<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8715] RocksDB does not propagate reconfiguration of serializer to the states</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8715</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Any changes to the serializer done in #ensureCompability are lost during the state creation.&lt;/p&gt;

&lt;p&gt;In particular, &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBValueState.java#L68&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBValueState.java#L68&lt;/a&gt; always uses a fresh copy of the StateDescriptor.&lt;/p&gt;

&lt;p&gt;An easy fix is to pass the reconfigured serializer as an additional parameter in &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java#L1681&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java#L1681&lt;/a&gt; , which can be retrieved through the side-output of getColumnFamily&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
kvStateInformation.get(stateDesc.getName()).f1.getStateSerializer()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I encountered it in 1.3.2 but the code in the master seems unchanged (hence the pointer into master). I encountered it in ValueState, but I suspect the same issue can be observed for all kinds of RocksDB states.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13139642">FLINK-8715</key>
            <summary>RocksDB does not propagate reconfiguration of serializer to the states</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tzulitai">Tzu-Li (Gordon) Tai</assignee>
                                    <reporter username="arvid">Arvid Heise</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Feb 2018 12:16:58 +0000</created>
                <updated>Tue, 22 Jun 2021 14:07:28 +0000</updated>
                            <resolved>Sat, 28 Apr 2018 09:09:57 +0000</resolved>
                                    <version>1.3.2</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16371392" author="stephanewen" created="Wed, 21 Feb 2018 13:14:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt; - what do you think here? This sounds like a critical issue, actually...&lt;/p&gt;

&lt;p&gt;Making this as a blocker, please remove the blocker status if you think this not an issue.&lt;/p&gt;</comment>
                            <comment id="16371427" author="aljoscha" created="Wed, 21 Feb 2018 13:54:00 +0000"  >&lt;p&gt;I think it is an issue but I don&apos;t see how we can easily enforce code to always to the right thing. We could add an &lt;tt&gt;ensureCompatibility()&lt;/tt&gt; on &lt;tt&gt;StateDescriptor&lt;/tt&gt;, which reconfigures the &lt;tt&gt;TypeSerializer&lt;/tt&gt; that it hands out. But this doesn&apos;t prevent code from erroneously getting a &lt;tt&gt;TypeSerializer&lt;/tt&gt; from the &lt;tt&gt;StateDescriptor&lt;/tt&gt; and reconfiguring that one...&lt;/p&gt;</comment>
                            <comment id="16404600" author="till.rohrmann" created="Mon, 19 Mar 2018 10:28:29 +0000"  >&lt;p&gt;I agree that we should at least give out a properly configured serializer from the &lt;tt&gt;StateDescriptor&lt;/tt&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanrichter83%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;stefanrichter83@gmail.com&quot;&gt;stefanrichter83@gmail.com&lt;/a&gt; how difficult would that be to add?&lt;/p&gt;</comment>
                            <comment id="16406943" author="stephanewen" created="Tue, 20 Mar 2018 20:10:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; I think you are right, the problem is potentially deeper.&lt;/p&gt;

&lt;p&gt;All parts of the code that obtain a serializer from a state descriptor need to obey reconfiguration based on the serializer config snapshot. At least all parts that touch data serialized by earlier versions. That includes queryable state!&lt;/p&gt;

&lt;p&gt;I think the best way to fix this (long run) would be to simply never have to use the old serializer again. If there is a change between the serializers, convert on restore, then the new serializer is safe to use. Everything else seems like a deep rabbit hole.&lt;/p&gt;

&lt;p&gt;The only worthwhile exception to this is may be Kryo, when the tag-to-class mapping changes. Then we really want the new serializer to re-configure and not convert the entire data set.&lt;/p&gt;

&lt;p&gt;If we really want to handle that, then we would indeed have to either&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;reconfigure the state descriptors&lt;/li&gt;
	&lt;li&gt;or never/nowhere use the state descriptors internally (for default values, etc.) but always use serializers/suppliers/etc obtained from the state descriptors.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16413453" author="arvid" created="Mon, 26 Mar 2018 06:56:44 +0000"  >&lt;p&gt;I don&apos;t have an overview for all the different use cases, so the following might be too simplistic to work.&lt;/p&gt;

&lt;p&gt;From a user&apos;s perspective, the serializer is just a plugin into the state descriptor that helps to customize serialization/deserialization. I don&apos;t see the need for a user to ever user StateDescriptor#getSerializer. I also clearly see the ownership of the serializer instance at the &quot;framework&quot;; I don&apos;t want to keep an outer reference either and I wouldn&apos;t expect to to be able to change the serializer after handing it over. So from a user&apos;s perspective a serializer is immutable.&lt;/p&gt;

&lt;p&gt;If you follow that thought, StateDescriptor#getSerializer should have been a non-public API; used solely by the state backend and the state query engine. Then you are free to return a direct reference to the serializer instead of a copy.&lt;/p&gt;

&lt;p&gt;The direct reference will then be configured using the snapshot state during initialization. Then it is effectively immutable and the varies copies can be created for different threads accessing the the state backend or state query engine.&lt;/p&gt;

&lt;p&gt;A quick solution to amend the current public #getSerializer is to mark it as deprecated and introduce a non-public #getSerializerInternally (failed to find a better name), which returns the direct reference instead of a copy. Replace all references to getSerializer with getSerializerInternally and make copies of the serializer only where needed.&lt;/p&gt;

&lt;p&gt;I think that goes along the lines what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; wrote in the end.&lt;/p&gt;

&lt;p&gt;Btw if you are making an exception for Kryo, it&apos;s hard to argue why it&apos;s not possible for Avro as well. Either you can make sure a serializer is reconfigurable or you don&apos;t support that at all.&lt;/p&gt;</comment>
                            <comment id="16445733" author="githubbot" created="Fri, 20 Apr 2018 13:36:22 +0000"  >&lt;p&gt;GitHub user tzulitai opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8715&quot; title=&quot;RocksDB does not propagate reconfiguration of serializer to the states&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8715&quot;&gt;&lt;del&gt;FLINK-8715&lt;/del&gt;&lt;/a&gt; Remove usage of StateDescriptor in state handles&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR is WIP, and is still lacking test coverage.&lt;br/&gt;
    It is opened now to collect some feedback for a proposed solution for &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8715&quot; title=&quot;RocksDB does not propagate reconfiguration of serializer to the states&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8715&quot;&gt;&lt;del&gt;FLINK-8715&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;    Previously, reconfigured state serializers on restore were not properly forwarded to the state handles. In the past, the `StateDescriptor` served as the holder for the reconfigured serializer.&lt;br/&gt;
    However, since 88ffad27, `StateDescriptor#getSerializer()` started giving out duplicates of the serializer, which caused reconfigured serializers to be a completely different copy then what the state handles were using.&lt;/p&gt;

&lt;p&gt;    This fix corrects this by explicitly forwarding the serializer to the instantiated state handles after the state is registered at the state backend. It also eliminates the use of `StateDescriptor`s internally in the state handles, so that the behaviour is independent of the `StateDescriptor#getSerializer()` method&apos;s implementation.&lt;/p&gt;

&lt;p&gt;    The alternative to this approach is to have an internal `setSerializer` method on the `StateDescriptor`, which should be used after state serializers are reconfigured on registration.&lt;br/&gt;
    Then, that assures that handed out serializers by the descriptor are always reconfigured, as soon as the descriptor is registered at the backend.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Remove `StateDescriptor`s from heap / RocksDB state handle classes&lt;/li&gt;
	&lt;li&gt;Forwards state serializer and any other necessary information provided by the state descriptor (e.g. default value, user functions, nested serializers, etc.) when instantiating state handles.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This fix still lacks test coverage.&lt;br/&gt;
    It has been opened to collect feedback for the approach.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / (*&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tzulitai/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tzulitai/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8715&quot; title=&quot;RocksDB does not propagate reconfiguration of serializer to the states&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8715&quot;&gt;&lt;del&gt;FLINK-8715&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5885&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c092dd6518d9e6f47f4cfc797c18bedc8a89cc05&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-04-20T13:15:42Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8715&quot; title=&quot;RocksDB does not propagate reconfiguration of serializer to the states&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8715&quot;&gt;&lt;del&gt;FLINK-8715&lt;/del&gt;&lt;/a&gt; Remove usage of StateDescriptor in state handles&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16446901" author="githubbot" created="Sat, 21 Apr 2018 17:29:12 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 to the general approach here&lt;br/&gt;
    Should add some tests (also checking why previous state migration tests did not catch this)&lt;/p&gt;</comment>
                            <comment id="16446904" author="githubbot" created="Sat, 21 Apr 2018 17:33:07 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r183214737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r183214737&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -1177,7 +1177,7 @@ private void restoreKeyGroupsShardWithTemporaryHelperInstance(&lt;br/&gt;
     				throw new StateMigrationException(&quot;State migration isn&apos;t supported, yet.&quot;);&lt;br/&gt;
     			} else {&lt;br/&gt;
     				stateInfo.f1 = newMetaInfo;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return stateInfo.f0;&lt;br/&gt;
    +				return Tuple2.of(stateInfo.f0, newMetaInfo.getStateSerializer());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Mirroring a the result from an offline discussion here:&lt;/p&gt;

&lt;p&gt;    This is a bit fragile - the fact that the `newMetaInfo` is mutable and the serializer is altered in there and then obtained from there again. Makes it harder for future maintainers and easy to accidentally break in the future.&lt;/p&gt;

&lt;p&gt;    The meta info should be immutable, and the re-configured serializer (or the original, if no reconfiguration is needed) would probably best be part of the compatiblity result.&lt;/p&gt;</comment>
                            <comment id="16447724" author="githubbot" created="Mon, 23 Apr 2018 08:20:08 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r183309701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r183309701&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -1177,7 +1177,7 @@ private void restoreKeyGroupsShardWithTemporaryHelperInstance(&lt;br/&gt;
     				throw new StateMigrationException(&quot;State migration isn&apos;t supported, yet.&quot;);&lt;br/&gt;
     			} else {&lt;br/&gt;
     				stateInfo.f1 = newMetaInfo;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return stateInfo.f0;&lt;br/&gt;
    +				return Tuple2.of(stateInfo.f0, newMetaInfo.getStateSerializer());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I agree here, that we should let the meta info be immutable, and let the compatibility check result carry the compatible, reconfigured serializer.&lt;/p&gt;

&lt;p&gt;    However, one issue is that this requires changes to the `CompatibilityResult` interface which is part of the public API. I would prefer not to touch the API now as we&apos;re approaching release. It would be possible to by-pass this by maybe introducing an internal compat result class, but downsides are - 1) that would have almost identical implementation to `CompatibilityResult`, and 2) that would entail touching a lot of our more complex serializer&apos;s code, because they use `CompatibilityUtil.resolveCompatibilityResult`.&lt;/p&gt;</comment>
                            <comment id="16451762" author="githubbot" created="Wed, 25 Apr 2018 07:19:27 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Updates:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;4953ad0 Treat state backend registration meta info as immutable. The new meta info is instantiated with the reconfigured serializer, instead of instantiating it with the pre-reconfigured serializer and altering it in there.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;b7a0ed0 Add a new test `StateBackendTestBase#testStateSerializerReconfiguration` that verifies 1) state serializers are reconfigured, and 2) state handles actually use the reconfigured serializer. This is a common test for all state backends.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    @StefanRRichter @aljoscha the PR is ready for another review. Could you have a look?&lt;/p&gt;</comment>
                            <comment id="16451771" author="githubbot" created="Wed, 25 Apr 2018 07:28:31 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    A note about previous tests that should have been failing because of this issue:&lt;br/&gt;
    The tests `StateBackendTestBase#testKryoRestoreResilienceWithDifferentRegistrationOrder()` and `StateBackendTestBase#testPojoRestoreResilienceWithDifferentRegistrationOrder` was supposed to, to some extend, test serializer reconfigurations across backend state restores.&lt;/p&gt;

&lt;p&gt;    f553d9b adds an extension to the Kryo test that verifies the state handles actually uses the correct reconfigured serializer. After adding that extension, the test fails without this PR.&lt;br/&gt;
    However, that still doesn&apos;t explain why, especially in the RocksDB case, modifications to the state did not cause errors while it was using the non-reconfigured serializer (with outdated Kryo registration mappings).&lt;/p&gt;</comment>
                            <comment id="16451953" author="githubbot" created="Wed, 25 Apr 2018 09:35:23 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r183996477&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r183996477&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -1125,59 +1125,62 @@ private void restoreKeyGroupsShardWithTemporaryHelperInstance(&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;that we checkpointed, i.e. is already in the map of column families.&lt;br/&gt;
     	 */&lt;br/&gt;
     	@SuppressWarnings(&quot;rawtypes, unchecked&quot;)&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected &amp;lt;N, S&amp;gt; ColumnFamilyHandle getColumnFamily(&lt;br/&gt;
    +	protected &amp;lt;N, S&amp;gt; Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;N, S&amp;gt;&amp;gt; getColumnFamilyAndStateSerializer(
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think this method has grown way too complex over time, and looking at the `Tuple2` return type it becomes more and more clear that this code is mixing up 2 different concerns and could be untangled a bit. I would suggest to separate this into: &lt;br/&gt;
    1) checking if this is a new state (does the map contain the name string), this is like a inlined check in current calling code. &lt;br/&gt;
    2) If yes, do the serializer checks and configuration magic and create the `RegisteredKeyedBackendStateMetaInfo`. this goes to a separate method that is called by the current caller.&lt;br/&gt;
    3) Request the column family, either by new registration or the existing one. can use the result from step 1 or recheck. this goes in another separate method called by the current caller.&lt;br/&gt;
    x) Optional: helper method that does steps 1-3 if we otherwise duplicate them too much.&lt;/p&gt;</comment>
                            <comment id="16451957" author="githubbot" created="Wed, 25 Apr 2018 09:39:26 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r183997653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r183997653&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -169,13 +169,16 @@ public HeapKeyedStateBackend(&lt;br/&gt;
     			TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer,&lt;br/&gt;
     			TypeSerializer&amp;lt;V&amp;gt; valueSerializer) throws StateMigrationException {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final RegisteredKeyedBackendStateMetaInfo&amp;lt;N, V&amp;gt; newMetaInfo =&lt;/li&gt;
	&lt;li&gt;new RegisteredKeyedBackendStateMetaInfo&amp;lt;&amp;gt;(stateType, stateName, namespaceSerializer, valueSerializer);&lt;br/&gt;
    -&lt;br/&gt;
     		@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     		StateTable&amp;lt;K, N, V&amp;gt; stateTable = (StateTable&amp;lt;K, N, V&amp;gt;) stateTables.get(stateName);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (stateTable == null) {&lt;br/&gt;
    +			RegisteredKeyedBackendStateMetaInfo&amp;lt;N, V&amp;gt; newMetaInfo = new RegisteredKeyedBackendStateMetaInfo&amp;lt;&amp;gt;(&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Mixing of concerns is not yet as bad as in the Rocks backend code, you might also start separating this a bit more here as well.&lt;/p&gt;</comment>
                            <comment id="16452356" author="githubbot" created="Wed, 25 Apr 2018 14:40:38 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184084995&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184084995&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/AbstractHeapState.java &amp;#8212;&lt;br/&gt;
    @@ -42,33 +42,35 @@&lt;br/&gt;
     	/** Map containing the actual key/value pairs. */&lt;br/&gt;
     	protected final StateTable&amp;lt;K, N, SV&amp;gt; stateTable;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** This holds the name of the state and can create an initial default value for the state. */&lt;/li&gt;
	&lt;li&gt;protected final SD stateDesc;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think with removing this, you can also remove SD from the generic type of this class, and transitively from the subclasses as well.&lt;/p&gt;</comment>
                            <comment id="16452368" author="githubbot" created="Wed, 25 Apr 2018 14:42:08 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184085595&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184085595&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -61,8 +64,7 @@&lt;br/&gt;
     	/** The column family of this particular instance of state. */&lt;br/&gt;
     	protected ColumnFamilyHandle columnFamily;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** State descriptor from which to create this state instance. */&lt;/li&gt;
	&lt;li&gt;protected final SD stateDesc;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Same as for the heap state also applies here, you can remove `SD` from the generic types of this class and the subclasses.&lt;/p&gt;</comment>
                            <comment id="16452378" author="githubbot" created="Wed, 25 Apr 2018 14:44:23 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184086555&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184086555&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapAggregatingState.java &amp;#8212;&lt;br/&gt;
    @@ -47,21 +47,23 @@&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Creates a new key/value state for the given hash map of key/value pairs.&lt;br/&gt;
     	 *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @param stateDesc&lt;/li&gt;
	&lt;li&gt;*             The state identifier for the state. This contains name and can create a default state value.&lt;br/&gt;
    +	 * @param valueSerializer&lt;br/&gt;
    +	 *             The serializer for the state.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param stateTable&lt;/li&gt;
	&lt;li&gt;The state table to use in this kev/value state. May contain initial state.&lt;/li&gt;
	&lt;li&gt;@param namespaceSerializer&lt;/li&gt;
	&lt;li&gt;The serializer for the type that indicates the namespace&lt;br/&gt;
     	 */&lt;br/&gt;
     	public HeapAggregatingState(&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;AggregatingStateDescriptor&amp;lt;IN, ACC, OUT&amp;gt; stateDesc,&lt;br/&gt;
     			StateTable&amp;lt;K, N, ACC&amp;gt; stateTable,&lt;br/&gt;
     			TypeSerializer&amp;lt;K&amp;gt; keySerializer,&lt;/li&gt;
	&lt;li&gt;TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) {&lt;br/&gt;
    +			TypeSerializer&amp;lt;ACC&amp;gt; valueSerializer,&lt;br/&gt;
    +			TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer,&lt;br/&gt;
    +			ACC defaultValue,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The comments are not updated to reflect this and the next line.&lt;/p&gt;</comment>
                            <comment id="16452382" author="githubbot" created="Wed, 25 Apr 2018 14:45:36 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184087107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184087107&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/AbstractHeapState.java &amp;#8212;&lt;br/&gt;
    @@ -42,33 +42,35 @@&lt;br/&gt;
     	/** Map containing the actual key/value pairs. */&lt;br/&gt;
     	protected final StateTable&amp;lt;K, N, SV&amp;gt; stateTable;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** This holds the name of the state and can create an initial default value for the state. */&lt;/li&gt;
	&lt;li&gt;protected final SD stateDesc;&lt;br/&gt;
    -&lt;br/&gt;
     	/** The current namespace, which the access methods will refer to. */&lt;br/&gt;
     	protected N currentNamespace;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected final TypeSerializer&amp;lt;K&amp;gt; keySerializer;&lt;/p&gt;

&lt;p&gt;    +	protected final TypeSerializer&amp;lt;SV&amp;gt; valueSerializer;&lt;br/&gt;
    +&lt;br/&gt;
     	protected final TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer;&lt;/p&gt;

&lt;p&gt;    +	private final SV defaultValue;&lt;br/&gt;
    +&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Creates a new key/value state for the given hash map of key/value pairs.&lt;br/&gt;
     	 *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @param stateDesc The state identifier for the state. This contains name&lt;/li&gt;
	&lt;li&gt;*                           and can create a default state value.&lt;br/&gt;
    +	 * @param valueSerializer The serializer for the state.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param stateTable The state tab;e to use in this kev/value state. May contain initial state.&lt;br/&gt;
     	 */&lt;br/&gt;
     	protected AbstractHeapState(&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;SD stateDesc,&lt;br/&gt;
     			StateTable&amp;lt;K, N, SV&amp;gt; stateTable,&lt;br/&gt;
     			TypeSerializer&amp;lt;K&amp;gt; keySerializer,&lt;/li&gt;
	&lt;li&gt;TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) {&lt;br/&gt;
    +			TypeSerializer&amp;lt;SV&amp;gt; valueSerializer,&lt;br/&gt;
    +			TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Comments require update.&lt;/p&gt;</comment>
                            <comment id="16452383" author="githubbot" created="Wed, 25 Apr 2018 14:46:07 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184087357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184087357&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapFoldingState.java &amp;#8212;&lt;br/&gt;
    @@ -49,17 +49,18 @@&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Creates a new key/value state for the given hash map of key/value pairs.&lt;br/&gt;
     	 *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @param stateDesc The state identifier for the state. This contains name&lt;/li&gt;
	&lt;li&gt;*                           and can create a default state value.&lt;br/&gt;
    +	 * @param valueSerializer The serializer for the state.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param stateTable The state tab;e to use in this kev/value state. May contain initial state.&lt;br/&gt;
     	 */&lt;br/&gt;
     	public HeapFoldingState(&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FoldingStateDescriptor&amp;lt;T, ACC&amp;gt; stateDesc,&lt;br/&gt;
     			StateTable&amp;lt;K, N, ACC&amp;gt; stateTable,&lt;br/&gt;
     			TypeSerializer&amp;lt;K&amp;gt; keySerializer,&lt;/li&gt;
	&lt;li&gt;TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) {&lt;/li&gt;
	&lt;li&gt;super(stateDesc, stateTable, keySerializer, namespaceSerializer);&lt;/li&gt;
	&lt;li&gt;this.foldTransformation = new FoldTransformation&amp;lt;&amp;gt;(stateDesc);&lt;br/&gt;
    +			TypeSerializer&amp;lt;ACC&amp;gt; valueSerializer,&lt;br/&gt;
    +			TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer,&lt;br/&gt;
    +			ACC defaultValue,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Comments require update.&lt;/p&gt;</comment>
                            <comment id="16452385" author="githubbot" created="Wed, 25 Apr 2018 14:46:54 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184087656&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184087656&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapFoldingState.java &amp;#8212;&lt;br/&gt;
    @@ -49,17 +49,18 @@&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Creates a new key/value state for the given hash map of key/value pairs.&lt;br/&gt;
     	 *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @param stateDesc The state identifier for the state. This contains name&lt;/li&gt;
	&lt;li&gt;*                           and can create a default state value.&lt;br/&gt;
    +	 * @param valueSerializer The serializer for the state.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param stateTable The state tab;e to use in this kev/value state. May contain initial state.&lt;br/&gt;
     	 */&lt;br/&gt;
     	public HeapFoldingState(&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FoldingStateDescriptor&amp;lt;T, ACC&amp;gt; stateDesc,&lt;br/&gt;
     			StateTable&amp;lt;K, N, ACC&amp;gt; stateTable,&lt;br/&gt;
     			TypeSerializer&amp;lt;K&amp;gt; keySerializer,&lt;/li&gt;
	&lt;li&gt;TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) {&lt;/li&gt;
	&lt;li&gt;super(stateDesc, stateTable, keySerializer, namespaceSerializer);&lt;/li&gt;
	&lt;li&gt;this.foldTransformation = new FoldTransformation&amp;lt;&amp;gt;(stateDesc);&lt;br/&gt;
    +			TypeSerializer&amp;lt;ACC&amp;gt; valueSerializer,&lt;br/&gt;
    +			TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer,&lt;br/&gt;
    +			ACC defaultValue,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think you need to double check this on every state class, they look all not updated.&lt;/p&gt;</comment>
                            <comment id="16452421" author="githubbot" created="Wed, 25 Apr 2018 15:00:53 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184093390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184093390&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapFoldingState.java &amp;#8212;&lt;br/&gt;
    @@ -103,17 +104,17 @@ public void add(T value) throws IOException {&lt;/p&gt;

&lt;p&gt;     	private static final class FoldTransformation&amp;lt;T, ACC&amp;gt; implements StateTransformationFunction&amp;lt;ACC, T&amp;gt; {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final FoldingStateDescriptor&amp;lt;T, ACC&amp;gt; stateDescriptor;&lt;br/&gt;
    +		private final HeapFoldingState&amp;lt;?, ?, T, ACC&amp;gt; stateRef;&lt;br/&gt;
     		private final FoldFunction&amp;lt;T, ACC&amp;gt; foldFunction;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FoldTransformation(FoldingStateDescriptor&amp;lt;T, ACC&amp;gt; stateDesc) {&lt;/li&gt;
	&lt;li&gt;this.stateDescriptor = Preconditions.checkNotNull(stateDesc);&lt;/li&gt;
	&lt;li&gt;this.foldFunction = Preconditions.checkNotNull(stateDesc.getFoldFunction());&lt;br/&gt;
    +		FoldTransformation(FoldFunction&amp;lt;T, ACC&amp;gt; foldFunction, HeapFoldingState&amp;lt;?, ?, T, ACC&amp;gt; stateRef) {&lt;br/&gt;
    +			this.stateRef = Preconditions.checkNotNull(stateRef);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Maybe the more honest and simple way is making this a non-static inner class instead of passing a reference to `HeapFoldingState.this` in the constructor. Essentially it does the same.&lt;/p&gt;</comment>
                            <comment id="16452444" author="githubbot" created="Wed, 25 Apr 2018 15:13:19 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184098081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184098081&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -185,36 +188,44 @@ public HeapKeyedStateBackend(&lt;br/&gt;
     				stateName.equals(stateTable.getMetaInfo().getName()),&lt;br/&gt;
     				&quot;Incompatible state names. &quot; +&lt;br/&gt;
     					&quot;Was &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + stateTable.getMetaInfo().getName() + &amp;quot;&amp;#93;&lt;/span&gt;, &quot; +&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;registered with &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + newMetaInfo.getName() + &amp;quot;&amp;#93;&lt;/span&gt;.&quot;);&lt;br/&gt;
    +					&quot;registered with &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + stateName + &amp;quot;&amp;#93;&lt;/span&gt;.&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!newMetaInfo.getStateType().equals(StateDescriptor.Type.UNKNOWN)&lt;br/&gt;
    +			if (!stateType.equals(StateDescriptor.Type.UNKNOWN)&lt;br/&gt;
     					&amp;amp;&amp;amp; !stateTable.getMetaInfo().getStateType().equals(StateDescriptor.Type.UNKNOWN)) 
{
     
     				Preconditions.checkState(
    -					newMetaInfo.getStateType().equals(stateTable.getMetaInfo().getStateType()),
    +					stateType.equals(stateTable.getMetaInfo().getStateType()),
     					&quot;Incompatible state types. &quot; +
     						&quot;Was [&quot; + stateTable.getMetaInfo().getStateType() + &quot;], &quot; +
    -						&quot;registered with [&quot; + newMetaInfo.getStateType() + &quot;].&quot;);
    +						&quot;registered with [&quot; + stateType + &quot;].&quot;);
     			}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     			RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;N, V&amp;gt; restoredMetaInfo =&lt;br/&gt;
     				(RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;N, V&amp;gt;) restoredKvStateMetaInfos.get(stateName);&lt;/p&gt;

&lt;p&gt;     			// check compatibility results to determine if state migration is required&lt;br/&gt;
    +			TypeSerializer&amp;lt;N&amp;gt; newNamespaceSerializer = namespaceSerializer.duplicate();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Just curious, why do we need to duplicate the serializer here but not in all other places like where `resolveCompatibilityResult()` is called? Or asked differently, should `resolveCompatibilityResult()` always do duplication internally or not at all or is this just as intended?&lt;/p&gt;</comment>
                            <comment id="16452457" author="githubbot" created="Wed, 25 Apr 2018 15:22:38 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184101616&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184101616&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -1125,59 +1125,62 @@ private void restoreKeyGroupsShardWithTemporaryHelperInstance(&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;that we checkpointed, i.e. is already in the map of column families.&lt;br/&gt;
     	 */&lt;br/&gt;
     	@SuppressWarnings(&quot;rawtypes, unchecked&quot;)&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected &amp;lt;N, S&amp;gt; ColumnFamilyHandle getColumnFamily(&lt;br/&gt;
    +	protected &amp;lt;N, S&amp;gt; Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;N, S&amp;gt;&amp;gt; getColumnFamilyAndStateSerializer(&lt;br/&gt;
     		StateDescriptor&amp;lt;?, S&amp;gt; descriptor, TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) throws IOException, StateMigrationException {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;?, ?&amp;gt;&amp;gt; stateInfo =&lt;br/&gt;
     			kvStateInformation.get(descriptor.getName());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RegisteredKeyedBackendStateMetaInfo&amp;lt;N, S&amp;gt; newMetaInfo = new RegisteredKeyedBackendStateMetaInfo&amp;lt;&amp;gt;(&lt;/li&gt;
	&lt;li&gt;descriptor.getType(),&lt;/li&gt;
	&lt;li&gt;descriptor.getName(),&lt;/li&gt;
	&lt;li&gt;namespaceSerializer,&lt;/li&gt;
	&lt;li&gt;descriptor.getSerializer());&lt;br/&gt;
    -&lt;br/&gt;
     		if (stateInfo != null) {&lt;br/&gt;
     			// TODO with eager registration in place, these checks should be moved to restore()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;N, S&amp;gt; restoredMetaInfo =&lt;br/&gt;
     				(RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;N, S&amp;gt;) restoredKvStateMetaInfos.get(descriptor.getName());&lt;/p&gt;

&lt;p&gt;     			Preconditions.checkState(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Objects.equals(newMetaInfo.getName(), restoredMetaInfo.getName()),&lt;br/&gt;
    +				Objects.equals(descriptor.getName(), restoredMetaInfo.getName()),&lt;br/&gt;
     				&quot;Incompatible state names. &quot; +&lt;br/&gt;
     					&quot;Was &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + restoredMetaInfo.getName() + &amp;quot;&amp;#93;&lt;/span&gt;, &quot; +&lt;/li&gt;
	&lt;li&gt;&quot;registered with &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + newMetaInfo.getName() + &amp;quot;&amp;#93;&lt;/span&gt;.&quot;);&lt;br/&gt;
    +					&quot;registered with &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + descriptor.getName() + &amp;quot;&amp;#93;&lt;/span&gt;.&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!Objects.equals(newMetaInfo.getStateType(), StateDescriptor.Type.UNKNOWN)&lt;br/&gt;
    +			if (!Objects.equals(descriptor.getType(), StateDescriptor.Type.UNKNOWN)&lt;br/&gt;
     				&amp;amp;&amp;amp; !Objects.equals(restoredMetaInfo.getStateType(), StateDescriptor.Type.UNKNOWN)) 
{
     
     				Preconditions.checkState(
    -					newMetaInfo.getStateType() == restoredMetaInfo.getStateType(),
    +					descriptor.getType() == restoredMetaInfo.getStateType(),
     					&quot;Incompatible state types. &quot; +
     						&quot;Was [&quot; + restoredMetaInfo.getStateType() + &quot;], &quot; +
    -						&quot;registered with [&quot; + newMetaInfo.getStateType() + &quot;].&quot;);
    +						&quot;registered with [&quot; + descriptor.getType() + &quot;].&quot;);
     			}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			// check compatibility results to determine if state migration is required&lt;br/&gt;
    +			TypeSerializer&amp;lt;N&amp;gt; newNamespaceSerializer = namespaceSerializer.duplicate();&lt;br/&gt;
     			CompatibilityResult&amp;lt;N&amp;gt; namespaceCompatibility = CompatibilityUtil.resolveCompatibilityResult(&lt;br/&gt;
     				restoredMetaInfo.getNamespaceSerializer(),&lt;br/&gt;
     				null,&lt;br/&gt;
     				restoredMetaInfo.getNamespaceSerializerConfigSnapshot(),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;newMetaInfo.getNamespaceSerializer());&lt;br/&gt;
    +				newNamespaceSerializer);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			TypeSerializer&amp;lt;S&amp;gt; newStateSerializer = descriptor.getSerializer().duplicate();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The `duplicate()` here looks redundant because it comes from the descriptor that already duplicates.&lt;/p&gt;</comment>
                            <comment id="16452492" author="githubbot" created="Wed, 25 Apr 2018 15:29:15 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184104126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184104126&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -185,36 +188,44 @@ public HeapKeyedStateBackend(&lt;br/&gt;
     				stateName.equals(stateTable.getMetaInfo().getName()),&lt;br/&gt;
     				&quot;Incompatible state names. &quot; +&lt;br/&gt;
     					&quot;Was &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + stateTable.getMetaInfo().getName() + &amp;quot;&amp;#93;&lt;/span&gt;, &quot; +&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;registered with &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + newMetaInfo.getName() + &amp;quot;&amp;#93;&lt;/span&gt;.&quot;);&lt;br/&gt;
    +					&quot;registered with &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + stateName + &amp;quot;&amp;#93;&lt;/span&gt;.&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!newMetaInfo.getStateType().equals(StateDescriptor.Type.UNKNOWN)&lt;br/&gt;
    +			if (!stateType.equals(StateDescriptor.Type.UNKNOWN)&lt;br/&gt;
     					&amp;amp;&amp;amp; !stateTable.getMetaInfo().getStateType().equals(StateDescriptor.Type.UNKNOWN)) 
{
     
     				Preconditions.checkState(
    -					newMetaInfo.getStateType().equals(stateTable.getMetaInfo().getStateType()),
    +					stateType.equals(stateTable.getMetaInfo().getStateType()),
     					&quot;Incompatible state types. &quot; +
     						&quot;Was [&quot; + stateTable.getMetaInfo().getStateType() + &quot;], &quot; +
    -						&quot;registered with [&quot; + newMetaInfo.getStateType() + &quot;].&quot;);
    +						&quot;registered with [&quot; + stateType + &quot;].&quot;);
     			}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     			RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;N, V&amp;gt; restoredMetaInfo =&lt;br/&gt;
     				(RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;N, V&amp;gt;) restoredKvStateMetaInfos.get(stateName);&lt;/p&gt;

&lt;p&gt;     			// check compatibility results to determine if state migration is required&lt;br/&gt;
    +			TypeSerializer&amp;lt;N&amp;gt; newNamespaceSerializer = namespaceSerializer.duplicate();&lt;br/&gt;
     			CompatibilityResult&amp;lt;N&amp;gt; namespaceCompatibility = CompatibilityUtil.resolveCompatibilityResult(&lt;br/&gt;
     					restoredMetaInfo.getNamespaceSerializer(),&lt;br/&gt;
     					null,&lt;br/&gt;
     					restoredMetaInfo.getNamespaceSerializerConfigSnapshot(),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;newMetaInfo.getNamespaceSerializer());&lt;br/&gt;
    +					newNamespaceSerializer);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			TypeSerializer&amp;lt;V&amp;gt; newValueSerializer = valueSerializer.duplicate();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Similar to my comment on the Rocks code, this duplicate seems redundant, because the serializer also comes straight from a `StateDescriptor` which duplicates before handing it out. One thing to consider when removing this call: it is just less obvious here that the serializer was already duplicated, so maybe it would be good to pass the state descriptor as argument and get the serializer directly here to avoid any surprises for people working on this in the future.&lt;/p&gt;</comment>
                            <comment id="16456238" author="githubbot" created="Fri, 27 Apr 2018 11:07:29 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184657398&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184657398&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapFoldingState.java &amp;#8212;&lt;br/&gt;
    @@ -49,17 +49,18 @@&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Creates a new key/value state for the given hash map of key/value pairs.&lt;br/&gt;
     	 *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @param stateDesc The state identifier for the state. This contains name&lt;/li&gt;
	&lt;li&gt;*                           and can create a default state value.&lt;br/&gt;
    +	 * @param valueSerializer The serializer for the state.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param stateTable The state tab;e to use in this kev/value state. May contain initial state.&lt;br/&gt;
     	 */&lt;br/&gt;
     	public HeapFoldingState(&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FoldingStateDescriptor&amp;lt;T, ACC&amp;gt; stateDesc,&lt;br/&gt;
     			StateTable&amp;lt;K, N, ACC&amp;gt; stateTable,&lt;br/&gt;
     			TypeSerializer&amp;lt;K&amp;gt; keySerializer,&lt;/li&gt;
	&lt;li&gt;TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) {&lt;/li&gt;
	&lt;li&gt;super(stateDesc, stateTable, keySerializer, namespaceSerializer);&lt;/li&gt;
	&lt;li&gt;this.foldTransformation = new FoldTransformation&amp;lt;&amp;gt;(stateDesc);&lt;br/&gt;
    +			TypeSerializer&amp;lt;ACC&amp;gt; valueSerializer,&lt;br/&gt;
    +			TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer,&lt;br/&gt;
    +			ACC defaultValue,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Javadocs for all state classes are now updated.&lt;/p&gt;</comment>
                            <comment id="16456239" author="githubbot" created="Fri, 27 Apr 2018 11:07:36 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184657419&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184657419&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapFoldingState.java &amp;#8212;&lt;br/&gt;
    @@ -103,17 +104,17 @@ public void add(T value) throws IOException {&lt;/p&gt;

&lt;p&gt;     	private static final class FoldTransformation&amp;lt;T, ACC&amp;gt; implements StateTransformationFunction&amp;lt;ACC, T&amp;gt; {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final FoldingStateDescriptor&amp;lt;T, ACC&amp;gt; stateDescriptor;&lt;br/&gt;
    +		private final HeapFoldingState&amp;lt;?, ?, T, ACC&amp;gt; stateRef;&lt;br/&gt;
     		private final FoldFunction&amp;lt;T, ACC&amp;gt; foldFunction;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FoldTransformation(FoldingStateDescriptor&amp;lt;T, ACC&amp;gt; stateDesc) {&lt;/li&gt;
	&lt;li&gt;this.stateDescriptor = Preconditions.checkNotNull(stateDesc);&lt;/li&gt;
	&lt;li&gt;this.foldFunction = Preconditions.checkNotNull(stateDesc.getFoldFunction());&lt;br/&gt;
    +		FoldTransformation(FoldFunction&amp;lt;T, ACC&amp;gt; foldFunction, HeapFoldingState&amp;lt;?, ?, T, ACC&amp;gt; stateRef) {&lt;br/&gt;
    +			this.stateRef = Preconditions.checkNotNull(stateRef);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Done &#128076; &lt;/p&gt;</comment>
                            <comment id="16456241" author="githubbot" created="Fri, 27 Apr 2018 11:08:11 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184657584&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184657584&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -185,36 +188,44 @@ public HeapKeyedStateBackend(&lt;br/&gt;
     				stateName.equals(stateTable.getMetaInfo().getName()),&lt;br/&gt;
     				&quot;Incompatible state names. &quot; +&lt;br/&gt;
     					&quot;Was &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + stateTable.getMetaInfo().getName() + &amp;quot;&amp;#93;&lt;/span&gt;, &quot; +&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;registered with &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + newMetaInfo.getName() + &amp;quot;&amp;#93;&lt;/span&gt;.&quot;);&lt;br/&gt;
    +					&quot;registered with &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + stateName + &amp;quot;&amp;#93;&lt;/span&gt;.&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!newMetaInfo.getStateType().equals(StateDescriptor.Type.UNKNOWN)&lt;br/&gt;
    +			if (!stateType.equals(StateDescriptor.Type.UNKNOWN)&lt;br/&gt;
     					&amp;amp;&amp;amp; !stateTable.getMetaInfo().getStateType().equals(StateDescriptor.Type.UNKNOWN)) 
{
     
     				Preconditions.checkState(
    -					newMetaInfo.getStateType().equals(stateTable.getMetaInfo().getStateType()),
    +					stateType.equals(stateTable.getMetaInfo().getStateType()),
     					&quot;Incompatible state types. &quot; +
     						&quot;Was [&quot; + stateTable.getMetaInfo().getStateType() + &quot;], &quot; +
    -						&quot;registered with [&quot; + newMetaInfo.getStateType() + &quot;].&quot;);
    +						&quot;registered with [&quot; + stateType + &quot;].&quot;);
     			}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     			RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;N, V&amp;gt; restoredMetaInfo =&lt;br/&gt;
     				(RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;N, V&amp;gt;) restoredKvStateMetaInfos.get(stateName);&lt;/p&gt;

&lt;p&gt;     			// check compatibility results to determine if state migration is required&lt;br/&gt;
    +			TypeSerializer&amp;lt;N&amp;gt; newNamespaceSerializer = namespaceSerializer.duplicate();&lt;br/&gt;
     			CompatibilityResult&amp;lt;N&amp;gt; namespaceCompatibility = CompatibilityUtil.resolveCompatibilityResult(&lt;br/&gt;
     					restoredMetaInfo.getNamespaceSerializer(),&lt;br/&gt;
     					null,&lt;br/&gt;
     					restoredMetaInfo.getNamespaceSerializerConfigSnapshot(),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;newMetaInfo.getNamespaceSerializer());&lt;br/&gt;
    +					newNamespaceSerializer);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			TypeSerializer&amp;lt;V&amp;gt; newValueSerializer = valueSerializer.duplicate();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I&apos;ve updated this according to your suggestion:&lt;br/&gt;
    The reconfiguration method now gets a state descriptor as an argument to reduce confusion.&lt;/p&gt;</comment>
                            <comment id="16456245" author="githubbot" created="Fri, 27 Apr 2018 11:08:39 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184657676&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184657676&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -61,8 +64,7 @@&lt;br/&gt;
     	/** The column family of this particular instance of state. */&lt;br/&gt;
     	protected ColumnFamilyHandle columnFamily;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** State descriptor from which to create this state instance. */&lt;/li&gt;
	&lt;li&gt;protected final SD stateDesc;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Fixed, thanks for catching this.&lt;/p&gt;</comment>
                            <comment id="16456246" author="githubbot" created="Fri, 27 Apr 2018 11:09:14 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @StefanRRichter, I&apos;ve addressed your comments and also rebased the PR.&lt;br/&gt;
    Could you have a final pass through this?&lt;/p&gt;</comment>
                            <comment id="16456309" author="githubbot" created="Fri, 27 Apr 2018 12:40:59 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184675164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184675164&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -1116,148 +1115,177 @@ private void restoreKeyGroupsShardWithTemporaryHelperInstance(&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Creates a column family handle for use with a k/v state. When restoring from a snapshot&lt;/li&gt;
	&lt;li&gt;* we don&apos;t restore the individual k/v states, just the global RocksDB database and the&lt;/li&gt;
	&lt;li&gt;* list of column families. When a k/v state is first requested we check here whether we&lt;/li&gt;
	&lt;li&gt;* already have a column family for that and return it or create a new one if it doesn&apos;t exist.&lt;br/&gt;
    +	 * Registers a k/v state information, which includes its state id, type, RocksDB column family handle, and serializers.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This also checks whether the 
{@link StateDescriptor}
&lt;p&gt; for a state matches the one&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;* that we checkpointed, i.e. is already in the map of column families.&lt;br/&gt;
    +	 * When restoring from a snapshot, we don&#8217;t restore the individual k/v states, just the global RocksDB database and&lt;br/&gt;
    +	 * the list of k/v state information. When a k/v state is first requested we check here whether we&lt;br/&gt;
    +	 * already have a registered entry for that and return it (after some necessary state compatibility checks)&lt;br/&gt;
    +	 * or create a new one if it does not exist.&lt;br/&gt;
     	 */&lt;/li&gt;
	&lt;li&gt;@SuppressWarnings(&quot;rawtypes, unchecked&quot;)&lt;/li&gt;
	&lt;li&gt;protected &amp;lt;N, S&amp;gt; ColumnFamilyHandle getColumnFamily(&lt;/li&gt;
	&lt;li&gt;StateDescriptor&amp;lt;?, S&amp;gt; descriptor, TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) throws IOException, StateMigrationException {&lt;br/&gt;
    +	private Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;?, ?&amp;gt;&amp;gt; tryRegisterKvStateInformation(&lt;br/&gt;
    +			StateDescriptor&amp;lt;?, ?&amp;gt; stateDesc,&lt;br/&gt;
    +			TypeSerializer&amp;lt;?&amp;gt; namespaceSerializer) throws StateMigrationException, IOException {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;?, ?&amp;gt;&amp;gt; stateInfo =&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;kvStateInformation.get(descriptor.getName());&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;RegisteredKeyedBackendStateMetaInfo&amp;lt;N, S&amp;gt; newMetaInfo = new RegisteredKeyedBackendStateMetaInfo&amp;lt;&amp;gt;(&lt;/li&gt;
	&lt;li&gt;descriptor.getType(),&lt;/li&gt;
	&lt;li&gt;descriptor.getName(),&lt;/li&gt;
	&lt;li&gt;namespaceSerializer,&lt;/li&gt;
	&lt;li&gt;descriptor.getSerializer());&lt;br/&gt;
    +			kvStateInformation.get(stateDesc.getName());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +		RegisteredKeyedBackendStateMetaInfo&amp;lt;?, ?&amp;gt; newMetaInfo;&lt;br/&gt;
     		if (stateInfo != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// TODO with eager registration in place, these checks should be moved to restore()&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;N, S&amp;gt; restoredMetaInfo =&lt;/li&gt;
	&lt;li&gt;(RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;N, S&amp;gt;) restoredKvStateMetaInfos.get(descriptor.getName());&lt;br/&gt;
    +			@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
    +			RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;?, ?&amp;gt; restoredMetaInfoSnapshot =&lt;br/&gt;
    +				restoredKvStateMetaInfos.get(stateDesc.getName());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			Preconditions.checkState(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Objects.equals(newMetaInfo.getName(), restoredMetaInfo.getName()),&lt;/li&gt;
	&lt;li&gt;&quot;Incompatible state names. &quot; +&lt;/li&gt;
	&lt;li&gt;&quot;Was &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + restoredMetaInfo.getName() + &amp;quot;&amp;#93;&lt;/span&gt;, &quot; +&lt;/li&gt;
	&lt;li&gt;&quot;registered with &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + newMetaInfo.getName() + &amp;quot;&amp;#93;&lt;/span&gt;.&quot;);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (!Objects.equals(newMetaInfo.getStateType(), StateDescriptor.Type.UNKNOWN)&lt;/li&gt;
	&lt;li&gt;&amp;amp;&amp;amp; !Objects.equals(restoredMetaInfo.getStateType(), StateDescriptor.Type.UNKNOWN)) 
{
    -
    -				Preconditions.checkState(
    -					newMetaInfo.getStateType() == restoredMetaInfo.getStateType(),
    -					&quot;Incompatible state types. &quot; +
    -						&quot;Was [&quot; + restoredMetaInfo.getStateType() + &quot;], &quot; +
    -						&quot;registered with [&quot; + newMetaInfo.getStateType() + &quot;].&quot;);
    -			}
&lt;p&gt;    +				restoredMetaInfoSnapshot != null,&lt;br/&gt;
    +				&quot;Requested to check compatibility of a restored RegisteredKeyedBackendStateMetaInfo,&quot; +&lt;br/&gt;
    +					&quot; but its corresponding restored snapshot cannot be found.&quot;);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// check compatibility results to determine if state migration is required&lt;/li&gt;
	&lt;li&gt;CompatibilityResult&amp;lt;N&amp;gt; namespaceCompatibility = CompatibilityUtil.resolveCompatibilityResult(&lt;/li&gt;
	&lt;li&gt;restoredMetaInfo.getNamespaceSerializer(),&lt;/li&gt;
	&lt;li&gt;null,&lt;/li&gt;
	&lt;li&gt;restoredMetaInfo.getNamespaceSerializerConfigSnapshot(),&lt;/li&gt;
	&lt;li&gt;newMetaInfo.getNamespaceSerializer());&lt;br/&gt;
    +			newMetaInfo = RegisteredKeyedBackendStateMetaInfo.resolveKvStateCompatibility(&lt;br/&gt;
    +				restoredMetaInfoSnapshot,&lt;br/&gt;
    +				namespaceSerializer,&lt;br/&gt;
    +				stateDesc);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CompatibilityResult&amp;lt;S&amp;gt; stateCompatibility = CompatibilityUtil.resolveCompatibilityResult(&lt;/li&gt;
	&lt;li&gt;restoredMetaInfo.getStateSerializer(),&lt;/li&gt;
	&lt;li&gt;UnloadableDummyTypeSerializer.class,&lt;/li&gt;
	&lt;li&gt;restoredMetaInfo.getStateSerializerConfigSnapshot(),&lt;/li&gt;
	&lt;li&gt;newMetaInfo.getStateSerializer());&lt;br/&gt;
    +			stateInfo.f1 = newMetaInfo;&lt;br/&gt;
    +		} else {&lt;br/&gt;
    +			String stateName = stateDesc.getName();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (namespaceCompatibility.isRequiresMigration() || stateCompatibility.isRequiresMigration()) 
{
    -				// TODO state migration currently isn&apos;t possible.
    -				throw new StateMigrationException(&quot;State migration isn&apos;t supported, yet.&quot;);
    -			}
&lt;p&gt; else &lt;/p&gt;
{
    -				stateInfo.f1 = newMetaInfo;
    -				return stateInfo.f0;
    -			}
&lt;p&gt;    +			newMetaInfo = new RegisteredKeyedBackendStateMetaInfo&amp;lt;&amp;gt;(&lt;br/&gt;
    +				stateDesc.getType(),&lt;br/&gt;
    +				stateName,&lt;br/&gt;
    +				namespaceSerializer,&lt;br/&gt;
    +				stateDesc.getSerializer());&lt;br/&gt;
    +&lt;br/&gt;
    +			ColumnFamilyHandle columnFamily = createColumnFamily(stateName);&lt;br/&gt;
    +&lt;br/&gt;
    +			stateInfo = Tuple2.of(columnFamily, newMetaInfo);&lt;br/&gt;
    +			kvStateInformation.put(stateDesc.getName(), stateInfo);&lt;br/&gt;
     		}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;byte[] nameBytes = descriptor.getName().getBytes(ConfigConstants.DEFAULT_CHARSET);&lt;br/&gt;
    +		return stateInfo;&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Creates a column family handle for use with a k/v state.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private ColumnFamilyHandle createColumnFamily(String stateName) throws IOException, StateMigrationException {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This method now longer throws `StateMigrationException`, so it could be removed.&lt;/p&gt;</comment>
                            <comment id="16456451" author="githubbot" created="Fri, 27 Apr 2018 13:43:37 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184690567&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184690567&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -1116,148 +1115,177 @@ private void restoreKeyGroupsShardWithTemporaryHelperInstance(&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Creates a column family handle for use with a k/v state. When restoring from a snapshot&lt;/li&gt;
	&lt;li&gt;* we don&apos;t restore the individual k/v states, just the global RocksDB database and the&lt;/li&gt;
	&lt;li&gt;* list of column families. When a k/v state is first requested we check here whether we&lt;/li&gt;
	&lt;li&gt;* already have a column family for that and return it or create a new one if it doesn&apos;t exist.&lt;br/&gt;
    +	 * Registers a k/v state information, which includes its state id, type, RocksDB column family handle, and serializers.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This also checks whether the 
{@link StateDescriptor}
&lt;p&gt; for a state matches the one&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;* that we checkpointed, i.e. is already in the map of column families.&lt;br/&gt;
    +	 * When restoring from a snapshot, we don&#8217;t restore the individual k/v states, just the global RocksDB database and&lt;br/&gt;
    +	 * the list of k/v state information. When a k/v state is first requested we check here whether we&lt;br/&gt;
    +	 * already have a registered entry for that and return it (after some necessary state compatibility checks)&lt;br/&gt;
    +	 * or create a new one if it does not exist.&lt;br/&gt;
     	 */&lt;/li&gt;
	&lt;li&gt;@SuppressWarnings(&quot;rawtypes, unchecked&quot;)&lt;/li&gt;
	&lt;li&gt;protected &amp;lt;N, S&amp;gt; ColumnFamilyHandle getColumnFamily(&lt;/li&gt;
	&lt;li&gt;StateDescriptor&amp;lt;?, S&amp;gt; descriptor, TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) throws IOException, StateMigrationException {&lt;br/&gt;
    +	private Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;?, ?&amp;gt;&amp;gt; tryRegisterKvStateInformation(
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We could rewrite this as&lt;br/&gt;
    ```&lt;br/&gt;
    	private &amp;lt;N, S&amp;gt; Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;N, S&amp;gt;&amp;gt; tryRegisterKvStateInformation(&lt;br/&gt;
    			StateDescriptor&amp;lt;?, S&amp;gt; stateDesc,&lt;br/&gt;
    			TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) throws StateMigrationException, IOException {&lt;/p&gt;

&lt;p&gt;    		Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;?, ?&amp;gt;&amp;gt; registeredInfo =&lt;br/&gt;
    			this.kvStateInformation.get(stateDesc.getName());&lt;/p&gt;

&lt;p&gt;    		if (registeredInfo != null) &lt;/p&gt;
{
    
    			@SuppressWarnings(&quot;unchecked&quot;)
    			RegisteredKeyedBackendStateMetaInfo.Snapshot&amp;lt;?, ?&amp;gt; restoredMetaInfoSnapshot =
    				restoredKvStateMetaInfos.get(stateDesc.getName());
    
    			Preconditions.checkState(
    				restoredMetaInfoSnapshot != null,
    				&quot;Requested to check compatibility of a restored RegisteredKeyedBackendStateMetaInfo,&quot; +
    					&quot; but its corresponding restored snapshot cannot be found.&quot;);
    
    			RegisteredKeyedBackendStateMetaInfo&amp;lt;N, S&amp;gt; resolveKvStateCompatibility =
    				RegisteredKeyedBackendStateMetaInfo.resolveKvStateCompatibility(
    				restoredMetaInfoSnapshot,
    				namespaceSerializer,
    				stateDesc);
    
    			registeredInfo.f1 = resolveKvStateCompatibility;
    
    			return Tuple2.of(registeredInfo.f0, resolveKvStateCompatibility);
    		}
&lt;p&gt; else &lt;/p&gt;
{
    			String stateName = stateDesc.getName();
    			RegisteredKeyedBackendStateMetaInfo&amp;lt;N, S&amp;gt; newMetaInfo = new RegisteredKeyedBackendStateMetaInfo&amp;lt;&amp;gt;(
    				stateDesc.getType(),
    				stateName,
    				namespaceSerializer,
    				stateDesc.getSerializer());
    
    			ColumnFamilyHandle columnFamily = createColumnFamily(stateName);
    			registeredInfo = Tuple2.of(columnFamily, newMetaInfo);
    			this.kvStateInformation.put(stateDesc.getName(), registeredInfo);
    			return Tuple2.of(columnFamily, newMetaInfo);
    		}
&lt;p&gt;    	}&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    and get rid of all the individual casts.&lt;/p&gt;</comment>
                            <comment id="16456458" author="githubbot" created="Fri, 27 Apr 2018 13:46:12 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Had two more suggestions, otherwise this is &#128077; for merging.&lt;/p&gt;</comment>
                            <comment id="16456459" author="githubbot" created="Fri, 27 Apr 2018 13:47:09 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184691691&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184691691&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -1116,148 +1115,177 @@ private void restoreKeyGroupsShardWithTemporaryHelperInstance(&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Creates a column family handle for use with a k/v state. When restoring from a snapshot&lt;/li&gt;
	&lt;li&gt;* we don&apos;t restore the individual k/v states, just the global RocksDB database and the&lt;/li&gt;
	&lt;li&gt;* list of column families. When a k/v state is first requested we check here whether we&lt;/li&gt;
	&lt;li&gt;* already have a column family for that and return it or create a new one if it doesn&apos;t exist.&lt;br/&gt;
    +	 * Registers a k/v state information, which includes its state id, type, RocksDB column family handle, and serializers.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This also checks whether the 
{@link StateDescriptor}
&lt;p&gt; for a state matches the one&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;* that we checkpointed, i.e. is already in the map of column families.&lt;br/&gt;
    +	 * When restoring from a snapshot, we don&#8217;t restore the individual k/v states, just the global RocksDB database and&lt;br/&gt;
    +	 * the list of k/v state information. When a k/v state is first requested we check here whether we&lt;br/&gt;
    +	 * already have a registered entry for that and return it (after some necessary state compatibility checks)&lt;br/&gt;
    +	 * or create a new one if it does not exist.&lt;br/&gt;
     	 */&lt;/li&gt;
	&lt;li&gt;@SuppressWarnings(&quot;rawtypes, unchecked&quot;)&lt;/li&gt;
	&lt;li&gt;protected &amp;lt;N, S&amp;gt; ColumnFamilyHandle getColumnFamily(&lt;/li&gt;
	&lt;li&gt;StateDescriptor&amp;lt;?, S&amp;gt; descriptor, TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) throws IOException, StateMigrationException {&lt;br/&gt;
    +	private Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;?, ?&amp;gt;&amp;gt; tryRegisterKvStateInformation(
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    And we can remove also the lines that suppress warnings&lt;/p&gt;</comment>
                            <comment id="16456482" author="githubbot" created="Fri, 27 Apr 2018 13:58:21 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184694977&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184694977&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -1116,148 +1115,177 @@ private void restoreKeyGroupsShardWithTemporaryHelperInstance(&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Creates a column family handle for use with a k/v state. When restoring from a snapshot&lt;/li&gt;
	&lt;li&gt;* we don&apos;t restore the individual k/v states, just the global RocksDB database and the&lt;/li&gt;
	&lt;li&gt;* list of column families. When a k/v state is first requested we check here whether we&lt;/li&gt;
	&lt;li&gt;* already have a column family for that and return it or create a new one if it doesn&apos;t exist.&lt;br/&gt;
    +	 * Registers a k/v state information, which includes its state id, type, RocksDB column family handle, and serializers.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This also checks whether the 
{@link StateDescriptor}
&lt;p&gt; for a state matches the one&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;* that we checkpointed, i.e. is already in the map of column families.&lt;br/&gt;
    +	 * When restoring from a snapshot, we don&#8217;t restore the individual k/v states, just the global RocksDB database and&lt;br/&gt;
    +	 * the list of k/v state information. When a k/v state is first requested we check here whether we&lt;br/&gt;
    +	 * already have a registered entry for that and return it (after some necessary state compatibility checks)&lt;br/&gt;
    +	 * or create a new one if it does not exist.&lt;br/&gt;
     	 */&lt;/li&gt;
	&lt;li&gt;@SuppressWarnings(&quot;rawtypes, unchecked&quot;)&lt;/li&gt;
	&lt;li&gt;protected &amp;lt;N, S&amp;gt; ColumnFamilyHandle getColumnFamily(&lt;/li&gt;
	&lt;li&gt;StateDescriptor&amp;lt;?, S&amp;gt; descriptor, TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) throws IOException, StateMigrationException {&lt;br/&gt;
    +	private Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;?, ?&amp;gt;&amp;gt; tryRegisterKvStateInformation(
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I did not go with this approach because of the extra tuples introduced.&lt;br/&gt;
    Though, TBH, I wasn&apos;t sure which was the better approach, this or the one you pointed out.&lt;/p&gt;

&lt;p&gt;    I would not be against this version.&lt;/p&gt;</comment>
                            <comment id="16456488" author="githubbot" created="Fri, 27 Apr 2018 14:02:09 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184696134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184696134&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -1116,148 +1115,177 @@ private void restoreKeyGroupsShardWithTemporaryHelperInstance(&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Creates a column family handle for use with a k/v state. When restoring from a snapshot&lt;/li&gt;
	&lt;li&gt;* we don&apos;t restore the individual k/v states, just the global RocksDB database and the&lt;/li&gt;
	&lt;li&gt;* list of column families. When a k/v state is first requested we check here whether we&lt;/li&gt;
	&lt;li&gt;* already have a column family for that and return it or create a new one if it doesn&apos;t exist.&lt;br/&gt;
    +	 * Registers a k/v state information, which includes its state id, type, RocksDB column family handle, and serializers.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This also checks whether the 
{@link StateDescriptor}
&lt;p&gt; for a state matches the one&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;* that we checkpointed, i.e. is already in the map of column families.&lt;br/&gt;
    +	 * When restoring from a snapshot, we don&#8217;t restore the individual k/v states, just the global RocksDB database and&lt;br/&gt;
    +	 * the list of k/v state information. When a k/v state is first requested we check here whether we&lt;br/&gt;
    +	 * already have a registered entry for that and return it (after some necessary state compatibility checks)&lt;br/&gt;
    +	 * or create a new one if it does not exist.&lt;br/&gt;
     	 */&lt;/li&gt;
	&lt;li&gt;@SuppressWarnings(&quot;rawtypes, unchecked&quot;)&lt;/li&gt;
	&lt;li&gt;protected &amp;lt;N, S&amp;gt; ColumnFamilyHandle getColumnFamily(&lt;/li&gt;
	&lt;li&gt;StateDescriptor&amp;lt;?, S&amp;gt; descriptor, TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) throws IOException, StateMigrationException {&lt;br/&gt;
    +	private Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;?, ?&amp;gt;&amp;gt; tryRegisterKvStateInformation(
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This method is rarely invoked, the tuples are not immutable so giving a defensive copy can also have its benefits an I feel like this is cleaner than having casts all over the place. There might also be different ways to solve the general problem, but this feels better to me than the initial version.&lt;/p&gt;</comment>
                            <comment id="16457248" author="githubbot" created="Sat, 28 Apr 2018 00:13:34 +0000"  >&lt;p&gt;Github user bowenli86 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184831125&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184831125&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -190,4 +197,12 @@ protected void writeKeyWithGroupAndNamespace(&lt;br/&gt;
     		RocksDBKeySerializationUtils.writeKey(key, keySerializer, keySerializationStream, keySerializationDataOutputView, ambiguousKeyPossible);&lt;br/&gt;
     		RocksDBKeySerializationUtils.writeNameSpace(namespace, namespaceSerializer, keySerializationStream, keySerializationDataOutputView, ambiguousKeyPossible);&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	protected V getDefaultValue() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    this method is duplicated among some impl classes. We can move it to `InternalKvState` as a &lt;span class=&quot;error&quot;&gt;&amp;#91;default method&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://docs.oracle.com/javase/tutorial/java/IandI/defaultmethods.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/tutorial/java/IandI/defaultmethods.html&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="16457249" author="githubbot" created="Sat, 28 Apr 2018 00:13:34 +0000"  >&lt;p&gt;Github user bowenli86 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184830451&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184830451&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/AbstractKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -455,4 +455,5 @@ public StreamCompressionDecorator getKeyGroupCompressionDecorator() {&lt;br/&gt;
     	@VisibleForTesting&lt;br/&gt;
     	public abstract int numStateEntries();&lt;/p&gt;

&lt;p&gt;    +&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    revert this?&lt;/p&gt;</comment>
                            <comment id="16457356" author="githubbot" created="Sat, 28 Apr 2018 04:57:56 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184840215&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184840215&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/AbstractKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -455,4 +455,5 @@ public StreamCompressionDecorator getKeyGroupCompressionDecorator() {&lt;br/&gt;
     	@VisibleForTesting&lt;br/&gt;
     	public abstract int numStateEntries();&lt;/p&gt;

&lt;p&gt;    +&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Will revert &#128077; &lt;/p&gt;</comment>
                            <comment id="16457357" author="githubbot" created="Sat, 28 Apr 2018 04:58:45 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184840230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184840230&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -1116,148 +1115,177 @@ private void restoreKeyGroupsShardWithTemporaryHelperInstance(&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Creates a column family handle for use with a k/v state. When restoring from a snapshot&lt;/li&gt;
	&lt;li&gt;* we don&apos;t restore the individual k/v states, just the global RocksDB database and the&lt;/li&gt;
	&lt;li&gt;* list of column families. When a k/v state is first requested we check here whether we&lt;/li&gt;
	&lt;li&gt;* already have a column family for that and return it or create a new one if it doesn&apos;t exist.&lt;br/&gt;
    +	 * Registers a k/v state information, which includes its state id, type, RocksDB column family handle, and serializers.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This also checks whether the 
{@link StateDescriptor}
&lt;p&gt; for a state matches the one&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;* that we checkpointed, i.e. is already in the map of column families.&lt;br/&gt;
    +	 * When restoring from a snapshot, we don&#8217;t restore the individual k/v states, just the global RocksDB database and&lt;br/&gt;
    +	 * the list of k/v state information. When a k/v state is first requested we check here whether we&lt;br/&gt;
    +	 * already have a registered entry for that and return it (after some necessary state compatibility checks)&lt;br/&gt;
    +	 * or create a new one if it does not exist.&lt;br/&gt;
     	 */&lt;/li&gt;
	&lt;li&gt;@SuppressWarnings(&quot;rawtypes, unchecked&quot;)&lt;/li&gt;
	&lt;li&gt;protected &amp;lt;N, S&amp;gt; ColumnFamilyHandle getColumnFamily(&lt;/li&gt;
	&lt;li&gt;StateDescriptor&amp;lt;?, S&amp;gt; descriptor, TypeSerializer&amp;lt;N&amp;gt; namespaceSerializer) throws IOException, StateMigrationException {&lt;br/&gt;
    +	private Tuple2&amp;lt;ColumnFamilyHandle, RegisteredKeyedBackendStateMetaInfo&amp;lt;?, ?&amp;gt;&amp;gt; tryRegisterKvStateInformation(
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Will change this as suggested!&lt;/p&gt;</comment>
                            <comment id="16457373" author="githubbot" created="Sat, 28 Apr 2018 05:39:36 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184841123&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184841123&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -190,4 +197,12 @@ protected void writeKeyWithGroupAndNamespace(&lt;br/&gt;
     		RocksDBKeySerializationUtils.writeKey(key, keySerializer, keySerializationStream, keySerializationDataOutputView, ambiguousKeyPossible);&lt;br/&gt;
     		RocksDBKeySerializationUtils.writeNameSpace(namespace, namespaceSerializer, keySerializationStream, keySerializationDataOutputView, ambiguousKeyPossible);&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	protected V getDefaultValue() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Not too sure about this one.&lt;/p&gt;

&lt;p&gt;    That would require introducing 2 methods in the `InternalKvState`:&lt;br/&gt;
    1. A getter method that returns the default value.&lt;br/&gt;
    2. A default method that actually does the serialization copying of the default value (the current `getDefaultValue` method).&lt;/p&gt;</comment>
                            <comment id="16457468" author="githubbot" created="Sat, 28 Apr 2018 09:04:08 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885#discussion_r184846476&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885#discussion_r184846476&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -190,4 +197,12 @@ protected void writeKeyWithGroupAndNamespace(&lt;br/&gt;
     		RocksDBKeySerializationUtils.writeKey(key, keySerializer, keySerializationStream, keySerializationDataOutputView, ambiguousKeyPossible);&lt;br/&gt;
     		RocksDBKeySerializationUtils.writeNameSpace(namespace, namespaceSerializer, keySerializationStream, keySerializationDataOutputView, ambiguousKeyPossible);&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	protected V getDefaultValue() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Since this PR is blocking a bug for the 1.5 release, I&apos;ll proceed to merge this as it is.&lt;br/&gt;
    @bowenli86 Perhaps we can open a separate JIRA for this to keep this in mind?&lt;/p&gt;</comment>
                            <comment id="16457473" author="githubbot" created="Sat, 28 Apr 2018 09:08:28 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the reviews @bowenli86 @StefanRRichter! I&apos;ve merged this.&lt;/p&gt;</comment>
                            <comment id="16457474" author="githubbot" created="Sat, 28 Apr 2018 09:08:54 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5885&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16457476" author="tzulitai" created="Sat, 28 Apr 2018 09:09:33 +0000"  >&lt;p&gt;Merged.&lt;/p&gt;

&lt;p&gt;1.6.0:&#160;07aa2d469e34884d715b01166db077a4cf7cf3af&lt;br/&gt;
1.5.0:&#160;fe0d8135bf3520af70071e634cf4dadae634b56a&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 29 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qdk7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>