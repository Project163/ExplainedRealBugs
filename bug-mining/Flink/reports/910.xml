<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:23:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-3179] Combiner is not injected if Reduce or GroupReduce input is explicitly partitioned</title>
                <link>https://issues.apache.org/jira/browse/FLINK-3179</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The optimizer does not inject a combiner if the input of a Reducer or GroupReducer is explicitly partitioned as in the following example&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;&amp;gt; words = ...
DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;&amp;gt; counts = words
  .partitionByHash(0)
  .groupBy(0)
  .sum(1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Explicit partitioning can be useful to enforce partitioning on a subset of keys or to use a different partitioning method (custom or range partitioning).&lt;/p&gt;

&lt;p&gt;This issue should be fixed by changing the &lt;tt&gt;instantiate()&lt;/tt&gt; methods of the &lt;tt&gt;ReduceProperties&lt;/tt&gt; and &lt;tt&gt;GroupReduceWithCombineProperties&lt;/tt&gt; classes such that a combine is injected in front of a &lt;tt&gt;PartitionPlanNode&lt;/tt&gt; if it is the input of a Reduce or GroupReduce operator. This should only happen, if the Reducer is the only successor of the Partition operator.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12922478">FLINK-3179</key>
            <summary>Combiner is not injected if Reduce or GroupReduce input is explicitly partitioned</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ram_krish">ramkrishna.s.vasudevan</assignee>
                                    <reporter username="fhueske">Fabian Hueske</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Dec 2015 20:02:32 +0000</created>
                <updated>Thu, 28 Feb 2019 14:30:05 +0000</updated>
                            <resolved>Tue, 22 Mar 2016 13:46:55 +0000</resolved>
                                    <version>0.10.1</version>
                                    <fixVersion>1.0.1</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>API / DataSet</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15119716" author="githubbot" created="Wed, 27 Jan 2016 16:33:45 +0000"  >&lt;p&gt;GitHub user ramkrish86 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3179&quot; title=&quot;Combiner is not injected if Reduce or GroupReduce input is explicitly partitioned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3179&quot;&gt;&lt;del&gt;FLINK-3179&lt;/del&gt;&lt;/a&gt; Combiner is not injected if Reduce or GroupReduce input is explicitly partitioned (Ram)&lt;/p&gt;

&lt;p&gt;    Followed the guidance given in the description in order to fix this. Is the approach correct here?  Also using this to learn the code. &lt;br/&gt;
    Once we see that a partition node is the input of a reduce node or group reduce node -  we try to inject the combiner to the source node (the data source node) and the reducer node will take the actual partition node as the input. &lt;br/&gt;
    So now the structure would be DataSource-&amp;gt;Combine-&amp;gt;Partition-&amp;gt;Reduce. &lt;br/&gt;
    Suggestions and feedback welcome as am not sure if I have covered all the cases here. &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ramkrish86/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ramkrish86/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3179&quot; title=&quot;Combiner is not injected if Reduce or GroupReduce input is explicitly partitioned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3179&quot;&gt;&lt;del&gt;FLINK-3179&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1553&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ccf6e18418ac9cae1c27a5ff4399ea188b03bc0b&lt;br/&gt;
Author: ramkrishna &amp;lt;ramkrishna.s.vasudevan@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-01-27T16:27:17Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3179&quot; title=&quot;Combiner is not injected if Reduce or GroupReduce input is explicitly partitioned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3179&quot;&gt;&lt;del&gt;FLINK-3179&lt;/del&gt;&lt;/a&gt; Combiner is not injected if Reduce or GroupReduce input is&lt;br/&gt;
    explicitly partitioned (Ram)&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15119719" author="githubbot" created="Wed, 27 Jan 2016 16:34:23 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-175730064&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-175730064&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Also ensured that the related test cases passes and also the Wordcount program output with and without partition remains the same. &lt;/p&gt;</comment>
                            <comment id="15121041" author="githubbot" created="Thu, 28 Jan 2016 08:44:52 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-176059338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-176059338&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the PR! &lt;br/&gt;
    I&apos;ll have a look at it and give feedback hopefully today or tomorrow.&lt;/p&gt;</comment>
                            <comment id="15123461" author="githubbot" created="Fri, 29 Jan 2016 13:17:12 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r51259067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r51259067&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -102,36 +107,72 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) &lt;/p&gt;
{
     											DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);
     		}
&lt;p&gt; else {&lt;br/&gt;
     			// non forward case. all local properties are killed anyways, so we can safely plug in a combiner&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The `else` branch will not be entered if the GroupReduce&apos;s predecessor is a Partition operator.&lt;br/&gt;
    You need to add an `if else` branch to the condition.&lt;/p&gt;</comment>
                            <comment id="15123463" author="githubbot" created="Fri, 29 Jan 2016 13:17:19 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r51259080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r51259080&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/ReduceProperties.java &amp;#8212;&lt;br/&gt;
    @@ -66,30 +70,62 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		}&lt;br/&gt;
     		else {&lt;br/&gt;
     			// non forward case. all local properties are killed anyways, so we can safely plug in a combiner&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The `else` branch will not be entered if the Reduce&apos;s predecessor is a Partition operator.&lt;br/&gt;
    You need to add an `if else` branch to the condition.&lt;/p&gt;</comment>
                            <comment id="15123471" author="githubbot" created="Fri, 29 Jan 2016 13:30:29 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-176754489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-176754489&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    You identified the right classes and methods for the fix, but the place within the method is not correct. Let me explain the issue.&lt;/p&gt;

&lt;p&gt;    In the common case as for example in a WordCount program, the operator order looks like this:&lt;br/&gt;
    ```&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;Map&amp;#93;&lt;/span&gt; -&lt;del&gt;hash-partition&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce&amp;#93;&lt;/span&gt;&lt;br/&gt;
    ```&lt;br/&gt;
    in this case, a combiner will be append to the Map to reduce the data before it is partitioned over the network. This looks like:&lt;br/&gt;
    ```&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;Map&amp;#93;&lt;/span&gt; -&lt;del&gt;local-fwd&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Combine&amp;#93;&lt;/span&gt; --hash-partition&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce&amp;#93;&lt;/span&gt;&lt;br/&gt;
    ```&lt;br/&gt;
    In some cases, Flink knows that the data is already appropriately partitioned (e.g. after a join):&lt;br/&gt;
    ```&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;Join&amp;#93;&lt;/span&gt; -&lt;del&gt;local-fwd&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce&amp;#93;&lt;/span&gt;&lt;br/&gt;
    ```&lt;br/&gt;
    in this case, the data is already local and no combiner needs to injected. The check is based on the shipping strategy of the input channel (this is the `if` case in `instantiate()`).&lt;/p&gt;

&lt;p&gt;    In case of an explicit partition operator, the operators look as follows:&lt;br/&gt;
    ```&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;Map&amp;#93;&lt;/span&gt; -&lt;del&gt;partition&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Partition&amp;#93;&lt;/span&gt; --local-fwd&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce&amp;#93;&lt;/span&gt;&lt;br/&gt;
    ```&lt;br/&gt;
    hence, the code enters the `if` case, because the input shipping strategy is `FORWARD`.&lt;br/&gt;
    Instead we would like to inject a combiner between Map and Partition as follows:&lt;br/&gt;
    ```&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;Map&amp;#93;&lt;/span&gt; -&lt;del&gt;local-fwd&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Combine&amp;#93;&lt;/span&gt; --partition&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Partition&amp;#93;&lt;/span&gt; --local-fwd&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce&amp;#93;&lt;/span&gt;&lt;br/&gt;
    ```&lt;br/&gt;
    Hence, we should adapt the condition to inject a combiner if the input strategy of Reduce is `FORWARD` and the input operator is a `PartitionNode`.&lt;/p&gt;

&lt;p&gt;    We should add appropriate tests for this feature. I suggest:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a unit test case in `GroupReduceCompilationTest`&lt;/li&gt;
	&lt;li&gt;a unit test case in `ReduceCompilationTest`&lt;/li&gt;
	&lt;li&gt;an end-to-end integration test in `javaApiOperators.GroupReduceITCase`&lt;/li&gt;
	&lt;li&gt;an end-to-end integration test in `javaApiOperators.ReduceITCase`&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15124755" author="githubbot" created="Sat, 30 Jan 2016 06:03:48 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-177080713&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-177080713&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you very much for the feedback. Let me try to understand this thing better and update the PR sooner. I will reach out here in case of any questions or doubts that I have. Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="15126204" author="githubbot" created="Mon, 1 Feb 2016 12:52:34 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-177957906&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-177957906&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I went through the code. In both cases of WordCount program with and without explicit partition&lt;br/&gt;
    `&lt;span class=&quot;error&quot;&gt;&amp;#91;Map&amp;#93;&lt;/span&gt; -&lt;del&gt;hash-partition&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce&amp;#93;&lt;/span&gt;`&lt;br/&gt;
    `&lt;span class=&quot;error&quot;&gt;&amp;#91;Map&amp;#93;&lt;/span&gt; -&lt;del&gt;partition&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Partition&amp;#93;&lt;/span&gt; --local-fwd&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce&amp;#93;&lt;/span&gt;`&lt;br/&gt;
    I see that it goes to the &apos;else&apos; part of the GroupReduceWithCombineProperties#instantiate() method. I debugged once again for both cases. &lt;/p&gt;

&lt;p&gt;    &amp;gt; hence, the code enters the if case, because the input shipping strategy is FORWARD.&lt;br/&gt;
    So with an explicit partitioner I don&apos;t see that happening. The input shipping strategy of the PARTITION node seems to have PARTITION_HASH as the strategy. &lt;br/&gt;
    So what am I missing here?&lt;/p&gt;</comment>
                            <comment id="15126305" author="githubbot" created="Mon, 1 Feb 2016 14:38:14 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-177997324&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-177997324&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The `GroupReduceWithCombineProperties.instanciate()` method checks the shipping strategy of the input channel. In case of the `WordCount` example &lt;b&gt;without&lt;/b&gt; explicit hash combiner, the shipping strategy is `PARTITION_HASH` and the `else` branch will inject a combiner. If you add an explicit partition operator, the input shipping strategy of the Reduce operator is `FORWARD` and the `if` branch is executed and does not add a combiner.&lt;/p&gt;

&lt;p&gt;    Hence the logic has to into the `if` branch and not into the `else` branch. Or even better add an additional condition to the `if` case `!(in.getSource().getOptimizerNode() instanceof PartitionNode)` and add an `if else` branch to handle the special case of the explicit partition operator.&lt;/p&gt;</comment>
                            <comment id="15134061" author="ram_krish" created="Fri, 5 Feb 2016 12:09:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt;&lt;br/&gt;
Was stuck with some work. Will come back to this next week.&lt;/p&gt;</comment>
                            <comment id="15143123" author="githubbot" created="Thu, 11 Feb 2016 17:37:42 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-182969700&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-182969700&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Might be a stupid question, but what if the partitioner depends on the number of elements. E.g. if you use `partitionCustom` with `Partitioner` which counts internally the elements and assigns the output channel number with respect to this count. In such a case, a combiner would change the result.&lt;/p&gt;</comment>
                            <comment id="15143301" author="githubbot" created="Thu, 11 Feb 2016 19:12:52 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-183014873&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-183014873&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    If a `Partitioner` is implemented such that is does not partition based on the key attribute, it cannot be used for a Reduce or GroupReduce transformation anyways. Also users should expect that a combiner is applied if a `ReduceFunction` or a `GroupReduceFunction` that implements a combine interface is used.&lt;/p&gt;</comment>
                            <comment id="15144103" author="githubbot" created="Fri, 12 Feb 2016 06:03:51 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-183190815&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-183190815&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @fhueske &lt;br/&gt;
    I got the problem that I was making. My bad. I was not applying the partition function on the Key ie. the String part returned from the flat map and hence the flow was going to the &apos;else&apos; case always. Now that I got what was the issue I was having I think I can update this PR shortly. Thanks for the patient review. &lt;/p&gt;</comment>
                            <comment id="15144274" author="githubbot" created="Fri, 12 Feb 2016 08:44:34 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-183230276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-183230276&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @ramkrish86, no worries &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
    I guess the issue description lacked a bit of detail. Flink&apos;s optimizer checks, if the partitioning produced by the explicit partitioning operator (hash, range, custom) can be reused for the Reduce. If not, the data is partitioned again and this time the combiner can be applied, since it is the regular.&lt;/p&gt;

&lt;p&gt;    Thanks for working on this..&lt;/p&gt;</comment>
                            <comment id="15148072" author="ram_krish" created="Tue, 16 Feb 2016 04:20:29 +0000"  >&lt;p&gt;I have updated the PR &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt;. Things seems to work but am not sure on the way things are done. May need some refinement. Feedback and comments welcome.&lt;/p&gt;</comment>
                            <comment id="15149868" author="githubbot" created="Wed, 17 Feb 2016 05:08:39 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-185025591&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-185025591&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    A new push request has been submitted. JYFI @fhueske .&lt;/p&gt;</comment>
                            <comment id="15150338" author="githubbot" created="Wed, 17 Feb 2016 11:29:28 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53151545&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53151545&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-examples/flink-examples-batch/src/main/java/org/apache/flink/examples/java/wordcount/WordCount.java &amp;#8212;&lt;br/&gt;
    @@ -66,7 +66,7 @@ public static void main(String[] args) throws Exception {&lt;/p&gt;

&lt;p&gt;     		DataSet&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; counts = &lt;br/&gt;
     				// split up the lines in pairs (2-tuples) containing: (word,1)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;text.flatMap(new Tokenizer())&lt;br/&gt;
    +				(text.flatMap(new Tokenizer()))
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Unnecessary change&lt;/p&gt;</comment>
                            <comment id="15150340" author="githubbot" created="Wed, 17 Feb 2016 11:29:54 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53151578&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53151578&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why do you remove the `@Override` annotation?&lt;/p&gt;</comment>
                            <comment id="15150342" author="githubbot" created="Wed, 17 Feb 2016 11:30:22 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53151628&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53151628&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -110,28 +135,49 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			combinerNode.setParallelism(in.getSource().getParallelism());&lt;/p&gt;

&lt;p&gt;     			SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
    +				.getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
     			combiner.setCosts(new Costs(0, 0));&lt;br/&gt;
     			combiner.initProperties(toCombiner.getGlobalProperties(), toCombiner.getLocalProperties());&lt;br/&gt;
     			// set sorting comparator key info&lt;br/&gt;
     			combiner.setDriverKeyInfo(in.getLocalStrategyKeys(), in.getLocalStrategySortOrder(), 0);&lt;br/&gt;
     			// set grouping comparator key info&lt;br/&gt;
     			combiner.setDriverKeyInfo(this.keyList, 1);&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;    +&lt;br/&gt;
     			Channel toReducer = new Channel(combiner);&lt;br/&gt;
     			toReducer.setShipStrategy(in.getShipStrategy(), in.getShipStrategyKeys(),&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;in.getShipStrategySortOrder(), in.getDataExchangeMode());&lt;br/&gt;
    +				in.getShipStrategySortOrder(), in.getDataExchangeMode());&lt;br/&gt;
     			if (in.getShipStrategy() == ShipStrategyType.PARTITION_RANGE) 
{
     				toReducer.setDataDistribution(in.getDataDistribution());
     			}
&lt;p&gt;     			toReducer.setLocalStrategy(LocalStrategy.COMBININGSORT, in.getLocalStrategyKeys(),&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;in.getLocalStrategySortOrder());&lt;br/&gt;
    +				in.getLocalStrategySortOrder());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
    +				toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +	private void addCombinerNodeData(Channel in, Channel toCombiner, SingleInputPlanNode combiner) &lt;/p&gt;
{
    +		combiner.setCosts(new Costs(0, 0));
    +		combiner.initProperties(toCombiner.getGlobalProperties(), toCombiner.getLocalProperties());
    +		// set sorting comparator key info
    +		combiner.setDriverKeyInfo(in.getLocalStrategyKeys(), in.getLocalStrategySortOrder(), 0);
    +		// set grouping comparator key info
    +		combiner.setDriverKeyInfo(this.keyList, 1);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private SingleInputPlanNode getReducerSingleInputPlanNode(Channel in, SingleInputNode node) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I don&apos;t think we need to move this into a function.&lt;/p&gt;</comment>
                            <comment id="15150343" author="githubbot" created="Wed, 17 Feb 2016 11:30:53 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53151692&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53151692&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
     			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;/li&gt;
	&lt;li&gt;if (in.getLocalStrategy() == LocalStrategy.SORT) {&lt;/li&gt;
	&lt;li&gt;if (!in.getLocalStrategyKeys().isValidUnorderedPrefix(this.keys)) {&lt;/li&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Bug: Inconsistent sort for group strategy.&quot;);&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				// Inject a combiner before the partition node&lt;br/&gt;
    +				Channel toCombiner = new Channel(in.getSource());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    bad variable name. This channel will not lead to the combiner.&lt;/p&gt;</comment>
                            <comment id="15150344" author="githubbot" created="Wed, 17 Feb 2016 11:31:38 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53151777&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53151777&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
     			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;/li&gt;
	&lt;li&gt;if (in.getLocalStrategy() == LocalStrategy.SORT) {&lt;/li&gt;
	&lt;li&gt;if (!in.getLocalStrategyKeys().isValidUnorderedPrefix(this.keys)) {&lt;/li&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Bug: Inconsistent sort for group strategy.&quot;);&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think we can move the code of this branch into a method called `injectCombinerBeforePartitioner()`.&lt;/p&gt;</comment>
                            <comment id="15150354" author="githubbot" created="Wed, 17 Feb 2016 11:34:13 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53152023&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53152023&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -110,28 +135,49 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			combinerNode.setParallelism(in.getSource().getParallelism());&lt;/p&gt;

&lt;p&gt;     			SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
    +				.getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
     			combiner.setCosts(new Costs(0, 0));&lt;br/&gt;
     			combiner.initProperties(toCombiner.getGlobalProperties(), toCombiner.getLocalProperties());&lt;br/&gt;
     			// set sorting comparator key info&lt;br/&gt;
     			combiner.setDriverKeyInfo(in.getLocalStrategyKeys(), in.getLocalStrategySortOrder(), 0);&lt;br/&gt;
     			// set grouping comparator key info&lt;br/&gt;
     			combiner.setDriverKeyInfo(this.keyList, 1);&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;    +&lt;br/&gt;
     			Channel toReducer = new Channel(combiner);&lt;br/&gt;
     			toReducer.setShipStrategy(in.getShipStrategy(), in.getShipStrategyKeys(),&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;in.getShipStrategySortOrder(), in.getDataExchangeMode());&lt;br/&gt;
    +				in.getShipStrategySortOrder(), in.getDataExchangeMode());&lt;br/&gt;
     			if (in.getShipStrategy() == ShipStrategyType.PARTITION_RANGE) 
{
     				toReducer.setDataDistribution(in.getDataDistribution());
     			}
&lt;p&gt;     			toReducer.setLocalStrategy(LocalStrategy.COMBININGSORT, in.getLocalStrategyKeys(),&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;in.getLocalStrategySortOrder());&lt;br/&gt;
    +				in.getLocalStrategySortOrder());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
    +				toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +	private void addCombinerNodeData(Channel in, Channel toCombiner, SingleInputPlanNode combiner) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    please rename method to `setCombinerProperties()`&lt;/p&gt;</comment>
                            <comment id="15150355" author="githubbot" created="Wed, 17 Feb 2016 11:34:34 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53152054&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53152054&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -110,28 +135,49 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			combinerNode.setParallelism(in.getSource().getParallelism());&lt;/p&gt;

&lt;p&gt;     			SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
    +				.getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
     			combiner.setCosts(new Costs(0, 0));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    use the `setCombinerProperties()` method here.&lt;/p&gt;</comment>
                            <comment id="15150358" author="githubbot" created="Wed, 17 Feb 2016 11:35:06 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53152093&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53152093&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -110,28 +135,49 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			combinerNode.setParallelism(in.getSource().getParallelism());&lt;/p&gt;

&lt;p&gt;     			SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
    +				.getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
     			combiner.setCosts(new Costs(0, 0));&lt;br/&gt;
     			combiner.initProperties(toCombiner.getGlobalProperties(), toCombiner.getLocalProperties());&lt;br/&gt;
     			// set sorting comparator key info&lt;br/&gt;
     			combiner.setDriverKeyInfo(in.getLocalStrategyKeys(), in.getLocalStrategySortOrder(), 0);&lt;br/&gt;
     			// set grouping comparator key info&lt;br/&gt;
     			combiner.setDriverKeyInfo(this.keyList, 1);&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;    +&lt;br/&gt;
     			Channel toReducer = new Channel(combiner);&lt;br/&gt;
     			toReducer.setShipStrategy(in.getShipStrategy(), in.getShipStrategyKeys(),&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;in.getShipStrategySortOrder(), in.getDataExchangeMode());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Please avoid reformatting changes.&lt;/p&gt;</comment>
                            <comment id="15150361" author="githubbot" created="Wed, 17 Feb 2016 11:36:46 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53152240&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53152240&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
     			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;/li&gt;
	&lt;li&gt;if (in.getLocalStrategy() == LocalStrategy.SORT) {&lt;/li&gt;
	&lt;li&gt;if (!in.getLocalStrategyKeys().isValidUnorderedPrefix(this.keys)) {&lt;/li&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Bug: Inconsistent sort for group strategy.&quot;);&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				// Inject a combiner before the partition node&lt;br/&gt;
    +				Channel toCombiner = new Channel(in.getSource());&lt;br/&gt;
    +				toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);&lt;br/&gt;
    +				GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +				combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +				if(toCombiner.getSource().getInputs().iterator().hasNext()) {&lt;br/&gt;
    +					Channel source = toCombiner.getSource().getInputs().iterator().next();&lt;br/&gt;
    +					// A combiner plan node is created with the map as the input
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The operator before the partitioner is not necessarily a `mapper`.&lt;/p&gt;</comment>
                            <comment id="15150364" author="githubbot" created="Wed, 17 Feb 2016 11:39:10 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53152430&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53152430&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
     			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;/li&gt;
	&lt;li&gt;if (in.getLocalStrategy() == LocalStrategy.SORT) {&lt;/li&gt;
	&lt;li&gt;if (!in.getLocalStrategyKeys().isValidUnorderedPrefix(this.keys)) {&lt;/li&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Bug: Inconsistent sort for group strategy.&quot;);&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				// Inject a combiner before the partition node&lt;br/&gt;
    +				Channel toCombiner = new Channel(in.getSource());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This channel is also not used in the plan. It is just used for look-ups.&lt;/p&gt;</comment>
                            <comment id="15150368" author="githubbot" created="Wed, 17 Feb 2016 11:41:04 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53152587&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53152587&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
     			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;/li&gt;
	&lt;li&gt;if (in.getLocalStrategy() == LocalStrategy.SORT) {&lt;/li&gt;
	&lt;li&gt;if (!in.getLocalStrategyKeys().isValidUnorderedPrefix(this.keys)) {&lt;/li&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Bug: Inconsistent sort for group strategy.&quot;);&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				// Inject a combiner before the partition node&lt;br/&gt;
    +				Channel toCombiner = new Channel(in.getSource());&lt;br/&gt;
    +				toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);&lt;br/&gt;
    +				GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +				combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +				if(toCombiner.getSource().getInputs().iterator().hasNext()) {&lt;br/&gt;
    +					Channel source = toCombiner.getSource().getInputs().iterator().next();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This is the channel with the partitioner as target.&lt;/p&gt;</comment>
                            <comment id="15150371" author="githubbot" created="Wed, 17 Feb 2016 11:42:11 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53152668&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53152668&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
     			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;/li&gt;
	&lt;li&gt;if (in.getLocalStrategy() == LocalStrategy.SORT) {&lt;/li&gt;
	&lt;li&gt;if (!in.getLocalStrategyKeys().isValidUnorderedPrefix(this.keys)) {&lt;/li&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Bug: Inconsistent sort for group strategy.&quot;);&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				// Inject a combiner before the partition node&lt;br/&gt;
    +				Channel toCombiner = new Channel(in.getSource());&lt;br/&gt;
    +				toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);&lt;br/&gt;
    +				GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +				combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +				if(toCombiner.getSource().getInputs().iterator().hasNext()) {&lt;br/&gt;
    +					Channel source = toCombiner.getSource().getInputs().iterator().next();&lt;br/&gt;
    +					// A combiner plan node is created with the map as the input&lt;br/&gt;
    +					SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We should use a new channel here instead of the existing `source` channel. In the other branch, the new channel is called `toCombiner`.&lt;/p&gt;</comment>
                            <comment id="15150373" author="githubbot" created="Wed, 17 Feb 2016 11:45:08 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53152922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53152922&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
     			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;/li&gt;
	&lt;li&gt;if (in.getLocalStrategy() == LocalStrategy.SORT) {&lt;/li&gt;
	&lt;li&gt;if (!in.getLocalStrategyKeys().isValidUnorderedPrefix(this.keys)) {&lt;/li&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Bug: Inconsistent sort for group strategy.&quot;);&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				// Inject a combiner before the partition node&lt;br/&gt;
    +				Channel toCombiner = new Channel(in.getSource());&lt;br/&gt;
    +				toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);&lt;br/&gt;
    +				GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +				combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +				if(toCombiner.getSource().getInputs().iterator().hasNext()) {&lt;br/&gt;
    +					Channel source = toCombiner.getSource().getInputs().iterator().next();&lt;br/&gt;
    +					// A combiner plan node is created with the map as the input&lt;br/&gt;
    +					SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()&lt;br/&gt;
    +						.getName()+&quot;)&quot;, source, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
    +					addCombinerNodeData(in, toCombiner, combiner);&lt;br/&gt;
    +					Channel combinerChannel = new Channel(combiner);&lt;br/&gt;
    +					combinerChannel.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Note that the actual partitioning is defined on the `Channel` that points to the `Partitioner`, i.e., the data is already partitioned when it arrives at the partitioner.&lt;br/&gt;
    Therefore, this channel must reuse the original `ShipStrategyType` and `DataExchangeMode` of the channel pointing to `Partition`. Setting it to `FORWARD` will remove the partitioning.&lt;/p&gt;</comment>
                            <comment id="15150376" author="githubbot" created="Wed, 17 Feb 2016 11:47:46 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53153193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53153193&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/ReduceProperties.java &amp;#8212;&lt;br/&gt;
    @@ -59,37 +65,69 @@ public DriverStrategy getStrategy() {&lt;br/&gt;
     	@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD ||&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;(node.getBroadcastConnections() != null &amp;amp;&amp;amp; !node.getBroadcastConnections().isEmpty()))&lt;br/&gt;
    +			(node.getBroadcastConnections() != null &amp;amp;&amp;amp; !node.getBroadcastConnections().isEmpty()))&lt;br/&gt;
     		{&lt;br/&gt;
    +			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Please refactor the code of this branch into a method called `injectCombinerBeforePartitioner()`. Some of the comments in the other class apply here as well.&lt;/p&gt;</comment>
                            <comment id="15150377" author="githubbot" created="Wed, 17 Feb 2016 11:47:58 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53153223&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53153223&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/ReduceProperties.java &amp;#8212;&lt;br/&gt;
    @@ -59,37 +65,69 @@ public DriverStrategy getStrategy() {&lt;br/&gt;
     	@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD ||&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;(node.getBroadcastConnections() != null &amp;amp;&amp;amp; !node.getBroadcastConnections().isEmpty()))&lt;br/&gt;
    +			(node.getBroadcastConnections() != null &amp;amp;&amp;amp; !node.getBroadcastConnections().isEmpty()))&lt;br/&gt;
     		{&lt;br/&gt;
    +			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				Channel toCombiner = new Channel(in.getSource());    +				toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);    +				// create an input node for combine with same parallelism as input node    +				ReduceNode combinerNode = ((ReduceNode) node).getCombinerUtilityNode();    +				combinerNode.setParallelism(in.getSource().getParallelism());    +				if(toCombiner.getSource().getInputs().iterator().hasNext()) {
    +					Channel source = toCombiner.getSource().getInputs().iterator().next();
    +					SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode,
    +						&quot;Combine (&quot;+node.getOperator().getName()+&quot;)&quot;, source,
    +						DriverStrategy.SORTED_PARTIAL_REDUCE, this.keyList);
    +					addCombinerProperties(toCombiner, combiner);
    +					Channel combinerChannel = new Channel(combiner);
    +					combinerChannel.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);
    +					// Create the partition single input plan node from the existing partition node
    +					PlanNode partitionplanNode = in.getSource().getPlanNode();
    +					SingleInputPlanNode partition = new SingleInputPlanNode(in.getSource().getOptimizerNode(), partitionplanNode.getNodeName(),
    +						combinerChannel, partitionplanNode.getDriverStrategy());
    +					partition.setCosts(partitionplanNode.getNodeCosts());
    +					partition.initProperties(partitionplanNode.getGlobalProperties(), partitionplanNode.getLocalProperties());
    +					// Create a reducer such that the input of the reducer is the partition node
    +					Channel toReducer = new Channel(partition);
    +					toReducer.setShipStrategy(in.getShipStrategy(), in.getShipStrategyKeys(),
    +						in.getShipStrategySortOrder(), in.getDataExchangeMode());
    +					return new SingleInputPlanNode(node, &quot;Reduce (&quot;+node.getOperator().getName()+&quot;)&quot;, toReducer,
    +						DriverStrategy.SORTED_REDUCE, this.keyList);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;, in,&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;DriverStrategy.SORTED_REDUCE, this.keyList);&lt;br/&gt;
    +				DriverStrategy.SORTED_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     		else {&lt;br/&gt;
     			// non forward case. all local properties are killed anyways, so we can safely plug in a combiner&lt;br/&gt;
     			Channel toCombiner = new Channel(in.getSource());&lt;br/&gt;
     			toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;    +&lt;br/&gt;
     			// create an input node for combine with same parallelism as input node&lt;br/&gt;
     			ReduceNode combinerNode = ((ReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
     			combinerNode.setParallelism(in.getSource().getParallelism());&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;Combine (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;, toCombiner,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    No reformatting please.&lt;/p&gt;</comment>
                            <comment id="15150382" author="githubbot" created="Wed, 17 Feb 2016 11:49:59 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53153386&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53153386&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-tests/src/test/java/org/apache/flink/test/javaApiOperators/GroupReduceITCase.java &amp;#8212;&lt;br/&gt;
    @@ -434,6 +431,95 @@ public void testCorrectnessOfGroupreduceWithDescendingGroupSort() throws Excepti&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Test&lt;br/&gt;
    +	public void testCorrectnessOfGroupreduceWithExplicitPartitionOfReducer() throws Exception {&lt;br/&gt;
    +		/*&lt;br/&gt;
    +		 * check correctness of groupReduce with descending group sort&lt;br/&gt;
    +		 */&lt;br/&gt;
    +		final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();&lt;br/&gt;
    +		env.setParallelism(1);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    If we run this test with parallelism `1`, we cannot check if the partitioning is working correctly. Also use a custom `GroupReduceFunction` that implements the `GroupCombineFunction` interface. The combine function should be implemented in a way that we can actually verify that it was called.&lt;/p&gt;</comment>
                            <comment id="15150383" author="githubbot" created="Wed, 17 Feb 2016 11:51:05 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53153472&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53153472&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-tests/src/test/java/org/apache/flink/test/javaApiOperators/GroupReduceITCase.java &amp;#8212;&lt;br/&gt;
    @@ -434,6 +431,95 @@ public void testCorrectnessOfGroupreduceWithDescendingGroupSort() throws Excepti&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Test&lt;br/&gt;
    +	public void testCorrectnessOfGroupreduceWithExplicitPartitionOfReducer() throws Exception &lt;/p&gt;
{
    +		/*
    +		 * check correctness of groupReduce with descending group sort
    +		 */
    +		final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();
    +		env.setParallelism(1);
    +
    +		DataSet&amp;lt;String&amp;gt; ds = CollectionDataSets.getStringDataSet(env);
    +
    +		DataSet&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; counts =
    +			// split up the lines in pairs (2-tuples) containing: (word,1)
    +			ds.flatMap(new Tokenizer()).partitionByHash(0)
    +				// group by the tuple field &quot;0&quot; and sum up tuple field &quot;1&quot;
    +				.groupBy(0)
    +				.sum(1);
    +
    +		List&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; result = counts.collect();
    +		String expected = &quot;am,1\n&quot;
    +			+
    +			&quot;are,1\n&quot; +
    +			&quot;comment,1\n&quot; +
    +			&quot;fine,1\n&quot; +
    +			&quot;hello,3\n&quot; +
    +			&quot;hi,1\n&quot;+
    +			&quot;how,1\n&quot;+
    +			&quot;i,1\n&quot;+
    +			&quot;lol,1\n&quot;+
    +			&quot;luke,1\n&quot;+
    +			&quot;random,1\n&quot;+
    +			&quot;skywalker,1\n&quot;+
    +			&quot;world,2\n&quot;+
    +			&quot;you,1\n&quot;;
    +
    +		compareResultAsTuples(result, expected);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCorrectnessOfGroupreduceWithoutExplicitPartitionOfReducer() throws Exception {&lt;br/&gt;
    +		/*&lt;br/&gt;
    +		 * check correctness of groupReduce with descending group sort&lt;br/&gt;
    +		 */&lt;br/&gt;
    +		final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();&lt;br/&gt;
    +		env.setParallelism(1);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    No parallelism of `1` and a custom `GroupReduceFunction` with `GroupCombineFunction` interface.&lt;/p&gt;</comment>
                            <comment id="15150391" author="githubbot" created="Wed, 17 Feb 2016 11:56:16 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-185170325&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-185170325&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @ramkrish86, thanks for the update.&lt;br/&gt;
    In addition to my comments inline we also need to extend the `ReduceITCase`.&lt;/p&gt;

&lt;p&gt;    Also we must take care of the case where the result of the partition operator goes into more than one function. Consider the following case:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
                                         /-&lt;del&gt;fwd&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce&amp;#93;&lt;/span&gt;&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;Input&amp;#93;&lt;/span&gt; -&lt;del&gt;shuffle&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Partitioner&amp;#93;&lt;/span&gt; -&amp;lt;&lt;br/&gt;
                                         &amp;#45;&lt;del&gt;fwd&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Map&amp;#93;&lt;/span&gt;&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    which should be translated to:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
               /-&lt;del&gt;fwd&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Combine&amp;#93;&lt;/span&gt; --shuffle&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Partitioner&amp;#93;&lt;/span&gt; --fwd&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce&amp;#93;&lt;/span&gt;&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;Input&amp;#93;&lt;/span&gt; --&amp;lt;&lt;br/&gt;
               &amp;#45;&lt;del&gt;shuffle&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Partitioner&amp;#93;&lt;/span&gt; --fwd&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Map&amp;#93;&lt;/span&gt;&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    Both translation tests need to be extended to cover this case.&lt;/p&gt;

&lt;p&gt;    Thanks, Fabian&lt;/p&gt;</comment>
                            <comment id="15157338" author="githubbot" created="Mon, 22 Feb 2016 17:27:56 +0000"  >&lt;p&gt;Github user ramkrish86 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53659650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53659650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
     			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;/li&gt;
	&lt;li&gt;if (in.getLocalStrategy() == LocalStrategy.SORT) {&lt;/li&gt;
	&lt;li&gt;if (!in.getLocalStrategyKeys().isValidUnorderedPrefix(this.keys)) {&lt;/li&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Bug: Inconsistent sort for group strategy.&quot;);&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				// Inject a combiner before the partition node&lt;br/&gt;
    +				Channel toCombiner = new Channel(in.getSource());&lt;br/&gt;
    +				toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);&lt;br/&gt;
    +				GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +				combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +				if(toCombiner.getSource().getInputs().iterator().hasNext()) {&lt;br/&gt;
    +					Channel source = toCombiner.getSource().getInputs().iterator().next();&lt;br/&gt;
    +					// A combiner plan node is created with the map as the input&lt;br/&gt;
    +					SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Thanks for all the comments. Checking one by one. I have few questions. Let me get back to you after fixing the other comments. Sorry about the formatting things. I will take care from next time so that they are not repeated. &lt;/p&gt;</comment>
                            <comment id="15157339" author="githubbot" created="Mon, 22 Feb 2016 17:28:09 +0000"  >&lt;p&gt;Github user ramkrish86 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53659684&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53659684&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-tests/src/test/java/org/apache/flink/test/javaApiOperators/GroupReduceITCase.java &amp;#8212;&lt;br/&gt;
    @@ -434,6 +431,95 @@ public void testCorrectnessOfGroupreduceWithDescendingGroupSort() throws Excepti&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Test&lt;br/&gt;
    +	public void testCorrectnessOfGroupreduceWithExplicitPartitionOfReducer() throws Exception {&lt;br/&gt;
    +		/*&lt;br/&gt;
    +		 * check correctness of groupReduce with descending group sort&lt;br/&gt;
    +		 */&lt;br/&gt;
    +		final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();&lt;br/&gt;
    +		env.setParallelism(1);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I see. Okie&lt;/p&gt;</comment>
                            <comment id="15163421" author="githubbot" created="Wed, 24 Feb 2016 17:56:13 +0000"  >&lt;p&gt;Github user ramkrish86 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53978205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53978205&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-tests/src/test/java/org/apache/flink/test/javaApiOperators/GroupReduceITCase.java &amp;#8212;&lt;br/&gt;
    @@ -434,6 +431,95 @@ public void testCorrectnessOfGroupreduceWithDescendingGroupSort() throws Excepti&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Test&lt;br/&gt;
    +	public void testCorrectnessOfGroupreduceWithExplicitPartitionOfReducer() throws Exception {&lt;br/&gt;
    +		/*&lt;br/&gt;
    +		 * check correctness of groupReduce with descending group sort&lt;br/&gt;
    +		 */&lt;br/&gt;
    +		final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();&lt;br/&gt;
    +		env.setParallelism(1);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Is it ok if I modify the existing test testCorrectnessOfGroupReduceOnTuplesWithCombine() and add a partitionByHash to the input dataset? I tested and debugged it and it seems to work fine after the changes and gives the same expected result as given by testCorrectnessOfGroupReduceOnTuplesWithCombine().&lt;/p&gt;</comment>
                            <comment id="15163719" author="githubbot" created="Wed, 24 Feb 2016 20:06:07 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r53998405&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r53998405&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-tests/src/test/java/org/apache/flink/test/javaApiOperators/GroupReduceITCase.java &amp;#8212;&lt;br/&gt;
    @@ -434,6 +431,95 @@ public void testCorrectnessOfGroupreduceWithDescendingGroupSort() throws Excepti&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Test&lt;br/&gt;
    +	public void testCorrectnessOfGroupreduceWithExplicitPartitionOfReducer() throws Exception {&lt;br/&gt;
    +		/*&lt;br/&gt;
    +		 * check correctness of groupReduce with descending group sort&lt;br/&gt;
    +		 */&lt;br/&gt;
    +		final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();&lt;br/&gt;
    +		env.setParallelism(1);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I&apos;d rather copy the test and adapt the copy. Thanks!&lt;/p&gt;</comment>
                            <comment id="15170412" author="githubbot" created="Sat, 27 Feb 2016 07:17:37 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-189599549&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-189599549&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @fhueske &lt;br/&gt;
    Could you give some examples for the above use case where the partition is an input to more than one function?  &lt;/p&gt;</comment>
                            <comment id="15170413" author="githubbot" created="Sat, 27 Feb 2016 07:18:07 +0000"  >&lt;p&gt;Github user ramkrish86 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r54329750&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r54329750&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-tests/src/test/java/org/apache/flink/test/javaApiOperators/GroupReduceITCase.java &amp;#8212;&lt;br/&gt;
    @@ -434,6 +431,95 @@ public void testCorrectnessOfGroupreduceWithDescendingGroupSort() throws Excepti&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Test&lt;br/&gt;
    +	public void testCorrectnessOfGroupreduceWithExplicitPartitionOfReducer() throws Exception {&lt;br/&gt;
    +		/*&lt;br/&gt;
    +		 * check correctness of groupReduce with descending group sort&lt;br/&gt;
    +		 */&lt;br/&gt;
    +		final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();&lt;br/&gt;
    +		env.setParallelism(1);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Ya. Copying and adapting the test is what I meant too.&lt;/p&gt;</comment>
                            <comment id="15170415" author="githubbot" created="Sat, 27 Feb 2016 07:20:04 +0000"  >&lt;p&gt;Github user ramkrish86 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r54329786&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r54329786&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
     			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;/li&gt;
	&lt;li&gt;if (in.getLocalStrategy() == LocalStrategy.SORT) {&lt;/li&gt;
	&lt;li&gt;if (!in.getLocalStrategyKeys().isValidUnorderedPrefix(this.keys)) {&lt;/li&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Bug: Inconsistent sort for group strategy.&quot;);&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				// Inject a combiner before the partition node&lt;br/&gt;
    +				Channel toCombiner = new Channel(in.getSource());&lt;br/&gt;
    +				toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);&lt;br/&gt;
    +				GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +				combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +				if(toCombiner.getSource().getInputs().iterator().hasNext()) {&lt;br/&gt;
    +					Channel source = toCombiner.getSource().getInputs().iterator().next();&lt;br/&gt;
    +					// A combiner plan node is created with the map as the input&lt;br/&gt;
    +					SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()&lt;br/&gt;
    +						.getName()+&quot;)&quot;, source, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
    +					addCombinerNodeData(in, toCombiner, combiner);&lt;br/&gt;
    +					Channel combinerChannel = new Channel(combiner);&lt;br/&gt;
    +					combinerChannel.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    If am not wrong, the ShipStrategyType and DataExchangeMode that we set to the CombinerChannel should be the one associated with the &apos;in&apos; node that is passed on to the method? Which in the case of Wordcount example is FORWARD and PIPELINED?&lt;/p&gt;</comment>
                            <comment id="15171645" author="githubbot" created="Mon, 29 Feb 2016 09:36:09 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r54386465&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r54386465&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -87,19 +92,39 @@ public DriverStrategy getStrategy() &lt;/p&gt;
{
     		return DriverStrategy.SORTED_GROUP_REDUCE;
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
     			// adjust a sort (changes grouping, so it must be for this driver to combining sort&lt;/li&gt;
	&lt;li&gt;if (in.getLocalStrategy() == LocalStrategy.SORT) {&lt;/li&gt;
	&lt;li&gt;if (!in.getLocalStrategyKeys().isValidUnorderedPrefix(this.keys)) {&lt;/li&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Bug: Inconsistent sort for group strategy.&quot;);&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				// Inject a combiner before the partition node&lt;br/&gt;
    +				Channel toCombiner = new Channel(in.getSource());&lt;br/&gt;
    +				toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);&lt;br/&gt;
    +				GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +				combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +				if(toCombiner.getSource().getInputs().iterator().hasNext()) {&lt;br/&gt;
    +					Channel source = toCombiner.getSource().getInputs().iterator().next();&lt;br/&gt;
    +					// A combiner plan node is created with the map as the input&lt;br/&gt;
    +					SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()&lt;br/&gt;
    +						.getName()+&quot;)&quot;, source, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
    +					addCombinerNodeData(in, toCombiner, combiner);&lt;br/&gt;
    +					Channel combinerChannel = new Channel(combiner);&lt;br/&gt;
    +					combinerChannel.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    If we have:&lt;br/&gt;
    `&lt;span class=&quot;error&quot;&gt;&amp;#91;Some-Op&amp;#93;&lt;/span&gt; -&lt;del&gt;(a)-partition&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Partition-Op&amp;#93;&lt;/span&gt; --(b)-fwd&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce-Op&amp;#93;&lt;/span&gt;`&lt;br/&gt;
    then `in` is the `-&lt;del&gt;(b)-fwd&lt;/del&gt;-&amp;gt;` channel and `node` is the the `&lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce-Op&amp;#93;&lt;/span&gt;`. &lt;/p&gt;

&lt;p&gt;    The combine operator should be inserted like this:&lt;br/&gt;
    `&lt;span class=&quot;error&quot;&gt;&amp;#91;Some-Op&amp;#93;&lt;/span&gt; -&lt;del&gt;(1)-fwd&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Combine-Op&amp;#93;&lt;/span&gt; --(2)-partition&lt;/del&gt;&lt;del&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Partition-Op&amp;#93;&lt;/span&gt; --(3)-fwd&lt;/del&gt;-&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Reduce-Op&amp;#93;&lt;/span&gt;`&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The channel (1) must be a new forward/pipelined channel.&lt;/li&gt;
	&lt;li&gt;The channel (2) must be new channel with the same shipping and exchange strategies as channel (a).&lt;/li&gt;
	&lt;li&gt;The channel (3) should be the original channel (b) which is the `in` parameter.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15171650" author="githubbot" created="Mon, 29 Feb 2016 09:41:43 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-190124885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-190124885&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I do not have a concrete use case in mind, but it is certainly possible to implement such a job in the DataSet API. Hence, it should be correctly translated. &lt;br/&gt;
    You can do this for example like this:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    DataSet&amp;lt;Tuple2&amp;lt;String, Long&amp;gt;&amp;gt; data = ...&lt;br/&gt;
    DataSet&amp;lt;Tuple2&amp;lt;String, Long&amp;gt;&amp;gt; pData = data.partitionByHash(0);&lt;br/&gt;
    pData.map(new SomeMapFunc())&lt;br/&gt;
         .output(new DiscardingOutputFormat&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt;());&lt;br/&gt;
    pData.groupReduce(new SomeCombinableGReduceFunc())&lt;br/&gt;
         .output(new DiscardingOutputFormat&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt;());&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="15177765" author="githubbot" created="Thu, 3 Mar 2016 12:43:06 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-191748107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-191748107&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @fhueske &lt;br/&gt;
    So for doing the above example where the partioned input goes both to the map and reducer as input &lt;br/&gt;
    should this class AllGroupWithPartialPreGroupProperties be changed like GroupReduceCombineProperties?  I can find both having similar code and the code flow too goes there only?&lt;/p&gt;</comment>
                            <comment id="15177779" author="githubbot" created="Thu, 3 Mar 2016 13:00:51 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-191752181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-191752181&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Sorry, I forgot a `groupBy()` in my example.&lt;br/&gt;
    It should be&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    DataSet&amp;lt;Tuple2&amp;lt;String, Long&amp;gt;&amp;gt; data = ...&lt;br/&gt;
    DataSet&amp;lt;Tuple2&amp;lt;String, Long&amp;gt;&amp;gt; pData = data.partitionByHash(0);&lt;br/&gt;
    pData.map(new SomeMapFunc())&lt;br/&gt;
         .output(new DiscardingOutputFormat&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt;());&lt;br/&gt;
    pData.groupBy(0)&lt;br/&gt;
         .groupReduce(new SomeCombinableGReduceFunc())&lt;br/&gt;
         .output(new DiscardingOutputFormat&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt;());&lt;br/&gt;
    ```&lt;/p&gt;
</comment>
                            <comment id="15179424" author="githubbot" created="Fri, 4 Mar 2016 06:26:54 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-192131350&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-192131350&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    New PR submitted @fhueske . Thanks for helping me thro this code review. It is was more of a beginner and there is a lot to learn from my side. &lt;/p&gt;</comment>
                            <comment id="15182594" author="ram_krish" created="Mon, 7 Mar 2016 05:14:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;fhueske@gmail.com&quot;&gt;fhueske@gmail.com&lt;/a&gt;&lt;br/&gt;
I have updated the PR in case you have not seen it. Thank you.&lt;/p&gt;</comment>
                            <comment id="15183010" author="githubbot" created="Mon, 7 Mar 2016 13:50:09 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r55204942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r55204942&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -126,12 +117,66 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			}&lt;br/&gt;
     			toReducer.setLocalStrategy(LocalStrategy.COMBININGSORT, in.getLocalStrategyKeys(),&lt;br/&gt;
     										in.getLocalStrategySortOrder());&lt;br/&gt;
    -&lt;br/&gt;
     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;,&lt;br/&gt;
     											toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	private SingleInputPlanNode injectCombinerBeforPartitioner(Channel in, SingleInputNode node) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Typo in method name injectCombinerBefor*&lt;b&gt;e&lt;/b&gt;*Partitioner&lt;/p&gt;</comment>
                            <comment id="15183011" author="githubbot" created="Mon, 7 Mar 2016 13:50:37 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r55205009&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r55205009&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -126,12 +117,66 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			}&lt;br/&gt;
     			toReducer.setLocalStrategy(LocalStrategy.COMBININGSORT, in.getLocalStrategyKeys(),&lt;br/&gt;
     										in.getLocalStrategySortOrder());&lt;br/&gt;
    -&lt;br/&gt;
     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;,&lt;br/&gt;
     											toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	private SingleInputPlanNode injectCombinerBeforPartitioner(Channel in, SingleInputNode node) {&lt;br/&gt;
    +		// Inject a combiner before the partition node&lt;br/&gt;
    +		Channel channelWithPartitionSrc = new Channel(in.getSource());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This channel is not really used and should not be created&lt;/p&gt;</comment>
                            <comment id="15183014" author="githubbot" created="Mon, 7 Mar 2016 13:51:23 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r55205091&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r55205091&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -126,12 +117,66 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			}&lt;br/&gt;
     			toReducer.setLocalStrategy(LocalStrategy.COMBININGSORT, in.getLocalStrategyKeys(),&lt;br/&gt;
     										in.getLocalStrategySortOrder());&lt;br/&gt;
    -&lt;br/&gt;
     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;,&lt;br/&gt;
     											toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	private SingleInputPlanNode injectCombinerBeforPartitioner(Channel in, SingleInputNode node) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Please use meaningful parameter name: in -&amp;gt; toReducer, node -&amp;gt; reduceNode&lt;/p&gt;</comment>
                            <comment id="15183019" author="githubbot" created="Mon, 7 Mar 2016 13:53:19 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r55205324&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r55205324&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -126,12 +117,66 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			}&lt;br/&gt;
     			toReducer.setLocalStrategy(LocalStrategy.COMBININGSORT, in.getLocalStrategyKeys(),&lt;br/&gt;
     										in.getLocalStrategySortOrder());&lt;br/&gt;
    -&lt;br/&gt;
     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;,&lt;br/&gt;
     											toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	private SingleInputPlanNode injectCombinerBeforPartitioner(Channel in, SingleInputNode node) {&lt;br/&gt;
    +		// Inject a combiner before the partition node&lt;br/&gt;
    +		Channel channelWithPartitionSrc = new Channel(in.getSource());&lt;br/&gt;
    +		GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +		combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +		if(in.getSource().getInputs().iterator().hasNext()) &lt;/p&gt;
{
    +			Channel oldChannelToPartitioner = channelWithPartitionSrc.getSource().getInputs().iterator().next();
    +			Channel toCombiner = new Channel(oldChannelToPartitioner.getSource());
    +            // A combiner plan node is created with the channel as input that has the partitioner as the target
    +			toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);
    +            SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()
    +                .getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);
    +            setCombinerProperties(in, oldChannelToPartitioner, combiner);
    +
    +			Channel toPartitioner = new Channel(combiner);
    +			// Set the actual partitioner node&apos;s strategy key and strategy order
    +			toPartitioner.setShipStrategy(oldChannelToPartitioner.getShipStrategy(), oldChannelToPartitioner.getShipStrategyKeys(),
    +				oldChannelToPartitioner.getShipStrategySortOrder(), oldChannelToPartitioner.getDataExchangeMode());
    +            // Create the partition single input plan node from the existing partition node
    +            PlanNode partitionplanNode = in.getSource().getPlanNode();
    +            SingleInputPlanNode partition = new SingleInputPlanNode(in.getSource().getOptimizerNode(), partitionplanNode.getNodeName(),
    +                toPartitioner, partitionplanNode.getDriverStrategy());
    +            partition.setCosts(partitionplanNode.getNodeCosts());
    +            partition.initProperties(partitionplanNode.getGlobalProperties(), partitionplanNode.getLocalProperties());
    +            // Create a reducer such that the input of the reducer is the partition node
    +            Channel toReducer = new Channel(partition);
    +            toReducer.setShipStrategy(in.getShipStrategy(), in.getShipStrategyKeys(),
    +                in.getShipStrategySortOrder(), in.getDataExchangeMode());
    +            return getReducerSingleInputPlanNode(toReducer, node);
    +        }
&lt;p&gt; else {&lt;br/&gt;
    +            return getReducerSingleInputPlanNode(in, node);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    in.getSource is the partitioner an should thus have exactly one input. If this is not the case, something is wrong and we should throw a `CompilerException`.&lt;/p&gt;</comment>
                            <comment id="15183021" author="githubbot" created="Mon, 7 Mar 2016 13:53:35 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r55205361&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r55205361&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -126,12 +117,66 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			}&lt;br/&gt;
     			toReducer.setLocalStrategy(LocalStrategy.COMBININGSORT, in.getLocalStrategyKeys(),&lt;br/&gt;
     										in.getLocalStrategySortOrder());&lt;br/&gt;
    -&lt;br/&gt;
     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;,&lt;br/&gt;
     											toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	private SingleInputPlanNode injectCombinerBeforPartitioner(Channel in, SingleInputNode node) {&lt;br/&gt;
    +		// Inject a combiner before the partition node&lt;br/&gt;
    +		Channel channelWithPartitionSrc = new Channel(in.getSource());&lt;br/&gt;
    +		GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +		combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +		if(in.getSource().getInputs().iterator().hasNext()) {&lt;br/&gt;
    +			Channel oldChannelToPartitioner = channelWithPartitionSrc.getSource().getInputs().iterator().next();&lt;br/&gt;
    +			Channel toCombiner = new Channel(oldChannelToPartitioner.getSource());&lt;br/&gt;
    +            // A combiner plan node is created with the channel as input that has the partitioner as the target&lt;br/&gt;
    +			toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);&lt;br/&gt;
    +            SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Indention is off&lt;/p&gt;</comment>
                            <comment id="15183022" author="githubbot" created="Mon, 7 Mar 2016 13:54:06 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r55205422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r55205422&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -126,12 +117,66 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			}&lt;br/&gt;
     			toReducer.setLocalStrategy(LocalStrategy.COMBININGSORT, in.getLocalStrategyKeys(),&lt;br/&gt;
     										in.getLocalStrategySortOrder());&lt;br/&gt;
    -&lt;br/&gt;
     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;,&lt;br/&gt;
     											toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	private SingleInputPlanNode injectCombinerBeforPartitioner(Channel in, SingleInputNode node) {&lt;br/&gt;
    +		// Inject a combiner before the partition node&lt;br/&gt;
    +		Channel channelWithPartitionSrc = new Channel(in.getSource());&lt;br/&gt;
    +		GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +		combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +		if(in.getSource().getInputs().iterator().hasNext()) {&lt;br/&gt;
    +			Channel oldChannelToPartitioner = channelWithPartitionSrc.getSource().getInputs().iterator().next();&lt;br/&gt;
    +			Channel toCombiner = new Channel(oldChannelToPartitioner.getSource());&lt;br/&gt;
    +            // A combiner plan node is created with the channel as input that has the partitioner as the target&lt;br/&gt;
    +			toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);&lt;br/&gt;
    +            SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()&lt;br/&gt;
    +                .getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);&lt;br/&gt;
    +            setCombinerProperties(in, oldChannelToPartitioner, combiner);&lt;br/&gt;
    +&lt;br/&gt;
    +			Channel toPartitioner = new Channel(combiner);&lt;br/&gt;
    +			// Set the actual partitioner node&apos;s strategy key and strategy order&lt;br/&gt;
    +			toPartitioner.setShipStrategy(oldChannelToPartitioner.getShipStrategy(), oldChannelToPartitioner.getShipStrategyKeys(),&lt;br/&gt;
    +				oldChannelToPartitioner.getShipStrategySortOrder(), oldChannelToPartitioner.getDataExchangeMode());&lt;br/&gt;
    +            // Create the partition single input plan node from the existing partition node&lt;br/&gt;
    +            PlanNode partitionplanNode = in.getSource().getPlanNode();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Indention is off (please check all your changes)&lt;/p&gt;</comment>
                            <comment id="15183045" author="githubbot" created="Mon, 7 Mar 2016 14:17:06 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r55208210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r55208210&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -126,12 +117,66 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			}&lt;br/&gt;
     			toReducer.setLocalStrategy(LocalStrategy.COMBININGSORT, in.getLocalStrategyKeys(),&lt;br/&gt;
     										in.getLocalStrategySortOrder());&lt;br/&gt;
    -&lt;br/&gt;
     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;,&lt;br/&gt;
     											toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	private SingleInputPlanNode injectCombinerBeforPartitioner(Channel in, SingleInputNode node) {&lt;br/&gt;
    +		// Inject a combiner before the partition node&lt;br/&gt;
    +		Channel channelWithPartitionSrc = new Channel(in.getSource());&lt;br/&gt;
    +		GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +		combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +		if(in.getSource().getInputs().iterator().hasNext()) &lt;/p&gt;
{
    +			Channel oldChannelToPartitioner = channelWithPartitionSrc.getSource().getInputs().iterator().next();
    +			Channel toCombiner = new Channel(oldChannelToPartitioner.getSource());
    +            // A combiner plan node is created with the channel as input that has the partitioner as the target
    +			toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);
    +            SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()
    +                .getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);
    +            setCombinerProperties(in, oldChannelToPartitioner, combiner);
    +
    +			Channel toPartitioner = new Channel(combiner);
    +			// Set the actual partitioner node&apos;s strategy key and strategy order
    +			toPartitioner.setShipStrategy(oldChannelToPartitioner.getShipStrategy(), oldChannelToPartitioner.getShipStrategyKeys(),
    +				oldChannelToPartitioner.getShipStrategySortOrder(), oldChannelToPartitioner.getDataExchangeMode());
    +            // Create the partition single input plan node from the existing partition node
    +            PlanNode partitionplanNode = in.getSource().getPlanNode();
    +            SingleInputPlanNode partition = new SingleInputPlanNode(in.getSource().getOptimizerNode(), partitionplanNode.getNodeName(),
    +                toPartitioner, partitionplanNode.getDriverStrategy());
    +            partition.setCosts(partitionplanNode.getNodeCosts());
    +            partition.initProperties(partitionplanNode.getGlobalProperties(), partitionplanNode.getLocalProperties());
    +            // Create a reducer such that the input of the reducer is the partition node
    +            Channel toReducer = new Channel(partition);
    +            toReducer.setShipStrategy(in.getShipStrategy(), in.getShipStrategyKeys(),
    +                in.getShipStrategySortOrder(), in.getDataExchangeMode());
    +            return getReducerSingleInputPlanNode(toReducer, node);
    +        }
&lt;p&gt; else &lt;/p&gt;
{
    +            return getReducerSingleInputPlanNode(in, node);
    +        }
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	private void setCombinerProperties(Channel in, Channel oldChannelToPartitioner, SingleInputPlanNode combiner) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    please use meaningful parameter names for `in` and `oldChannelToPartitioner`. &lt;/p&gt;</comment>
                            <comment id="15183047" author="githubbot" created="Mon, 7 Mar 2016 14:18:11 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#discussion_r55208348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#discussion_r55208348&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -126,12 +117,66 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     			}&lt;br/&gt;
     			toReducer.setLocalStrategy(LocalStrategy.COMBININGSORT, in.getLocalStrategyKeys(),&lt;br/&gt;
     										in.getLocalStrategySortOrder());&lt;br/&gt;
    -&lt;br/&gt;
     			return new SingleInputPlanNode(node, &quot;Reduce (&quot;&lt;ins&gt;node.getOperator().getName()&lt;/ins&gt;&quot;)&quot;,&lt;br/&gt;
     											toReducer, DriverStrategy.SORTED_GROUP_REDUCE, this.keyList);&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	private SingleInputPlanNode injectCombinerBeforPartitioner(Channel in, SingleInputNode node) {&lt;br/&gt;
    +		// Inject a combiner before the partition node&lt;br/&gt;
    +		Channel channelWithPartitionSrc = new Channel(in.getSource());&lt;br/&gt;
    +		GroupReduceNode combinerNode = ((GroupReduceNode) node).getCombinerUtilityNode();&lt;br/&gt;
    +		combinerNode.setParallelism(in.getSource().getParallelism());&lt;br/&gt;
    +		if(in.getSource().getInputs().iterator().hasNext()) &lt;/p&gt;
{
    +			Channel oldChannelToPartitioner = channelWithPartitionSrc.getSource().getInputs().iterator().next();
    +			Channel toCombiner = new Channel(oldChannelToPartitioner.getSource());
    +            // A combiner plan node is created with the channel as input that has the partitioner as the target
    +			toCombiner.setShipStrategy(ShipStrategyType.FORWARD, DataExchangeMode.PIPELINED);
    +            SingleInputPlanNode combiner = new SingleInputPlanNode(combinerNode, &quot;Combine(&quot;+node.getOperator()
    +                .getName()+&quot;)&quot;, toCombiner, DriverStrategy.SORTED_GROUP_COMBINE);
    +            setCombinerProperties(in, oldChannelToPartitioner, combiner);
    +
    +			Channel toPartitioner = new Channel(combiner);
    +			// Set the actual partitioner node&apos;s strategy key and strategy order
    +			toPartitioner.setShipStrategy(oldChannelToPartitioner.getShipStrategy(), oldChannelToPartitioner.getShipStrategyKeys(),
    +				oldChannelToPartitioner.getShipStrategySortOrder(), oldChannelToPartitioner.getDataExchangeMode());
    +            // Create the partition single input plan node from the existing partition node
    +            PlanNode partitionplanNode = in.getSource().getPlanNode();
    +            SingleInputPlanNode partition = new SingleInputPlanNode(in.getSource().getOptimizerNode(), partitionplanNode.getNodeName(),
    +                toPartitioner, partitionplanNode.getDriverStrategy());
    +            partition.setCosts(partitionplanNode.getNodeCosts());
    +            partition.initProperties(partitionplanNode.getGlobalProperties(), partitionplanNode.getLocalProperties());
    +            // Create a reducer such that the input of the reducer is the partition node
    +            Channel toReducer = new Channel(partition);
    +            toReducer.setShipStrategy(in.getShipStrategy(), in.getShipStrategyKeys(),
    +                in.getShipStrategySortOrder(), in.getDataExchangeMode());
    +            return getReducerSingleInputPlanNode(toReducer, node);
    +        }
&lt;p&gt; else &lt;/p&gt;
{
    +            return getReducerSingleInputPlanNode(in, node);
    +        }
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	private void setCombinerProperties(Channel in, Channel oldChannelToPartitioner, SingleInputPlanNode combiner) &lt;/p&gt;
{
    +		combiner.setCosts(new Costs(0, 0));
    +		combiner.initProperties(oldChannelToPartitioner.getGlobalProperties(), oldChannelToPartitioner.getLocalProperties());
    +		// set sorting comparator key info
    +		combiner.setDriverKeyInfo(in.getLocalStrategyKeys(), in.getLocalStrategySortOrder(), 0);
    +		// set grouping comparator key info
    +		combiner.setDriverKeyInfo(this.keyList, 1);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private SingleInputPlanNode getReducerSingleInputPlanNode(Channel in, SingleInputNode node) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Please change parameter names: in -&amp;gt; toReducer, node -&amp;gt; reduceNode&lt;/p&gt;</comment>
                            <comment id="15183062" author="githubbot" created="Mon, 7 Mar 2016 14:32:45 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-193272515&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-193272515&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi Ram, &lt;br/&gt;
    I just realized that the approach taken here might not work. We are modifying the plan while it is enumerated. There might be cases, where this leads to compiler errors or wrong plans. I have to check which side effects the plan modification might have.&lt;/p&gt;

&lt;p&gt;    I would suggest we put this PR for a few days on ice and I check whether it is possible to continue or if we have to find another approach.&lt;/p&gt;</comment>
                            <comment id="15184361" author="githubbot" created="Tue, 8 Mar 2016 04:09:24 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-193595361&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-193595361&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @fhueske &lt;br/&gt;
    I was looking into the comments and the refactoring I can avoid by creating a new patch altogether. But saying the last comment I think I can hold this off for some time. Felt sad as I wanted to bring this to closure. Anyway you are the expert so I need to adhere to your words here. No problem. Will check if I can take up some other JIRA or do you have any suggestions till then?&lt;/p&gt;</comment>
                            <comment id="15184641" author="githubbot" created="Tue, 8 Mar 2016 08:23:22 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-193658558&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-193658558&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @ramkrish86, I totally understand that you are disappointed. I&apos;m very sorry to raise these concerns this late after you put a lot of effort into this PR. I should have noticed this issue much earlier &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;    Touching the optimizer is always a little bit like open heart surgery and must be done very carefully with the whole picture in mind. I have not completely investigated the possible side effects yet, but will definitely let you know once I have.&lt;/p&gt;

&lt;p&gt;    Would you like to work on a different issue in the meantime?&lt;/p&gt;</comment>
                            <comment id="15184671" author="githubbot" created="Tue, 8 Mar 2016 08:44:56 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-193665240&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-193665240&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @fhueske &lt;br/&gt;
    Everthing is a learning. good that I got to know some flows out of this issue. Ya am interested to take up some other JIRA in the meantime.&lt;/p&gt;</comment>
                            <comment id="15201482" author="githubbot" created="Fri, 18 Mar 2016 13:39:46 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-198364412&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-198364412&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @ramkrish86, I thought about this PR and came to the conclusion that we should not continue. The optimizer&apos;s design does not allow to modify operators in or inject operators into enumerated subplans. This might cause invalid execution plans and in worst case wrong results without somebody noticing it.&lt;/p&gt;

&lt;p&gt;    I would simply log a WARN message that a combiner was not added if the optimizer identifies a Partition operator in front of a Reduce or combinable GroupReduce operator and give a hint that an explicit CombinerFunction can be added with groupCombine in front of the partition operator.&lt;/p&gt;

&lt;p&gt;    Sorry again @ramkrish86 that I lead you into a dead end with this PR.&lt;/p&gt;</comment>
                            <comment id="15202565" author="ram_krish" created="Sat, 19 Mar 2016 04:54:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sorry again @ramkrish86 that I lead you into a dead end with this PR.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt; . It is a learning for me so am happy.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I would simply log a WARN message that a combiner was not added if the optimizer identifies a Partition operator in front of a Reduce or combinable GroupReduce operator and give a hint that an explicit CombinerFunction can be added with groupCombine in front of the partition operator.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Want me to do this?  So this log will be coming in that GroupReduceWithCombineProperties instantiate() API only?&lt;/p&gt;</comment>
                            <comment id="15203939" author="fhueske" created="Mon, 21 Mar 2016 09:28:46 +0000"  >&lt;p&gt;Yes, would be great if you could open a PR to add the WARN log message to &lt;tt&gt;GroupReduceWithCombineProperties#instantiate()&lt;/tt&gt; and &lt;tt&gt;ReduceProperties#instantiate()&lt;/tt&gt;.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="15204063" author="githubbot" created="Mon, 21 Mar 2016 11:36:01 +0000"  >&lt;p&gt;GitHub user ramkrish86 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1822&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1822&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3179&quot; title=&quot;Combiner is not injected if Reduce or GroupReduce input is explicitly partitioned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3179&quot;&gt;&lt;del&gt;FLINK-3179&lt;/del&gt;&lt;/a&gt; - Adding just a log message&lt;/p&gt;

&lt;p&gt;    As suggested in the JIRA, just adding a log message indicating to add an combiner function before the partition operator. &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ramkrish86/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ramkrish86/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3179&quot; title=&quot;Combiner is not injected if Reduce or GroupReduce input is explicitly partitioned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3179&quot;&gt;&lt;del&gt;FLINK-3179&lt;/del&gt;&lt;/a&gt;_log&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1822.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1822.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1822&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 79ca46e6855b1573e140bc19cdb7563d9d4f09d8&lt;br/&gt;
Author: ramkrishna &amp;lt;ramkrishna.s.vasudevan@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-03-21T11:33:42Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3179&quot; title=&quot;Combiner is not injected if Reduce or GroupReduce input is explicitly partitioned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3179&quot;&gt;&lt;del&gt;FLINK-3179&lt;/del&gt;&lt;/a&gt; - Adding just a log message&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15205235" author="githubbot" created="Mon, 21 Mar 2016 21:56:00 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1822#discussion_r56904780&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1822#discussion_r56904780&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/GroupReduceWithCombineProperties.java &amp;#8212;&lt;br/&gt;
    @@ -90,6 +94,9 @@ public DriverStrategy getStrategy() {&lt;br/&gt;
     	@Override&lt;br/&gt;
     	public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD) {&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				LOG.warn(&quot;Consider adding an explicit CombinerFunction with groupCombine in front of the partition operator&quot;);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Can you extend the error message as follows?&lt;/p&gt;

&lt;p&gt;    &amp;gt; Cannot automatically inject combiner for GroupReduceFunction. Please add an explicit combiner with combineGroup() in front of the partition operator. &lt;/p&gt;
</comment>
                            <comment id="15205236" author="githubbot" created="Mon, 21 Mar 2016 21:56:27 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1822#discussion_r56904841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1822#discussion_r56904841&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/operators/ReduceProperties.java &amp;#8212;&lt;br/&gt;
    @@ -61,6 +65,9 @@ public SingleInputPlanNode instantiate(Channel in, SingleInputNode node) {&lt;br/&gt;
     		if (in.getShipStrategy() == ShipStrategyType.FORWARD ||&lt;br/&gt;
     				(node.getBroadcastConnections() != null &amp;amp;&amp;amp; !node.getBroadcastConnections().isEmpty()))&lt;br/&gt;
     		{&lt;br/&gt;
    +			if(in.getSource().getOptimizerNode() instanceof PartitionNode) {&lt;br/&gt;
    +				LOG.warn(&quot;Consider adding an explicit CombinerFunction with groupCombine in front of the partition operator&quot;);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Can you extend the error message as follows?&lt;/p&gt;

&lt;p&gt;    &amp;gt; Cannot automatically inject combiner for ReduceFunction. Please add an explicit combiner with combineGroup() in front of the partition operator. &lt;/p&gt;</comment>
                            <comment id="15205237" author="githubbot" created="Mon, 21 Mar 2016 21:57:00 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1822#issuecomment-199503791&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1822#issuecomment-199503791&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the PR! Just had a suggestion for the wording of the log message. Looks good otherwise.&lt;/p&gt;</comment>
                            <comment id="15205812" author="githubbot" created="Tue, 22 Mar 2016 05:15:21 +0000"  >&lt;p&gt;Github user ramkrish86 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1822#issuecomment-199642001&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1822#issuecomment-199642001&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Done the update @fhueske . Pls review. Thanks. &lt;/p&gt;</comment>
                            <comment id="15205962" author="githubbot" created="Tue, 22 Mar 2016 07:56:11 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1822#issuecomment-199684210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1822#issuecomment-199684210&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the update! Good to merge &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15206064" author="githubbot" created="Tue, 22 Mar 2016 09:34:07 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1822#issuecomment-199717124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1822#issuecomment-199717124&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging&lt;/p&gt;</comment>
                            <comment id="15206145" author="ram_krish" created="Tue, 22 Mar 2016 10:42:56 +0000"  >&lt;p&gt;So good to close this JIRA then?&lt;/p&gt;</comment>
                            <comment id="15206295" author="githubbot" created="Tue, 22 Mar 2016 12:55:02 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1822&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1822&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15206298" author="githubbot" created="Tue, 22 Mar 2016 12:55:02 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15206299" author="githubbot" created="Tue, 22 Mar 2016 12:55:40 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1553#issuecomment-199798994&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1553#issuecomment-199798994&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Closed this PR in favor of PR #1822 &lt;/p&gt;</comment>
                            <comment id="15206382" author="fhueske" created="Tue, 22 Mar 2016 13:46:55 +0000"  >&lt;p&gt;Fixed for 1.0.1 with cd5773ed302cc3c287b00cef6440cc2d740fc469&lt;br/&gt;
Fixed for 1.1.0 with 76da442837d8606d8c4c4d8367b29fd79dc5ba35&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 35 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pzw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>