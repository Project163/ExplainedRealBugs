<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:17:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-31835] DataTypeHint don&apos;t support Row&lt;i Array&lt;int&gt;&gt;</title>
                <link>https://issues.apache.org/jira/browse/FLINK-31835</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Using DataTypeHint(&quot;Row&amp;lt;t ARRAY&amp;lt;INT&amp;gt;&amp;gt;&quot;) in a UDF gives the following error:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.ClassCastException: class [I cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to class [Ljava.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;; ([I and [Ljava.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;; are in module java.base of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;bootstrap&apos;&lt;/span&gt;)
org.apache.flink.table.data.conversion.ArrayObjectArrayConverter.toInternal(ArrayObjectArrayConverter.java:40)
org.apache.flink.table.data.conversion.DataStructureConverter.toInternalOrNull(DataStructureConverter.java:61)
org.apache.flink.table.data.conversion.RowRowConverter.toInternal(RowRowConverter.java:75)
org.apache.flink.table.data.conversion.RowRowConverter.toInternal(RowRowConverter.java:37)
org.apache.flink.table.data.conversion.DataStructureConverter.toInternalOrNull(DataStructureConverter.java:61)
StreamExecCalc$251.processElement_split9(Unknown Source)
StreamExecCalc$251.processElement(Unknown Source)
org.apache.flink.streaming.runtime.tasks.CopyingChainingOutput.pushToOperator(CopyingChainingOutput.java:82) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The function is as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@DataTypeHint(&lt;span class=&quot;code-quote&quot;&gt;&quot;Row&amp;lt;t ARRAY&amp;lt;INT&amp;gt;&amp;gt;&quot;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Row eval() {
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[] i = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[3];
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Row.of(i);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This error is not reported when testing other simple types, so it is not an environmental problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13533004">FLINK-31835</key>
            <summary>DataTypeHint don&apos;t support Row&lt;i Array&lt;int&gt;&gt;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aitozi">WenJun Min</assignee>
                                    <reporter username="jeff-zou">jeff-zou</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 18 Apr 2023 09:10:33 +0000</created>
                <updated>Thu, 7 Dec 2023 12:55:31 +0000</updated>
                            <resolved>Mon, 12 Jun 2023 09:53:12 +0000</resolved>
                                    <version>1.15.4</version>
                                    <fixVersion>1.18.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17715358" author="jark" created="Sun, 23 Apr 2023 04:02:30 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeff-zou&quot; class=&quot;user-hover&quot; rel=&quot;jeff-zou&quot;&gt;jeff-zou&lt;/a&gt;, thanks for reporting this. I think this is expected. You should declare the type hint as &quot;ARRAY&amp;lt;INT NOT NULL&amp;gt;&quot; to map to &lt;tt&gt;int[]&lt;/tt&gt;. &quot;ARRAY&amp;lt;INT&amp;gt;&quot; is recognized as a result of &lt;tt&gt;Integer[]&lt;/tt&gt;. That&apos;s why the conversion class is &lt;tt&gt;ArrayObjectArrayConverter&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;But I think the exception message can be improved. &lt;/p&gt;</comment>
                            <comment id="17715464" author="aitozi" created="Sun, 23 Apr 2023 14:14:31 +0000"  >&lt;p&gt;In this case, ARRAY&amp;lt;INT NOT NULL&amp;gt; will still maps to &lt;tt&gt;ArrayObjectArrayConverter&lt;/tt&gt;. I think it&apos;s not expected&lt;/p&gt;</comment>
                            <comment id="17715466" author="aitozi" created="Sun, 23 Apr 2023 14:31:05 +0000"  >&lt;p&gt;When creating Array CollectionDataType it will use the array&apos;s element type to construct an array conversion class. But the conversionClass is &lt;tt&gt;Integer&lt;/tt&gt; for both  &lt;tt&gt;INT NOT NULL&lt;/tt&gt; and &lt;tt&gt;INT&lt;/tt&gt;. So the conversion class for Array&amp;lt;INT NOT NULL&amp;gt; will become &lt;tt&gt;Integer[]&lt;/tt&gt;&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (logicalType.getTypeRoot() == LogicalTypeRoot.ARRAY &amp;amp;&amp;amp; clazz == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Array.newInstance(elementDataType.getConversionClass(), 0).getClass();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="17715474" author="aitozi" created="Sun, 23 Apr 2023 15:13:00 +0000"  >&lt;p&gt;The first thought in my mind is that the conversion class for atomic type eg: &lt;tt&gt;IntType&lt;/tt&gt; should respect to the nullability. So, when a &lt;tt&gt;IntType&lt;/tt&gt; copy from nullable to not null. Its default conversionClass will change from &lt;tt&gt;Integer&lt;/tt&gt; to &lt;tt&gt;int&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;And in the DataType: &lt;tt&gt;AtomicType&lt;/tt&gt; and &lt;tt&gt;CollectionDataType&lt;/tt&gt; should also respect to the nullable and notNull call. The conversionClass of the dataType should be changed after these call.&lt;/p&gt;

&lt;p&gt;I have verified this locally, it can solve this problem, what do you think this solution &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="17715658" author="jark" created="Mon, 24 Apr 2023 09:05:56 +0000"  >&lt;p&gt;This sounds good to me. My only concern is the compatibility problem. What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt;? Is there any potential problems?&lt;/p&gt;</comment>
                            <comment id="17716152" author="JIRAUSER282259" created="Tue, 25 Apr 2023 08:00:55 +0000"  >&lt;p&gt;hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aitozi&quot; class=&quot;user-hover&quot; rel=&quot;aitozi&quot;&gt;aitozi&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Under Flink 1.15, how do I solve this problem?&#160; Even I have change the hint to Array&amp;lt;int not null&amp;gt;, it&apos;s still reporting this error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.ClassCastException: [I cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to [Ljava.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&#160; &#160; at org.apache.flink.table.data.conversion.ArrayObjectArrayConverter.toInternal(ArrayObjectArrayConverter.java:40)
&#160; &#160; at org.apache.flink.table.data.conversion.DataStructureConverter.toInternalOrNull(DataStructureConverter.java:61)
&#160; &#160; at org.apache.flink.table.data.conversion.RowRowConverter.toInternal(RowRowConverter.java:75)
&#160; &#160; at org.apache.flink.table.data.conversion.RowRowConverter.toInternal(RowRowConverter.java:37)
&#160; &#160; at org.apache.flink.table.data.conversion.DataStructureConverter.toInternalOrNull(DataStructureConverter.java:61)
&#160; &#160; at StreamExecCalc$278.processElement_trueFilter1_split13(Unknown Source)
&#160; &#160; at StreamExecCalc$278.processElement_trueFilter1(Unknown Source)
&#160; &#160; at StreamExecCalc$278.processElement_split3(Unknown Source) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17716209" author="aitozi" created="Tue, 25 Apr 2023 10:25:16 +0000"  >&lt;p&gt;Yes, the reason is shown above. I have pushed a PR to try to solve this. But it needs some discussion to avoid break the compatibility. &lt;/p&gt;</comment>
                            <comment id="17716538" author="aitozi" created="Wed, 26 Apr 2023 05:39:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; The PR have passed the CI and I think the current solution will not cause compatibility problem by only fix the conversion class according to the nullability when creating CollectionDataType, could you help review that ?&lt;/p&gt;</comment>
                            <comment id="17731533" author="jark" created="Mon, 12 Jun 2023 09:53:12 +0000"  >&lt;p&gt;Fixed in master: a6adbdda0cdf90635f0cd7a3427486bced301fbd&lt;/p&gt;</comment>
                            <comment id="17786151" author="xuyangzhong" created="Wed, 15 Nov 2023 03:15:34 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aitozi&quot; class=&quot;user-hover&quot; rel=&quot;aitozi&quot;&gt;aitozi&lt;/a&gt;. Sorry for this noise, can you check if the incompatible changes that may be caused by this pr expected?&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-33523&quot; title=&quot;DataType ARRAY&amp;lt;INT NOT NULL&amp;gt; fails to cast into Object[]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-33523&quot;&gt;&lt;del&gt;FLINK-33523&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-33547&quot; title=&quot;SQL primitive array type after upgrading to Flink 1.18.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-33547&quot;&gt;&lt;del&gt;FLINK-33547&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17794179" author="twalthr" created="Thu, 7 Dec 2023 12:55:31 +0000"  >&lt;blockquote&gt;
&lt;p&gt;My only concern is the compatibility problem. What do you think Timo Walther? Is there any potential problems?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry that I did not answer earlier &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;. But my answer would have been yes, there are compatibility problems.&lt;/p&gt;

&lt;p&gt;Hints are not perfect. Sometimes a user needs to override the &lt;tt&gt;getTypeInference()&lt;/tt&gt; with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
outputTypeStrategy(() -&amp;gt; DataTypes.ARRAY(INT().notNull()).bringedTo(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[].class))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;if a class other that the default class should be used. The default class of INT is Integer, thus the default class for array is Integer[].&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13557554">FLINK-33523</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13557993">FLINK-33547</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1hcnk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>