<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:23:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-3595] Kafka09 consumer thread does not interrupt when stuck in record emission</title>
                <link>https://issues.apache.org/jira/browse/FLINK-3595</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When canceling a job, the Kafka 0.9 Consumer Thread may be stuck in a blocking method (output emitting) and never wakes up.&lt;/p&gt;

&lt;p&gt;The thread as a whole cannot be simply interrupted, because of a bug in Kafka that makes the consumer freeze/hang up on interrupt.&lt;/p&gt;

&lt;p&gt;There are two possible solutions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;allow and call interrupt when the consumer thread is emitting elements&lt;/li&gt;
	&lt;li&gt;destroy the output network buffer pools eagerly on canceling. The Kafka thread will then throw an exception if it is stuck in emitting elements and it will terminate, which is accepted in case the status is canceled.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12948397">FLINK-3595</key>
            <summary>Kafka09 consumer thread does not interrupt when stuck in record emission</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="uce">Ufuk Celebi</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Mar 2016 13:34:22 +0000</created>
                <updated>Mon, 4 Apr 2016 19:28:42 +0000</updated>
                            <resolved>Mon, 4 Apr 2016 19:28:42 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.0.1</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15187094" author="stephanewen" created="Wed, 9 Mar 2016 13:34:52 +0000"  >&lt;p&gt;Had a discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=uce&quot; class=&quot;user-hover&quot; rel=&quot;uce&quot;&gt;uce&lt;/a&gt;, the second option would be preferable, if possible.&lt;/p&gt;</comment>
                            <comment id="15189312" author="githubbot" created="Thu, 10 Mar 2016 13:58:29 +0000"  >&lt;p&gt;GitHub user uce opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1780&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1780&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3595&quot; title=&quot;Kafka09 consumer thread does not interrupt when stuck in record emission&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3595&quot;&gt;&lt;del&gt;FLINK-3595&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Eagerly destroy buffer pools on cancelling&lt;/p&gt;

&lt;p&gt;    When canceling a job, the Kafka 0.9 Consumer Thread may be stuck in a blocking method (output emitting) and never wakes up.&lt;/p&gt;

&lt;p&gt;    The thread as a whole cannot be simply interrupted, because of a bug in Kafka that makes the consumer freeze/hang up on interrupt.&lt;/p&gt;

&lt;p&gt;    With this PR, we destroy the buffer pools eagerly on canceling. The Kafka thread will then throw an exception if it is stuck in emitting elements and it will terminate, which is accepted in case the status is canceled.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/uce/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/uce/flink&lt;/a&gt; 3595-close_bufferpools&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1780.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1780.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1780&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 52320e184f0af61d1d1bf5f9e81b9da2309033c5&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-03-10T11:02:25Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3595&quot; title=&quot;Kafka09 consumer thread does not interrupt when stuck in record emission&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3595&quot;&gt;&lt;del&gt;FLINK-3595&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Eagerly destroy buffer pools on cancelling&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15191312" author="githubbot" created="Fri, 11 Mar 2016 18:06:38 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1780#discussion_r55864951&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1780#discussion_r55864951&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/taskmanager/TaskCancelAsyncProducerConsumerTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,309 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.taskmanager;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.ConfigConstants;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.runtime.instance.ActorGateway;&lt;br/&gt;
    +import org.apache.flink.runtime.io.network.api.writer.RecordWriter;&lt;br/&gt;
    +import org.apache.flink.runtime.io.network.api.writer.ResultPartitionWriter;&lt;br/&gt;
    +import org.apache.flink.runtime.io.network.partition.consumer.InputGate;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.DistributionPattern;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobStatus;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobVertex;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.AbstractInvokable;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.scheduler.SlotSharingGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.messages.JobManagerMessages.CancelJob;&lt;br/&gt;
    +import org.apache.flink.runtime.testingUtils.TestingCluster;&lt;br/&gt;
    +import org.apache.flink.runtime.testingUtils.TestingJobManagerMessages.NotifyWhenJobStatus;&lt;br/&gt;
    +import org.apache.flink.runtime.testingUtils.TestingJobManagerMessages.WaitForAllVerticesToBeRunning;&lt;br/&gt;
    +import org.apache.flink.types.LongValue;&lt;br/&gt;
    +import org.apache.flink.util.TestLogger;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +import scala.concurrent.Await;&lt;br/&gt;
    +import scala.concurrent.Future;&lt;br/&gt;
    +import scala.concurrent.duration.Deadline;&lt;br/&gt;
    +import scala.concurrent.duration.FiniteDuration;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.concurrent.TimeUnit;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +import static org.junit.Assert.assertNotNull;&lt;br/&gt;
    +import static org.junit.Assert.assertTrue;&lt;br/&gt;
    +&lt;br/&gt;
    +public class TaskCancelAsyncProducerConsumerTest extends TestLogger {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    If this fires up a test cluster, it should probably be an IT case&lt;/p&gt;</comment>
                            <comment id="15191316" author="githubbot" created="Fri, 11 Mar 2016 18:12:53 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1780#issuecomment-195483345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1780#issuecomment-195483345&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Test failures&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CheckpointNotifierITCase (2x) - known instability&lt;/li&gt;
	&lt;li&gt;Kafka08 test&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This seems to be the relevant failure&lt;br/&gt;
    ```&lt;br/&gt;
    03/11/2016 15:44:58	Job execution switched to status FAILED.&lt;br/&gt;
    org.apache.flink.client.program.ProgramInvocationException: The program execution failed: Communication with JobManager failed: null&lt;br/&gt;
    	at org.apache.flink.client.program.Client.runBlocking(Client.java:381)&lt;br/&gt;
    	at org.apache.flink.client.program.Client.runBlocking(Client.java:355)&lt;br/&gt;
    	at org.apache.flink.client.program.Client.runBlocking(Client.java:348)&lt;br/&gt;
    	at org.apache.flink.streaming.api.environment.RemoteStreamEnvironment.executeRemotely(RemoteStreamEnvironment.java:206)&lt;br/&gt;
    	at org.apache.flink.streaming.api.environment.RemoteStreamEnvironment.execute(RemoteStreamEnvironment.java:172)&lt;br/&gt;
    	at org.apache.flink.test.util.TestUtils.tryExecute(TestUtils.java:31)&lt;br/&gt;
    	at org.apache.flink.streaming.connectors.kafka.KafkaConsumerTestBase.readSequence(KafkaConsumerTestBase.java:1207)&lt;br/&gt;
    	at org.apache.flink.streaming.connectors.kafka.Kafka08ITCase.testOffsetInZookeeper(Kafka08ITCase.java:216)&lt;br/&gt;
    	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
    	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)&lt;br/&gt;
    	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
    	at java.lang.reflect.Method.invoke(Method.java:483)&lt;br/&gt;
    	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)&lt;br/&gt;
    	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)&lt;br/&gt;
    	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)&lt;br/&gt;
    	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)&lt;br/&gt;
    	at org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)&lt;br/&gt;
    Caused by: org.apache.flink.runtime.client.JobExecutionException: Communication with JobManager failed: null&lt;br/&gt;
    	at org.apache.flink.runtime.client.JobClient.submitJobAndWait(JobClient.java:141)&lt;br/&gt;
    	at org.apache.flink.client.program.Client.runBlocking(Client.java:379)&lt;br/&gt;
    	... 16 more&lt;br/&gt;
    Caused by: java.lang.InterruptedException&lt;br/&gt;
    	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedNanos(AbstractQueuedSynchronizer.java:1039)&lt;br/&gt;
    	at java.util.concurrent.locks.AbstractQueuedSynchronizer.tryAcquireSharedNanos(AbstractQueuedSynchronizer.java:1328)&lt;br/&gt;
    	at scala.concurrent.impl.Promise$DefaultPromise.tryAwait(Promise.scala:208)&lt;br/&gt;
    	at scala.concurrent.impl.Promise$DefaultPromise.ready(Promise.scala:218)&lt;br/&gt;
    	at scala.concurrent.impl.Promise$DefaultPromise.result(Promise.scala:223)&lt;br/&gt;
    	at scala.concurrent.Await$$anonfun$result$1.apply(package.scala:107)&lt;br/&gt;
    	at scala.concurrent.BlockContext$DefaultBlockContext$.blockOn(BlockContext.scala:53)&lt;br/&gt;
    	at scala.concurrent.Await$.result(package.scala:107)&lt;br/&gt;
    	at scala.concurrent.Await.result(package.scala)&lt;br/&gt;
    	at org.apache.flink.runtime.client.JobClient.submitJobAndWait(JobClient.java:133)&lt;br/&gt;
    	... 17 more&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="15191347" author="githubbot" created="Fri, 11 Mar 2016 18:34:50 +0000"  >&lt;p&gt;Github user uce commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1780#issuecomment-195491044&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1780#issuecomment-195491044&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Regarding the stack trace of the Kafka test: the log shows two failures.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The stack trace you posted is part of a test time out (that&apos;s why you have the interruption of the client in your stack trace), and&lt;/li&gt;
	&lt;li&gt;a job restart when not enough task managers are connected (NoResourceAvailableException).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Looking at the code, the failures seem unrelated. Do you think that&apos;s not the case?&lt;/p&gt;</comment>
                            <comment id="15224136" author="githubbot" created="Mon, 4 Apr 2016 13:41:11 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1780#issuecomment-205299566&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1780#issuecomment-205299566&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Makes sense. Given that the CI tests run, I am okay with merging this...&lt;/p&gt;</comment>
                            <comment id="15224225" author="githubbot" created="Mon, 4 Apr 2016 14:25:11 +0000"  >&lt;p&gt;Github user uce commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1780#issuecomment-205319812&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1780#issuecomment-205319812&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Just rebased. Waiting for Travis and then merging to `master` and `release-1.0`.&lt;/p&gt;</comment>
                            <comment id="15224872" author="githubbot" created="Mon, 4 Apr 2016 19:27:58 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1780&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1780&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15224873" author="uce" created="Mon, 4 Apr 2016 19:28:42 +0000"  >&lt;p&gt;Fixed in 3465580 (master), e0dc5c1 (release-1.0).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uefj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>