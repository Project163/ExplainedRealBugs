<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7973] Fix service shading relocation for S3 file systems</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7973</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The shade plugin relocates services incorrectly currently, applying relocation patterns multiple times.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13115927">FLINK-7973</key>
            <summary>Fix service shading relocation for S3 file systems</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkruber">Nico Kruber</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Nov 2017 14:14:03 +0000</created>
                <updated>Fri, 17 Nov 2017 08:31:50 +0000</updated>
                            <resolved>Wed, 15 Nov 2017 09:47:31 +0000</resolved>
                                                    <fixVersion>1.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16238288" author="stephanewen" created="Fri, 3 Nov 2017 20:11:59 +0000"  >&lt;p&gt;Fixed via 84d0677f98f81d50411957103be82993e40f587a&lt;/p&gt;</comment>
                            <comment id="16240351" author="nicok" created="Mon, 6 Nov 2017 14:17:04 +0000"  >&lt;p&gt;the shading is still broken since some Flink classes were included in the relocation but are not present in the jar file&lt;/p&gt;</comment>
                            <comment id="16240742" author="githubbot" created="Mon, 6 Nov 2017 19:23:37 +0000"  >&lt;p&gt;GitHub user NicoK opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7973&quot; title=&quot;Fix service shading relocation for S3 file systems&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7973&quot;&gt;&lt;del&gt;FLINK-7973&lt;/del&gt;&lt;/a&gt; fix shading and relocating Hhadoop for the S3 filesystems&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    The current shading of the `flink-s3-fs-hadoop` and `flink-s3-fs-presto` projects also relocates Flink core classes and even some from the JDK itself. Additionally, the relocation of Hadoop does not work as expected since Hadoop loads classes based on class names in its `core-default.xml` which are unshaded and thus use the original namespace.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;adapt the `pom.xml` of both `flink-s3-fs-hadoop` and `flink-s3-fs-presto`:&lt;/li&gt;
	&lt;li&gt;do not shade everything and instead define include patterns explicitly&lt;/li&gt;
	&lt;li&gt;only shade and relocate Flink classes imported from flink-hadoop-fs&lt;/li&gt;
	&lt;li&gt;hack around Hadoop loading (unshaded/non-relocated) classes based on names in the `core-default.xml` by overwriting the `Configuration` class (we may need to also extend this for the `mapred-default.xml` and `hdfs-defaults.xml` and their respective configuration classes in the future):&lt;/li&gt;
	&lt;li&gt;provide a `core-default-shaded.xml` file with shaded class names and&lt;/li&gt;
	&lt;li&gt;copy and adapt the `Configuration` class of the respective Hadoop version to load this file instead of `core-default.xml`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change can (and was) manually tested as follows:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;verify the shaded `jar` file does not contain non-relocated classes&lt;/li&gt;
	&lt;li&gt;verify the changed `Configuration` classes reside in the shaded namespace where the original Hadoop `Configuration` classes would go into, e.g. `org.apache.flink.fs.s3hadoop.shaded.org.hadoop.conf` (look for `core-default-shaded.xml` string in the `Configuration.class` file)&lt;/li&gt;
	&lt;li&gt;verify the `META-INF/services` files are still correct (name + content)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/NicoK/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/NicoK/flink&lt;/a&gt; flink-7973&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4961&lt;/p&gt;

&lt;hr /&gt;

&lt;hr /&gt;</comment>
                            <comment id="16241884" author="githubbot" created="Tue, 7 Nov 2017 11:54:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961#discussion_r149344188&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961#discussion_r149344188&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-presto/pom.xml &amp;#8212;&lt;br/&gt;
    @@ -284,6 +322,7 @@ under the License.&lt;br/&gt;
     										&amp;lt;exclude&amp;gt;META-INF/maven/org.apache.h*/**&amp;lt;/exclude&amp;gt;&lt;br/&gt;
     										&amp;lt;exclude&amp;gt;META-INF/maven/org.apache.flink/flink-hadoop-fs/**&amp;lt;/exclude&amp;gt;&lt;br/&gt;
     										&amp;lt;exclude&amp;gt;META-INF/maven/org.apache.flink/force-shading/**&amp;lt;/exclude&amp;gt;&lt;br/&gt;
    +										&amp;lt;exclude&amp;gt;core-default.xml&amp;lt;/exclude&amp;gt;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    same as in the other pom&lt;/p&gt;</comment>
                            <comment id="16241885" author="githubbot" created="Tue, 7 Nov 2017 11:54:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961#discussion_r149344386&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961#discussion_r149344386&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-hadoop/pom.xml &amp;#8212;&lt;br/&gt;
    @@ -33,6 +33,7 @@ under the License.&lt;br/&gt;
     	&amp;lt;packaging&amp;gt;jar&amp;lt;/packaging&amp;gt;&lt;/p&gt;

&lt;p&gt;     	&amp;lt;properties&amp;gt;&lt;br/&gt;
    +		&amp;lt;&lt;span class=&quot;error&quot;&gt;Unable to render embedded object: File (-- Do not change this without updating the copied Configuration class) not found.&lt;/span&gt; --&amp;gt;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    should we add a similar comment to the presto hadoop dependency?&lt;/p&gt;</comment>
                            <comment id="16241886" author="githubbot" created="Tue, 7 Nov 2017 11:54:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961#discussion_r149344106&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961#discussion_r149344106&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-hadoop/pom.xml &amp;#8212;&lt;br/&gt;
    @@ -277,6 +336,7 @@ under the License.&lt;br/&gt;
     										&amp;lt;exclude&amp;gt;META-INF/maven/org.apache.commons/**&amp;lt;/exclude&amp;gt;&lt;br/&gt;
     										&amp;lt;exclude&amp;gt;META-INF/maven/org.apache.flink/flink-hadoop-fs/**&amp;lt;/exclude&amp;gt;&lt;br/&gt;
     										&amp;lt;exclude&amp;gt;META-INF/maven/org.apache.flink/force-shading/**&amp;lt;/exclude&amp;gt;&lt;br/&gt;
    +										&amp;lt;exclude&amp;gt;core-default.xml&amp;lt;/exclude&amp;gt;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    add comment that we&apos;re using our own shaded core-default.xml&lt;/p&gt;</comment>
                            <comment id="16242502" author="githubbot" created="Tue, 7 Nov 2017 17:46:05 +0000"  >&lt;p&gt;Github user NicoK commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961#discussion_r149449571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961#discussion_r149449571&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-hadoop/pom.xml &amp;#8212;&lt;br/&gt;
    @@ -33,6 +33,7 @@ under the License.&lt;br/&gt;
     	&amp;lt;packaging&amp;gt;jar&amp;lt;/packaging&amp;gt;&lt;/p&gt;

&lt;p&gt;     	&amp;lt;properties&amp;gt;&lt;br/&gt;
    +		&amp;lt;&lt;span class=&quot;error&quot;&gt;Unable to render embedded object: File (-- Do not change this without updating the copied Configuration class) not found.&lt;/span&gt; --&amp;gt;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    done (also the other suggestions)&lt;/p&gt;</comment>
                            <comment id="16243703" author="githubbot" created="Wed, 8 Nov 2017 10:55:10 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961#discussion_r149635569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961#discussion_r149635569&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-hadoop/README.md &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,27 @@&lt;br/&gt;
    +This project is a wrapper around Hadoop&apos;s s3a file system. By pulling a smaller dependency tree and&lt;br/&gt;
    +shading all dependencies away, this keeps the appearance of Flink being Hadoop-free,&lt;br/&gt;
    +from a dependency perspective.&lt;br/&gt;
    +&lt;br/&gt;
    +We also relocate the shaded Hadoop version to allow running in a different&lt;br/&gt;
    +setup. For this to work, however, we needed to adapt Hadoop&apos;s `Configuration`&lt;br/&gt;
    +class to load a (shaded) `core-default-shaded.xml` configuration with the&lt;br/&gt;
    +relocated class names of classes loaded via reflection&lt;br/&gt;
    +(in the fute, we may need to extend this to `mapred-default.xml` and `hdfs-defaults.xml` and their respective configuration classes).&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: &quot;fute&quot;&lt;/p&gt;</comment>
                            <comment id="16243704" author="githubbot" created="Wed, 8 Nov 2017 10:55:10 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961#discussion_r149635319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961#discussion_r149635319&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-hadoop/README.md &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,27 @@&lt;br/&gt;
    +This project is a wrapper around Hadoop&apos;s s3a file system. By pulling a smaller dependency tree and&lt;br/&gt;
    +shading all dependencies away, this keeps the appearance of Flink being Hadoop-free,&lt;br/&gt;
    +from a dependency perspective.&lt;br/&gt;
    +&lt;br/&gt;
    +We also relocate the shaded Hadoop version to allow running in a different&lt;br/&gt;
    +setup. For this to work, however, we needed to adapt Hadoop&apos;s `Configuration`&lt;br/&gt;
    +class to load a (shaded) `core-default-shaded.xml` configuration with the&lt;br/&gt;
    +relocated class names of classes loaded via reflection&lt;br/&gt;
    +(in the fute, we may need to extend this to `mapred-default.xml` and `hdfs-defaults.xml` and their respective configuration classes).&lt;br/&gt;
    +&lt;br/&gt;
    +# Changing the Hadoop Version&lt;br/&gt;
    +&lt;br/&gt;
    +If you want to change the Hadoop version this project depends on, the following&lt;br/&gt;
    +steps are required to keep the shading correct:&lt;br/&gt;
    +&lt;br/&gt;
    +1. copy `org/apache/hadoop/conf/Configuration.java` from the respective Hadoop jar file to this project&lt;br/&gt;
    +  - adapt the `Configuration` class by replacing `core-default.xml` with `core-default-shaded.xml`.&lt;br/&gt;
    +2. copy `core-default.xml` from the respective Hadoop jar file to this project as&lt;br/&gt;
    +  - `src/main/resources/core-default-shaded.xml` (replacing every occurence of `org.apache.hadoop` with `org.apache.flink.fs.s3hadoop.shaded.org.apache.hadoop`)&lt;br/&gt;
    +  - `src/test/resources/core-site.xml` (as is)&lt;br/&gt;
    +3. verify the shaded jar:&lt;br/&gt;
    +  - does not contain any unshaded classes except for `org.apache.flink.fs.s3hadoop.S3FileSystemFactory`&lt;br/&gt;
    +  - every other classes should be under `org.apache.flink.fs.s3hadoop.shaded`&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    &quot;every other class&quot; or &quot;all other classes&quot;&lt;/p&gt;</comment>
                            <comment id="16243705" author="githubbot" created="Wed, 8 Nov 2017 10:55:10 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961#discussion_r149635214&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961#discussion_r149635214&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-presto/README.md &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,28 @@&lt;br/&gt;
    +This project is a wrapper around the S3 file system from the Presto project which shades all dependencies.&lt;br/&gt;
    +Initial simple tests seem to indicate that it responds slightly faster&lt;br/&gt;
    +and in a bit more lightweight manner to write/read/list requests, compared&lt;br/&gt;
    +to the Hadoop s3a FS, but it has some semantic differences.&lt;br/&gt;
    +&lt;br/&gt;
    +We also relocate the shaded Hadoop version to allow running in a different&lt;br/&gt;
    +setup. For this to work, however, we needed to adapt Hadoop&apos;s `Configuration`&lt;br/&gt;
    +class to load a (shaded) `core-default-shaded.xml` configuration with the&lt;br/&gt;
    +relocated class names of classes loaded via reflection&lt;br/&gt;
    +(in the fute, we may need to extend this to `mapred-default.xml` and `hdfs-defaults.xml` and their respective configuration classes).&lt;br/&gt;
    +&lt;br/&gt;
    +# Changing the Hadoop Version&lt;br/&gt;
    +&lt;br/&gt;
    +If you want to change the Hadoop version this project depends on, the following&lt;br/&gt;
    +steps are required to keep the shading correct:&lt;br/&gt;
    +&lt;br/&gt;
    +1. copy `org/apache/hadoop/conf/Configuration.java` from the respective Hadoop jar file (from `com.facebook.presto.hadoop/hadoop-apache2`) to this project&lt;br/&gt;
    +  - adapt the `Configuration` class by replacing `core-default.xml` with `core-default-shaded.xml`.&lt;br/&gt;
    +2. copy `core-default.xml` from the respective Hadoop jar (from `com.facebook.presto.hadoop/hadoop-apache2`) file to this project as&lt;br/&gt;
    +  - `src/main/resources/core-default-shaded.xml` (replacing every occurence of `org.apache.hadoop` with `org.apache.flink.fs.s3presto.shaded.org.apache.hadoop`)&lt;br/&gt;
    +  - `src/test/resources/core-site.xml` (as is)&lt;br/&gt;
    +3. verify the shaded jar:&lt;br/&gt;
    +  - does not contain any unshaded classes except for `org.apache.flink.fs.s3presto.S3FileSystemFactory`&lt;br/&gt;
    +  - every other classes should be under `org.apache.flink.fs.s3presto.shaded`&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    &quot;every other class&quot; or &quot;all other classes&quot;&lt;/p&gt;</comment>
                            <comment id="16243711" author="githubbot" created="Wed, 8 Nov 2017 10:56:22 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961#discussion_r149635850&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961#discussion_r149635850&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-hadoop/README.md &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,27 @@&lt;br/&gt;
    +This project is a wrapper around Hadoop&apos;s s3a file system. By pulling a smaller dependency tree and&lt;br/&gt;
    +shading all dependencies away, this keeps the appearance of Flink being Hadoop-free,&lt;br/&gt;
    +from a dependency perspective.&lt;br/&gt;
    +&lt;br/&gt;
    +We also relocate the shaded Hadoop version to allow running in a different&lt;br/&gt;
    +setup. For this to work, however, we needed to adapt Hadoop&apos;s `Configuration`&lt;br/&gt;
    +class to load a (shaded) `core-default-shaded.xml` configuration with the&lt;br/&gt;
    +relocated class names of classes loaded via reflection&lt;br/&gt;
    +(in the fute, we may need to extend this to `mapred-default.xml` and `hdfs-defaults.xml` and their respective configuration classes).&lt;br/&gt;
    +&lt;br/&gt;
    +# Changing the Hadoop Version&lt;br/&gt;
    +&lt;br/&gt;
    +If you want to change the Hadoop version this project depends on, the following&lt;br/&gt;
    +steps are required to keep the shading correct:&lt;br/&gt;
    +&lt;br/&gt;
    +1. copy `org/apache/hadoop/conf/Configuration.java` from the respective Hadoop jar file to this project&lt;br/&gt;
    +  - adapt the `Configuration` class by replacing `core-default.xml` with `core-default-shaded.xml`.&lt;br/&gt;
    +2. copy `core-default.xml` from the respective Hadoop jar file to this project as&lt;br/&gt;
    +  - `src/main/resources/core-default-shaded.xml` (replacing every occurence of `org.apache.hadoop` with `org.apache.flink.fs.s3hadoop.shaded.org.apache.hadoop`)&lt;br/&gt;
    +  - `src/test/resources/core-site.xml` (as is)&lt;br/&gt;
    +3. verify the shaded jar:&lt;br/&gt;
    +  - does not contain any unshaded classes except for `org.apache.flink.fs.s3hadoop.S3FileSystemFactory`&lt;br/&gt;
    +  - every other classes should be under `org.apache.flink.fs.s3hadoop.shaded`&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: &quot;classes&quot;&lt;/p&gt;</comment>
                            <comment id="16243717" author="githubbot" created="Wed, 8 Nov 2017 10:57:16 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961#discussion_r149636051&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961#discussion_r149636051&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-presto/README.md &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,28 @@&lt;br/&gt;
    +This project is a wrapper around the S3 file system from the Presto project which shades all dependencies.&lt;br/&gt;
    +Initial simple tests seem to indicate that it responds slightly faster&lt;br/&gt;
    +and in a bit more lightweight manner to write/read/list requests, compared&lt;br/&gt;
    +to the Hadoop s3a FS, but it has some semantic differences.&lt;br/&gt;
    +&lt;br/&gt;
    +We also relocate the shaded Hadoop version to allow running in a different&lt;br/&gt;
    +setup. For this to work, however, we needed to adapt Hadoop&apos;s `Configuration`&lt;br/&gt;
    +class to load a (shaded) `core-default-shaded.xml` configuration with the&lt;br/&gt;
    +relocated class names of classes loaded via reflection&lt;br/&gt;
    +(in the fute, we may need to extend this to `mapred-default.xml` and `hdfs-defaults.xml` and their respective configuration classes).&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: &quot;fute&quot;&lt;/p&gt;</comment>
                            <comment id="16243718" author="githubbot" created="Wed, 8 Nov 2017 10:57:25 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961#discussion_r149636089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961#discussion_r149636089&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-presto/README.md &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,28 @@&lt;br/&gt;
    +This project is a wrapper around the S3 file system from the Presto project which shades all dependencies.&lt;br/&gt;
    +Initial simple tests seem to indicate that it responds slightly faster&lt;br/&gt;
    +and in a bit more lightweight manner to write/read/list requests, compared&lt;br/&gt;
    +to the Hadoop s3a FS, but it has some semantic differences.&lt;br/&gt;
    +&lt;br/&gt;
    +We also relocate the shaded Hadoop version to allow running in a different&lt;br/&gt;
    +setup. For this to work, however, we needed to adapt Hadoop&apos;s `Configuration`&lt;br/&gt;
    +class to load a (shaded) `core-default-shaded.xml` configuration with the&lt;br/&gt;
    +relocated class names of classes loaded via reflection&lt;br/&gt;
    +(in the fute, we may need to extend this to `mapred-default.xml` and `hdfs-defaults.xml` and their respective configuration classes).&lt;br/&gt;
    +&lt;br/&gt;
    +# Changing the Hadoop Version&lt;br/&gt;
    +&lt;br/&gt;
    +If you want to change the Hadoop version this project depends on, the following&lt;br/&gt;
    +steps are required to keep the shading correct:&lt;br/&gt;
    +&lt;br/&gt;
    +1. copy `org/apache/hadoop/conf/Configuration.java` from the respective Hadoop jar file (from `com.facebook.presto.hadoop/hadoop-apache2`) to this project&lt;br/&gt;
    +  - adapt the `Configuration` class by replacing `core-default.xml` with `core-default-shaded.xml`.&lt;br/&gt;
    +2. copy `core-default.xml` from the respective Hadoop jar (from `com.facebook.presto.hadoop/hadoop-apache2`) file to this project as&lt;br/&gt;
    +  - `src/main/resources/core-default-shaded.xml` (replacing every occurence of `org.apache.hadoop` with `org.apache.flink.fs.s3presto.shaded.org.apache.hadoop`)&lt;br/&gt;
    +  - `src/test/resources/core-site.xml` (as is)&lt;br/&gt;
    +3. verify the shaded jar:&lt;br/&gt;
    +  - does not contain any unshaded classes except for `org.apache.flink.fs.s3presto.S3FileSystemFactory`&lt;br/&gt;
    +  - every other classes should be under `org.apache.flink.fs.s3presto.shaded`&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: &quot;classes&quot;&lt;/p&gt;</comment>
                            <comment id="16243722" author="githubbot" created="Wed, 8 Nov 2017 10:58:15 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think this looks good now that the comments are addressed. @zentol what do you think?&lt;/p&gt;</comment>
                            <comment id="16243725" author="githubbot" created="Wed, 8 Nov 2017 10:59:27 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    looks like I created a new word: `fute` &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; - fixed the typos both of you found&lt;/p&gt;</comment>
                            <comment id="16244296" author="githubbot" created="Wed, 8 Nov 2017 16:51:13 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I added two end-to-end tests and it seems for presto this currently fails with:&lt;br/&gt;
    ```&lt;br/&gt;
    ------------------------------------------------------------&lt;br/&gt;
     The program finished with the following exception:&lt;/p&gt;

&lt;p&gt;    org.apache.flink.client.program.ProgramInvocationException: The program execution failed: Failed to submit job ae34d825b54b7afe2e973627d396e722 (WordCount Example)&lt;br/&gt;
    	at org.apache.flink.client.program.ClusterClient.run(ClusterClient.java:492)&lt;br/&gt;
    	at org.apache.flink.client.program.StandaloneClusterClient.submitJob(StandaloneClusterClient.java:105)&lt;br/&gt;
    	at org.apache.flink.client.program.ClusterClient.run(ClusterClient.java:456)&lt;br/&gt;
    	at org.apache.flink.client.program.ClusterClient.run(ClusterClient.java:444)&lt;br/&gt;
    	at org.apache.flink.client.program.ContextEnvironment.execute(ContextEnvironment.java:62)&lt;br/&gt;
    	at org.apache.flink.examples.java.wordcount.WordCount.main(WordCount.java:86)&lt;br/&gt;
    	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
    	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)&lt;br/&gt;
    	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
    	at java.lang.reflect.Method.invoke(Method.java:498)&lt;br/&gt;
    	at org.apache.flink.client.program.PackagedProgram.callMainMethod(PackagedProgram.java:525)&lt;br/&gt;
    	at org.apache.flink.client.program.PackagedProgram.invokeInteractiveModeForExecution(PackagedProgram.java:417)&lt;br/&gt;
    	at org.apache.flink.client.program.ClusterClient.run(ClusterClient.java:396)&lt;br/&gt;
    	at org.apache.flink.client.CliFrontend.executeProgram(CliFrontend.java:802)&lt;br/&gt;
    	at org.apache.flink.client.CliFrontend.run(CliFrontend.java:282)&lt;br/&gt;
    	at org.apache.flink.client.CliFrontend.parseParameters(CliFrontend.java:1054)&lt;br/&gt;
    	at org.apache.flink.client.CliFrontend$1.call(CliFrontend.java:1101)&lt;br/&gt;
    	at org.apache.flink.client.CliFrontend$1.call(CliFrontend.java:1098)&lt;br/&gt;
    	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
    	at javax.security.auth.Subject.doAs(Subject.java:422)&lt;br/&gt;
    	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1556)&lt;br/&gt;
    	at org.apache.flink.runtime.security.HadoopSecurityContext.runSecured(HadoopSecurityContext.java:41)&lt;br/&gt;
    	at org.apache.flink.client.CliFrontend.main(CliFrontend.java:1098)&lt;br/&gt;
    Caused by: org.apache.flink.runtime.client.JobExecutionException: Failed to submit job ae34d825b54b7afe2e973627d396e722 (WordCount Example)&lt;br/&gt;
    	at org.apache.flink.runtime.jobmanager.JobManager.org$apache$flink$runtime$jobmanager$JobManager$$submitJob(JobManager.scala:1325)&lt;br/&gt;
    	at org.apache.flink.runtime.jobmanager.JobManager$$anonfun$handleMessage$1.applyOrElse(JobManager.scala:447)&lt;br/&gt;
    	at scala.runtime.AbstractPartialFunction.apply(AbstractPartialFunction.scala:36)&lt;br/&gt;
    	at org.apache.flink.runtime.LeaderSessionMessageFilter$$anonfun$receive$1.applyOrElse(LeaderSessionMessageFilter.scala:38)&lt;br/&gt;
    	at scala.runtime.AbstractPartialFunction.apply(AbstractPartialFunction.scala:36)&lt;br/&gt;
    	at org.apache.flink.runtime.LogMessages$$anon$1.apply(LogMessages.scala:33)&lt;br/&gt;
    	at org.apache.flink.runtime.LogMessages$$anon$1.apply(LogMessages.scala:28)&lt;br/&gt;
    	at scala.PartialFunction$class.applyOrElse(PartialFunction.scala:123)&lt;br/&gt;
    	at org.apache.flink.runtime.LogMessages$$anon$1.applyOrElse(LogMessages.scala:28)&lt;br/&gt;
    	at akka.actor.Actor$class.aroundReceive(Actor.scala:502)&lt;br/&gt;
    	at org.apache.flink.runtime.jobmanager.JobManager.aroundReceive(JobManager.scala:122)&lt;br/&gt;
    	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:526)&lt;br/&gt;
    	at akka.actor.ActorCell.invoke(ActorCell.scala:495)&lt;br/&gt;
    	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:257)&lt;br/&gt;
    	at akka.dispatch.Mailbox.run(Mailbox.scala:224)&lt;br/&gt;
    	at akka.dispatch.Mailbox.exec(Mailbox.scala:234)&lt;br/&gt;
    	at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)&lt;br/&gt;
    	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)&lt;br/&gt;
    	at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)&lt;br/&gt;
    	at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)&lt;br/&gt;
    Caused by: org.apache.flink.runtime.JobException: Creating the input splits caused an error: null&lt;br/&gt;
    	at org.apache.flink.runtime.executiongraph.ExecutionJobVertex.&amp;lt;init&amp;gt;(ExecutionJobVertex.java:262)&lt;br/&gt;
    	at org.apache.flink.runtime.executiongraph.ExecutionGraph.attachJobGraph(ExecutionGraph.java:801)&lt;br/&gt;
    	at org.apache.flink.runtime.executiongraph.ExecutionGraphBuilder.buildGraph(ExecutionGraphBuilder.java:180)&lt;br/&gt;
    	at org.apache.flink.runtime.jobmanager.JobManager.org$apache$flink$runtime$jobmanager$JobManager$$submitJob(JobManager.scala:1277)&lt;br/&gt;
    	... 19 more&lt;br/&gt;
    Caused by: java.lang.ExceptionInInitializerError&lt;br/&gt;
    	at org.apache.flink.fs.s3presto.shaded.com.amazonaws.ClientConfiguration.&amp;lt;clinit&amp;gt;(ClientConfiguration.java:65)&lt;br/&gt;
    	at org.apache.flink.fs.s3presto.shaded.com.facebook.presto.hive.PrestoS3FileSystem.initialize(PrestoS3FileSystem.java:203)&lt;br/&gt;
    	at org.apache.flink.fs.s3presto.S3FileSystemFactory.create(S3FileSystemFactory.java:133)&lt;br/&gt;
    	at org.apache.flink.core.fs.FileSystem.getUnguardedFileSystem(FileSystem.java:377)&lt;br/&gt;
    	at org.apache.flink.core.fs.FileSystem.get(FileSystem.java:307)&lt;br/&gt;
    	at org.apache.flink.core.fs.Path.getFileSystem(Path.java:293)&lt;br/&gt;
    	at org.apache.flink.api.common.io.FileInputFormat.createInputSplits(FileInputFormat.java:472)&lt;br/&gt;
    	at org.apache.flink.api.common.io.FileInputFormat.createInputSplits(FileInputFormat.java:62)&lt;br/&gt;
    	at org.apache.flink.runtime.executiongraph.ExecutionJobVertex.&amp;lt;init&amp;gt;(ExecutionJobVertex.java:248)&lt;br/&gt;
    	... 22 more&lt;br/&gt;
    Caused by: org.apache.flink.fs.s3presto.shaded.org.apache.commons.logging.LogConfigurationException: java.lang.ClassNotFoundException: org.apache.flink.fs.s3presto.shaded.org.apache.commons.logging.impl.LogFactoryImpl (Caused by java.lang.ClassNotFoundException: org.apache.flink.fs.s3presto.shaded.org.apache.commons.logging.impl.LogFactoryImpl)&lt;br/&gt;
    	at org.apache.flink.fs.s3presto.shaded.org.apache.commons.logging.LogFactory.createFactory(LogFactory.java:1201)&lt;br/&gt;
    	at org.apache.flink.fs.s3presto.shaded.org.apache.commons.logging.LogFactory$2.run(LogFactory.java:1003)&lt;br/&gt;
    	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
    	at org.apache.flink.fs.s3presto.shaded.org.apache.commons.logging.LogFactory.newFactory(LogFactory.java:1000)&lt;br/&gt;
    	at org.apache.flink.fs.s3presto.shaded.org.apache.commons.logging.LogFactory.getFactory(LogFactory.java:626)&lt;br/&gt;
    	at org.apache.flink.fs.s3presto.shaded.org.apache.commons.logging.LogFactory.getLog(LogFactory.java:657)&lt;br/&gt;
    	at org.apache.flink.fs.s3presto.shaded.com.amazonaws.util.VersionInfoUtils.&amp;lt;clinit&amp;gt;(VersionInfoUtils.java:47)&lt;br/&gt;
    	... 31 more&lt;br/&gt;
    Caused by: java.lang.ClassNotFoundException: org.apache.flink.fs.s3presto.shaded.org.apache.commons.logging.impl.LogFactoryImpl&lt;br/&gt;
    	at java.net.URLClassLoader.findClass(URLClassLoader.java:381)&lt;br/&gt;
    	at java.lang.ClassLoader.loadClass(ClassLoader.java:424)&lt;br/&gt;
    	at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:335)&lt;br/&gt;
    	at java.lang.ClassLoader.loadClass(ClassLoader.java:357)&lt;br/&gt;
    	at org.apache.flink.fs.s3presto.shaded.org.apache.commons.logging.LogFactory.createFactory(LogFactory.java:1063)&lt;br/&gt;
    	... 37 more&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    This is my branch with the end-to-end tests: &lt;a href=&quot;https://github.com/aljoscha/flink/tree/finish-pr-4961-s3-shading-fixing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aljoscha/flink/tree/finish-pr-4961-s3-shading-fixing&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16244431" author="githubbot" created="Wed, 8 Nov 2017 17:56:43 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    unfortunately, it seems we cannot minimize the shaded `jar` or it will not contain non-imported/dynamically-loaded classes like this one&lt;/p&gt;</comment>
                            <comment id="16247727" author="githubbot" created="Fri, 10 Nov 2017 16:20:09 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I did include your end-to-end tests (with some fixes) and the fixes for the errors they found. Should be fine now, let&apos;s see what travis says...&lt;/p&gt;</comment>
                            <comment id="16249495" author="githubbot" created="Mon, 13 Nov 2017 12:16:40 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This look even better now! Waiting for Travis and then I&apos;ll merge.&lt;/p&gt;

&lt;p&gt;    Thanks! &#128515; &lt;/p&gt;
</comment>
                            <comment id="16249805" author="aljoscha" created="Mon, 13 Nov 2017 16:44:01 +0000"  >&lt;p&gt;Fixed on master in&lt;br/&gt;
0e5fb0b78cd0a3ccb144071a47579eb6c3d0570a&lt;br/&gt;
e9e7c3372189db7e933ff59114b9ec6245838eda&lt;/p&gt;

&lt;p&gt;Fixed on release-1.4 in&lt;br/&gt;
25a28ab32609c45fb8c40f717148e32fb453d2fc&lt;br/&gt;
9f68212603e3601e2f7a67ff93be9b15844c14da&lt;/p&gt;</comment>
                            <comment id="16249819" author="githubbot" created="Mon, 13 Nov 2017 16:54:54 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Could you please close the PR if it doesn&apos;t auto-close?&lt;/p&gt;</comment>
                            <comment id="16249872" author="githubbot" created="Mon, 13 Nov 2017 17:47:26 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fixed on master in&lt;br/&gt;
    0e5fb0b78cd0a3ccb144071a47579eb6c3d0570a&lt;br/&gt;
    e9e7c3372189db7e933ff59114b9ec6245838eda&lt;/p&gt;

&lt;p&gt;    Fixed on release-1.4 in&lt;br/&gt;
    25a28ab32609c45fb8c40f717148e32fb453d2fc&lt;br/&gt;
    9f68212603e3601e2f7a67ff93be9b15844c14da&lt;/p&gt;</comment>
                            <comment id="16249873" author="githubbot" created="Mon, 13 Nov 2017 17:47:27 +0000"  >&lt;p&gt;Github user NicoK closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4961&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16251217" author="nicok" created="Tue, 14 Nov 2017 10:39:54 +0000"  >&lt;p&gt;we still have problems if (via the classpath) some hadoop JNI library is loaded. Then, &lt;tt&gt;NativeCodeLoader#isNativeCodeLoaded&lt;/tt&gt; will return &lt;tt&gt;true&lt;/tt&gt; and native code libraries will be tried although our relocated namespaces have no JNI mapping.&lt;/p&gt;</comment>
                            <comment id="16251486" author="githubbot" created="Tue, 14 Nov 2017 14:53:10 +0000"  >&lt;p&gt;GitHub user NicoK opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5013&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7973&quot; title=&quot;Fix service shading relocation for S3 file systems&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7973&quot;&gt;&lt;del&gt;FLINK-7973&lt;/del&gt;&lt;/a&gt; disable JNI bridge for relocated hadoop classes in s3-fs-*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    If some Hadoop&apos;s JNI library is in the classpath, it will be loaded by our shaded, relocated hadoop classes in the `flink-s3-fs-*` filesystems as well. Then, however, `NativeCodeLoader#isNativeCodeLoaded` will return `true` and native code libraries will be tried although our relocated namespaces have no JNI mapping leading to errors like `java.lang.UnsatisfiedLinkError: org.apache.flink.fs.s3hadoop.shaded.org.apache.hadoop.security.JniBasedUnixGroupsMapping.anchorNative()V`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;disable native code loading (there are more users than the shown `JniBasedUnixGroupsMapping`) via copies of the respective `NativeCodeLoader` class&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change added tests and can be verified as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Manually verified the change by running a 3 node cluster with 1 JobManagers and 2 TaskManagers on EMR executing the `WordCount` example with an S3 input source:&lt;br/&gt;
      ```&lt;br/&gt;
    cp ./opt/flink-s3-fs-hadoop-1.4-SNAPSHOT.jar ./lib/&lt;br/&gt;
    ./bin/flink run -m yarn-cluster -yn 2 -ys 1 -yjm 768 -ytm 1024 ./examples/batch/WordCount.jar --input s3://&amp;lt;bucket&amp;gt;/&amp;lt;path-to-intput-file&amp;gt;&lt;br/&gt;
    ```&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The serializers: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): *&lt;b&gt;yes&lt;/b&gt;* &amp;#8211; actually, the shaded and relocated Hadoop classes may not use (potentially faster) JNI implementations for certain functions; depending on their use, this may be per record but since this only applies to the S3 filesystem access, performance penalties should be hidden by its access times anyway&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: *&lt;b&gt;yes&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? *&lt;b&gt;docs&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/NicoK/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/NicoK/flink&lt;/a&gt; flink-7973-2&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5013.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5013.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5013&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 95f533d004e7373e9de03245a7984b6355209c22&lt;br/&gt;
Author: Nico Kruber &amp;lt;nico@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-11-14T13:36:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7973&quot; title=&quot;Fix service shading relocation for S3 file systems&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7973&quot;&gt;&lt;del&gt;FLINK-7973&lt;/del&gt;&lt;/a&gt; disable JNI bridge for relocated hadoop classes in s3-fs-*&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16251544" author="githubbot" created="Tue, 14 Nov 2017 15:26:39 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5013&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Changes look reasonable to me. I supposed we can&apos;t guard this with a test?&lt;/p&gt;</comment>
                            <comment id="16251564" author="githubbot" created="Tue, 14 Nov 2017 15:36:14 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5013&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This would be difficult to test - the most reasonable test would be to put the Hadoop JNI into the classpath and then run the end-to-end test on that but we don&apos;t want to include the platform-dependant jni library, I suppose&lt;/p&gt;</comment>
                            <comment id="16253174" author="githubbot" created="Wed, 15 Nov 2017 09:22:05 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5013&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Unfortunately, I don&apos;t think we can test this now. I have in mind to add more end-to-end tests or &quot;system tests&quot; that run nightly on AWS or some proper Hadoop and they should catch it.&lt;/p&gt;

&lt;p&gt;    What do you think, @zentol?&lt;/p&gt;</comment>
                            <comment id="16253183" author="githubbot" created="Wed, 15 Nov 2017 09:30:40 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5013&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I expected that we can&apos;t test automatically this for now. From my side, +1 to merge.&lt;/p&gt;

&lt;p&gt;    We definitely need more tests that actually run against flink-dist though.&lt;/p&gt;</comment>
                            <comment id="16253184" author="githubbot" created="Wed, 15 Nov 2017 09:32:47 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5013&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Jip, the end-to-end tests are a first step but we need more. &#128076; &lt;/p&gt;</comment>
                            <comment id="16253196" author="aljoscha" created="Wed, 15 Nov 2017 09:47:31 +0000"  >&lt;p&gt;Fixed on release-1.4 in&lt;br/&gt;
d6d35fa145c122f469d72bf73433afde5d778aac&lt;/p&gt;

&lt;p&gt;Fixed on master in&lt;br/&gt;
5f00294af4b5527d4e320c2adc66fe9c6c2fd5b6&lt;/p&gt;</comment>
                            <comment id="16253232" author="githubbot" created="Wed, 15 Nov 2017 10:23:51 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5013&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @NicoK could you please close this PR?&lt;/p&gt;

&lt;p&gt;    And thanks for the work! &#128077; &lt;/p&gt;</comment>
                            <comment id="16256646" author="githubbot" created="Fri, 17 Nov 2017 08:31:49 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5013&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fixed on master in&lt;br/&gt;
    0e5fb0b78cd0a3ccb144071a47579eb6c3d0570a&lt;br/&gt;
    e9e7c3372189db7e933ff59114b9ec6245838eda&lt;/p&gt;

&lt;p&gt;    Fixed on release-1.4 in&lt;br/&gt;
    25a28ab32609c45fb8c40f717148e32fb453d2fc&lt;br/&gt;
    9f68212603e3601e2f7a67ff93be9b15844c14da&lt;/p&gt;</comment>
                            <comment id="16256647" author="githubbot" created="Fri, 17 Nov 2017 08:31:50 +0000"  >&lt;p&gt;Github user NicoK closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5013&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3md3r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>