<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:18:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-1419] DistributedCache doesn&apos;t preserver files for subsequent operations</title>
                <link>https://issues.apache.org/jira/browse/FLINK-1419</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When subsequent operations want to access the same files in the DC it frequently happens that the files are not created for the following operation.&lt;/p&gt;

&lt;p&gt;This is fairly odd, since the DC is supposed to either a) preserve files when another operation kicks in within a certain time window, or b) just recreate the deleted files. Both things don&apos;t happen.&lt;br/&gt;
Increasing the time window had no effect.&lt;/p&gt;

&lt;p&gt;I&apos;d like to use this issue as a starting point for a more general discussion about the DistributedCache. &lt;/p&gt;

&lt;p&gt;Currently:&lt;br/&gt;
1. all files reside in a common job-specific directory&lt;br/&gt;
2. are deleted during the job.&lt;/p&gt;

&lt;p&gt;One thing that was brought up about Trait 1 is that it basically forbids modification of the files, concurrent access and all. Personally I&apos;m not sure if this a problem. Changing it to a task-specific place solved the issue though.&lt;/p&gt;

&lt;p&gt;I&apos;m more concerned about Trait #2. Besides the mentioned issue, the deletion is realized with the scheduler, which adds a lot of complexity to the current code. (It really is a pain to work on...) &lt;br/&gt;
If we moved the deletion to the end of the job it could be done as a clean-up step in the TaskManager, With this we could reduce the DC to a cacheFile(String source) method, the delete method in the TM, and throw out everything else.&lt;br/&gt;
Also, the current implementation implies that big files may be copied multiple times. This may be undesired, depending on how big the files are.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12768398">FLINK-1419</key>
            <summary>DistributedCache doesn&apos;t preserver files for subsequent operations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="chesnay">Chesnay Schepler</reporter>
                        <labels>
                    </labels>
                <created>Mon, 19 Jan 2015 09:52:28 +0000</created>
                <updated>Sun, 1 Feb 2015 23:43:47 +0000</updated>
                            <resolved>Sun, 1 Feb 2015 23:43:47 +0000</resolved>
                                    <version>0.8.0</version>
                    <version>0.9</version>
                                    <fixVersion>0.9</fixVersion>
                    <fixVersion>0.8.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14282393" author="fhueske" created="Mon, 19 Jan 2015 11:02:38 +0000"  >&lt;p&gt;I think it is fine to make files in the DC immutable (read only). An operator that wants to modify files, can create a local writable copy.&lt;/p&gt;

&lt;p&gt;Files in the DC should only be copied once per TM and stay until the job is finished, IMO.&lt;br/&gt;
The question is, who initiates the copy process. The first task that requires the file? In that case, all other tasks need to recognize that the file is copied by another task and wait until the copying is completed.&lt;/p&gt;</comment>
                            <comment id="14291639" author="githubbot" created="Mon, 26 Jan 2015 10:09:00 +0000"  >&lt;p&gt;GitHub user zentol opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-1419&quot; title=&quot;DistributedCache doesn&amp;#39;t preserver files for subsequent operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-1419&quot;&gt;&lt;del&gt;FLINK-1419&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; DC properly synchronized&lt;/p&gt;

&lt;p&gt;    Addresses the issue of files not being preserved in subsequent operations.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zentol/incubator-flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/incubator-flink&lt;/a&gt; dc_cache_fix&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #339&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 5c9059d3ce58d8415ce374927dd253579a5fd741&lt;br/&gt;
Author: zentol &amp;lt;s.motsu@web.de&amp;gt;&lt;br/&gt;
Date:   2015-01-26T10:07:53Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-1419&quot; title=&quot;DistributedCache doesn&amp;#39;t preserver files for subsequent operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-1419&quot;&gt;&lt;del&gt;FLINK-1419&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; DC properly synchronized&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14292011" author="githubbot" created="Mon, 26 Jan 2015 16:16:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#discussion_r23541551&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#discussion_r23541551&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/filecache/FileCache.java &amp;#8212;&lt;br/&gt;
    @@ -72,7 +72,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@return copy task&lt;br/&gt;
     	 */&lt;br/&gt;
     	public FutureTask&amp;lt;Path&amp;gt; createTmpFile(String name, DistributedCacheEntry entry, JobID jobID) {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;synchronized (count) {&lt;br/&gt;
    +		synchronized (lock) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    How does the static lock solves the problem?&lt;/p&gt;</comment>
                            <comment id="14292024" author="githubbot" created="Mon, 26 Jan 2015 16:26:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71488487&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71488487&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I don&apos;t really understand how the static lock solves the mentioned issue. Is there a concurrency problem between creating files on disk and updating the count hash map?&lt;/p&gt;

&lt;p&gt;    I think there is a problem between the DeleteProcess and the CopyProcess. The CopyProcess is synchronized on the static lock object and the DeleteProcess is not. Thus, it might be the case that the copy method created the directories for a new file &quot;foobar&quot;, let&apos;s say /tmp/123/foobar, and afterwards the delete process deletes the directory /tmp/123 because it checked the count hash map before the createTmpFile method was called.&lt;/p&gt;

&lt;p&gt;    This problem should still persist with the current changes.&lt;/p&gt;</comment>
                            <comment id="14292032" author="githubbot" created="Mon, 26 Jan 2015 16:29:51 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71489135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71489135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    but that is exactly what is changing, both the delete and copy process are synchronized on the same object.&lt;/p&gt;</comment>
                            <comment id="14292036" author="githubbot" created="Mon, 26 Jan 2015 16:34:36 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71490079&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71490079&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    oh i see what you mean, maybe extend the synchronized block to include the actual delete stuff. yup that&apos;s a good idea, all i know is i tried it without the change and ran into issues, with the change it ran.&lt;/p&gt;</comment>
                            <comment id="14292038" author="githubbot" created="Mon, 26 Jan 2015 16:35:28 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71490264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71490264&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yes, but only the access to the count hash map. The delete action itself is not synchronized.&lt;/p&gt;</comment>
                            <comment id="14292067" author="githubbot" created="Mon, 26 Jan 2015 16:55:41 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71494058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71494058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yeah, that would probably solve the problem. &lt;/p&gt;

&lt;p&gt;    With race conditions it is often very tricky. Sometimes little changes change the process interleaving such that the problem seems to be fixed.&lt;/p&gt;</comment>
                            <comment id="14293416" author="githubbot" created="Tue, 27 Jan 2015 12:14:54 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71638812&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71638812&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    updated to include discussed changes&lt;/p&gt;</comment>
                            <comment id="14293556" author="githubbot" created="Tue, 27 Jan 2015 14:09:12 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71652771&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71652771&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;m wondering whether the count hash map update should rather happen in the copy process. Because otherwise there could be the following interleaving:&lt;/p&gt;

&lt;p&gt;    1. You register a new temp file &quot;foobar&quot; for task B --&amp;gt; creating a copy task and increment file counter&lt;br/&gt;
    2. You delete the temp file &quot;foobar&quot; for task A because it is finished --&amp;gt; creating a delete process with the incremented counter&lt;br/&gt;
    3. You execute the copy process&lt;br/&gt;
    4. You execute the delete process&lt;/p&gt;

&lt;p&gt;    Then the file &quot;foobar&quot; does not exist for task B.&lt;/p&gt;

&lt;p&gt;    Another thing is that the DeleteProcess tries to delete the whole directory below the jobID if one file shall be deleted. I don&apos;t know whether this is the right behaviour.&lt;/p&gt;</comment>
                            <comment id="14293584" author="githubbot" created="Tue, 27 Jan 2015 14:21:49 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71654749&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71654749&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    both good points. I&apos;ll address them after lunch!&lt;/p&gt;</comment>
                            <comment id="14293723" author="githubbot" created="Tue, 27 Jan 2015 16:01:05 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71672497&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71672497&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Whenever I look more closely at the DC I&apos;m always left wondering how it can work at all.&lt;/p&gt;

&lt;p&gt;    About your first point, i don&apos;t think thats enough. there is a more fundamental flaw, we need another counter for delete processes.&lt;/p&gt;

&lt;p&gt;    consider the following 2 scenarios with 2 tasks distributing the same file.&lt;br/&gt;
    C denotes the creating of a copying process, D denotes deleting process. # denotes the count variable, O the oldCount variable.&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    1):   I   II  III  IV&lt;br/&gt;
    T1:--&lt;del&gt;C&lt;/del&gt;------&lt;del&gt;D&lt;/del&gt;-------&lt;br/&gt;
    T2:------&lt;del&gt;C&lt;/del&gt;------&lt;del&gt;D&lt;/del&gt;--&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;1   2    2   2&lt;br/&gt;
    O              2   2&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    2)    I   II  III  IV&lt;br/&gt;
    T1:--&lt;del&gt;C&lt;/del&gt;----------&lt;del&gt;D&lt;/del&gt;--&lt;br/&gt;
    T2:------&lt;del&gt;C&lt;/del&gt;--&lt;del&gt;D&lt;/del&gt;-------&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;1   2    2   2&lt;br/&gt;
    O              2   2&lt;br/&gt;
    ```&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    In both scenarios, D at III should not delete the file, but all D&apos;s have the very same information.&lt;/p&gt;

&lt;p&gt;    instead, i propose having 2 counters, one counting the # of copy operations; and one counting the # of delete operations, with the current value (at process creation) stored in the process. when executing, if the current value is equal to the copy count, files may be deleted, since this means that this delete process was the last to be started.&lt;/p&gt;

&lt;p&gt;    let&apos;s make another fancy schema to illustrate the point:&lt;br/&gt;
    ```&lt;br/&gt;
    1):   I   II  III  IV&lt;br/&gt;
    T1:--&lt;del&gt;C&lt;/del&gt;------&lt;del&gt;D&lt;/del&gt;-------&lt;br/&gt;
    T2:------&lt;del&gt;C&lt;/del&gt;------&lt;del&gt;D&lt;/del&gt;--&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;1   2    2   2&lt;br/&gt;
    O              1   2&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    2)    I   II  III  IV&lt;br/&gt;
    T1:--&lt;del&gt;C&lt;/del&gt;----------&lt;del&gt;D&lt;/del&gt;--&lt;br/&gt;
    T2:------&lt;del&gt;C&lt;/del&gt;--&lt;del&gt;D&lt;/del&gt;-------&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;1   2    2   2&lt;br/&gt;
    O              1   2&lt;br/&gt;
    ```&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14294433" author="githubbot" created="Tue, 27 Jan 2015 23:53:49 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71754470&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71754470&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    You&apos;re right Chesney. I assume that the faulty DC wasn&apos;t noticed because it was probably never really used &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;    Your solution should make the DC to work properly. We could even get rid of the second counter by simply decrementing the counter upon deletion. If the counter is 0, then the file can be deleted. Nice illustrations btw.&lt;/p&gt;</comment>
                            <comment id="14294991" author="githubbot" created="Wed, 28 Jan 2015 10:54:00 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71815201&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71815201&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    updated to include discussed changes&lt;/p&gt;</comment>
                            <comment id="14295015" author="githubbot" created="Wed, 28 Jan 2015 11:20:11 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#discussion_r23680315&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#discussion_r23680315&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/filecache/FileCache.java &amp;#8212;&lt;br/&gt;
    @@ -179,27 +179,40 @@ public Path call()  {&lt;/p&gt;

&lt;p&gt;     		private String name;&lt;br/&gt;
     		private JobID jobID;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private int oldCount;&lt;br/&gt;
    +		private String filePath;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public DeleteProcess(String name, DistributedCacheEntry e, JobID jobID, int c) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    We no longer need c.&lt;/p&gt;</comment>
                            <comment id="14295017" author="githubbot" created="Wed, 28 Jan 2015 11:22:19 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#discussion_r23680424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#discussion_r23680424&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/filecache/FileCache.java &amp;#8212;&lt;br/&gt;
    @@ -179,27 +179,40 @@ public Path call()  {&lt;/p&gt;

&lt;p&gt;     		private String name;&lt;br/&gt;
     		private JobID jobID;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private int oldCount;&lt;br/&gt;
    +		private String filePath;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public DeleteProcess(String name, DistributedCacheEntry e, JobID jobID, int c) &lt;/p&gt;
{
     			this.name = name;
     			this.jobID = jobID;
    -			this.oldCount = c;
    +			this.filePath = e.filePath;
     		}
&lt;p&gt;    +&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void run() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;synchronized (count) {&lt;/li&gt;
	&lt;li&gt;if (count.get(new ImmutablePair&amp;lt;JobID, String&amp;gt;(jobID, name)) != oldCount) {&lt;br/&gt;
    +			Pair&amp;lt;JobID, String&amp;gt; key = new ImmutablePair&amp;lt;JobID, String&amp;gt;(jobID, name);&lt;br/&gt;
    +			synchronized (lock) {&lt;br/&gt;
    +				if (!count.containsKey(key)) {&lt;br/&gt;
     					return;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Could we invert the if condition? Imho something like ```if(count.containsKey(key))&lt;/p&gt;
{ .... }
&lt;p&gt;``` gives a cleaner control flow without too many return statements.&lt;/p&gt;</comment>
                            <comment id="14295019" author="githubbot" created="Wed, 28 Jan 2015 11:22:52 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#discussion_r23680449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#discussion_r23680449&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/filecache/FileCache.java &amp;#8212;&lt;br/&gt;
    @@ -179,27 +179,40 @@ public Path call()  {&lt;/p&gt;

&lt;p&gt;     		private String name;&lt;br/&gt;
     		private JobID jobID;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private int oldCount;&lt;br/&gt;
    +		private String filePath;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public DeleteProcess(String name, DistributedCacheEntry e, JobID jobID, int c) &lt;/p&gt;
{
     			this.name = name;
     			this.jobID = jobID;
    -			this.oldCount = c;
    +			this.filePath = e.filePath;
     		}
&lt;p&gt;    +&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void run() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;synchronized (count) {&lt;/li&gt;
	&lt;li&gt;if (count.get(new ImmutablePair&amp;lt;JobID, String&amp;gt;(jobID, name)) != oldCount) {&lt;br/&gt;
    +			Pair&amp;lt;JobID, String&amp;gt; key = new ImmutablePair&amp;lt;JobID, String&amp;gt;(jobID, name);&lt;br/&gt;
    +			synchronized (lock) {&lt;br/&gt;
    +				if (!count.containsKey(key)) 
{
     					return;
     				}&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;Path tmp = getTempDir(jobID, &quot;&quot;);&lt;/li&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;if (lfs.exists(tmp)) {&lt;/li&gt;
	&lt;li&gt;lfs.delete(tmp, true);&lt;br/&gt;
    +				count.put(key, count.get(key) - 1);&lt;br/&gt;
    +				if (count.get(key) != 0) {&lt;br/&gt;
    +					return;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Same here with the if condition.&lt;/p&gt;</comment>
                            <comment id="14295026" author="githubbot" created="Wed, 28 Jan 2015 11:25:31 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#discussion_r23680555&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#discussion_r23680555&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/filecache/FileCache.java &amp;#8212;&lt;br/&gt;
    @@ -179,27 +179,40 @@ public Path call()  {&lt;/p&gt;

&lt;p&gt;     		private String name;&lt;br/&gt;
     		private JobID jobID;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private int oldCount;&lt;br/&gt;
    +		private String filePath;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public DeleteProcess(String name, DistributedCacheEntry e, JobID jobID, int c) &lt;/p&gt;
{
     			this.name = name;
     			this.jobID = jobID;
    -			this.oldCount = c;
    +			this.filePath = e.filePath;
     		}
&lt;p&gt;    +&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void run() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;synchronized (count) {&lt;/li&gt;
	&lt;li&gt;if (count.get(new ImmutablePair&amp;lt;JobID, String&amp;gt;(jobID, name)) != oldCount) {&lt;br/&gt;
    +			Pair&amp;lt;JobID, String&amp;gt; key = new ImmutablePair&amp;lt;JobID, String&amp;gt;(jobID, name);&lt;br/&gt;
    +			synchronized (lock) {&lt;br/&gt;
    +				if (!count.containsKey(key)) 
{
     					return;
     				}&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;Path tmp = getTempDir(jobID, &quot;&quot;);&lt;/li&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;if (lfs.exists(tmp)) {&lt;/li&gt;
	&lt;li&gt;lfs.delete(tmp, true);&lt;br/&gt;
    +				count.put(key, count.get(key) - 1);&lt;br/&gt;
    +				if (count.get(key) != 0) 
{
    +					return;
    +				}
&lt;p&gt;    +				Path tmp = getTempDir(jobID, filePath.substring(filePath.lastIndexOf(&quot;/&quot;) + 1));&lt;br/&gt;
    +				try {&lt;br/&gt;
    +					if (lfs.exists(tmp)) &lt;/p&gt;
{
    +						lfs.delete(tmp, true);
    +					}
&lt;p&gt;    +					count.remove(key);&lt;br/&gt;
    +					if (count.isEmpty()) { //delete job directory&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This won&apos;t probably work, because there might still be other jobs running on the TaskManager which have not yet deleted all of their files. The problem is the ```Pair&amp;lt;JobID, Filename&amp;gt;```. Either we change count to be something like ```HashMap[JobID, HashMap&lt;span class=&quot;error&quot;&gt;&amp;#91;String, Integer&amp;#93;&lt;/span&gt;]``` or have to iterate over all entries to see if there still exists an entry with the respective jobID.&lt;/p&gt;</comment>
                            <comment id="14295031" author="githubbot" created="Wed, 28 Jan 2015 11:29:28 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71819301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71819301&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    With your latest changes Chesney, namely the incrementing/decrementing logic, I think that it now makes sense again to increase the counters in the createTmpFile method. Because otherwise the following could happen.&lt;/p&gt;

&lt;p&gt;    1. You create a new temp file but do not execute the copy process yet. The respective counter is 1&lt;br/&gt;
    2. You delete the same file and the delete process is immediately executed. This would delete the file.&lt;br/&gt;
    3. Now the copy process is started and has to transfer the file again even though it was known at the time of deleting the file that it is still needed.&lt;/p&gt;

&lt;p&gt;    What do you think? Am I missing a point which prevents putting the incrementing logic back into the createTmpFile method?&lt;/p&gt;</comment>
                            <comment id="14295087" author="githubbot" created="Wed, 28 Jan 2015 12:12:23 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71825712&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71825712&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    well you sure know how to keep me busy &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;    you are right about moving it back. Updated.&lt;/p&gt;
</comment>
                            <comment id="14295092" author="githubbot" created="Wed, 28 Jan 2015 12:25:59 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71827151&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71827151&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Haste makes waste &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14295098" author="githubbot" created="Wed, 28 Jan 2015 12:35:28 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-71828186&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-71828186&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks good to me now. Thanks Chesney.&lt;/p&gt;</comment>
                            <comment id="14300784" author="githubbot" created="Sun, 1 Feb 2015 23:24:32 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339#issuecomment-72390974&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339#issuecomment-72390974&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1, will merge. Thanks @zentol &amp;amp; @tillrohrmann!&lt;/p&gt;</comment>
                            <comment id="14300788" author="githubbot" created="Sun, 1 Feb 2015 23:41:33 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/339&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/339&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14300789" author="fhueske" created="Sun, 1 Feb 2015 23:43:47 +0000"  >&lt;p&gt;Fixed in 563e546236217dace58a8031d56d08a27e08160b&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i24ilr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>