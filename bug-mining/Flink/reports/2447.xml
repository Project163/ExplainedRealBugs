<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9421] RunningJobsRegistry entries are not cleaned up after job termination</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9421</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently, the &lt;tt&gt;Dispatcher&lt;/tt&gt; does not clean up the &lt;tt&gt;RunningJobsRegistry&lt;/tt&gt; after the job has finished. The consequence is that a ZNode with the JobID and a state num per job remains in ZooKeeper.&lt;/p&gt;

&lt;p&gt;We should clean up these ZNodes to avoid a resource leak.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13161361">FLINK-9421</key>
            <summary>RunningJobsRegistry entries are not cleaned up after job termination</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 May 2018 10:04:21 +0000</created>
                <updated>Thu, 24 May 2018 14:53:33 +0000</updated>
                            <resolved>Thu, 24 May 2018 14:53:33 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16488085" author="till.rohrmann" created="Wed, 23 May 2018 21:48:06 +0000"  >&lt;p&gt;Sorry &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yanghua&quot; class=&quot;user-hover&quot; rel=&quot;yanghua&quot;&gt;yanghua&lt;/a&gt;, I actually have a fix ready but did not see that you assigned the issue to yourself. If it&apos;s ok, then I would take this issue.&lt;/p&gt;</comment>
                            <comment id="16488212" author="yanghua" created="Wed, 23 May 2018 23:39:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; I have releases the&#160;&#160;assignee, please go ahead thanks.&lt;/p&gt;</comment>
                            <comment id="16488625" author="githubbot" created="Thu, 24 May 2018 08:16:01 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6068&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;     &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9421&quot; title=&quot;RunningJobsRegistry entries are not cleaned up after job termination&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9421&quot;&gt;&lt;del&gt;FLINK-9421&lt;/del&gt;&lt;/a&gt; Remove job from RunningJobsRegistry when it reaches a terminal state&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This commit lets the Dispatcher remove the RunningJobsRegistry entry for a completed job&lt;br/&gt;
    when it is removed from the Dispatcher.&lt;/p&gt;

&lt;p&gt;    This PR is based on #6067 &lt;/p&gt;

&lt;p&gt;    cc @GJL&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added `DispatcherResourceCleanupTest#testRunningJobsRegistryCleanup`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; runningJobsRegistryCleanup&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6068.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6068.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6068&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4b4d82cc5a3bb9694fd19a37c21345cbe7928962&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-05-23T16:50:27Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9427&quot; title=&quot;Cannot download from BlobServer, because the server address is unknown.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9427&quot;&gt;&lt;del&gt;FLINK-9427&lt;/del&gt;&lt;/a&gt; Fix registration and request slot race condition in TaskExecutor&lt;/p&gt;

&lt;p&gt;    This commit fixes a race condition between the TaskExecutor and the ResourceManager. Before,&lt;br/&gt;
    it could happen that the ResourceManager sends requestSlots message before the TaskExecutor&lt;br/&gt;
    registration was completed. Due to this, the TaskExecutor did not have all information it needed&lt;br/&gt;
    to accept task submissions.&lt;/p&gt;

&lt;p&gt;    The problem was that the TaskExecutor sent the SlotReport at registration time. Due to this, t&lt;br/&gt;
    he SlotManager could already assign these slots to pending slot requests. With this commit, the&lt;br/&gt;
    registration protocol changes such that the TaskExecutor first registers at the ResourceManager&lt;br/&gt;
    and only after completing this step, it will announce the available slots to the SlotManager.&lt;/p&gt;

&lt;p&gt;commit 4d034edca41294e250c49807a3beecb2b419824d&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-05-23T21:48:38Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9421&quot; title=&quot;RunningJobsRegistry entries are not cleaned up after job termination&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9421&quot;&gt;&lt;del&gt;FLINK-9421&lt;/del&gt;&lt;/a&gt; Remove job from RunningJobsRegistry when it reaches a terminal state&lt;/p&gt;

&lt;p&gt;    This commit lets the Dispatcher remove the RunningJobsRegistry entry for a completed job&lt;br/&gt;
    when it is removed from the Dispatcher.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16488808" author="githubbot" created="Thu, 24 May 2018 11:13:21 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6068#discussion_r190548385&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6068#discussion_r190548385&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java &amp;#8212;&lt;br/&gt;
    @@ -271,6 +279,80 @@ public void testBlobServerCleanupWhenClosingDispatcher() throws Exception &lt;/p&gt;
{
     		assertThat(deleteAllFuture.isDone(), is(false));
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that the &lt;/p&gt;
{@link RunningJobsRegistry}
&lt;p&gt; entries are cleared after the&lt;br/&gt;
    +	 * job reached a terminal state.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testRunningJobsRegistryCleanup() throws Exception &lt;/p&gt;
{
    +		submitJob();
    +
    +		runningJobsRegistry.setJobRunning(jobId);
    +		assertThat(runningJobsRegistry.contains(jobId), is(true));
    +
    +		resultFuture.complete(new ArchivedExecutionGraphBuilder().setState(JobStatus.FINISHED).setJobID(jobId).build());
    +
    +		// wait for the clearing
    +		runningJobsRegistry.getClearedFuture().get();
    +
    +		assertThat(runningJobsRegistry.contains(jobId), is(false));
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private static final class TestingRunningJobsRegistry implements RunningJobsRegistry {&lt;br/&gt;
    +&lt;br/&gt;
    +		private final JobID jobId;&lt;br/&gt;
    +&lt;br/&gt;
    +		private final CompletableFuture&amp;lt;Void&amp;gt; clearedFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    For simplicity I would use a `CountDownLatch` here.&lt;/p&gt;</comment>
                            <comment id="16488809" author="githubbot" created="Thu, 24 May 2018 11:13:21 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6068#discussion_r190548607&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6068#discussion_r190548607&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java &amp;#8212;&lt;br/&gt;
    @@ -271,6 +279,80 @@ public void testBlobServerCleanupWhenClosingDispatcher() throws Exception &lt;/p&gt;
{
     		assertThat(deleteAllFuture.isDone(), is(false));
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that the &lt;/p&gt;
{@link RunningJobsRegistry}
&lt;p&gt; entries are cleared after the&lt;br/&gt;
    +	 * job reached a terminal state.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testRunningJobsRegistryCleanup() throws Exception &lt;/p&gt;
{
    +		submitJob();
    +
    +		runningJobsRegistry.setJobRunning(jobId);
    +		assertThat(runningJobsRegistry.contains(jobId), is(true));
    +
    +		resultFuture.complete(new ArchivedExecutionGraphBuilder().setState(JobStatus.FINISHED).setJobID(jobId).build());
    +
    +		// wait for the clearing
    +		runningJobsRegistry.getClearedFuture().get();
    +
    +		assertThat(runningJobsRegistry.contains(jobId), is(false));
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private static final class TestingRunningJobsRegistry implements RunningJobsRegistry {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Maybe `SingleRunningJobRegistry`.&lt;/p&gt;</comment>
                            <comment id="16488810" author="githubbot" created="Thu, 24 May 2018 11:13:22 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6068#discussion_r190500268&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6068#discussion_r190500268&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java &amp;#8212;&lt;br/&gt;
    @@ -271,6 +279,80 @@ public void testBlobServerCleanupWhenClosingDispatcher() throws Exception &lt;/p&gt;
{
     		assertThat(deleteAllFuture.isDone(), is(false));
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that the &lt;/p&gt;
{@link RunningJobsRegistry}
&lt;p&gt; entries are cleared after the&lt;br/&gt;
    +	 * job reached a terminal state.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testRunningJobsRegistryCleanup() throws Exception &lt;/p&gt;
{
    +		submitJob();
    +
    +		runningJobsRegistry.setJobRunning(jobId);
    +		assertThat(runningJobsRegistry.contains(jobId), is(true));
    +
    +		resultFuture.complete(new ArchivedExecutionGraphBuilder().setState(JobStatus.FINISHED).setJobID(jobId).build());
    +
    +		// wait for the clearing
    +		runningJobsRegistry.getClearedFuture().get();
    +
    +		assertThat(runningJobsRegistry.contains(jobId), is(false));
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private static final class TestingRunningJobsRegistry implements RunningJobsRegistry {&lt;br/&gt;
    +&lt;br/&gt;
    +		private final JobID jobId;&lt;br/&gt;
    +&lt;br/&gt;
    +		private final CompletableFuture&amp;lt;Void&amp;gt; clearedFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		private JobSchedulingStatus jobSchedulingStatus = JobSchedulingStatus.PENDING;&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean containsJob = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private TestingRunningJobsRegistry(JobID jobId) &lt;/p&gt;
{
    +			this.jobId = jobId;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public CompletableFuture&amp;lt;Void&amp;gt; getClearedFuture() &lt;/p&gt;
{
    +			return clearedFuture;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void setJobRunning(JobID jobID) throws IOException &lt;/p&gt;
{
    +			checkJobId(jobID);
    +			containsJob = true;
    +			jobSchedulingStatus = JobSchedulingStatus.RUNNING;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		private void checkJobId(JobID jobID) {&lt;br/&gt;
    +			Preconditions.checkArgument(jobId.equals(jobID));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Not the best variable names here: `jobId` vs. `jobID`&lt;/p&gt;</comment>
                            <comment id="16488916" author="githubbot" created="Thu, 24 May 2018 12:44:16 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6068#discussion_r190571191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6068#discussion_r190571191&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java &amp;#8212;&lt;br/&gt;
    @@ -271,6 +279,80 @@ public void testBlobServerCleanupWhenClosingDispatcher() throws Exception &lt;/p&gt;
{
     		assertThat(deleteAllFuture.isDone(), is(false));
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that the &lt;/p&gt;
{@link RunningJobsRegistry}
&lt;p&gt; entries are cleared after the&lt;br/&gt;
    +	 * job reached a terminal state.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testRunningJobsRegistryCleanup() throws Exception &lt;/p&gt;
{
    +		submitJob();
    +
    +		runningJobsRegistry.setJobRunning(jobId);
    +		assertThat(runningJobsRegistry.contains(jobId), is(true));
    +
    +		resultFuture.complete(new ArchivedExecutionGraphBuilder().setState(JobStatus.FINISHED).setJobID(jobId).build());
    +
    +		// wait for the clearing
    +		runningJobsRegistry.getClearedFuture().get();
    +
    +		assertThat(runningJobsRegistry.contains(jobId), is(false));
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private static final class TestingRunningJobsRegistry implements RunningJobsRegistry {&lt;br/&gt;
    +&lt;br/&gt;
    +		private final JobID jobId;&lt;br/&gt;
    +&lt;br/&gt;
    +		private final CompletableFuture&amp;lt;Void&amp;gt; clearedFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		private JobSchedulingStatus jobSchedulingStatus = JobSchedulingStatus.PENDING;&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean containsJob = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private TestingRunningJobsRegistry(JobID jobId) &lt;/p&gt;
{
    +			this.jobId = jobId;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public CompletableFuture&amp;lt;Void&amp;gt; getClearedFuture() &lt;/p&gt;
{
    +			return clearedFuture;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void setJobRunning(JobID jobID) throws IOException &lt;/p&gt;
{
    +			checkJobId(jobID);
    +			containsJob = true;
    +			jobSchedulingStatus = JobSchedulingStatus.RUNNING;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		private void checkJobId(JobID jobID) {&lt;br/&gt;
    +			Preconditions.checkArgument(jobId.equals(jobID));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    True, will change it.&lt;/p&gt;</comment>
                            <comment id="16488917" author="githubbot" created="Thu, 24 May 2018 12:44:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6068#discussion_r190571226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6068#discussion_r190571226&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java &amp;#8212;&lt;br/&gt;
    @@ -271,6 +279,80 @@ public void testBlobServerCleanupWhenClosingDispatcher() throws Exception &lt;/p&gt;
{
     		assertThat(deleteAllFuture.isDone(), is(false));
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that the &lt;/p&gt;
{@link RunningJobsRegistry}
&lt;p&gt; entries are cleared after the&lt;br/&gt;
    +	 * job reached a terminal state.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testRunningJobsRegistryCleanup() throws Exception &lt;/p&gt;
{
    +		submitJob();
    +
    +		runningJobsRegistry.setJobRunning(jobId);
    +		assertThat(runningJobsRegistry.contains(jobId), is(true));
    +
    +		resultFuture.complete(new ArchivedExecutionGraphBuilder().setState(JobStatus.FINISHED).setJobID(jobId).build());
    +
    +		// wait for the clearing
    +		runningJobsRegistry.getClearedFuture().get();
    +
    +		assertThat(runningJobsRegistry.contains(jobId), is(false));
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private static final class TestingRunningJobsRegistry implements RunningJobsRegistry {&lt;br/&gt;
    +&lt;br/&gt;
    +		private final JobID jobId;&lt;br/&gt;
    +&lt;br/&gt;
    +		private final CompletableFuture&amp;lt;Void&amp;gt; clearedFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Good point. Will change it.&lt;/p&gt;</comment>
                            <comment id="16488918" author="githubbot" created="Thu, 24 May 2018 12:44:29 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6068#discussion_r190571258&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6068#discussion_r190571258&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java &amp;#8212;&lt;br/&gt;
    @@ -271,6 +279,80 @@ public void testBlobServerCleanupWhenClosingDispatcher() throws Exception &lt;/p&gt;
{
     		assertThat(deleteAllFuture.isDone(), is(false));
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that the &lt;/p&gt;
{@link RunningJobsRegistry}
&lt;p&gt; entries are cleared after the&lt;br/&gt;
    +	 * job reached a terminal state.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testRunningJobsRegistryCleanup() throws Exception &lt;/p&gt;
{
    +		submitJob();
    +
    +		runningJobsRegistry.setJobRunning(jobId);
    +		assertThat(runningJobsRegistry.contains(jobId), is(true));
    +
    +		resultFuture.complete(new ArchivedExecutionGraphBuilder().setState(JobStatus.FINISHED).setJobID(jobId).build());
    +
    +		// wait for the clearing
    +		runningJobsRegistry.getClearedFuture().get();
    +
    +		assertThat(runningJobsRegistry.contains(jobId), is(false));
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private static final class TestingRunningJobsRegistry implements RunningJobsRegistry {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Good idea.&lt;/p&gt;</comment>
                            <comment id="16488925" author="githubbot" created="Thu, 24 May 2018 12:50:25 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6068&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @GJL. I&apos;ll address your comments and then merge the PR.&lt;/p&gt;</comment>
                            <comment id="16489140" author="githubbot" created="Thu, 24 May 2018 14:51:42 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6068&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16489148" author="till.rohrmann" created="Thu, 24 May 2018 14:53:33 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
master: 5ad0ca2392a9672a92756337243834d1b466a24d&lt;br/&gt;
1.5.0: 2307102fb3cd733b453438877b179043dfeaae9b&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3u1u7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>