<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:49:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19441] Performance regression on 24.09.2020</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19441</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;A couple of benchmarks are showing a small performance regression on 24.09.2020:&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=globalWindow&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=globalWindow&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=tupleKeyBy&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=tupleKeyBy&amp;amp;env=2&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13329744">FLINK-19441</key>
            <summary>Performance regression on 24.09.2020</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="arvid">Arvid Heise</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 28 Sep 2020 12:41:53 +0000</created>
                <updated>Tue, 22 Jun 2021 14:06:58 +0000</updated>
                            <resolved>Tue, 20 Apr 2021 07:12:41 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17203209" author="pnowojski" created="Mon, 28 Sep 2020 12:53:03 +0000"  >&lt;p&gt;It&apos;s likely (% noisy benchmarks and regression size of the noise) that the last good build was &lt;tt&gt;73a1441952&lt;/tt&gt;, while first problematic was &lt;tt&gt;aa62e64902&lt;/tt&gt;.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;git ls 73a1441952..aa62e64902
aa62e64902 [4 weeks ago] [FLINK-19323][network] Small optimization of RecordWriter#serializeRecord [kevin.cyj]
8ec4f1d8d2 [4 weeks ago] [FLINK-19302][network] Fix flushing BoundedBlockingResultPartition [kevin.cyj]
b7ed49d829 [4 weeks ago] [hotfix] Remove unused RecordWriterTest#TrackingBufferRecycler [kevin.cyj]
900a896922 [5 weeks ago] [FLINK-19297][network] Make ResultPartitionWriter record-oriented [kevin.cyj]
88a07a9eb6 [4 weeks ago] [FLINK-19312][network] Introduce BufferWritingResultPartition which wraps the ResultSubpartition related logic [kevin.cyj]
0c8a7c1ea3 [4 weeks ago] [hotfix] Remove outdated description in Javadoc of RecordWriter [kevin.cyj]
82f524baec [4 weeks ago] [FLINK-19320][task] Remove RecordWriter#clearBuffers [kevin.cyj]
c3fab5173c [4 days ago] [FLINK-19391][network] Moved notification during subpartition request to the requester. [Arvid Heise]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17203217" author="arvid" created="Mon, 28 Sep 2020 13:07:53 +0000"  >&lt;p&gt;It&apos;s highly unlikely that my commit has caused this regression. It&apos;s much more likely that this PR has caused some more overhead per record (like one additional virtual call).&lt;/p&gt;</comment>
                            <comment id="17204166" author="stephanewen" created="Tue, 29 Sep 2020 17:44:45 +0000"  >&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; did run benchmarks on the code before we merged it. This regression was not visible then.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; could you share your findings here?&lt;/p&gt;</comment>
                            <comment id="17204616" author="arvid" created="Wed, 30 Sep 2020 10:01:32 +0000"  >&lt;p&gt;The regressions are rather subtle and may be lost in noise for one run. However, both the content and the timing fit too well as that we can dismiss it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It would be good to have several benchmark runs of the non-rebased version to be sure that it&apos;s in fact not the cause. It might also make sense to double-check the code for any unnecessary virtual calls on the hot path.&lt;/p&gt;</comment>
                            <comment id="17205424" author="stephanewen" created="Thu, 1 Oct 2020 11:19:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AHeise&quot; class=&quot;user-hover&quot; rel=&quot;AHeise&quot;&gt;AHeise&lt;/a&gt; That sounds like a plan. I&apos;ll start digging into the code, see if I can spot some virtual per-record calls.&lt;/p&gt;</comment>
                            <comment id="17207834" author="rmetzger" created="Mon, 5 Oct 2020 05:59:09 +0000"  >&lt;p&gt;Since this ticket is a blocker, I&apos;d like to assign one person to be responsible for its resolution. I&apos;ll assign &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; for now. Please unassign yourself if you disagree.&lt;/p&gt;</comment>
                            <comment id="17208828" author="stephanewen" created="Tue, 6 Oct 2020 14:56:04 +0000"  >&lt;p&gt;&#160;I could not find anything very suspicious in the code. In general, the code does look less complex not than before, does not have any new locks or volatile variable accesses, and seems to have the same number of virtual method calls:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&#160;RecordWriter.emit(T record) (bi-morphic between &lt;tt&gt;ChannelSelectorRecordWriter&lt;/tt&gt; and &lt;tt&gt;BroadcastRecordWriter&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;The record serialization (to byte buffer) is unchanged&lt;/li&gt;
	&lt;li&gt;Because the record-to-buffer logic is in the &lt;tt&gt;ResultPartition&lt;/tt&gt; now, there is one method on ResultPartition that is called per record now, rather than per buffer. That method is not virtual, though, there is only one active implementation.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;One think we can investigate is the &lt;tt&gt;ConsumableNotifyingResultPartitionWriterDecorator&lt;/tt&gt;. The class is always loaded, but never instantiated (only a static method is used). That means in CHA the JIT will find two methods for the last method mentioned above, but all call sites call the same one, so any profiling logic should be able to cut this out again.&lt;/p&gt;

&lt;p&gt;Still, it is trivial to change the code so that the &lt;tt&gt;ConsumableNotifyingResultPartitionWriterDecorator&lt;/tt&gt; code is never loaded.&lt;br/&gt;
 Here is the PR for that: &lt;a href=&quot;https://github.com/apache/flink/pull/13548&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/13548&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17212527" author="rmetzger" created="Mon, 12 Oct 2020 17:18:05 +0000"  >&lt;p&gt;Is there any update on this ticket? Should this ticket block the 1.12 release?&lt;/p&gt;</comment>
                            <comment id="17212856" author="arvid" created="Tue, 13 Oct 2020 06:14:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;&apos;s PR did not fix the regression (which had a low chance anyways). I&apos;d now need to bisect everything and run the two benchmarks very often on my local machine to narrow it down to a specific commit. However, I currently lack the time. The regression itself is also quite subtle (in comparison for example the the Avro regression). I&apos;d decrease priority to Critical and take it into the bug fixing phase.&lt;br/&gt;
Note that literally anyone could work on narrowing it down.&lt;/p&gt;</comment>
                            <comment id="17213559" author="ym" created="Wed, 14 Oct 2020 03:20:53 +0000"  >&lt;p&gt;I have forwarded this to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;&#160;and pinged him in person.&lt;/p&gt;</comment>
                            <comment id="17213611" author="kevin.cyj" created="Wed, 14 Oct 2020 05:07:27 +0000"  >&lt;p&gt;Really sorry for the late responses. I will take a look and will update if I have any findings soon.&lt;/p&gt;</comment>
                            <comment id="17214410" author="kevin.cyj" created="Thu, 15 Oct 2020 03:50:44 +0000"  >&lt;p&gt;As a first step, I tried to run the two benchmark cases on commit&#160;c3fab5173c (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19391&quot; title=&quot;Deadlock during partition update&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19391&quot;&gt;&lt;del&gt;FLINK-19391&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Moved notification during subpartition request to the requester. &lt;span class=&quot;error&quot;&gt;&amp;#91;Arvid Heise&amp;#93;&lt;/span&gt;) and commit&#160;aa62e64902 (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19323&quot; title=&quot;Small optimization of network layer record serialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19323&quot;&gt;&lt;del&gt;FLINK-19323&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Small optimization of RecordWriter#serializeRecord &lt;span class=&quot;error&quot;&gt;&amp;#91;kevin.cyj&amp;#93;&lt;/span&gt;). There is no regression and the performance is even better for tupleKeyBy. For globalWindow, there is no visible different. The results are as follows:&lt;/p&gt;

&lt;p&gt;To avoid influence from other processes, I closes all other applications on my laptop, after which only about 3% CPU is used. Besides, two versions of Flink package ran in turn, the odd line in the following results is from commit&#160;c3fab5173c and the even line is from commit&#160;aa62e64902 (line number starts from 1).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(base) kevin.cyj@kevincyjs-macbook-pro flink-benchmarks % grep &lt;span class=&quot;code-quote&quot;&gt;&quot;KeyByBenchmarks.tupleKeyBy&quot;&lt;/span&gt; ../result.txt | grep &lt;span class=&quot;code-quote&quot;&gt;&quot;thrpt&quot;&lt;/span&gt;
KeyByBenchmarks.tupleKeyBy     thrpt   30  4399.725 &#177; 180.287  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4393.090 &#177; 215.023  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4646.292 &#177; 273.936  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4123.914 &#177; 108.549  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4349.349 &#177; 275.403  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4808.382 &#177; 362.876  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4224.644 &#177; 236.571  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4649.511 &#177; 255.074  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4340.121 &#177; 230.217  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4973.276 &#177; 161.522  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4481.989 &#177; 250.952  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4494.742 &#177; 328.143  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4482.170 &#177; 245.795  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4210.755 &#177; 136.354  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4244.761 &#177; 255.086  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4687.526 &#177; 299.669  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4188.102 &#177; 240.958  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4658.756 &#177; 257.802  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4370.287 &#177; 206.037  ops/ms
KeyByBenchmarks.tupleKeyBy     thrpt   30  4583.454 &#177; 286.767  ops/ms
(base) kevin.cyj@kevincyjs-macbook-pro flink-benchmarks % grep &lt;span class=&quot;code-quote&quot;&gt;&quot;WindowBenchmarks.globalWindow&quot;&lt;/span&gt; ../result.txt | grep &lt;span class=&quot;code-quote&quot;&gt;&quot;thrpt&quot;&lt;/span&gt;
WindowBenchmarks.globalWindow  thrpt   30  5359.334 &#177;  92.793  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5473.884 &#177;  72.067  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5449.328 &#177;  88.903  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5316.775 &#177; 307.340  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5413.462 &#177;  89.206  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5403.000 &#177; 337.460  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5409.112 &#177;  92.309  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5556.913 &#177; 103.412  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5512.030 &#177;  95.002  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5490.936 &#177;  87.189  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5520.000 &#177;  83.022  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5422.663 &#177; 107.169  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5353.005 &#177;  91.061  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5451.412 &#177; 104.578  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5444.123 &#177;  89.937  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5512.661 &#177;  64.927  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5377.912 &#177;  89.680  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5480.517 &#177;  68.624  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5373.978 &#177; 122.724  ops/ms
WindowBenchmarks.globalWindow  thrpt   30  5436.810 &#177; 102.140  ops/ms
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17220785" author="rmetzger" created="Mon, 26 Oct 2020 15:59:25 +0000"  >&lt;p&gt;If there are no objections, I will downgrade the priority of this ticket to &quot;Critical&quot; in the coming days.&lt;/p&gt;</comment>
                            <comment id="17225191" author="rmetzger" created="Tue, 3 Nov 2020 07:21:24 +0000"  >&lt;p&gt;I&apos;m downgrading the ticket.&lt;/p&gt;</comment>
                            <comment id="17322955" author="flink-jira-bot" created="Fri, 16 Apr 2021 10:52:24 +0000"  >&lt;p&gt;This issue is assigned but has not received an update in 7 days so it has been labeled &quot;stale-assigned&quot;. If you are still working on the issue, please give an update and remove the label. If you are no longer working on the issue, please unassign so someone else may work on it. In 7 days the issue will be automatically unassigned.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13328446">FLINK-19297</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13329738">FLINK-19439</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13329740">FLINK-19440</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0iz4g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>