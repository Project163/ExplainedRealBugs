<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:48:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18862] Fix LISTAGG throws BinaryRawValueData cannot be cast to StringData exception in runtime</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18862</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;1. Env&#65306;flinksql&#12289; version 1.11.1&#65292;perjob mode&lt;br/&gt;
2. Error&#65306;org.apache.flink.table.data.binary.BinaryRawValueData cannot be cast to org.apache.flink.table.data.StringData&lt;/p&gt;

&lt;p&gt;3&#12289;Job&#65306;&lt;/p&gt;

&lt;p&gt;(1) create a kafka table&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    CREATE TABLE kafka(
        x &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
        y &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;
    )with(
       &lt;span class=&quot;code-quote&quot;&gt;&apos;connector&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;kafka&apos;&lt;/span&gt;,
        ......
    )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;(2)create a view:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   CREATE VIEW view1 AS
   SELECT 
       x, 
       y, 
       CAST(COUNT(1) AS VARCHAR) AS ct
   FROM kafka
   GROUP BY 
       x, y
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;(3) aggregate on the view:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    select 
         x, 
         LISTAGG(CONCAT_WS(&lt;span class=&quot;code-quote&quot;&gt;&apos;=&apos;&lt;/span&gt;, y, ct), &lt;span class=&quot;code-quote&quot;&gt;&apos;,&apos;&lt;/span&gt;) AS lists
    FROM view1
    GROUP BY x
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then the exception is thrown&#65306;org.apache.flink.table.data.binary.BinaryRawValueData cannot be cast to org.apache.flink.table.data.StringData&lt;br/&gt;
The problem is that, there is no RawValueData in the query. The result type of count(1) should be bigint, not RawValueData. &lt;/p&gt;

&lt;p&gt;(4) If there is no aggregation, the job can run succefully.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    select 
	    x, 
	    CONCAT_WS(&lt;span class=&quot;code-quote&quot;&gt;&apos;=&apos;&lt;/span&gt;, y, ct)
    from view1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The detailed exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ClassCastException: org.apache.flink.table.data.binary.BinaryRawValueData cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to org.apache.flink.table.data.StringData
	at org.apache.flink.table.data.GenericRowData.getString(GenericRowData.java:169) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.table.data.JoinedRowData.getString(JoinedRowData.java:139) ~[flink-table-blink_2.11-1.11.1.jar:?]
	at org.apache.flink.table.data.RowData.get(RowData.java:273) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.table.runtime.typeutils.RowDataSerializer.copyRowData(RowDataSerializer.java:156) ~[flink-table-blink_2.11-1.11.1.jar:1.11.1]
	at org.apache.flink.table.runtime.typeutils.RowDataSerializer.copy(RowDataSerializer.java:123) ~[flink-table-blink_2.11-1.11.1.jar:1.11.1]
	at org.apache.flink.table.runtime.typeutils.RowDataSerializer.copy(RowDataSerializer.java:50) ~[flink-table-blink_2.11-1.11.1.jar:1.11.1]
	at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.pushToOperator(OperatorChain.java:715) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.collect(OperatorChain.java:692) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.collect(OperatorChain.java:672) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:52) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:30) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.api.operators.TimestampedCollector.collect(TimestampedCollector.java:53) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.table.runtime.operators.aggregate.GroupAggFunction.processElement(GroupAggFunction.java:205) ~[flink-table-blink_2.11-1.11.1.jar:1.11.1]
	at org.apache.flink.table.runtime.operators.aggregate.GroupAggFunction.processElement(GroupAggFunction.java:43) ~[flink-table-blink_2.11-1.11.1.jar:1.11.1]
	at org.apache.flink.streaming.api.operators.KeyedProcessOperator.processElement(KeyedProcessOperator.java:85) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.tasks.OneInputStreamTask$StreamTaskNetworkOutput.emitRecord(OneInputStreamTask.java:161) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.io.StreamTaskNetworkInput.processElement(StreamTaskNetworkInput.java:178) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.io.StreamTaskNetworkInput.emitNext(StreamTaskNetworkInput.java:153) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:67) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:345) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxStep(MailboxProcessor.java:191) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:181) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:558) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:530) ~[ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:721) [ad_features_auto-1.0-SNAPSHOT.jar:?]
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:546) [ad_features_auto-1.0-SNAPSHOT.jar:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13321690">FLINK-18862</key>
            <summary>Fix LISTAGG throws BinaryRawValueData cannot be cast to StringData exception in runtime</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jark">Jark Wu</assignee>
                                    <reporter username="YUJIANBO">YUJIANBO</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 9 Aug 2020 15:36:47 +0000</created>
                <updated>Tue, 11 Aug 2020 08:33:13 +0000</updated>
                            <resolved>Tue, 11 Aug 2020 08:33:13 +0000</resolved>
                                    <version>1.11.1</version>
                                    <fixVersion>1.11.2</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17174015" author="leonard xu" created="Mon, 10 Aug 2020 01:51:44 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=YUJIANBO&quot; class=&quot;user-hover&quot; rel=&quot;YUJIANBO&quot;&gt;YUJIANBO&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks for creating this issue. But could you using English to describe this issue? It&apos;s recommended using English in community.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17174082" author="jark" created="Mon, 10 Aug 2020 05:36:17 +0000"  >&lt;p&gt;Thanks for reporting this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=YUJIANBO&quot; class=&quot;user-hover&quot; rel=&quot;YUJIANBO&quot;&gt;YUJIANBO&lt;/a&gt;, I have reproduced this problem in local. I will take this issue. &lt;/p&gt;</comment>
                            <comment id="17174126" author="jark" created="Mon, 10 Aug 2020 07:13:51 +0000"  >&lt;p&gt;I have looked into this issue. The root cause is that the &lt;tt&gt;ListAggWithRetractAggFunction#getTypeInference&lt;/tt&gt; is not considered when it is a built-in agg function. However, if we want to call &lt;tt&gt;getTypeInference&lt;/tt&gt;, we have to pass the &lt;tt&gt;DataTypeFactory&lt;/tt&gt; for all the related methods in &lt;tt&gt;AggregateUtils&lt;/tt&gt;, e.g. &lt;tt&gt;transformToStreamAggregateInfoList, transformToBatchAggregateInfoList, deriveAggregateInfoList&lt;/tt&gt;, which is a big refactoring. Do you have any thoughts &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17174161" author="twalthr" created="Mon, 10 Aug 2020 07:59:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&#160;I&apos;m about to open PR for&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18809&quot; title=&quot;Update internal aggregate functions to new type system&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18809&quot;&gt;&lt;del&gt;FLINK-18809&lt;/del&gt;&lt;/a&gt;. Only one test is failing in my builds. After that all built-in agg functions use the new type system. It might also solve this issue.&lt;/p&gt;</comment>
                            <comment id="17174168" author="jark" created="Mon, 10 Aug 2020 08:12:05 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt;. I just figure out a quick fix for this: override the &lt;tt&gt;ListAggWithRetractAggFunction#getResultType&lt;/tt&gt; and return &lt;tt&gt;InternalTypeInfo.of(DataTypes.STRING().getLogicalType())&lt;/tt&gt;. This uses the legacy APIs, but should work. &lt;/p&gt;</comment>
                            <comment id="17174187" author="jark" created="Mon, 10 Aug 2020 08:49:43 +0000"  >&lt;p&gt;Considering we still need a fix for 1.11 series, I will open a pull request with the above approach. We can switch to the type inference approach in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18809&quot; title=&quot;Update internal aggregate functions to new type system&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18809&quot;&gt;&lt;del&gt;FLINK-18809&lt;/del&gt;&lt;/a&gt; but keep the new added tests. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17174213" author="twalthr" created="Mon, 10 Aug 2020 10:07:48 +0000"  >&lt;p&gt;Yes, this could be a fix for the 1.11 branch.&lt;/p&gt;</comment>
                            <comment id="17175195" author="jark" created="Tue, 11 Aug 2020 03:23:05 +0000"  >&lt;p&gt;Fixed in &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;master (1.12.0): bfbdca9f574b4201ba7a400607c5169134ecf0a2&lt;/li&gt;
	&lt;li&gt;1.11.2: a72a8cd430a00c51ba55d7d9eed3e39dcbac3164&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="13009346" name="sql &#20013;agg&#31639;&#23376;&#30340; count(1) &#30340;&#32467;&#26524;&#24378;&#36716;&#25104;String&#31867;&#22411;&#20877;&#32463;&#36807;&#19968;&#27425;agg&#30340;&#25805;&#20316;&#23601;&#19981;&#33021;&#25104;&#21151;.txt" size="5007" author="YUJIANBO" created="Sun, 9 Aug 2020 16:20:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 14 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hlj4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>