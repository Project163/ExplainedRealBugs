<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:40:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-13487] TaskExecutorPartitionLifecycleTest.testPartitionReleaseAfterReleaseCall failed on Travis</title>
                <link>https://issues.apache.org/jira/browse/FLINK-13487</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://api.travis-ci.org/v3/job/564925114/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/564925114/log.txt&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
21:14:47.090 [ERROR] Tests run: 4, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 5.754 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.flink.runtime.taskexecutor.TaskExecutorPartitionLifecycleTest
21:14:47.090 [ERROR] testPartitionReleaseAfterReleaseCall(org.apache.flink.runtime.taskexecutor.TaskExecutorPartitionLifecycleTest)  Time elapsed: 0.136 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.util.concurrent.ExecutionException: org.apache.flink.runtime.taskexecutor.exceptions.TaskSubmissionException: Could not submit task because there is no JobManager associated &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the job 2a0ab40cb53241799b71ff6fd2f53d3d.
	at org.apache.flink.runtime.taskexecutor.TaskExecutorPartitionLifecycleTest.testPartitionRelease(TaskExecutorPartitionLifecycleTest.java:331)
	at org.apache.flink.runtime.taskexecutor.TaskExecutorPartitionLifecycleTest.testPartitionReleaseAfterReleaseCall(TaskExecutorPartitionLifecycleTest.java:201)
Caused by: org.apache.flink.runtime.taskexecutor.exceptions.TaskSubmissionException: Could not submit task because there is no JobManager associated &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the job 2a0ab40cb53241799b71ff6fd2f53d3d.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13247777">FLINK-13487</key>
            <summary>TaskExecutorPartitionLifecycleTest.testPartitionReleaseAfterReleaseCall failed on Travis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gaoyunhaii">Yun Gao</assignee>
                                    <reporter username="tzulitai">Tzu-Li (Gordon) Tai</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 30 Jul 2019 04:21:16 +0000</created>
                <updated>Wed, 2 Oct 2019 17:50:25 +0000</updated>
                            <resolved>Wed, 31 Jul 2019 11:43:54 +0000</resolved>
                                                    <fixVersion>1.9.0</fixVersion>
                                    <component>Runtime / Task</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16896083" author="zjwang" created="Tue, 30 Jul 2019 12:34:03 +0000"  >&lt;p&gt;Thanks for the cooperation from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; to trace the root cause. It is mainly caused by unfinished registration while submitting tasks and we could reoccur it when adjust the codes to sleep for a while during registration. &#160;We should make the submitting task happen only after registration done.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; would fix for it.&lt;/p&gt;</comment>
                            <comment id="16896346" author="gaoyunhaii" created="Tue, 30 Jul 2019 17:25:44 +0000"  >&lt;p&gt;Very thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; for the&#160;help at this issue! A more detailed cause of this issue is described as follows.&lt;/p&gt;

&lt;p&gt;From the logs recorded in the &lt;em&gt;error_log&lt;/em&gt;&#160; attached, we can see that:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The TM registers to JM for two times.&lt;/li&gt;
	&lt;li&gt;When the task is submitted, the jobManagerTable does not contains the corresponding JobId, and thus cause the test failed.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The basic process of the test is:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Step 1 
&lt;/span&gt;taskManagerServices.getJobLeaderService().addJob(jobId, jobMasterAddress); 

&lt;span class=&quot;code-comment&quot;&gt;// Step 2
&lt;/span&gt;jobManagerLeaderRetriever.notifyListener(jobMasterAddress, UUID.randomUUID());

&lt;span class=&quot;code-comment&quot;&gt;// Step 3 
&lt;/span&gt;taskExecutorGateway.requestSlot() 

&lt;span class=&quot;code-comment&quot;&gt;// Step 4 
&lt;/span&gt;taskExecutorGateway.submitTask()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The two registration is triggered by step 1/2 and step 3 respectively. However, since the registration is asynchronous, the submit task is executed before the two registrations get finished. To fix this problem, we need to postpone the submitting till the slot is offered to JM. In real case this is guaranteed by JM not start deploying the task before the slot offer succeed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;A more detailed description is as follows for reference:&lt;/p&gt;

&lt;p&gt;In step 1, the job id is added to the JobLeaderService of the TM side, and it triggers the leader retrieve process. Since the leader retrieve service is an instance of SettableLeaderRetrieveService and by now the address has not been set, the leader retrieve will not take effects.&lt;/p&gt;

&lt;p&gt;In step 2, the&#160;SettableLeaderRetrieveService is notified with the actual JobMaster address and then TM starts to register to JM. Part of the registration should be done asynchronously by the execution thread pool of the RpcService. However, in this case the asynchronous part might takes longer time than usual.&lt;/p&gt;

&lt;p&gt;In step 3, the request slot allocates the slot first, then TM found that the registration has not succeeded. Then is call jobLeaderService#addJob again. Since now the JM address has been set, it will trigger the second registration. The registration is also executed asynchronously and the request will return successfully.&lt;/p&gt;

&lt;p&gt;In step 4, the submit started before the registration succeeded. Then the error occurred.&lt;/p&gt;

&lt;p&gt;The the finally part in the test code executes and shutdown the TM, the the tests end and the original submit failing exception was thrown. This is the reason that the exception is&#160;printed after the TM stopped. At this time, the Akka thread of TM continued to run since the exception in the akka thread is caught, and one of the registration finally succeed and it triggers the slot offering again. This is why we can also see the offering slot event in the error log.&#160;&lt;/p&gt;

&lt;p&gt;&#160;The above exception could reoccur stably if we add a sleep in the RetryingRegistration#register, before the call of &quot;completionFuture.complete(Tuple2.of(gateway, success))&quot; in the asynchronous executor thread. We can also see the two jobLeaderService#addJob calls in this case. If we also add sleep to the finally part of the test method, we can also see the offer slot event after the submitting failure.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16896902" author="till.rohrmann" created="Wed, 31 Jul 2019 08:19:57 +0000"  >&lt;p&gt;Please move the issue into &quot;In Progress&quot; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yungao.gy&quot; class=&quot;user-hover&quot; rel=&quot;yungao.gy&quot;&gt;yungao.gy&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; will take a look at the PR.&lt;/p&gt;</comment>
                            <comment id="16897083" author="zentol" created="Wed, 31 Jul 2019 11:43:54 +0000"  >&lt;p&gt;master: 3958cec0d1be3c2e4e9c48ec675085557384b4cd&lt;/p&gt;

&lt;p&gt;1.9: e5e1c11f2fe9ed9de88488e5344033264cad03de&#160;&lt;/p&gt;</comment>
                            <comment id="16897141" author="gaoyunhaii" created="Wed, 31 Jul 2019 12:56:44 +0000"  >&lt;p&gt;Very thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;, and sorry for not changing the status. I will pay attention the next time.&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12976228" name="error_log.png" size="444189" author="gaoyunhaii" created="Tue, 30 Jul 2019 14:58:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ztt4:k</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>