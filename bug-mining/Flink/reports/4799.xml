<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19391] Deadlock during partition update</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19391</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Master cron job is currently failing because of a deadlock introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19026&quot; title=&quot;Improve threading model of Unaligner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19026&quot;&gt;&lt;del&gt;FLINK-19026&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-09-23T21:50:39.2444176Z Found one Java-level deadlock:
2020-09-23T21:50:39.2444633Z =============================
2020-09-23T21:50:39.2445001Z &quot;Temp writer&quot;:
2020-09-23T21:50:39.2445484Z   waiting to lock monitor 0x00007f4e14004ca8 (object 0x0000000086501948, a java.lang.Object),
2020-09-23T21:50:39.2446418Z   which is held by &quot;flink-akka.actor.default-dispatcher-2&quot;
2020-09-23T21:50:39.2447193Z &quot;flink-akka.actor.default-dispatcher-2&quot;:
2020-09-23T21:50:39.2447903Z   waiting to lock monitor 0x00007f4e14004bf8 (object 0x0000000086501930, a org.apache.flink.runtime.io.network.partition.PrioritizedDeque),
2020-09-23T21:50:39.2448703Z   which is held by &quot;Temp writer&quot;
2020-09-23T21:50:39.2448965Z 
2020-09-23T21:50:39.2449384Z Java stack information for the threads listed above:
2020-09-23T21:50:39.2449900Z ===================================================
2020-09-23T21:50:39.2450325Z &quot;Temp writer&quot;:
2020-09-23T21:50:39.2451050Z 	at org.apache.flink.runtime.io.network.partition.consumer.LocalInputChannel.checkAndWaitForSubpartitionView(LocalInputChannel.java:244)
2020-09-23T21:50:39.2452264Z 	- waiting to lock &amp;lt;0x0000000086501948&amp;gt; (a java.lang.Object)
2020-09-23T21:50:39.2453183Z 	at org.apache.flink.runtime.io.network.partition.consumer.LocalInputChannel.getNextBuffer(LocalInputChannel.java:205)
2020-09-23T21:50:39.2454173Z 	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.waitAndGetNextData(SingleInputGate.java:642)
2020-09-23T21:50:39.2455422Z 	- locked &amp;lt;0x0000000086501930&amp;gt; (a org.apache.flink.runtime.io.network.partition.PrioritizedDeque)
2020-09-23T21:50:39.2456310Z 	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.getNextBufferOrEvent(SingleInputGate.java:619)
2020-09-23T21:50:39.2457311Z 	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.getNext(SingleInputGate.java:602)
2020-09-23T21:50:39.2458205Z 	at org.apache.flink.runtime.taskmanager.InputGateWithMetrics.getNext(InputGateWithMetrics.java:105)
2020-09-23T21:50:39.2459258Z 	at org.apache.flink.runtime.io.network.api.reader.AbstractRecordReader.getNextRecord(AbstractRecordReader.java:100)
2020-09-23T21:50:39.2460465Z 	at org.apache.flink.runtime.io.network.api.reader.MutableRecordReader.next(MutableRecordReader.java:47)
2020-09-23T21:50:39.2461344Z 	at org.apache.flink.runtime.operators.util.ReaderIterator.next(ReaderIterator.java:59)
2020-09-23T21:50:39.2462164Z 	at org.apache.flink.runtime.operators.TempBarrier$TempWritingThread.run(TempBarrier.java:178)
2020-09-23T21:50:39.2463418Z &quot;flink-akka.actor.default-dispatcher-2&quot;:
2020-09-23T21:50:39.2464109Z 	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.queueChannel(SingleInputGate.java:825)
2020-09-23T21:50:39.2465336Z 	- waiting to lock &amp;lt;0x0000000086501930&amp;gt; (a org.apache.flink.runtime.io.network.partition.PrioritizedDeque)
2020-09-23T21:50:39.2466228Z 	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.notifyChannelNonEmpty(SingleInputGate.java:791)
2020-09-23T21:50:39.2467222Z 	at org.apache.flink.runtime.io.network.partition.consumer.InputChannel.notifyChannelNonEmpty(InputChannel.java:154)
2020-09-23T21:50:39.2468212Z 	at org.apache.flink.runtime.io.network.partition.consumer.LocalInputChannel.notifyDataAvailable(LocalInputChannel.java:236)
2020-09-23T21:50:39.2469577Z 	at org.apache.flink.runtime.io.network.partition.ResultPartitionManager.createSubpartitionView(ResultPartitionManager.java:76)
2020-09-23T21:50:39.2470607Z 	at org.apache.flink.runtime.io.network.partition.consumer.LocalInputChannel.requestSubpartition(LocalInputChannel.java:133)
2020-09-23T21:50:39.2471765Z 	- locked &amp;lt;0x0000000086501948&amp;gt; (a java.lang.Object)
2020-09-23T21:50:39.2472685Z 	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.updateInputChannel(SingleInputGate.java:489)
2020-09-23T21:50:39.2473727Z 	- locked &amp;lt;0x0000000086532500&amp;gt; (a java.lang.Object)
2020-09-23T21:50:39.2474449Z 	at org.apache.flink.runtime.io.network.NettyShuffleEnvironment.updatePartitionInfo(NettyShuffleEnvironment.java:279)
2020-09-23T21:50:39.2475394Z 	at org.apache.flink.runtime.taskexecutor.TaskExecutor.lambda$updatePartitions$12(TaskExecutor.java:758)
2020-09-23T21:50:39.2476235Z 	at org.apache.flink.runtime.taskexecutor.TaskExecutor$$Lambda$406/1860601696.run(Unknown Source)
2020-09-23T21:50:39.2476973Z 	at java.util.concurrent.CompletableFuture$AsyncRun.run(CompletableFuture.java:1640)
2020-09-23T21:50:39.2477714Z 	at akka.dispatch.TaskInvocation.run(AbstractDispatcher.scala:40)
2020-09-23T21:50:39.2478698Z 	at akka.dispatch.ForkJoinExecutorConfigurator$AkkaForkJoinTask.exec(ForkJoinExecutorConfigurator.scala:44)
2020-09-23T21:50:39.2479506Z 	at akka.dispatch.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
2020-09-23T21:50:39.2480263Z 	at akka.dispatch.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
2020-09-23T21:50:39.2481018Z 	at akka.dispatch.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
2020-09-23T21:50:39.2481727Z 	at akka.dispatch.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
2020-09-23T21:50:39.2482192Z 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The deadlock was introduced by the alternative fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12510&quot; title=&quot;Deadlock when reading from InputGates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12510&quot;&gt;&lt;del&gt;FLINK-12510&lt;/del&gt;&lt;/a&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19026&quot; title=&quot;Improve threading model of Unaligner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19026&quot;&gt;&lt;del&gt;FLINK-19026&lt;/del&gt;&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;The alternative fix avoided double lock acquisition in &lt;tt&gt;SingleInputGate#waitAndGetNextData&lt;/tt&gt; by moving &lt;tt&gt;notifyDataAvailable&lt;/tt&gt; from &lt;tt&gt;ResultSubpartition#createReadView&lt;/tt&gt; to &lt;tt&gt;ResultPartitionManager#createSubpartitionView&lt;/tt&gt;, which solved the circular deadlock of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12510&quot; title=&quot;Deadlock when reading from InputGates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12510&quot;&gt;&lt;del&gt;FLINK-12510&lt;/del&gt;&lt;/a&gt; by not acquiring the &lt;tt&gt;buffers&lt;/tt&gt; lock of &lt;tt&gt;PipelinedSubpartition&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;However, that fix didn&apos;t go far enough. For local channels, it is still possible to create a similar deadlock. While &lt;tt&gt;SingleInputGate&lt;/tt&gt; reads from &lt;tt&gt;LocalInputChannel&lt;/tt&gt;, it holds the lock &lt;tt&gt;inputChannelsWithData&lt;/tt&gt;. The channel may start requesting the partition and tries to acquire &lt;tt&gt;requestLock&lt;/tt&gt;. &lt;br/&gt;
At the same time there is an update of partition info, which acquires the &lt;tt&gt;requestLock&lt;/tt&gt; and notifies the &lt;tt&gt;SingleInputGate&lt;/tt&gt;, which needs to lock on &lt;tt&gt;inputChannelsWithData&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The solution is to first acquire the partition and release &lt;tt&gt;requestLock&lt;/tt&gt; before notifying &lt;tt&gt;SingleInputGate&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13329150">FLINK-19391</key>
            <summary>Deadlock during partition update</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arvid">Arvid Heise</assignee>
                                    <reporter username="arvid">Arvid Heise</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 24 Sep 2020 07:23:29 +0000</created>
                <updated>Tue, 22 Jun 2021 14:07:29 +0000</updated>
                            <resolved>Thu, 24 Sep 2020 14:17:11 +0000</resolved>
                                    <version>1.12.0</version>
                                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17201555" author="arvid" created="Thu, 24 Sep 2020 14:17:02 +0000"  >&lt;p&gt;Merged into master as &lt;a href=&quot;https://github.com/apache/flink/commit/c3fab5173c1127c970ee992e8bde948abd22dced&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/c3fab5173c1127c970ee992e8bde948abd22dced&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="13329109">FLINK-19387</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13324104">FLINK-19026</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 7 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ivgo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>