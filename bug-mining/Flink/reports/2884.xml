<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:38:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-11046] ElasticSearch6Connector cause thread blocked when index failed with retry</title>
                <link>https://issues.apache.org/jira/browse/FLINK-11046</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When i&apos;m using es6 sink to index into es,&#160;bulk process with some&#160;exception catched, and&#160; i trying to reindex the document with the call `indexer.add(action)`&#160;in the `ActionRequestFailureHandler.onFailure()` method, but things goes incorrect. The call thread stuck there, and with the thread dump, i saw the `bulkprocessor` object was locked by other thread.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; ActionRequestFailureHandler &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Serializable {

 void onFailure(ActionRequest action, Throwable failure, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; restStatusCode, RequestIndexer indexer) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable;

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After i read the code implemented in the `indexer.add(action)`, i find that `synchronized` is needed on each add operation.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void internalAdd(DocWriteRequest request, @Nullable &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; payload) {
&#160; ensureOpen();
&#160; bulkRequest.add(request, payload);
&#160; executeIfNeeded();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And, at i also noticed that `bulkprocessor` object&#160;would also&#160;locked in the bulk process thread.&#160;&lt;/p&gt;

&lt;p&gt;the bulk process operation is in the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void execute(BulkRequest bulkRequest, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; executionId) {
    &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; toRelease = () -&amp;gt; {};
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; bulkRequestSetupSuccessful = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        listener.beforeBulk(executionId, bulkRequest);
        semaphore.acquire();
        toRelease = semaphore::release;
        CountDownLatch latch = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CountDownLatch(1);
        retry.withBackoff(consumer, bulkRequest, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActionListener&amp;lt;BulkResponse&amp;gt;() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onResponse(BulkResponse response) {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    listener.afterBulk(executionId, bulkRequest, response);
                } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                    semaphore.release();
                    latch.countDown();
                }
            }

            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onFailure(Exception e) {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    listener.afterBulk(executionId, bulkRequest, e);
                } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                    semaphore.release();
                    latch.countDown();
                }
            }
        }, Settings.EMPTY);
        bulkRequestSetupSuccessful = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (concurrentRequests == 0) {
           latch.await();
        }
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
        logger.info(() -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ParameterizedMessage(&lt;span class=&quot;code-quote&quot;&gt;&quot;Bulk request {} has been cancelled.&quot;&lt;/span&gt;, executionId), e);
        listener.afterBulk(executionId, bulkRequest, e);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
        logger.warn(() -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ParameterizedMessage(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to execute bulk request {}.&quot;&lt;/span&gt;, executionId), e);
        listener.afterBulk(executionId, bulkRequest, e);
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bulkRequestSetupSuccessful == &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we fail on client.bulk() release the semaphore
&lt;/span&gt;            toRelease.run();
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As the read line i marked above, i think, that&apos;s the reason why the retry operation thread was block, because the the bulk process thread never release the lock on `bulkprocessor`.&#160; and, i also trying to figure out why the field `concurrentRequests` was set to zero. And i saw the the initialize for bulkprocessor in class `ElasticsearchSinkBase`:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; BulkProcessor buildBulkProcessor(BulkProcessor.Listener listener) {
 ...
 BulkProcessor.Builder bulkProcessorBuilder =      callBridge.createBulkProcessorBuilder(client, listener);

 &lt;span class=&quot;code-comment&quot;&gt;// This makes flush() blocking
&lt;/span&gt; bulkProcessorBuilder.setConcurrentRequests(0);
 
 ...

 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; bulkProcessorBuilder.build();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;this field value was set to zero&#160;explicitly. So, all things seems to make sense, but i still wonder why the retry operation is not in the same thread as the bulk process execution, after i read the code, `bulkAsync` method might be the&#160;last puzzle.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; BulkProcessor.Builder createBulkProcessorBuilder(RestHighLevelClient client, BulkProcessor.Listener listener) {
 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; BulkProcessor.builder(client::bulkAsync, listener);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So, I hope someone can help to fix this problem, or given some suggestions,&#160;and also&#160;i can make a try to take it.&#160;&lt;br/&gt;
 Thanks a lot !&lt;/p&gt;</description>
                <environment></environment>
        <key id="13201837">FLINK-11046</key>
            <summary>ElasticSearch6Connector cause thread blocked when index failed with retry</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xueyu">xueyu</assignee>
                                    <reporter username="luoguohao">luoguohao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 2 Dec 2018 07:18:48 +0000</created>
                <updated>Wed, 8 Jan 2020 12:13:50 +0000</updated>
                            <resolved>Mon, 11 Feb 2019 18:00:57 +0000</resolved>
                                    <version>1.6.2</version>
                                    <fixVersion>1.7.2</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>Connectors / ElasticSearch</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16706243" author="miki haiat" created="Sun, 2 Dec 2018 12:28:40 +0000"  >&lt;p&gt;HI ,&lt;br/&gt;
Can you please share the elastic connection properties .&lt;/p&gt;



&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16706611" author="luoguohao" created="Mon, 3 Dec 2018 02:43:28 +0000"  >&lt;p&gt;sorry for missing that, here are all my settings for the ES sink:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;bulk.flush.max.actions: 1000&lt;/li&gt;
	&lt;li&gt;bulk.flush.interval.ms: 10s&lt;/li&gt;
	&lt;li&gt;bulk.flush.max.size.mb: 10M&lt;/li&gt;
	&lt;li&gt;bulk.flush.backoff.enable: true&lt;/li&gt;
	&lt;li&gt;bulk.flush.backoff.retries: 3&lt;/li&gt;
	&lt;li&gt;bulk.flush.backoff.type:&#160;EXPONENTIAL&lt;/li&gt;
	&lt;li&gt;bulk.flush.backoff.delay: 1minute&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16708337" author="tzulitai" created="Tue, 4 Dec 2018 07:57:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luoguohao&quot; class=&quot;user-hover&quot; rel=&quot;luoguohao&quot;&gt;luoguohao&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;So, to clarify things a bit:&lt;br/&gt;
In your Elasticsearch function&apos;s failure handler, you&apos;re catching an exception and readding documents to the indexer?&lt;br/&gt;
What exactly is the exception that you are getting?&lt;/p&gt;

&lt;p&gt;If possible, could you also give me a more complete snippet of the code that you&apos;re encountering this problem? That would help with figuring out the problem on my side.&lt;/p&gt;</comment>
                            <comment id="16708469" author="luoguohao" created="Tue, 4 Dec 2018 09:36:13 +0000"  >&lt;p&gt;HI, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thank you for your reply. Because&#160;our&#160;elasticSearch&#160;scheme is configured as strict mode, so if some unexpected `strict_dynamic_mapping_exception` be thrown, i would check if the&#160;field is invalid, otherwise, remapping the schema, and re-adding the index operation into the `RequestIndexer` instance.&lt;/p&gt;

&lt;p&gt;The snippet of the code would as simple as the follow:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LoadTraitIntoEsFailureHandler
    &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ActionRequestFailureHandler {

 override def onFailure(action: ActionRequest,
                       failure: Throwable,
                       restStatusCode: Int,
                       indexer: RequestIndexer): Unit = {
   failure match {
     &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; exception: ElasticsearchException
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; isStrictDynamicMappingException(exception) &#8658; 
        val updateAction = action.asInstanceOf[UpdateRequest]
        &lt;span class=&quot;code-comment&quot;&gt;// remapping the es schema &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; needed
&lt;/span&gt;        ...
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt;, re-adding the action &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; needed
&lt;/span&gt;        indexer.add(updateAction)
     &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; others &#8658;
       &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; nothing
&lt;/span&gt;   }
 }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That&apos;s all things&#160;for the retry operation.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16721296" author="tzulitai" created="Fri, 14 Dec 2018 11:37:01 +0000"  >&lt;p&gt;This seems a bit odd.&lt;/p&gt;

&lt;p&gt;While concurrent requests is indeed set to 0 and therefore only a single bulk&#160;request will be allowed to be executed and new index accumulations are blocked during the process, the lock should have been released&#160;after the bulk request finishes and un-block the new index addition.&lt;/p&gt;

&lt;p&gt;After all, the &lt;tt&gt;BulkProcessor&lt;/tt&gt; is supposed to be thread-safe: &lt;a href=&quot;http://javadoc.kyubu.de/elasticsearch/HEAD/org/elasticsearch/action/bulk/BulkProcessor.html.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://javadoc.kyubu.de/elasticsearch/HEAD/org/elasticsearch/action/bulk/BulkProcessor.html.&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16721314" author="tzulitai" created="Fri, 14 Dec 2018 11:53:33 +0000"  >&lt;p&gt;Ah ...., I think I understand the deadlock now.&lt;/p&gt;

&lt;p&gt;It&apos;s because the we&apos;re calling the user provided &lt;tt&gt;ActionRequestFailureHandler.onFailure(...)&lt;/tt&gt;&#160; inside the &lt;tt&gt;afterBulk&lt;/tt&gt; callback. The lock is only released when the &lt;tt&gt;afterBulk&lt;/tt&gt; method returns.&lt;/p&gt;

&lt;p&gt;So, the deadlock is:&lt;br/&gt;
1. The &lt;tt&gt;BulkProcessor&lt;/tt&gt; flushes, and one of the document indexing failed, which invokes the&#160;user&apos;s&#160;&lt;tt&gt;ActionRequestFailureHandler.onFailure(...)&lt;/tt&gt;. At this point, the lock on &lt;tt&gt;BulkProcessor&lt;/tt&gt; isn&apos;t released yet, because the &lt;tt&gt;onFailure&lt;/tt&gt; call is part of the bulk processor&apos;s flush callback.&lt;br/&gt;
2. Within &lt;tt&gt;ActionRequestFailureHandler.onFailure(...)&lt;/tt&gt;, in your case you added some new documents to be indexed. Upon adding, the &lt;tt&gt;BulkProcessor&lt;/tt&gt; would try to flush again, but the lock wasn&apos;t released yet and therefore deadlock.&lt;/p&gt;

&lt;p&gt;So, the re-indexing thread (i.e. the async callback) should have been blocked on:&lt;br/&gt;
&lt;a href=&quot;https://github.com/elastic/elasticsearch/blob/v6.3.1/server/src/main/java/org/elasticsearch/action/bulk/BulkRequestHandler.java#L60&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/elastic/elasticsearch/blob/v6.3.1/server/src/main/java/org/elasticsearch/action/bulk/BulkRequestHandler.java#L60&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;While the main task thread should have been blocked on:&lt;br/&gt;
&lt;a href=&quot;https://github.com/elastic/elasticsearch/blob/v6.3.1/server/src/main/java/org/elasticsearch/action/bulk/BulkRequestHandler.java#L86&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/elastic/elasticsearch/blob/v6.3.1/server/src/main/java/org/elasticsearch/action/bulk/BulkRequestHandler.java#L86&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Could you confirm this and see if the analysis makes sense to you?&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luoguohao&quot; class=&quot;user-hover&quot; rel=&quot;luoguohao&quot;&gt;luoguohao&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16721348" author="tzulitai" created="Fri, 14 Dec 2018 12:24:51 +0000"  >&lt;p&gt;I propose the following fix:&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;RequestIndexer&lt;/tt&gt; instance provided to the &lt;tt&gt;ActionRequestFailureHandler&lt;/tt&gt; shouldn&apos;t be the same instance as the one used for indexing incoming records (i.e. the one used in &lt;tt&gt;invoke&lt;/tt&gt; method of the sink).&lt;/p&gt;

&lt;p&gt;Instead, it should be a separate instance, which buffers any requests that the user attempts to re-index in the failure handler.&lt;br/&gt;
In &lt;tt&gt;invoke&lt;/tt&gt;, before processing the next element, we always check if there are buffered requests from the failure handler that needs to be added to the actual request indexer.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luoguohao&quot; class=&quot;user-hover&quot; rel=&quot;luoguohao&quot;&gt;luoguohao&lt;/a&gt; you mentioned that you would want to try fixing this. Do you want to take a try on this?&lt;/p&gt;</comment>
                            <comment id="16742179" author="xueyu" created="Mon, 14 Jan 2019 15:08:29 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;, have you worked on this issue? If not could you please assign this issue to me..I investigated this issue these two days and have some ideas to fix it and wanted to have a try on it. According to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt; comments, my thought was writing a new RequestIndexer which uses BulkRequest to buffer action requests. I was a little late to assign it... Thanks~&lt;/p&gt;</comment>
                            <comment id="16742183" author="dawidwys" created="Mon, 14 Jan 2019 15:11:15 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xueyu&quot; class=&quot;user-hover&quot; rel=&quot;xueyu&quot;&gt;xueyu&lt;/a&gt;,&lt;br/&gt;
I just started, so I can leave it for you.&lt;/p&gt;</comment>
                            <comment id="16742665" author="luoguohao" created="Tue, 15 Jan 2019 02:06:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt; yes, that&apos;s the point. thanks for giving&#160;a suggestion. i&#160;may not have enough time working on it, maybe next time. currently, i just&#160;get around this problem by re-indexing manually.&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xueyu&quot; class=&quot;user-hover&quot; rel=&quot;xueyu&quot;&gt;xueyu&lt;/a&gt;&#160;i am also looking forward to your commit and&#160;apply the patch when it is available. Thx.&lt;/p&gt;</comment>
                            <comment id="16742980" author="tzulitai" created="Tue, 15 Jan 2019 11:11:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xueyu&quot; class=&quot;user-hover&quot; rel=&quot;xueyu&quot;&gt;xueyu&lt;/a&gt; please feel free to ping me after opening the PR. Thanks for working on this.&lt;/p&gt;</comment>
                            <comment id="16742981" author="tzulitai" created="Tue, 15 Jan 2019 11:12:31 +0000"  >&lt;p&gt;Just a side note for the implementation:&lt;br/&gt;
probably the Elasticsearch end-to-end test should be updated to cover this scenario (re-indexing ES documents in the failure handler).&lt;br/&gt;
We should also make sure that the updated end-to-end test does actually fail without the proposed fix.&lt;/p&gt;</comment>
                            <comment id="16747810" author="dawidwys" created="Mon, 21 Jan 2019 10:06:11 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xueyu&quot; class=&quot;user-hover&quot; rel=&quot;xueyu&quot;&gt;xueyu&lt;/a&gt; Did you manage to make any progress on this issue?&lt;/p&gt;</comment>
                            <comment id="16747831" author="xueyu" created="Mon, 21 Jan 2019 10:35:13 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;, sorry that I only writed the codes and didn&apos;t write any test and end-to-end test yet...The codes are on &lt;a href=&quot;https://github.com/xueyumusic/flink/tree/es6-onfailure&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;my branch&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;According to my current work status I estimated that still need about two weeks  from my side.. If this issue is urgent, please feel free to take it over.&lt;br/&gt;
Thank you and sorry for delay..., &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;  &lt;/p&gt;</comment>
                            <comment id="16750025" author="xueyu" created="Wed, 23 Jan 2019 14:09:09 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt;, I don&apos;t know how to make elastic6 response has failure and then trigger onFailure callback in e2e test Elasticsearch6SinkExample.java right now...Do you have any suggestions about this..? Thanks. &lt;br/&gt;
I tried this and was not sure whether it is right..&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; IndexRequest createIndexRequest(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; element, ParameterTool parameterTool) {
		Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; json = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
		json.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;data&quot;&lt;/span&gt;, element);

		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (element.startsWith(&lt;span class=&quot;code-quote&quot;&gt;&quot;message #15&quot;&lt;/span&gt;)) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Requests.indexRequest()
					.index(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
					.type(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
					.id(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
					.source(element);
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Requests.indexRequest()
				.index(parameterTool.getRequired(&lt;span class=&quot;code-quote&quot;&gt;&quot;index&quot;&lt;/span&gt;))
				.type(parameterTool.getRequired(&lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt;))
				.id(element)
				.source(json);
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16750891" author="xueyu" created="Thu, 24 Jan 2019 09:05:34 +0000"  >&lt;p&gt;It looks that this kind of IndexRequest could result in reponse failure...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Requests.indexRequest()
	.index(&lt;span class=&quot;code-quote&quot;&gt;&quot; :ind: ind : &quot;&lt;/span&gt;)
	.type(&lt;span class=&quot;code-quote&quot;&gt;&quot; :type: type : &quot;&lt;/span&gt;)
	.id(element)
	.source(&lt;span class=&quot;code-quote&quot;&gt;&quot;{data&amp;gt;\n&amp;lt;+++&amp;gt; :dw : dw : &quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;whatisyourname&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16765222" author="tzulitai" created="Mon, 11 Feb 2019 18:00:57 +0000"  >&lt;p&gt;Merged.&lt;/p&gt;

&lt;p&gt;1.8.0: 3aa92af9a68015f240c6dcc46313202e78ea5883&lt;br/&gt;
1.7.2: 2f522271abf03c5584612076b549c98d76a07f0f&lt;/p&gt;</comment>
                            <comment id="16945072" author="suxing lee" created="Sat, 5 Oct 2019 14:49:45 +0000"  >&lt;p&gt;Another situation that can lead to deadlock is the bug of es6.x itself. See &lt;a href=&quot;https://github.com/elastic/elasticsearch/issues/47599&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/elastic/elasticsearch/issues/47599&lt;/a&gt; for details.&lt;/p&gt;

&lt;p&gt;We&#160;can workaround the deadlock by changing the BackoffPolicy to noBackoff.&lt;/p&gt;

&lt;p&gt;So we&apos;d better set the elastic connection properties as follows in ElasticSearch6Connector.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
bulk.flush.backoff.enable: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 6 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s012uw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>