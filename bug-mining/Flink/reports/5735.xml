<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:00:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-23911] Projections not selecting any metadata columns cause all declared metadata columns to be applied to the source</title>
                <link>https://issues.apache.org/jira/browse/FLINK-23911</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;h1&gt;&lt;a name=&quot;NewDescription&quot;&gt;&lt;/a&gt;New Description&lt;/h1&gt;

&lt;p&gt;If a source implements SupportsReadingMetadata and SupportsProjectionPushDown, a table is created declaring some metadata columns and then queried with none of the metadata columns selected, #applyReadableMetadata will be called with all metadata keys declared in the schema. This causes unnecessary (and potentially expensive) calculations in the source.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;hr /&gt;
&lt;h1&gt;&lt;a name=&quot;OriginalDescription&quot;&gt;&lt;/a&gt;Original Description&lt;/h1&gt;

&lt;p&gt;Given a table with a declared schema containing some metadata columns, if we select only some of those metadata columns (or none), the interface of SupportsReadableMetadata states that the planner will perform the projection and only push required metadata keys into the source:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The planner will select required metadata columns (i.e. perform projection push down) and will call {@link #applyReadableMetadata(List, DataType)} with a list of metadata keys.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;However, it seems that this doesn&apos;t happen, and the planner always applies all metadata declared in the schema instead. This can be a problem because the source has to do unnecessary work, and some metadata might be more expensive to compute than others.&lt;/p&gt;

&lt;p&gt;For reference, SupportsProjectionPushDown can not be used to workaround this because it operates only on physical columns, i.e. #applyProjections will never be called with a projection for the metadata columns, even if they are selected.&lt;/p&gt;

&lt;p&gt;The following test case can be executed to debug into #applyReadableMetadata of the values table source:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
def test(): Unit = {
  val tableId = TestValuesTableFactory.registerData(Seq())

  tEnv.createTemporaryTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;T&quot;&lt;/span&gt;, TableDescriptor.forConnector(&lt;span class=&quot;code-quote&quot;&gt;&quot;values&quot;&lt;/span&gt;)
    .schema(Schema.newBuilder()
      .column(&lt;span class=&quot;code-quote&quot;&gt;&quot;f0&quot;&lt;/span&gt;, DataTypes.INT())
      .columnByMetadata(&lt;span class=&quot;code-quote&quot;&gt;&quot;m1&quot;&lt;/span&gt;, DataTypes.STRING())
      .columnByMetadata(&lt;span class=&quot;code-quote&quot;&gt;&quot;m2&quot;&lt;/span&gt;, DataTypes.STRING())
      .build())
    .option(&lt;span class=&quot;code-quote&quot;&gt;&quot;data-id&quot;&lt;/span&gt;, tableId)
    .option(&lt;span class=&quot;code-quote&quot;&gt;&quot;bounded&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
    .option(&lt;span class=&quot;code-quote&quot;&gt;&quot;readable-metadata&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;m1:STRING,m2:STRING&quot;&lt;/span&gt;)
    .build())

  tEnv.sqlQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT f0, m1 FROM T&quot;&lt;/span&gt;).execute().collect().toList
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13396609">FLINK-23911</key>
            <summary>Projections not selecting any metadata columns cause all declared metadata columns to be applied to the source</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="airblader">Ingo B&#252;rk</assignee>
                                    <reporter username="airblader">Ingo B&#252;rk</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 23 Aug 2021 06:37:27 +0000</created>
                <updated>Mon, 30 Aug 2021 06:50:35 +0000</updated>
                            <resolved>Wed, 25 Aug 2021 13:13:42 +0000</resolved>
                                    <version>1.13.2</version>
                                    <fixVersion>1.14.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17402982" author="lzljs3620320" created="Mon, 23 Aug 2021 06:50:13 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=airblader&quot; class=&quot;user-hover&quot; rel=&quot;airblader&quot;&gt;airblader&lt;/a&gt;&lt;br/&gt;
It seems that there are two bugs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;select all physical fields and partial meta columns, expect meta projection (applyReadableMetadata) but not.&lt;/li&gt;
	&lt;li&gt;select partial physical fields and empty meta columns, expect meta projection (applyReadableMetadata) but not.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17403000" author="airblader" created="Mon, 23 Aug 2021 07:30:46 +0000"  >&lt;p&gt;I debugged a little bit more. Actually only the second case you mentioned is a problem (when no metadata columns remain after the projection). If any metadata columns are selected, #applyReadableMetadata is called twice and the second time the projection has been considered correctly. However, if only physical columns are selected, then #applyReadableMetadata is only called once with all metadata keys.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;I am also quite surprised that #applyReadableMetadata is called multiple times on a source. Depending on the implementation this can cause unexpected behavior, so we should probably document that this method (and those of all other abilities?) must be idempotent.&lt;/del&gt; (Edit: it&apos;s called on different instances of the source)&lt;/p&gt;

&lt;p&gt;&lt;del&gt;Edit: It seems this might also differ between 1.13 and master? In my 1.13 project I couldn&apos;t reproduce the same behavior, but continuing to look into this&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;Edit 2: That was not correct, this just depends on SupportProjectionPushDown being implemented.&lt;/p&gt;</comment>
                            <comment id="17403004" author="airblader" created="Mon, 23 Aug 2021 07:40:46 +0000"  >&lt;p&gt;So there actually are two problems (again):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;If none of the metadata columns are selected, #applyReadableMetadata is called with&#160;&lt;em&gt;all&lt;/em&gt; metadata keys.&lt;/li&gt;
	&lt;li&gt;If the source does not implement SupportProjectionPushDown, #applyReadableMetadata is&#160;&lt;em&gt;always&lt;/em&gt; called with__&#160;&lt;em&gt;all&lt;/em&gt; metadata keys. Unless I&apos;m missing something, there should be no reason for this from the source perspective: projection push down is completely independent of projecting required metadata keys, right?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17403012" author="lzljs3620320" created="Mon, 23 Aug 2021 07:49:39 +0000"  >&lt;p&gt;I&apos;m not sure if we need to separate Metadata projection push down from SupportProjectionPushDown. If we want to, we may need to introduce an interface for this.&lt;/p&gt;

&lt;p&gt;The (physical/metadata) projection push down should an option. Because it may be a dangerous thing. Maybe we cannot start multiple instances of a same stream source. If the project causes the source to not be reused and multiple instances occur, this may lead to exceptions. For example Kafka consume group can not be reused by multiple instances.&lt;/p&gt;</comment>
                            <comment id="17403018" author="airblader" created="Mon, 23 Aug 2021 08:06:54 +0000"  >&lt;p&gt;I think a source which implements SupportsReadableMetadata but not SupportsProjectionPushDown should still receive only the metadata keys which are actually required, since SupportsProjectionPushDown operates only on the physical columns. I don&apos;t think I understand why a separate interface would be needed here, could you maybe elaborate a bit on that? Thanks!&lt;/p&gt;

&lt;p&gt;But if there&apos;s something I am missing (which is more than possible &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;) we should at least point this out in the documentation.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think the fix for the other case (no metadata columns selected) is pretty simple. We currently only apply the spec if any metadata columns have been selected, but we should just always apply it, even if the list is empty, right?&lt;/p&gt;</comment>
                            <comment id="17403021" author="airblader" created="Mon, 23 Aug 2021 08:13:20 +0000"  >&lt;p&gt;We should also still document the fact that #applyReadableMetadata (and other abilities, I assume) should be idempotent. The source is copied before the specs are applied, but an implementation like this looks totally fine based on the interface docs, but is actually broken (pseudo-code):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MySource &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; SupportsReadableMetadata, SupportsProjectionPushDown {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; metadataKeys = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; MySource copy() {
    MySource copy = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MySource();
    copy.metadataKeys.addAll(metadataKeys);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; copy;
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void applyReadableMetadata(List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; metadataKeys, DataType producedType) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.metadataKeys.addAll(metadataKeys);
  }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since the source is created and applyReadableMetadata is called with all metadata keys, copying it and then calling it with a subset of keys would only add duplicates.&lt;/p&gt;</comment>
                            <comment id="17403103" author="airblader" created="Mon, 23 Aug 2021 10:18:36 +0000"  >&lt;p&gt;I&apos;ve split this issue into the two cases since one is a bug and the other one an additional improvement that never worked before as far as I can tell.&lt;/p&gt;</comment>
                            <comment id="17403535" author="lzljs3620320" created="Tue, 24 Aug 2021 05:53:46 +0000"  >&lt;p&gt;&amp;gt; I don&apos;t think I understand why a separate interface would be needed here&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=airblader&quot; class=&quot;user-hover&quot; rel=&quot;airblader&quot;&gt;airblader&lt;/a&gt;, Implements SupportsReadableMetadata does not mean the connector want to support metadata column projection push down.&lt;br/&gt;
For example:&lt;br/&gt;
CREATE TABLE kafka (..., meta1, meta2, meta3) WITH (&apos;connector&apos; = &apos;kafka&apos;, &apos;group.id&apos; = &apos;a_id&apos;);&lt;br/&gt;
INSERT INTO sink_1 SELECT ..., meta1 FROM kafka;&lt;br/&gt;
INSERT INTO sink_2 SELECT ..., meta2 FROM kafka;&lt;br/&gt;
This job will failed because two kafka source instances use same group.id. Why not only one instance? Because their meta column projection are different.&lt;/p&gt;</comment>
                            <comment id="17403544" author="jark" created="Tue, 24 Aug 2021 06:21:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;, I think your use case is another orthogonal topic. It&apos;s too complex for users to use if we introduce an option to disable/enable metadata pushdown, because this problem also exists in other interfaces, e.g. filter/projection pushdown. If users don&apos;t want to reuse same group.id, then the user should declare different group.id in query using table hints. &lt;/p&gt;</comment>
                            <comment id="17403549" author="airblader" created="Tue, 24 Aug 2021 06:28:57 +0000"  >&lt;p&gt;What if we just added a method in SupportsReadingMetadata which returns a boolean of whether metadata should be projected (if the source doesn&apos;t implement projection pushdown), with a default implementation preserving current behavior?&lt;/p&gt;</comment>
                            <comment id="17403575" author="lzljs3620320" created="Tue, 24 Aug 2021 07:04:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; If we just modify this, it should be a behavior change. Then we should explain more...&lt;/p&gt;</comment>
                            <comment id="17403581" author="airblader" created="Tue, 24 Aug 2021 07:11:11 +0000"  >&lt;p&gt;Just to be clear: this issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23911&quot; title=&quot;Projections not selecting any metadata columns cause all declared metadata columns to be applied to the source&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23911&quot;&gt;&lt;del&gt;FLINK-23911&lt;/del&gt;&lt;/a&gt;) should be safe to fix. We&apos;re talking about how to address &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23917&quot; title=&quot;Project metadata columns to apply to sources which do not implement projection pushdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23917&quot;&gt;&lt;del&gt;FLINK-23917&lt;/del&gt;&lt;/a&gt; now.&lt;/p&gt;</comment>
                            <comment id="17403589" author="jark" created="Tue, 24 Aug 2021 07:15:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; I think this just fixing the wrong behavior. The Javadoc already explains &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
The planner will select required metadata columns (i.e. perform projection push down) and will
 * call {@link #applyReadableMetadata(List, DataType)} with a list of metadata keys. An
 * implementation must ensure that metadata columns are appended at the end of the physical row in
 * the order of the provided list after the apply method has been called.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17403598" author="lzljs3620320" created="Tue, 24 Aug 2021 07:22:15 +0000"  >&lt;p&gt;&amp;gt; a boolean of whether metadata should be projected&lt;br/&gt;
It should be a valid way.&lt;/p&gt;</comment>
                            <comment id="17403602" author="lzljs3620320" created="Tue, 24 Aug 2021 07:25:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; I&apos;m not sure whether the right behavior is reasonable.. Just for metadata column projection, user needs to declare a new group.id and modify their sql using table hints.  (I mean the sql user instead of connector developer)&lt;/p&gt;</comment>
                            <comment id="17404436" author="twalthr" created="Wed, 25 Aug 2021 13:13:42 +0000"  >&lt;p&gt;Fixed in 1.14.0:&lt;/p&gt;

&lt;p&gt;commit 97650c03ac93eeef81ff9f328578f5025fc5f4e3&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;table-planner&amp;#93;&lt;/span&gt; Apply metadata spec even if no metadata were used&lt;/p&gt;

&lt;p&gt;commit 27fcc4a1eca6313aa604dbc5cd72b88f14f38963&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;table-planner&amp;#93;&lt;/span&gt; Make SupportsReadingMetadata visible in the plan digests&lt;/p&gt;

&lt;p&gt;commit 50411b67fd5f240c84c1b0d236062dee5082f42a&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;table-common&amp;#93;&lt;/span&gt; Emphasize that #applyReadableMetadata must be idempotent&lt;/p&gt;

&lt;p&gt;We will not fix this for 1.13 because it causes plan changes.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13377350">FLINK-22600</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310761">
                    <name>Issue split</name>
                                            <outwardlinks description="split to">
                                        <issuelink>
            <issuekey id="13396653">FLINK-23917</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 11 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0u52w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>