<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:55:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21685] Flink JobManager failed to restart from checkpoint in kubernetes HA setup</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21685</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We use Flink K8S session cluster with HA mode (1 JobManager and 4 TaskManagers). When jobs are running in Flink, and JobManager restarted, Flink JobManager failed to recover job from checkpoint&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-03-08 13:16:42,962 INFO&#160; org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore [] - Trying to fetch 1 checkpoints from storage. 
2021-03-08 13:16:42,962 INFO&#160; org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore [] - Trying to fetch 1 checkpoints from storage. 
2021-03-08 13:16:42,962 INFO&#160; org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore [] - Trying to retrieve checkpoint 1. 
2021-03-08 13:16:43,014 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator&#160; &#160; [] - Restoring job 9a534b2e309b24f78866b65d94082ead from Checkpoint 1 @ 1615208258041 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 9a534b2e309b24f78866b65d94082ead located at s3a:&lt;span class=&quot;code-comment&quot;&gt;//zalando-stellar-flink-state-eu-central-1-staging/checkpoints/9a534b2e309b24f78866b65d94082ead/chk-1. 
&lt;/span&gt;2021-03-08 13:16:43,023 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator&#160; &#160; [] - No master state to restore 
2021-03-08 13:16:43,024 INFO&#160; org.apache.flink.runtime.jobmaster.JobMaster&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;[] - Using failover strategy org.apache.flink.runtime.executiongraph.failover.flip1.RestartPipelinedRegionFailoverStrategy@58d927d2 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; BrandCollectionTrackingJob (9a534b2e309b24f78866b65d94082ead). 
2021-03-08 13:16:43,046 INFO&#160; org.apache.flink.runtime.jobmaster.JobManagerRunnerImpl&#160; &#160; &#160; [] - JobManager runner &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job BrandCollectionTrackingJob (9a534b2e309b24f78866b65d94082ead) was granted leadership with session id c258d8ce-69d3-49df-8bee-1b748d5bbe74 at akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@10.2.179.12:6123/user/rpc/jobmanager_2. 
&lt;/span&gt;2021-03-08 13:16:43,060 WARN&#160; akka.remote.transport.netty.NettyTransport&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;[] - Remote connection to [&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;] failed with java.net.NoRouteToHostException: No route to host 
2021-03-08 13:16:43,060 WARN&#160; akka.remote.ReliableDeliverySupervisor&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;[] - Association with remote system [akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@10.2.174.188:6123] has failed, address is now gated &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [50] ms. Reason: [Association failed with [akka.tcp://flink@10.2.174.188:6123]] Caused by: [java.net.NoRouteToHostException: No route to host]&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Attached is the log, and our configuration.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13363190">FLINK-21685</key>
            <summary>Flink JobManager failed to restart from checkpoint in kubernetes HA setup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wangyang0918">Yang Wang</assignee>
                                    <reporter username="petrizhang">Peng Zhang</reporter>
                        <labels>
                            <label>k8s-ha</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 9 Mar 2021 07:22:01 +0000</created>
                <updated>Sat, 28 Aug 2021 11:13:07 +0000</updated>
                            <resolved>Thu, 1 Apr 2021 11:29:18 +0000</resolved>
                                    <version>1.12.1</version>
                    <version>1.12.2</version>
                                    <fixVersion>1.13.0</fixVersion>
                    <fixVersion>1.12.3</fixVersion>
                                    <component>Deployment / Kubernetes</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17297976" author="dailw" created="Tue, 9 Mar 2021 09:50:21 +0000"  >&lt;p&gt;You need&#160;create Job Manager RPC service on k8s,like :&lt;/p&gt;

&lt;p&gt;apiVersion: v1&lt;br/&gt;
kind: Service&lt;br/&gt;
metadata:&lt;br/&gt;
 name: flink-jm-rpc-service&lt;br/&gt;
spec:&lt;br/&gt;
 clusterIP: None&lt;br/&gt;
 selector:&lt;br/&gt;
 role: jobmanager&lt;br/&gt;
 ports:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protocol: TCP&lt;br/&gt;
 port: 6123&lt;br/&gt;
 targetPort: 6123&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17298040" author="fly_in_gis" created="Tue, 9 Mar 2021 12:22:56 +0000"  >&lt;p&gt;The internal Kubernetes service is&#160;unnecessary when HA enabled.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;From your attached logs, I find &quot;java.net.SocketTimeoutException: sent ping but didn&apos;t receive pong within&quot; many times. Could you please check whether the network connection between JobManager pod and Kubernetes APIServer is stable?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;By the way, I have verified the Kubernetes standalone session cluster with HA enabled in my minikube. When I kill the JobManager, a new one will be launched and take over the leadership. After it becomes the leader, it could recover all the jobs from latest checkpoint successfully. Actually,&#160;I could not reproduce your issues.&lt;/p&gt;</comment>
                            <comment id="17298595" author="petrizhang" created="Wed, 10 Mar 2021 07:37:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;&#160;we are running in a production K8S cluster, so it is unlikely that there is network issue between&#160;JobManager pod and Kubernetes APIServer. Would you be able to try in a K8S cluster (not in minikube since the K8S behaviour might be different)?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And when you said that you could reproduce the issue, could you explain more if there is an issue or how you work around it?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17298640" author="till.rohrmann" created="Wed, 10 Mar 2021 08:41:46 +0000"  >&lt;p&gt;Could you share a bit more details about the job and the exact setup you are running &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=petrizhang&quot; class=&quot;user-hover&quot; rel=&quot;petrizhang&quot;&gt;petrizhang&lt;/a&gt;? &lt;/p&gt;

&lt;p&gt;In the attached logs, I could see three JobManager instances. One instance only living from 12:05: to 13:01. It received a SIGTERM at 12:31 but only shut down 13:01. This is strange.&lt;/p&gt;

&lt;p&gt;At 12:42 a second instance is started which becomes the leader. A bit later at (12:54) we see the following snippet in the logs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1615207818477197056,Will wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; AWS credentials &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; up to 60 s.
1615207818921065984,Successfully obtained AWS credentials. Caller: arn:aws:sts::637664033771:assumed-role/stellar-flink-staging-iam-role/bf1a2c86-stellar-flink-staging-iam-role
1615207817604473088,&lt;span class=&quot;code-quote&quot;&gt;&quot;Shutting down, got signal: Terminated&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From this point onwards the second JobManager seems to be no longer working. Only at 13:15, the instance receives the SIGTERM signal to shut itself down.&lt;/p&gt;

&lt;p&gt;In the meantime a third JobManager is started 13:01. The third JobManager was granted the leadership but it never starts the job.&lt;/p&gt;

&lt;p&gt;I am suspecting that somewhere in &lt;a href=&quot;https://github.com/apache/flink/blob/release-1.12/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobManagerRunnerImpl.java#L337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/release-1.12/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobManagerRunnerImpl.java#L337&lt;/a&gt; it fails.&lt;/p&gt;

&lt;p&gt;Could you maybe run the deployment with DEBUG logs? This could help us further pinning down the problem.&lt;/p&gt;</comment>
                            <comment id="17298755" author="fly_in_gis" created="Wed, 10 Mar 2021 11:20:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=petrizhang&quot; class=&quot;user-hover&quot; rel=&quot;petrizhang&quot;&gt;petrizhang&lt;/a&gt;&#160;I am just saying that I could not reproduce this issue even on a real K8s cluster. Note that I am using the aliyun Kubernetes cluster and aliyun oss as the HA storage.&lt;/p&gt;</comment>
                            <comment id="17298757" author="fly_in_gis" created="Wed, 10 Mar 2021 11:26:56 +0000"  >&lt;p&gt;Could you please run the example job with HA enabled by using the following yamls? This is exactly what I tried to reproduce your issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;jobmanager.job&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
apiVersion: batch/v1
kind: Job
metadata:
  name: flink-jobmanager
spec:
  template:
    metadata:
      labels:
        app: flink
        component: jobmanager
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: artifacts-fetcher
          image: apache/flink:1.12.2
          imagePullPolicy: IfNotPresent
          # Use wget or other tools to get user jars from remote storage
          command: [ &lt;span class=&quot;code-quote&quot;&gt;&apos;cp&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;/opt/flink/examples/streaming/StateMachineExample.jar&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;/flink-artifact/myjob.jar&apos;&lt;/span&gt; ]
          volumeMounts:
            - mountPath: /flink-artifact
              name: flink-artifact
      containers:
        - name: jobmanager
          image: apache/flink:1.12.2
          imagePullPolicy: Always
          env:
          - name: ENABLE_BUILT_IN_PLUGINS
            value: flink-oss-fs-hadoop-1.12.2.jar
          - name: _POD_IP_ADDRESS
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
          args: [&lt;span class=&quot;code-quote&quot;&gt;&quot;standalone-job&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;--job-classname&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.flink.streaming.examples.statemachine.StateMachineExample&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;--host&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;$(_POD_IP_ADDRESS)&quot;&lt;/span&gt;]
          ports:
            - containerPort: 6123
              name: rpc
            - containerPort: 6124
              name: blob-server
            - containerPort: 8081
              name: webui
          livenessProbe:
            tcpSocket:
              port: 6123
            initialDelaySeconds: 30
            periodSeconds: 60
          volumeMounts:
            - name: flink-config-volume
              mountPath: /opt/flink/conf
            - mountPath: /opt/flink/usrlib
              name: flink-artifact
          securityContext:
            runAsUser: 9999  # refers to user _flink_ from official flink image, change &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; necessary
      volumes:
        - name: flink-artifact
          emptyDir: { }
        - name: flink-config-volume
          configMap:
            name: flink-config
            items:
              - key: flink-conf.yaml
                path: flink-conf.yaml
              - key: log4j-console.properties
                path: log4j-console.properties
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;taskmanager.yaml&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;apiVersion: apps/v1
kind: Deployment
metadata:
  name: flink-taskmanager
spec:
  replicas: 2
  selector:
    matchLabels:
      app: flink
      component: taskmanager
  template:
    metadata:
      labels:
        app: flink
        component: taskmanager
    spec:
      initContainers:
        - name: artifacts-fetcher
          image: apache/flink:1.12.2
          imagePullPolicy: IfNotPresent
          # Use wget or other tools to get user jars from remote storage
          command: [ &lt;span class=&quot;code-quote&quot;&gt;&apos;cp&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;/opt/flink/examples/streaming/StateMachineExample.jar&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;/flink-artifact/myjob.jar&apos;&lt;/span&gt; ]
          volumeMounts:
            - mountPath: /flink-artifact
              name: flink-artifact
      containers:
      - name: taskmanager
        image: apache/flink:1.12.2
        imagePullPolicy: Always
        env:
        - name: ENABLE_BUILT_IN_PLUGINS
          value: flink-oss-fs-hadoop-1.12.2.jar
        args: [&lt;span class=&quot;code-quote&quot;&gt;&quot;taskmanager&quot;&lt;/span&gt;]
        ports:
        - containerPort: 6122
          name: rpc
        - containerPort: 6125
          name: query-state
        livenessProbe:
          tcpSocket:
            port: 6122
          initialDelaySeconds: 30
          periodSeconds: 60
        volumeMounts:
        - name: flink-config-volume
          mountPath: /opt/flink/conf/
        - mountPath: /opt/flink/usrlib
          name: flink-artifact
        securityContext:
          runAsUser: 9999  # refers to user _flink_ from official flink image, change &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; necessary
      volumes:
      - name: flink-artifact
        emptyDir: { }
      - name: flink-config-volume
        configMap:
          name: flink-config
          items:
          - key: flink-conf.yaml
            path: flink-conf.yaml
          - key: log4j-console.properties
            path: log4j-console.properties
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;flink-configuration-configmap.yaml&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
apiVersion: v1
kind: ConfigMap
metadata:
  name: flink-config
  labels:
    app: flink
data:
  flink-conf.yaml: |+
    jobmanager.rpc.address: flink-jobmanager
    taskmanager.numberOfTaskSlots: 2
    blob.server.port: 6124
    jobmanager.rpc.port: 6123
    taskmanager.rpc.port: 6122
    queryable-state.proxy.ports: 6125
    jobmanager.memory.process.size: 1600m
    taskmanager.memory.process.size: 1728m
    parallelism.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;: 2
    kubernetes.cluster-id: standalone-k8s-ha-app1
    high-availability: org.apache.flink.kubernetes.highavailability.KubernetesHaServicesFactory
    high-availability.storageDir: oss:&lt;span class=&quot;code-comment&quot;&gt;//flink-debug-yiqi/flink-ha
&lt;/span&gt;    restart-strategy: fixed-delay
    restart-strategy.fixed-delay.attempts: 10
    fs.oss.endpoint: oss-cn-beijing.aliyuncs.com
    fs.oss.accessKeyId: xxxx
    fs.oss.accessKeySecret: yyyy
  log4j-console.properties: |+
    # This affects logging &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; both user code and Flink
    rootLogger.level = INFO
    rootLogger.appenderRef.console.ref = ConsoleAppender
    rootLogger.appenderRef.rolling.ref = RollingFileAppender    # Uncomment &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you want to _only_ change Flink&apos;s logging
    #logger.flink.name = org.apache.flink
    #logger.flink.level = INFO    # The following lines keep the log level of common libraries/connectors on
    # log level INFO. The root logger does not override &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;. You have to manually
    # change the log levels here.
    logger.akka.name = akka
    logger.akka.level = INFO
    logger.kafka.name= org.apache.kafka
    logger.kafka.level = INFO
    logger.hadoop.name = org.apache.hadoop
    logger.hadoop.level = INFO
    logger.zookeeper.name = org.apache.zookeeper
    logger.zookeeper.level = INFO    # Log all infos to the console
    appender.console.name = ConsoleAppender
    appender.console.type = CONSOLE
    appender.console.layout.type = PatternLayout
    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n    # Log all infos in the given rolling file
    appender.rolling.name = RollingFileAppender
    appender.rolling.type = RollingFile
    appender.rolling.append = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
    appender.rolling.fileName = ${sys:log.file}
    appender.rolling.filePattern = ${sys:log.file}.%i
    appender.rolling.layout.type = PatternLayout
    appender.rolling.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
    appender.rolling.policies.type = Policies
    appender.rolling.policies.size.type = SizeBasedTriggeringPolicy
    appender.rolling.policies.size.size=100MB
    appender.rolling.strategy.type = DefaultRolloverStrategy
    appender.rolling.strategy.max = 10    # Suppress the irrelevant (wrong) warnings from the Netty channel handler
    logger.netty.name = org.apache.flink.shaded.akka.org.jboss.netty.channel.DefaultChannelPipeline
    logger.netty.level = OFF    logger.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.name = org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint
    logger.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.level = ERROR
    logger.minirest.name = org.apache.flink.runtime.jobmaster.MiniDispatcherRestEndpoint
    logger.minirest.level = ERROR
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;jobmanager-rest-service.yaml&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
apiVersion: v1
kind: Service
metadata:
  name: flink-jobmanager-&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;
spec:
  type: LoadBalancer
  ports:
  - name: &lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;
    port: 8081
  selector:
    app: flink
    component: jobmanager
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17299440" author="petrizhang" created="Thu, 11 Mar 2021 09:40:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;We have a company wide K8S cluster, where we set up Flink cluster HA. We wanner to set up one Flink JobManager and 4 TaskManagers, and we run Flink in session cluster mode. And we submit jobs to Flink via Rest API. When no jobs are not running in Flink, restarting Flink JobManager can recover. However, when jobs are running in Flink, after I deleted Flink JobManager pod by using `kubectl delete pod &amp;lt;jobmanager-pod-id&amp;gt;`, a new JobManager pod is started, but then Flink cannot recover properly.&lt;/p&gt;

&lt;p&gt;I found that `stellar-flink-cluster-resourcemanager-leader` is not updated to use the IP address to the new JobManager pod. Then, TaskManagers cannot find the new JobManager. However, it is unclear why the cluster is not updated to use the new JobManager.&lt;/p&gt;

&lt;p&gt;I saw this issue &lt;a href=&quot;https://stackoverflow.com/questions/66219093/flink-fencing-errors-in-k8-ha-mode/66228073#66228073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/66219093/flink-fencing-errors-in-k8-ha-mode/66228073#66228073&lt;/a&gt;&#160;and tried to configure via `FLINK_PROPERTIES` while not using configmap for flink-config.yaml. But this does not help.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;&#160;I am trying your example, and will let you know the result. Meanwhile, your example starts Flink as `standalone-job` and our case just start Flink in standalone session mode. I wonder if this would matter, and would you be able to try to start Flink in standalone session mode and submit a job, and then delete the JobManager pod (which will restart a new JobManager), and see if there is an issue. Thanks!&lt;/p&gt;</comment>
                            <comment id="17299445" author="till.rohrmann" created="Thu, 11 Mar 2021 09:46:03 +0000"  >&lt;p&gt;I think your configuration also sets the pod&apos;s IP as &lt;tt&gt;jobmanager.rpc.address&lt;/tt&gt;. Hence, this should not be the problem. It might be a problem of the Kubernetes HA services not being able to update the new leader information. Do you have the possibility to run the deployment with DEBUG logs enabled?&lt;/p&gt;</comment>
                            <comment id="17299537" author="petrizhang" created="Thu, 11 Mar 2021 12:52:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;I uploaded the debug file&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;^scalyr-logs.txt.zip&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;At about 12:30, Flink starts Job Manager&lt;/p&gt;

&lt;p&gt;At about 12:38:30, I deleted the JobManager pod, then K8S started a new JobManager. Then, after a while, the error happened&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I also uploaded the role definition files&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;^01-role.yaml&amp;#93;&lt;/span&gt;&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;^02-role-binding.yaml&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17300825" author="petrizhang" created="Sat, 13 Mar 2021 12:31:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;&#160;Do you have any findings from the logs?&lt;/p&gt;

&lt;p&gt;From the debug log, I saw that the new JobManager pod was granted leadship&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2021-03-11 12:39:43,140 DEBUG org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService [] - Grant leadership to contender LeaderContender: DefaultDispatcherRunner with session ID 28ab74d0-83bf-44a4-afc3-691884ef0d98.	&lt;br/&gt;
2021-03-11 12:39:43,993 DEBUG org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService [] - Grant leadership to contender &lt;a href=&quot;http://10.2.19.254:8081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://10.2.19.254:8081&lt;/a&gt; with session ID 726e06fe-59a0-4985-a069-4f5334c76da1.	&lt;br/&gt;
2021-03-11 12:39:46,520 DEBUG org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService [] - Grant leadership to contender LeaderContender: JobManagerRunnerImpl with session ID 1afde9ba-6119-4c4d-8735-c3115e7ad8d6.	&lt;br/&gt;
2021-03-11 12:39:48,841 DEBUG org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService [] - Grant leadership to contender LeaderContender: StandaloneResourceManager with session ID 6de9cf53-9d5c-44a1-bc65-1b34e55a6b38.	&lt;br/&gt;
2021-03-11 12:39:49,322 DEBUG org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService [] - Grant leadership to contender LeaderContender: JobManagerRunnerImpl with session ID 41fe8896-d00a-4ff0-a866-e4fd9f7e023e.	&lt;br/&gt;
2021-03-11 12:39:54,182 DEBUG org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService [] - Grant leadership to contender LeaderContender: JobManagerRunnerImpl with session ID bee3d4f6-e857-46d0-9766-53fc47747413.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;but no logs on &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Successfully wrote leader information&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;so, something went wrong after the new JobManager was granted leadership and tried to confirm the leadership and update the leadership into configmap. What do you think? Thanks!&lt;/p&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17301360" author="fly_in_gis" created="Mon, 15 Mar 2021 03:30:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=petrizhang&quot; class=&quot;user-hover&quot; rel=&quot;petrizhang&quot;&gt;petrizhang&lt;/a&gt;&#160;I think your analysis is right. The new leader did not write the leader information to the ConfigMap successfully. This is the root cause why it could not recover the jobs from latest successful checkpoints.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It is really strange that JobManager could still receive the &quot;MODIFIED&quot; event for leader ConfigMap, which means the leader elector could update the annotation successfully. Maybe you could double check the annotation of leader ConfigMap for verification. However, we could not write the leader information to the content of ConfigMap. And we also do not have any exceptions(e.g. resource conflicts).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am curious which version of Kubernetes you are using? Is it a standard Kubernetes cluster or with some internal changes?&lt;/p&gt;

&lt;p&gt;I have tested in the minikube and a real K8s cluster with version 1.18. It just works well and I could not reproduce such issue.&lt;/p&gt;</comment>
                            <comment id="17301485" author="petrizhang" created="Mon, 15 Mar 2021 08:22:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt; We are using standard Kubernetes, and version is 1.19.8. Would you be able to try on this version in minikube?&lt;/p&gt;

&lt;p&gt;Server Version: version.Info{Major:&quot;1&quot;, Minor:&quot;19&quot;, GitVersion:&quot;v1.19.8&quot;, GitCommit:&quot;fd5d41537aee486160ad9b5356a9d82363273721&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2021-02-17T12:33:08Z&quot;, GoVersion:&quot;go1.15.8&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;}&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As you said, it is strange that&#160;JobManager could still receive the &quot;MODIFIED&quot; event for leader ConfigMap, which means the leader elector could update the annotation successfully. I checked the configmap and it seems it is kept being updated, but I do not know why. Do you have any idea how we could debug the issue?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17302213" author="fly_in_gis" created="Tue, 16 Mar 2021 04:50:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=petrizhang&quot; class=&quot;user-hover&quot; rel=&quot;petrizhang&quot;&gt;petrizhang&lt;/a&gt;&#160;After submitting more jobs in the session cluster, I could reproduce your issue. I think the root cause might be the io-executor pool size is not big enough. In my real K8s cluster, all the cpus(64 cores) are bound to pods. The io-executor pool size is 256(64 * 4). However, in the minikube, I just have one cpus and pool size is 4. Currently, we may have some blocking operations in the io-executor. This causes the &quot;confirmLeadership&quot; could not be done timely.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Could you please increase &lt;tt&gt;cluster.io-pool.size&lt;/tt&gt; to 32 or bigger and have a try again? Moreover, I will dive into more and try to find out what is blocking the io-executor.&lt;/p&gt;</comment>
                            <comment id="17302297" author="fly_in_gis" created="Tue, 16 Mar 2021 07:48:25 +0000"  >&lt;p&gt;I have attached a jstack of JobManager process. It reveals the root cause. All the cluster-io theads(only 4) are waiting for the result of completableFuture while the futures are also needed to be executed in the io-executor.&lt;/p&gt;

&lt;p&gt;I believe increase the size of &lt;tt&gt;cluster.io-pool.size&lt;/tt&gt; could help.&lt;/p&gt;</comment>
                            <comment id="17302342" author="petrizhang" created="Tue, 16 Mar 2021 08:57:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;&#160;I confirm that increasing&#160;cluster.io-pool.size solved the problem, and JobManager can recover. Thanks a lot!&lt;/p&gt;

&lt;p&gt;BTW, do you think Flink could be improved to handle this case (when cluster.io-pool.size is not big and the futures are blocked)? Anyway, I think it is fine for my case now.&lt;/p&gt;</comment>
                            <comment id="17302429" author="fly_in_gis" created="Tue, 16 Mar 2021 11:13:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=petrizhang&quot; class=&quot;user-hover&quot; rel=&quot;petrizhang&quot;&gt;petrizhang&lt;/a&gt;&#160;Yes, I think the current default value of &lt;tt&gt;cluster.io-pool.size&lt;/tt&gt; does not make sense when running in the containerized environment. Since the CPU cores may be just 1, and then the pool size(1 * 4) will be too small.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, do you think we could make the &lt;tt&gt;cluster.io-pool.size&lt;/tt&gt;&#160;always than 16? It is enough to run more than 10 jobs in a session cluster.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Math.max(16, 4 * the number of CPU cores)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17303618" author="till.rohrmann" created="Wed, 17 Mar 2021 17:48:58 +0000"  >&lt;p&gt;Thanks for the analysis &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=petrizhang&quot; class=&quot;user-hover&quot; rel=&quot;petrizhang&quot;&gt;petrizhang&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;. Do we know why we wait on &lt;tt&gt;CompletableFuture&lt;/tt&gt; in the io-executor? I think this does not sound right and we might wanna fix this.&lt;/p&gt;</comment>
                            <comment id="17303679" author="till.rohrmann" created="Wed, 17 Mar 2021 19:24:03 +0000"  >&lt;p&gt;I think the problem is that we use the same executor for &lt;tt&gt;KubernetesRunningJobsRegistry.writeJobStatusToConfigMap&lt;/tt&gt; and for the &lt;tt&gt;Fabric8FlinkKubeClient&lt;/tt&gt;. If we give the latter its own executor, it should all work.&lt;/p&gt;</comment>
                            <comment id="17303866" author="fly_in_gis" created="Thu, 18 Mar 2021 06:07:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; At the very beginning, we have dedicated thread pool for &lt;tt&gt;Fabric8FlinkKubeClient&lt;/tt&gt;. The default value is 4 and I think it is enough for almost cases. But we make Kubernetes Client in KubernetesResourceManagerDriver use io-executor in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19700&quot; title=&quot;Make Kubernetes Client in KubernetesResourceManagerDriver use io executor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19700&quot;&gt;&lt;del&gt;FLINK-19700&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;So are you suggesting to change back to use the dedicated thread pool for &lt;tt&gt;Fabric8FlinkKubeClient&lt;/tt&gt;? After then, I think we also need to introduce a new config option to configure the pool size.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Beyond this change, I still have the concern about how we calculate the default io-executor pool size based on hardware information. In containerize environment, it will cause the value too small.&lt;/p&gt;</comment>
                            <comment id="17303955" author="till.rohrmann" created="Thu, 18 Mar 2021 09:14:15 +0000"  >&lt;p&gt;Yes, I think we need to introduce a separate thread pool here. The problem is if we have two actions A, B and A waits on B but both actions use the same thread pool, then it is possible that multiple A actions deadlock the B actions.&lt;/p&gt;

&lt;p&gt;Theoretically, if we design everything correctly, then Flink should work with a single thread for each available thread pool. We should try to build Flink like this. Admittedly, this might not give us the best performance based on the available resources. Hence, I think it makes sense to make the thread pool size of the &lt;tt&gt;Fabric8FlinkKubeClient&lt;/tt&gt; configurable.&lt;/p&gt;

&lt;p&gt;How would you like to change the default size for these pools?&lt;/p&gt;</comment>
                            <comment id="17304002" author="fly_in_gis" created="Thu, 18 Mar 2021 09:55:08 +0000"  >&lt;p&gt;I think 2 is enough for the default pool size of the &lt;tt&gt;Fabric8FlinkKubeClient&lt;/tt&gt;. And I will have a test via starting a Flink application, which has more than 1000 TaskManager and enable the Kubernetes HA service.&lt;/p&gt;</comment>
                            <comment id="17306771" author="fly_in_gis" created="Tue, 23 Mar 2021 04:49:04 +0000"  >&lt;p&gt;I have tested in a real K8s cluster and having the following result.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If I configure the dedicated thread pool for Kubernetes client to 2, requesting all 1000 TaskManagers needs 24 seconds.&lt;/li&gt;
	&lt;li&gt;The requesting time will down to 11 seconds if we have 4 threads.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;So I will introduce a new config option for Kubernetes client thread pool with default value 4.&lt;/p&gt;</comment>
                            <comment id="17313096" author="till.rohrmann" created="Thu, 1 Apr 2021 11:29:19 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.13.0: ade268ec1bce2d784b9c1c70fb0fdcf6fae91498&lt;br/&gt;
1.12.3: 94f69ee2ac546f446478769a4944779d1096b3ef&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13366632">FLINK-21902</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13358897">FLINK-21382</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13022355" name="jstack.jm.1" size="184812" author="wangyang0918" created="Tue, 16 Mar 2021 07:44:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ofxc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>