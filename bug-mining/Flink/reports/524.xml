<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:20:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2540] LocalBufferPool.requestBuffer gets into infinite loop</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2540</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I&apos;m trying to run a complicated computation that looks like this: &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;br/&gt;
One of the DataSource-&amp;gt;Filter-&amp;gt;Map chains finishes fine, but the other one freezes. Debugging shows that it is spinning in the while loop in LocalBufferPool.requestBuffer.&lt;/p&gt;

&lt;p&gt;askToRecycle is false. Both numberOfRequestedMemorySegments and currentPoolSize is 128, so it never goes into that if either.&lt;/p&gt;

&lt;p&gt;This is a stack trace: &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;And here is the code, if you would like to run it: &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;. Unfortunately, I can&apos;t make it more minimal, becuase if I remove some operators, the problem disappears. The class to start is malom.Solver. (On first run, it calculates some lookuptables for a few minutes, and puts them into /tmp/movegen)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://compalg.inf.elte.hu/~ggevay/flink/plan.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://compalg.inf.elte.hu/~ggevay/flink/plan.txt&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://compalg.inf.elte.hu/~ggevay/flink/stacktrace.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://compalg.inf.elte.hu/~ggevay/flink/stacktrace.txt&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/ggevay/flink/tree/deadlock-malom&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ggevay/flink/tree/deadlock-malom&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12856871">FLINK-2540</key>
            <summary>LocalBufferPool.requestBuffer gets into infinite loop</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="uce">Ufuk Celebi</assignee>
                                    <reporter username="ggevay">G&#225;bor G&#233;vay</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Aug 2015 09:43:55 +0000</created>
                <updated>Sat, 6 Apr 2019 21:18:54 +0000</updated>
                            <resolved>Mon, 13 Aug 2018 08:00:07 +0000</resolved>
                                                    <fixVersion>0.9.1</fixVersion>
                    <fixVersion>0.10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14701179" author="stephanewen" created="Tue, 18 Aug 2015 12:28:32 +0000"  >&lt;p&gt;I put Ufuk as responsible for that (hop that&apos;s okay).&lt;/p&gt;

&lt;p&gt;He knows that code best...&lt;/p&gt;</comment>
                            <comment id="14701186" author="uce" created="Tue, 18 Aug 2015 12:34:58 +0000"  >&lt;p&gt;Yes, sure. I will fix it asap. Thanks for reporting this Gabor! It&apos;s very important to have it fixed for the upcoming 0.9.1 release.&lt;/p&gt;</comment>
                            <comment id="14703114" author="uce" created="Wed, 19 Aug 2015 14:40:43 +0000"  >&lt;p&gt;Debugging this. It is not a bug in the local buffer pool (from what I can tell so far). The stack trace shows that the call is a blocking request. That&apos;s why there is the infinite loop.&lt;/p&gt;

&lt;p&gt;The problem is that the buffers seem to not be consumed/recycled at some later point. I&apos;m trying to figure out where that happens now.&lt;/p&gt;</comment>
                            <comment id="14704151" author="githubbot" created="Thu, 20 Aug 2015 01:57:05 +0000"  >&lt;p&gt;GitHub user uce opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1036&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1036&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2540&quot; title=&quot;LocalBufferPool.requestBuffer gets into infinite loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2540&quot;&gt;&lt;del&gt;FLINK-2540&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;optimizer&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Propagate union batch exchanges to union inputs&lt;/p&gt;

&lt;p&gt;    The DataExchangeMode of union nodes was not respected when translating an OptimizedPlan to a JobGraph. This could result in deadlocks, when a branched data flow was closed.&lt;/p&gt;

&lt;p&gt;    Union nodes with a batch exchange will propagate their exchange mode to all inputs of their inputs when the JobGraph is generated.&lt;/p&gt;

&lt;p&gt;    This PR adds a test for this and propagates the data exchange mode of union nodes to their input in the JobGraphGenerator.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/uce/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/uce/flink&lt;/a&gt; union_exchange-2540&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1036.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1036.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1036&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit bac21bf5d77c8e15c608ecbf006d29e7af1dd68a&lt;br/&gt;
Author: Aljoscha Krettek &amp;lt;aljoscha.krettek@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-07-23T13:12:38Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2398&quot; title=&quot;Decouple StreamGraph Building from the API&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2398&quot;&gt;&lt;del&gt;FLINK-2398&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;api-breaking&amp;#93;&lt;/span&gt; Introduce StreamGraphGenerator&lt;/p&gt;

&lt;p&gt;    This decouples the building of the StreamGraph from the API methods.&lt;br/&gt;
    Before the methods would build the StreamGraph as they go. Now the API&lt;br/&gt;
    methods build a hierachy of StreamTransformation nodes. From these a&lt;br/&gt;
    StreamGraph is generated upon execution.&lt;/p&gt;

&lt;p&gt;    This also introduces some API breaking changes:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The result of methods that create sinks is now DataStreamSink instead&lt;br/&gt;
       of DataStream&lt;/li&gt;
	&lt;li&gt;Iterations cannot have feedback edges with differing parallelism&lt;/li&gt;
	&lt;li&gt;&quot;Preserve partitioning&quot; is not the default for feedback edges. The&lt;br/&gt;
       previous option for this is removed.&lt;/li&gt;
	&lt;li&gt;You can close an iteration several times, no need for a union.&lt;/li&gt;
	&lt;li&gt;Strict checking of whether partitioning and parallelism work&lt;br/&gt;
       together. I.e. if upstream and downstream parallelism don&apos;t match it&lt;br/&gt;
       is not legal to have Forward partitioning anymore. This was not very&lt;br/&gt;
       transparent: When you went from low parallelism to high dop some&lt;br/&gt;
       downstream  operators would never get any input. When you went from high&lt;br/&gt;
       parallelism to low dop you would get skew in the downstream operators&lt;br/&gt;
       because all elements that would be forwarded to an operator that is not&lt;br/&gt;
       &quot;there&quot; go to another operator. This requires insertion of global()&lt;br/&gt;
       or rebalance() in some places. For example with most sources which&lt;br/&gt;
       have parallelism one.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This also makes StreamExecutionEnvironment.execute() behave consistently&lt;br/&gt;
    across different execution environments (local, remote ...): The list of&lt;br/&gt;
    operators to be executed are cleared after execute is called.&lt;/p&gt;

&lt;p&gt;commit cbaccac630d579a9d7d7237aba5a40010e5c1814&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-08-19T22:38:37Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2540&quot; title=&quot;LocalBufferPool.requestBuffer gets into infinite loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2540&quot;&gt;&lt;del&gt;FLINK-2540&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;optimizer&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Propagate union batch exchanges to union inputs&lt;/p&gt;

&lt;p&gt;    The DataExchangeMode of union nodes was not respected when translating an OptimizedPlan&lt;br/&gt;
    to a JobGraph. This could result in deadlocks, when a branched data flow was closed.&lt;/p&gt;

&lt;p&gt;    Union nodes with a batch exchange will propagate their exchange mode to all inputs of&lt;br/&gt;
    their inputs when the JobGraph is generated.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14704569" author="githubbot" created="Thu, 20 Aug 2015 09:21:07 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1036#issuecomment-132948630&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1036#issuecomment-132948630&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Is it intended that this PR is based on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2398&quot; title=&quot;Decouple StreamGraph Building from the API&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2398&quot;&gt;&lt;del&gt;FLINK-2398&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14706405" author="githubbot" created="Fri, 21 Aug 2015 08:34:59 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1036#issuecomment-133331346&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1036#issuecomment-133331346&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Other then the branch mixup, this looks good.&lt;/p&gt;

&lt;p&gt;    Will test it and merge it, if it works...&lt;/p&gt;</comment>
                            <comment id="14706480" author="githubbot" created="Fri, 21 Aug 2015 09:51:03 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1036#issuecomment-133358126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1036#issuecomment-133358126&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Ah, the github mirror is out of sync again - that&apos;s why this pull request includes bac21bf5d77c8e15c608ecbf006d29e7af1dd68a again (which is in the apache master, but not in the github mirror).&lt;/p&gt;</comment>
                            <comment id="14706501" author="githubbot" created="Fri, 21 Aug 2015 10:09:30 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1036#issuecomment-133363161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1036#issuecomment-133363161&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging this, looks good, test works and catches the problematic condition!&lt;/p&gt;</comment>
                            <comment id="14706571" author="githubbot" created="Fri, 21 Aug 2015 11:36:04 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1036&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1036&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14706913" author="stephanewen" created="Fri, 21 Aug 2015 15:56:45 +0000"  >&lt;p&gt;Fixed&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;0.9.1 in a31f29480ace690ac59e3e29a8dd4832d078d2ab&lt;/li&gt;
	&lt;li&gt;0.10 in 58421b848ac9190db3b7c86b5ee4f8a9fc977d90&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16417023" author="renkaige" created="Wed, 28 Mar 2018 08:18:16 +0000"  >&lt;p&gt;It seems that this issue was not fixed at all.It is closed since some github/Jira sync bugs occured.&lt;/p&gt;

&lt;p&gt;I still get same problem in 1.3.2&lt;/p&gt;</comment>
                            <comment id="16417058" author="renkaige" created="Wed, 28 Mar 2018 09:01:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=uce&quot; class=&quot;user-hover&quot; rel=&quot;uce&quot;&gt;uce&lt;/a&gt; As far as I can see,there is no reason that the thread can jump out of the loop even though buffers be consumed by later opeartors.&lt;/p&gt;</comment>
                            <comment id="16811693" author="indraneelrr" created="Sat, 6 Apr 2019 21:18:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=uce&quot; class=&quot;user-hover&quot; rel=&quot;uce&quot;&gt;uce&lt;/a&gt; any updates on this? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=RenkaiGe&quot; class=&quot;user-hover&quot; rel=&quot;RenkaiGe&quot;&gt;RenkaiGe&lt;/a&gt; is right. This issue is not fixed and our flink job gets stuck waiting for `availableMemorySegments` to be non empty. This is in 1.7.2&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 32 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2j1of:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>