<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:52:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21274] At per-job mode, during the exit of the JobManager process, if ioExecutor exits at the end, the System.exit() method will not be executed.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21274</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3DLatestissuedescription%282021.02.07%29%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D&quot;&gt;&lt;/a&gt;=============Latest issue description(2021.02.07)==================&lt;/h2&gt;

&lt;p&gt;I want to try to describe the issue in a more concise way:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;My issue only appears in per-job mode,&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;In JsonResponseHistoryServerArchivist#archiveExecutionGraph, submit the archive task to ioExecutor for execution. At the same time, ClusterEntrypoint#stopClusterServices exits multiple thread pools in parallel (for example, commonRpcService, metricRegistry, MetricRegistryImpl#executor(in metricRegistry.shutdown())). Think about it, assuming that the archiving process takes 10 seconds to execute, then ExecutorUtils.nonBlockingShutdown will wait 10 before exiting. However, through testing, it was found that the JobManager process exited immediately after commonRpcService and metricRegistry exited. At this time, ExecutorUtils.nonBlockingShutdown is still waiting for the end of the archiving process, so the archiving process will not be completely executed.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;There are two specific reproduction methods:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Method one:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Modify the org.apache.flink.runtime.history.FsJobArchivist#archiveJob method to wait 5 seconds before actually writing to HDFS (simulating a slow write speed scenario).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Path archiveJob(Path rootPath, JobID jobId, Collection&amp;lt;ArchivedJson&amp;gt; jsonToArchive)
    &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        FileSystem fs = rootPath.getFileSystem();
        Path path = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(rootPath, jobId.toString());
        OutputStream out = fs.create(path, FileSystem.WriteMode.NO_OVERWRITE);

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===========================Wait 5 seconds..&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
            e.printStackTrace();
        }

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (JsonGenerator gen = jacksonFactory.createGenerator(out, JsonEncoding.UTF8)) {
            ...  &lt;span class=&quot;code-comment&quot;&gt;// Part of the code is omitted here
&lt;/span&gt;        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            fs.delete(path, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
        }
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Job {} has been archived at {}.&quot;&lt;/span&gt;, jobId, path);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; path;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
        LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to archive job.&quot;&lt;/span&gt;, e);
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The above modification will cause the archive to fail.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Method two:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;In ClusterEntrypoint#stopClusterServices, before ExecutorUtils.nonBlockingShutdown is called, submit a task that waits 10 seconds to ioExecutor.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ioExecutor.execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===ioExecutor before sleep&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(10000);
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===ioExecutor after sleep&quot;&lt;/span&gt;);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
            e.printStackTrace();
        }
    }
});
terminationFutures.add(ExecutorUtils.nonBlockingShutdown(shutdownTimeout, TimeUnit.MILLISECONDS, ioExecutor));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;According to the above modification, ===ioExecutor before sleep will be printed, but ===ioExecutor after sleep will not be printed.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;The root cause of the above issue is that all user threads (in Akka ActorSystem) have exited during the waiting, and finally the daemon thread (in ioExecutor) cannot be executed completely.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#de350b&quot;&gt;&#160;&lt;b&gt;If you already understand my issue, you can skip the following old version of the issue description, and browse the comment area directly&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3DOlderissuedescription%282021.02.04%29%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D&quot;&gt;&lt;/a&gt;================Older issue description(2021.02.04)================&lt;/h2&gt;

&lt;p&gt;This is a partial configuration of my Flink History service(flink-conf.yaml), and&#160;this is also the configuration of my Flink client.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
jobmanager.archive.fs.dir: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//hdfsHACluster/flink/completed-jobs/
&lt;/span&gt;historyserver.archive.fs.dir: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//hdfsHACluster/flink/completed-jobs/&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I used &lt;font color=&quot;#0747a6&quot;&gt;flink run -m yarn-cluster /cloud/service/flink/examples/batch/WordCount.jar&lt;/font&gt; to submit a WorkCount task to the Yarn cluster. Under normal circumstances, after the task is completed, the flink job execution information will be archived to HDFS, and then the JobManager process will exit. However, when this archiving process takes a long time (maybe the HDFS write speed is slow), the task archive file upload fails.&lt;/p&gt;

&lt;p&gt;The specific reproduction method is as follows:&lt;/p&gt;

&lt;p&gt;Modify the &lt;font color=&quot;#0747a6&quot;&gt;org.apache.flink.runtime.history.FsJobArchivist#archiveJob&lt;/font&gt;&#160;method to&#160;wait 5 seconds before actually writing to HDFS (simulating a slow write speed scenario).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Path archiveJob(Path rootPath, JobID jobId, Collection&amp;lt;ArchivedJson&amp;gt; jsonToArchive) 
    &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        FileSystem fs = rootPath.getFileSystem();
        Path path = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(rootPath, jobId.toString());
        OutputStream out = fs.create(path, FileSystem.WriteMode.NO_OVERWRITE);

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===========================Wait 5 seconds..&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
            e.printStackTrace();
        }

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (JsonGenerator gen = jacksonFactory.createGenerator(out, JsonEncoding.UTF8)) {
            ...  &lt;span class=&quot;code-comment&quot;&gt;// Part of the code is omitted here
&lt;/span&gt;        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            fs.delete(path, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
        }
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Job {} has been archived at {}.&quot;&lt;/span&gt;, jobId, path);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; path;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
        LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to archive job.&quot;&lt;/span&gt;, e);
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After I make the above changes to the code, I cannot find the corresponding task on Flink&apos;s HistoryServer(Refer to Figure 1.png and Figure 2.png).&lt;/p&gt;

&lt;p&gt;Then I went to Yarn to browse the JobManager log (see attachment application_1612404624605_0010-JobManager.log for log details), and&#160; &#160;did not found the following logs in the JobManager log file:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO entrypoint.ClusterEntrypoint: Terminating cluster entrypoint process YarnJobClusterEntrypoint with exit code 0.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Usually, if the task exits normally, a similar log will be printed before executing &lt;font color=&quot;#0747a6&quot;&gt;System.exit(returnCode)&lt;/font&gt;.&lt;/p&gt;

&lt;p&gt;If no Exception information is found in the JobManager log, the above situation occurs, indicating that the JobManager is running to a certain point, and there is no user thread in the JobManager process, which causes the program to exit without completing the normal process.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Eventually I found out that multiple services (e.g. ioExecutor, metricRegistry, commonRpcService) were exited asynchronously in &lt;font color=&quot;#0747a6&quot;&gt;org.apache.flink.runtime.entrypoint.ClusterEntrypoint#stopClusterServices&lt;/font&gt;, and multiple services would be exited in the shutdown() method of metricRegistry (e.g. executor), these exit actions are executed asynchronously and in parallel. If ioExecutor or executor exits after&#160;metricRegistry and commonRpcService , it will cause the above problems.&#160; Why is there no such problem with&#160;ioExecutor being exited brefore metricRegistry and commonRpcService? The&#160;key difference is that the threads in&#160;ioExecutor are daemon threads, while the threads in metricRegistry and commonRpcService are user threads.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I hope to modify the following code to fix this bug. If it is determined that this is a bug (this problem will affect all versions above 1.9), please assign the ticket to me, thank you.&lt;/p&gt;

&lt;p&gt;Only need to modify the &lt;font color=&quot;#0747a6&quot;&gt;org.apache.flink.runtime.entrypoint.ClusterEntrypoint#runClusterEntrypoint&lt;/font&gt;&#160;method:&lt;/p&gt;

&lt;p&gt;After fixing&#65306;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void runClusterEntrypoint(ClusterEntrypoint clusterEntrypoint) {

   &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; clusterEntrypointName = clusterEntrypoint.getClass().getSimpleName();
   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      clusterEntrypoint.startCluster();
   } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ClusterEntrypointException e) {
      LOG.error(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Could not start cluster entrypoint %s.&quot;&lt;/span&gt;, clusterEntrypointName), e);
      &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(STARTUP_FAILURE_RETURN_CODE);
   }

   &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; returnCode;
   Throwable throwable = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      returnCode = clusterEntrypoint.getTerminationFuture().get().processExitCode();
   } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
      throwable = e;
      returnCode = RUNTIME_FAILURE_RETURN_CODE;
   }

   LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Terminating cluster entrypoint process {} with exit code {}.&quot;&lt;/span&gt;, clusterEntrypointName, returnCode, throwable);
   &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(returnCode);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;Before fixing:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void runClusterEntrypoint(ClusterEntrypoint clusterEntrypoint) {

   &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; clusterEntrypointName = clusterEntrypoint.getClass().getSimpleName();
   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      clusterEntrypoint.startCluster();
   } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ClusterEntrypointException e) {
      LOG.error(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Could not start cluster entrypoint %s.&quot;&lt;/span&gt;, clusterEntrypointName), e);
      &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(STARTUP_FAILURE_RETURN_CODE);
   }

   clusterEntrypoint.getTerminationFuture().whenComplete((applicationStatus, throwable) -&amp;gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; returnCode;

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
         returnCode = RUNTIME_FAILURE_RETURN_CODE;
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
         returnCode = applicationStatus.processExitCode();
      }

      LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Terminating cluster entrypoint process {} with exit code {}.&quot;&lt;/span&gt;, clusterEntrypointName, returnCode, throwable);
      &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(returnCode);
   });
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The purpose of the modification is to ensure that the Main thread exits last.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13356675">FLINK-21274</key>
            <summary>At per-job mode, during the exit of the JobManager process, if ioExecutor exits at the end, the System.exit() method will not be executed.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wjc920">Jichao Wang</assignee>
                                    <reporter username="wjc920">Jichao Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 4 Feb 2021 06:58:38 +0000</created>
                <updated>Thu, 11 Feb 2021 18:33:59 +0000</updated>
                            <resolved>Thu, 11 Feb 2021 18:33:59 +0000</resolved>
                                    <version>1.9.3</version>
                    <version>1.10.1</version>
                    <version>1.11.0</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.11.4</fixVersion>
                    <fixVersion>1.12.2</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17279268" author="wjc920" created="Fri, 5 Feb 2021 01:58:19 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt; , could&#160;you help me confirm if this is a bug? thank you.&lt;/p&gt;</comment>
                            <comment id="17279381" author="fly_in_gis" created="Fri, 5 Feb 2021 06:22:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wjc920&quot; class=&quot;user-hover&quot; rel=&quot;wjc920&quot;&gt;wjc920&lt;/a&gt;&#160;I am afraid this ticket is related with&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21008&quot; title=&quot;Residual HA related Kubernetes ConfigMaps and ZooKeeper nodes when cluster entrypoint received SIGTERM in shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21008&quot;&gt;&lt;del&gt;FLINK-21008&lt;/del&gt;&lt;/a&gt;. The root cause of both them are that &lt;tt&gt;ClusterEntrypoint#shutDownAsync&lt;/tt&gt; is not fully executed. And then this leads to the residual HA related data or archiving failure for completed jobs.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, I cannot agree with your fix. Simply calling the &lt;tt&gt;getTerminationFuture().get()&lt;/tt&gt; will block the executing of &lt;tt&gt;runClusterEntrypoint&lt;/tt&gt;. This also could not completely resolve the issue if we receive the SIGTERM very fast. So I prefer the solution posted in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21008&quot; title=&quot;Residual HA related Kubernetes ConfigMaps and ZooKeeper nodes when cluster entrypoint received SIGTERM in shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21008&quot;&gt;&lt;del&gt;FLINK-21008&lt;/del&gt;&lt;/a&gt;,&#160;triggering a&#160;&lt;tt&gt;ClusterEntrypoint.closeAsync()&lt;/tt&gt;&#160;if we see a SIGTERM and then wait on the completion. WDYT?&lt;/p&gt;</comment>
                            <comment id="17279454" author="wjc920" created="Fri, 5 Feb 2021 08:23:36 +0000"  >&lt;p&gt;I want to try further explanation:&lt;/p&gt;

&lt;p&gt;I added some logs that print thread information to &lt;font color=&quot;#0747a6&quot;&gt;org.apache.flink.runtime.entrypoint.ClusterEntrypoint&lt;/font&gt; to get the status before the JobManager exits. The code is modified as follows:&lt;/p&gt;

&lt;p&gt;// code1&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void runClusterEntrypoint(ClusterEntrypoint clusterEntrypoint) {

		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; clusterEntrypointName = clusterEntrypoint.getClass().getSimpleName();
		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
			clusterEntrypoint.startCluster();
		} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ClusterEntrypointException e) {
			LOG.error(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Could not start cluster entrypoint %s.&quot;&lt;/span&gt;, clusterEntrypointName), e);
			&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(STARTUP_FAILURE_RETURN_CODE);
		}

		&lt;span class=&quot;code-comment&quot;&gt;// code1-1
&lt;/span&gt;		clusterEntrypoint.getTerminationFuture().whenComplete((applicationStatus, throwable) -&amp;gt; {
			&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; returnCode;

			LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;================clusterEntrypoint.getTerminationFuture isTerminal======================================&quot;&lt;/span&gt;);
			LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===Current thread name is: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName()
				+ &lt;span class=&quot;code-quote&quot;&gt;&quot;, isDaemon: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().isDaemon());
			printThreads();

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				returnCode = RUNTIME_FAILURE_RETURN_CODE;
			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
				returnCode = applicationStatus.processExitCode();
			}

			LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Terminating cluster entrypoint process {} with exit code {}.&quot;&lt;/span&gt;, clusterEntrypointName, returnCode, throwable);
			&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(returnCode);
		});
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;// code2&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void cleanupDirectories() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
		LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===================Starting cleanupDirectories================================&quot;&lt;/span&gt;);
		LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;cleanupDirectories===Current thread name is: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName()
			+ &lt;span class=&quot;code-quote&quot;&gt;&quot;, isDaemon: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().isDaemon());
		printThreads();
		ShutdownHookUtil.removeShutdownHook(shutDownHook, getClass().getSimpleName(), LOG);

		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; webTmpDir = configuration.getString(WebOptions.TMP_DIR);

		FileUtils.deleteDirectory(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(webTmpDir));
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;// code3&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; CompletableFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; stopClusterServices(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; cleanupHaData) {
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; shutdownTimeout = configuration.getLong(ClusterOptions.CLUSTER_SERVICES_SHUTDOWN_TIMEOUT);

		&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (lock) {
			Throwable exception = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

			&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Collection&amp;lt;CompletableFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;&amp;gt; terminationFutures = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;(3);

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (blobServer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
					blobServer.close();
				} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
					exception = ExceptionUtils.firstOrSuppressed(t, exception);
				}
			}

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (haServices != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
					&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cleanupHaData) {
						haServices.closeAndCleanupAllData();
					} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
						haServices.close();
					}
				} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
					exception = ExceptionUtils.firstOrSuppressed(t, exception);
				}
			}

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (archivedExecutionGraphStore != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
					archivedExecutionGraphStore.close();
				} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
					exception = ExceptionUtils.firstOrSuppressed(t, exception);
				}
			}

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (processMetricGroup != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				processMetricGroup.close();
			}

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (metricRegistry != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===metricRegistry is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
				CompletableFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; futureMetricRegistry = metricRegistry.shutdown();
				terminationFutures.add(futureMetricRegistry);
				futureMetricRegistry.whenComplete((aVoid, throwable) -&amp;gt; {
				    &lt;span class=&quot;code-comment&quot;&gt;// code3-1
&lt;/span&gt;					LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;========================metricRegistry shutdowns successfully===================================&quot;&lt;/span&gt;);
					LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;metricRegistry===Current thread name is: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName()
						+ &lt;span class=&quot;code-quote&quot;&gt;&quot;, isDaemon: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().isDaemon());
					printThreads();
				});
			}

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ioExecutor != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===ioExecutor is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
				CompletableFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; futureIoExecutor = ExecutorUtils.nonBlockingShutdown(shutdownTimeout,
					TimeUnit.MILLISECONDS, ioExecutor);
				terminationFutures.add(futureIoExecutor);
				futureIoExecutor.whenComplete((aVoid, throwable) -&amp;gt; {
				    &lt;span class=&quot;code-comment&quot;&gt;// code3-2
&lt;/span&gt;					LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;==============ioExecutor shutdowns successfully==========================&quot;&lt;/span&gt;);
					LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;ioExecutor===Current thread name is: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName()
						+ &lt;span class=&quot;code-quote&quot;&gt;&quot;, isDaemon: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().isDaemon());
					printThreads();
				});
			}

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (commonRpcService != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===commonRpcService is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
				CompletableFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; futureCommonRpcService = commonRpcService.stopService();
				terminationFutures.add(futureCommonRpcService);
				futureCommonRpcService.whenComplete((aVoid, throwable) -&amp;gt; {
				    &lt;span class=&quot;code-comment&quot;&gt;// code3-3
&lt;/span&gt;					LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;============================commonRpcService shutdowns successfully=====================================&quot;&lt;/span&gt;);
					LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;commonRpcService===Current thread name is: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName()
						+ &lt;span class=&quot;code-quote&quot;&gt;&quot;, isDaemon: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().isDaemon());
					printThreads();
				});

			}

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exception != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				terminationFutures.add(FutureUtils.completedExceptionally(exception));
			}

			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; FutureUtils.completeAll(terminationFutures);
		}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;// code4&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void printThreads() {
		&lt;span class=&quot;code-object&quot;&gt;ThreadGroup&lt;/span&gt; group = &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getThreadGroup();
		&lt;span class=&quot;code-object&quot;&gt;ThreadGroup&lt;/span&gt; topGroup = group;
		&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (group != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			topGroup = group;
			group = group.getParent();
		}
		&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; slackSize = topGroup.activeCount() * 2;
		&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[] slackThreads = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[slackSize];
		&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; actualSize = topGroup.enumerate(slackThreads);
		&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[] atualThreads = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[actualSize];
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.arraycopy(slackThreads, 0, atualThreads, 0, actualSize);
		LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===Threads size is &quot;&lt;/span&gt; + atualThreads.length);
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; thread : atualThreads) {
			LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; name : &quot;&lt;/span&gt; + thread.getName()+&lt;span class=&quot;code-quote&quot;&gt;&quot;, isDaemon: &quot;&lt;/span&gt; + thread.isDaemon());
		}

	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
 The attached log file description:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13020064/13020064_Add+wait+5+seconds+in+org.apache.flink.runtime.history.FsJobArchivist%23archiveJob.log&quot; title=&quot;Add wait 5 seconds in org.apache.flink.runtime.history.FsJobArchivist#archiveJob.log attached to FLINK-21274&quot;&gt;Add wait 5 seconds in org.apache.flink.runtime.history.FsJobArchivist#archiveJob.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;This log file corresponds to &lt;font color=&quot;#0747a6&quot;&gt;code6&lt;/font&gt;, and a 5-second wait logic is added to the &lt;font color=&quot;#0747a6&quot;&gt;org.apache.flink.runtime.history.FsJobArchivist#archiveJob&lt;/font&gt; method&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13020066/13020066_Not+add+wait+5+seconds.log&quot; title=&quot;Not add wait 5 seconds.log attached to FLINK-21274&quot;&gt;Not add wait 5 seconds.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;This log file corresponds to &lt;font color=&quot;#0747a6&quot;&gt;code6&lt;/font&gt;, delete the logic to wait for 5 seconds in the &lt;font color=&quot;#0747a6&quot;&gt;org.apache.flink.runtime.history.FsJobArchivist#archiveJob&lt;/font&gt; method&lt;/p&gt;

&lt;p&gt;// code5&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Path archiveJob(Path rootPath, JobID jobId, Collection&amp;lt;ArchivedJson&amp;gt; jsonToArchive) 
    &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        FileSystem fs = rootPath.getFileSystem();
        Path path = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(rootPath, jobId.toString());
        OutputStream out = fs.create(path, FileSystem.WriteMode.NO_OVERWRITE);

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;===========================Wait 5 seconds..&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
            e.printStackTrace();
        }

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (JsonGenerator gen = jacksonFactory.createGenerator(out, JsonEncoding.UTF8)) {
            ...  &lt;span class=&quot;code-comment&quot;&gt;// Part of the code is omitted here
&lt;/span&gt;        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            fs.delete(path, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
        }
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Job {} has been archived at {}.&quot;&lt;/span&gt;, jobId, path);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; path;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
        LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to archive job.&quot;&lt;/span&gt;, e);
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;// code6&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Path archiveJob(Path rootPath, JobID jobId, Collection&amp;lt;ArchivedJson&amp;gt; jsonToArchive) 
    &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        FileSystem fs = rootPath.getFileSystem();
        Path path = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(rootPath, jobId.toString());
        OutputStream out = fs.create(path, FileSystem.WriteMode.NO_OVERWRITE);
		
		&lt;span class=&quot;code-comment&quot;&gt;// Here, will not wait 5 seconds
&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (JsonGenerator gen = jacksonFactory.createGenerator(out, JsonEncoding.UTF8)) {
            ...  &lt;span class=&quot;code-comment&quot;&gt;// Part of the code is omitted here
&lt;/span&gt;        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            fs.delete(path, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
        }
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Job {} has been archived at {}.&quot;&lt;/span&gt;, jobId, path);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; path;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
        LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to archive job.&quot;&lt;/span&gt;, e);
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think that the thread information printed in &lt;font color=&quot;#0747a6&quot;&gt;code1-1&lt;/font&gt; and &lt;font color=&quot;#0747a6&quot;&gt;code2&lt;/font&gt; is the thread information before the JobManager process exits.&lt;/p&gt;

&lt;p&gt;If add a 5-second wait, &lt;font color=&quot;#0747a6&quot;&gt;code3-2&lt;/font&gt; and&lt;font color=&quot;#0747a6&quot;&gt; code1-1&lt;/font&gt; will not be executed, which means that ioExecutor fails to exit normally. And &lt;font color=&quot;#0747a6&quot;&gt;code2&lt;/font&gt; is executed by the YarnJobClusterEntrypoint shutdown hook.&#160;Why does this happen? I think we need to think about it carefully.&lt;/p&gt;

&lt;p&gt;If you delete the 5-second wait, we find that the program exits normally, and &lt;font color=&quot;#0747a6&quot;&gt;code1-1&lt;/font&gt; is executed by the &lt;font color=&quot;#0747a6&quot;&gt;flink-akka.actor.default-dispatcher-16&lt;/font&gt; thread. Corresponding to this, there is another situation. If metricRegistry exits after commonRpcService,&lt;font color=&quot;#0747a6&quot;&gt; code1-1&lt;/font&gt; will be executed by &lt;font color=&quot;#0747a6&quot;&gt;flink-metrics-scheduler-1&lt;/font&gt;.&lt;/p&gt;

&lt;p&gt;JobManager exits multiple thread pools in parallel before JobManager process exiting. Different thread pool exit orders result in different threads executing &lt;font color=&quot;#0747a6&quot;&gt;code1-1&lt;/font&gt;. If the thread pool is daemon pool (for example: ioExecutor) and finally exits, &lt;font color=&quot;#0747a6&quot;&gt;code1-1&lt;/font&gt; will not be executed. This is the root cause of the problem.&lt;/p&gt;

&lt;p&gt;If the &lt;font color=&quot;#0747a6&quot;&gt;org.apache.flink.runtime.util.ExecutorThreadFactory#newThread&lt;/font&gt; method corresponding to ioExecutor is modified from &lt;font color=&quot;#0747a6&quot;&gt;code7&lt;/font&gt; to &lt;font color=&quot;#0747a6&quot;&gt;code8&lt;/font&gt;, after doing so, even if we wait 10 seconds in &lt;font color=&quot;#0747a6&quot;&gt;code5&lt;/font&gt;, &lt;font color=&quot;#0747a6&quot;&gt;code1-1&lt;/font&gt; will be executed. At this time, the thread executing code1-1 will be &lt;font color=&quot;#0747a6&quot;&gt;ForkJoinPool.commonPool-worker-57&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;// code7&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; newThread(&lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; runnable) {
		&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; t = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(group, runnable, namePrefix + threadNumber.getAndIncrement());
		t.setDaemon(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

		t.setPriority(threadPriority);

		&lt;span class=&quot;code-comment&quot;&gt;// optional handler &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; uncaught exceptions
&lt;/span&gt;		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exceptionHandler != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			t.setUncaughtExceptionHandler(exceptionHandler);
		}

		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; t;
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;// code8&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; newThread(&lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; runnable) {
		&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; t = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(group, runnable, namePrefix + threadNumber.getAndIncrement());
		t.setDaemon(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);

		t.setPriority(threadPriority);

		&lt;span class=&quot;code-comment&quot;&gt;// optional handler &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; uncaught exceptions
&lt;/span&gt;		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exceptionHandler != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			t.setUncaughtExceptionHandler(exceptionHandler);
		}

		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; t;
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think &lt;font color=&quot;#0747a6&quot;&gt;code1-1&lt;/font&gt; needs to be executed by MainThread, otherwise if the daemon thread pool finally exits, &lt;font color=&quot;#0747a6&quot;&gt;code1-1&lt;/font&gt; will not be executed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt; What do you think?&lt;/p&gt;</comment>
                            <comment id="17279485" author="wjc920" created="Fri, 5 Feb 2021 09:06:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21008&quot; title=&quot;Residual HA related Kubernetes ConfigMaps and ZooKeeper nodes when cluster entrypoint received SIGTERM in shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21008&quot;&gt;&lt;del&gt;FLINK-21008&lt;/del&gt;&lt;/a&gt; is that while the JobManager is exiting, the external device sends a&#160;SIGTERM to the JobManager.&#160; May result in&#160;&lt;tt&gt;stopClusterServices&lt;/tt&gt;&#160;and&#160;&lt;tt&gt;cleanupDirectories&lt;/tt&gt;&#160;not being executed.&lt;/p&gt;

&lt;p&gt;But&#65292;&lt;/p&gt;

&lt;p&gt;According to the scene described in this ticket, I did not send any&#160;SIGTERM to the JobManager process, the task in ioExecutor (for example: archiving job info) cannot be completely executed during program exit.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;From this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CompletableFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; futureIoExecutor = ExecutorUtils.nonBlockingShutdown(shutdownTimeout,
 TimeUnit.MILLISECONDS, ioExecutor);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We can infer that if the task in ioExecutor is not completed temporarily, shutdown will wait for 30 seconds, but the result of my actual test is that shutdown did not wait 30 seconds, and ended immediately.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The scenario I gave in this ticket is that the FlinkJob is executed normally and no SIGTERM is received. At this time, if the archiving speed is too slow, the archiving will not be completed.&lt;/p&gt;</comment>
                            <comment id="17279627" author="wjc920" created="Fri, 5 Feb 2021 10:59:47 +0000"  >&lt;p&gt;We can also modify &lt;font color=&quot;#0747a6&quot;&gt;org.apache.flink.yarn.entrypoint.YarnJobClusterEntrypoint#main&lt;/font&gt;. Compared with the way I mentioned at the beginning, this way involves the modification of multiple main methods(e.g. &lt;font color=&quot;#0747a6&quot;&gt;org.apache.flink.yarn.entrypoint.YarnSessionClusterEntrypoint#main&lt;/font&gt;, &lt;font color=&quot;#0747a6&quot;&gt;org.apache.flink.mesos.entrypoint.MesosJobClusterEntrypoint&lt;/font&gt;#main, and so on...).&lt;/p&gt;

&lt;p&gt;org.apache.flink.yarn.entrypoint.YarnJobClusterEntrypoint#main&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
   &lt;span class=&quot;code-comment&quot;&gt;// startup checks and logging
&lt;/span&gt;   EnvironmentInformation.logEnvironmentInfo(LOG, YarnJobClusterEntrypoint.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getSimpleName(), args);
   SignalHandler.register(LOG);
   JvmShutdownSafeguard.installAsShutdownHook(LOG);

   Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; env = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getenv();

   &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; workingDirectory = env.get(ApplicationConstants.Environment.PWD.key());
   Preconditions.checkArgument(
      workingDirectory != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;Working directory variable (%s) not set&quot;&lt;/span&gt;,
      ApplicationConstants.Environment.PWD.key());

   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      YarnEntrypointUtils.logYarnEnvironmentInformation(env, LOG);
   } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Could not log YARN environment information.&quot;&lt;/span&gt;, e);
   }

   Configuration configuration = YarnEntrypointUtils.loadConfiguration(workingDirectory, env);

   YarnJobClusterEntrypoint yarnJobClusterEntrypoint = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; YarnJobClusterEntrypoint(
      configuration);

   ClusterEntrypoint.runClusterEntrypoint(yarnJobClusterEntrypoint);

   &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; returnCode;
   Throwable throwable = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      returnCode = yarnJobClusterEntrypoint.getTerminationFuture().get().processExitCode();
   } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
      throwable = e;
      returnCode = RUNTIME_FAILURE_RETURN_CODE;
   }

   LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Terminating cluster entrypoint process {} with exit code {}.&quot;&lt;/span&gt;,
      yarnJobClusterEntrypoint.getClass().getSimpleName(),
      returnCode, throwable);
   &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(returnCode);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;All my modifications are to make the main thread exit last.&#160;&lt;/p&gt;

&lt;p&gt;Is there a better way to solve this problem?&lt;/p&gt;</comment>
                            <comment id="17279638" author="wjc920" created="Fri, 5 Feb 2021 11:20:46 +0000"  >&lt;p&gt;I investigated the code of Kafka&apos;s Broker and Spark service. They also added blocking waiting in the main method. I think this is to ensure that the main thread finally exits.&#160;&lt;/p&gt;

&lt;p&gt;In fact, you can use tools to monitor the JobManager process. When the JobManager is running, the main thread no longer exists. This is an abnormal phenomenon.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;kafka.Kafka#main&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;  def main(args: Array[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]): Unit = {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      val serverProps = getPropsFromArgs(args)
      val kafkaServerStartable = KafkaServerStartable.fromProps(serverProps)

      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!OperatingSystem.IS_WINDOWS &amp;amp;&amp;amp; !Java.isIbmJdk)
          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LoggingSignalHandler().register()
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: ReflectiveOperationException =&amp;gt;
          warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to register optional signal handler that logs a message when the process is terminated &quot;&lt;/span&gt; +
            s&lt;span class=&quot;code-quote&quot;&gt;&quot;by a signal. Reason &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; registration failure is: $e&quot;&lt;/span&gt;, e)
      }

      &lt;span class=&quot;code-comment&quot;&gt;// attach shutdown handler to &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; terminating signals as well as normal termination
&lt;/span&gt;      &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().addShutdownHook(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka-shutdown-hook&quot;&lt;/span&gt;) {
        override def run(): Unit = kafkaServerStartable.shutdown()
      })

      kafkaServerStartable.startup()
      kafkaServerStartable.awaitShutdown()
    }
    &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: Throwable =&amp;gt;
        fatal(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exiting Kafka due to fatal exception&quot;&lt;/span&gt;, e)
        Exit.exit(1)
    }
    Exit.exit(0)
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;org.apache.spark.deploy.yarn.ApplicationMaster#main&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  def main(args: Array[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]): Unit = {
    SignalUtils.registerLogger(log)
    val amArgs = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ApplicationMasterArguments(args)
    master = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ApplicationMaster(amArgs)
    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(master.run())
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17280358" author="wjc920" created="Sun, 7 Feb 2021 02:44:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;&#160;I updated the issue description and issue title, please review my issue again. Thank you.&lt;/p&gt;</comment>
                            <comment id="17280365" author="fly_in_gis" created="Sun, 7 Feb 2021 03:44:27 +0000"  >&lt;p&gt;Sorry for late response. I will have a deep dive into this issue today.&lt;/p&gt;</comment>
                            <comment id="17280413" author="fly_in_gis" created="Sun, 7 Feb 2021 08:32:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wjc920&quot; class=&quot;user-hover&quot; rel=&quot;wjc920&quot;&gt;wjc920&lt;/a&gt;&#160;I think I get your point now. It is a different issue with&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21008&quot; title=&quot;Residual HA related Kubernetes ConfigMaps and ZooKeeper nodes when cluster entrypoint received SIGTERM in shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21008&quot;&gt;&lt;del&gt;FLINK-21008&lt;/del&gt;&lt;/a&gt;. However, both of them could lead to the tasks(e.g. archiving to HDFS, cleaning up HA data) in the io-executor are not completely executed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The root cause of this issue is that all the user threads have terminated in &lt;tt&gt;ClusterEntrypoint#shutDownAsync&lt;/tt&gt;. After then the io-executors will also terminate since they are daemon threads. As a result, the tasks which have been submitted to io-executors will not be completely executed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, do you have some ideas on why do we not keep the main thread in Flink?&#160;&lt;/p&gt;</comment>
                            <comment id="17280701" author="wjc920" created="Mon, 8 Feb 2021 00:36:46 +0000"  >&lt;p&gt;Thank you very much for reviewing this issue carefully, and I agree with you. I hope to fix this bug myself with your assistance. For me, this is a very meaningful thing.&lt;/p&gt;</comment>
                            <comment id="17280740" author="fly_in_gis" created="Mon, 8 Feb 2021 04:09:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wjc920&quot; class=&quot;user-hover&quot; rel=&quot;wjc920&quot;&gt;wjc920&lt;/a&gt;&#160;IIUC, the solution you are suggesting is to make the main thread blocking. After then it will be a long lived thread, as long as the life of JobManager process.&lt;/p&gt;

&lt;p&gt;Currently, I am not aware of any better solutions. Let&apos;s wait for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;whether he has some concerns to do this change since he is the author of the &lt;tt&gt;ClusterEntrypoint&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17280924" author="till.rohrmann" created="Mon, 8 Feb 2021 10:24:17 +0000"  >&lt;p&gt;Thanks for reporting and analysing this problem so thoroughly &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wjc920&quot; class=&quot;user-hover&quot; rel=&quot;wjc920&quot;&gt;wjc920&lt;/a&gt;. I think your findings are correct. The problem is that in some cases we don&apos;t have non-daemon thread remaining which causes the JVM to terminate before all tasks have been completed.&lt;/p&gt;

&lt;p&gt;I think your solution to change the &lt;tt&gt;ClusterEntrypoint.runClusterEntrypoint&lt;/tt&gt; to wait on the result of &lt;tt&gt;clusterEntrypoint.getTerminationFuture().get()&lt;/tt&gt; and do the &lt;tt&gt;System.exit&lt;/tt&gt; outside of the future callback looks like the best solution to me.&lt;/p&gt;</comment>
                            <comment id="17280925" author="till.rohrmann" created="Mon, 8 Feb 2021 10:25:01 +0000"  >&lt;p&gt;I&apos;ve assigned you to this ticket &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wjc920&quot; class=&quot;user-hover&quot; rel=&quot;wjc920&quot;&gt;wjc920&lt;/a&gt;. Happy coding!&lt;/p&gt;</comment>
                            <comment id="17283288" author="till.rohrmann" created="Thu, 11 Feb 2021 18:33:59 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.13.0:&lt;/p&gt;

&lt;p&gt;e6585365c931042a94408e0a58b0316b40a270e5&lt;br/&gt;
cf451aa73f050b69031366e1dda7bc0a3e0f9f81&lt;/p&gt;

&lt;p&gt;1.12.2:&lt;/p&gt;

&lt;p&gt;a7f898ab3f6bc887c590abf6e2c6eab9a89d1d12&lt;br/&gt;
a7f3b369229328ddc717776fca767ae4428df53a&lt;/p&gt;

&lt;p&gt;1.11.4:&lt;/p&gt;

&lt;p&gt;b4e3b498ec47deb383b83de87ac00b7707b26314&lt;br/&gt;
9946891bb3d6568ae29af6d8c23ccb39bfbfba22&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13019963" name="1.png" size="49498" author="wjc920" created="Thu, 4 Feb 2021 06:57:15 +0000"/>
                            <attachment id="13019964" name="2.png" size="31606" author="wjc920" created="Thu, 4 Feb 2021 06:57:11 +0000"/>
                            <attachment id="13020064" name="Add wait 5 seconds in org.apache.flink.runtime.history.FsJobArchivist#archiveJob.log" size="68569" author="wjc920" created="Fri, 5 Feb 2021 08:39:58 +0000"/>
                            <attachment id="13020066" name="Not add wait 5 seconds.log" size="75154" author="wjc920" created="Fri, 5 Feb 2021 08:41:56 +0000"/>
                            <attachment id="13019965" name="application_1612404624605_0010-JobManager.log" size="58537" author="wjc920" created="Thu, 4 Feb 2021 06:39:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 39 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0nceg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>