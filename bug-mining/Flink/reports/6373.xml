<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:10:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-26799] StateChangeFormat#read not seek to offset correctly</title>
                <link>https://issues.apache.org/jira/browse/FLINK-26799</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;StateChangeFormat#read must seek to offset before read, current implement as follows :&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
FSDataInputStream stream = handle.openInputStream();
DataInputViewStreamWrapper input = wrap(stream);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stream.getPos() != offset) {
    LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;seek from {} to {}&quot;&lt;/span&gt;, stream.getPos(), offset);
    input.skipBytesToRead((&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) offset);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But the if condition is incorrect, stream.getPos() return the position of underlying stream which is different from position of input.&lt;/p&gt;

&lt;p&gt;By the way, because of wrapped by BufferedInputStream, position of underlying stream always at n*bufferSize or the end of file.&#160;&lt;/p&gt;

&lt;p&gt;Actually, input is aways at position 0 at beginning, so I think we can seek to the offset directly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13435072">FLINK-26799</key>
            <summary>StateChangeFormat#read not seek to offset correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Feifan Wang">Feifan Wang</assignee>
                                    <reporter username="Feifan Wang">Feifan Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 22 Mar 2022 08:08:59 +0000</created>
                <updated>Mon, 28 Mar 2022 09:21:54 +0000</updated>
                            <resolved>Mon, 28 Mar 2022 09:18:21 +0000</resolved>
                                    <version>1.15.0</version>
                    <version>1.16.0</version>
                                    <fixVersion>1.15.0</fixVersion>
                    <fixVersion>1.16.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17510981" author="feifan wang" created="Wed, 23 Mar 2022 02:48:59 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; , can you help confirm that ?&lt;/p&gt;</comment>
                            <comment id="17511536" author="roman_khachatryan" created="Thu, 24 Mar 2022 01:04:36 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt; , thanks for looking into it,&lt;/p&gt;

&lt;p&gt;&amp;gt; But the if condition is incorrect, stream.getPos() return the position of underlying stream which is different from position of input.&lt;br/&gt;
Exactly, this is the underlying stream that needs to be positioned. Then &quot;offset&quot; bytes are skipped from the buffer. So I think this is correct.&lt;/p&gt;

&lt;p&gt;&amp;gt; Actually, input is aways at position 0 at beginning, so I think we can seek to the offset directly.&lt;/p&gt;

&lt;p&gt;Are you proposing to seek on the underlying stream &lt;b&gt;before wrapping&lt;/b&gt;?&lt;br/&gt;
I think that won&apos;t work, because the compression flag is written at the beginning.&lt;/p&gt;

&lt;p&gt;Alternatively, seeking on the underlying stream &lt;b&gt;after wrapping&lt;/b&gt; seem dangerous to me: there is no contract that no bytes are buffered by constructor AFAIK.&lt;/p&gt;</comment>
                            <comment id="17511550" author="feifan wang" created="Thu, 24 Mar 2022 02:20:03 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; , I&apos;m not mean seek on the underlying stream before wrapping. We should always seek on the wrapper stream as long as the offset not equal to 0. I think the code should be like below :&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (offset != 0) {
    LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;seek from {} to {}&quot;&lt;/span&gt;, stream.getPos(), offset);
    input.skipBytesToRead((&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) offset);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17511558" author="feifan wang" created="Thu, 24 Mar 2022 02:31:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; , here the problem is &lt;b&gt;`underlyingStream.getPos() == offset` not mean the wrapper stream is on correct position.&lt;/b&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17511681" author="roman_khachatryan" created="Thu, 24 Mar 2022 08:22:52 +0000"  >&lt;p&gt;Do you have a scenario where this issue arises? I&apos;ve played a bit with StateChangelogStorageTest.testWriteAndRead altering buffer size and adding offsets and it works as expected.&lt;/p&gt;

&lt;p&gt;OTH, the change you&apos;re proposing also seems correct so I wouldn&apos;t mind it.&lt;/p&gt;</comment>
                            <comment id="17511760" author="feifan wang" created="Thu, 24 Mar 2022 10:23:38 +0000"  >&lt;p&gt;Thanks very much for reply &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;StateChangelogStorageTest.testWriteAndRead is not enough to find the problem. But with a little modification, the problem can be found :&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;change the keyLen from 10 to &lt;font color=&quot;#de350b&quot;&gt;405&lt;/font&gt;&lt;/li&gt;
	&lt;li&gt;&lt;font color=&quot;#172b4d&quot;&gt;call writer.nextSequenceNumber()&lt;/font&gt; after dealt with every entry of appendsByKeyGroup&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Complete StateChangelogStorageTest.testWriteAndRead with above modification is :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@MethodSource(&lt;span class=&quot;code-quote&quot;&gt;&quot;parameters&quot;&lt;/span&gt;)
@ParameterizedTest(name = &lt;span class=&quot;code-quote&quot;&gt;&quot;compression = {0}&quot;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testWriteAndRead(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; compression) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    KeyGroupRange kgRange = KeyGroupRange.of(0, 5);
    Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt;&amp;gt; appendsByKeyGroup = generateAppends(kgRange, 405, 20);

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (StateChangelogStorage&amp;lt;T&amp;gt; client = getFactory(compression, temporaryFolder);
            StateChangelogWriter&amp;lt;T&amp;gt; writer =
                    client.createWriter(
                            &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OperatorID().toString(), kgRange, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SyncMailboxExecutor())) {
        SequenceNumber prev = writer.initialSequenceNumber();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt;&amp;gt; entry : appendsByKeyGroup.entrySet()) {
            &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; group = entry.getKey();
            List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; appends = entry.getValue();
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes : appends) {
                writer.append(group, bytes);
            }
            writer.nextSequenceNumber();
        }

        T handle = writer.persist(prev).get();
        StateChangelogHandleReader&amp;lt;T&amp;gt; reader = client.createReader();

        assertByteMapsEqual(appendsByKeyGroup, extract(handle, reader));
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You can run FsStateChangelogStorageTest after above modification for reproducing this problem.&lt;/p&gt;</comment>
                            <comment id="17511776" author="roman_khachatryan" created="Thu, 24 Mar 2022 10:52:52 +0000"  >&lt;p&gt;Thanks for the investigation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;Should the test fail with these changes? On my machine, it doesn&apos;t (both StateChangelogStorageTest and FsStateChangelogStorageTest).&lt;/p&gt;

&lt;p&gt;If it does fail in your environment, do you mind opening a PR with the test change and the fix?&lt;/p&gt;</comment>
                            <comment id="17511783" author="feifan wang" created="Thu, 24 Mar 2022 10:58:54 +0000"  >&lt;p&gt;FsStateChangelogStorageTest does fail with above changes on StateChangelogStorageTest.&lt;/p&gt;

&lt;p&gt;I&apos;am glad to prepare a pr to fix it and enhance the test.&lt;/p&gt;</comment>
                            <comment id="17511794" author="roman_khachatryan" created="Thu, 24 Mar 2022 11:14:02 +0000"  >&lt;p&gt;Thanks a lot!&lt;br/&gt;
I&apos;ve assigned the ticket to you.&lt;/p&gt;</comment>
                            <comment id="17511823" author="feifan wang" created="Thu, 24 Mar 2022 12:05:02 +0000"  >&lt;p&gt;It&apos;s my pleasure, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; .&lt;/p&gt;</comment>
                            <comment id="17513258" author="roman_khachatryan" created="Mon, 28 Mar 2022 09:18:21 +0000"  >&lt;p&gt;Merged into master as d5e472af4f817d343fae9073aad162ee13f08d6a&lt;/p&gt;

&lt;p&gt;into&#160;1.15 as 3fed74d757b.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13041525" name="image-2022-03-24-18-12-09-742.png" size="622835" author="Feifan Wang" created="Thu, 24 Mar 2022 10:12:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10p9c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>