<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20646] ReduceTransformation does not work with RocksDBStateBackend</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20646</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The intra-slot managed memory sharing (FLIP-141) requires transformations to properly declare their managed memory use cases.&lt;/p&gt;

&lt;p&gt;For RocksDB state backend, it requires all &lt;tt&gt;Transformation&lt;/tt&gt;-s on a keyed stream (with non-null&#160;&lt;tt&gt;KeySelector&lt;/tt&gt;) to call&#160;&lt;tt&gt;Transformation#updateManagedMemoryStateBackendUseCase&lt;/tt&gt;, which the newly introduced &lt;tt&gt;ReduceTransformation&lt;/tt&gt; did not.&lt;/p&gt;

&lt;p&gt;As a result, Flink will not reserve managed memory for operators converted from &lt;tt&gt;ReduceTransformation&lt;/tt&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19931&quot; title=&quot;Do not emit intermediate results for reduce operation BATCH execution mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19931&quot;&gt;&lt;del&gt;FLINK-19931&lt;/del&gt;&lt;/a&gt;), leading to the following failure when RocksDB state backend is used.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
16:58:49,373 WARN  org.apache.flink.streaming.api.operators.BackendRestorerProcedure [] - Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; restoring keyed state backend &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; StreamGroupedReduceOperator_c27dcf7b54ef6bfd6cff02ca8870b681_(1/1) from alternative (1/1), will retry &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; more alternatives are available.
java.io.IOException: Failed to acquire shared cache resource &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; RocksDB
	at org.apache.flink.contrib.streaming.state.RocksDBOperationUtils.allocateSharedCachesIfConfigured(RocksDBOperationUtils.java:264) ~[flink-statebackend-rocksdb_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.contrib.streaming.state.RocksDBStateBackend.createKeyedStateBackend(RocksDBStateBackend.java:535) ~[flink-statebackend-rocksdb_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.contrib.streaming.state.RocksDBStateBackend.createKeyedStateBackend(RocksDBStateBackend.java:94) ~[flink-statebackend-rocksdb_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.lambda$keyedStatedBackend$1(StreamTaskStateInitializerImpl.java:299) ~[flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.attemptCreateAndRestore(BackendRestorerProcedure.java:142) ~[flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:121) ~[flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.keyedStatedBackend(StreamTaskStateInitializerImpl.java:316) ~[flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:155) ~[flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:248) ~[flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.runtime.tasks.OperatorChain.initializeStateAndOpenOperators(OperatorChain.java:400) ~[flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$beforeInvoke$2(StreamTask.java:507) ~[flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.runThrowing(StreamTaskActionExecutor.java:47) [flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.beforeInvoke(StreamTask.java:501) [flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:531) [flink-streaming-java_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:722) [flink-runtime_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:547) [flink-runtime_2.11-1.12.0.jar:1.12.0]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:832) [?:?]
Caused by: java.lang.IllegalArgumentException: The fraction of memory to allocate should not be 0. Please make sure that all types of managed memory consumers contained in the job are configured with a non-negative weight via `taskmanager.memory.managed.consumer-weights`.
	at org.apache.flink.util.Preconditions.checkArgument(Preconditions.java:164) ~[flink-core-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.memory.MemoryManager.validateFraction(MemoryManager.java:631) ~[flink-runtime_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.memory.MemoryManager.computeMemorySize(MemoryManager.java:612) ~[flink-runtime_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.memory.MemoryManager.getSharedMemoryResourceForManagedMemory(MemoryManager.java:499) ~[flink-runtime_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.contrib.streaming.state.RocksDBOperationUtils.allocateSharedCachesIfConfigured(RocksDBOperationUtils.java:260) ~[flink-statebackend-rocksdb_2.11-1.12.0.jar:1.12.0]
	... 16 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is reported on the user-zh mailing list. (In Chinese though.)&lt;br/&gt;
&lt;a href=&quot;http://apache-flink.147419.n8.nabble.com/flink-1-12-RocksDBStateBackend-td9504.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink.147419.n8.nabble.com/flink-1-12-RocksDBStateBackend-td9504.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13346532">FLINK-20646</key>
            <summary>ReduceTransformation does not work with RocksDBStateBackend</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aljoscha">Aljoscha Krettek</assignee>
                                    <reporter username="xtsong">Xintong Song</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 17 Dec 2020 09:00:13 +0000</created>
                <updated>Wed, 13 Jan 2021 09:02:50 +0000</updated>
                            <resolved>Mon, 21 Dec 2020 08:29:58 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.12.1</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17250916" author="xintongsong" created="Thu, 17 Dec 2020 09:03:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;,&lt;br/&gt;
Could you inform how widely is &lt;tt&gt;ReduceTransformation&lt;/tt&gt; used? I&apos;m afraid we would need to have a quick bugfix release if it&apos;s very widely used.&lt;/p&gt;</comment>
                            <comment id="17250920" author="xintongsong" created="Thu, 17 Dec 2020 09:16:32 +0000"  >&lt;p&gt;I think this bug reveals two problems.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Absence of common abstraction for &quot;stateful transformations&quot;. Relying on various concrete transformation implementations to maintain the key selectors and declare the memory use case is fragile. New transformation implementations can easily overlook them, which is what&apos;s happening now.&lt;/li&gt;
	&lt;li&gt;Lack of testings. I&apos;m wondering how this problem escaped from our release testing. Reduce operation + RocksDB state backend should not be a that rare case. Obviously we don&apos;t have test coverage for such scenarios.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As for a quick fix, we can simply call &lt;tt&gt;updateManagedMemoryStateBackendUseCase&lt;/tt&gt; in &lt;tt&gt;ReduceTransformation&lt;/tt&gt;. I reviewed the type hierarchy of &lt;tt&gt;Transformation&lt;/tt&gt; and do not see other sub-classes with this problem. &lt;/p&gt;</comment>
                            <comment id="17250942" author="aljoscha" created="Thu, 17 Dec 2020 09:36:01 +0000"  >&lt;p&gt;A very quick fix for this is to just call&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
updateManagedMemoryStateBackendUseCase(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in &lt;tt&gt;ReduceTransformation&lt;/tt&gt;. I wouldn&apos;t add a test for it now and it seems we also don&apos;t have equivalent tests for other transformations.&lt;/p&gt;

&lt;p&gt;One thing I noticed is that there are some conflicts in how we assign the memory requirements. We allow operators/transformations to do it but we also hard-set some things for batch execution mode. This comes from the fact that the Blink-derived Table runner basically re-implements the newer BATCH-execution machinery we now have for general operators/transformations. In the long run, we should get rid of this complication.&lt;/p&gt;</comment>
                            <comment id="17250953" author="aljoscha" created="Thu, 17 Dec 2020 09:54:07 +0000"  >&lt;p&gt;I think the windowless &lt;tt&gt;reduce()&lt;/tt&gt; is not a common operation because it&apos;s not super useful in &lt;tt&gt;STREAMING&lt;/tt&gt; mode. You just get an infinite stream of updates.&lt;/p&gt;

&lt;p&gt;Do you know how they discovered the bug?&lt;/p&gt;</comment>
                            <comment id="17250962" author="xintongsong" created="Thu, 17 Dec 2020 10:01:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I think they are just playing with 1.12.0. The user posted his codes when running into this problem. It&apos;s just a word count.&lt;br/&gt;
&lt;a href=&quot;https://paste.ubuntu.com/p/9WrBz3Xrc6/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://paste.ubuntu.com/p/9WrBz3Xrc6/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Also, I&apos;m wondering does it make sense to you to have something like &lt;tt&gt;AbstractKeyedTransformation&lt;/tt&gt;? Not saying we should do it right now. We can do it after the quick fix. It should help improve the testability and prevent similar problems if we introduce new transformations later.&lt;/p&gt;</comment>
                            <comment id="17263993" author="xintongsong" created="Wed, 13 Jan 2021 09:02:50 +0000"  >&lt;p&gt;Fixed via:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master (1.13): cf71008984dd68b25db3612a9ca39f197b7e09c8&lt;/li&gt;
	&lt;li&gt;release-1.12: 4d1c9927f77b11f6990e447856fac6627a46bdcf&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0llns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>