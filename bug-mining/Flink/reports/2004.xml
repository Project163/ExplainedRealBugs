<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7737] On HCFS systems, FSDataOutputStream does not issue hsync only hflush which leads to data loss</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7737</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;During several tests where we simulated failure conditions, we have observed that on HCFS systems where the data stream is of type FSDataOutputStream, Flink will issue hflush() and not hsync() which results in data loss.&lt;/p&gt;

&lt;p&gt;In the class &lt;b&gt;StreamWriterBase.java&lt;/b&gt; the code below will execute hsync if the output stream is of type &lt;b&gt;HdfsDataOutputStream&lt;/b&gt; but not for streams of type &lt;b&gt;FSDataOutputStream&lt;/b&gt;.  Is this by design?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void hflushOrSync(FSDataOutputStream os) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;// At &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; point the refHflushOrSync cannot be &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// since register method would have thrown &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it was.
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.refHflushOrSync.invoke(os);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (os &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; HdfsDataOutputStream) {
				((HdfsDataOutputStream) os).hsync(EnumSet.of(HdfsDataOutputStream.SyncFlag.UPDATE_LENGTH));
			}
		} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InvocationTargetException e) {
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg = &lt;span class=&quot;code-quote&quot;&gt;&quot;Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to hflushOrSync!&quot;&lt;/span&gt;;
LOG.error(msg + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + e.getCause());
Throwable cause = e.getCause();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cause != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; cause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; IOException) {
&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; (IOException) cause;
			}
&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(msg, e);
		} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg = &lt;span class=&quot;code-quote&quot;&gt;&quot;Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to hflushOrSync!&quot;&lt;/span&gt;;
LOG.error(msg + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + e);
&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(msg, e);
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Could a potential fix me to perform a sync even on streams of type &lt;b&gt;FSDataOutputStream&lt;/b&gt;?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (os &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; HdfsDataOutputStream) {
                                ((HdfsDataOutputStream) os).hsync(EnumSet.of(HdfsDataOutputStream.SyncFlag.UPDATE_LENGTH));
                        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (os &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; FSDataOutputStream) {
                                os.hsync();
                        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Dev&lt;/p&gt;</environment>
        <key id="13105838">FLINK-7737</key>
            <summary>On HCFS systems, FSDataOutputStream does not issue hsync only hflush which leads to data loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="ryanehobbs">Ryan Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Sep 2017 19:10:54 +0000</created>
                <updated>Wed, 2 Oct 2019 17:43:23 +0000</updated>
                            <resolved>Tue, 24 Oct 2017 14:16:06 +0000</resolved>
                                    <version>1.3.2</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>Connectors / Common</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16189049" author="vijikarthi" created="Mon, 2 Oct 2017 23:31:03 +0000"  >&lt;p&gt;Some observation with respect to the usage of hflush vs hsync. When using HCFS implementation as backed filesystem, only hflush() is invoked since call to hsync() happens only when the FSDataOutputStream is instance of HdfsDataOutputStream. Due to this fact, we are seeing some data loss when the bucketing sink is holding data in pending state and trying to close the stream (as part of TM failover recovery).&lt;/p&gt;

&lt;p&gt;I do not see any issue in adding another condition to include hsync() call for HCFS types (FSDataOutputStream). &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt; Could you please take a look?&lt;/p&gt;

&lt;p&gt;hflush() - This API flushes all outstanding data (i.e. the current unfinished packet) from the client into the OS buffers on all DataNode replicas.&lt;/p&gt;

&lt;p&gt;hsync() - This API flushes the data to the DataNodes, like hflush(), but should also force the data to underlying physical storage via fsync (or equivalent).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/hadoop/blob/trunk/hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/blob/trunk/hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16198610" author="aljoscha" created="Tue, 10 Oct 2017 12:45:41 +0000"  >&lt;p&gt;I think the solution could be to simply always call &lt;tt&gt;hsync()&lt;/tt&gt;. The reflective invocation comes from a time when Flink supported both Hadoop 1 and Hadoop 2, so nowadays we could just call &lt;tt&gt;hsync()&lt;/tt&gt;. In fact, the reflective code was removed from master this week but it was replaced by &lt;tt&gt;hflush()&lt;/tt&gt; only.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="16198654" author="stephanewen" created="Tue, 10 Oct 2017 13:14:49 +0000"  >&lt;p&gt;Quick question to understand this correctly: If &lt;tt&gt;hflush()&lt;/tt&gt; flushes to data from the HDFS client to the DataNode, why does this still lead to data loss in case of a Flink TaskManager failover?&lt;/p&gt;</comment>
                            <comment id="16198722" author="stephanewen" created="Tue, 10 Oct 2017 14:06:44 +0000"  >&lt;p&gt;Or, let me rephrase the question: Is the data replicated to the required number of nodes after &lt;tt&gt;hflush()&lt;/tt&gt;, or only after &lt;tt&gt;hsync()&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;If that is the case, then would the best solution be to just always call &lt;tt&gt;hsync()&lt;/tt&gt; on checkpoints, rather than &lt;tt&gt;hflush()&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="16198898" author="vijikarthi" created="Tue, 10 Oct 2017 16:14:34 +0000"  >&lt;p&gt;I believe hflush() routes the data to DN but is lost since no sync happens to the disk (will let Ryan to confirm). &lt;/p&gt;

&lt;p&gt;I think we cannot generalize hsync() call since the `SyncFlag` is NameNode specific - &lt;a href=&quot;https://github.com/apache/hadoop/blob/trunk/hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java#L599&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/blob/trunk/hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java#L599&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16199070" author="ryanehobbs" created="Tue, 10 Oct 2017 17:50:39 +0000"  >&lt;p&gt;In the case of hflush() it is simply flushing the buffer but there is no guarantee that the data is sync&apos;d to disk so in the case of a failure scenario we have seen data loss when hflush() is used.  Is it possible for Flink to pass in SYNC_BLOCK flag on create(). If set I believe when hflush() is called it will perform hsync().  &lt;/p&gt;</comment>
                            <comment id="16199948" author="stephanewen" created="Wed, 11 Oct 2017 08:15:53 +0000"  >&lt;p&gt;I am still a bit confused - if &lt;tt&gt;hsync()&lt;/tt&gt; is really only about syncing to the DataNode&apos;s disks, then the only case where this should make a difference is when all 3 data nodes are lost and at least one is recovered from the disk data. For any Flink TaskManager failover, this should not make any difference.&lt;/p&gt;

&lt;p&gt;This blog article about HBase seems to confirm that &lt;tt&gt;hsync()&lt;/tt&gt; only matters to multi DataNode failures, where data needs to be recovered from disk.&lt;/p&gt;

&lt;p&gt;I can see that this is desirable to have as an option (should we pass that as a flag to the Bucketing sink?), so guarantee data on disk at checkpoint. If the flag is set, the Bucketing sink calls &lt;tt&gt;hsync()&lt;/tt&gt;, otherwise, it calls &lt;tt&gt;hflush()&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="16202700" author="ryanehobbs" created="Thu, 12 Oct 2017 22:05:54 +0000"  >&lt;p&gt;In our case we are using a hadoop compatible file system (HCFS) which is similar to how an S3FileSystem or AzureDataLike would behave. So in the traditional sense we do not have multiple data nodes; instead data is written to a node which is later on distributed.  It is for this reason we cannot guarantee that hflush will work.  I believe the flash SYNC_BLOCK on create() would be sufficient because it is my understanding that if that flag is set, a hflush() would trigger the hsync() upon close which would work in our case.&lt;/p&gt;</comment>
                            <comment id="16205136" author="stephanewen" created="Sun, 15 Oct 2017 14:32:45 +0000"  >&lt;p&gt;Okay, I think the root cause here is that &lt;tt&gt;hflush()&lt;/tt&gt; and &lt;tt&gt;hsync()&lt;/tt&gt; semantics are somewhat different across file systems.&lt;/p&gt;

&lt;p&gt;We cud solve this the following way:&lt;/p&gt;

&lt;p&gt;  1. Always &lt;tt&gt;hsync()&lt;/tt&gt; in the bucketing sink, but I feat that introduces a performance hit for other cases (like HDFS).&lt;/p&gt;

&lt;p&gt;  2. Always passing SYNC_BLOCK in create - will that have the same effect as (1) ?&lt;/p&gt;

&lt;p&gt;  3. Make it configurable in the for the user whether they need sync or only flush. But I fear most users will get that wrong.&lt;/p&gt;

&lt;p&gt;  4. Make the file systems obey a stricter definition of &lt;tt&gt;flush()&lt;/tt&gt;, meaning it needs to guarantee persistence for loss of a TaskManager. Then this is up to the file system implementer or the wrapper to forward these calls properly. BTW, it has just gotten a lot easier to plug in new file systems. A file system based on Hadoop can also be explicitly exposed to handle certain situations differently than the other file systems loaded through Hadoop&apos;s abstaction: &lt;a href=&quot;https://github.com/apache/flink/pull/4781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4781&lt;/a&gt; (already merged into master)&lt;/p&gt;

&lt;p&gt;I believe that this is an issue for more cases. For example, in order to guarantee recoverability of a task manager, the file system mounted under &lt;tt&gt;&lt;a href=&quot;file://&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file://&lt;/a&gt;&lt;/tt&gt; needs only &lt;tt&gt;flush()&lt;/tt&gt; if it is a local file system, but needs to &lt;tt&gt;sync()&lt;/tt&gt; if it is a mounted NFS style file system.&lt;/p&gt;</comment>
                            <comment id="16208634" author="vijikarthi" created="Wed, 18 Oct 2017 00:18:26 +0000"  >&lt;p&gt;I am trying to understand the changes that went it as part of the PR (&lt;a href=&quot;https://github.com/apache/flink/pull/4781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4781&lt;/a&gt;). I see few FileSystemFactory implementations (HDFS, MapR, S3Presto, S3Hadoop, LocalFS) that handles the concrete FS invocation (plus configuration/scheme). &lt;/p&gt;

&lt;p&gt;There is no hsync() API call during open() instead we call only hflush() with the assumption that data will be appropriately synced to the disk by the underlying implementation. Is my understanding right? &lt;/p&gt;

&lt;p&gt;If so, I am under the assumption that for stock HDFS, if the file system is created with SYNC_BLOCK flag option, then the blocks will be synced to the disk upon close() or else we need to invoke hsync() explicitly. With the current changes, if the TMs were to fail and recover, will the data on Hadoop DNs get synced to the disk?&lt;/p&gt;</comment>
                            <comment id="16211609" author="pnowojski" created="Thu, 19 Oct 2017 19:37:53 +0000"  >&lt;p&gt;I have started looking into this. Are you sure that setting &lt;tt&gt;SYNC_BLOCK&lt;/tt&gt; is good enough? According to what I was able to find, it only tells to sync the data on the last packet for given block and seems to have nothing to do with &lt;tt&gt;hflush()&lt;/tt&gt;. Unless I&apos;m missing the point that we start a new data block per each flush?&lt;/p&gt;

&lt;p&gt;Regardless of that, I think that we cannot always &lt;tt&gt;hsync()&lt;/tt&gt; the data because of performance reasons (different semantics on different systems), so I would lean toward the 4. option proposed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;. However the abstraction with &lt;tt&gt;FileSystemFactory&lt;/tt&gt; is a little bit confusing to me, because it works/allows to plugin &lt;tt&gt;FileSystem&lt;/tt&gt; defined in &lt;tt&gt;flink-core&lt;/tt&gt; module, but &lt;tt&gt;BucketingSink&lt;/tt&gt; and &lt;tt&gt;StreamWriterBase&lt;/tt&gt; are using &lt;tt&gt;FileSystem&lt;/tt&gt; and &lt;tt&gt;FSDataOutputStream&lt;/tt&gt; defined in &lt;tt&gt;hadoop-commons&lt;/tt&gt;, which confuses me... &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ryanehobbs&quot; class=&quot;user-hover&quot; rel=&quot;ryanehobbs&quot;&gt;ryanehobbs&lt;/a&gt; am I missing something, or is this PR &lt;a href=&quot;https://github.com/apache/flink/pull/4781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4781&lt;/a&gt; kind of irrelevant to this issue?&lt;/p&gt;</comment>
                            <comment id="16211807" author="ryanehobbs" created="Thu, 19 Oct 2017 21:54:22 +0000"  >&lt;p&gt;I believe the SYNC_BLOCK flag is sufficient.  My understanding (I could be incorrect) is that if the flag `SYNC_BLOCK` is passed in during create, then upon &lt;em&gt;hflush()&lt;/em&gt; if that flag was used during create it will perform &lt;em&gt;hsync()&lt;/em&gt;.  I believe &lt;a href=&quot;https://github.com/apache/flink/pull/4781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4781&lt;/a&gt; may be an alternate solution to #2 cited above by Stephen.  We are in the process of looking into that now.&lt;/p&gt;</comment>
                            <comment id="16212293" author="pnowojski" created="Fri, 20 Oct 2017 07:42:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ryanehobbs&quot; class=&quot;user-hover&quot; rel=&quot;ryanehobbs&quot;&gt;ryanehobbs&lt;/a&gt; could you give a source where did you find that &lt;tt&gt;SYNC_BLOCK&lt;/tt&gt; behaves as you described? Against it I have found those:&lt;br/&gt;
&lt;a href=&quot;http://www.hypertable.com/documentation/administrator_guide/hdfs_and_durability&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.hypertable.com/documentation/administrator_guide/hdfs_and_durability&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://hadoop.apache.org/docs/r2.7.3/api/org/apache/hadoop/fs/CreateFlag.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hadoop.apache.org/docs/r2.7.3/api/org/apache/hadoop/fs/CreateFlag.html&lt;/a&gt;&lt;br/&gt;
and the discussion in original issue:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-744&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HDFS-744&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16212534" author="pnowojski" created="Fri, 20 Oct 2017 12:10:59 +0000"  >&lt;p&gt;After discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; I confirmed that this PR &lt;a href=&quot;https://github.com/apache/flink/pull/4781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4781&lt;/a&gt; that allows to add custom &lt;tt&gt;FileSystem&lt;/tt&gt; is irrelevant at the moment to this issue, because BucketingSink is not using flink&apos;s abstraction. We decided that I will add a simple boolean flag to the &lt;tt&gt;StreamWriterBase&lt;/tt&gt; that will allow user to choose between &lt;tt&gt;hsync&lt;/tt&gt; and &lt;tt&gt;hflush&lt;/tt&gt; on flushing. This will be a stop-gap solution until &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5789&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-5789&lt;/a&gt; is resolved.&lt;/p&gt;</comment>
                            <comment id="16212811" author="githubbot" created="Fri, 20 Oct 2017 15:50:09 +0000"  >&lt;p&gt;GitHub user pnowojski opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4876&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7737&quot; title=&quot;On HCFS systems, FSDataOutputStream does not issue hsync only hflush which leads to data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7737&quot;&gt;&lt;del&gt;FLINK-7737&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;filesystem&amp;#93;&lt;/span&gt; Add syncOnFlush flag to StreamWriterBase&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    It depends whether to call hsync or hflush on the underlying file system and user preferences. Normally hflush is enough to protect against single machine HDFS failures and against TaskManagers failures. However if user is using S3 like file system, or wants to protect against whole HDFS rack power loss hsync must be used instead.&lt;/p&gt;

&lt;p&gt;    This is a stop gap solution until proper fix waiting for &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5789&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-5789&lt;/a&gt;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change is hard to test &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; One could think about writing a unit test using mocks, but that would only copy the implementation.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (*&lt;b&gt;yes&lt;/b&gt;* / no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable / docs / *&lt;b&gt;JavaDocs&lt;/b&gt;* / not documented)&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/pnowojski/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pnowojski/flink&lt;/a&gt; f7737&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4876.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4876.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4876&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 8d1c34197d1098cbd5a56ec882da17f42410c1f4&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-10-20T14:47:52Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7737&quot; title=&quot;On HCFS systems, FSDataOutputStream does not issue hsync only hflush which leads to data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7737&quot;&gt;&lt;del&gt;FLINK-7737&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;filesystem&amp;#93;&lt;/span&gt; Add syncOnFlush flag to StreamWriterBase&lt;/p&gt;

&lt;p&gt;    It depends whether to call hsync or hflush on the underlying file system&lt;br/&gt;
    and user preferences. Normally hflush is enough to protect against single&lt;br/&gt;
    machine HDFS failures and against TaskManagers failures. However if user is&lt;br/&gt;
    using S3 like file system, or wants to protect againt whole HDFS rack power&lt;br/&gt;
    loss hsync must be used instead.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16212816" author="ryanehobbs" created="Fri, 20 Oct 2017 15:53:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; will the flag be issue on create() or when the the close() operation is executed?  &lt;/p&gt;</comment>
                            <comment id="16212857" author="pnowojski" created="Fri, 20 Oct 2017 16:39:43 +0000"  >&lt;p&gt;&lt;tt&gt;StreamWriterBase#close&lt;/tt&gt; issues a &lt;tt&gt;flush()&lt;/tt&gt; call, so &lt;tt&gt;syncOnFlush&lt;/tt&gt; flag will be honoured also when closing. What &quot;create()&quot; do you have in mind?&lt;/p&gt;</comment>
                            <comment id="16213008" author="vijikarthi" created="Fri, 20 Oct 2017 18:28:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Thanks for the fix. It addresses the FS sink operation when any of the writer implementation is used (AvroKVSinkWriter, SequenceFileWriter, StringWriter). However, the BucketingSink is calling flush() when snapshot is being taken (see snapshotState()) which causes sync() to happen frequently. Essentially we need to call the sync() only while closing the current part file. Instead of calling sync() during flush(), having a separate API call to handle sync() might help.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ryanehobbs&quot; class=&quot;user-hover&quot; rel=&quot;ryanehobbs&quot;&gt;ryanehobbs&lt;/a&gt; create() is not modified since SYNC_BLOCK flag is not used. This fix addresses the writer implementation directly and hence upon writer close, sync() will be invoked when the flag is set (as part of the flush() API call).  &lt;/p&gt;</comment>
                            <comment id="16213174" author="pnowojski" created="Fri, 20 Oct 2017 20:22:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vijikarthi&quot; class=&quot;user-hover&quot; rel=&quot;vijikarthi&quot;&gt;vijikarthi&lt;/a&gt; am I missing something? If there is no file system failure, there should be no difference between hsync and hflush. If there is some file system failure, not calling hsync during snapshot may cause data loses. I thought that this is whole point of this issue.&lt;/p&gt;

&lt;p&gt;Imagine that just after operators completed snapshot, there is a complete power loss on every machine, both in the Flink cluster and file system cluster. If this snapshot was marked as completed 0.1ms before failure, after restart it will be chosen for recovery. In that case, if &lt;tt&gt;hsync&lt;/tt&gt; was not called on &lt;tt&gt;snapshotState()&lt;/tt&gt;, we would have a data loss.&lt;/p&gt;</comment>
                            <comment id="16216878" author="githubbot" created="Tue, 24 Oct 2017 13:13:27 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4876&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Excellent changes, I&apos;ll merge along with a bunch of other stuff. &#128077; &lt;/p&gt;</comment>
                            <comment id="16216965" author="githubbot" created="Tue, 24 Oct 2017 14:14:59 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4876&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I merged this, could you please close the PR?&lt;/p&gt;</comment>
                            <comment id="16216969" author="aljoscha" created="Tue, 24 Oct 2017 14:16:06 +0000"  >&lt;p&gt;Fixed by adding a configuration setting to &lt;tt&gt;StreamWriterBase&lt;/tt&gt; in 4a6a94dfbe59954a981dbf3e6917f625060372e6&lt;/p&gt;</comment>
                            <comment id="16216993" author="githubbot" created="Tue, 24 Oct 2017 14:27:14 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4876&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks! &lt;/p&gt;</comment>
                            <comment id="16216994" author="githubbot" created="Tue, 24 Oct 2017 14:27:15 +0000"  >&lt;p&gt;Github user pnowojski closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4876&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16220629" author="githubbot" created="Thu, 26 Oct 2017 15:33:17 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4876&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    A quick post-mortem comment here:&lt;/p&gt;

&lt;p&gt;    This adds a lot of `equals()` and `hashCode()` on classes where these are ill-defined.&lt;/p&gt;

&lt;p&gt;    For example: `StreamWriterBase` defines `equals()` and `hashCode()` just on a subset of configuration fields (here the sync field) and ignore the associated stream, because equals and hash is ill-defined on the stream. To me, the correct conclusion is that `equals()` and `hashCode()` are ill-defined on `StreamWriterBase` and should not be there!&lt;/p&gt;

&lt;p&gt;    Adding such methods just to make assertion statement in tests more compact wrongly pushes some specific test logic in to the main classes. The correct way is to adjust the assertions in the test, or, if there is a lot of repetitive checking, create a `Matcher` that matches &quot;equality based on some fields&quot; and replace `assertEquals(X, Y)` with `assertThat(matcher, X, Y)`.&lt;/p&gt;

&lt;p&gt;    I think in this case, it is actually a reason for a follow-up patch that changes this.&lt;/p&gt;</comment>
                            <comment id="16221844" author="githubbot" created="Fri, 27 Oct 2017 07:15:06 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4876&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I assumed that it is up to concrete implementations of `StreamWriterBase` to implement `equals` completely, for example based on `configuration`. Alternatively including `outStream` in equality/hash implementation is also a solution, with slightly different semantic.&lt;/p&gt;</comment>
                            <comment id="16222209" author="githubbot" created="Fri, 27 Oct 2017 11:48:54 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4876&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    But do you understand what I mean? Semantics of code in the main scope should not be quirked to make assertions in tests shorter to write.&lt;/p&gt;

&lt;p&gt;    Equals/hashCode is usually not implemented on I/O classes, like the output stream, because it is not well defined.&lt;/p&gt;</comment>
                            <comment id="16222429" author="githubbot" created="Fri, 27 Oct 2017 14:07:16 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4876&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yes I know what you mean. However including `outStream` to `hashCode` and `equals` wouldn&apos;t add any quirks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kogn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>