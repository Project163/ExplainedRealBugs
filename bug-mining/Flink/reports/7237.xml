<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:18:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-33053] Watcher leak in Zookeeper HA mode</title>
                <link>https://issues.apache.org/jira/browse/FLINK-33053</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We observe a watcher leak in our OLAP stress test when enabling Zookeeper HA mode. TM&apos;s watches on the leader of JobMaster has not been stopped after job finished.&lt;/p&gt;

&lt;p&gt;Here is how we re-produce this issue:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Start a session cluster and enable Zookeeper HA mode.&lt;/li&gt;
	&lt;li&gt;Continuously and concurrently submit short queries, e.g. WordCount to the cluster.&lt;/li&gt;
	&lt;li&gt;echo -n wchp | nc {zk host} {zk port} to get current watches.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We can see a lot of watches on /flink/{cluster_name}/leader/{job_id}/connection_info.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13549860">FLINK-33053</key>
            <summary>Watcher leak in Zookeeper HA mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guoyangze">Yangze Guo</assignee>
                                    <reporter username="guoyangze">Yangze Guo</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 7 Sep 2023 03:45:58 +0000</created>
                <updated>Mon, 5 May 2025 06:26:06 +0000</updated>
                            <resolved>Tue, 19 Sep 2023 05:37:47 +0000</resolved>
                                    <version>1.17.0</version>
                    <version>1.18.0</version>
                    <version>1.17.1</version>
                                    <fixVersion>1.19.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17762558" author="karmagyz" created="Thu, 7 Sep 2023 03:48:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; Would you like to take a look?&lt;/p&gt;</comment>
                            <comment id="17762560" author="karmagyz" created="Thu, 7 Sep 2023 03:52:36 +0000"  >&lt;p&gt;Also cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wangyang0918&quot; class=&quot;user-hover&quot; rel=&quot;wangyang0918&quot;&gt;wangyang0918&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17762574" author="mapohl" created="Thu, 7 Sep 2023 05:56:37 +0000"  >&lt;p&gt;Thanks for bringing this up, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guoyangze&quot; class=&quot;user-hover&quot; rel=&quot;guoyangze&quot;&gt;guoyangze&lt;/a&gt;. I&apos;m going to have a look at it. Just having a brief look at the code, I suspect it to be a curator issue. Because we&apos;re properly closing all the resources in the driver. But I have to investigate further.&lt;/p&gt;

&lt;p&gt;You didn&apos;t check, by any chance, whether this is also observable in 1.18 (because we upgraded curator to 5.4.0 in 1.18)?&lt;/p&gt;</comment>
                            <comment id="17762578" author="karmagyz" created="Thu, 7 Sep 2023 06:21:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; Thanks for your help. I check it with curator 5.5.0 but observe the same issue. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;Tison&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17762579" author="karmagyz" created="Thu, 7 Sep 2023 06:23:19 +0000"  >&lt;p&gt;In our test, the log shows the ZooKeeperLeaderRetrievalDriver has been close correctly. So, it&apos;s likely to be a curator issue.&lt;/p&gt;</comment>
                            <comment id="17762582" author="mapohl" created="Thu, 7 Sep 2023 06:50:46 +0000"  >&lt;p&gt;Can you share the logs and the thread dump of this run?&lt;/p&gt;</comment>
                            <comment id="17762599" author="tison" created="Thu, 7 Sep 2023 07:46:10 +0000"  >&lt;p&gt;The recipe in use is &lt;tt&gt;TreeCache&lt;/tt&gt;, which doesn&apos;t change from 5.0.0. And it also closes watches on &lt;tt&gt;close&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Do you have a bisect which version introduced this regression?&lt;/p&gt;</comment>
                            <comment id="17762657" author="tison" created="Thu, 7 Sep 2023 09:00:52 +0000"  >&lt;p&gt;Perhaps you can enable debug logs and check &quot;Removing watcher for path: &quot; from Curator to see if the related watchers are issued removing.&lt;/p&gt;</comment>
                            <comment id="17762677" author="karmagyz" created="Thu, 7 Sep 2023 09:47:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt; Could we use CuratorCache instead? Would it be more stable?&lt;/p&gt;</comment>
                            <comment id="17762680" author="mapohl" created="Thu, 7 Sep 2023 09:55:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-29813&quot; title=&quot;Remove deprecated Curator API usages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-29813&quot;&gt;FLINK-29813&lt;/a&gt; is already covering the migration to &lt;tt&gt;CuratorCache&lt;/tt&gt;. I haven&apos;t had a chance to look into it, yet. We need to do an analysis whether switching would cause some side effects. But we still might want to understand where the thread leaking is coming from.&lt;/p&gt;</comment>
                            <comment id="17762700" author="karmagyz" created="Thu, 7 Sep 2023 10:52:43 +0000"  >&lt;p&gt;Thanks for the pointer &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;. I&apos;ll try to get a debug log and heap dump.&lt;/p&gt;</comment>
                            <comment id="17762936" author="karmagyz" created="Fri, 8 Sep 2023 03:24:20 +0000"  >&lt;p&gt;I reproduce the issue and filter out some logs. &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13062758/13062758_26.dump.zip&quot; title=&quot;26.dump.zip attached to FLINK-33053&quot;&gt;26.dump.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13062757/13062757_26.log&quot; title=&quot;26.log attached to FLINK-33053&quot;&gt;26.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; This tm still watches the leader of job 7db5c7316828f598234677e2169e7b0f.&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;/flink/flink-native-test-117/leader/7db5c7316828f598234677e2169e7b0f/connection_info&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; 0x6400013b748a4420&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17762962" author="mapohl" created="Fri, 8 Sep 2023 05:51:05 +0000"  >&lt;p&gt;Thanks for sharing this. I guess, the thread dump (which you can generate by sending &lt;tt&gt;kill -3 &amp;lt;taskmanager-pid&amp;gt;&lt;/tt&gt; to the TaskManager process) would be more helpful than the heap dump. Or am I missing something. The thread dump might tell us more of what threads are still available even after the JobMaster is closed.&lt;/p&gt;</comment>
                            <comment id="17762965" author="tison" created="Fri, 8 Sep 2023 05:57:29 +0000"  >&lt;p&gt;The log seems trimed. I saw:&lt;/p&gt;

&lt;p&gt;2023-09-08 11:09:03,738 DEBUG org.apache.flink.shaded.curator5.org.apache.curator.framework.imps.WatcherRemovalManager [] - Removing watcher for path: /flink/flink-native-test-117/leader/7db5c7316828f598234677e2169e7b0f/connection_info&lt;/p&gt;

&lt;p&gt;So the TM has issued watcher removal request.&lt;/p&gt;</comment>
                            <comment id="17763315" author="karmagyz" created="Sat, 9 Sep 2023 07:58:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt; Yes, it seems teh curator framework issued the watcher removal request at least. But will there be any logs printed when this request is successful?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; Thead dump of a TM with watch leak &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13062778/13062778_taskmanager_flink-native-test-117-taskmanager-1-9_thread_dump+%281%29.json&quot; title=&quot;taskmanager_flink-native-test-117-taskmanager-1-9_thread_dump (1).json attached to FLINK-33053&quot;&gt;taskmanager_flink-native-test-117-taskmanager-1-9_thread_dump (1).json&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17763713" author="karmagyz" created="Mon, 11 Sep 2023 13:21:56 +0000"  >&lt;p&gt;I just find that this issue is very easy to reproduce. To observe the watch leak, it only requires deploying a local standalone HA cluster and submitting a single wordcount job. Thus, I&apos;d like to promote it to blocker of 1.18. WDYT&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="17764640" author="karmagyz" created="Wed, 13 Sep 2023 12:32:18 +0000"  >&lt;p&gt;JFYI, I&apos;m still investigating the root cause of this, but I found the issue will be fixed if we add a safetynet in&#160;&lt;br/&gt;
ZooKeeperLeaderRetrievalDriver#close like this:&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
client.watchers()
   .removeAll()
   .ofType(Watcher.WatcherType.Any)
   .forPath(connectionInformationPath);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17764702" author="tison" created="Wed, 13 Sep 2023 14:12:40 +0000"  >&lt;p&gt;I noticed that the &lt;tt&gt;TreeCache&lt;/tt&gt;&apos;s close call &lt;tt&gt;removeWatches&lt;/tt&gt; instead of &lt;tt&gt;removeAllWatches&lt;/tt&gt; called by your scripts above.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;removeWatches&lt;/tt&gt; only remove the watcher in client side so remain the server side watcher as is.&lt;/p&gt;</comment>
                            <comment id="17764721" author="tison" created="Wed, 13 Sep 2023 14:38:58 +0000"  >&lt;p&gt;See &lt;a href=&quot;https://lists.apache.org/thread/3b9hn9j4c05yfztlr2zcctbg7sqwdh58&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread/3b9hn9j4c05yfztlr2zcctbg7sqwdh58&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This seems to be a ZK issue that I met one year ago..&lt;/p&gt;</comment>
                            <comment id="17764723" author="tison" created="Wed, 13 Sep 2023 14:39:43 +0000"  >&lt;p&gt;But we don&apos;t have other shared watchers so we can force remove watches as above.&lt;/p&gt;</comment>
                            <comment id="17764943" author="karmagyz" created="Thu, 14 Sep 2023 02:26:07 +0000"  >&lt;p&gt;Thanks for the pointer &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt; . I&apos;d like to add a safetynet atm as &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-4625&quot; title=&quot;No reliable way to remove watcher without interfering others in same watch mode and on same path&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-4625&quot;&gt;ZOOKEEPER-4625&lt;/a&gt; has not been fixed and the patch might not be cherry-pick to old version. BTW, could we fix it in curator?&lt;/p&gt;</comment>
                            <comment id="17764948" author="tison" created="Thu, 14 Sep 2023 03:00:04 +0000"  >&lt;p&gt;No. Both &lt;tt&gt;CuratorCache&lt;/tt&gt; and &lt;tt&gt;TreeCache&lt;/tt&gt; doesn&apos;t &quot;own&quot; the path so it&apos;s unclear if other recipes share the same client (connection) set up watches also. This is different from &lt;tt&gt;LeaderLatch&lt;/tt&gt; which owns the path so it can ensure that no one else (should) access the related nodes.&lt;/p&gt;</comment>
                            <comment id="17764950" author="tison" created="Thu, 14 Sep 2023 03:03:54 +0000"  >&lt;p&gt;But it&apos;s possible to add an option to explicitly identify the ownership. You can open an issue on the Curator JIRA project and let me with the other maintainers to figure it out.&lt;/p&gt;</comment>
                            <comment id="17766646" author="karmagyz" created="Tue, 19 Sep 2023 05:35:24 +0000"  >&lt;p&gt;master: d5e151f72336abcc13082fe4bb3e05fd5a785e86&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13487190">ZOOKEEPER-4625</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13062758" name="26.dump.zip" size="44048814" author="guoyangze" created="Fri, 8 Sep 2023 03:22:35 +0000"/>
                            <attachment id="13062757" name="26.log" size="51492" author="guoyangze" created="Fri, 8 Sep 2023 03:21:53 +0000"/>
                            <attachment id="13062778" name="taskmanager_flink-native-test-117-taskmanager-1-9_thread_dump (1).json" size="160803" author="guoyangze" created="Sat, 9 Sep 2023 07:58:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1k7w8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>