<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:22:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-37670] Watermark alignment can deadlock job if there are no more splits to be assigned</title>
                <link>https://issues.apache.org/jira/browse/FLINK-37670</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;tt&gt;SourceCoordinator#announceCombinedWatermark&lt;/tt&gt; stops announcing combined watermark if &lt;tt&gt;context.hasNoMoreSplits(subtaskId)&lt;/tt&gt; returns true.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        for (Integer subtaskId : subTaskIds) {
            // when subtask have been finished, do not send event.
            if (!context.hasNoMoreSplits(subtaskId)) {
                // Subtask maybe during deploying or restarting, so we only send
                // WatermarkAlignmentEvent to ready task to avoid period task fail
                // (Java-ThreadPoolExecutor will not schedule the period task if it throws an
                // exception).
                context.sendEventToSourceOperatorIfTaskReady(
                        subtaskId, new WatermarkAlignmentEvent(maxAllowedWatermark));
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which means new max allowed watermark will not be announced anymore, preventing sources from making progress. The intention was to prevent failures caused by tasks not running:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: org.apache.flink.runtime.operators.coordination.TaskNotRunningException: Task is not running, but in state FINISHED
	at org.apache.flink.runtime.taskmanager.Task.deliverOperatorEvent(Task.java:1613) ~[flink-runtime-1.19-SNAPSHOT.jar:1.19-SNAPSHOT]
	at org.apache.flink.runtime.taskexecutor.TaskExecutor.sendOperatorEventToTask(TaskExecutor.java:1478) ~[flink-runtime-1.19-SNAPSHOT.jar:1.19-SNAPSHOT]
	at jdk.internal.reflect.GeneratedMethodAccessor6.invoke(Unknown Source) ~[?:?]
	at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:?]
	at java.lang.reflect.Method.invoke(Method.java:566) ~[?:?]
	at org.apache.flink.runtime.rpc.pekko.PekkoRpcActor.lambda$handleRpcInvocation$1(PekkoRpcActor.java:318) ~[flink-rpc-akka8c031913-bb13-4662-a216-58134efdb2d9.jar:1.19-SNAPSHOT]
	at org.apache.flink.runtime.concurrent.ClassLoadingUtils.runWithContextClassLoader(ClassLoadingUtils.java:83) ~[flink-rpc-core-1.19-SNAPSHOT.jar:1.19-SNAPSHOT]
	at org.apache.flink.runtime.rpc.pekko.PekkoRpcActor.handleRpcInvocation(PekkoRpcActor.java:316) ~[flink-rpc-akka8c031913-bb13-4662-a216-58134efdb2d9.jar:1.19-SNAPSHOT]
	at org.apache.flink.runtime.rpc.pekko.PekkoRpcActor.handleRpcMessage(PekkoRpcActor.java:229) ~[flink-rpc-akka8c031913-bb13-4662-a216-58134efdb2d9.jar:1.19-SNAPSHOT]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;This is an incorrect check. This, contrary to the comment, doesn&apos;t check if all subtasks have finished, but only that source coordinator has no more splits to assign.&lt;/li&gt;
	&lt;li&gt;Even if it was checking if all subtasks finished, that wouldn&apos;t work because:&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
	&lt;li&gt;one subtask can be finished, while others are still running&lt;/li&gt;
	&lt;li&gt;there can be race conditions between sending an operator event to a running operator and that operator switching to finished&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think, at least for some non critical events, we need to just ignore &lt;tt&gt;TaskNotRunningException&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13615160">FLINK-37670</key>
            <summary>Watermark alignment can deadlock job if there are no more splits to be assigned</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 14 Apr 2025 07:26:37 +0000</created>
                <updated>Wed, 16 Apr 2025 11:25:43 +0000</updated>
                            <resolved>Wed, 16 Apr 2025 11:25:43 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>1.19.2</version>
                    <version>1.20.1</version>
                                    <fixVersion>1.20.2</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                    <fixVersion>2.0.1</fixVersion>
                                    <component>API / DataStream</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17944837" author="pnowojski" created="Tue, 15 Apr 2025 20:09:20 +0000"  >&lt;p&gt;merged commit 0849018 into apache:master&lt;/p&gt;</comment>
                            <comment id="17945039" author="pnowojski" created="Wed, 16 Apr 2025 11:25:32 +0000"  >&lt;p&gt;merged commit ad51793 into apache:release-2.0&lt;br/&gt;
merged commit 5c24ae6 into apache:release-1.20 &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13576363">FLINK-35157</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13610045">FLINK-37399</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            29 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vcg8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>