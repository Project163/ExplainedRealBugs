<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20295] File Source lost data when reading from directories created by FileSystemTableSink with JSON format</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20295</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When testing the compaction functionality of the FileSystemTableSink, I found that when using json format, the produced directories could not be read correctly by the file source, namely only a part of records are read.&lt;/p&gt;


&lt;p&gt;By checking the produced directories, the number of the records in it is the same as expected, thus it seems to be the issue of the source side.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The issue only exists for JSON format.&lt;/p&gt;

&lt;p&gt;The data is produced by &lt;a href=&quot;https://github.com/gaoyunhaii/flink1.12test/blob/main/src/main/java/FileCompactionTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FileCompactionTest&lt;/a&gt;&#160;and read by&#160;&#160;&lt;a href=&quot;https://github.com/gaoyunhaii/flink1.12test/blob/main/src/main/java/FileCompactionCheckTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FileCompactionCheckTest&lt;/a&gt;&#160;. An example directories tar file of 8000 records are also attached.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13342092">FLINK-20295</key>
            <summary>File Source lost data when reading from directories created by FileSystemTableSink with JSON format</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lzljs3620320">Jingsong Lee</assignee>
                                    <reporter username="gaoyunhaii">Yun Gao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 23 Nov 2020 10:02:17 +0000</created>
                <updated>Wed, 25 Nov 2020 10:46:07 +0000</updated>
                            <resolved>Wed, 25 Nov 2020 06:38:10 +0000</resolved>
                                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Connectors / FileSystem</component>
                    <component>Table SQL / Ecosystem</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17237439" author="stephanewen" created="Mon, 23 Nov 2020 15:32:51 +0000"  >&lt;p&gt;Thanks for reporting this. Is it possible to have a minimal example that reproduces this problem?&lt;/p&gt;</comment>
                            <comment id="17237766" author="gaoyunhaii" created="Tue, 24 Nov 2020 00:41:02 +0000"  >&lt;p&gt;Ok, no problem, I&apos;ll implement a minimal example.&lt;/p&gt;</comment>
                            <comment id="17237850" author="gaoyunhaii" created="Tue, 24 Nov 2020 04:20:01 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;, I submitted the minimal example:&#160;&lt;a href=&quot;https://github.com/gaoyunhaii/flink/commit/8874b3494dc25bda1859d332a301771ff98238c3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;The minimal example&lt;/a&gt;&#160;.&lt;/p&gt;

&lt;p&gt;I also debugged the case and found that it should be due to that&#160;&lt;em&gt;DeserializationSchemaAdapter&lt;/em&gt; always returned the same cached iterator for different batches, thus it might be the data get override before it is fully emitted. Returns different iterators should be able to solve this issue.&#160;&lt;/p&gt;</comment>
                            <comment id="17237887" author="lzljs3620320" created="Tue, 24 Nov 2020 06:09:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt;&#160;Thanks for your debugging and&#160;research, &lt;tt&gt;HiveBulkFormatAdapter&lt;/tt&gt;&#160;also has this problem. I and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt;&#160;will fix this.&lt;/p&gt;</comment>
                            <comment id="17237892" author="gaoyunhaii" created="Tue, 24 Nov 2020 06:25:11 +0000"  >&lt;p&gt;OK, very thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt; for attending this issue!&lt;/p&gt;</comment>
                            <comment id="17238125" author="stephanewen" created="Tue, 24 Nov 2020 13:35:52 +0000"  >&lt;p&gt;Thanks for debugging this. So this is a bug in the &lt;tt&gt;DeserializationFormatAdapter&lt;/tt&gt; implementation?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; A thought on the &lt;tt&gt;DeserializationFormatAdapter&lt;/tt&gt; implementation:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think it makes sense to use a StreamRecordFormat here. Then you also don&apos;t need to worry about batching.&lt;/li&gt;
	&lt;li&gt;We can also use Java&apos;s &lt;tt&gt;BufferedReader(InputStreamReader())&lt;/tt&gt; to parse the lines. That is a bit less performant than out own fast parsing DelimitedInputFormat, but it supports different charset encodings properly. Currently, the DelimitedInputFormat fails on UTF-16 and some other charsets.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17238547" author="lzljs3620320" created="Wed, 25 Nov 2020 06:38:10 +0000"  >&lt;p&gt;master (1.12):&#160;07a449e2f68384007cad61c10d0dcbbe0cf89c26&lt;/p&gt;</comment>
                            <comment id="17238554" author="lzljs3620320" created="Wed, 25 Nov 2020 06:51:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;&#160;Yes, it is a bug&#160;in the&#160;&lt;tt&gt;DeserializationFormatAdapter&lt;/tt&gt;&#160;implementation.&lt;/p&gt;

&lt;p&gt;Yes, I&apos;ve also thought about using StreamFormat, but we don&apos;t have splittable&#160;StreamFormat implementation at present. In order to avoid functional regression, I still write DelimitedInputFormat.&lt;/p&gt;

&lt;p&gt;I will create a Jira to remove&#160;DelimitedInputFormat in&#160;&lt;tt&gt;DeserializationFormatAdapter&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17238616" author="stephanewen" created="Wed, 25 Nov 2020 09:09:00 +0000"  >&lt;p&gt;StreamRecordFormats can be splittable. I think the biggest problem is how to do the line parsing in a way that supports charsets properly. &lt;del&gt;Even for UTF-8, just searching byte-wise for a &apos;\n&apos; character leads to wrong results due to multi-byte code points.&lt;/del&gt; The current DelimitedInputFormat cannot handle various cases.&lt;/p&gt;</comment>
                            <comment id="17238624" author="lzljs3620320" created="Wed, 25 Nov 2020 09:26:37 +0000"  >&lt;p&gt;Let me continue to investigate, I remember that UTF-8 is OK, because the coding will ensure the uniqueness of each byte.&lt;/p&gt;

&lt;p&gt;I quoted your words in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20340&quot; title=&quot;Use StreamFormat instead of DelimitedInputFormat in DeserializationSchemaAdapter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20340&quot;&gt;FLINK-20340&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17238668" author="stephanewen" created="Wed, 25 Nov 2020 10:45:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; - I think you are right, UTF-8 is actually okay. UTF-16 was a big issue, though.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13340262">FLINK-20122</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13342537">FLINK-20340</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13015842" name="compaction.tgz" size="6908" author="gaoyunhaii" created="Mon, 23 Nov 2020 10:02:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kubc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>