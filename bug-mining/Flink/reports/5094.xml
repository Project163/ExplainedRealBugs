<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:52:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21028] Streaming application didn&apos;t stop properly </title>
                <link>https://issues.apache.org/jira/browse/FLINK-21028</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I have a Flink job running on YARN with a disjoint graph, i.e. a single job contains two independent and isolated pipelines.&lt;/p&gt;

&lt;p&gt;From time to time, I stop the job with a savepoint like so:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
flink stop -p ${SAVEPOINT_BASEDIR}/${FLINK_JOB_NAME}/SAVEPOINTS --yarnapplicationId=${FLINK_YARN_APPID} ${ID}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A few days ago, this job suddenly didn&apos;t stop properly as usual but ran into a possible race condition.&lt;/p&gt;

&lt;p&gt;On the CLI with stop, I received a simple timeout:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.flink.util.FlinkException: Could not stop with a savepoint job &lt;span class=&quot;code-quote&quot;&gt;&quot;f23290bf5fb0ecd49a4455e4a65f2eb6&quot;&lt;/span&gt;.
 at org.apache.flink.client.cli.CliFrontend.lambda$stop$5(CliFrontend.java:495)
 at org.apache.flink.client.cli.CliFrontend.runClusterAction(CliFrontend.java:864)
 at org.apache.flink.client.cli.CliFrontend.stop(CliFrontend.java:487)
 at org.apache.flink.client.cli.CliFrontend.parseParameters(CliFrontend.java:931)
 at org.apache.flink.client.cli.CliFrontend.lambda$main$10(CliFrontend.java:992)
 at java.security.AccessController.doPrivileged(Native Method)
 at javax.security.auth.Subject.doAs(Subject.java:422)
 at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1875)
 at org.apache.flink.runtime.security.contexts.HadoopSecurityContext.runSecured(HadoopSecurityContext.java:41)
 at org.apache.flink.client.cli.CliFrontend.main(CliFrontend.java:992)
Caused by: java.util.concurrent.TimeoutException
 at java.util.concurrent.CompletableFuture.timedGet(CompletableFuture.java:1771)
 at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1915)
 at org.apache.flink.client.cli.CliFrontend.lambda$stop$5(CliFrontend.java:493)
 ... 9 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The root of the problem however is that on a taskmanager, I received an exception in shutdown, which lead to restarting (a part) of the pipeline and put it back to running state, thus the console command for stopping timed out (as the job was (partially) back in running state). the exception which looks like a race condition for me in the logs is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-01-12T06:15:15.827877+01:00 WARN org.apache.flink.runtime.taskmanager.Task Source: rawdata_source1 -&amp;gt; validation_source1 -&amp;gt; enrich_source1 -&amp;gt; map_json_source1 -&amp;gt; Sink: write_to_kafka_source1) (3/18) (bc68320cf69dd877782417a3298499d6) switched from RUNNING to FAILED.
java.util.concurrent.ExecutionException: org.apache.flink.streaming.runtime.tasks.ExceptionInChainedOperatorException: Could not forward element to next &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;
 at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)
 at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1915)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.quiesceTimeServiceAndCloseOperator(StreamOperatorWrapper.java:161)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:130)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:134)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:134)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:134)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:134)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:134)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:80)
 at org.apache.flink.streaming.runtime.tasks.OperatorChain.closeOperators(OperatorChain.java:302)
 at org.apache.flink.streaming.runtime.tasks.StreamTask.afterInvoke(StreamTask.java:576)
 at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:544)
 at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:721)
 at org.apache.flink.runtime.taskmanager.Task.run(Task.java:546)
 at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: org.apache.flink.streaming.runtime.tasks.ExceptionInChainedOperatorException: Could not forward element to next &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;
 at org.apache.flink.streaming.runtime.tasks.OperatorChain$ChainingOutput.emitWatermark(OperatorChain.java:642)
 at org.apache.flink.streaming.api.operators.CountingOutput.emitWatermark(CountingOutput.java:41)
 at org.apache.flink.streaming.runtime.operators.TimestampsAndWatermarksOperator$WatermarkEmitter.emitWatermark(TimestampsAndWatermarksOperator.java:165)
 at org.apache.flink.streaming.runtime.operators.util.AssignerWithPeriodicWatermarksAdapter.onPeriodicEmit(AssignerWithPeriodicWatermarksAdapter.java:54)
 at org.apache.flink.streaming.runtime.operators.TimestampsAndWatermarksOperator.close(TimestampsAndWatermarksOperator.java:125)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.lambda$closeOperator$5(StreamOperatorWrapper.java:205)
 at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$SynchronizedStreamTaskActionExecutor.runThrowing(StreamTaskActionExecutor.java:92)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.closeOperator(StreamOperatorWrapper.java:203)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.lambda$deferCloseOperatorToMailbox$3(StreamOperatorWrapper.java:177)
 at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$SynchronizedStreamTaskActionExecutor.runThrowing(StreamTaskActionExecutor.java:92)
 at org.apache.flink.streaming.runtime.tasks.mailbox.Mail.run(Mail.java:78)
 at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxExecutorImpl.tryYield(MailboxExecutorImpl.java:90)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.quiesceTimeServiceAndCloseOperator(StreamOperatorWrapper.java:155)
 ... 13 more
Caused by: java.lang.RuntimeException
 at org.apache.flink.streaming.runtime.io.RecordWriterOutput.emitWatermark(RecordWriterOutput.java:123)
 at org.apache.flink.streaming.api.operators.CountingOutput.emitWatermark(CountingOutput.java:41)
 at org.apache.flink.streaming.api.operators.AbstractStreamOperator.processWatermark(AbstractStreamOperator.java:570)
 at org.apache.flink.streaming.api.operators.ProcessOperator.processWatermark(ProcessOperator.java:72)
 at org.apache.flink.streaming.runtime.tasks.OperatorChain$ChainingOutput.emitWatermark(OperatorChain.java:638)
 ... 25 more
Caused by: java.lang.IllegalStateException
 at org.apache.flink.util.Preconditions.checkState(Preconditions.java:179)
 at org.apache.flink.runtime.io.network.buffer.BufferBuilder.append(BufferBuilder.java:83)
 at org.apache.flink.runtime.io.network.api.serialization.SpanningRecordSerializer.copyToBufferBuilder(SpanningRecordSerializer.java:90)
 at org.apache.flink.runtime.io.network.api.writer.RecordWriter.copyFromSerializerToTargetChannel(RecordWriter.java:136)
 at org.apache.flink.runtime.io.network.api.writer.ChannelSelectorRecordWriter.broadcastEmit(ChannelSelectorRecordWriter.java:80)
 at org.apache.flink.streaming.runtime.io.RecordWriterOutput.emitWatermark(RecordWriterOutput.java:121)
 ... 29 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I already raised a question regarding this bug on the user mailing list with the conclusion to just open a ticket here. Original on user mailing list: &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Bugs-in-Streaming-job-stopping-Weird-graceful-stop-restart-for-disjoint-job-graph-td40610.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Bugs-in-Streaming-job-stopping-Weird-graceful-stop-restart-for-disjoint-job-graph-td40610.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;edit:&lt;br/&gt;
In Flink 1.12.x this bug can probably lead to corrupted data stream and all kinds of deserialisation errors on the downstream task.&lt;br/&gt;
Also the same bug can leave any code (regardless if it&apos;s Flink&apos;s network stack, user code, or some 3rd party library) that sleeps interruptible in an invalid state.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13353251">FLINK-21028</key>
            <summary>Streaming application didn&apos;t stop properly </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="TheoD">Theo Diefenthal</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 19 Jan 2021 10:45:07 +0000</created>
                <updated>Wed, 28 Jul 2021 10:42:20 +0000</updated>
                            <resolved>Tue, 23 Feb 2021 17:47:40 +0000</resolved>
                                    <version>1.11.2</version>
                    <version>1.12.2</version>
                    <version>1.13.0</version>
                                    <fixVersion>1.11.4</fixVersion>
                    <fixVersion>1.12.2</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17267933" author="till.rohrmann" created="Tue, 19 Jan 2021 14:37:23 +0000"  >&lt;p&gt;Thanks for creating this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TheoD&quot; class=&quot;user-hover&quot; rel=&quot;TheoD&quot;&gt;TheoD&lt;/a&gt;. How does this ticket relate to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21029&quot; title=&quot;Failure of shutdown lead to restart of (connected) pipeline&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21029&quot;&gt;FLINK-21029&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21030&quot; title=&quot;Broken job restart for job with disjoint graph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21030&quot;&gt;&lt;del&gt;FLINK-21030&lt;/del&gt;&lt;/a&gt;? Can this ticket be closed or do you want a different aspect fixed with this issue?&lt;/p&gt;</comment>
                            <comment id="17267989" author="theod" created="Tue, 19 Jan 2021 15:55:26 +0000"  >&lt;p&gt;Hi Till, thanks for your feedback.&lt;/p&gt;

&lt;p&gt;Originally on the mailing list, I split it up into three different issue in order to focus on different anspects as for me, those issues occured at the same time but still are somehow different.&lt;/p&gt;

&lt;p&gt;In this issue here, I assume definitely a bug in Flinks shutdown behavior, something like a race condition. Some Buffer was already closed even though it was still assumed to be opened. (No hardware failure or anything else, just flink internal)&lt;/p&gt;

&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21029&quot; title=&quot;Failure of shutdown lead to restart of (connected) pipeline&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21029&quot;&gt;FLINK-21029&lt;/a&gt;, I raise a more general question: If &lt;em&gt;anything unexpected&lt;/em&gt; occurs during a requested job shutdown: Should we force shutdown or try to restart? So this is not directly related to the bug here but general behavior.&lt;/p&gt;

&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21030&quot; title=&quot;Broken job restart for job with disjoint graph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21030&quot;&gt;&lt;del&gt;FLINK-21030&lt;/del&gt;&lt;/a&gt;, I see a follow up error on top of this bug: If a failing job starts to recover, it seems to don&apos;t recover the entire pipeline but only the connected components.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I wasn&apos;t sure whether to open a single ticket for all of them or just creating one, but seeing your comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21029&quot; title=&quot;Failure of shutdown lead to restart of (connected) pipeline&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21029&quot;&gt;FLINK-21029&lt;/a&gt;, I think it was a good decision to split them up: We can discuss there how Flink should handle any failure in shutdown whereas this bug here stays &quot;clean&quot; and focused on why under this special circumstances there was this race condition.&lt;/p&gt;</comment>
                            <comment id="17268008" author="till.rohrmann" created="Tue, 19 Jan 2021 16:15:39 +0000"  >&lt;p&gt;Alright, thanks for the clarification &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TheoD&quot; class=&quot;user-hover&quot; rel=&quot;TheoD&quot;&gt;TheoD&lt;/a&gt;. I think it makes sense to investigate whether the Task failure was a coincidence or caused by the stop-with-savepoint command. What would definitely help is if you could provide us with the debug logs of the run where Flink failed.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AHeise&quot; class=&quot;user-hover&quot; rel=&quot;AHeise&quot;&gt;AHeise&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17268016" author="theod" created="Tue, 19 Jan 2021 16:29:13 +0000"  >&lt;p&gt;Sadly, I don&apos;t have any DEBUG logs here as I can&apos;t reproduce the issue. This job runs since ~ 2 years and is stopped and restarted afterwards once a week and this is the first time that this happened.&lt;/p&gt;

&lt;p&gt;There isn&apos;t anything meaningful in the INFO-Logs: I can see on all taskmanagers the logs that all checkpoints succeeded up to the time when I called &quot;stop&quot;. Afterwards, there are only messages from various tasks that they switched their state from RUNNING to FINISHED. Only this one task prints this exception which is already printed above and switched its state to FAILING. &lt;/p&gt;

&lt;p&gt;It might be helpful to note that the job runs on 18 task managers, each having one slot. The cluster has 10 or 15 nodes, so definitely less than 18. Some machines thus run multiple task managers (Shouldn&apos;t be a problem, but might be helpful?). &lt;/p&gt;

&lt;p&gt;Note also the feature of the &quot;distinct graph&quot; here: We have a parallelism of 18 (18 Task Managers, 1 Slot), and we have one particual subgraph with parallelism 18 and some other subgraphs with lower parallelism. In total, there are like 200 tasks and some task managers run multiple subgraphs in parallel, even though they only have one slot... Maybe that is part of the issue here?&lt;/p&gt;</comment>
                            <comment id="17281047" author="till.rohrmann" created="Mon, 8 Feb 2021 13:20:12 +0000"  >&lt;p&gt;Stephan suggested that this might be race condition between shutting down and the old sources still doing something.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17281875" author="pnowojski" created="Tue, 9 Feb 2021 16:47:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TheoD&quot; class=&quot;user-hover&quot; rel=&quot;TheoD&quot;&gt;TheoD&lt;/a&gt;, could you post full logs, including those from Job Manager and at least from those two Task Managers that:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;two tasks had something that looks like a racecondition&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;? Frankly I stared at the code and the provided stack trace for a better part of last couple of hours and the only potential explanation that I could come up with, was if someone had interrupted the task&apos;s thread (1) while it was waiting for the buffer and this interrupted exception would later be swallowed by someone else (2). The problem might be that &lt;tt&gt;RecordWriter#finishBufferBuilder&lt;/tt&gt; leaves the finished buffer without setting it to &lt;tt&gt;null&lt;/tt&gt;, which is later detected as an &lt;tt&gt;IllegalStateException&lt;/tt&gt;. If that&apos;s the case, this problem was accidentally fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19297&quot; title=&quot;Make ResultPartitionWriter record-oriented&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19297&quot;&gt;&lt;del&gt;FLINK-19297&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;(1) If that was Flink cancelling those two tasks, there must be some reason behind this cancellation attempt. Some different third task, would have to have failed due to a completely different reason. Alternatively, are you sure that neither you, nor anyone else has cancelled the job while it was being stopped? Or maybe something completely different, some watchdog script issued SIGINT to the Flink process? &lt;/p&gt;

&lt;p&gt;The second part (2), might be actually something somehow expected. We are first interrupting the source function thread, and later the task thread. During this period maybe &lt;tt&gt;StreamTask&lt;/tt&gt; managed to start closing itself and it hit this illegal state problem?&lt;/p&gt;

&lt;p&gt;TL;DR I&apos;m not sure, but my only theory is a combination of something else interrupting a task plus a minor bug fixed accidentally in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19297&quot; title=&quot;Make ResultPartitionWriter record-oriented&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19297&quot;&gt;&lt;del&gt;FLINK-19297&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17282124" author="theod" created="Wed, 10 Feb 2021 00:08:44 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; , there really isn&apos;t anything else in the logs. I only see/saw succeeded checkpoints all the time and than the printed error on two taskmanagers following all respectively a lot to restart while others were stopped.&lt;/p&gt;

&lt;p&gt;But as you post your questions: Can this be related to the disjoint job graph setup? I once realized that if (on YARN) I start my job and have both disjoint pipelines with parallelism 1 setup and have yarn configurted with 1 slot per taskmanager, I still have only one task manager running so that both graphs run on the same taskmanager. =&amp;gt; Might it be that the stop tried to stop both &quot;graphs&quot; and those graphs caused kind of a race against each other? (I have no idea about flink internals...)&lt;/p&gt;</comment>
                            <comment id="17282188" author="kezhuw" created="Wed, 10 Feb 2021 02:53:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Thanks for renew, I used to think it could caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20888&quot; title=&quot;ContinuousFileReaderOperator should not close the output on close()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20888&quot;&gt;&lt;del&gt;FLINK-20888&lt;/del&gt;&lt;/a&gt;, but failed to find a concrete path&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Could it be&#160;&lt;tt&gt;sourceThread.interrupt()&lt;/tt&gt; in&#160;&lt;tt&gt;SourceStreamTask.cancelTask&lt;/tt&gt; ? &lt;tt&gt;SourceStreamTask&lt;/tt&gt; itself is concurrent with user function.&lt;/p&gt;

&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19297&quot; title=&quot;Make ResultPartitionWriter record-oriented&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19297&quot;&gt;&lt;del&gt;FLINK-19297&lt;/del&gt;&lt;/a&gt;, symptom could be different. A null but not full buffer with later &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt; could introduce a corrupted record. This could be case of &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/flink-kryo-exception-td41228.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/flink-kryo-exception-td41228.html&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Besides above, I found that &lt;tt&gt;BufferWritingResultPartition.requestNewBufferBuilderFromPool&lt;/tt&gt; turns &lt;tt&gt;InterruptedException&lt;/tt&gt; to &lt;tt&gt;IOException&lt;/tt&gt; with no cause. This could be problematic. I saw &lt;tt&gt;SourceStreamTask&lt;/tt&gt; depends on &lt;tt&gt;InterruptedException&lt;/tt&gt; in cancelling.&lt;/p&gt;

&lt;p&gt;Actually, I am kind of confused about the pipeline. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TheoD&quot; class=&quot;user-hover&quot; rel=&quot;TheoD&quot;&gt;TheoD&lt;/a&gt; I saw the chained task was named as &lt;tt&gt;Source: rawdata_source1 -&amp;gt; validation_source1 -&amp;gt; enrich_source1 -&amp;gt; map_json_source1 -&amp;gt; Sink: write_to_kafka_source1)&lt;/tt&gt;. If this is a source to sink chained task, how this could happen ? There is no output at all.&lt;/p&gt;</comment>
                            <comment id="17282297" author="pnowojski" created="Wed, 10 Feb 2021 08:13:54 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Can this be related to the disjoint job graph setup? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TheoD&quot; class=&quot;user-hover&quot; rel=&quot;TheoD&quot;&gt;TheoD&lt;/a&gt; I don&apos;t think so. At least I do not see how, but as I don&apos;t understand how is it happening, I might be wrong.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19297&quot; title=&quot;Make ResultPartitionWriter record-oriented&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19297&quot;&gt;&lt;del&gt;FLINK-19297&lt;/del&gt;&lt;/a&gt;, symptom could be different. A null but not full buffer with later EndOfPartitionEvent could introduce a corrupted record.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; you might be right. Keep also in mind, that by looking at the stack trace here, this &quot;later&quot;, doesn&apos;t necessarily have to be &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt;, but &quot;later&quot; could be records that are being emitted during the closing procedure:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.quiesceTimeServiceAndCloseOperator(StreamOperatorWrapper.java:161)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:130)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:134)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:134)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:134)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:134)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:134)
 at org.apache.flink.streaming.runtime.tasks.StreamOperatorWrapper.close(StreamOperatorWrapper.java:80)
 at org.apache.flink.streaming.runtime.tasks.OperatorChain.closeOperators(OperatorChain.java:302)
 at org.apache.flink.streaming.runtime.tasks.StreamTask.afterInvoke(StreamTask.java:576)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;Actually, I am kind of confused about the pipeline. Theo Diefenthal I saw the chained task was named as Source: rawdata_source1 -&amp;gt; validation_source1 -&amp;gt; enrich_source1 -&amp;gt; map_json_source1 -&amp;gt; Sink: write_to_kafka_source1). If this is a source to sink chained task, how this could happen ? There is no output at all.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Good question. I second that (maybe a side output?). Also it&apos;s suspicious that on the stack trace we have 6 operator wrappers, while the task name suggests there should be 5.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TheoD&quot; class=&quot;user-hover&quot; rel=&quot;TheoD&quot;&gt;TheoD&lt;/a&gt;, please share the logs with us, we might spot something that you missed, or at the very least we would understand the context better. Could you also share the JobGraph with us?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Piotr Nowojski Could it be sourceThread.interrupt() in SourceStreamTask.cancelTask ? SourceStreamTask itself is concurrent with user function.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It could be, that&apos;s what I&apos;m suspecting, but something would have to trigger &lt;tt&gt;SourceStreamTask&lt;/tt&gt; cancellation in the first place, or something completely not related to Flink, would have to send SIGINT to the Flink process.&lt;/p&gt;</comment>
                            <comment id="17282305" author="kezhuw" created="Wed, 10 Feb 2021 08:29:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;but something would have to trigger SourceStreamTask cancellation in the first place&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; I saw path &lt;tt&gt;StreamTask.notifyCheckpointComplete&lt;/tt&gt; ==&amp;gt; &lt;tt&gt;SourceStreamTask.finishTask&lt;/tt&gt; ==&amp;gt; &lt;tt&gt;SourceStreamTask.cancelTask&lt;/tt&gt; ==&amp;gt; &lt;tt&gt;SourceStreamTask.sourceThread.interrupt&lt;/tt&gt;. It is part of stop-with-savepoint procedure.&lt;/p&gt;</comment>
                            <comment id="17282489" author="pnowojski" created="Wed, 10 Feb 2021 14:39:32 +0000"  >&lt;p&gt;Yes, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; good catch. I think you are right. That explains the problem. For clean shutdown we should never interrupt threads. While:&lt;/p&gt;

&lt;p&gt;StreamTask.notifyCheckpointComplete ==&amp;gt; SourceStreamTask.finishTask ==&amp;gt; SourceStreamTask.cancelTask ==&amp;gt; SourceStreamTask.sourceThread.interrupt&lt;/p&gt;

&lt;p&gt;is doing just that leaving the network stack in the inconsistent state, and later we are entering the &quot;clean shutdown procedure&quot;, which attempts to write more records to the network stack. Here (in 1.11.2) it display itself with&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.IllegalStateException
 at org.apache.flink.util.Preconditions.checkState(Preconditions.java:179)
 at org.apache.flink.runtime.io.network.buffer.BufferBuilder.append(BufferBuilder.java:83)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While in Flink 1.12.x all kinds of stream corruptions exceptions can happen. I&apos;m not saying those are the only potential outcomes. If interrupted exception is thrown/caught from the user code/3rd party library it can also be left in an invalid state, causing whole bunch of different problems.&lt;/p&gt;</comment>
                            <comment id="17282950" author="till.rohrmann" created="Thu, 11 Feb 2021 09:43:02 +0000"  >&lt;p&gt;Shall we make this ticket a blocker for the 1.13.0 release? It sounds like we want to quickly fix it.&lt;/p&gt;</comment>
                            <comment id="17289031" author="pnowojski" created="Tue, 23 Feb 2021 11:49:31 +0000"  >&lt;p&gt;merged commit 19ceee0 into apache:master&lt;/p&gt;</comment>
                            <comment id="17289219" author="pnowojski" created="Tue, 23 Feb 2021 17:47:40 +0000"  >&lt;p&gt;merged commit 463d9e3 into apache:release-1.11&lt;br/&gt;
merged commit 54beaa3 into apache:release-1.12&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13382730">FLINK-22928</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13360262">FLINK-21447</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13361179">FLINK-21515</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13353254">FLINK-21030</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13392309">FLINK-23527</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13392317">FLINK-23528</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13353253">FLINK-21029</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13354470">FLINK-21133</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 38 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0mra0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>