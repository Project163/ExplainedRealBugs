<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:27:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5830] OutOfMemoryError during notify final state in TaskExecutor may cause job stuck</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5830</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The scenario is like this:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;JobMaster&lt;/tt&gt; tries to cancel all the executions when process failed execution, and the task executor already acknowledge the cancel rpc message.&lt;br/&gt;
When notify the final state in &lt;tt&gt;TaskExecutor&lt;/tt&gt;, it causes OOM in &lt;tt&gt;AkkaRpcActor&lt;/tt&gt; and this error is caught to log the info. The final state will not be sent any more.&lt;br/&gt;
The &lt;tt&gt;JobMaster&lt;/tt&gt; can not receive the final state and trigger the restart strategy.&lt;/p&gt;

&lt;p&gt;One solution is to catch the &lt;tt&gt;OutOfMemoryError&lt;/tt&gt; and throw it, then it will cause to shut down the &lt;tt&gt;ActorSystem&lt;/tt&gt; resulting in exiting the &lt;tt&gt;TaskExecutor&lt;/tt&gt;. The &lt;tt&gt;JobMaster&lt;/tt&gt; can be notified of &lt;tt&gt;TaskExecutor&lt;/tt&gt; failure and fail all the tasks to trigger restart successfully.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13043961">FLINK-5830</key>
            <summary>OutOfMemoryError during notify final state in TaskExecutor may cause job stuck</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zjwang">Zhijiang</assignee>
                                    <reporter username="zjwang">Zhijiang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Feb 2017 11:14:29 +0000</created>
                <updated>Thu, 9 Mar 2017 12:05:04 +0000</updated>
                            <resolved>Thu, 9 Mar 2017 12:04:57 +0000</resolved>
                                                    <fixVersion>1.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15874304" author="githubbot" created="Mon, 20 Feb 2017 10:09:32 +0000"  >&lt;p&gt;GitHub user zhijiangW opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5830&quot; title=&quot;OutOfMemoryError during notify final state in TaskExecutor may cause job stuck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5830&quot;&gt;&lt;del&gt;FLINK-5830&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Distributed Coordination&amp;#93;&lt;/span&gt; Handle OutOfMemory error during process async message in akka rpc actor&lt;/p&gt;

&lt;p&gt;    If caught OOM error during process async messages in *&lt;b&gt;AkkaRpcActor&lt;/b&gt;&lt;b&gt;, it will bring ambiguous behavior and may lost rpc messages. If the message is for notifying final state in **TaskExecutor&lt;/b&gt;&lt;b&gt;, it will result in **JobMaster&lt;/b&gt;* can not receive final state any more during process failing job, and may cause job stuck in final.&lt;/p&gt;

&lt;p&gt;    The solution is to catch this special error in *&lt;b&gt;AkkaRpcActor&lt;/b&gt;* and throw it, then it will result in shutting down *&lt;b&gt;ActorSystem&lt;/b&gt;* and exiting *&lt;b&gt;TaskExecutor&lt;/b&gt;* process. So the *&lt;b&gt;JobMaster&lt;/b&gt;* can be aware of that and make the job restart if necessary.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zhijiangW/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zhijiangW/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5830&quot; title=&quot;OutOfMemoryError during notify final state in TaskExecutor may cause job stuck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5830&quot;&gt;&lt;del&gt;FLINK-5830&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3360&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 1365c6da1c456d764a3171c858bce81511ed8da5&lt;br/&gt;
Author: &#28120;&#27743; &amp;lt;taojiang.wzj@alibaba-inc.com&amp;gt;&lt;br/&gt;
Date:   2017-02-20T09:54:54Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5830&quot; title=&quot;OutOfMemoryError during notify final state in TaskExecutor may cause job stuck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5830&quot;&gt;&lt;del&gt;FLINK-5830&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Distributed Coordination&amp;#93;&lt;/span&gt;Handle OutOfMemory error during process async message in akka rpc actor&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15874399" author="githubbot" created="Mon, 20 Feb 2017 11:22:29 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I would suggest that we adopt the following pattern for all the places like the one in this pull request where we catch Throwables:&lt;/p&gt;

&lt;p&gt;    ```java&lt;br/&gt;
    try &lt;/p&gt;
{
        ...
    } catch (Throwable t) {
        ExceptionUtils.rethrowIfFatalErrorOrOOM(t);
    
         // the other handling logic...
    }&lt;br/&gt;
    ```&lt;br/&gt;
    &lt;br/&gt;
    This requires to add the function `rethrowIfFatalErrorOrOOM(Throwable)` to the `ExceptionUtils`, similar to the method here: &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-core/src/main/java/org/apache/flink/util/ExceptionUtils.java#L109&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-core/src/main/java/org/apache/flink/util/ExceptionUtils.java#L109&lt;/a&gt;&lt;br/&gt;
    &lt;br/&gt;
    It would be even nicer if we could do something like Scala supports, but I think there is no way better way to do this in Java than the way suggested above&lt;br/&gt;
    ```scala&lt;br/&gt;
    try {        ...    }
&lt;p&gt; catch {&lt;br/&gt;
        case NonFatal(t) =&amp;gt; // does not include OOM and internal errors&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="15875284" author="githubbot" created="Tue, 21 Feb 2017 03:01:36 +0000"  >&lt;p&gt;Github user zhijiangW commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen , thank you for so quick reviews! &lt;/p&gt;

&lt;p&gt;    That is a good idea to add the uniform way in the utils, so we can use that in anywhere.&lt;/p&gt;

&lt;p&gt;    I will fix it as your suggestions later today.&lt;/p&gt;</comment>
                            <comment id="15875444" author="githubbot" created="Tue, 21 Feb 2017 06:40:12 +0000"  >&lt;p&gt;Github user zhijiangW commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen , already submit the modifications.&lt;/p&gt;</comment>
                            <comment id="15875727" author="githubbot" created="Tue, 21 Feb 2017 10:07:51 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think adding this safety net makes sense and protects against a corrupted state. &lt;/p&gt;

&lt;p&gt;    However, isn&apos;t the root cause of the described problem that the JobMaster-TaskExecutor communication does not tolerate a lost message? Maybe we should introduce an acknowledge message which signals the correct reception of the status message. If the response times out we can either retry to send it or fail.&lt;/p&gt;</comment>
                            <comment id="15877368" author="githubbot" created="Wed, 22 Feb 2017 03:07:05 +0000"  >&lt;p&gt;Github user zhijiangW commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @tillrohrmann , thank you for reviews and positive suggestions!&lt;/p&gt;

&lt;p&gt;    I try to explain the root case of this issue first:&lt;/p&gt;

&lt;p&gt;    From JobMaster side, it sends the cancel rpc message and gets the acknowledge from TaskExecutor, then the execution state transition to *&lt;b&gt;CANCELING&lt;/b&gt;*.&lt;/p&gt;

&lt;p&gt;    From TaskExecutor side, it would notify the final state to JobMaster before task exits. The *&lt;b&gt;notifyFinalState&lt;/b&gt;* can be divided into two steps:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Execute the *&lt;b&gt;RunAsync&lt;/b&gt;* message by akka actor and this is a tell action, and it will trigger to run *&lt;b&gt;unregisterTaskAndNotifyFinalState&lt;/b&gt;*.&lt;/li&gt;
	&lt;li&gt;In process of *&lt;b&gt;unregisterTaskAndNotifyFinalState&lt;/b&gt;&lt;b&gt;, it will trigger the rpc message of **updateTaskExecutionState&lt;/b&gt;* , and it is a ask action, so the mechanism can avoid lost message.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The problem is that it may cause OOM before trigger *&lt;b&gt;updateTaskExecutionState&lt;/b&gt;&lt;b&gt;, and this error is caught by **AkkaRpcActor&lt;/b&gt;* and does not do anything resulting in interrupting the following process. The *&lt;b&gt;updateTaskExecutionState&lt;/b&gt;* will not be executed anymore.&lt;/p&gt;

&lt;p&gt;    For the key point interaction between TaskExecutor and JobMaster, it should not tolerate lost message, and I agree with your above suggestions. So there may be two ideas for this improvement:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Enhance the robustness of *&lt;b&gt;notifyFinalState&lt;/b&gt;*, and the current rethrow OOM is an easy option, but it will cause the TaskExecutor exit&#65292;there should be other ways to make the cost reduction.&lt;/li&gt;
	&lt;li&gt;After get cancel acknowledge in JobMaster side, it will trigger a timeout to check the execution final state. If the execution has not entered the final state within timeout, the JobMaster can resend the acknowledge message to TaskExecutor to confirm the status.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    And I prefers the first way to just make it sense in one side, avoid the complex interaction between TaskExecutor and JobMaster. &lt;/p&gt;

&lt;p&gt;    Wish your further suggestions or any ideas.&lt;/p&gt;</comment>
                            <comment id="15877984" author="githubbot" created="Wed, 22 Feb 2017 10:50:00 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looking at this from another angle: If any Runnable that is scheduled ever lets an exception bubble out, can we still assume that the JobManager is in a sane state? Or should be actually make every uncaught exception in the RPC executors a fatal error and send a `notifyFatalError` to the `RpcEndpoint`?&lt;/p&gt;</comment>
                            <comment id="15878018" author="githubbot" created="Wed, 22 Feb 2017 11:15:40 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the clarification @zhijiangW. I know understand the problem that we effectively introduce via `RpcEndpoint.runAsync` another message which might get &quot;lost&quot; (e.g. due to OOM exception).&lt;/p&gt;

&lt;p&gt;    I agree with Stephan that it&apos;s hard to reason about the consistency of the `AkkaRpcActor&lt;br/&gt;
    s` internal state once we see an exception. The conservative approach would probably be to let it terminate or calling `notifyFatalError` to handle it.&lt;/p&gt;

&lt;p&gt;    Related to this is also how we handle exceptions in the `AkkaRpcActor.handleRpcInvocation`. There we catch all exception and simply send them to the caller. I think in this method we should only send the non-fatal exceptions back and terminate otherwise.&lt;/p&gt;

&lt;p&gt;    To follow a similar pattern for the `handleRunAsync` we could think about returning a `Future` which we return when calling `RpcEndpoint.runAsync` which will be completed with non fatal exceptions or if the `Runnable` has been executed. And in case that we see a fatal exception we terminate or call `notifyFatalError`. What do you think?&lt;/p&gt;</comment>
                            <comment id="15880168" author="githubbot" created="Thu, 23 Feb 2017 09:26:10 +0000"  >&lt;p&gt;Github user zhijiangW commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen , if the exception is bubbled out, and cause TaskExecutor to exit as a result, I think the JobMaster can be assumed in a sane state in final based on detection of TaskExecutor failure. &lt;/p&gt;

&lt;p&gt;    The current solution just refers to OOM error, maybe it can extend to any exceptions, because it is difficult to confirm the consistency of the internal state and the conservative approach is to let it terminate as @tillrohrmann said.&lt;/p&gt;

&lt;p&gt;    If I understand correctly from @tillrohrmann &apos;s suggestions, the *&lt;b&gt;RpcEndpoint.runAsync&lt;/b&gt;* method would modify to return a *&lt;b&gt;Future&lt;/b&gt;* that is similar with *&lt;b&gt;RpcEndpoint.callAsync&lt;/b&gt;&lt;b&gt;, but still a **Tell&lt;/b&gt;* action in akka. And this *&lt;b&gt;Future&lt;/b&gt;* should be set as a field in *&lt;b&gt;RunAsync&lt;/b&gt;* in order to get it when handle in *&lt;b&gt;AkkaRpcActor&lt;/b&gt;&lt;b&gt;. The **Future&lt;/b&gt;* can help to determine whether the message is executed successfully or lost to enhance the *&lt;b&gt;Tell&lt;/b&gt;* mechanism.  If the *&lt;b&gt;Future&lt;/b&gt;* with *&lt;b&gt;Tell&lt;/b&gt;* action is better than current ** RpcEndpoint .callAsync** which refers to *&lt;b&gt;Ask&lt;/b&gt;* action, I will try to do for that. Or another option is tolerating the lost message in current *&lt;b&gt;RpcEndpoint.runAsync&lt;/b&gt;&lt;b&gt;, and it should be used in such scenarios for efficiency and not safe. For the important interaction, it should resort to **RpcEndpoint.callAsync&lt;/b&gt;*. What do you think?&lt;/p&gt;
</comment>
                            <comment id="15902717" author="githubbot" created="Thu, 9 Mar 2017 09:04:42 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging this...&lt;/p&gt;</comment>
                            <comment id="15902944" author="githubbot" created="Thu, 9 Mar 2017 12:03:54 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3360&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15902946" author="stephanewen" created="Thu, 9 Mar 2017 12:04:57 +0000"  >&lt;p&gt;Fixed in 527eabdd4fb3e34b0698b53ec9a7fb1348882791&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 36 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3a8fj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>