<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:41:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14589] Redundant slot requests with the same AllocationID leads to inconsistent slot table</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14589</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;em&gt;NOTE: We found this issue in 1.6.2, but I checked the relevant code is still in the mainline. What I am not sure, however, is what other slot-related fixes after 1.6.2 (such as &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11059&quot; title=&quot;JobMaster may continue using an invalid slot if releasing idle slot meet a timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11059&quot;&gt;&lt;del&gt;FLINK-11059&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12863&quot; title=&quot;Race condition between slot offerings and AllocatedSlotReport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12863&quot;&gt;&lt;del&gt;FLINK-12863&lt;/del&gt;&lt;/a&gt;, etc) would prevent the initial cause of this issue from happening. So far, I have not found the related fix to the issue I am describing here, so opening this issue. Please feel free to deduplicate this if another one already covers it. Please note that we have already picked &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9912&quot; title=&quot;Release TaskExecutors from SlotPool if all slots have been removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9912&quot;&gt;&lt;del&gt;FLINK-9912&lt;/del&gt;&lt;/a&gt;, which turned out to be a major fix to slot allocation failure issue. I will note the ramification to that issue just in case others experience the same problem).&lt;/em&gt;&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Summary&quot;&gt;&lt;/a&gt;Summary&lt;/h2&gt;

&lt;p&gt;When &lt;b&gt;requestSlot&lt;/b&gt; is called from ResourceManager (RM) to TaskManager (TM), TM firstly reserves the requested slot marking it as ALLOCATED, offers the slot to JM, and marks the slot as ACTIVE once getting acknowledgement from JM. This three-way communication for slot allocation is identified by AllocationID, which is generated by JM initially. The way TM reserves a slot is by calling &lt;b&gt;TaskSlotTable.allocateSlot&lt;/b&gt; if the requested slot number (i.e., slot index) is free to use. The major data structure is &lt;b&gt;TaskSlot&lt;/b&gt; indexed by slot index. Once the slot is marked as ALLOCATED with a given AllocationID, it tries to update other maps such as &lt;b&gt;allocationIDTaskSlotMap&lt;/b&gt; keyed by AllocationID and &lt;b&gt;slotsPerJob&lt;/b&gt; keyed by JobID. Here when updating &lt;b&gt;allocationIDTaskSlotMap&lt;/b&gt;, it&apos;s directly using &lt;b&gt;allocationIDTaskSlotMap.put(allocationId, taskSlot)&lt;/b&gt;, which may overwrite existing entry, if one is already there with the same AllocationID. This would render inconsistency between &lt;b&gt;TaskSlot&lt;/b&gt; and &lt;b&gt;allocationIDTaskSlotMap&lt;/b&gt;, where the former says two slots are allocated by the same AllocationID and the latter says the AllocationID only has the latest task slot. With this state, once the slot is freed, &lt;b&gt;freeSlot&lt;/b&gt; is driven by AllocationID, so it fetches slot index (i.e., the latter one that has arrived later) from &lt;b&gt;allocationIDTaskSlotMap&lt;/b&gt;, marks the slot free, and removes it from &lt;b&gt;allocationIDTaskSlotMap&lt;/b&gt;. But still the old task slot is marked as allocated. This old task slot becomes zombie and can never be freed. This can cause permanent slot allocation failure if TM slots are statically and tightly provisioned and resource manager is not actively spawning new TMs where unavailable (e.g., Kubernetes without active mode integration, which is not yet available).&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Scenario&quot;&gt;&lt;/a&gt;Scenario&lt;/h2&gt;

&lt;p&gt;From my observation, the redundant slot requests with the same AllocationID and different slot indices should be rare but can happen with race condition especially when repeated fail-over and heartbeat timeout (primarily caused by transient resource overload, not permanent network partition/node outage) are taking place. The following is a detailed scenario, which could lead to this issue (AID is AllocationID):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;AID1 is requested from JM and put in the pending request queue in RM.&lt;/li&gt;
	&lt;li&gt;RM picks up slot number 1 (Slot1) from freeSlots and performs requestSlot with Slot1 and AID1. Here this slot request is on the fly.&lt;/li&gt;
	&lt;li&gt;In the meantime, Slot1 is occupied by AID2 in TM for a delayed slot request and TM sends slot report via heartbeat to RM saying Slot1 is already allocated with AID2.&lt;/li&gt;
	&lt;li&gt;RM&apos;s heartbeat handler identifies that Slot1 is occupied with a different AID (AID2) so that it should reject the pending request sent from step 2.&lt;/li&gt;
	&lt;li&gt;handleFailedSlotRequest puts the rejected AID1 to pending request again by retrying the slot request. Now it picks up another available slot, say Slot2. So, the retried slot request with Slot 2 and AID1 is on the fly.&lt;/li&gt;
	&lt;li&gt;In the meantime, Slot1 occupied by AID2 is freed (by any disconnection with JM, or releasing all the tasks in the slot on cancellation/failure - the latter was observed).&lt;/li&gt;
	&lt;li&gt;The in-flight slot request (Slot1, AID1) from step 2 arrives at TM, and it&apos;s succeeded as Slot1 is free to allocate. TM offers the Slot1 to JM, which acknowledges it so that TM marks Slot1 ACTIVE with AID1. As this point, allocationIDTaskSlotMap&lt;span class=&quot;error&quot;&gt;&amp;#91;AID1&amp;#93;&lt;/span&gt; = Slot1 in TM. JM&apos;s allocatedSlots&lt;span class=&quot;error&quot;&gt;&amp;#91;AID1&amp;#93;&lt;/span&gt; = Slot1.&lt;/li&gt;
	&lt;li&gt;The next in-flight slot request (Slot2, AID1) from step 5 arrives at TM. As Slot2 is still free, TM marks it ALLOCATED and offers Slot2 to JM and &lt;b&gt;&quot;overwrite allocationIDTaskSlotMap&lt;span class=&quot;error&quot;&gt;&amp;#91;AID1&amp;#93;&lt;/span&gt; to Slot2&quot;&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;In step 7, JM has allocatedSlots&lt;span class=&quot;error&quot;&gt;&amp;#91;AID1&amp;#93;&lt;/span&gt; = Slot1, which leads JM to reject the offer as the same AID is already occupied by another slot.&lt;/li&gt;
	&lt;li&gt;TM gets the rejected offer for (Slot2, AID1) and frees Slot2. As part of that, it removes allocationIDTaskSlotMap&lt;span class=&quot;error&quot;&gt;&amp;#91;AID1&amp;#93;&lt;/span&gt;. &lt;b&gt;Here Slot1 is still marked as ALLOCATED with AID1 but allocationIDTaskSlotMap contains nothing for AID1.&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;From this point on, RM believes that Slot1 is allocated for AID1, so is JM, proceeding task deployment with AID1. In TM, AID1 is not allocated at all due to allocationIDTaskSlotMap&lt;span class=&quot;error&quot;&gt;&amp;#91;AID1&amp;#93;&lt;/span&gt; = null. Task deployment is failed with &lt;b&gt;TaskSubmissionException(&quot;No task slot allocated for job ID&quot;)&lt;/b&gt;.&lt;/li&gt;
	&lt;li&gt;Any slot release from JM (by another heartbeat timeout) removes the allocated slot (Slot1, AID1) from allocatedSlots and availableSlots, where freeing slots with AID1 in TM is no-op due to allocationIDTaskSlotMap&lt;span class=&quot;error&quot;&gt;&amp;#91;AID1&amp;#93;&lt;/span&gt; = null.&lt;/li&gt;
	&lt;li&gt;Any further scheduling is failed with &lt;b&gt;NoResourceAvailableException(&quot;Could not allocate all requires slots within timeout&quot;)&lt;/b&gt;, unless active resource manager is used.&lt;/li&gt;
&lt;/ol&gt;


&lt;h2&gt;&lt;a name=&quot;Repromethod&quot;&gt;&lt;/a&gt;Repro method&lt;/h2&gt;

&lt;p&gt;The repro I have is a little stressed way than deterministic one, by having constantly failing app (also with not reacting to cancellation to prolong fail-over), with short heartbeat timeout (&amp;lt;=1s) to emulate resource overload without imposing arbitrary resource overloads (I enabled DEBUG log, which could also add a bit more load). Apart from repro test, the real applications that run into this issue are heavily loaded (high slot oversubscription) doing continuous fail-overs (by code error).&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Experiment&quot;&gt;&lt;/a&gt;Experiment&lt;/h2&gt;

&lt;p&gt;I&apos;ve tested the simple solution like having &lt;b&gt;TaskSlotTable.allocateSlot&lt;/b&gt; check if &lt;b&gt;allocationIDTaskSlotMap&lt;/b&gt; has an existing task slot entry for a requested AID, it can reject allocation up front, so that the redundant slot request can fail fast not reaching reservation and slot offer, preventing allocationIDTaskSlotMap overwrite and inconsistent allocation tables. In the above example, the fix can replace step 8, 9, and 10 with RM getting &lt;b&gt;SlotAllocationException&lt;/b&gt; on handling failed slot request. It may retry the pending request via handleFailedSlotRequest, but it would stop retrying once next heartbeat saying the pending slot was allocated by another AID or eventually slot request timeout. My test with the fix has run for a while hitting this race case multiple times and survived without slot allocation failure.&lt;/p&gt;

&lt;p&gt;As my experience may be in a bit old version (1.6.2), It would be good to discuss what other unexpected things happened and what would be other related issues that have been incorporated in mainline.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13265602">FLINK-14589</key>
            <summary>Redundant slot requests with the same AllocationID leads to inconsistent slot table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hwanju">Hwanju Kim</assignee>
                                    <reporter username="hwanju">Hwanju Kim</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 31 Oct 2019 18:04:04 +0000</created>
                <updated>Wed, 6 Nov 2019 22:56:09 +0000</updated>
                            <resolved>Wed, 6 Nov 2019 22:56:09 +0000</resolved>
                                    <version>1.6.3</version>
                                    <fixVersion>1.8.3</fixVersion>
                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16966466" author="till.rohrmann" created="Mon, 4 Nov 2019 08:30:02 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hwanju&quot; class=&quot;user-hover&quot; rel=&quot;hwanju&quot;&gt;hwanju&lt;/a&gt;. I think your analysis is spot on and it should be still a problem in Flink &amp;gt; 1.6. I think your solution approach is good and should solve the problem. Would you have time to open a PR against the master for it? I&apos;ve assigned you to the issue.&lt;/p&gt;</comment>
                            <comment id="16966989" author="hwanju" created="Mon, 4 Nov 2019 20:43:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, sure I will ping you once PR can be ready.&lt;/p&gt;</comment>
                            <comment id="16968780" author="till.rohrmann" created="Wed, 6 Nov 2019 22:56:09 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.10.0: 155885cc6d182bf0f6519a9992b21b957444b4fe&lt;br/&gt;
1.9.2: 6904fc6dc55d43ead2bf95f0cf495b3e98a53337&lt;br/&gt;
1.8.3: d25246920bddfd045528a8e683fc0b3ecca8a6a6&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z085bk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>