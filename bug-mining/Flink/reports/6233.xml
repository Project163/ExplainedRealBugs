<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:09:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-24607] SourceCoordinator may miss to close SplitEnumerator when failover frequently</title>
                <link>https://issues.apache.org/jira/browse/FLINK-24607</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We are having a connection leak problem when using mysql-cdc &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; source. We observed that many enumerators are not closed from the JM log.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#10140;  test123 cat jobmanager.log | grep &lt;span class=&quot;code-quote&quot;&gt;&quot;SourceCoordinator \[\] - Restoring SplitEnumerator&quot;&lt;/span&gt; | wc -l
     264
&#10140;  test123 cat jobmanager.log | grep &lt;span class=&quot;code-quote&quot;&gt;&quot;SourceCoordinator \[\] - Starting split enumerator&quot;&lt;/span&gt; | wc -l
     264
&#10140;  test123 cat jobmanager.log | grep &lt;span class=&quot;code-quote&quot;&gt;&quot;MySqlSourceEnumerator \[\] - Starting enumerator&quot;&lt;/span&gt; | wc -l
     263
&#10140;  test123 cat jobmanager.log | grep &lt;span class=&quot;code-quote&quot;&gt;&quot;SourceCoordinator \[\] - Closing SourceCoordinator&quot;&lt;/span&gt; | wc -l
     264
&#10140;  test123 cat jobmanager.log | grep &lt;span class=&quot;code-quote&quot;&gt;&quot;MySqlSourceEnumerator \[\] - Closing enumerator&quot;&lt;/span&gt; | wc -l
     195
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We added &quot;Closing enumerator&quot; log in &lt;tt&gt;MySqlSourceEnumerator#close()&lt;/tt&gt;, and &quot;Starting enumerator&quot; in &lt;tt&gt;MySqlSourceEnumerator#start()&lt;/tt&gt;. From the above result you can see that SourceCoordinator is restored and closed 264 times, split enumerator is started 264 but only closed 195 times. It seems that &lt;tt&gt;SourceCoordinator&lt;/tt&gt; misses to close enumerator when job failover frequently. &lt;/p&gt;

&lt;p&gt;I also went throught the code of &lt;tt&gt;SourceCoordinator&lt;/tt&gt; and found some suspicious point:&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;started&lt;/tt&gt; flag and  &lt;tt&gt;enumerator&lt;/tt&gt; is assigned in the main thread, however &lt;tt&gt;SourceCoordinator#close()&lt;/tt&gt; is executed async by &lt;tt&gt;DeferrableCoordinator#closeAsync&lt;/tt&gt;.  That means the close method will check the &lt;tt&gt;started&lt;/tt&gt; and &lt;tt&gt;enumerator&lt;/tt&gt; variable async. Is there any concurrency problem here which mean lead to dirty read and miss to close the &lt;tt&gt;enumerator&lt;/tt&gt;? &lt;/p&gt;

&lt;p&gt;I&apos;m still not sure, because it&apos;s hard to reproduce locally, and we can&apos;t deploy a custom flink version to production env. &lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;: &lt;a href=&quot;https://github.com/ververica/flink-cdc-connectors&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ververica/flink-cdc-connectors&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13407655">FLINK-24607</key>
            <summary>SourceCoordinator may miss to close SplitEnumerator when failover frequently</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="becket_qin">Jiangjie Qin</assignee>
                                    <reporter username="jark">Jark Wu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 21 Oct 2021 03:33:42 +0000</created>
                <updated>Thu, 24 Feb 2022 01:55:28 +0000</updated>
                            <resolved>Thu, 24 Feb 2022 01:55:28 +0000</resolved>
                                    <version>1.13.3</version>
                                    <fixVersion>1.14.4</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                    <fixVersion>1.13.7</fixVersion>
                                    <component>Connectors / Common</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17474535" author="davidmoravek" created="Wed, 12 Jan 2022 13:44:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jqin&quot; class=&quot;user-hover&quot; rel=&quot;jqin&quot;&gt;jqin&lt;/a&gt; Do you have any thoughts on this one?&lt;/p&gt;</comment>
                            <comment id="17475066" author="becket_qin" created="Thu, 13 Jan 2022 02:52:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmvk&quot; class=&quot;user-hover&quot; rel=&quot;dmvk&quot;&gt;dmvk&lt;/a&gt; I am not sure about the exact cause of this issue. But I went through the SourceCoordinator protocol a couple of days earlier and there might be a threading bug. I will verify that first and see if that is related to this ticket.&lt;/p&gt;</comment>
                            <comment id="17489273" author="becket_qin" created="Wed, 9 Feb 2022 06:16:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmvk&quot; class=&quot;user-hover&quot; rel=&quot;dmvk&quot;&gt;dmvk&lt;/a&gt; Sorry I did not notice the attached log file earlier. From the log, it looks that the split enumerators are sometimes not closed because the coordinator closing sequence timed out before it reaches the code block that closes the enumerator.&lt;/p&gt;

&lt;p&gt;More specifically, either the main executor or worker executor is performing some time-consuming task which causes the executor shutdown to take more than 60 seconds. After that closing sequence will be interrupted and the rest of the closing sequence are skipped.&lt;/p&gt;

&lt;p&gt;What we can do here is to put the split enumerator closing sequence in the finally block in &lt;tt&gt;SourceCoordinator.close()&lt;/tt&gt;. It ensures that &lt;tt&gt;enumerator.close()&lt;/tt&gt; will be invoked. Also, we will need to make sure that the executors actually exits even if the split enumerator executes some tasks running indefinitely.&lt;/p&gt;

&lt;p&gt;I&apos;ll submit a patch shortly.&lt;/p&gt;</comment>
                            <comment id="17497109" author="becket_qin" created="Thu, 24 Feb 2022 01:55:17 +0000"  >&lt;p&gt;Patch merged.&lt;/p&gt;

&lt;p&gt;Master:&#160;0f19c2472c54aac97e4067f5398731ab90036d1a&lt;/p&gt;

&lt;p&gt;release-1.14:&#160;0a76d632f33d9a69df87457a63043bd7f609ed40&lt;/p&gt;

&lt;p&gt;release-1.13:&#160;6fb7807b20cba05437a7b570c704d643432745eb&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13035175" name="jobmanager.log" size="4889782" author="jark" created="Thu, 21 Oct 2021 03:33:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0w16w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>