<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:17:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-32049] CoordinatedSourceRescaleITCase.testDownscaling fails on AZP</title>
                <link>https://issues.apache.org/jira/browse/FLINK-32049</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;CoordinatedSourceRescaleITCase.testDownscaling fails with&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;May 08 03:19:14 [ERROR] Failures: 
May 08 03:19:14 [ERROR]   CoordinatedSourceRescaleITCase.testDownscaling:75-&amp;gt;resumeCheckpoint:107 
May 08 03:19:14 Multiple Failures (1 failure)
May 08 03:19:14 -- failure 1 --
May 08 03:19:14 [Any cause contains message &apos;successfully restored checkpoint&apos;] 
May 08 03:19:14 Expecting any element of:
May 08 03:19:14   [org.apache.flink.runtime.client.JobExecutionException: Job execution failed.
May 08 03:19:14 	at org.apache.flink.runtime.jobmaster.JobResult.toJobExecutionResult(JobResult.java:144)
May 08 03:19:14 	at org.apache.flink.runtime.minicluster.MiniClusterJobClient.lambda$getJobExecutionResult$3(MiniClusterJobClient.java:141)
May 08 03:19:14 	at java.util.concurrent.CompletableFuture.uniApply(CompletableFuture.java:616)
May 08 03:19:14 	...(45 remaining lines not displayed - this can be changed with Assertions.setMaxStackTraceElementsDisplayed),
May 08 03:19:14     org.apache.flink.runtime.JobException: Recovery is suppressed by NoRestartBackoffTimeStrategy
May 08 03:19:14 	at org.apache.flink.runtime.executiongraph.failover.flip1.ExecutionFailureHandler.handleFailure(ExecutionFailureHandler.java:139)
May 08 03:19:14 	at org.apache.flink.runtime.executiongraph.failover.flip1.ExecutionFailureHandler.getFailureHandlingResult(ExecutionFailureHandler.java:83)
May 08 03:19:14 	at org.apache.flink.runtime.scheduler.DefaultScheduler.recordTaskFailure(DefaultScheduler.java:258)
May 08 03:19:14 	...(35 remaining lines not displayed - this can be changed with Assertions.setMaxStackTraceElementsDisplayed),
May 08 03:19:14     java.lang.IllegalStateException: This executor has been registered.
May 08 03:19:14 	at org.apache.flink.util.Preconditions.checkState(Preconditions.java:193)
May 08 03:19:14 	at org.apache.flink.runtime.checkpoint.channel.ChannelStateWriteRequestExecutorImpl.registerSubtask(ChannelStateWriteRequestExecutorImpl.java:341)
May 08 03:19:14 	at org.apache.flink.runtime.checkpoint.channel.ChannelStateWriteRequestExecutorFactory.getOrCreateExecutor(ChannelStateWriteRequestExecutorFactory.java:63)
May 08 03:19:14 	...(17 remaining lines not displayed - this can be changed with Assertions.setMaxStackTraceElementsDisplayed)]
May 08 03:19:14 to satisfy the given assertions requirements but none did:
May 08 03:19:14 
May 08 03:19:14 org.apache.flink.runtime.client.JobExecutionException: Job execution failed.
May 08 03:19:14 	at org.apache.flink.runtime.jobmaster.JobResult.toJobExecutionResult(JobResult.java:144)
May 08 03:19:14 	at org.apache.flink.runtime.minicluster.MiniClusterJobClient.lambda$getJobExecutionResult$3(MiniClusterJobClient.java:141)
May 08 03:19:14 	at java.util.concurrent.CompletableFuture.uniApply(CompletableFuture.java:616)
May 08 03:19:14 	...(45 remaining lines not displayed - this can be changed with Assertions.setMaxStackTraceElementsDisplayed)
May 08 03:19:14 error: 
May 08 03:19:14 Expecting throwable message:
May 08 03:19:14   &quot;Job execution failed.&quot;
May 08 03:19:14 to contain:
May 08 03:19:14   &quot;successfully restored checkpoint&quot;
May 08 03:19:14 but did not.
May 08 03:19:14 

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=48772&amp;amp;view=logs&amp;amp;j=fc7981dc-d266-55b0-5fff-f0d0a2294e36&amp;amp;t=1a9b228a-3e0e-598f-fc81-c321539dfdbf&amp;amp;l=7191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=48772&amp;amp;view=logs&amp;amp;j=fc7981dc-d266-55b0-5fff-f0d0a2294e36&amp;amp;t=1a9b228a-3e0e-598f-fc81-c321539dfdbf&amp;amp;l=7191&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13535687">FLINK-32049</key>
            <summary>CoordinatedSourceRescaleITCase.testDownscaling fails on AZP</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fanrui">Rui Fan</assignee>
                                    <reporter username="Sergey Nuyanzin">Sergey Nuyanzin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Wed, 10 May 2023 18:48:45 +0000</created>
                <updated>Thu, 13 Jul 2023 11:03:37 +0000</updated>
                            <resolved>Thu, 13 Jul 2023 11:03:37 +0000</resolved>
                                    <version>1.18.0</version>
                    <version>1.17.1</version>
                                    <fixVersion>1.18.0</fixVersion>
                    <fixVersion>1.17.2</fixVersion>
                                    <component>Connectors / Common</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17731571" author="sergey nuyanzin" created="Mon, 12 Jun 2023 11:24:55 +0000"  >&lt;p&gt;Same for testUpscaling&lt;br/&gt;
&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49750&amp;amp;view=logs&amp;amp;j=fc7981dc-d266-55b0-5fff-f0d0a2294e36&amp;amp;t=1a9b228a-3e0e-598f-fc81-c321539dfdbf&amp;amp;l=7575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49750&amp;amp;view=logs&amp;amp;j=fc7981dc-d266-55b0-5fff-f0d0a2294e36&amp;amp;t=1a9b228a-3e0e-598f-fc81-c321539dfdbf&amp;amp;l=7575&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17741903" author="weijie guo" created="Tue, 11 Jul 2023 08:39:56 +0000"  >&lt;p&gt;I have some suspicion that this is because &lt;tt&gt;ChannelStateWriteRequestExecutorFactory#getOrCreateExecutor&lt;/tt&gt; may have obtained an already registered executor. That is to say, there is a possibility that &lt;tt&gt;isRegistering&lt;/tt&gt; has become false, but &lt;tt&gt;onRegistered&lt;/tt&gt; has not been called yet, so the executor is still not null. &lt;/p&gt;

&lt;p&gt;I am not very familiar with related codes, so I cannot fully confirm this argument. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt; Can you help confirm this? If there is indeed a possibility, I&apos;d like to fix this.&lt;/p&gt;</comment>
                            <comment id="17742285" author="fanrui" created="Wed, 12 Jul 2023 06:28:54 +0000"  >&lt;p&gt;Thanks report this JIRA, and thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt; &apos;s analysis, there is indeed a thread safety bug here.&lt;/p&gt;

&lt;p&gt;There are three cases that update registering from true to false:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Registered maxSubtasksPerChannelStateFile subtasks to the executor&lt;/li&gt;
	&lt;li&gt;checkpoint started&lt;/li&gt;
	&lt;li&gt;A subtask is released&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Offline discussed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt; , the case1 is thread safe, the case2 and case3 are thread-unsafe.&lt;/p&gt;

&lt;h1&gt;&lt;a name=&quot;Thereasonaboutthisbug%3A&quot;&gt;&lt;/a&gt;The reason about this bug:&lt;/h1&gt;

&lt;p&gt;When one subtask is closing, it will call the ChannelStateWriteRequestExecutorImpl#releaseSubtask. The &lt;a href=&quot;https://github.com/apache/flink/blob/2dfff436c09821fb658bf8d289206b9ef85bb25b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateWriteRequestExecutorImpl.java#L390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;releaseSubtask method&lt;/a&gt; will hold 2 locks at the different time.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The first one is ChannelStateWriteRequestExecutorImpl#lock, and update the isRegistering from true to false.&lt;/li&gt;
	&lt;li&gt;The second one is onRegistered.accept(this) will hold ChannelStateWriteRequestExecutorFactory#lock and update the ChannelStateWriteRequestExecutorFactory#executor&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;However, these 2 locks are held at the different time. The following calls will meet a bug:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Subtask 1 finished the first step of releaseSubtask, and doesn&apos;t hold the second lock.&lt;/li&gt;
	&lt;li&gt;Subtask 2 is starting, and call the executor#registerSubtask&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Subtask2 will throw &lt;b&gt;&lt;em&gt;This executor has been registered&lt;/em&gt;&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;This bug can be reproduced by the unit test. I have added a unit test with multiple threads to trigger this bug. After the &lt;a href=&quot;https://github.com/apache/flink/pull/22983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;, the test is fine.&lt;/p&gt;

&lt;h1&gt;&lt;a name=&quot;Question&quot;&gt;&lt;/a&gt;Question&lt;/h1&gt;

&lt;p&gt;Case2 and case3 are thread-unsafe and bug, however, I didn&apos;t see they happen from CI log. I uploaded the log with this exception : `java.lang.IllegalStateException: This executor has been registered.` The detailed log in mvn-3.log.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17742689" author="fanrui" created="Thu, 13 Jul 2023 07:43:15 +0000"  >&lt;p&gt;Merged via:&lt;br/&gt;
&amp;lt;master: 1.18&amp;gt; bc4c21e47040360aab5bcb0f2c18b907b60e7838&lt;br/&gt;
1.17 : c8b6c79ee57050cea8be81f56b707ccbcc0fdf4d&lt;/p&gt;</comment>
                            <comment id="17742758" author="fanrui" created="Thu, 13 Jul 2023 11:03:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Sergey+Nuyanzin&quot; class=&quot;user-hover&quot; rel=&quot;Sergey Nuyanzin&quot;&gt;Sergey Nuyanzin&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt;, thanks for the reporting.&lt;/p&gt;

&lt;p&gt;We have fixed the bug. In theory, this exception cannot happen again. I close this JIRA first, please cc me if it happens again.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13061275" name="logs-cron_azure-test_cron_azure_connect_2-1686196685.zip" size="227967" author="fanrui" created="Wed, 12 Jul 2023 06:33:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 17 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ht5c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>