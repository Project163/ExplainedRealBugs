<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:11:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-28817] NullPointerException in HybridSource when restoring from checkpoint</title>
                <link>https://issues.apache.org/jira/browse/FLINK-28817</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Scenario:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;CheckpointCoordinator - Completed checkpoint 14 for job 00000000000000000000000000000000&lt;/li&gt;
	&lt;li&gt;HybridSource successfully completed processing a few SourceFactories, that reads from s3&lt;/li&gt;
	&lt;li&gt;HybridSourceSplitEnumerator.switchEnumerator failed with&#160;com.amazonaws.SdkClientException: Unable to execute HTTP request: Read timed out.&#160;This is intermittent error, it is usually fixed, when Flink recover from checkpoint &amp;amp; repeat the operation.&lt;/li&gt;
	&lt;li&gt;Flink starts recovering from checkpoint,&#160;&lt;/li&gt;
	&lt;li&gt;HybridSourceSplitEnumerator receives SourceReaderFinishedEvent{sourceIndex=-1}&lt;/li&gt;
	&lt;li&gt;Processing this event cause&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;2022/08/08 08:39:34.862 ERROR o.a.f.r.s.c.SourceCoordinator - Uncaught exception in the SplitEnumerator for Source Source: hybrid-source while handling operator event SourceEventWrapper[SourceReaderFinishedEvent&lt;/p&gt;

{sourceIndex=-1}

&lt;p&gt;] from subtask 6. Triggering job failover.&lt;br/&gt;
java.lang.NullPointerException: Source for index=0 is not available from sources: {788=org.apache.flink.connector.file.src.SppFileSource@5a3803f3}&lt;br/&gt;
at org.apache.flink.util.Preconditions.checkNotNull(Preconditions.java:104)&lt;br/&gt;
at org.apache.flink.connector.base.source.hybridspp.SwitchedSources.sourceOf(SwitchedSources.java:36)&lt;br/&gt;
at org.apache.flink.connector.base.source.hybridspp.HybridSourceSplitEnumerator.sendSwitchSourceEvent(HybridSourceSplitEnumerator.java:152)&lt;br/&gt;
at org.apache.flink.connector.base.source.hybridspp.HybridSourceSplitEnumerator.handleSourceEvent(HybridSourceSplitEnumerator.java:226)&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;I&apos;m running my version of the Hybrid Sources with additional logging, so line numbers &amp;amp; some names could be different from Flink Github.&lt;/p&gt;

&lt;p&gt;My Observation: the problem is intermittent, sometimes it works ok, i.e. SourceReaderFinishedEvent comes with correct sourceIndex. As I see from my log, it happens if my SourceFactory.create() &#160;is executed BEFORE HybridSourceSplitEnumerator - handleSourceEvent SourceReaderFinishedEvent{sourceIndex=-1}.&lt;br/&gt;
If&#160; HybridSourceSplitEnumerator - handleSourceEvent is executed before my SourceFactory.create(), then sourceIndex=-1 in SourceReaderFinishedEvent&lt;/p&gt;

&lt;p&gt;Preconditions-checkNotNull-error log from JobMgr is attached&lt;/p&gt;</description>
                <environment></environment>
        <key id="13475253">FLINK-28817</key>
            <summary>NullPointerException in HybridSource when restoring from checkpoint</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zhongqishang">Qishang Zhong</assignee>
                                    <reporter username="Benenson">Michael</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 5 Aug 2022 00:31:11 +0000</created>
                <updated>Tue, 16 Aug 2022 20:31:20 +0000</updated>
                            <resolved>Fri, 12 Aug 2022 23:55:50 +0000</resolved>
                                    <version>1.14.4</version>
                    <version>1.15.1</version>
                                    <fixVersion>1.16.0</fixVersion>
                    <fixVersion>1.15.2</fixVersion>
                                    <component>Connectors / Common</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17576669" author="zhongqishang" created="Mon, 8 Aug 2022 09:49:19 +0000"  >&lt;p&gt;I encountered the similar problem.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thw&quot; class=&quot;user-hover&quot; rel=&quot;thw&quot;&gt;thw&lt;/a&gt; Please take a look the following case.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;org.apache.flink.connector.base.source.hybrid.HybridSourceSplitEnumeratorTest&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testRestoreEnumeratorWith2ndSource() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    setupEnumeratorAndTriggerSourceSwitch();
    HybridSourceEnumeratorState enumeratorState = enumerator.snapshotState(0);
    MockSplitEnumerator underlyingEnumerator = getCurrentEnumerator(enumerator);
    assertThat(
            (List&amp;lt;MockSourceSplit&amp;gt;)
                    Whitebox.getInternalState(underlyingEnumerator, &lt;span class=&quot;code-quote&quot;&gt;&quot;splits&quot;&lt;/span&gt;))
            .hasSize(0);
    enumerator =
            (HybridSourceSplitEnumerator) source.restoreEnumerator(context, enumeratorState);
    enumerator.start();
    enumerator.handleSourceEvent(SUBTASK0, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SourceReaderFinishedEvent(-1));
    underlyingEnumerator = getCurrentEnumerator(enumerator);
    assertThat(
            (List&amp;lt;MockSourceSplit&amp;gt;)
                    Whitebox.getInternalState(underlyingEnumerator, &lt;span class=&quot;code-quote&quot;&gt;&quot;splits&quot;&lt;/span&gt;))
            .hasSize(0);
}
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17576998" author="benenson" created="Mon, 8 Aug 2022 22:17:18 +0000"  >&lt;p&gt;Clarification for the problem:&lt;/p&gt;

&lt;p&gt;1. &amp;#8211; &#160;HybridSourceSplitEnumerator.switchEnumerator failed with&#160;&lt;br/&gt;
com.amazonaws.SdkClientException: Unable to execute HTTP request: Read timed out&lt;br/&gt;
Caused by: java.net.SocketTimeoutException: Read timed out&lt;br/&gt;
This is intermittent error, it is usually fixed, when Flink recover from checkpoint &amp;amp; repeat the operation&lt;/p&gt;

&lt;p&gt;2. &amp;#8211; &#160;Flink starts recovering from checkpoint:&lt;br/&gt;
CheckpointCoordinator - Restoring job 00000000000000000000000000000000 from Checkpoint&lt;br/&gt;
SourceCoordinator - Closing SourceCoordinator for source Source: hybrid-source.&lt;br/&gt;
SourceCoordinator - Restoring SplitEnumerator of source Source: hybrid-source from checkpoint.&lt;br/&gt;
SourceCoordinator - Starting split enumerator for source Source: hybrid-source.&lt;br/&gt;
HybridSourceSplitEnumerator - Restoring enumerator for sourceIndex=788&lt;br/&gt;
HybridSourceSplitEnumerator - Starting enumerator for sourceIndex=788&lt;/p&gt;

&lt;p&gt;3. &amp;#8211; &#160;HybridSourceSplitEnumerator receives SourceReaderFinishedEvent{sourceIndex=-1}&lt;br/&gt;
HybridSourceSplitEnumerator - handleSourceEvent SourceReaderFinishedEvent{sourceIndex=-1} subtask=6&lt;/p&gt;

&lt;p&gt;4. &amp;#8211; &#160;Processing this event cause&#160;&lt;br/&gt;
2022/08/08 08:39:34.862 ERROR o.a.f.r.s.c.SourceCoordinator - Uncaught exception in the SplitEnumerator for Source Source: hybrid-source while handling operator event SourceEventWrapper&lt;span class=&quot;error&quot;&gt;&amp;#91;SourceReaderFinishedEvent\{sourceIndex=-1}&amp;#93;&lt;/span&gt; from subtask 6. Triggering job failover.&lt;br/&gt;
java.lang.NullPointerException: Source for index=0 is not available from sources: {788=org.apache.flink.connector.file.src.SppFileSource@5a3803f3}&lt;br/&gt;
at org.apache.flink.util.Preconditions.checkNotNull(Preconditions.java:104)&lt;br/&gt;
at org.apache.flink.connector.base.source.hybridspp.SwitchedSources.sourceOf(SwitchedSources.java:36)&lt;br/&gt;
at org.apache.flink.connector.base.source.hybridspp.HybridSourceSplitEnumerator.sendSwitchSourceEvent(HybridSourceSplitEnumerator.java:152)&lt;br/&gt;
at org.apache.flink.connector.base.source.hybridspp.HybridSourceSplitEnumerator.handleSourceEvent(HybridSourceSplitEnumerator.java:226)&lt;br/&gt;
at org.apache.flink.runtime.source.coordinator.SourceCoordinator.lambda$handleEventFromOperator$1(SourceCoordinator.java:182)&lt;br/&gt;
at org.apache.flink.runtime.source.coordinator.SourceCoordinator.lambda$runInEventLoop$8(SourceCoordinator.java:344)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;/p&gt;

&lt;p&gt;I&apos;m running my version of the Hybrid Sources with additional logging, so line numbers &amp;amp; some names could be different from Flink Github.&lt;/p&gt;

&lt;p&gt;My Observation: the problem is intermittent, sometimes it works ok, i.e. SourceReaderFinishedEvent comes with correct sourceIndex. As I see from my log, it happens if my SourceFactory.create() &#160;is executed BEFORE HybridSourceSplitEnumerator - handleSourceEvent SourceReaderFinishedEvent{sourceIndex=-1}.&lt;br/&gt;
If&#160; HybridSourceSplitEnumerator - handleSourceEvent is executed before my SourceFactory.create(), then sourceIndex=-1 in SourceReaderFinishedEvent&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thw&quot; class=&quot;user-hover&quot; rel=&quot;thw&quot;&gt;thw&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mason6345&quot; class=&quot;user-hover&quot; rel=&quot;mason6345&quot;&gt;mason6345&lt;/a&gt;&#160;could you, please, look at this issue?&lt;/p&gt;

&lt;p&gt;Preconditions-checkNotNull-error log from JobMgr is attached&lt;/p&gt;</comment>
                            <comment id="17577822" author="zhongqishang" created="Wed, 10 Aug 2022 07:11:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thw&quot; class=&quot;user-hover&quot; rel=&quot;thw&quot;&gt;thw&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I tried to open a PR for this issue.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Benenson&quot; class=&quot;user-hover&quot; rel=&quot;Benenson&quot;&gt;Benenson&lt;/a&gt; has already test for this PR.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17578507" author="thw" created="Thu, 11 Aug 2022 14:28:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Benenson&quot; class=&quot;user-hover&quot; rel=&quot;Benenson&quot;&gt;Benenson&lt;/a&gt; thanks for investigating this issue. I think that has to do with the reader not having any restored splits (most likely because none were previously assigned) and therefore reporting -1 back to the enumerator. Let me check what the correct fix for this is.&lt;/p&gt;</comment>
                            <comment id="17578893" author="nicholasjiang" created="Fri, 12 Aug 2022 09:55:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thw&quot; class=&quot;user-hover&quot; rel=&quot;thw&quot;&gt;thw&lt;/a&gt;, IMO, this pull request could also fixed the bug of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-26938&quot; title=&quot;HybridSource recovery from savepoint fails When flink parallelism is greater than the number of Kafka partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-26938&quot;&gt;&lt;del&gt;FLINK-26938&lt;/del&gt;&lt;/a&gt; , right?&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhongqishang&quot; class=&quot;user-hover&quot; rel=&quot;zhongqishang&quot;&gt;zhongqishang&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17579190" author="thw" created="Fri, 12 Aug 2022 23:54:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nicholasjiang&quot; class=&quot;user-hover&quot; rel=&quot;nicholasjiang&quot;&gt;nicholasjiang&lt;/a&gt; I believe it does. Can you please verify and close &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-26938&quot; title=&quot;HybridSource recovery from savepoint fails When flink parallelism is greater than the number of Kafka partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-26938&quot;&gt;&lt;del&gt;FLINK-26938&lt;/del&gt;&lt;/a&gt; if so?&lt;/p&gt;</comment>
                            <comment id="17579192" author="thw" created="Fri, 12 Aug 2022 23:56:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Benenson&quot; class=&quot;user-hover&quot; rel=&quot;Benenson&quot;&gt;Benenson&lt;/a&gt; thank you for the thorough investigation!&lt;/p&gt;</comment>
                            <comment id="17580458" author="dannycranmer" created="Tue, 16 Aug 2022 20:31:20 +0000"  >&lt;ul&gt;
	&lt;li&gt;Merged commit &lt;a href=&quot;https://github.com/apache/flink/commit/6e80d90b1611499375cf74b45a0828db383aac7d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;6e80d90&lt;/tt&gt;&lt;/a&gt;&#160;into&#160;apache:master&lt;/li&gt;
	&lt;li&gt;Merged commit &lt;a href=&quot;https://github.com/apache/flink/commit/e5570e3e33ac33fd1b31d38c86ac6a291e7bc47e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;e5570e3&lt;/tt&gt;&lt;/a&gt;&#160;into&#160;apache:release-1.15&#160;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="13047897" name="Preconditions-checkNotNull-error.zip" size="294597" author="Benenson" created="Mon, 8 Aug 2022 22:19:01 +0000"/>
                            <attachment id="13047737" name="bf-29-JM-err-analysis.log" size="17595" author="Benenson" created="Fri, 5 Aug 2022 00:30:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17how:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>