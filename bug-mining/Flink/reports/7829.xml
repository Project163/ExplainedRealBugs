<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:22:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-37747] GlobalCommitterOperator cannot commit after scaling writer/committer</title>
                <link>https://issues.apache.org/jira/browse/FLINK-37747</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Hey,&lt;/p&gt;

&lt;p&gt;Our FLINK job stopped writing into Delta table with FLINK Delta connector frequently. After checking the issue, we found in GlobalCommitterOperator, in &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/streaming/runtime/operators/sink/GlobalCommitterOperator.java#L207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt; function, it was returned directly when checking some checkpoint has finished or not(this &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/streaming/runtime/operators/sink/GlobalCommitterOperator.java#L211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;). The issue was happened when:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;auto-scaler scales up chained writer/committer(the direct upstream operator of GlobalCommitterOperator)&lt;/li&gt;
	&lt;li&gt;job ran limited TM first with lower parallelism for writer/committer, and then writer/committer was scaled up to higher parallelism&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After debugging with more logs, we found the cause of the issue. An example is:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;for checkpoint 3, FLINK job completed successfully with 3 writer/committer in parallel
	&lt;ul&gt;
		&lt;li&gt;All committable objects in writer/committer were saved into checkpoint state in checkpoint 3&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;writer/committer was scaled up to 5 parallel tasks&lt;/li&gt;
	&lt;li&gt;writer/committer restore state from checkpoint 3, they will emit committable objects from checkpoint 3. code is &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/streaming/runtime/operators/sink/CommitterOperator.java#L139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;
	&lt;ul&gt;
		&lt;li&gt;latest parallelism of writer/committer is used, which is 5 in CommittableSummary. Code is &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/streaming/runtime/operators/sink/CommitterOperator.java#L186&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;GlobalCommitterOpeartor received committable summary from writer/committer, it knows:
	&lt;ul&gt;
		&lt;li&gt;5 parallel writer/committer from upstreams&lt;/li&gt;
		&lt;li&gt;it will look for committable summary from 5 upstream writer/committer&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;3 writer/committers emit CommittableSummary to global committer operator as only 3 restore state from checkpoint 3&lt;/li&gt;
	&lt;li&gt;Global committer operator stuck here forever as it looks for committable summary for 5 subtasks from upstream operator&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We have a quick solution for this case and raise a PR to fix this.&#160;&lt;/p&gt;

&lt;p&gt;We are using FLINK 1.20 but we found the issue is still existed in master branch.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13616639">FLINK-37747</key>
            <summary>GlobalCommitterOperator cannot commit after scaling writer/committer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="david2025">David</assignee>
                                    <reporter username="david2025">David</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 28 Apr 2025 23:03:52 +0000</created>
                <updated>Mon, 3 Nov 2025 08:25:29 +0000</updated>
                            <resolved>Thu, 8 May 2025 06:28:53 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>1.19.2</version>
                    <version>1.20.1</version>
                    <version>2.1.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>1.20.3</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17948051" author="arvid" created="Tue, 29 Apr 2025 07:57:22 +0000"  >&lt;p&gt;Thank you for raising the issue and your detailed analysis. Could you please add the exact Flink version? Flink 1.20.1 has some fixes around the sink.&lt;/p&gt;

&lt;p&gt;From a look at your PR, I don&apos;t think that your fix resolves the issue sufficiently well. I guess a proper IT Case should help clarify that. Do you need help to craft one?&lt;/p&gt;

&lt;p&gt;I&apos;ll comment on the PR.&lt;/p&gt;</comment>
                            <comment id="17948068" author="JIRAUSER309542" created="Tue, 29 Apr 2025 08:40:45 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt; . We are using FLINK 1.20.1. Could you give me an example of IT case? I can try to make one and update the PR.&lt;/p&gt;</comment>
                            <comment id="17948176" author="arvid" created="Tue, 29 Apr 2025 14:04:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/pull/26518#issuecomment-2839056740&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/26518#issuecomment-2839056740&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17949356" author="JIRAUSER309542" created="Sun, 4 May 2025 23:15:44 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt; Thanks for reviewing the PR. I updated the PR accordingly. Do you think the PR is OK to merge?&lt;/p&gt;

&lt;p&gt;This issue is also in 1.20.1 release. Do you have guideline to apply the fix to 1.20.1 release? Thanks!&lt;/p&gt;</comment>
                            <comment id="17949400" author="arvid" created="Mon, 5 May 2025 09:52:15 +0000"  >&lt;p&gt;I replied &lt;a href=&quot;https://github.com/apache/flink/pull/26518#pullrequestreview-2813896882&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/26518#pullrequestreview-2813896882&lt;/a&gt; . Almost good to be merged.&#160;&lt;/p&gt;

&lt;p&gt;For backports, we usually wait for the main patch to be merged and then we checkout&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;release-2.0 into a new branch and cherry-pick the commit, open new PR, if there are adjustments needed beyond import fixes, please point them out&lt;/li&gt;
	&lt;li&gt;same for release-1.20&lt;/li&gt;
	&lt;li&gt;same for release-1.19 (might not be needed anymore)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Note for backports, please ignore/remove the PR template and just point to the original PR. Here is an example &lt;a href=&quot;https://github.com/apache/flink/pull/26457&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/26457&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17950147" author="JIRAUSER309542" created="Wed, 7 May 2025 23:14:07 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt; for the review! Updated the PR &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17950197" author="arvid" created="Thu, 8 May 2025 06:28:53 +0000"  >&lt;p&gt;Merged into master as fce5cb34aec2f384b551677f69b272f9d36a7ca0.&lt;/p&gt;</comment>
                            <comment id="17950198" author="arvid" created="Thu, 8 May 2025 06:29:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=david2025&quot; class=&quot;user-hover&quot; rel=&quot;david2025&quot;&gt;david2025&lt;/a&gt; I just merged your PR. Can you please do the backports as well? Ideally you cherry-pick fce5cb34aec2f384b551677f69b272f9d36a7ca0.&lt;/p&gt;</comment>
                            <comment id="17950492" author="arvid" created="Fri, 9 May 2025 10:39:19 +0000"  >&lt;p&gt;There are some discussions around new patch release for 1.20 and 1.19. Are you able to follow-up &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=david2025&quot; class=&quot;user-hover&quot; rel=&quot;david2025&quot;&gt;david2025&lt;/a&gt; for the backports or should I do them?&lt;/p&gt;</comment>
                            <comment id="17950839" author="JIRAUSER309542" created="Mon, 12 May 2025 05:50:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt; yep, I am making PRs to 1.20 and 1.19.&lt;/p&gt;</comment>
                            <comment id="17950842" author="JIRAUSER309542" created="Mon, 12 May 2025 06:44:07 +0000"  >&lt;p&gt;hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt; i made a PR to path release-2.0: &lt;a href=&quot;https://github.com/apache/flink/pull/26546&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/26546&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;for release-1.20 and release-1.19, some extra commits are needed and I am not sure which commit log should be included. Can you help on this? Thank you!&lt;/p&gt;</comment>
                            <comment id="18021420" author="martijnvisser" created="Fri, 19 Sep 2025 13:44:39 +0000"  >&lt;p&gt;master: fce5cb34aec2f384b551677f69b272f9d36a7ca0&lt;br/&gt;
release-1.20: 5a151f6c49e2483ed225bf007e818f95c3a2eae8&lt;/p&gt;</comment>
                            <comment id="18032773" author="JIRAUSER310966" created="Fri, 24 Oct 2025 14:00:43 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;We are facing once again a similar issue where our Flink job stopped writing to Delta, similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-37747&quot; title=&quot;GlobalCommitterOperator cannot commit after scaling writer/committer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-37747&quot;&gt;&lt;del&gt;FLINK-37747&lt;/del&gt;&lt;/a&gt;, the GlobalCommitter was not being called.&lt;br/&gt;
It seems that our application got stuck in a checkpoint (&lt;b&gt;873&lt;/b&gt;) that has a mismatching state where the number of &lt;b&gt;subtasks (2)&lt;/b&gt;&#160;does not equal the number of &lt;b&gt;subtask committable managers (1).&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;During debugging, we identified that the &lt;b&gt;GlobalCommitter&lt;/b&gt; is not being triggered because of a failing &lt;a href=&quot;https://github.com/apache/flink/blob/87f898ec800c53e1c996634ca0a1f64bc79ecfca/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/operators/sink/committables/CheckpointCommittableManagerImpl.java#L138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;condition check&lt;/a&gt;. The condition expects these values to be equal.&lt;/p&gt;

&lt;p&gt;However, these values do not match, thus the GlobalCommitter from executing. We did have a bit of restarts during the time this checkpoint was being taken (see logs), So I&apos;m not sure if that&apos;s the culprit.&lt;br/&gt;
Different from &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-37747&quot; title=&quot;GlobalCommitterOperator cannot commit after scaling writer/committer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-37747&quot;&gt;&lt;del&gt;FLINK-37747&lt;/del&gt;&lt;/a&gt;, this time is harder to reproduce, just scaling up the application is not enough.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It looks like it is a very specific edge case that causes the mismatching state. Any ideas or suggestions? Could it be that we also need to add a similar check as for the one reported in issue &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-37747&quot; title=&quot;GlobalCommitterOperator cannot commit after scaling writer/committer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-37747&quot;&gt;&lt;del&gt;FLINK-37747&lt;/del&gt;&lt;/a&gt; on the CommittableCollectorSerializer? I&apos;m honestly not sure how to proceed here.&lt;/p&gt;

&lt;p&gt;&#8211;&lt;br/&gt;
&lt;b&gt;Flink version: 1.20.3&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;Checkpoint failure logs:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2025-10-17 22:55:17.553 2025-10-17 20:55:17,553 [Delta Sink: transactions: Global Committer (1/1)#4] WARN &#160;org.apache.flink.streaming.runtime.io.checkpointing.SingleCheckpointBarrierHandler [] - Delta Sink: transactions: Global Committer (1/1)#4 (0c370242facfda1d112e94882bcbd052_5991bfefb6d30e6487b8f3e5342389c8_0_4): Received checkpoint barrier for checkpoint 874 before completing current checkpoint 873. Skipping current checkpoint.
2025-10-17 22:51:46.971 2025-10-17 20:51:46,971 [Delta Sink: denied-purchases: Global Committer (1/1)#4] WARN &#160;org.apache.flink.streaming.runtime.io.checkpointing.SingleCheckpointBarrierHandler [] - Delta Sink: denied-purchases: Global Committer (1/1)#4 (0c370242facfda1d112e94882bcbd052_a858192fe71e42efe3da125ec5940cc3_0_4): Received checkpoint barrier for checkpoint 874 before completing current checkpoint 873. Skipping current checkpoint.
2025-10-17 22:51:46.971 2025-10-17 20:51:46,971 [Delta Sink: fees: Global Committer (1/1)#4] WARN &#160;org.apache.flink.streaming.runtime.io.checkpointing.SingleCheckpointBarrierHandler [] - Delta Sink: fees: Global Committer (1/1)#4 (0c370242facfda1d112e94882bcbd052_2c03ec2835e560f8b6522a2c8cc8ed7a_0_4): Received checkpoint barrier for checkpoint 874 before completing current checkpoint 873. Skipping current checkpoint.
2025-10-17 22:51:45.104 2025-10-17 20:51:45,103 [Checkpoint Timer] WARN &#160;org.apache.flink.runtime.checkpoint.CheckpointFailureManager [] - Failed to trigger or complete checkpoint 873 for job 50ac0f996fb31d6aef83ca9c8738a401. (0 consecutive failed attempts so far)
2025-10-17 22:51:45.104 2025-10-17 20:51:45,104 [SourceCoordinator-Source: datomic-single-split] INFO &#160;org.apache.flink.runtime.source.coordinator.SourceCoordinator [] - Marking checkpoint 873 as aborted for source Source: datomic-single-split.
2025-10-17 22:51:00.103 2025-10-17 20:51:00,102 [Checkpoint Timer] INFO &#160;org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160;[] - Triggering checkpoint 873 (type=SavepointType{name=&apos;Savepoint&apos;, postCheckpointAction=NONE, formatType=CANONICAL}) @ 1760734260075 for job 50ac0f996fb31d6aef83ca9c8738a401&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="18034903" author="JIRAUSER309542" created="Mon, 3 Nov 2025 00:10:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ericsn21021&quot; class=&quot;user-hover&quot; rel=&quot;ericsn21021&quot;&gt;ericsn21021&lt;/a&gt; which release do you use? A fix was made to &lt;a href=&quot;https://issues.apache.org/jira/issues/?jql=project+%3D+FLINK+AND+fixVersion+%3D+2.1.0&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;2.1.0&lt;/a&gt;,&#160;&lt;a href=&quot;https://issues.apache.org/jira/issues/?jql=project+%3D+FLINK+AND+fixVersion+%3D+2.0.1&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;2.0.1&lt;/a&gt;,&#160;&lt;a href=&quot;https://issues.apache.org/jira/issues/?jql=project+%3D+FLINK+AND+fixVersion+%3D+1.20.3&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;1.20.3&lt;/a&gt;, for other version, it will run into the issue you are facing.&lt;/p&gt;</comment>
                            <comment id="18034981" author="JIRAUSER310966" created="Mon, 3 Nov 2025 08:25:29 +0000"  >&lt;p&gt;1.20.3, I&apos;ve opened a new issue here &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-38582&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-38582&lt;/a&gt;, thx.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vlkg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fixed global committer not proceeding during upscaling recovery</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>