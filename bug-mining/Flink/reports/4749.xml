<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20008] Java Deadlock in ZooKeeperLeaderElectionTest.testZooKeeperReelectionWithReplacement()</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20008</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The stack trace detects a deadlock between the testing thread and the curator event thread.&lt;/p&gt;

&lt;p&gt;Full log: &lt;a href=&quot;https://dev.azure.com/sewen0794/Flink/_build/results?buildId=176&amp;amp;view=logs&amp;amp;j=6e58d712-c5cc-52fb-0895-6ff7bd56c46b&amp;amp;t=f30a8e80-b2cf-535c-9952-7f521a4ae374&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/sewen0794/Flink/_build/results?buildId=176&amp;amp;view=logs&amp;amp;j=6e58d712-c5cc-52fb-0895-6ff7bd56c46b&amp;amp;t=f30a8e80-b2cf-535c-9952-7f521a4ae374&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Relevant Stack Trace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Found one Java-level deadlock:
=============================
&lt;span class=&quot;code-quote&quot;&gt;&quot;main-EventThread&quot;&lt;/span&gt;:
  waiting to lock monitor 0x00007f74c00045e8 (object 0x000000008ed14cb0, a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;:
  waiting to lock monitor 0x00007f74e401a1f8 (object 0x000000008ed15008, a org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;main-EventThread&quot;&lt;/span&gt;

Java stack information &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the threads listed above:
===================================================
&lt;span class=&quot;code-quote&quot;&gt;&quot;main-EventThread&quot;&lt;/span&gt;:
	at org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService.onGrantLeadership(DefaultLeaderElectionService.java:186)
	- waiting to lock &amp;lt;0x000000008ed14cb0&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
	at org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionDriver.isLeader(ZooKeeperLeaderElectionDriver.java:158)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch$9.apply(LeaderLatch.java:693)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch$9.apply(LeaderLatch.java:689)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.listen.ListenerContainer$1.run(ListenerContainer.java:100)
	at org.apache.flink.shaded.curator4.org.apache.curator.shaded.com.google.common.util.concurrent.DirectExecutor.execute(DirectExecutor.java:30)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.listen.ListenerContainer.forEach(ListenerContainer.java:92)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.setLeadership(LeaderLatch.java:688)
	- locked &amp;lt;0x000000008ed15008&amp;gt; (a org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.checkLeadership(LeaderLatch.java:567)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.access$700(LeaderLatch.java:65)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch$7.processResult(LeaderLatch.java:618)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorFrameworkImpl.sendToBackgroundCallback(CuratorFrameworkImpl.java:883)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorFrameworkImpl.processBackgroundOperation(CuratorFrameworkImpl.java:653)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.WatcherRemovalFacade.processBackgroundOperation(WatcherRemovalFacade.java:152)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.GetChildrenBuilderImpl$2.processResult(GetChildrenBuilderImpl.java:187)
	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:601)
	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:508)


&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;:
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.close(LeaderLatch.java:203)
	- waiting to lock &amp;lt;0x000000008ed15008&amp;gt; (a org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch)
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.close(LeaderLatch.java:190)
	at org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionDriver.close(ZooKeeperLeaderElectionDriver.java:140)
	at org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService.stop(DefaultLeaderElectionService.java:103)
	- locked &amp;lt;0x000000008ed14cb0&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
	at org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionTest.testZooKeeperReelectionWithReplacement(ZooKeeperLeaderElectionTest.java:310)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13339070">FLINK-20008</key>
            <summary>Java Deadlock in ZooKeeperLeaderElectionTest.testZooKeeperReelectionWithReplacement()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Thu, 5 Nov 2020 18:02:26 +0000</created>
                <updated>Sat, 7 Nov 2020 15:21:18 +0000</updated>
                            <resolved>Sat, 7 Nov 2020 15:21:18 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17227248" author="till.rohrmann" created="Fri, 6 Nov 2020 09:02:14 +0000"  >&lt;p&gt;The problem is that &lt;tt&gt;curator.framework.leader.LeaderLatch&lt;/tt&gt; calls &lt;tt&gt;ZooKeeperLeaderElectionDriver.isLeader --&amp;gt; DefaultLeaderElectionService.onGrantLeadership&lt;/tt&gt; holding an internal lock &lt;tt&gt;a&lt;/tt&gt;. &lt;tt&gt;ZooKeeperLeaderElectionDriver.isLeader --&amp;gt; DefaultLeaderElectionService.onGrantLeadership&lt;/tt&gt; will try to acquire the lock &lt;tt&gt;b&lt;/tt&gt; of &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt;. Therefore, if there is a concurrent close operation first acquiring lock &lt;tt&gt;b&lt;/tt&gt; and then trying to close &lt;tt&gt;curator.framework.leader.LeaderLatch&lt;/tt&gt; which requires lock &lt;tt&gt;a&lt;/tt&gt;, we run into the deadlock.&lt;/p&gt;</comment>
                            <comment id="17227264" author="till.rohrmann" created="Fri, 6 Nov 2020 09:18:04 +0000"  >&lt;p&gt;The solution I propose is to move &lt;tt&gt;leaderElectionDriver.close()&lt;/tt&gt; out of the &lt;tt&gt;lock&lt;/tt&gt; scope in &lt;tt&gt;DefaultLeaderElectionService.stop&lt;/tt&gt; method.&lt;/p&gt;</comment>
                            <comment id="17227325" author="fly_in_gis" created="Fri, 6 Nov 2020 10:57:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;&apos;s right. I didn&apos;t notice that curator &lt;tt&gt;LeaderLatch&lt;/tt&gt; also have a internal lock. Currently, we are closing the &lt;tt&gt;LeaderLatch&lt;/tt&gt; in the another lock. This could cause dead lock. Moving &lt;tt&gt;DefaultLeaderElectionService#stop&lt;/tt&gt; out of &lt;tt&gt;lock&lt;/tt&gt; is reasonable.&lt;/p&gt;</comment>
                            <comment id="17227823" author="till.rohrmann" created="Sat, 7 Nov 2020 15:21:18 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;6dc5a13abfb0f44b5920bee4c4467a92bffe8eb9&lt;br/&gt;
980a2c906928d9124a176a286a34f768fb56ad8b&lt;br/&gt;
9d435f4506c8bf628b30606f442ce27b9bde8666&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kbo8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>