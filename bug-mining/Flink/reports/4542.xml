<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:49:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18641] &quot;Failure to finalize checkpoint&quot; error in MasterTriggerRestoreHook</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18641</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://github.com/pravega/flink-connectors&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pravega/flink-connectors&lt;/a&gt; is a Pravega connector for Flink. The ReaderCheckpointHook&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; class uses the Flink `MasterTriggerRestoreHook` interface to trigger the Pravega checkpoint during Flink checkpoints to make sure the data recovery. The checkpoint recovery tests are running fine in Flink 1.10, but it has below issues in Flink 1.11 causing the tests time out. Suspect it is related to the checkpoint coordinator thread model changes in Flink 1.11&lt;/p&gt;

&lt;p&gt;Error stacktrace:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-07-09 15:39:39,999 30945 [jobmanager-&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;-thread-5] WARN  o.a.f.runtime.jobmaster.JobMaster - Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing checkpoint acknowledgement message
org.apache.flink.runtime.checkpoint.CheckpointException: Could not finalize the pending checkpoint 3. Failure reason: Failure to finalize checkpoint.
         at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.completePendingCheckpoint(CheckpointCoordinator.java:1033)
         at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.receiveAcknowledgeMessage(CheckpointCoordinator.java:948)
         at org.apache.flink.runtime.scheduler.SchedulerBase.lambda$acknowledgeCheckpoint$4(SchedulerBase.java:802)
         at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
         at java.util.concurrent.FutureTask.run(FutureTask.java:266)
         at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)
         at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
         at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: org.apache.flink.util.SerializedThrowable: Pending checkpoint has not been fully acknowledged yet
         at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195)
         at org.apache.flink.runtime.checkpoint.PendingCheckpoint.finalizeCheckpoint(PendingCheckpoint.java:298)
         at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.completePendingCheckpoint(CheckpointCoordinator.java:1021)
         ... 9 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;More detail in this mailing thread: &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Pravega-connector-cannot-recover-from-the-checkpoint-due-to-quot-Failure-to-finalize-checkpoint-quot-td36652.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Pravega-connector-cannot-recover-from-the-checkpoint-due-to-quot-Failure-to-finalize-checkpoint-quot-td36652.html&lt;/a&gt;&lt;br/&gt;
Also in &lt;a href=&quot;https://github.com/pravega/flink-connectors/issues/387&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pravega/flink-connectors/issues/387&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13318181">FLINK-18641</key>
            <summary>&quot;Failure to finalize checkpoint&quot; error in MasterTriggerRestoreHook</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="becket_qin">Jiangjie Qin</assignee>
                                    <reporter username="Brian Zhou">Brian Zhou</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 20 Jul 2020 07:10:20 +0000</created>
                <updated>Wed, 9 Sep 2020 06:34:32 +0000</updated>
                            <resolved>Wed, 9 Sep 2020 01:33:40 +0000</resolved>
                                    <version>1.11.0</version>
                                    <fixVersion>1.11.2</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17162056" author="pnowojski" created="Tue, 21 Jul 2020 13:52:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt; do you have some good guess what&apos;s the problem here?&lt;/p&gt;</comment>
                            <comment id="17162410" author="becket_qin" created="Wed, 22 Jul 2020 00:28:44 +0000"  >&lt;p&gt;Looked into this a little bit. The problems is following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The Pravega connector uses the &lt;tt&gt;MasterTriggerRestoreHook&lt;/tt&gt;&#160;and &lt;tt&gt;ExternallyInducedSource&lt;/tt&gt;&#160;for checkpointing. That means the tasks may start checkpointing after the &lt;tt&gt;MasterTriggerRestoreHook.triggerCheckpoint()&lt;/tt&gt;&#160;is invoked.&lt;/li&gt;
	&lt;li&gt;In Flink 1.10, the checkpoint thread blocks on the future returned by the master hook. This becomes asynchronous in Flink 1.11. It only guarantees that the JM triggers the task checkpoint after the master state is checkpointed. However, this does not cover the case where the task checkpoints are triggered by the master hooks rather than by JM itself.&lt;/li&gt;
	&lt;li&gt;Due to the change in (2), what happens in this case is that the task checkpionts are triggered by the master hook, and acknowledged before the master hook future is completed. From JM&apos;s perspective, once all the task checkpoints are acked, it will try to finalize the checkpoint, but found that the master checkpoint has not completed yet, thus an exception is thrown.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This is a bug in JM when working with&#160;&lt;tt&gt;MasterTriggerRestoreHook&lt;/tt&gt;&#160;and&#160;&lt;tt&gt;ExternallyInducedSource.&lt;/tt&gt;&#160;I&apos;ll submit a fix for this.&lt;/p&gt;</comment>
                            <comment id="17162428" author="brian zhou" created="Wed, 22 Jul 2020 02:11:44 +0000"  >&lt;p&gt;Thanks Jiangjie for looking into this. I noticed 1.11.1 release just happened, so can we get a quick 1.11.2 release to fix this? This one is now a blocker to Pravega Flink 1.11 connector, so I hope this could be fixed ASAP.&lt;/p&gt;</comment>
                            <comment id="17162553" author="sleepy" created="Wed, 22 Jul 2020 07:20:47 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; for analyzing this issue. The asynchronous checkpoint threading model breaks the assumption of &lt;tt&gt;ExternallyInducedSource&lt;/tt&gt; could trigger a checkpoint before &lt;tt&gt;MasterTriggerRestoreHook&lt;/tt&gt; finishes the trigger future. We can find a way to guarantee that. However it&apos;s not friendly to the scenario that doing some initialization or preparation in &lt;tt&gt;MasterTriggerRestoreHook&lt;/tt&gt;. Because checkpoint might be triggered before initialization of preparation finishes. Hope nobody uses it like that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Currently the semantics of &lt;tt&gt;ExternallyInducedSource&lt;/tt&gt; is highly bound with the implementation of Flink checkpoint which should be avoided IMO. I think we should redesign the &lt;tt&gt;ExternallyInducedSource&lt;/tt&gt; as a long-term goal.&lt;/p&gt;

&lt;p&gt;To &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;, do you already have any idea for fixing it? If not, I could help to fix it.&lt;/p&gt;

&lt;p&gt;BTW, this change of &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; is introduced in 1.10. Is it possible that the failure of testing case is exposed by the change of &lt;tt&gt;OperatorCoordinator&lt;/tt&gt;? Because we add another asynchronous step between master hook triggering and task triggering. I&apos;m not sure if there must be some &lt;tt&gt;OperatorCoordinator&lt;/tt&gt; added or not in the scenario of Pravega connector testing. If not, there is a work-around way that try to finish future returned by &lt;tt&gt;MasterTriggerRestoreHook.triggerCheckpoint&lt;/tt&gt; before trigger task checkpoint (I assume there is only one master hook in the case). &lt;/p&gt;</comment>
                            <comment id="17162667" author="pnowojski" created="Wed, 22 Jul 2020 10:08:11 +0000"  >&lt;p&gt;So the problem is that checkpoint is finalised after JM receives all of the ACKS, without waiting for async master hook to complete? And the solution would be to include waiting for async hook to complete, before completing/finalising the checkpoint?  &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In Flink 1.10, the checkpoint thread blocks on the future returned by the master hook. This becomes asynchronous in Flink 1.11.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;, as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt; mentioned that&apos;s not correct. Those changes were done already in Flink 1.10.&lt;/p&gt;</comment>
                            <comment id="17163239" author="becket_qin" created="Thu, 23 Jul 2020 05:53:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;In Flink 1.10, the checkpoint thread blocks on the future returned by the master hook, therefore that thread will not handle the acks from the tasks until the master hook has completed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/bfe6c2eddedaf3b8067c973ba82a06b36d5095f9/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L627&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/bfe6c2eddedaf3b8067c973ba82a06b36d5095f9/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L627&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now in Flink 1.11, the checkpoint thread no longer blocks on that future anymore, it uses handleAsync instead.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/791e276c8346a49130cb096bafa128d7f1231236/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L708&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/791e276c8346a49130cb096bafa128d7f1231236/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L708&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/791e276c8346a49130cb096bafa128d7f1231236/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L544&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/791e276c8346a49130cb096bafa128d7f1231236/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L544&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So that is what I meant by&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In Flink 1.10, the checkpoint thread blocks on the future returned by the master hook. This becomes asynchronous in Flink 1.11.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17163267" author="becket_qin" created="Thu, 23 Jul 2020 06:51:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt; There are actually more problems than the issues reported by this ticket. In checkpoint there are two orders:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the checkpoint taking order;&lt;/li&gt;
	&lt;li&gt;the checkpoint acknowledge handling order.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This ticket reports the problem of unexpected checkpoint acknowledge handling order. While the acknowledge handling order is not super important, the checkpoint taking order is critical because that may cause correctness problem.&lt;/p&gt;

&lt;p&gt;By design, the checkpoint should always actually take the snapshot of the master hooks and OperatorCoordinator first before taking the checkpoint on the tasks.&lt;/p&gt;

&lt;p&gt;Prior to FLIP-27, this ordering is always guaranteed because the checkpoint on the tasks are triggered in one of the following ways:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The CheckpointCoordinator takes snapshot of the master hooks, wait for it to finish, and then trigger the snapshot on tasks. (Strict snapshot order is guaranteed by the checkpoint coordinator.)&lt;/li&gt;
	&lt;li&gt;The CheckpointCoordinator takes snapshot of the master hooks. The master hook triggers the checkpoint on the tasks using ExternallyInducedSource. The CheckpointCoordinator waits until the master hooks finishes snapshot. (In this case, the master hooks have to guarantee the consistency between the master state and the task states. The tasks may ack the checkpoint before the master hooks completes, but the acks won&apos;t be handled until the master hooks acks are handled).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;After FLIP-27, with the introduction of OperatorCoordinator, we need to make sure that the tasks checkpoint cannot be triggered before the OperatorCoordinator checkpoint. Given that the task checkpoint can be triggered by both the CheckpointCoordinator itself or the master hooks. We should first checkpoint the OperatorCoordinator, then the master hooks, lastly triggering the task checkpoint.&lt;/p&gt;

&lt;p&gt;The current code does not do this correctly. That means the master hooks can trigger the snapshot of the tasks before the OperatorCoordinators are checkpointed.&lt;/p&gt;

&lt;p&gt;Regarding the fix, I am thinking of the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Change the checkpoint order to checkpoint OperatorCoordinators first, i.e before checkpointing master hooks.&lt;/li&gt;
	&lt;li&gt;Keep the master hooks async, but invoke them after checkpointing the OperatorCoordinators. This is fine because according to the java doc of &lt;tt&gt;MasterTriggerRestoreHook#triggerCheckpoint()&lt;/tt&gt;&#160;can choose to be synchronous if it wants to. Otherwise the CheckpointCoordinator will consider it as asynchronous friendly.&lt;/li&gt;
	&lt;li&gt;Change the logic to only call &lt;tt&gt;CheckpointCoordinator#completePendingCheckpoint()&lt;/tt&gt;&#160;after all the checkpoints are acked, instead of only looking the task checkpoints. This is because the acknowledge handling order may vary given the current async checkpoint pattern.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I agree that In long run, the operator coordinator can actually supersede the master hooks. So we can probably mark the master hooks as deprecated.&lt;/p&gt;</comment>
                            <comment id="17163341" author="sleepy" created="Thu, 23 Jul 2020 08:31:33 +0000"  >&lt;p&gt;Ah, sorry &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;, I forgot this change is not submitted to release-1.10 at that time, it&apos;s only submitted to master.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;, thanks for correcting it. There are two different things of your response, master hook and &lt;tt&gt;OperatorCoordinator&lt;/tt&gt;. Regarding to this ticket, it&apos;s not caused by the &lt;tt&gt;OperatorCoordinator&lt;/tt&gt; part, right? I think we could file another ticket for it and discuss it there.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;By design, the checkpoint should always actually take the snapshot of the master hooks and OperatorCoordinator first before taking the checkpoint on the tasks.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Technically speaking, there is no clear semantics that master hook should be taken before task snapshotting. For the &lt;tt&gt;ExternallyInducedSource&lt;/tt&gt;, the task snapshotting might be taken before master hook finishes the future returned. And if there are multiple master hooks, some hooks might be invoked after task snapshotting. It&apos;s concurrent somewhat. I don&apos;t think we should/could guarantee the ordering here.&lt;/p&gt;

&lt;p&gt;Anyway we have to fix the issue of &lt;tt&gt;ExternallyInducedSource&lt;/tt&gt; caused by the ordering.&lt;br/&gt;
Regarding to the fixing plan. I&apos;m not sure how heavy the fixing of &lt;tt&gt;OperatorCoordinator&lt;/tt&gt; might be. If it&apos;s not a simple fixing, it might be better to separate these things into different patches. As a quick fixing of this ticket, we could take the master hook synchronously with the coordinator-wide lock retaining just like before.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I agree that In long run, the operator coordinator can actually supersede the master hooks. So we can probably mark the master hooks as deprecated.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Totally agree!&lt;/p&gt;</comment>
                            <comment id="17163359" author="becket_qin" created="Thu, 23 Jul 2020 08:59:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;&#160;Right, the master hooks with ExternalInducedSource are not really that robust in my opinion.&lt;/p&gt;

&lt;p&gt;I think the fix is just a few lines of code. However, apparently we do not have a test covering the use case of &lt;tt&gt;ExternallyInducedSource&lt;/tt&gt;. So as usual, I think the major work here will be writing the tests.&lt;/p&gt;</comment>
                            <comment id="17163425" author="pnowojski" created="Thu, 23 Jul 2020 11:04:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; yes you are right that the problem was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13905&quot; title=&quot;Separate checkpoint triggering into stages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13905&quot;&gt;&lt;del&gt;FLINK-13905&lt;/del&gt;&lt;/a&gt; in 1.11.0.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;By design, the checkpoint should always actually take the snapshot of the master hooks and OperatorCoordinator first before taking the checkpoint on the tasks.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Regarding the ordering guarantees. I don&apos;t understand where does this strict ordering comes from? Java docs of the &lt;tt&gt;MasterTriggerRestoreHook&lt;/tt&gt; doesn&apos;t seem to support this statement:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
	 * &amp;lt;p&amp;gt;If the action should be executed asynchronously and only needs to complete before the
	 * checkpoint is considered completed, then the method may use the given executor to execute the
	 * actual action and would signal its completion by completing the &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;. 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So synchronously waiting for the hook&apos;s future to complete would solve the problem, but what I proposed above:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;And the solution would be to include waiting for async hook to complete, before completing/finalising the checkpoint?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Should also be correct, right?&lt;/p&gt;

&lt;p&gt;As a sidenote, I&apos;m +1 for the easiest solution to solve this bug without causing regressions compared to 1.10/1.9 and without undermining &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; threading model refactor (which we still need to complete). As you both mentioned, &lt;tt&gt;MasterTriggerRestoreHook&lt;/tt&gt; is on it&apos;s way out to be replaced by FLIP-27.&lt;/p&gt;</comment>
                            <comment id="17164178" author="becket_qin" created="Fri, 24 Jul 2020 06:18:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;Synchronously waiting for the hook&apos;s future is not sufficient after introduction of OperatorCoordinator. This is because when the master hooks are triggered on the &lt;tt&gt;ExternallyInducedSource&lt;/tt&gt;, the tasks may start to checkpoint the operators before the OperatorCoordinator is checkpointed. This breaks the checkpoint contract between the OperatorCoordinator and the Operator, which is that the OperatorCoordinator is always checkpointed before the subtasks/operators are checkpointed.&lt;/p&gt;

&lt;p&gt;Otherwise, yes, we only need to wait for the master hooks to finish before completing the checkpoint.&lt;/p&gt;</comment>
                            <comment id="17166057" author="sleepy" created="Tue, 28 Jul 2020 01:32:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;, the ticket has not been assigned yet. Is there anyone working on this?&lt;/p&gt;</comment>
                            <comment id="17166925" author="becket_qin" created="Wed, 29 Jul 2020 06:50:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;&#160;Sorry for the late reply. I have a fix ready and is working on the tests. Will submit a patch this week.&lt;/p&gt;</comment>
                            <comment id="17170530" author="becket_qin" created="Tue, 4 Aug 2020 03:46:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt; Somehow the PR info was not updated in the ticket. Would you help take a look?&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/pull/13044&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/13044&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17190612" author="zhuzh" created="Fri, 4 Sep 2020 07:59:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;, what&apos;s the status of the pull request?&lt;/p&gt;</comment>
                            <comment id="17191389" author="becket_qin" created="Mon, 7 Sep 2020 00:44:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;&#160;Just some minor items left, should be checked in soon.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17191391" author="zhuzh" created="Mon, 7 Sep 2020 01:02:23 +0000"  >&lt;p&gt;Thanks for the updates! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17192558" author="becket_qin" created="Wed, 9 Sep 2020 01:33:40 +0000"  >&lt;p&gt;Master:&#160;d850871518..99cd44f203&lt;/p&gt;

&lt;p&gt;release-1.11:&#160;3dc019eaff9a30..7286c662af636&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 9 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0gzyw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>