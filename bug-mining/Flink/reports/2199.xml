<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8409] Race condition in KafkaConsumerThread leads to potential NPE</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8409</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The following lines in the &lt;tt&gt;KafkaConsumerThread::setOffsetsToCommit(...)&lt;/tt&gt; suggests a race condition with the asynchronous callback from committing offsets to Kafka:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// record the work to be committed by the main consumer thread and make sure the consumer notices that
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (nextOffsetsToCommit.getAndSet(offsetsToCommit) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Committing offsets to Kafka takes longer than the checkpoint interval. &quot;&lt;/span&gt; +
        &lt;span class=&quot;code-quote&quot;&gt;&quot;Skipping commit of previous offsets because newer complete checkpoint offsets are available. &quot;&lt;/span&gt; +
        &lt;span class=&quot;code-quote&quot;&gt;&quot;This does not compromise Flink&apos;s checkpoint integrity.&quot;&lt;/span&gt;);
}
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.offsetCommitCallback = commitCallback;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the main consumer thread&apos;s main loop, &lt;tt&gt;nextOffsetsToCommit&lt;/tt&gt; will be checked if there are any offsets to commit. If so, an asynchronous offset commit operation will be performed. The NPE happens in the case when the commit completes, but &lt;tt&gt;this.offsetCommitCallback = commitCallback;&lt;/tt&gt; is not yet reached.&lt;/p&gt;

&lt;p&gt;A possible fix is to make setting the next offsets to commit along with the callback instance a single atomic operation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13129874">FLINK-8409</key>
            <summary>Race condition in KafkaConsumerThread leads to potential NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tzulitai">Tzu-Li (Gordon) Tai</assignee>
                                    <reporter username="tzulitai">Tzu-Li (Gordon) Tai</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Jan 2018 14:56:23 +0000</created>
                <updated>Mon, 12 Mar 2018 15:27:22 +0000</updated>
                            <resolved>Mon, 12 Mar 2018 15:27:22 +0000</resolved>
                                    <version>1.3.2</version>
                    <version>1.4.0</version>
                    <version>1.5.0</version>
                                    <fixVersion>1.3.4</fixVersion>
                    <fixVersion>1.4.1</fixVersion>
                    <fixVersion>1.5.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16333922" author="githubbot" created="Mon, 22 Jan 2018 06:39:08 +0000"  >&lt;p&gt;GitHub user tzulitai opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5329&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5329&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8409&quot; title=&quot;Race condition in KafkaConsumerThread leads to potential NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8409&quot;&gt;&lt;del&gt;FLINK-8409&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Fix potential NPE in KafkaConsumerThread&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR fixes a race condition that may lead to a NPE in the async callbacks for Kafka offset committing.&lt;/p&gt;

&lt;p&gt;    The following lines in the KafkaConsumerThread::setOffsetsToCommit(...) suggests a race condition with the asynchronous callback from committing offsets to Kafka:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    // record the work to be committed by the main consumer thread and make sure the consumer notices that&lt;br/&gt;
    if (nextOffsetsToCommit.getAndSet(offsetsToCommit) != null) &lt;/p&gt;
{
        log.warn(&quot;Committing offsets to Kafka takes longer than the checkpoint interval. &quot; +
            &quot;Skipping commit of previous offsets because newer complete checkpoint offsets are available. &quot; +
            &quot;This does not compromise Flink&apos;s checkpoint integrity.&quot;);
    }
&lt;p&gt;    this.offsetCommitCallback = commitCallback;&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    In the main consumer thread&apos;s main loop, `nextOffsetsToCommit` will be checked if there are any offsets to commit. If so, an asynchronous offset commit operation will be performed. The NPE happens in the case when the commit completes, but `this.offsetCommitCallback = commitCallback;` is not yet reached.&lt;/p&gt;

&lt;p&gt;    This PR fixes this by making setting the `commitCallback` and `nextOffsetsToCommit` an atomic operation.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    No new tests were added.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tzulitai/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tzulitai/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8409&quot; title=&quot;Race condition in KafkaConsumerThread leads to potential NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8409&quot;&gt;&lt;del&gt;FLINK-8409&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5329.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5329.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5329&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c8081acaf51b3407af7d425063572f03a68021ac&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-01-13T12:13:20Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8409&quot; title=&quot;Race condition in KafkaConsumerThread leads to potential NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8409&quot;&gt;&lt;del&gt;FLINK-8409&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Fix offset committing race condition in KafkaConsumerThread&lt;/p&gt;

&lt;p&gt;commit a1bf7af3a80bbbb6871b1177cb58c127c94bd75c&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-01-13T12:35:03Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Make AbortedReassignmentException a static class&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16346767" author="githubbot" created="Wed, 31 Jan 2018 12:54:33 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5329&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5329&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging ...&lt;/p&gt;</comment>
                            <comment id="16354356" author="githubbot" created="Tue, 6 Feb 2018 19:04:02 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5329&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5329&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16354373" author="tzulitai" created="Tue, 6 Feb 2018 19:07:34 +0000"  >&lt;p&gt;Merged.&lt;/p&gt;

&lt;p&gt;1.5 -&#160;3655200799929409352945a3f4fce0f3e987b9ad&lt;br/&gt;
 1.4 -&#160;08163009e443d00379696f9f84b3ccb0af6a25b6&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3oqsv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>