<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:59:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-23560] Performance regression on 29.07.2021</title>
                <link>https://issues.apache.org/jira/browse/FLINK-23560</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=remoteFilePartition&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=remoteFilePartition&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=uncompressedMmapPartition&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=uncompressedMmapPartition&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=compressedFilePartition&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=compressedFilePartition&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=tupleKeyBy&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=tupleKeyBy&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=arrayKeyBy&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=arrayKeyBy&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=uncompressedFilePartition&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=uncompressedFilePartition&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=sortedTwoInput&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=sortedTwoInput&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=sortedMultiInput&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=sortedMultiInput&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=globalWindow&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=globalWindow&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
(And potentially other benchmarks)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13392703">FLINK-23560</key>
            <summary>Performance regression on 29.07.2021</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akalashnikov">Anton Kalashnikov</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 30 Jul 2021 09:11:22 +0000</created>
                <updated>Sat, 28 Aug 2021 13:11:05 +0000</updated>
                            <resolved>Mon, 16 Aug 2021 09:03:18 +0000</resolved>
                                    <version>1.14.0</version>
                                    <fixVersion>1.14.0</fixVersion>
                                    <component>Benchmarks</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17390436" author="pnowojski" created="Fri, 30 Jul 2021 09:15:09 +0000"  >
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;git ls c3088af325..230f659e79
230f659e790 [3 days ago] [FLINK-23452][streaming] Integration ThroughputCalculator in StreamTask for the calculation of the subtask level throughput [Anton Kalashnikov]
29d7bcd2bb3 [3 days ago] [hotfix] Stopping the StreamTask#systemTimerService explicitly after the invoke [Anton Kalashnikov]
45890c0a001 [3 days ago] [FLINK-23452][core] Added specific configuration for the calculation of the throughput [Anton Kalashnikov]
fe26c9d0644 [3 days ago] [FLINK-23452][runtime] Added extra classes for the ability to calculate throughput [Anton Kalashnikov]
3cbdd783e4e [3 days ago] [FLINK-23452][refactor] Extracted PeriodTimer interface for the abstraction of idle/backpressure time management [Anton Kalashnikov]
5c475d41fea [2 weeks ago] [FLINK-23354][blob] Limit the size of ShuffleDescriptors in PermanentBlobCache on TaskExecutor [Thesharing]
d879d3e46bf [25 hours ago] [FLINK-23517][build] Add error messages for bannedDependencies rules [Chesnay Schepler]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akalashnikov&quot; class=&quot;user-hover&quot; rel=&quot;akalashnikov&quot;&gt;akalashnikov&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17390595" author="pnowojski" created="Fri, 30 Jul 2021 13:49:51 +0000"  >&lt;p&gt;I&apos;ve commented out whole content of the &lt;tt&gt;StreamTask#throughputCalculationSetup()&lt;/tt&gt; and results were back to normal on the benchmark request machine. So it&apos;s indeed caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23452&quot; title=&quot;Measuring subtask throughput&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23452&quot;&gt;&lt;del&gt;FLINK-23452&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13031282/13031282_Screenshot+2021-07-30+at+15.46.54.png&quot; width=&quot;600&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17392978" author="akalashnikov" created="Wed, 4 Aug 2021 10:12:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; My conclusion why it happens:&lt;/p&gt;

&lt;p&gt;First of all, there is a little java theory: if a synchronization block is used in only one thread it works more effectively rather than it would be used in different threads. It happens because when only one thread is able to own the mutex the information about this owner thread is located inside of the header of this object but when the several threads want to own the object then the java create the table with this information in a separate place which requires extra hops on each synchronization.&lt;/p&gt;

&lt;p&gt;One more important notice is the all problematic benchmarks don&apos;t have any timers or checkpoints. So it mostly has only one thread during the execution. More precisely: &lt;b&gt;LegacySourceFunctionThread&lt;/b&gt;&#160;does main execution(evict the data under the checkpoint lock) and &lt;b&gt;MailboxProcessorThread&lt;/b&gt;&#160;do nothing until&#160;&lt;b&gt;LegacySourceFunctionThread&lt;/b&gt; is finished and then&#160;&lt;b&gt;MailboxProcessorThread&lt;/b&gt; just finishes the task.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23452&quot; title=&quot;Measuring subtask throughput&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23452&quot;&gt;&lt;del&gt;FLINK-23452&lt;/del&gt;&lt;/a&gt;&#160;has introduced the action which is submitted to the mailbox for execution. It is not really important what is this task doing(performance drop reproduces even for empty action). More important here is that during the&#160;&lt;b&gt;LegacySourceFunctionThread&lt;/b&gt; does its job(emitting records under checkpoint lock synchronization)&lt;b&gt;,&lt;/b&gt; the&#160;&lt;b&gt;MailboxProcessorThread&lt;/b&gt; wakes up and executes the action via &lt;b&gt;SynchronizedStreamTaskActionExecutor&lt;/b&gt;(synchronized version of&#160;&lt;b&gt;StreamTaskActionExecutor&lt;/b&gt;) which uses for synchronization the same checkpoint lock which uses&#160;&lt;b&gt;LegacySourceFunctionThread&lt;/b&gt;. So as soon as&#160;&lt;b&gt;MailboxProcessorThread&lt;/b&gt; takes the lock for the first time&#160;&#160;&lt;b&gt;LegacySourceFunctionThread&lt;/b&gt; becomes slower because of more expensive synchronization which I mention at the beginning.&lt;/p&gt;

&lt;p&gt;I proved the above-described assumption by adding the simple code before the execution of mainOperator inside of&#160;SourceStreamTask.LegacySourceFunctionThread#run(in fact it can be added to any place in the code):&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(() -&amp;gt; {
&#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (lock) {
&#160; &#160;}
}).start();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;These small changes lead to the same degradation as&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23452&quot; title=&quot;Measuring subtask throughput&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23452&quot;&gt;&lt;del&gt;FLINK-23452&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In general, it means that currently, our benchmarks are not so relevant because in real cases we usually use the checkpoint or timeService which&#160; weren&apos;t used for these benchmarks. But also we can turn off the feature from&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23452&quot; title=&quot;Measuring subtask throughput&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23452&quot;&gt;&lt;del&gt;FLINK-23452&lt;/del&gt;&lt;/a&gt;&#160;for sources(input gates == 0) because, in fact, the calculation of the throughput for sources doesn&apos;t make sense.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17392994" author="pnowojski" created="Wed, 4 Aug 2021 10:26:38 +0000"  >&lt;p&gt;Great analysis and good find &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akalashnikov&quot; class=&quot;user-hover&quot; rel=&quot;akalashnikov&quot;&gt;akalashnikov&lt;/a&gt;.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In general, it means that currently, our benchmarks are not so relevant because in real cases we usually use the checkpoint or timeService which  weren&apos;t used for these benchmarks.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is not true for batch jobs, where are no timers and checkpointing is disabled. In those cases performance drop caught by this JIRA ticket would have been visible to the users. But indeed we can:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;But also we can turn off the feature from &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23452&quot; title=&quot;Measuring subtask throughput&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23452&quot;&gt;&lt;del&gt;FLINK-23452&lt;/del&gt;&lt;/a&gt; for sources(input gates == 0) because, in fact, the calculation of the throughput for sources doesn&apos;t make sense.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;as this should solve the problem.&lt;/p&gt;</comment>
                            <comment id="17394584" author="pnowojski" created="Fri, 6 Aug 2021 07:15:38 +0000"  >&lt;p&gt;merged to master as a8db36bf07e&lt;/p&gt;</comment>
                            <comment id="17394827" author="pnowojski" created="Fri, 6 Aug 2021 15:21:16 +0000"  >&lt;p&gt;The issue in &lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=sortedTwoInput&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=sortedTwoInput&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://codespeed.dak8s.net:8000/timeline/?ben=sortedMultiInput&amp;amp;env=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8000/timeline/?ben=sortedMultiInput&amp;amp;env=2&lt;/a&gt;&lt;br/&gt;
still persists. It looks like there were two different performance regressions in the same commit range. Which makes sense, because my and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akalashnikov&quot; class=&quot;user-hover&quot; rel=&quot;akalashnikov&quot;&gt;akalashnikov&lt;/a&gt;&apos;s fix for the first regression couldn&apos;t explain those &lt;tt&gt;sortedInput&lt;/tt&gt; benchmarks as:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;those benchmarks are so slow (2M records/s) and involve spilling to disk, that any regression around enqueuing mailbox action shouldnt&#8217; be visible&lt;/li&gt;
	&lt;li&gt;those benchmarks are using FLIP-27 sources, so no problem with biased locking as described by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akalashnikov&quot; class=&quot;user-hover&quot; rel=&quot;akalashnikov&quot;&gt;akalashnikov&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17399614" author="ym" created="Mon, 16 Aug 2021 09:01:49 +0000"  >&lt;p&gt;closed with&lt;/p&gt;

&lt;p&gt;merged commit&#160;&lt;a href=&quot;https://github.com/apache/flink/commit/a8db36bf07eb475434da8215762f5129f55c5b53&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;a8db36b&lt;/tt&gt;&lt;/a&gt;&#160;into&#160;apache:master&#160;&lt;/p&gt;

&lt;p&gt;merged commit&#160;&lt;a href=&quot;https://github.com/apache/flink/commit/6d89c1de833ddde82d85826e428242c74de77034&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;6d89c1d&lt;/tt&gt;&lt;/a&gt;&#160;into&#160;apache:master&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13391121">FLINK-23452</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13031282" name="Screenshot 2021-07-30 at 15.46.54.png" size="151625" author="pnowojski" created="Fri, 30 Jul 2021 13:51:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 13 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0tgzc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>