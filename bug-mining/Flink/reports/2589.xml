<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10063] Jepsen: Automatically restart Mesos Processes</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10063</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Use a process supervisor to automatically restart Mesos processes. This is needed because Mesos uses a &quot;fail-fast&quot; approach to error handling, e.g., the Mesos master will exit when it discovers it has been partitioned away from the Zookeeper quorum. Currently the some of the tests cannot pass because the Mesos processes exiting.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Acceptance Criteria&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Running tests with &lt;tt&gt;--deployment-mode mesos-session&lt;/tt&gt; should not fail due to reasons related to the Mesos setup.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13176962">FLINK-10063</key>
            <summary>Jepsen: Automatically restart Mesos Processes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gjy">Gary Yao</assignee>
                                    <reporter username="gjy">Gary Yao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 5 Aug 2018 12:48:25 +0000</created>
                <updated>Thu, 9 Aug 2018 08:06:53 +0000</updated>
                            <resolved>Thu, 9 Aug 2018 08:06:53 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16569458" author="githubbot" created="Sun, 5 Aug 2018 13:02:59 +0000"  >&lt;p&gt;GJL opened a new pull request #6496: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10063&quot; title=&quot;Jepsen: Automatically restart Mesos Processes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10063&quot;&gt;&lt;del&gt;FLINK-10063&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Use runit to supervise mesos processes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6496&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   &lt;b&gt;Use a process supervisor to automatically restart Mesos processes. This is needed because Mesos uses a &quot;fail-fast&quot; approach to error handling, e.g., the Mesos master will exit when it discovers it has been partitioned away from the Zookeeper quorum. Currently the some of the tests cannot pass because the Mesos processes exiting.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;   cc: @igalshilman @cewood @tillrohrmann &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Use runit to supervise Mesos processes.&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Make docker setup work.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change added tests and can be verified as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Ran Mesos tests on docker.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (*&lt;b&gt;yes&lt;/b&gt;* (in test code) / no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16569828" author="githubbot" created="Mon, 6 Aug 2018 07:33:01 +0000"  >&lt;p&gt;cewood commented on a change in pull request #6496: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10063&quot; title=&quot;Jepsen: Automatically restart Mesos Processes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10063&quot;&gt;&lt;del&gt;FLINK-10063&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Use runit to supervise mesos processes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6496#discussion_r207790888&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6496#discussion_r207790888&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-jepsen/docker/Dockerfile-db&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -35,5 +35,12 @@ RUN mkdir -p /root/.ssh/ &amp;amp;&amp;amp; \&lt;br/&gt;
     chmod 600 /root/.ssh/authorized_keys &amp;amp;&amp;amp; \&lt;br/&gt;
     cat /root/id_rsa.pub &amp;gt;&amp;gt; /root/.ssh/authorized_keys&lt;/p&gt;

&lt;p&gt;+COPY sshd-run /etc/sv/service/sshd/run&lt;br/&gt;
+RUN chmod +x /etc/sv/service/sshd/run &amp;amp;&amp;amp; \&lt;br/&gt;
+    ln -sf /etc/sv/service/sshd /etc/service&lt;br/&gt;
+&lt;br/&gt;
 EXPOSE 22&lt;br/&gt;
-CMD exec /usr/sbin/sshd -D&lt;br/&gt;
+&lt;br/&gt;
+# Start runit process supervisor which will bring up sshd.&lt;br/&gt;
+# In our tests we can use runit to supervise more processes, e.g., Mesos.&lt;br/&gt;
+CMD runsvdir -P /etc/service /dev/null &amp;gt; /dev/null&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Is the extra `&amp;gt; /dev/null` actually required? I would have expected that the log argument to `/dev/null` alone would have sufficed, since it also redirects standard error according to the docs.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16569829" author="githubbot" created="Mon, 6 Aug 2018 07:33:01 +0000"  >&lt;p&gt;cewood commented on a change in pull request #6496: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10063&quot; title=&quot;Jepsen: Automatically restart Mesos Processes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10063&quot;&gt;&lt;del&gt;FLINK-10063&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Use runit to supervise mesos processes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6496#discussion_r207793002&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6496#discussion_r207793002&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-jepsen/src/jepsen/flink/mesos.clj&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -24,11 +24,35 @@&lt;br/&gt;
             &lt;span class=&quot;error&quot;&gt;&amp;#91;jepsen.os.debian :as debian&amp;#93;&lt;/span&gt;&lt;br/&gt;
             [jepsen.flink.zookeeper :refer &lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-uri&amp;#93;&lt;/span&gt;]))&lt;/p&gt;

&lt;p&gt;+;;; runit process supervisor (&lt;a href=&quot;http://smarden.org/runit/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://smarden.org/runit/&lt;/a&gt;)&lt;br/&gt;
+;;;&lt;br/&gt;
+;;; We use runit to supervise Mesos processes because Mesos uses a &quot;fail-fast&quot; approach to&lt;br/&gt;
+;;; error handling, e.g., the Mesos master will exit when it discovers it has been partitioned away&lt;br/&gt;
+;;; from the Zookeeper quorum.&lt;br/&gt;
+&lt;br/&gt;
+(def runit-version &quot;2.1.2-3&quot;)&lt;br/&gt;
+&lt;br/&gt;
+(defn create-supervised-service!&lt;br/&gt;
+  &quot;Registers a service with the process supervisor and starts it.&quot;&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;service-name cmd&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (let [service-dir (str &quot;/etc/sv/&quot; service-name)&lt;br/&gt;
+        run-script (str service-dir &quot;/run&quot;)]&lt;br/&gt;
+    (c/su&lt;br/&gt;
+      (c/exec :mkdir :-p service-dir)&lt;br/&gt;
+      (c/exec :echo (clojure.string/join &quot;\n&quot; &lt;a href=&quot;#!/bin/sh&amp;quot; cmd&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&quot;#!/bin/sh&quot; cmd&lt;/a&gt;) :&amp;gt; run-script)&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   It&apos;s generally considered best practice for runit units to include an `exec 2&amp;gt;&amp;amp;1` line, and to prefix your command with `exec ...`. So I&apos;d suggest updating this line accordingly; `&lt;a href=&quot;#!/bin/sh&amp;quot; &amp;quot;exec 2&amp;gt;&amp;amp;1&amp;quot; (str &amp;quot;exec &amp;quot; cmd)&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&quot;#!/bin/sh&quot; &quot;exec 2&amp;gt;&amp;amp;1&quot; (str &quot;exec &quot; cmd)&lt;/a&gt;`&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16569830" author="githubbot" created="Mon, 6 Aug 2018 07:33:40 +0000"  >&lt;p&gt;cewood commented on issue #6496: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10063&quot; title=&quot;Jepsen: Automatically restart Mesos Processes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10063&quot;&gt;&lt;del&gt;FLINK-10063&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Use runit to supervise mesos processes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6496#issuecomment-410615164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6496#issuecomment-410615164&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   And nice work on this, it&apos;s super tedious doing all this setup and tear down stuff, nice job :100: &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16572756" author="githubbot" created="Wed, 8 Aug 2018 06:44:51 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6496: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10063&quot; title=&quot;Jepsen: Automatically restart Mesos Processes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10063&quot;&gt;&lt;del&gt;FLINK-10063&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Use runit to supervise mesos processes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6496#discussion_r208471471&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6496#discussion_r208471471&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-jepsen/src/jepsen/flink/mesos.clj&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -24,11 +24,35 @@&lt;br/&gt;
             &lt;span class=&quot;error&quot;&gt;&amp;#91;jepsen.os.debian :as debian&amp;#93;&lt;/span&gt;&lt;br/&gt;
             [jepsen.flink.zookeeper :refer &lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-uri&amp;#93;&lt;/span&gt;]))&lt;/p&gt;

&lt;p&gt;+;;; runit process supervisor (&lt;a href=&quot;http://smarden.org/runit/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://smarden.org/runit/&lt;/a&gt;)&lt;br/&gt;
+;;;&lt;br/&gt;
+;;; We use runit to supervise Mesos processes because Mesos uses a &quot;fail-fast&quot; approach to&lt;br/&gt;
+;;; error handling, e.g., the Mesos master will exit when it discovers it has been partitioned away&lt;br/&gt;
+;;; from the Zookeeper quorum.&lt;br/&gt;
+&lt;br/&gt;
+(def runit-version &quot;2.1.2-3&quot;)&lt;br/&gt;
+&lt;br/&gt;
+(defn create-supervised-service!&lt;br/&gt;
+  &quot;Registers a service with the process supervisor and starts it.&quot;&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;service-name cmd&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (let [service-dir (str &quot;/etc/sv/&quot; service-name)&lt;br/&gt;
+        run-script (str service-dir &quot;/run&quot;)]&lt;br/&gt;
+    (c/su&lt;br/&gt;
+      (c/exec :mkdir :-p service-dir)&lt;br/&gt;
+      (c/exec :echo (clojure.string/join &quot;\n&quot; &lt;a href=&quot;#!/bin/sh&amp;quot; cmd&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&quot;#!/bin/sh&quot; cmd&lt;/a&gt;) :&amp;gt; run-script)&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I&apos;ll fix this.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16573300" author="githubbot" created="Wed, 8 Aug 2018 14:41:48 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6496: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10063&quot; title=&quot;Jepsen: Automatically restart Mesos Processes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10063&quot;&gt;&lt;del&gt;FLINK-10063&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Use runit to supervise mesos processes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6496#discussion_r208608118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6496#discussion_r208608118&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-jepsen/docker/Dockerfile-db&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -35,5 +35,12 @@ RUN mkdir -p /root/.ssh/ &amp;amp;&amp;amp; \&lt;br/&gt;
     chmod 600 /root/.ssh/authorized_keys &amp;amp;&amp;amp; \&lt;br/&gt;
     cat /root/id_rsa.pub &amp;gt;&amp;gt; /root/.ssh/authorized_keys&lt;/p&gt;

&lt;p&gt;+COPY sshd-run /etc/sv/service/sshd/run&lt;br/&gt;
+RUN chmod +x /etc/sv/service/sshd/run &amp;amp;&amp;amp; \&lt;br/&gt;
+    ln -sf /etc/sv/service/sshd /etc/service&lt;br/&gt;
+&lt;br/&gt;
 EXPOSE 22&lt;br/&gt;
-CMD exec /usr/sbin/sshd -D&lt;br/&gt;
+&lt;br/&gt;
+# Start runit process supervisor which will bring up sshd.&lt;br/&gt;
+# In our tests we can use runit to supervise more processes, e.g., Mesos.&lt;br/&gt;
+CMD runsvdir -P /etc/service /dev/null &amp;gt; /dev/null&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Yes is needed. It only redirects std err:&lt;/p&gt;

&lt;p&gt;   &amp;gt;&amp;gt;&amp;gt; If the log argument is given to runsvdir, all output to standard error is redirected to this log&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16573302" author="githubbot" created="Wed, 8 Aug 2018 14:41:57 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6496: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10063&quot; title=&quot;Jepsen: Automatically restart Mesos Processes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10063&quot;&gt;&lt;del&gt;FLINK-10063&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Use runit to supervise mesos processes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6496#discussion_r208608118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6496#discussion_r208608118&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-jepsen/docker/Dockerfile-db&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -35,5 +35,12 @@ RUN mkdir -p /root/.ssh/ &amp;amp;&amp;amp; \&lt;br/&gt;
     chmod 600 /root/.ssh/authorized_keys &amp;amp;&amp;amp; \&lt;br/&gt;
     cat /root/id_rsa.pub &amp;gt;&amp;gt; /root/.ssh/authorized_keys&lt;/p&gt;

&lt;p&gt;+COPY sshd-run /etc/sv/service/sshd/run&lt;br/&gt;
+RUN chmod +x /etc/sv/service/sshd/run &amp;amp;&amp;amp; \&lt;br/&gt;
+    ln -sf /etc/sv/service/sshd /etc/service&lt;br/&gt;
+&lt;br/&gt;
 EXPOSE 22&lt;br/&gt;
-CMD exec /usr/sbin/sshd -D&lt;br/&gt;
+&lt;br/&gt;
+# Start runit process supervisor which will bring up sshd.&lt;br/&gt;
+# In our tests we can use runit to supervise more processes, e.g., Mesos.&lt;br/&gt;
+CMD runsvdir -P /etc/service /dev/null &amp;gt; /dev/null&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Yes is needed. It only redirects std err:&lt;/p&gt;

&lt;p&gt;   &amp;gt; If the log argument is given to runsvdir, all output to standard error is redirected to this log&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16574452" author="githubbot" created="Thu, 9 Aug 2018 08:02:55 +0000"  >&lt;p&gt;tillrohrmann commented on issue #6496: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10063&quot; title=&quot;Jepsen: Automatically restart Mesos Processes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10063&quot;&gt;&lt;del&gt;FLINK-10063&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Use runit to supervise mesos processes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6496#issuecomment-411672800&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6496#issuecomment-411672800&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merging this PR.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16574455" author="githubbot" created="Thu, 9 Aug 2018 08:05:40 +0000"  >&lt;p&gt;asfgit closed pull request #6496: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10063&quot; title=&quot;Jepsen: Automatically restart Mesos Processes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10063&quot;&gt;&lt;del&gt;FLINK-10063&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Use runit to supervise mesos processes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6496&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-jepsen/docker/Dockerfile-db b/flink-jepsen/docker/Dockerfile-db&lt;br/&gt;
index 1555329af3f..cb60efce2e5 100644&lt;br/&gt;
&amp;#8212; a/flink-jepsen/docker/Dockerfile-db&lt;br/&gt;
+++ b/flink-jepsen/docker/Dockerfile-db&lt;br/&gt;
@@ -21,7 +21,7 @@ FROM debian:jessie&lt;br/&gt;
 RUN echo &quot;deb &lt;a href=&quot;http://http.debian.net/debian&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://http.debian.net/debian&lt;/a&gt; jessie-backports main&quot; &amp;gt;&amp;gt; /etc/apt/sources.list &amp;amp;&amp;amp; \&lt;br/&gt;
     apt-get update &amp;amp;&amp;amp; \&lt;br/&gt;
     apt-get install -y -t jessie-backports openjdk-8-jdk &amp;amp;&amp;amp; \&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;apt-get install -y apt-utils bzip2 curl faketime iproute iptables iputils-ping less libzip2 logrotate man man-db net-tools ntpdate psmisc python rsyslog sudo sysvinit sysvinit-core sysvinit-utils tar unzip vim wget&lt;br/&gt;
+    apt-get install -y apt-utils bzip2 curl faketime iproute iptables iputils-ping less libzip2 logrotate man man-db net-tools ntpdate psmisc python rsyslog runit sudo sysvinit sysvinit-core sysvinit-utils tar unzip vim wget&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; RUN apt-get update &amp;amp;&amp;amp; \&lt;br/&gt;
     apt-get -y install openssh-server &amp;amp;&amp;amp; \&lt;br/&gt;
@@ -35,5 +35,12 @@ RUN mkdir -p /root/.ssh/ &amp;amp;&amp;amp; \&lt;br/&gt;
     chmod 600 /root/.ssh/authorized_keys &amp;amp;&amp;amp; \&lt;br/&gt;
     cat /root/id_rsa.pub &amp;gt;&amp;gt; /root/.ssh/authorized_keys&lt;/p&gt;

&lt;p&gt;+COPY sshd-run /etc/sv/service/sshd/run&lt;br/&gt;
+RUN chmod +x /etc/sv/service/sshd/run &amp;amp;&amp;amp; \&lt;br/&gt;
+    ln -sf /etc/sv/service/sshd /etc/service&lt;br/&gt;
+&lt;br/&gt;
 EXPOSE 22&lt;br/&gt;
-CMD exec /usr/sbin/sshd -D&lt;br/&gt;
+&lt;br/&gt;
+# Start runit process supervisor which will bring up sshd.&lt;br/&gt;
+# In our tests we can use runit to supervise more processes, e.g., Mesos.&lt;br/&gt;
+CMD runsvdir -P /etc/service /dev/null &amp;gt; /dev/null&lt;br/&gt;
diff --git a/flink-jepsen/src/jepsen/flink/db.clj b/flink-jepsen/src/jepsen/flink/db.clj&lt;br/&gt;
index 9a725d7149a..becc551e2cf 100644&lt;br/&gt;
&amp;#8212; a/flink-jepsen/src/jepsen/flink/db.clj&lt;br/&gt;
+++ b/flink-jepsen/src/jepsen/flink/db.clj&lt;br/&gt;
@@ -97,7 +97,7 @@&lt;br/&gt;
   (if (cu/exists? log-dir) (cu/ls-full log-dir) []))&lt;/p&gt;

&lt;p&gt; (defn flink-db&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;test&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  []&lt;br/&gt;
   (reify db/DB&lt;br/&gt;
     (setup! &lt;span class=&quot;error&quot;&gt;&amp;#91;_ test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
       (c/su&lt;br/&gt;
@@ -131,7 +131,7 @@&lt;br/&gt;
   []&lt;br/&gt;
   (let [zk (zk/db deb-zookeeper-package)&lt;br/&gt;
         hadoop (hadoop/db hadoop-dist-url)&lt;/li&gt;
	&lt;li&gt;flink (flink-db test)]&lt;br/&gt;
+        flink (flink-db)]&lt;br/&gt;
     (combined-db &lt;span class=&quot;error&quot;&gt;&amp;#91;hadoop zk flink&amp;#93;&lt;/span&gt;)))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; (defn exec-flink!&lt;br/&gt;
@@ -192,7 +192,7 @@&lt;br/&gt;
   (let [zk (zk/db deb-zookeeper-package)&lt;br/&gt;
         hadoop (hadoop/db hadoop-dist-url)&lt;br/&gt;
         mesos (mesos/db deb-mesos-package deb-marathon-package)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;flink (flink-db test)]&lt;br/&gt;
+        flink (flink-db)]&lt;br/&gt;
     (combined-db &lt;span class=&quot;error&quot;&gt;&amp;#91;hadoop zk mesos flink&amp;#93;&lt;/span&gt;)))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; (defn submit-job-with-retry!&lt;br/&gt;
@@ -209,24 +209,25 @@&lt;br/&gt;
     (let [r (fu/retry (fn []&lt;br/&gt;
                         (http/post&lt;br/&gt;
                           (str (mesos/marathon-base-url test) &quot;/v2/apps&quot;)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{:form-params  {:id   &quot;flink&quot;&lt;/li&gt;
	&lt;li&gt;:cmd  (str &quot;HADOOP_CLASSPATH=`&quot; hadoop/install-dir &quot;/bin/hadoop classpath` &quot;&lt;/li&gt;
	&lt;li&gt;&quot;HADOOP_CONF_DIR=&quot; hadoop/hadoop-conf-dir &quot; &quot;&lt;/li&gt;
	&lt;li&gt;install-dir &quot;/bin/mesos-appmaster.sh &quot;&lt;/li&gt;
	&lt;li&gt;&quot;-Dmesos.master=&quot; (zookeeper-uri&lt;/li&gt;
	&lt;li&gt;test&lt;/li&gt;
	&lt;li&gt;mesos/zk-namespace) &quot; &quot;&lt;/li&gt;
	&lt;li&gt;&quot;-Djobmanager.rpc.address=$(hostname -f) &quot;&lt;/li&gt;
	&lt;li&gt;&quot;-Djobmanager.heap.mb=2048 &quot;&lt;/li&gt;
	&lt;li&gt;&quot;-Djobmanager.rpc.port=6123 &quot;&lt;/li&gt;
	&lt;li&gt;&quot;-Djobmanager.web.port=8081 &quot;&lt;/li&gt;
	&lt;li&gt;&quot;-Dmesos.resourcemanager.tasks.mem=2048 &quot;&lt;/li&gt;
	&lt;li&gt;&quot;-Dtaskmanager.heap.mb=2048 &quot;&lt;/li&gt;
	&lt;li&gt;&quot;-Dtaskmanager.numberOfTaskSlots=2 &quot;&lt;/li&gt;
	&lt;li&gt;&quot;-Dmesos.resourcemanager.tasks.cpus=1 &quot;&lt;/li&gt;
	&lt;li&gt;&quot;-Drest.bind-address=$(hostname -f) &quot;)&lt;/li&gt;
	&lt;li&gt;:cpus 1.0&lt;/li&gt;
	&lt;li&gt;:mem  2048}&lt;br/&gt;
+                          {:form-params  {:id                    &quot;flink&quot;&lt;br/&gt;
+                                          :cmd                   (str &quot;HADOOP_CLASSPATH=`&quot; hadoop/install-dir &quot;/bin/hadoop classpath` &quot;&lt;br/&gt;
+                                                                      &quot;HADOOP_CONF_DIR=&quot; hadoop/hadoop-conf-dir &quot; &quot;&lt;br/&gt;
+                                                                      install-dir &quot;/bin/mesos-appmaster.sh &quot;&lt;br/&gt;
+                                                                      &quot;-Dmesos.master=&quot; (zookeeper-uri&lt;br/&gt;
+                                                                                          test&lt;br/&gt;
+                                                                                          mesos/zk-namespace) &quot; &quot;&lt;br/&gt;
+                                                                      &quot;-Djobmanager.rpc.address=$(hostname -f) &quot;&lt;br/&gt;
+                                                                      &quot;-Djobmanager.heap.mb=2048 &quot;&lt;br/&gt;
+                                                                      &quot;-Djobmanager.rpc.port=6123 &quot;&lt;br/&gt;
+                                                                      &quot;-Djobmanager.web.port=8081 &quot;&lt;br/&gt;
+                                                                      &quot;-Dmesos.resourcemanager.tasks.mem=2048 &quot;&lt;br/&gt;
+                                                                      &quot;-Dtaskmanager.heap.mb=2048 &quot;&lt;br/&gt;
+                                                                      &quot;-Dtaskmanager.numberOfTaskSlots=2 &quot;&lt;br/&gt;
+                                                                      &quot;-Dmesos.resourcemanager.tasks.cpus=1 &quot;&lt;br/&gt;
+                                                                      &quot;-Drest.bind-address=$(hostname -f) &quot;)&lt;br/&gt;
+                                          :cpus                  1.0&lt;br/&gt;
+                                          :mem                   2048&lt;br/&gt;
+                                          :maxLaunchDelaySeconds 3}&lt;br/&gt;
                            :content-type :json})))]&lt;br/&gt;
       (info &quot;Submitted Flink Application via Marathon&quot; r)&lt;br/&gt;
       (c/on (-&amp;gt; test :nodes sort first)&lt;br/&gt;
diff --git a/flink-jepsen/src/jepsen/flink/mesos.clj b/flink-jepsen/src/jepsen/flink/mesos.clj&lt;br/&gt;
index fd75991bdf5..a73f25fd489 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-jepsen/src/jepsen/flink/mesos.clj&lt;br/&gt;
+++ b/flink-jepsen/src/jepsen/flink/mesos.clj&lt;br/&gt;
@@ -24,11 +24,37 @@&lt;br/&gt;
             &lt;span class=&quot;error&quot;&gt;&amp;#91;jepsen.os.debian :as debian&amp;#93;&lt;/span&gt;&lt;br/&gt;
             [jepsen.flink.zookeeper :refer &lt;span class=&quot;error&quot;&gt;&amp;#91;zookeeper-uri&amp;#93;&lt;/span&gt;]))&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+;;; runit process supervisor (&lt;a href=&quot;http://smarden.org/runit/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://smarden.org/runit/&lt;/a&gt;)&lt;br/&gt;
+;;;&lt;br/&gt;
+;;; We use runit to supervise Mesos processes because Mesos uses a &quot;fail-fast&quot; approach to&lt;br/&gt;
+;;; error handling, e.g., the Mesos master will exit when it discovers it has been partitioned away&lt;br/&gt;
+;;; from the Zookeeper quorum.&lt;br/&gt;
+&lt;br/&gt;
+(def runit-version &quot;2.1.2-3&quot;)&lt;br/&gt;
+&lt;br/&gt;
+(defn create-supervised-service!&lt;br/&gt;
+  &quot;Registers a service with the process supervisor and starts it.&quot;&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;service-name cmd&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (let [service-dir (str &quot;/etc/sv/&quot; service-name)&lt;br/&gt;
+        run-script (str service-dir &quot;/run&quot;)]&lt;br/&gt;
+    (c/su&lt;br/&gt;
+      (c/exec :mkdir :-p service-dir)&lt;br/&gt;
+      (c/exec :echo (clojure.string/join &quot;\n&quot; [&quot;#!/bin/sh&quot;&lt;br/&gt;
+                                               &quot;exec 2&amp;gt;&amp;amp;1&quot;&lt;br/&gt;
+                                               (str &quot;exec &quot; cmd)]) :&amp;gt; run-script)&lt;br/&gt;
+      (c/exec :chmod :+x run-script)&lt;br/&gt;
+      (c/exec :ln :-sf service-dir (str &quot;/etc/service/&quot; service-name)))))&lt;br/&gt;
+&lt;br/&gt;
+(defn stop-supervised-service!&lt;br/&gt;
+  &quot;Stops a service and removes it from supervision.&quot;&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;service-name&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (c/su&lt;br/&gt;
+    (c/exec :sv :down service-name)&lt;br/&gt;
+    (c/exec :rm :-f (str &quot;/etc/service/&quot; service-name))))&lt;br/&gt;
+&lt;br/&gt;
 ;;; Mesos&lt;/p&gt;

&lt;p&gt; (def master-count 1)&lt;br/&gt;
-(def master-pidfile &quot;/var/run/mesos/master.pid&quot;)&lt;br/&gt;
-(def slave-pidfile &quot;/var/run/mesos/slave.pid&quot;)&lt;br/&gt;
 (def master-dir &quot;/var/lib/mesos/master&quot;)&lt;br/&gt;
 (def slave-dir &quot;/var/lib/mesos/slave&quot;)&lt;br/&gt;
 (def log-dir &quot;/var/log/mesos&quot;)&lt;br/&gt;
@@ -40,115 +66,130 @@&lt;/p&gt;

&lt;p&gt; (def marathon-bin &quot;/usr/bin/marathon&quot;)&lt;br/&gt;
 (def zk-marathon-namespace &quot;marathon&quot;)&lt;br/&gt;
-(def marathon-pidfile &quot;/var/run/mesos/marathon.pid&quot;)&lt;br/&gt;
 (def marathon-rest-port 8080)&lt;/p&gt;

&lt;p&gt;-(defn install!&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;test node mesos-version marathon-version&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;(c/su&lt;/li&gt;
	&lt;li&gt;(debian/add-repo! :mesosphere&lt;/li&gt;
	&lt;li&gt;&quot;deb &lt;a href=&quot;http://repos.mesosphere.com/debian&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://repos.mesosphere.com/debian&lt;/a&gt; jessie main&quot;&lt;/li&gt;
	&lt;li&gt;&quot;keyserver.ubuntu.com&quot;&lt;/li&gt;
	&lt;li&gt;&quot;E56151BF&quot;)&lt;/li&gt;
	&lt;li&gt;(debian/install {:mesos    mesos-version&lt;/li&gt;
	&lt;li&gt;:marathon marathon-version})&lt;/li&gt;
	&lt;li&gt;(c/exec :mkdir :-p &quot;/var/run/mesos&quot;)&lt;/li&gt;
	&lt;li&gt;(c/exec :mkdir :-p master-dir)&lt;/li&gt;
	&lt;li&gt;(c/exec :mkdir :-p slave-dir)))&lt;br/&gt;
-&lt;br/&gt;
 ;;; Mesos functions&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+(defn mesos-master-cmd&lt;br/&gt;
+  &quot;Returns the command to run the mesos master.&quot;&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (clojure.string/join &quot; &quot;&lt;br/&gt;
+                       [&quot;env GLOG_v=1&quot;&lt;br/&gt;
+                        master-bin&lt;br/&gt;
+                        (str &quot;--hostname=&quot; (name node))&lt;br/&gt;
+                        (str &quot;--log_dir=&quot; log-dir)&lt;br/&gt;
+                        (str &quot;--offer_timeout=30secs&quot;)&lt;br/&gt;
+                        (str &quot;--quorum=&quot; (util/majority master-count))&lt;br/&gt;
+                        (str &quot;--registry_fetch_timeout=120secs&quot;)&lt;br/&gt;
+                        (str &quot;--registry_store_timeout=5secs&quot;)&lt;br/&gt;
+                        (str &quot;--work_dir=&quot; master-dir)&lt;br/&gt;
+                        (str &quot;--zk=&quot; (zookeeper-uri test zk-namespace))]))&lt;br/&gt;
+&lt;br/&gt;
+(defn mesos-slave-cmd&lt;br/&gt;
+  &quot;Returns the command to run the mesos agent.&quot;&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (clojure.string/join &quot; &quot;&lt;br/&gt;
+                       [&quot;env GLOG_v=1&quot;&lt;br/&gt;
+                        slave-bin&lt;br/&gt;
+                        (str &quot;--hostname=&quot; (name node))&lt;br/&gt;
+                        (str &quot;--log_dir=&quot; log-dir)&lt;br/&gt;
+                        (str &quot;--master=&quot; (zookeeper-uri test zk-namespace))&lt;br/&gt;
+                        (str &quot;--recovery_timeout=30secs&quot;)&lt;br/&gt;
+                        (str &quot;--work_dir=&quot; slave-dir)]))&lt;br/&gt;
+&lt;br/&gt;
+(defn create-mesos-master-supervised-service!&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (create-supervised-service! &quot;mesos-master&quot;&lt;br/&gt;
+                              (mesos-master-cmd test node)))&lt;br/&gt;
+&lt;br/&gt;
+(defn create-mesos-slave-supervised-service!&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (create-supervised-service! &quot;mesos-slave&quot;&lt;br/&gt;
+                              (mesos-slave-cmd test node)))&lt;br/&gt;
+&lt;br/&gt;
+(defn master-node?&lt;br/&gt;
+  &quot;Returns a truthy value if the node should run the mesos master.&quot;&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (some #&lt;/p&gt;
{node} (take master-count (sort (:nodes test)))))&lt;br/&gt;
+&lt;br/&gt;
 (defn start-master!&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
-  (when (some #{node}
&lt;p&gt; (take master-count (sort (:nodes test))))&lt;br/&gt;
+  (when (master-node? test node)&lt;br/&gt;
     (info node &quot;Starting mesos master&quot;)&lt;br/&gt;
     (c/su&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;(c/exec :start-stop-daemon&lt;/li&gt;
	&lt;li&gt;:--background&lt;/li&gt;
	&lt;li&gt;:--chdir master-dir&lt;/li&gt;
	&lt;li&gt;:--exec &quot;/usr/bin/env&quot;&lt;/li&gt;
	&lt;li&gt;:--make-pidfile&lt;/li&gt;
	&lt;li&gt;:--no-close&lt;/li&gt;
	&lt;li&gt;:--oknodo&lt;/li&gt;
	&lt;li&gt;:--pidfile master-pidfile&lt;/li&gt;
	&lt;li&gt;:--start&lt;/li&gt;
	&lt;li&gt;:--&lt;/li&gt;
	&lt;li&gt;&quot;GLOG_v=1&quot;&lt;/li&gt;
	&lt;li&gt;master-bin&lt;/li&gt;
	&lt;li&gt;(str &quot;--hostname=&quot; (name node))&lt;/li&gt;
	&lt;li&gt;(str &quot;--log_dir=&quot; log-dir)&lt;/li&gt;
	&lt;li&gt;(str &quot;--offer_timeout=30secs&quot;)&lt;/li&gt;
	&lt;li&gt;(str &quot;--quorum=&quot; (util/majority master-count))&lt;/li&gt;
	&lt;li&gt;(str &quot;--registry_fetch_timeout=120secs&quot;)&lt;/li&gt;
	&lt;li&gt;(str &quot;--registry_store_timeout=5secs&quot;)&lt;/li&gt;
	&lt;li&gt;(str &quot;--work_dir=&quot; master-dir)&lt;/li&gt;
	&lt;li&gt;(str &quot;--zk=&quot; (zookeeper-uri test zk-namespace))&lt;/li&gt;
	&lt;li&gt;:&amp;gt;&amp;gt; (str log-dir &quot;/master.stdout&quot;)&lt;/li&gt;
	&lt;li&gt;(c/lit &quot;2&amp;gt;&amp;amp;1&quot;)))))&lt;br/&gt;
+      (create-mesos-master-supervised-service! test node))))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; (defn start-slave!&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;(when-not (some #
{node}
&lt;p&gt; (take master-count (sort (:nodes test))))&lt;br/&gt;
+  (when-not (master-node? test node)&lt;br/&gt;
     (info node &quot;Starting mesos slave&quot;)&lt;br/&gt;
     (c/su&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;(c/exec :start-stop-daemon :--start&lt;/li&gt;
	&lt;li&gt;:--background&lt;/li&gt;
	&lt;li&gt;:--chdir slave-dir&lt;/li&gt;
	&lt;li&gt;:--exec slave-bin&lt;/li&gt;
	&lt;li&gt;:--make-pidfile&lt;/li&gt;
	&lt;li&gt;:--no-close&lt;/li&gt;
	&lt;li&gt;:--pidfile slave-pidfile&lt;/li&gt;
	&lt;li&gt;:--oknodo&lt;/li&gt;
	&lt;li&gt;:--&lt;/li&gt;
	&lt;li&gt;(str &quot;--hostname=&quot; (name node))&lt;/li&gt;
	&lt;li&gt;(str &quot;--log_dir=&quot; log-dir)&lt;/li&gt;
	&lt;li&gt;(str &quot;--master=&quot; (zookeeper-uri test zk-namespace))&lt;/li&gt;
	&lt;li&gt;(str &quot;--recovery_timeout=30secs&quot;)&lt;/li&gt;
	&lt;li&gt;(str &quot;--work_dir=&quot; slave-dir)&lt;/li&gt;
	&lt;li&gt;:&amp;gt;&amp;gt; (str log-dir &quot;/slave.stdout&quot;)&lt;/li&gt;
	&lt;li&gt;(c/lit &quot;2&amp;gt;&amp;amp;1&quot;)))))&lt;br/&gt;
+      (create-mesos-slave-supervised-service! test node))))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; (defn stop-master!&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;node&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;(info node &quot;Stopping mesos master&quot;)&lt;/li&gt;
	&lt;li&gt;(meh (cu/grepkill! :mesos-master))&lt;/li&gt;
	&lt;li&gt;(meh (c/exec :rm :-rf master-pidfile))&lt;/li&gt;
	&lt;li&gt;(meh (c/exec :rm :-rf&lt;/li&gt;
	&lt;li&gt;(c/lit (str log-dir &quot;/*&quot;))&lt;/li&gt;
	&lt;li&gt;(c/lit (str master-dir &quot;/*&quot;)))))&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (when (master-node? test node)&lt;br/&gt;
+    (info node &quot;Stopping mesos master&quot;)&lt;br/&gt;
+    (stop-supervised-service! &quot;mesos-master&quot;)&lt;br/&gt;
+    (meh (c/exec :rm :-rf&lt;br/&gt;
+                 (c/lit (str log-dir &quot;/*&quot;))&lt;br/&gt;
+                 (c/lit (str master-dir &quot;/*&quot;))))))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; (defn stop-slave!&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;node&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;(info node &quot;Stopping mesos slave&quot;)&lt;/li&gt;
	&lt;li&gt;(meh (cu/grepkill! :mesos-slave))&lt;/li&gt;
	&lt;li&gt;(meh (c/exec :rm :-rf slave-pidfile))&lt;/li&gt;
	&lt;li&gt;(meh (c/exec :rm :-rf&lt;/li&gt;
	&lt;li&gt;(c/lit (str log-dir &quot;/*&quot;))&lt;/li&gt;
	&lt;li&gt;(c/lit (str slave-dir &quot;/*&quot;)))))&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (when-not (master-node? test node)&lt;br/&gt;
+    (info node &quot;Stopping mesos slave&quot;)&lt;br/&gt;
+    (stop-supervised-service! &quot;mesos-slave&quot;)&lt;br/&gt;
+    (meh (c/exec :rm :-rf&lt;br/&gt;
+                 (c/lit (str log-dir &quot;/*&quot;))&lt;br/&gt;
+                 (c/lit (str slave-dir &quot;/*&quot;))))))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; ;;; Marathon functions&lt;/p&gt;

&lt;p&gt;+(defn install!&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node mesos-version marathon-version&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (c/su&lt;br/&gt;
+    (debian/add-repo! :mesosphere&lt;br/&gt;
+                      &quot;deb &lt;a href=&quot;http://repos.mesosphere.com/debian&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://repos.mesosphere.com/debian&lt;/a&gt; jessie main&quot;&lt;br/&gt;
+                      &quot;keyserver.ubuntu.com&quot;&lt;br/&gt;
+                      &quot;E56151BF&quot;)&lt;br/&gt;
+    (debian/install {:mesos    mesos-version&lt;br/&gt;
+                     :marathon marathon-version&lt;br/&gt;
+                     :runit    runit-version})&lt;br/&gt;
+    (c/exec :mkdir :-p &quot;/var/run/mesos&quot;)&lt;br/&gt;
+    (c/exec :mkdir :-p master-dir)&lt;br/&gt;
+    (c/exec :mkdir :-p slave-dir)))&lt;br/&gt;
+&lt;br/&gt;
+(defn marathon-cmd&lt;br/&gt;
+  &quot;Returns the command to run the marathon.&quot;&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (clojure.string/join &quot; &quot;&lt;br/&gt;
+                       [marathon-bin&lt;br/&gt;
+                        (str &quot;--hostname &quot; node)&lt;br/&gt;
+                        (str &quot;--master &quot; (zookeeper-uri test zk-namespace))&lt;br/&gt;
+                        (str &quot;--zk &quot; (zookeeper-uri test zk-marathon-namespace))&lt;br/&gt;
+                        (str &quot;&amp;gt;&amp;gt; &quot; log-dir &quot;/marathon.out&quot;)]))&lt;br/&gt;
+&lt;br/&gt;
+(defn create-marathon-supervised-service!&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (create-supervised-service! &quot;marathon&quot;&lt;br/&gt;
+                              (marathon-cmd test node)))&lt;br/&gt;
+&lt;br/&gt;
+(defn marathon-node?&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (= node (first (sort (:nodes test)))))&lt;br/&gt;
+&lt;br/&gt;
 (defn start-marathon!&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;(when (= node (first (sort (:nodes test))))&lt;br/&gt;
+  (when (marathon-node? test node)&lt;br/&gt;
     (info &quot;Start marathon&quot;)&lt;br/&gt;
     (c/su&lt;/li&gt;
	&lt;li&gt;(c/exec :start-stop-daemon :--start&lt;/li&gt;
	&lt;li&gt;:--background&lt;/li&gt;
	&lt;li&gt;:--exec marathon-bin&lt;/li&gt;
	&lt;li&gt;:--make-pidfile&lt;/li&gt;
	&lt;li&gt;:--no-close&lt;/li&gt;
	&lt;li&gt;:--pidfile marathon-pidfile&lt;/li&gt;
	&lt;li&gt;:--&lt;/li&gt;
	&lt;li&gt;(c/lit (str &quot;--hostname &quot; node))&lt;/li&gt;
	&lt;li&gt;(c/lit (str &quot;--master &quot; (zookeeper-uri test zk-namespace)))&lt;/li&gt;
	&lt;li&gt;(c/lit (str &quot;--zk &quot; (zookeeper-uri test zk-marathon-namespace)))&lt;/li&gt;
	&lt;li&gt;:&amp;gt;&amp;gt; (str log-dir &quot;/marathon.stdout&quot;)&lt;/li&gt;
	&lt;li&gt;(c/lit &quot;2&amp;gt;&amp;amp;1&quot;)))))&lt;br/&gt;
+      (create-marathon-supervised-service! test node))))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; (defn stop-marathon!&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[]&lt;/li&gt;
	&lt;li&gt;(cu/grepkill! &quot;marathon&quot;))&lt;br/&gt;
+  &lt;span class=&quot;error&quot;&gt;&amp;#91;test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
+  (when (marathon-node? test node)&lt;br/&gt;
+    (stop-supervised-service! &quot;marathon&quot;)))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; (defn marathon-base-url&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;test&amp;#93;&lt;/span&gt;&lt;br/&gt;
@@ -163,9 +204,9 @@&lt;br/&gt;
       (start-slave! test node)&lt;br/&gt;
       (start-marathon! test node))&lt;br/&gt;
     (teardown! &lt;span class=&quot;error&quot;&gt;&amp;#91;this test node&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;(stop-slave! node)&lt;/li&gt;
	&lt;li&gt;(stop-master! node)&lt;/li&gt;
	&lt;li&gt;(stop-marathon!))&lt;br/&gt;
+      (stop-slave! test node)&lt;br/&gt;
+      (stop-master! test node)&lt;br/&gt;
+      (stop-marathon! test node))&lt;br/&gt;
     db/LogFiles&lt;br/&gt;
     (log-files &lt;span class=&quot;error&quot;&gt;&amp;#91;_ test node&amp;#93;&lt;/span&gt;&lt;br/&gt;
       (if (cu/exists? log-dir) (cu/ls-full log-dir) []))))&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16574457" author="till.rohrmann" created="Thu, 9 Aug 2018 08:06:53 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
master:&lt;br/&gt;
812ac8b2a13bb71cf4e5859b245cf13dfddbd222&lt;br/&gt;
c029d2af9de1346cf3372a55fff663cd9b61e3f1&lt;/p&gt;

&lt;p&gt;1.6.1:&lt;br/&gt;
a8d2f904df2d607c934b4f3a4f17c35e12d6b48b&lt;br/&gt;
bdab563b7f05b96ac0d0a582fdfa3bd235ec8e17&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wpg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>