<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6434] There may be allocatedSlots leak in SlotPool</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6434</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;If the call allocateSlot() from Execution to Slotpool timeout, the job will begin to failover, but the pending request are still in SlotPool, if then a new slot register to SlotPool, it may be fulfill the outdated pending request and be added to allocatedSlots, but it will never be used and will never be recycled.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13068669">FLINK-6434</key>
            <summary>There may be allocatedSlots leak in SlotPool</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tiemsn">shuai.xu</assignee>
                                    <reporter username="tiemsn">shuai.xu</reporter>
                        <labels>
                            <label>flip-6</label>
                    </labels>
                <created>Wed, 3 May 2017 07:35:27 +0000</created>
                <updated>Thu, 28 Feb 2019 14:12:55 +0000</updated>
                            <resolved>Fri, 10 Nov 2017 10:24:58 +0000</resolved>
                                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15997961" author="till.rohrmann" created="Fri, 5 May 2017 09:02:09 +0000"  >&lt;p&gt;Thanks for reporting the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tiemsn&quot; class=&quot;user-hover&quot; rel=&quot;tiemsn&quot;&gt;tiemsn&lt;/a&gt;. This sounds like a bug and should be fixed.&lt;/p&gt;

&lt;p&gt;I think we could solve it the following way: We generate the &lt;tt&gt;AllocationID&lt;/tt&gt; in &lt;tt&gt;ProviderAndOwner#allocateSlot&lt;/tt&gt; and pass it to &lt;tt&gt;SlotPoolGateway#allocateSlot&lt;/tt&gt;. On the returned future we register an exception handler which will call &lt;tt&gt;SlotPoolGateway#failAllocation&lt;/tt&gt; with the generated &lt;tt&gt;AllocationID&lt;/tt&gt;. That way we should be able to deal with timeouts on the &lt;tt&gt;Execution&lt;/tt&gt; side. What do you think?&lt;/p&gt;</comment>
                            <comment id="16000232" author="tiemsn" created="Mon, 8 May 2017 04:07:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; This seems can not fix the bug completely, as between allocateSlot(allcationID1) and failAllocation(allcoationID1), another free slot with allocationID2 may fulfill the pending request, and the allocatedSlots record it will allocationID2, failAllocation(allcoationID1) can not release it, the slot is still leaked.&lt;/p&gt;</comment>
                            <comment id="16000369" author="till.rohrmann" created="Mon, 8 May 2017 07:32:56 +0000"  >&lt;p&gt;You&apos;re right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tiemsn&quot; class=&quot;user-hover&quot; rel=&quot;tiemsn&quot;&gt;tiemsn&lt;/a&gt;. The problem seems to be that the actual slot allocation has a different lifetime than a concrete slot request. I think we have to introduce a slot request id which can be used to fail a specific slot request. That way we decouple the requests from the actual slots a &lt;tt&gt;SlotPool&lt;/tt&gt; has available.&lt;/p&gt;</comment>
                            <comment id="16000435" author="tiemsn" created="Mon, 8 May 2017 08:32:41 +0000"  >&lt;p&gt;Yes, add a request id can solve the problem.&lt;/p&gt;</comment>
                            <comment id="16068237" author="till.rohrmann" created="Thu, 29 Jun 2017 12:01:32 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tiemsn&quot; class=&quot;user-hover&quot; rel=&quot;tiemsn&quot;&gt;tiemsn&lt;/a&gt;, what&apos;s the state of the fix? Are you working on this issue?&lt;/p&gt;</comment>
                            <comment id="16073081" author="tiemsn" created="Tue, 4 Jul 2017 04:07:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; Sorry, I have not start working on it&lt;/p&gt;</comment>
                            <comment id="16235157" author="githubbot" created="Thu, 2 Nov 2017 04:28:00 +0000"  >&lt;p&gt;GitHub user shuai-xu opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6434&quot; title=&quot;There may be allocatedSlots leak in SlotPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6434&quot;&gt;&lt;del&gt;FLINK-6434&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; cancel slot allocation if request timed out in ProviderAndOwner&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This pr adds a cancel slot allocation protocol between ProviderAndOwner and SlotPool. So that ProviderAndOwner can cancel the slot allocations no longer need to avoid slot leaking.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Let the ProviderAndOwner generate the allocation id before calling allocateSlot to slot pool.&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;If the allocateSlot call timed out, ProviderAndOwner cancel the previos allocation to slot pool.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change added tests and can be verified as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Added unittest in SlotPoolRpcTest&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Modify the existing SlotPoolTest&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/shuai-xu/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/shuai-xu/flink&lt;/a&gt; jira-6434&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4937&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ab3c599d55847451a1194ba55375207267561a71&lt;br/&gt;
Author: shuai.xus &amp;lt;shuai.xus@alibaba-inc.com&amp;gt;&lt;br/&gt;
Date:   2017-10-20T09:12:39Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6434&quot; title=&quot;There may be allocatedSlots leak in SlotPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6434&quot;&gt;&lt;del&gt;FLINK-6434&lt;/del&gt;&lt;/a&gt; cancel slot allocation if request timed out in ProviderAndOwner&lt;/p&gt;

&lt;p&gt;    Summary:&lt;br/&gt;
    This fix flink jira #6434&lt;br/&gt;
    1. Let the ProviderAndOwner generate the allcation id before calling allocateSlot to slot pool.&lt;br/&gt;
    2. If the allocateSlot call timed out, ProviderAndOwner cancel the previos allocation to slot pool.&lt;/p&gt;

&lt;p&gt;    Test Plan: UnitTest&lt;/p&gt;

&lt;p&gt;    Reviewers: haitao.w&lt;/p&gt;

&lt;p&gt;    Differential Revision: &lt;a href=&quot;https://aone.alibaba-inc.com/code/D323990&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://aone.alibaba-inc.com/code/D323990&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16236170" author="githubbot" created="Thu, 2 Nov 2017 17:25:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148569315&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148569315&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -361,9 +374,19 @@ private void slotRequestToResourceManagerFailed(AllocationID allocationID, Throw&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	private void checkTimeoutSlotAllocation(AllocationID allocationID) &lt;/p&gt;
{
    +		removePendingRequestWithException(allocationID, new TimeoutException(&quot;Slot allocation request &quot; + allocationID + &quot; timed out&quot;));
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void removePendingRequestWithException(AllocationID allocationID, Exception e) {&lt;br/&gt;
     		PendingRequest request = pendingRequests.remove(allocationID);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (request != null &amp;amp;&amp;amp; !request.getFuture().isDone()) {&lt;/li&gt;
	&lt;li&gt;request.getFuture().completeExceptionally(new TimeoutException(&quot;Slot allocation request timed out&quot;));&lt;br/&gt;
    +		if (request != null &amp;amp;&amp;amp; (!request.getFuture().isDone() || request.getFuture().isCompletedExceptionally())) {&lt;br/&gt;
    +			//TODO: the following line depends on the pr: &lt;a href=&quot;https://github.com/apache/flink/pull/4887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887&lt;/a&gt;&lt;br/&gt;
    +			//if (resourceManagerGateway != null) 
{
    +			//	resourceManagerGateway.cancelSlotRequest(jobId, jobMasterId, allocationID);
    +			//}
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This should be removed and added once #4887 has been merged.&lt;/p&gt;</comment>
                            <comment id="16236171" author="githubbot" created="Thu, 2 Nov 2017 17:25:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148570278&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148570278&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}
&lt;p&gt;    +		catch (ExecutionException e) &lt;/p&gt;
{
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}
&lt;p&gt;    +		catch (Exception e) &lt;/p&gt;
{
    +			fail(&quot;wrong exception: &quot; + e);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		// 2. test the pending request is in pendingRequests&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This should be a separate test.&lt;/p&gt;</comment>
                            <comment id="16236172" author="githubbot" created="Thu, 2 Nov 2017 17:25:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148570387&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148570387&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			future.get(2, TimeUnit.SECONDS);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Timeouts should be lower.&lt;/p&gt;</comment>
                            <comment id="16236173" author="githubbot" created="Thu, 2 Nov 2017 17:25:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148592528&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148592528&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -361,9 +374,19 @@ private void slotRequestToResourceManagerFailed(AllocationID allocationID, Throw&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	private void checkTimeoutSlotAllocation(AllocationID allocationID) &lt;/p&gt;
{
    +		removePendingRequestWithException(allocationID, new TimeoutException(&quot;Slot allocation request &quot; + allocationID + &quot; timed out&quot;));
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void removePendingRequestWithException(AllocationID allocationID, Exception e) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    maybe we could refactor this method into `failPendingRequest(PendingRequest, Exception)`, then it could be used by `checkTimeoutSlotAllocation` and `checkTimeoutRequestWaitingForResourceManager`&lt;/p&gt;</comment>
                            <comment id="16236174" author="githubbot" created="Thu, 2 Nov 2017 17:25:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148571851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148571851&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolTest.java &amp;#8212;&lt;br/&gt;
    @@ -294,11 +296,11 @@ public void returnAllocatedSlot(Slot slot) {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static ResourceManagerGateway createResourceManagerGatewayMock() {&lt;br/&gt;
    +	static ResourceManagerGateway createResourceManagerGatewayMock() {&lt;br/&gt;
     		ResourceManagerGateway resourceManagerGateway = mock(ResourceManagerGateway.class);&lt;br/&gt;
     		when(resourceManagerGateway&lt;/li&gt;
	&lt;li&gt;.requestSlot(any(JobMasterId.class), any(SlotRequest.class), any(Time.class)))&lt;/li&gt;
	&lt;li&gt;.thenReturn(mock(CompletableFuture.class, RETURNS_MOCKS));&lt;br/&gt;
    +				.requestSlot(any(JobMasterId.class), any(SlotRequest.class), any(Time.class)))&lt;br/&gt;
    +				.thenReturn(mock(CompletableFuture.class, RETURNS_MOCKS));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why not returning a proper `CompletableFuture` here?&lt;/p&gt;</comment>
                            <comment id="16236175" author="githubbot" created="Thu, 2 Nov 2017 17:25:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148570569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148570569&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}&lt;br/&gt;
    +		catch (ExecutionException e) {
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}&lt;br/&gt;
    +		catch (Exception e) {
    +			fail(&quot;wrong exception: &quot; + e);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		// 2. test the pending request is in pendingRequests&lt;br/&gt;
    +		ResourceManagerGateway resourceManagerGateway = SlotPoolTest.createResourceManagerGatewayMock();&lt;br/&gt;
    +		pool.connectToResourceManager(resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +		AllocationID allocationID2 = new AllocationID();&lt;br/&gt;
    +		future = slotPoolGateway.allocateSlot(allocationID2, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try {    +			future.get(2, TimeUnit.SECONDS);    +			fail(&quot;We expected a AskTimeoutException.&quot;);    +		}
&lt;p&gt;    +		catch (ExecutionException e) &lt;/p&gt;
{
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}
&lt;p&gt;    +		catch (Exception e) &lt;/p&gt;
{
    +			fail(&quot;wrong exception: &quot; + e);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfPendingRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID2);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfPendingRequests());&lt;br/&gt;
    +		//verify(resourceManagerGateway, times(1)).cancelSlotRequest(jid, any(JobMasterId.class), allocationID2);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    should be removed&lt;/p&gt;</comment>
                            <comment id="16236176" author="githubbot" created="Thu, 2 Nov 2017 17:25:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148570094&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148570094&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}
&lt;p&gt;    +		catch (ExecutionException e) {&lt;br/&gt;
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Better to check with `instanceOf` I think.&lt;/p&gt;</comment>
                            <comment id="16236177" author="githubbot" created="Thu, 2 Nov 2017 17:25:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148572112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148572112&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolTest.java &amp;#8212;&lt;br/&gt;
    @@ -294,11 +296,11 @@ public void returnAllocatedSlot(Slot slot) {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static ResourceManagerGateway createResourceManagerGatewayMock() {&lt;br/&gt;
    +	static ResourceManagerGateway createResourceManagerGatewayMock() {&lt;br/&gt;
     		ResourceManagerGateway resourceManagerGateway = mock(ResourceManagerGateway.class);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We could think about implementing a `SimpleAckingResourceManagerGateway` for testing purposes. That way we avoid mocking too much.&lt;/p&gt;</comment>
                            <comment id="16236178" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148596180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148596180&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -262,23 +263,36 @@ public void disconnectResourceManager() {&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public CompletableFuture&amp;lt;SimpleSlot&amp;gt; allocateSlot(&lt;/li&gt;
	&lt;li&gt;ScheduledUnit task,&lt;br/&gt;
    +	public CompletableFuture&amp;lt;SimpleSlot&amp;gt; allocateSlot(AllocationID allocationID,&lt;br/&gt;
     			ResourceProfile resources,&lt;br/&gt;
     			Iterable&amp;lt;TaskManagerLocation&amp;gt; locationPreferences,&lt;br/&gt;
     			Time timeout) 
{
     
    -		return internalAllocateSlot(task, resources, locationPreferences);
    +		return internalAllocateSlot(allocationID, resources, locationPreferences);
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	@Override&lt;br/&gt;
     	public void returnAllocatedSlot(Slot slot) &lt;/p&gt;
{
     		internalReturnAllocatedSlot(slot);
     	}

&lt;p&gt;    +	@Override&lt;br/&gt;
    +	public void cancelSlotAllocation(AllocationID allocationID) {&lt;br/&gt;
    +		waitingForResourceManager.remove(allocationID);&lt;br/&gt;
    +		&lt;br/&gt;
    +		removePendingRequestWithException(allocationID, new CancellationException(&quot;Allocation &quot; + allocationID + &quot; cancelled&quot;));&lt;br/&gt;
    +&lt;br/&gt;
    +		if (allocatedSlots.contains(allocationID)) {&lt;br/&gt;
    +			Slot slot = allocatedSlots.get(allocationID);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    We could avoid the `contains` call by simply calling `get` and then compare against `null`.&lt;/p&gt;</comment>
                            <comment id="16236179" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148570462&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148570462&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Timeout should be lower&lt;/p&gt;</comment>
                            <comment id="16236180" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148571514&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148571514&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}&lt;br/&gt;
    +		catch (ExecutionException e) {
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}&lt;br/&gt;
    +		catch (Exception e) {
    +			fail(&quot;wrong exception: &quot; + e);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		// 2. test the pending request is in pendingRequests&lt;br/&gt;
    +		ResourceManagerGateway resourceManagerGateway = SlotPoolTest.createResourceManagerGatewayMock();&lt;br/&gt;
    +		pool.connectToResourceManager(resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +		AllocationID allocationID2 = new AllocationID();&lt;br/&gt;
    +		future = slotPoolGateway.allocateSlot(allocationID2, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try {    +			future.get(2, TimeUnit.SECONDS);    +			fail(&quot;We expected a AskTimeoutException.&quot;);    +		}
&lt;p&gt;    +		catch (ExecutionException e) &lt;/p&gt;
{
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}&lt;br/&gt;
    +		catch (Exception e) {
    +			fail(&quot;wrong exception: &quot; + e);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfPendingRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID2);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfPendingRequests());&lt;br/&gt;
    +		//verify(resourceManagerGateway, times(1)).cancelSlotRequest(jid, any(JobMasterId.class), allocationID2);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 3. test the allocation is timed out in client side but the request is fulfilled in slot pool&lt;br/&gt;
    +		AllocationID allocationID3 = new AllocationID();&lt;br/&gt;
    +		future = slotPoolGateway.allocateSlot(allocationID3, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try {
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}&lt;br/&gt;
    +		catch (ExecutionException e) {    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());    +		}
&lt;p&gt;    +		catch (Exception e) &lt;/p&gt;
{
    +			fail(&quot;wrong exception: &quot; + e);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		ResourceID resourceID = ResourceID.generate();&lt;br/&gt;
    +		AllocatedSlot allocatedSlot = SlotPoolTest.createAllocatedSlot(resourceID, allocationID3, jid, DEFAULT_TESTING_PROFILE);&lt;br/&gt;
    +		slotPoolGateway.registerTaskManager(resourceID);&lt;br/&gt;
    +		assertTrue(slotPoolGateway.offerSlot(allocatedSlot).get());&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfPendingRequests());&lt;br/&gt;
    +		assertTrue(pool.getAllocatedSlots().contains(allocationID3));&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID3);&lt;br/&gt;
    +		assertFalse(pool.getAllocatedSlots().contains(allocationID3));&lt;br/&gt;
    +		assertTrue(pool.getAvailableSlots().contains(allocationID3));&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testProviderAndOwner() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.seconds(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		ResourceManagerGateway resourceManagerGateway = SlotPoolTest.createResourceManagerGatewayMock();&lt;br/&gt;
    +		pool.connectToResourceManager(resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +		ScheduledUnit mockScheduledUnit = mock(ScheduledUnit.class);&lt;br/&gt;
    +		Execution mockExecution = mock(Execution.class);&lt;br/&gt;
    +		ExecutionVertex mockExecutionVertex = mock(ExecutionVertex.class);&lt;br/&gt;
    +		when(mockScheduledUnit.getTaskToExecute()).thenReturn(mockExecution);&lt;br/&gt;
    +		when(mockExecution.getVertex()).thenReturn(mockExecutionVertex);&lt;br/&gt;
    +		when(mockExecutionVertex.getPreferredLocations()).thenReturn(null);&lt;br/&gt;
    +														&lt;br/&gt;
    +		// test the pending request is clear when timed out&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = pool.getSlotProvider().allocateSlot(mockScheduledUnit, true);&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}
&lt;p&gt;    +		catch (ExecutionException e) &lt;/p&gt;
{
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}
&lt;p&gt;    +		catch (Exception e) &lt;/p&gt;
{
    +			fail(&quot;wrong exception: &quot; + e);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		// wait for the async call to execute&lt;br/&gt;
    +		Thread.sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Enforcing certain interleavings with `Thread.sleep` is bound to fail eventually. Please do it differently.&lt;/p&gt;</comment>
                            <comment id="16236181" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148570875&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148570875&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}&lt;br/&gt;
    +		catch (ExecutionException e) {
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}&lt;br/&gt;
    +		catch (Exception e) {
    +			fail(&quot;wrong exception: &quot; + e);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		// 2. test the pending request is in pendingRequests&lt;br/&gt;
    +		ResourceManagerGateway resourceManagerGateway = SlotPoolTest.createResourceManagerGatewayMock();&lt;br/&gt;
    +		pool.connectToResourceManager(resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +		AllocationID allocationID2 = new AllocationID();&lt;br/&gt;
    +		future = slotPoolGateway.allocateSlot(allocationID2, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try {    +			future.get(2, TimeUnit.SECONDS);    +			fail(&quot;We expected a AskTimeoutException.&quot;);    +		}
&lt;p&gt;    +		catch (ExecutionException e) &lt;/p&gt;
{
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}&lt;br/&gt;
    +		catch (Exception e) {
    +			fail(&quot;wrong exception: &quot; + e);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfPendingRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID2);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfPendingRequests());&lt;br/&gt;
    +		//verify(resourceManagerGateway, times(1)).cancelSlotRequest(jid, any(JobMasterId.class), allocationID2);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 3. test the allocation is timed out in client side but the request is fulfilled in slot pool&lt;br/&gt;
    +		AllocationID allocationID3 = new AllocationID();&lt;br/&gt;
    +		future = slotPoolGateway.allocateSlot(allocationID3, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try {
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}&lt;br/&gt;
    +		catch (ExecutionException e) {    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());    +		}
&lt;p&gt;    +		catch (Exception e) &lt;/p&gt;
{
    +			fail(&quot;wrong exception: &quot; + e);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		ResourceID resourceID = ResourceID.generate();&lt;br/&gt;
    +		AllocatedSlot allocatedSlot = SlotPoolTest.createAllocatedSlot(resourceID, allocationID3, jid, DEFAULT_TESTING_PROFILE);&lt;br/&gt;
    +		slotPoolGateway.registerTaskManager(resourceID);&lt;br/&gt;
    +		assertTrue(slotPoolGateway.offerSlot(allocatedSlot).get());&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfPendingRequests());&lt;br/&gt;
    +		assertTrue(pool.getAllocatedSlots().contains(allocationID3));&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID3);&lt;br/&gt;
    +		assertFalse(pool.getAllocatedSlots().contains(allocationID3));&lt;br/&gt;
    +		assertTrue(pool.getAvailableSlots().contains(allocationID3));&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testProviderAndOwner() throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    What does this test tests? Maybe add a short description.&lt;/p&gt;</comment>
                            <comment id="16236182" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148570658&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148570658&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}&lt;br/&gt;
    +		catch (ExecutionException e) {
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}&lt;br/&gt;
    +		catch (Exception e) {
    +			fail(&quot;wrong exception: &quot; + e);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		// 2. test the pending request is in pendingRequests&lt;br/&gt;
    +		ResourceManagerGateway resourceManagerGateway = SlotPoolTest.createResourceManagerGatewayMock();&lt;br/&gt;
    +		pool.connectToResourceManager(resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +		AllocationID allocationID2 = new AllocationID();&lt;br/&gt;
    +		future = slotPoolGateway.allocateSlot(allocationID2, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try {    +			future.get(2, TimeUnit.SECONDS);    +			fail(&quot;We expected a AskTimeoutException.&quot;);    +		}
&lt;p&gt;    +		catch (ExecutionException e) &lt;/p&gt;
{
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}
&lt;p&gt;    +		catch (Exception e) &lt;/p&gt;
{
    +			fail(&quot;wrong exception: &quot; + e);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfPendingRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID2);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfPendingRequests());&lt;br/&gt;
    +		//verify(resourceManagerGateway, times(1)).cancelSlotRequest(jid, any(JobMasterId.class), allocationID2);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 3. test the allocation is timed out in client side but the request is fulfilled in slot pool&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    separate test&lt;/p&gt;</comment>
                            <comment id="16236183" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148571183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148571183&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}&lt;br/&gt;
    +		catch (ExecutionException e) {
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}&lt;br/&gt;
    +		catch (Exception e) {
    +			fail(&quot;wrong exception: &quot; + e);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		// 2. test the pending request is in pendingRequests&lt;br/&gt;
    +		ResourceManagerGateway resourceManagerGateway = SlotPoolTest.createResourceManagerGatewayMock();&lt;br/&gt;
    +		pool.connectToResourceManager(resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +		AllocationID allocationID2 = new AllocationID();&lt;br/&gt;
    +		future = slotPoolGateway.allocateSlot(allocationID2, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try {    +			future.get(2, TimeUnit.SECONDS);    +			fail(&quot;We expected a AskTimeoutException.&quot;);    +		}
&lt;p&gt;    +		catch (ExecutionException e) &lt;/p&gt;
{
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}&lt;br/&gt;
    +		catch (Exception e) {
    +			fail(&quot;wrong exception: &quot; + e);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfPendingRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID2);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfPendingRequests());&lt;br/&gt;
    +		//verify(resourceManagerGateway, times(1)).cancelSlotRequest(jid, any(JobMasterId.class), allocationID2);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 3. test the allocation is timed out in client side but the request is fulfilled in slot pool&lt;br/&gt;
    +		AllocationID allocationID3 = new AllocationID();&lt;br/&gt;
    +		future = slotPoolGateway.allocateSlot(allocationID3, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try {
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}&lt;br/&gt;
    +		catch (ExecutionException e) {    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());    +		}
&lt;p&gt;    +		catch (Exception e) &lt;/p&gt;
{
    +			fail(&quot;wrong exception: &quot; + e);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		ResourceID resourceID = ResourceID.generate();&lt;br/&gt;
    +		AllocatedSlot allocatedSlot = SlotPoolTest.createAllocatedSlot(resourceID, allocationID3, jid, DEFAULT_TESTING_PROFILE);&lt;br/&gt;
    +		slotPoolGateway.registerTaskManager(resourceID);&lt;br/&gt;
    +		assertTrue(slotPoolGateway.offerSlot(allocatedSlot).get());&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfPendingRequests());&lt;br/&gt;
    +		assertTrue(pool.getAllocatedSlots().contains(allocationID3));&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID3);&lt;br/&gt;
    +		assertFalse(pool.getAllocatedSlots().contains(allocationID3));&lt;br/&gt;
    +		assertTrue(pool.getAvailableSlots().contains(allocationID3));&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testProviderAndOwner() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.seconds(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		ResourceManagerGateway resourceManagerGateway = SlotPoolTest.createResourceManagerGatewayMock();&lt;br/&gt;
    +		pool.connectToResourceManager(resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +		ScheduledUnit mockScheduledUnit = mock(ScheduledUnit.class);&lt;br/&gt;
    +		Execution mockExecution = mock(Execution.class);&lt;br/&gt;
    +		ExecutionVertex mockExecutionVertex = mock(ExecutionVertex.class);&lt;br/&gt;
    +		when(mockScheduledUnit.getTaskToExecute()).thenReturn(mockExecution);&lt;br/&gt;
    +		when(mockExecution.getVertex()).thenReturn(mockExecutionVertex);&lt;br/&gt;
    +		when(mockExecutionVertex.getPreferredLocations()).thenReturn(null);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I would refrain from too extensive mocking. This makes it extremely hard to maintain tests. If possible replace the mocks with actual classes.&lt;/p&gt;</comment>
                            <comment id="16236184" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148598542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148598542&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -1006,7 +1044,13 @@ public boolean returnAllocatedSlot(Slot slot) {&lt;br/&gt;
     			Iterable&amp;lt;TaskManagerLocation&amp;gt; locationPreferences = &lt;br/&gt;
     					task.getTaskToExecute().getVertex().getPreferredLocations();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return gateway.allocateSlot(task, ResourceProfile.UNKNOWN, locationPreferences, timeout);&lt;br/&gt;
    +			final AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +			CompletableFuture&amp;lt;SimpleSlot&amp;gt; slotFuture = gateway.allocateSlot(allocationID, ResourceProfile.UNKNOWN, locationPreferences, timeout);&lt;br/&gt;
    +			slotFuture.exceptionally((Throwable failure) -&amp;gt; {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think `slotFuture.whenComplete` would better fit here.&lt;/p&gt;</comment>
                            <comment id="16236185" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148591926&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148591926&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -262,23 +263,36 @@ public void disconnectResourceManager() {&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public CompletableFuture&amp;lt;SimpleSlot&amp;gt; allocateSlot(&lt;/li&gt;
	&lt;li&gt;ScheduledUnit task,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We should not remove the `ScheduledUnit` parameter here.&lt;/p&gt;</comment>
                            <comment id="16236186" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148601504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148601504&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -645,6 +668,21 @@ AllocatedSlots getAllocatedSlots() &lt;/p&gt;
{
     		return allocatedSlots;
     	}

&lt;p&gt;    +	@VisibleForTesting&lt;br/&gt;
    +	AvailableSlots getAvailableSlots() &lt;/p&gt;
{
    +		return availableSlots;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	int getNumOfWaitingForResourceRequests() &lt;/p&gt;
{
    +		return waitingForResourceManager.size();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	int getNumOfPendingRequests() &lt;/p&gt;
{
    +		return pendingRequests.size();
    +	}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think we should not make internal state easily accessible because it will usually be modified by the main thread. Also when checking a certain interleaving you might be falsely entrapped that you can do something like&lt;br/&gt;
    ```&lt;br/&gt;
    slotPool.asyncAddPendingRequest()&lt;br/&gt;
    slotPool.getNumOfPendingRequests() // this returns +1 pending requests&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    This is might work but sometimes it also does not work because the concurrent operation has not been completed. I would like to make concurrent operations explicit by, for example, returning a `CompletableFuture&amp;lt;Integer&amp;gt; getNumberOfPendingRequests` if at all.&lt;/p&gt;</comment>
                            <comment id="16236187" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148596041&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148596041&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -262,23 +263,36 @@ public void disconnectResourceManager() {&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public CompletableFuture&amp;lt;SimpleSlot&amp;gt; allocateSlot(&lt;/li&gt;
	&lt;li&gt;ScheduledUnit task,&lt;br/&gt;
    +	public CompletableFuture&amp;lt;SimpleSlot&amp;gt; allocateSlot(AllocationID allocationID,&lt;br/&gt;
     			ResourceProfile resources,&lt;br/&gt;
     			Iterable&amp;lt;TaskManagerLocation&amp;gt; locationPreferences,&lt;br/&gt;
     			Time timeout) 
{
     
    -		return internalAllocateSlot(task, resources, locationPreferences);
    +		return internalAllocateSlot(allocationID, resources, locationPreferences);
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	@Override&lt;br/&gt;
     	public void returnAllocatedSlot(Slot slot) &lt;/p&gt;
{
     		internalReturnAllocatedSlot(slot);
     	}

&lt;p&gt;    +	@Override&lt;br/&gt;
    +	public void cancelSlotAllocation(AllocationID allocationID) {&lt;br/&gt;
    +		waitingForResourceManager.remove(allocationID);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    we should fail the pending request properly. E.g. check if the slot is in `waitingForResourceManager` or `pendingRequests`. If yes, then remove and call `failPendingRequest`.&lt;/p&gt;</comment>
                            <comment id="16236188" author="githubbot" created="Thu, 2 Nov 2017 17:25:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148599978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148599978&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}
&lt;p&gt;    +		catch (ExecutionException e) &lt;/p&gt;
{
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}
&lt;p&gt;    +		catch (Exception e) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This is not needed if you add `throws Exception` to the test method.&lt;/p&gt;</comment>
                            <comment id="16236189" author="githubbot" created="Thu, 2 Nov 2017 17:25:24 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148602544&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148602544&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}&lt;br/&gt;
    +		catch (ExecutionException e) {
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}&lt;br/&gt;
    +		catch (Exception e) {
    +			fail(&quot;wrong exception: &quot; + e);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		// 2. test the pending request is in pendingRequests&lt;br/&gt;
    +		ResourceManagerGateway resourceManagerGateway = SlotPoolTest.createResourceManagerGatewayMock();&lt;br/&gt;
    +		pool.connectToResourceManager(resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +		AllocationID allocationID2 = new AllocationID();&lt;br/&gt;
    +		future = slotPoolGateway.allocateSlot(allocationID2, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try {    +			future.get(2, TimeUnit.SECONDS);    +			fail(&quot;We expected a AskTimeoutException.&quot;);    +		}
&lt;p&gt;    +		catch (ExecutionException e) &lt;/p&gt;
{
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}
&lt;p&gt;    +		catch (Exception e) &lt;/p&gt;
{
    +			fail(&quot;wrong exception: &quot; + e);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfPendingRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID2);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfPendingRequests());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    It&apos;s not guaranteed that `pool.getNumofPendingRequests()` is executed after `pool.cancelSlotAllocation` has been executed.&lt;/p&gt;</comment>
                            <comment id="16236190" author="githubbot" created="Thu, 2 Nov 2017 17:25:24 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148602423&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148602423&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/instance/SlotPoolRpcTest.java &amp;#8212;&lt;br/&gt;
    @@ -99,4 +108,129 @@ public void testSlotAllocationNoResourceManager() throws Exception &lt;/p&gt;
{
     			fail(&quot;wrong exception: &quot; + e);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelSlotAllocation() throws Exception {&lt;br/&gt;
    +		final JobID jid = new JobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final SlotPool pool = new SlotPool(&lt;br/&gt;
    +				rpcService, jid,&lt;br/&gt;
    +				SystemClock.getInstance(),&lt;br/&gt;
    +				Time.days(1), Time.days(1),&lt;br/&gt;
    +				Time.seconds(3) // this is the timeout for the request tested here&lt;br/&gt;
    +		);&lt;br/&gt;
    +		pool.start(JobMasterId.generate(), &quot;foobar&quot;);&lt;br/&gt;
    +		SlotPoolGateway slotPoolGateway = pool.getSelfGateway(SlotPoolGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +		// 1. test the pending request is in waitingResourceManagerRequests&lt;br/&gt;
    +		AllocationID allocationID = new AllocationID();&lt;br/&gt;
    +		CompletableFuture&amp;lt;SimpleSlot&amp;gt; future = slotPoolGateway.allocateSlot(allocationID, DEFAULT_TESTING_PROFILE, null, Time.seconds(1));&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			future.get(2, TimeUnit.SECONDS);
    +			fail(&quot;We expected a AskTimeoutException.&quot;);
    +		}
&lt;p&gt;    +		catch (ExecutionException e) &lt;/p&gt;
{
    +			assertEquals(AskTimeoutException.class, e.getCause().getClass());
    +		}
&lt;p&gt;    +		catch (Exception e) &lt;/p&gt;
{
    +			fail(&quot;wrong exception: &quot; + e);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(1, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    +&lt;br/&gt;
    +		pool.cancelSlotAllocation(allocationID);&lt;br/&gt;
    +		assertEquals(0, pool.getNumOfWaitingForResourceRequests());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think the test could look the following:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    slotPoolGateway.allocateSlot();&lt;br/&gt;
    CompletableFuture&amp;lt;Integer&amp;gt; numberPendingRequestsFuture = slotPoolGateway.requestNumberPendingRequests();&lt;br/&gt;
    assertEquals(1, numberPendingRequestsFuture.get());&lt;br/&gt;
    slotPoolGateway.cancelAllocation();&lt;br/&gt;
    CompletableFuture&amp;lt;Integer&amp;gt; numberPendingRequestsFuture = slotPoolGateway.requestNumberPendingRequests();&lt;br/&gt;
    assertEquals(0, numberPendingRequestsFuture.get());&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16236191" author="githubbot" created="Thu, 2 Nov 2017 17:25:24 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148599674&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148599674&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPoolGateway.java &amp;#8212;&lt;br/&gt;
    @@ -86,10 +85,16 @@&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	CompletableFuture&amp;lt;SimpleSlot&amp;gt; allocateSlot(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ScheduledUnit task,&lt;br/&gt;
    +			AllocationID allocationID,&lt;br/&gt;
     			ResourceProfile resources,&lt;br/&gt;
     			Iterable&amp;lt;TaskManagerLocation&amp;gt; locationPreferences,&lt;br/&gt;
     			@RpcTimeout Time timeout);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	void returnAllocatedSlot(Slot slot);&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Cancel a slot allocation.&lt;br/&gt;
    +	 * This method should be called when the CompletableFuture returned by allocateSlot completed exceptionally.&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Params description is missing.&lt;/p&gt;</comment>
                            <comment id="16237187" author="githubbot" created="Fri, 3 Nov 2017 07:15:39 +0000"  >&lt;p&gt;Github user shuai-xu commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148718854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148718854&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -262,23 +263,36 @@ public void disconnectResourceManager() {&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public CompletableFuture&amp;lt;SimpleSlot&amp;gt; allocateSlot(&lt;/li&gt;
	&lt;li&gt;ScheduledUnit task,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why put the ScheduledUnit as a parameter here? I think the interface in slot pool should be clean and it should only have resource related parameters, should not have schedule related parameters.&lt;/p&gt;</comment>
                            <comment id="16237426" author="githubbot" created="Fri, 3 Nov 2017 10:44:40 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937#discussion_r148750995&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937#discussion_r148750995&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -262,23 +263,36 @@ public void disconnectResourceManager() {&lt;br/&gt;
     	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public CompletableFuture&amp;lt;SimpleSlot&amp;gt; allocateSlot(&lt;/li&gt;
	&lt;li&gt;ScheduledUnit task,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Because this information is needed for scheduling.&lt;/p&gt;</comment>
                            <comment id="16247321" author="till.rohrmann" created="Fri, 10 Nov 2017 10:24:58 +0000"  >&lt;p&gt;Fixed via &lt;br/&gt;
f7481977cb558c12f43901f9e3bbe4b10f23b0b4&lt;br/&gt;
2f9eb5194acc2b8f29a6bf0c97a4230811a3db99&lt;br/&gt;
56aefcd9e7055ae6e2d10110715024ed6997b50c&lt;/p&gt;</comment>
                            <comment id="16247322" author="githubbot" created="Fri, 10 Nov 2017 10:25:45 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4937&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4937&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12996099">FLINK-4344</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 1 week, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3eepb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>