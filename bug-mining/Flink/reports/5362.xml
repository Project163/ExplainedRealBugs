<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:56:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21247] flink iceberg table map&lt;string,string&gt; cannot convert to datastream</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21247</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Flink Iceberg Table with map&amp;lt;string,string&amp;gt;&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13019898/13019898_image-2021-02-03-15-38-42-340.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
&#160;&lt;br/&gt;
we want to read the table like this :&lt;br/&gt;
&#160;&lt;br/&gt;
String querySql = &quot;SELECT ftime,extinfo,country,province,operator,apn,gw,src_ip_head,info_str,product_id,app_version,sdk_id,sdk_version,hardware_os,qua,upload_ip,client_ip,upload_apn,event_code,event_result,package_size,consume_time,event_value,event_time,upload_time,boundle_id,uin,platform,os_version,channel,brand,model from bfzt3 &quot;;&lt;br/&gt;
Table table = tEnv.sqlQuery(querySql);&lt;/p&gt;

&lt;p&gt;DataStream&amp;lt;AttaInfo&amp;gt; sinkStream = tEnv.toAppendStream(table, Types.POJO(AttaInfo.class, map));&lt;/p&gt;

&lt;p&gt;sinkStream.map(x-&amp;gt;1).returns(Types.INT).keyBy(new NullByteKeySelector&amp;lt;Integer&amp;gt;()).reduce((x,y) -&amp;gt; &lt;/p&gt;
{
 return x+y;
}
&lt;p&gt;).print();&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
when read&#160; we find a exception&lt;br/&gt;
&#160;&lt;br/&gt;
2021-02-03 15:37:57&lt;br/&gt;
java.lang.ClassCastException: org.apache.iceberg.flink.data.FlinkParquetReaders$ReusableMapData cannot be cast to org.apache.flink.table.data.binary.BinaryMapData&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.table.runtime.typeutils.MapDataSerializer.copy(MapDataSerializer.java:107)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.table.runtime.typeutils.MapDataSerializer.copy(MapDataSerializer.java:47)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.table.runtime.typeutils.RowDataSerializer.copyRowData(RowDataSerializer.java:166)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.table.runtime.typeutils.RowDataSerializer.copy(RowDataSerializer.java:129)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.table.runtime.typeutils.RowDataSerializer.copy(RowDataSerializer.java:50)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.runtime.tasks.CopyingChainingOutput.pushToOperator(CopyingChainingOutput.java:69)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.runtime.tasks.CopyingChainingOutput.collect(CopyingChainingOutput.java:46)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.runtime.tasks.CopyingChainingOutput.collect(CopyingChainingOutput.java:26)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:50)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:28)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.api.operators.StreamSourceContexts$ManualWatermarkContext.processAndCollect(StreamSourceContexts.java:317)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.api.operators.StreamSourceContexts$WatermarkContext.collect(StreamSourceContexts.java:411)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.api.functions.source.InputFormatSourceFunction.run(InputFormatSourceFunction.java:92)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:110)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:66)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.flink.streaming.runtime.tasks.SourceStreamTask$LegacySourceFunctionThread.run(SourceStreamTask.java:241)&lt;br/&gt;
&#160;&lt;br/&gt;
we find that iceberg map is&#160;&#160;ReusableMapData implements MapData&#160;&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13019897/13019897_image-2021-02-03-15-40-27-055.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
&#160;&lt;br/&gt;
this is the exception&#160;&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13019896/13019896_image-2021-02-03-15-41-34-426.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
MapData has two default implements&#160;&#160;GenericMapData and&#160;BinaryMapData&lt;br/&gt;
from iceberg implement is&#160;ReusableMapData&lt;br/&gt;
&#160;&lt;br/&gt;
so i think that code should change to like this&#160;&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13019895/13019895_image-2021-02-03-15-43-19-919.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;iceberg master&lt;/p&gt;

&lt;p&gt;flink 1.12&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13356394">FLINK-21247</key>
            <summary>flink iceberg table map&lt;string,string&gt; cannot convert to datastream</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="icshuo">Shuo Cheng</assignee>
                                    <reporter username="txdong-sz">donglei</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 3 Feb 2021 07:44:36 +0000</created>
                <updated>Fri, 28 Mar 2025 06:29:06 +0000</updated>
                            <resolved>Mon, 26 Apr 2021 08:15:02 +0000</resolved>
                                    <version>1.12.1</version>
                                    <fixVersion>1.14.0</fixVersion>
                    <fixVersion>1.13.1</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17277778" author="txdong-sz" created="Wed, 3 Feb 2021 07:53:21 +0000"  >&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;i change code to this&#160; and can run normally&lt;/p&gt;

&lt;p&gt;print map data can run&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;sinkStream.addSink(new RichSinkFunction&amp;lt;AttaInfo&amp;gt;() {&lt;br/&gt;
 @Override&lt;br/&gt;
 public void invoke(AttaInfo value, Context context) throws Exception {&lt;/p&gt;


&lt;p&gt; Map&amp;lt;String, String&amp;gt; map2 = value.getEvent_value();&lt;/p&gt;

&lt;p&gt; map2.entrySet().stream().forEach(x-&amp;gt;&lt;/p&gt;
{

 System.out.println(x.getKey()+&quot;:&quot; + x.getValue());
 }
&lt;p&gt;);&lt;br/&gt;
 }&lt;br/&gt;
});&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13019901/13019901_image-2021-02-03-15-52-12-493.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13019902/13019902_image-2021-02-03-15-53-18-244.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17277799" author="jark" created="Wed, 3 Feb 2021 08:19:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=openinx&quot; class=&quot;user-hover&quot; rel=&quot;openinx&quot;&gt;openinx&lt;/a&gt;, not sure what&apos;s the potential reason why Iceberg introduced `ReusableMapData`. &lt;/p&gt;</comment>
                            <comment id="17278483" author="openinx" created="Thu, 4 Feb 2021 02:24:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;,  Assume that there are 5 records in iceberg table ( table schema is:  create table test (row : map&amp;lt;string, String&amp;gt;) ):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
row1: map&amp;lt;{&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;}, {&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2}, {&quot;&lt;/span&gt;c&lt;span class=&quot;code-quote&quot;&gt;&quot;, &quot;&lt;/span&gt;3&quot;}&amp;gt;
row2: map&amp;lt;{&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;}&amp;gt;
row3: map&amp;lt;{&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;111&quot;&lt;/span&gt;}&amp;gt;
row4: map&amp;lt;{&lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;11&quot;&lt;/span&gt;}&amp;gt;
row5: map&amp;lt;{&lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;, 1&quot;}&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we don&apos;t use the reuse object,  then for each row we will need to create a new RowData object for each row, which would create so many young objects that produces the GC issues.  But if use the reuse object,  then each children fields inside this object will all be reusable.  In this case,  we will need a ReusableMapData to maintain the key-value pairs for the first row1, then for the second row2,  actually the ReusableMapData has enough space to hold the map of row2, then we don&apos;t have to allocate new map -  that will really reduce the heap object allocations.&lt;/p&gt;

&lt;p&gt;In our apache iceberg generic parquet reader &amp;amp; writer,  we use this reuse strategy for all the compute engines. Another similar data structure is ReusableArrayData, which extends from ArrayData interfaces.  I think we also need to fix it in this PR. Thanks. &lt;/p&gt;</comment>
                            <comment id="17278507" author="jark" created="Thu, 4 Feb 2021 03:14:03 +0000"  >&lt;p&gt;Thanks for the explanation, I&apos;m fine the the fix way. What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;? &lt;/p&gt;</comment>
                            <comment id="17313779" author="openinx" created="Fri, 2 Apr 2021 10:13:55 +0000"  >&lt;p&gt;I think this will need to get merged in flink 1.13.0,  otherwise the newly released flink won&apos;t be able to read iceberg map data type,  this&apos;s a critical bug.&lt;/p&gt;</comment>
                            <comment id="17313879" author="jark" created="Fri, 2 Apr 2021 13:43:20 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=openinx&quot; class=&quot;user-hover&quot; rel=&quot;openinx&quot;&gt;openinx&lt;/a&gt;, I changed the type to BUG, and fix version to 1.13. &lt;/p&gt;</comment>
                            <comment id="17317774" author="lzljs3620320" created="Fri, 9 Apr 2021 08:22:00 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=txdong-sz&quot; class=&quot;user-hover&quot; rel=&quot;txdong-sz&quot;&gt;txdong-sz&lt;/a&gt;,&#160;Thanks for the contribution. Can you fix the checkstyle and add case in the PR?&lt;/p&gt;</comment>
                            <comment id="17319188" author="icshuo" created="Mon, 12 Apr 2021 09:43:58 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=txdong-sz&quot; class=&quot;user-hover&quot; rel=&quot;txdong-sz&quot;&gt;txdong-sz&lt;/a&gt;, it seems you are offline for several days, so please excuse me for taking this issue without informing you.&lt;/p&gt;</comment>
                            <comment id="17331884" author="lzljs3620320" created="Mon, 26 Apr 2021 08:15:02 +0000"  >&lt;p&gt;Fixed via:&lt;/p&gt;

&lt;p&gt;master:&#160;033cdeae0e510a930e9975542ae0a43c4484adeb&lt;/p&gt;

&lt;p&gt;release-1.13:&#160;970b2b8b746ba7a29154e0d2f6b282c094bbfc24&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13019898" name="image-2021-02-03-15-38-42-340.png" size="63624" author="txdong-sz" created="Wed, 3 Feb 2021 07:38:43 +0000"/>
                            <attachment id="13019897" name="image-2021-02-03-15-40-27-055.png" size="113902" author="txdong-sz" created="Wed, 3 Feb 2021 07:40:28 +0000"/>
                            <attachment id="13019896" name="image-2021-02-03-15-41-34-426.png" size="26644" author="txdong-sz" created="Wed, 3 Feb 2021 07:41:35 +0000"/>
                            <attachment id="13019895" name="image-2021-02-03-15-43-19-919.png" size="22595" author="txdong-sz" created="Wed, 3 Feb 2021 07:43:20 +0000"/>
                            <attachment id="13019901" name="image-2021-02-03-15-52-12-493.png" size="63217" author="txdong-sz" created="Wed, 3 Feb 2021 07:52:13 +0000"/>
                            <attachment id="13019902" name="image-2021-02-03-15-53-18-244.png" size="64081" author="txdong-sz" created="Wed, 3 Feb 2021 07:53:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 29 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0nao0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>