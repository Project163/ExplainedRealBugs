<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:22:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-37460] Using State Processor API and Kafka Sink with Exactly once delivery leads to org.apache.kafka.common.errors.InvalidPidMappingException</title>
                <link>https://issues.apache.org/jira/browse/FLINK-37460</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Setup:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Job with KafkaSink with `DeliveryGuarantee.EXACTLY_ONCE`&lt;/li&gt;
	&lt;li&gt;Kafka Cluster with max transaction time e.g. 24h&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Steps to reproduce:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Run the job for at least 24h&lt;/li&gt;
	&lt;li&gt;Stop with savepoint&lt;/li&gt;
	&lt;li&gt;Use State Processor API to rewrite savepoint&lt;/li&gt;
	&lt;li&gt;Start job from rewritten savepoint&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Actual:&lt;br/&gt;
Job will fail after about 24h with &lt;br/&gt;
```&lt;br/&gt;
Caused by: org.apache.kafka.common.errors.InvalidPidMappingException: The producer attempted to use a producer id which is not currently assigned to its transactional id.2025-03-03 08:42:14.749&lt;br/&gt;
	at java.lang.Thread.run(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:?&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:575) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:763) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.restoreAndInvoke(Task.java:939) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.runWithSystemExitMonitoring(Task.java:970) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.StreamTask.restore(StreamTask.java:771) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.StreamTask.restoreInternal(StreamTask.java:812) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.call(StreamTaskActionExecutor.java:55) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$restoreInternal$5(StreamTask.java:812) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.StreamTask.restoreStateAndGates(StreamTask.java:858) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.RegularOperatorChain.initializeStateAndOpenOperators(RegularOperatorChain.java:106) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:294) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.StreamOperatorStateHandler.initializeOperatorState(StreamOperatorStateHandler.java:147) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.operators.sink.CommitterOperator.initializeState(CommitterOperator.java:135) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.operators.sink.CommitterOperator.commitAndEmitCheckpoints(CommitterOperator.java:174) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.operators.sink.CommitterOperator.commitAndEmit(CommitterOperator.java:190) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.operators.sink.committables.CheckpointCommittableManagerImpl.commit(CheckpointCommittableManagerImpl.java:134) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.connector.kafka.sink.KafkaCommitter.commit(KafkaCommitter.java:119) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:?&amp;#93;&lt;/span&gt;2025-03-03 08:42:14.749&lt;br/&gt;
	at org.apache.flink.streaming.runtime.operators.sink.committables.CommitRequestImpl.signalFailedWithUnknownReason(CommitRequestImpl.java:85) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-dist-1.20.0.jar:1.20.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;Explanation:&lt;br/&gt;
When using EXACTLY_ONCE, KafkaSink writes KafkaCommitable to the checkpoint which contains current transactionalId with current producerId. After checkpoint is completed transaction is commited.&lt;/p&gt;

&lt;p&gt;When Flink start up the job from checkpoint/savepoint in state initialization `AbstractStreamOperator.initializeState` it will in `CommitterOperator.commitAndEmitCheckpoints` get all checkpoint commitables up to last completed checkpoint `committableCollector.getCheckpointCommittablesUpTo(lastCompletedCheckpointId)` and try to commit them.&lt;/p&gt;

&lt;p&gt;Problem starts when we use State Processing API, which is resetting checkpointId to 0. Initially there is no problem but when we reach the checkpointId equal to the checkpointId of savepoint we were migrating.&lt;br/&gt;
The `committableCollector.getCheckpointCommittablesUpTo(lastCompletedCheckpointId)` loads not only latest transaction details but also the last transaction that happen before migration. If the migration happen earlier than Kafka transaction expiration time KafkaCommiter will get `org.apache.kafka.common.errors.InvalidPidMappingException`.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13611450">FLINK-37460</key>
            <summary>Using State Processor API and Kafka Sink with Exactly once delivery leads to org.apache.kafka.common.errors.InvalidPidMappingException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gaborgsomogyi">Gabor Somogyi</assignee>
                                    <reporter username="gliter">Grzegorz Liter</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 11 Mar 2025 14:03:28 +0000</created>
                <updated>Thu, 20 Mar 2025 16:37:10 +0000</updated>
                            <resolved>Thu, 20 Mar 2025 16:33:44 +0000</resolved>
                                    <version>1.20.1</version>
                                    <fixVersion>1.20.2</fixVersion>
                    <fixVersion>2.0.1</fixVersion>
                                    <component>API / State Processor</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17934226" author="martijnvisser" created="Tue, 11 Mar 2025 14:13:12 +0000"  >&lt;p&gt;For reference for others: this was discussed on Slack, the true bug would be that the State Processor API should not reset the checkpointId to 0. &lt;/p&gt;</comment>
                            <comment id="17934230" author="gaborgsomogyi" created="Tue, 11 Mar 2025 14:20:30 +0000"  >&lt;p&gt;This sounds severe, can you confirm that using the original checkpoint ID would solve this problem?&lt;/p&gt;</comment>
                            <comment id="17934231" author="gaborgsomogyi" created="Tue, 11 Mar 2025 14:21:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; thanks for the context, it helps. Let me take a look at it...&lt;/p&gt;</comment>
                            <comment id="17934235" author="JIRAUSER301498" created="Tue, 11 Mar 2025 14:28:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaborgsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;gaborgsomogyi&quot;&gt;gaborgsomogyi&lt;/a&gt; yes, as this is what happens during stoping and starting job. The stored transaction details will be recent and KafkaSink will be able to try to commit (which is already commited) transaction without problem as it is not yet expired in Kafka Cluster.&lt;/p&gt;

&lt;p&gt;To add context, this is problem when we e.g. stop job and then try to start it after transaction is expired by Kafka Cluster. This is documented here: &lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/connectors/datastream/kafka/#fault-tolerance&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/connectors/datastream/kafka/#fault-tolerance&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In case of this issue it is kind of simulating that as the transaction lingers for long time in the State due to resetting checkpoint id during State migration.&lt;/p&gt;</comment>
                            <comment id="17934258" author="gaborgsomogyi" created="Tue, 11 Mar 2025 15:59:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gliter&quot; class=&quot;user-hover&quot; rel=&quot;gliter&quot;&gt;gliter&lt;/a&gt; thanks for the detailed explanation! I&apos;ve just created a code to address this issue. I&apos;m intended to file a PR soon.&lt;br/&gt;
I&apos;ve added automated tests for coverage but I would like to ask you to double check it on your side manually to be on the safe side.&lt;/p&gt;</comment>
                            <comment id="17934260" author="JIRAUSER301498" created="Tue, 11 Mar 2025 16:03:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaborgsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;gaborgsomogyi&quot;&gt;gaborgsomogyi&lt;/a&gt; Sure, let me know.&lt;/p&gt;</comment>
                            <comment id="17934265" author="gaborgsomogyi" created="Tue, 11 Mar 2025 16:14:50 +0000"  >&lt;p&gt;Just filed it, plz report back.&lt;/p&gt;</comment>
                            <comment id="17935428" author="gaborgsomogyi" created="Fri, 14 Mar 2025 07:11:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/c89c41606fe609208f10d8fc08999145b612c6a2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;c89c416&lt;/tt&gt;&lt;/a&gt; on master&lt;/p&gt;</comment>
                            <comment id="17937157" author="gaborgsomogyi" created="Thu, 20 Mar 2025 16:33:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/e24c477720b214864a37d77e285dc391075cb483&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;e24c477&lt;/tt&gt;&lt;/a&gt; on release-1.20&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1upko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>