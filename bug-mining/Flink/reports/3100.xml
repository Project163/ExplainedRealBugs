<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:40:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-13249] Distributed Jepsen test fails with blocked TaskExecutor</title>
                <link>https://issues.apache.org/jira/browse/FLINK-13249</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The distributed Jepsen test which kills &lt;tt&gt;JobMasters&lt;/tt&gt; started to fail recently. From a first glance, it looks as if the &lt;tt&gt;TaskExecutor&apos;s&lt;/tt&gt; main thread is blocked by some operation. Further investigation is required.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13244642">FLINK-13249</key>
            <summary>Distributed Jepsen test fails with blocked TaskExecutor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Fri, 12 Jul 2019 15:57:24 +0000</created>
                <updated>Fri, 2 Aug 2019 11:43:37 +0000</updated>
                            <resolved>Thu, 18 Jul 2019 08:40:49 +0000</resolved>
                                    <version>1.9.0</version>
                                    <fixVersion>1.9.0</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                                        <aggregatetimeremainingestimate seconds="0">0h</aggregatetimeremainingestimate>
                                        <aggregatetimespent seconds="2400">40m</aggregatetimespent>
                                    <comments>
                            <comment id="16883969" author="till.rohrmann" created="Fri, 12 Jul 2019 16:37:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13013&quot; title=&quot;Make sure that SingleInputGate can always request partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13013&quot;&gt;&lt;del&gt;FLINK-13013&lt;/del&gt;&lt;/a&gt; introduces a deadlock when setting up the &lt;tt&gt;SingleInputGate&lt;/tt&gt;. The problem is that when we setup the &lt;tt&gt;SingleInputGate&lt;/tt&gt; we try to request the partitions. Requesting the partitions acquires first the &lt;tt&gt;requestLock&lt;/tt&gt;. Next we try to create the &lt;tt&gt;PartitionRequestClient&lt;/tt&gt; in a blocking fashion. If the corresponding partition cannot be found, we ask the &lt;tt&gt;JobMaster&lt;/tt&gt; about the state of the producer via the &lt;tt&gt;PartitionProducerStateProvider#requestPartitionProducerState&lt;/tt&gt;. The response to this request arrives in a different thread which tries to call &lt;tt&gt;SingleInputGate#retriggerPartitionRequest&lt;/tt&gt;. The problem is that this method also requires the &lt;tt&gt;SingleInputGate#requestLock&lt;/tt&gt; which creates the deadlock.&lt;/p&gt;</comment>
                            <comment id="16884956" author="gaoyunhaii" created="Mon, 15 Jul 2019 08:56:09 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;, I think a little differently for the cause of this issue. I agree with that it is caused by the deadlock between&#160;&lt;em&gt;requestSubpartition -&amp;gt; waitForChannel&lt;/em&gt;&#160; and&#160;&lt;em&gt;retriggerPartitionRequest,&lt;/em&gt; but I think it&#160;might not be caused by&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13013&quot; title=&quot;Make sure that SingleInputGate can always request partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13013&quot;&gt;&lt;del&gt;FLINK-13013&lt;/del&gt;&lt;/a&gt;. Instead, I think it&#160;might be caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12530&quot; title=&quot;Move Task.inputGatesById to NetworkEnvironment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12530&quot;&gt;&lt;del&gt;FLINK-12530&lt;/del&gt;&lt;/a&gt;, since in this issue we move the retriggerPartitionRequest from the Task#executor to the Netty IO Thread. Since after the changing, the Netty IO thread is blocked when trying to acquire the request lock, then it cannot proceed to handle the connection of the other channels, and this cause the &lt;em&gt;waitForChannel&lt;/em&gt; to wait forever.&lt;/p&gt;</comment>
                            <comment id="16884960" author="srichter" created="Mon, 15 Jul 2019 09:02:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; thanks for the input, I think what you wrote makes sense. So the point that we would have to address is ensuring that the callback is not run by the netty IO thread, because they are never allowed to run blocking op?&lt;/p&gt;</comment>
                            <comment id="16884990" author="gaoyunhaii" created="Mon, 15 Jul 2019 09:24:38 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt;, I think in this case the key is the Netty thread&#160; and the task thread is mutable blocked and both block states cannot be released.&#160;&lt;/p&gt;

&lt;p&gt;For the reasons cause this, I further read the code and found that the codes is similar to let the Netty thread to execute something like&#160; &lt;em&gt;future.handleAsync({routine 1: PartitionProducerStateResponseHandle::new at Task.java#1090}, Task#executor).thenAccept({routine2 : retriggerPartitionRequest at SingleInputGate#605})&lt;/em&gt;, I think we might intend to make both routine 1 and routine 2 to be executed with the Task#executor, however, if the routing&#160;1 executes really fast and when the Netty thread get to the thenAccept, it&#160;found&#160;the previous stage has finished, then the Netty thread will execute routine 2 directly.&#160;&lt;/p&gt;</comment>
                            <comment id="16885002" author="srichter" created="Mon, 15 Jul 2019 09:34:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; That is also how I understood your comment, just wanted to clarify that we agree the approach should be to change the `thenAccept(&lt;/p&gt;
{routine2})` to `thenAcceptAsync({routine2}
&lt;p&gt;, taskExecutor)` to be on the safe side and guarantee it never runs from the netty thread. The biggest downside would be that we have to pass down the executor into the gate.&lt;/p&gt;</comment>
                            <comment id="16885018" author="till.rohrmann" created="Mon, 15 Jul 2019 09:49:49 +0000"  >&lt;p&gt;I think the root cause is that the &lt;tt&gt;SingleInputGate#setup&lt;/tt&gt; method holds the &lt;tt&gt;SingleInputGate#requestLock&lt;/tt&gt; while it waits on the channel completion and the channel can only be established once the partition state update has arrived.&lt;/p&gt;</comment>
                            <comment id="16885053" author="till.rohrmann" created="Mon, 15 Jul 2019 10:25:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; explained me the problem and now I finally got it. It looks indeed that we need to execute the call back from the partition state checker asynchronously &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGate.java#L605&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGate.java#L605&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16885059" author="srichter" created="Mon, 15 Jul 2019 10:29:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; alright, I think then we have a consensus on how to approach this. I think the last remaining question is whether or not we actually require to pass in the task&apos;s executor or simply use the common pool. Option one obviously has the advantage that it integrates with how execution is supposed to happen and with with the task lifecycle, disadvantage is that it seems like we would need to pass down the executor from quiet far way. Option 2 would be simpler if we agree that there is no requirement that this has to run through the particular executor.&lt;/p&gt;</comment>
                            <comment id="16885928" author="till.rohrmann" created="Tue, 16 Jul 2019 08:17:01 +0000"  >&lt;p&gt;This is a very good question. The down side of the global executor is that it&apos;s not really well defined who else is using it. Assume that there is another user (low level priority) who runs a long running task in it. Then, the retriggering of the partition request would again not happen. Such a usage could come even from a user function.&lt;/p&gt;

&lt;p&gt;If we don&apos;t have a concrete and immediate plan how to refactor this code in the future, I would slightly be against using the global executor because I fear that it will remain for quite some time and could bite us later.&lt;/p&gt;</comment>
                            <comment id="16885946" author="pnowojski" created="Tue, 16 Jul 2019 08:52:09 +0000"  >&lt;p&gt;I tend to agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; that it would be better to pass this executor somehow. I&apos;m more worried about how invasive this change for the tests might be, not for the actual production code. We both create and setup input gates inside &lt;tt&gt;Task&lt;/tt&gt; class, so &lt;tt&gt;Task#executor&lt;/tt&gt; is just right besides them, or did I miss something &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16885981" author="srichter" created="Tue, 16 Jul 2019 09:34:10 +0000"  >&lt;p&gt;My tendency is also more towards having a well-specified executor, in particular as the code is not just some stateless request.&lt;/p&gt;

&lt;p&gt;I would have another suggestion that might get around the problem, so how about changing:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	void requestPartitionProducerState(
		IntermediateDataSetID intermediateDataSetId,
		ResultPartitionID resultPartitionId,
		Consumer&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; ResponseHandle&amp;gt; responseConsumer);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and then do in `Task`&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
		futurePartitionState.whenCompleteAsync(
			(ExecutionState executionState, Throwable throwable) -&amp;gt; {
				responseConsumer.accept(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PartitionProducerStateResponseHandle(executionState, throwable));
			},
			executor);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This would keep the control where execution happens in the task and we don&apos;t need to pass down the executor. Wdyt?&lt;/p&gt;</comment>
                            <comment id="16886622" author="till.rohrmann" created="Wed, 17 Jul 2019 02:11:43 +0000"  >&lt;p&gt;I like this idea &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt;. It is not so invasive and should be easy to implement.&lt;/p&gt;</comment>
                            <comment id="16887752" author="srichter" created="Thu, 18 Jul 2019 08:40:49 +0000"  >&lt;p&gt;Merged in:&lt;br/&gt;
master: 23bd23b325&lt;br/&gt;
release-1.9: 3eff6387b5&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13244951">FLINK-13272</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13244864">FLINK-13254</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13233714">FLINK-12530</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12974545" name="jstack_25661_YarnTaskExecutorRunner" size="117174" author="trohrmann" created="Fri, 12 Jul 2019 16:39:14 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="13245785">FLINK-13325</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 17 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04mdc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>