<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18452] Fix StateMigrationException because RetractableTopNFunction#ComparatorWrapper might be incompatible</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18452</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We found that in SQL jobs using &quot;Top-N&quot; functionality provided by the blink planner, the job state cannot be retrieved because of &quot;incompatible&quot; state serializers (in fact they are compatible).&lt;/p&gt;

&lt;p&gt;The error log is displayed like below&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;taskmanager.log&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;2020-06-30&#160;09:19:32.089&#160;[Rank(strategy=&lt;span class=&quot;error&quot;&gt;&amp;#91;RetractStrategy&amp;#93;&lt;/span&gt;,&#160;rankType=&lt;span class=&quot;error&quot;&gt;&amp;#91;ROW_NUMBER&amp;#93;&lt;/span&gt;,&#160;rankRange=&lt;span class=&quot;error&quot;&gt;&amp;#91;rankStart=1,&#160;rankEnd=100&amp;#93;&lt;/span&gt;,&#160;partitionBy=&lt;span class=&quot;error&quot;&gt;&amp;#91;appkey,&#160;serverid&amp;#93;&lt;/span&gt;,&#160;orderBy=&lt;span class=&quot;error&quot;&gt;&amp;#91;quantity&#160;DESC&amp;#93;&lt;/span&gt;,&#160;select=&lt;span class=&quot;error&quot;&gt;&amp;#91;appkey,&#160;serverid,&#160; quantity&amp;#93;&lt;/span&gt;)&#160;(1/1)]&#160;INFO&#160;&#160;org.apache.flink.runtime.taskmanager.Task&#160;&#160;-&#160;Rank(strategy=&lt;span class=&quot;error&quot;&gt;&amp;#91;RetractStrategy&amp;#93;&lt;/span&gt;,&#160;rankType=&lt;span class=&quot;error&quot;&gt;&amp;#91;ROW_NUMBER&amp;#93;&lt;/span&gt;,&#160;rankRange=&lt;span class=&quot;error&quot;&gt;&amp;#91;rankStart=1,&#160;rankEnd=100&amp;#93;&lt;/span&gt;,&#160;partitionBy=&lt;span class=&quot;error&quot;&gt;&amp;#91;appkey,&#160;serverid&amp;#93;&lt;/span&gt;,&#160;orderBy=&lt;span class=&quot;error&quot;&gt;&amp;#91;quantity&#160;DESC&amp;#93;&lt;/span&gt;,&#160;select=&lt;span class=&quot;error&quot;&gt;&amp;#91;appkey,&#160;serverid,&#160;oid,&#160;quantity&amp;#93;&lt;/span&gt;)&#160;(1/1)&#160;(bd4d2e4327efac57dc70e220b8de460b)&#160;switched&#160;from&#160;RUNNING&#160;to&#160;FAILED.&lt;br/&gt;
java.lang.RuntimeException:&#160;Error&#160;while&#160;getting&#160;state&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.runtime.state.DefaultKeyedStateStore.getState(DefaultKeyedStateStore.java:62)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.streaming.api.operators.StreamingRuntimeContext.getState(StreamingRuntimeContext.java:144)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.table.runtime.operators.rank.RetractableTopNFunction.open(RetractableTopNFunction.java:115)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.api.common.functions.util.FunctionUtils.openFunction(FunctionUtils.java:36)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.open(AbstractUdfStreamOperator.java:102)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.streaming.api.operators.KeyedProcessOperator.open(KeyedProcessOperator.java:57)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.streaming.runtime.tasks.StreamTask.initializeStateAndOpen(StreamTask.java:990)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$beforeInvoke$0(StreamTask.java:453)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$SynchronizedStreamTaskActionExecutor.runThrowing(StreamTaskActionExecutor.java:94)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.streaming.runtime.tasks.StreamTask.beforeInvoke(StreamTask.java:448)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:460)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:708)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.runtime.taskmanager.Task.run(Task.java:533)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
Caused&#160;by:&#160;org.apache.flink.util.StateMigrationException:&#160;The&#160;new&#160;state&#160;serializer&#160;cannot&#160;be&#160;incompatible.&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend.updateRestoredStateMetaInfo(RocksDBKeyedStateBackend.java:543)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend.tryRegisterKvStateInformation(RocksDBKeyedStateBackend.java:491)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend.createInternalState(RocksDBKeyedStateBackend.java:652)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.runtime.state.KeyedStateFactory.createInternalState(KeyedStateFactory.java:47)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.runtime.state.ttl.TtlStateFactory.createStateAndWrapWithTtlIfEnabled(TtlStateFactory.java:72)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.runtime.state.AbstractKeyedStateBackend.getOrCreateKeyedState(AbstractKeyedStateBackend.java:279)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.runtime.state.AbstractKeyedStateBackend.getPartitionedState(AbstractKeyedStateBackend.java:328)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.runtime.state.DefaultKeyedStateStore.getPartitionedState(DefaultKeyedStateStore.java:124)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;at&#160;org.apache.flink.runtime.state.DefaultKeyedStateStore.getState(DefaultKeyedStateStore.java:60)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;...&#160;13&#160;more&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
After careful debugging, it is found to be an issue with the compatibility check of type serializers.&lt;br/&gt;
&#160;&lt;br/&gt;
In short, during checkpointing, Flink serializes &lt;em&gt;SortedMapSerializer&lt;/em&gt; by creating a&#160;&lt;em&gt;SortedMapSerializerSnapshot&lt;/em&gt; object, and the original comparator is encapsulated within the object (here we call it&#160;&lt;em&gt;StreamExecSortComparator$579&lt;/em&gt;).&lt;br/&gt;
&#160;&lt;br/&gt;
At restoration, the object is read and restored as normal. However, during the construction of&#160;RetractableTopNFunction instance, another Comparator is provided by Flink as an argument (we call it&#160;&lt;em&gt;StreamExecSortComparator$626&lt;/em&gt;), and it is later used in the &lt;em&gt;ValueStateDescriptor&lt;/em&gt; which acts like a key to the state store.&lt;br/&gt;
&#160;&lt;br/&gt;
Here comes the problem: when the newly-restored Flink program tries to access state (&lt;em&gt;getState&lt;/em&gt;) through the previously mentioned &lt;em&gt;ValueStateDescriptor&lt;/em&gt;, the State Backend firstly detects whether the provided comparator in state descriptor is compatible with the one in snapshot, eventually the logic goes to the &lt;em&gt;equals&lt;/em&gt; method at&#160;&lt;em&gt;RetractableTopNFunction.ComparatorWrapper&lt;/em&gt; class.&lt;br/&gt;
&#160;&lt;br/&gt;
In the equals method, here is a code snippet:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; generatedRecordComparator.getClassName().equals(oGeneratedComparator.getClassName()) &amp;amp;&amp;amp;
      generatedRecordComparator.getCode().equals(oGeneratedComparator.getCode()) &amp;amp;&amp;amp;
      Arrays.equals(generatedRecordComparator.getReferences(), oGeneratedComparator.getReferences());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After debugging, we found that the class name of comparator within snapshot is&#160;&lt;em&gt;StreamExecSortComparator$579&lt;/em&gt;, and the class name of comparator provided in the new job is&#160;&lt;em&gt;StreamExecSortComparator$626&lt;/em&gt;, hence this method always returns false, even though actually they are indeed compatible (acts the same). Also, because the code in each generator is generated independently, the corresponding varaibles within the two comparators are highly likely to be different (&lt;em&gt;isNullA$581&lt;/em&gt; vs &lt;em&gt;isNullA$682&lt;/em&gt;).&lt;br/&gt;
&#160;&lt;br/&gt;
Hence we believe that the implementation of equals method has serious flaws, and should be addressed in later releases.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13314196">FLINK-18452</key>
            <summary>Fix StateMigrationException because RetractableTopNFunction#ComparatorWrapper might be incompatible</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jark">Jark Wu</assignee>
                                    <reporter username="kyledong">Weike Dong</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 30 Jun 2020 03:40:10 +0000</created>
                <updated>Fri, 19 Nov 2021 15:12:26 +0000</updated>
                            <resolved>Mon, 23 Nov 2020 03:29:53 +0000</resolved>
                                    <version>1.10.0</version>
                    <version>1.10.1</version>
                    <version>1.11.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17148289" author="kyledong" created="Tue, 30 Jun 2020 03:45:16 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qingru.zhang&quot; class=&quot;user-hover&quot; rel=&quot;qingru.zhang&quot;&gt;qingru.zhang&lt;/a&gt;, would you please be so kind to look at this issue, as you are the original author for the code. Thank you very much.&lt;/p&gt;</comment>
                            <comment id="17148332" author="jark" created="Tue, 30 Jun 2020 06:05:33 +0000"  >&lt;p&gt;I think this is an issue in &lt;tt&gt;ComparatorWrapper#equals&lt;/tt&gt;, we shouldn&apos;t compare the generated class name and code, because they are not consistent even in the same Flink version. We should compare the sort key fields (the meata information used to generate the comparator). &lt;/p&gt;</comment>
                            <comment id="17148348" author="kyledong" created="Tue, 30 Jun 2020 06:31:26 +0000"  >&lt;p&gt;Thank you&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&#160;for the reply, and I agree that the meta info given to&#160;&lt;em&gt;org.apache.flink.table.planner.codegen.sort.ComparatorCodeGenerator#gen&lt;/em&gt;&#160;is more suitable for the comparison (maybe there are other classes that have the same problem).&lt;/p&gt;

&lt;p&gt;I am quite interested in solving this issue, could you please assign this ticket to me? Thank you very much : )&lt;/p&gt;</comment>
                            <comment id="17148388" author="kyledong" created="Tue, 30 Jun 2020 07:30:42 +0000"  >&lt;p&gt;One important thing to note here is backward compatibility. For example, for &lt;em&gt;GeneratedRecordComparator&lt;/em&gt; instances created in current or earlier Flink versions, AFAIK they do not have the proper meta info needed to compare with the new one with the meta info.&lt;/p&gt;

&lt;p&gt;In order to maintain compatibility, a hacky approach is to extract relevant fields from the generated code text, however, this is error-prone and could possibly only be used as a fallback approach if no other methods are available.&lt;/p&gt;

&lt;p&gt;Or maybe we could add a new class (like &lt;em&gt;GeneratedRecordComparatorV2&lt;/em&gt;) with the required meta info, and &quot;migrate&quot; the current implementation to the new one if needed. In this way, we could enumerate all of the comparator code generation implementations in existing Flink versions, and provide a robust migration plan.&lt;/p&gt;</comment>
                            <comment id="17149048" author="jark" created="Wed, 1 Jul 2020 02:12:14 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kyledong&quot; class=&quot;user-hover&quot; rel=&quot;kyledong&quot;&gt;kyledong&lt;/a&gt;, currently, SQL/Table doesn&apos;t provide state compatible across major versions. So I think we don&apos;t need to care about it. &lt;/p&gt;

&lt;p&gt;But I&apos;m not sure whether it is worth to fix in minor versions. If we need to fix it in minor versions, we may need a complex solution. &lt;/p&gt;</comment>
                            <comment id="17156587" author="kyledong" created="Mon, 13 Jul 2020 09:19:15 +0000"  >&lt;p&gt;Yes, I agree that we can fix this bug in next major release, i.e. 1.12.0, as currently there are no other user reports on this problem, it seems not to be that urgent to change existing class structure.&lt;/p&gt;</comment>
                            <comment id="17233224" author="jark" created="Tue, 17 Nov 2020 02:48:18 +0000"  >&lt;p&gt;I will take this issue. &lt;/p&gt;</comment>
                            <comment id="17237094" author="jark" created="Mon, 23 Nov 2020 03:29:53 +0000"  >&lt;p&gt;Fixed in master (1.12.0): 49029a0a690e0810d238c76446c05e2ec191b91a&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13006706" name="c2ebeac8aadebad0dffa5cc255d45190594c5b2a84bda020dd30bf24b9169702.png" size="192294" author="kyledong" created="Tue, 30 Jun 2020 03:39:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0gbl4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>