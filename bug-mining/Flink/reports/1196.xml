<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:25:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4640] Serialization of the initialValue of a Fold on WindowedStream fails</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4640</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The following program&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DataStream&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt; src = env.fromElements(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, 1L));

src
  .keyBy(1)
  .timeWindow(Time.minutes(5))
  .fold(TreeMultimap.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;create(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FoldFunction&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;, TreeMultimap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt;() {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TreeMultimap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; fold(
        TreeMultimap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; topKSoFar, 
        Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; itemCount) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception 
    {
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; item = itemCount.f0;
      &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; count = itemCount.f1;
      topKSoFar.put(count, item);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (topKSoFar.keySet().size() &amp;gt; 10) {
        topKSoFar.removeAll(topKSoFar.keySet().first());
      }
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; topKSoFar;
    }
});
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;throws this exception&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Caused by: java.lang.RuntimeException: Could not add value to folding state.&lt;br/&gt;
	at org.apache.flink.runtime.state.memory.MemFoldingState.add(MemFoldingState.java:91)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.operators.windowing.WindowOperator.processElement(WindowOperator.java:382)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.io.StreamInputProcessor.processInput(StreamInputProcessor.java:176)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.OneInputStreamTask.run(OneInputStreamTask.java:66)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:266)&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:584)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at com.google.common.collect.AbstractMapBasedMultimap.put(AbstractMapBasedMultimap.java:192)&lt;br/&gt;
	at com.google.common.collect.AbstractSetMultimap.put(AbstractSetMultimap.java:121)&lt;br/&gt;
	at com.google.common.collect.TreeMultimap.put(TreeMultimap.java:78)&lt;br/&gt;
	at org.apache.flink.streaming.examples.wordcount.WordCount$1.fold(WordCount.java:115)&lt;br/&gt;
	at org.apache.flink.streaming.examples.wordcount.WordCount$1.fold(WordCount.java:109)&lt;br/&gt;
	at org.apache.flink.runtime.state.memory.MemFoldingState.add(MemFoldingState.java:85)&lt;br/&gt;
	... 6 more&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The exception is caused because the initial value was not correctly deserialized and is &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The user reporting this issue said that using the same &lt;tt&gt;FoldFunction&lt;/tt&gt; on a &lt;tt&gt;KeyedStream&lt;/tt&gt; (without a window) works fine.&lt;/p&gt;

&lt;p&gt;I tracked the problem down to the serialization of the &lt;tt&gt;StateDescriptor&lt;/tt&gt;, i.e., the &lt;tt&gt;writeObject()&lt;/tt&gt; and &lt;tt&gt;readObject()&lt;/tt&gt; methods. The methods use Flink&apos;s TypeSerializers to serialize the default value. In case of the &lt;tt&gt;TreeMultiMap&lt;/tt&gt; this is the &lt;tt&gt;KryoSerializer&lt;/tt&gt; which fails to read the serialized data for some reason.&lt;/p&gt;

&lt;p&gt;A quick workaround to solve this issue would be to check if the default value implements &lt;tt&gt;Serializable&lt;/tt&gt; and use Java Serialization in this case. However, it would be good to track the root cause of this problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13006152">FLINK-4640</key>
            <summary>Serialization of the initialValue of a Fold on WindowedStream fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="fhueske">Fabian Hueske</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Sep 2016 09:16:10 +0000</created>
                <updated>Thu, 28 Feb 2019 11:16:22 +0000</updated>
                            <resolved>Wed, 21 Sep 2016 15:54:35 +0000</resolved>
                                    <version>1.1.2</version>
                    <version>1.2.0</version>
                                    <fixVersion>1.1.3</fixVersion>
                    <fixVersion>1.2.0</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15507104" author="stephanewen" created="Tue, 20 Sep 2016 16:50:01 +0000"  >&lt;p&gt;I actually reproduced the error BOTH on the &lt;tt&gt;KeyedStream&lt;/tt&gt; and on the &lt;tt&gt;WindowDataStream&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The problem is that Kryo cannot properly serialize the &lt;tt&gt;TreeMultiMap&lt;/tt&gt;. It uses Objenesis to instantiate the map on deserialization, which leaves a broken object that then causes the nullpointer exception.&lt;br/&gt;
That is a Kryo/Guava incompatibility. Not sure there is anything we can do directly about that.&lt;/p&gt;

&lt;p&gt;Should be fixable by registering a suitable serializer for the TreeMultiMap:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;env.registerTypeWithKryoSerializer(TreeMultimap.class, JavaSerializer.class);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15507323" author="stephanewen" created="Tue, 20 Sep 2016 18:15:00 +0000"  >&lt;p&gt;Okay, so the &lt;tt&gt;keyBy(1).fold(...)&lt;/tt&gt; case can be fixed via &lt;tt&gt;env.registerTypeWithKryoSerializer(TreeMultimap.class, JavaSerializer.class);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The Window operator still fails if I do &lt;tt&gt;keyBy(1).timeWindow(Time.seconds(10)).fold(...)&lt;/tt&gt;.&lt;br/&gt;
The bug is that serializer registrations are not properly forwarded.&lt;/p&gt;

&lt;p&gt;Fixing that...&lt;/p&gt;</comment>
                            <comment id="15507442" author="stephanewen" created="Tue, 20 Sep 2016 18:56:18 +0000"  >&lt;p&gt;Have a fix and nice tests. Waiting for the CI to give green light, then merging this fix.&lt;/p&gt;</comment>
                            <comment id="15510353" author="stephanewen" created="Wed, 21 Sep 2016 15:54:36 +0000"  >&lt;p&gt;Fixed in&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1.1.3 via 52a4440d916fb450c4999f6e1f42f392e247b426&lt;/li&gt;
	&lt;li&gt;1.2.0 via 4d4eb64be7490672771243147824a70d3d47c501&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33u47:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>