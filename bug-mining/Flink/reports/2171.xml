<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8462] TaskExecutor does not verify RM heartbeat timeouts</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8462</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;TaskExecutor&lt;/tt&gt; does&#160;neither&#160;properly stop RM heartbeats nor does it check whether a RM heartbeat timeout is still valid. As a consequence, it can happen that the &lt;tt&gt;TaskExecutor&lt;/tt&gt; closes the connection to an active &lt;tt&gt;RM&lt;/tt&gt; due to an outdated heartbeat timeout.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13132207">FLINK-8462</key>
            <summary>TaskExecutor does not verify RM heartbeat timeouts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>flip-6</label>
                    </labels>
                <created>Fri, 19 Jan 2018 14:57:51 +0000</created>
                <updated>Mon, 22 Jan 2018 21:56:09 +0000</updated>
                            <resolved>Mon, 22 Jan 2018 21:56:09 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16332535" author="githubbot" created="Fri, 19 Jan 2018 16:55:45 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5318&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5318&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8462&quot; title=&quot;TaskExecutor does not verify RM heartbeat timeouts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8462&quot;&gt;&lt;del&gt;FLINK-8462&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Filter invalid heartbeat timeouts in TaskExecutor&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This commit properly stops the heartbeating of disconnected RMs and additionally&lt;br/&gt;
    ignores outdated heartbeat timeouts for old RM connections out.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Unmonitor RMs when RM lost leadership&lt;/li&gt;
	&lt;li&gt;Check that RM heartbeats are still valid&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added `TaskExecutorTest#testRMHeartbeatStopWhenLeadershipRevoked`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    cc @GJL &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; filterInvalidRMTimeouts&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5318.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5318.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5318&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 5169dcad7defb7421903582fda0217448eefb008&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-01-19T13:56:42Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8462&quot; title=&quot;TaskExecutor does not verify RM heartbeat timeouts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8462&quot;&gt;&lt;del&gt;FLINK-8462&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Filter invalid heartbeat timeouts in TaskExecutor&lt;/p&gt;

&lt;p&gt;    This commit properly stops the heartbeating of disconnected RMs and additionally&lt;br/&gt;
    ignores outdated heartbeat timeouts for old RM connections out.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16333996" author="githubbot" created="Mon, 22 Jan 2018 08:17:47 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5318#discussion_r162865803&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5318#discussion_r162865803&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java &amp;#8212;&lt;br/&gt;
    @@ -717,15 +717,14 @@ private void notifyOfNewResourceManagerLeader(String newLeaderAddress, ResourceM&lt;br/&gt;
     			}&lt;/p&gt;

&lt;p&gt;     			// drop the current connection or connection attempt&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (resourceManagerConnection != null) 
{
    -				resourceManagerConnection.close();
    -				resourceManagerConnection = null;
    -			}
&lt;p&gt;    +			closeResourceManagerConnection(&lt;br/&gt;
    +				new FlinkException(&quot;New ResourceManager leader found under: &quot; + newLeaderAddress +&lt;br/&gt;
    +					&apos;(&apos; + newResourceManagerId + &apos;)&apos;));&lt;br/&gt;
     		}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		// establish a connection to the new leader&lt;br/&gt;
     		if (newLeaderAddress != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;log.info(&quot;Attempting to register at ResourceManager {}&quot;, newLeaderAddress);&lt;br/&gt;
    +			log.info(&quot;Attempting to register at ResourceManager {}({})&quot;, newLeaderAddress, newResourceManagerId);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: a space after the logged `newLeaderAddress` wouldn&apos;t hurt: `{} ({})`&lt;/p&gt;</comment>
                            <comment id="16333997" author="githubbot" created="Mon, 22 Jan 2018 08:17:47 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5318#discussion_r162867968&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5318#discussion_r162867968&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/taskexecutor/TaskExecutorTest.java &amp;#8212;&lt;br/&gt;
    @@ -1425,4 +1440,137 @@ public void testFilterOutDuplicateJobMasterRegistrations() throws Exception &lt;/p&gt;
{
     			taskExecutor.getTerminationFuture().get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that the heartbeat is stopped once the TaskExecutor detects that the RM is no longer leader.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8462&quot; title=&quot;TaskExecutor does not verify RM heartbeat timeouts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8462&quot;&gt;&lt;del&gt;FLINK-8462&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testRMHeartbeatStopWhenLeadershipRevoked() throws Exception {&lt;br/&gt;
    +		final long heartbeatInterval = 1L;&lt;br/&gt;
    +		final long heartbeatTimeout = 1000L;&lt;br/&gt;
    +		final TaskManagerConfiguration taskManagerConfiguration = TaskManagerConfiguration.fromConfiguration(new Configuration());&lt;br/&gt;
    +		final TaskManagerLocation taskManagerLocation = new LocalTaskManagerLocation();&lt;br/&gt;
    +		final TestingFatalErrorHandler testingFatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    +		final RecordingHeartbeatServices heartbeatServices = new RecordingHeartbeatServices(heartbeatInterval, heartbeatTimeout);&lt;br/&gt;
    +		final ResourceID rmResourceID = ResourceID.generate();&lt;br/&gt;
    +&lt;br/&gt;
    +		final TaskSlotTable taskSlotTable = new TaskSlotTable(Collections.singleton(ResourceProfile.UNKNOWN), timerService);&lt;br/&gt;
    +&lt;br/&gt;
    +		final TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    +		final TestingLeaderRetrievalService rmLeaderRetrievalService = new TestingLeaderRetrievalService();&lt;br/&gt;
    +		haServices.setResourceManagerLeaderRetriever(rmLeaderRetrievalService);&lt;br/&gt;
    +&lt;br/&gt;
    +		final String rmAddress = &quot;rm&quot;;&lt;br/&gt;
    +		final TestingResourceManagerGateway rmGateway = new TestingResourceManagerGateway(&lt;br/&gt;
    +			ResourceManagerId.generate(),&lt;br/&gt;
    +			rmResourceID,&lt;br/&gt;
    +			heartbeatInterval,&lt;br/&gt;
    +			rmAddress,&lt;br/&gt;
    +			rmAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;ResourceID&amp;gt; registeredTaskManagerFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		rmGateway.setRegisterTaskExecutorFunction(&lt;br/&gt;
    +			info -&amp;gt; &lt;/p&gt;
{
    +				registeredTaskManagerFuture.complete(info.f1);
    +				return CompletableFuture.completedFuture(
    +					new TaskExecutorRegistrationSuccess(
    +						new InstanceID(),
    +						rmResourceID,
    +						heartbeatInterval));
    +			}
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +		rpc.registerGateway(rmAddress, rmGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +		final TaskExecutor taskExecutor = new TaskExecutor(&lt;br/&gt;
    +			rpc,&lt;br/&gt;
    +			taskManagerConfiguration,&lt;br/&gt;
    +			taskManagerLocation,&lt;br/&gt;
    +			mock(MemoryManager.class),&lt;br/&gt;
    +			mock(IOManager.class),&lt;br/&gt;
    +			mock(NetworkEnvironment.class),&lt;br/&gt;
    +			haServices,&lt;br/&gt;
    +			heartbeatServices,&lt;br/&gt;
    +			mock(TaskManagerMetricGroup.class),&lt;br/&gt;
    +			mock(BroadcastVariableManager.class),&lt;br/&gt;
    +			mock(FileCache.class),&lt;br/&gt;
    +			taskSlotTable,&lt;br/&gt;
    +			mock(JobManagerTable.class),&lt;br/&gt;
    +			mock(JobLeaderService.class),&lt;br/&gt;
    +			testingFatalErrorHandler);&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			taskExecutor.start();&lt;br/&gt;
    +&lt;br/&gt;
    +			rmLeaderRetrievalService.notifyListener(rmAddress, rmGateway.getFencingToken().toUUID());&lt;br/&gt;
    +&lt;br/&gt;
    +			// wait for TM registration&lt;br/&gt;
    +			assertThat(&lt;br/&gt;
    +				registeredTaskManagerFuture.get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS),&lt;br/&gt;
    +				org.hamcrest.Matchers.equalTo(taskManagerLocation.getResourceID()));&lt;br/&gt;
    +&lt;br/&gt;
    +			final BlockingQueue&amp;lt;ResourceID&amp;gt; unmonitoredTargets = heartbeatServices.getUnmonitoredTargets();&lt;br/&gt;
    +&lt;br/&gt;
    +			// let RM lose leadership&lt;br/&gt;
    +			rmLeaderRetrievalService.notifyListener(null, null);&lt;br/&gt;
    +&lt;br/&gt;
    +			// the timeout should not have triggered since it is much higher&lt;br/&gt;
    +			assertThat(unmonitoredTargets.poll(100L, TimeUnit.MILLISECONDS), org.hamcrest.Matchers.equalTo(rmResourceID));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I&apos;d add a static import for `equalTo`, or simply use `assertEquals` since the other tests already do so.&lt;/p&gt;</comment>
                            <comment id="16333998" author="githubbot" created="Mon, 22 Jan 2018 08:17:47 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5318#discussion_r162867279&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5318#discussion_r162867279&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java &amp;#8212;&lt;br/&gt;
    @@ -1337,11 +1340,16 @@ public void reportPayload(ResourceID resourceID, Void payload) {&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void notifyHeartbeatTimeout(final ResourceID resourceId) {&lt;br/&gt;
     			runAsync(() -&amp;gt; {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;log.info(&quot;The heartbeat of ResourceManager with id {} timed out.&quot;, resourceId);&lt;br/&gt;
    +				// first check whether the timeout is still valid&lt;br/&gt;
    +				if (resourceManagerConnection != null &amp;amp;&amp;amp; resourceManagerConnection.getResourceManagerId().equals(resourceId)) {&lt;br/&gt;
    +					log.info(&quot;The heartbeat of ResourceManager with id {} timed out.&quot;, resourceId);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;closeResourceManagerConnection(&lt;/li&gt;
	&lt;li&gt;new TimeoutException(&lt;/li&gt;
	&lt;li&gt;&quot;The heartbeat of ResourceManager with id &quot; + resourceId + &quot; timed out.&quot;));&lt;br/&gt;
    +					closeResourceManagerConnection(&lt;br/&gt;
    +						new TimeoutException(&lt;br/&gt;
    +							&quot;The heartbeat of ResourceManager with id &quot; + resourceId + &quot; timed out.&quot;));&lt;br/&gt;
    +				} else {&lt;br/&gt;
    +					log.debug(&quot;Received heartbeat timeout for outdated ResourceManager connection {}. Ignoring the timeout.&quot;, resourceId);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: &lt;b&gt;ResourceManager with id&lt;/b&gt; vs &lt;b&gt;ResourceManager connection {}&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;    Same argument is logged but one is called a connection, the other one is called RM.&lt;/p&gt;
</comment>
                            <comment id="16334087" author="githubbot" created="Mon, 22 Jan 2018 09:59:20 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5318#discussion_r162890000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5318#discussion_r162890000&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/taskexecutor/TaskExecutorTest.java &amp;#8212;&lt;br/&gt;
    @@ -1425,4 +1440,137 @@ public void testFilterOutDuplicateJobMasterRegistrations() throws Exception &lt;/p&gt;
{
     			taskExecutor.getTerminationFuture().get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that the heartbeat is stopped once the TaskExecutor detects that the RM is no longer leader.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8462&quot; title=&quot;TaskExecutor does not verify RM heartbeat timeouts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8462&quot;&gt;&lt;del&gt;FLINK-8462&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testRMHeartbeatStopWhenLeadershipRevoked() throws Exception {&lt;br/&gt;
    +		final long heartbeatInterval = 1L;&lt;br/&gt;
    +		final long heartbeatTimeout = 1000L;&lt;br/&gt;
    +		final TaskManagerConfiguration taskManagerConfiguration = TaskManagerConfiguration.fromConfiguration(new Configuration());&lt;br/&gt;
    +		final TaskManagerLocation taskManagerLocation = new LocalTaskManagerLocation();&lt;br/&gt;
    +		final TestingFatalErrorHandler testingFatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    +		final RecordingHeartbeatServices heartbeatServices = new RecordingHeartbeatServices(heartbeatInterval, heartbeatTimeout);&lt;br/&gt;
    +		final ResourceID rmResourceID = ResourceID.generate();&lt;br/&gt;
    +&lt;br/&gt;
    +		final TaskSlotTable taskSlotTable = new TaskSlotTable(Collections.singleton(ResourceProfile.UNKNOWN), timerService);&lt;br/&gt;
    +&lt;br/&gt;
    +		final TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    +		final TestingLeaderRetrievalService rmLeaderRetrievalService = new TestingLeaderRetrievalService();&lt;br/&gt;
    +		haServices.setResourceManagerLeaderRetriever(rmLeaderRetrievalService);&lt;br/&gt;
    +&lt;br/&gt;
    +		final String rmAddress = &quot;rm&quot;;&lt;br/&gt;
    +		final TestingResourceManagerGateway rmGateway = new TestingResourceManagerGateway(&lt;br/&gt;
    +			ResourceManagerId.generate(),&lt;br/&gt;
    +			rmResourceID,&lt;br/&gt;
    +			heartbeatInterval,&lt;br/&gt;
    +			rmAddress,&lt;br/&gt;
    +			rmAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;ResourceID&amp;gt; registeredTaskManagerFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		rmGateway.setRegisterTaskExecutorFunction(&lt;br/&gt;
    +			info -&amp;gt; &lt;/p&gt;
{
    +				registeredTaskManagerFuture.complete(info.f1);
    +				return CompletableFuture.completedFuture(
    +					new TaskExecutorRegistrationSuccess(
    +						new InstanceID(),
    +						rmResourceID,
    +						heartbeatInterval));
    +			}
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +		rpc.registerGateway(rmAddress, rmGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +		final TaskExecutor taskExecutor = new TaskExecutor(&lt;br/&gt;
    +			rpc,&lt;br/&gt;
    +			taskManagerConfiguration,&lt;br/&gt;
    +			taskManagerLocation,&lt;br/&gt;
    +			mock(MemoryManager.class),&lt;br/&gt;
    +			mock(IOManager.class),&lt;br/&gt;
    +			mock(NetworkEnvironment.class),&lt;br/&gt;
    +			haServices,&lt;br/&gt;
    +			heartbeatServices,&lt;br/&gt;
    +			mock(TaskManagerMetricGroup.class),&lt;br/&gt;
    +			mock(BroadcastVariableManager.class),&lt;br/&gt;
    +			mock(FileCache.class),&lt;br/&gt;
    +			taskSlotTable,&lt;br/&gt;
    +			mock(JobManagerTable.class),&lt;br/&gt;
    +			mock(JobLeaderService.class),&lt;br/&gt;
    +			testingFatalErrorHandler);&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			taskExecutor.start();&lt;br/&gt;
    +&lt;br/&gt;
    +			rmLeaderRetrievalService.notifyListener(rmAddress, rmGateway.getFencingToken().toUUID());&lt;br/&gt;
    +&lt;br/&gt;
    +			// wait for TM registration&lt;br/&gt;
    +			assertThat(&lt;br/&gt;
    +				registeredTaskManagerFuture.get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS),&lt;br/&gt;
    +				org.hamcrest.Matchers.equalTo(taskManagerLocation.getResourceID()));&lt;br/&gt;
    +&lt;br/&gt;
    +			final BlockingQueue&amp;lt;ResourceID&amp;gt; unmonitoredTargets = heartbeatServices.getUnmonitoredTargets();&lt;br/&gt;
    +&lt;br/&gt;
    +			// let RM lose leadership&lt;br/&gt;
    +			rmLeaderRetrievalService.notifyListener(null, null);&lt;br/&gt;
    +&lt;br/&gt;
    +			// the timeout should not have triggered since it is much higher&lt;br/&gt;
    +			assertThat(unmonitoredTargets.poll(100L, TimeUnit.MILLISECONDS), org.hamcrest.Matchers.equalTo(rmResourceID));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Will change it.&lt;/p&gt;</comment>
                            <comment id="16334168" author="githubbot" created="Mon, 22 Jan 2018 11:33:39 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5318&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5318&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @GJL. I&apos;ve fixed the failing test case. Let&apos;s see what Travis says.&lt;/p&gt;</comment>
                            <comment id="16334390" author="githubbot" created="Mon, 22 Jan 2018 15:16:41 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5318&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5318&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Tests passed. Merging this PR.&lt;/p&gt;</comment>
                            <comment id="16334990" author="githubbot" created="Mon, 22 Jan 2018 21:55:02 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5318&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5318&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16334993" author="till.rohrmann" created="Mon, 22 Jan 2018 21:56:09 +0000"  >&lt;p&gt;Fixed via&#160;776af4a882c85926fc0764b702fec717c675e34c&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p4bb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>