<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:19:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-34518] Adaptive Scheduler restores from empty state if JM fails during restarting state</title>
                <link>https://issues.apache.org/jira/browse/FLINK-34518</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;If a JobManager failover occurs while the Job is in a Restarting state, the HA metadata is deleted (as if it was a globally terminal state) and the job restarts from an empty state after the JM comes back up:&lt;/p&gt;

&lt;p&gt;Jobmanager killed after killing Taskmanager (restarting phase):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2024-02-26 10:10:12,147 DEBUG org.apache.flink.kubernetes.KubernetesResourceManagerDriver &#160;[] - Ignore TaskManager pod that is already added: autoscaling-example-taskmanager-3-2
2024-02-26 10:10:13,799 DEBUG org.apache.flink.runtime.resourcemanager.active.ActiveResourceManager [] - Trigger heartbeat request.
2024-02-26 10:10:13,799 DEBUG org.apache.flink.runtime.resourcemanager.active.ActiveResourceManager [] - Trigger heartbeat request.
2024-02-26 10:10:13,799 DEBUG org.apache.flink.runtime.jobmaster.JobMaster &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - Received heartbeat request from 9b7e17b75812ab60ecf028e02368d0c2.
2024-02-26 10:10:13,799 DEBUG org.apache.flink.runtime.resourcemanager.active.ActiveResourceManager [] - Received heartbeat from 251c25cf794e3c9396fc02306613507b.
2024-02-26 10:10:14,091 DEBUG org.apache.pekko.remote.transport.netty.NettyTransport &#160; &#160; &#160; [] - Remote connection to [/10.244.0.120:55647] was disconnected because of [id: 0x4a61a791, /10.244.0.120:55647 :&amp;gt; /10.244.0.118:6123] DISCONNECTED
2024-02-26 10:10:14,091 DEBUG org.apache.pekko.remote.transport.ProtocolStateActor &#160; &#160; &#160; &#160; [] - Association between local [tcp://flink@10.244.0.118:6123] and remote [tcp://flink@10.244.0.120:55647] was disassociated because the ProtocolStateActor failed: Unknown
2024-02-26 10:10:14,092 INFO &#160;org.apache.flink.runtime.entrypoint.ClusterEntrypoint &#160; &#160; &#160; &#160;[] - RECEIVED SIGNAL 15: SIGTERM. Shutting down as requested.
2024-02-26 10:10:14,094 INFO &#160;org.apache.flink.runtime.entrypoint.ClusterEntrypoint &#160; &#160; &#160; &#160;[] - Shutting KubernetesApplicationClusterEntrypoint down with application status UNKNOWN. Diagnostics Cluster entrypoint has been closed externally..
2024-02-26 10:10:14,095 INFO &#160;org.apache.flink.runtime.blob.BlobServer &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - Stopped BLOB server at 0.0.0.0:6124
2024-02-26 10:10:14,095 INFO &#160;org.apache.flink.runtime.jobmaster.MiniDispatcherRestEndpoint [] - Shutting down rest endpoint.
2024-02-26 10:10:14,315 DEBUG org.apache.flink.kubernetes.shaded.io.fabric8.kubernetes.client.Watcher [] - Watcher closed
2024-02-26 10:10:14,511 DEBUG org.apache.pekko.actor.CoordinatedShutdown &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - Performing task [terminate-system] in CoordinatedShutdown phase [actor-system-terminate]
2024-02-26 10:10:14,595 INFO &#160;org.apache.pekko.remote.RemoteActorRefProvider$RemotingTerminator [] - Shutting down remote daemon.
2024-02-26 10:10:14,596 INFO &#160;org.apache.pekko.remote.RemoteActorRefProvider$RemotingTerminator [] - Remote daemon shut down; proceeding with flushing remote transports.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then the new JM comes back it doesn&apos;t find any checkpoints as the HA metadata was deleted (we couldn&apos;t see this in the logs of the shutting down JM):&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2024-02-26 10:10:30,294 INFO  org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStoreUtils [] - Recovering checkpoints from KubernetesStateHandleStore{configMapName=&apos;autoscaling-example-5ddd0b1ba346d3bfd5ef53a63772e43c-config-map&apos;}.2024-02-26 10:10:30,394 INFO  org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStoreUtils [] - Found 0 checkpoints in KubernetesStateHandleStore{configMapName=&apos;autoscaling-example-5ddd0b1ba346d3bfd5ef53a63772e43c-config-map&apos;}.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Even the main method is re-run and the jobgraph is regenerated (which is expected given the HA metadata was removed incorrectly)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13569823">FLINK-34518</key>
            <summary>Adaptive Scheduler restores from empty state if JM fails during restarting state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mapohl">Matthias Pohl</assignee>
                                    <reporter username="gyfora">Gyula Fora</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 26 Feb 2024 10:15:03 +0000</created>
                <updated>Tue, 27 Feb 2024 14:13:20 +0000</updated>
                            <resolved>Tue, 27 Feb 2024 14:13:20 +0000</resolved>
                                    <version>1.17.2</version>
                    <version>1.19.0</version>
                    <version>1.18.1</version>
                    <version>1.20.0</version>
                                    <fixVersion>1.19.0</fixVersion>
                    <fixVersion>1.17.3</fixVersion>
                    <fixVersion>1.18.2</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17820656" author="gyfora" created="Mon, 26 Feb 2024 10:15:40 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17820675" author="mapohl" created="Mon, 26 Feb 2024 11:12:53 +0000"  >&lt;p&gt;thanks for reporting this issue, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gyfora&quot; class=&quot;user-hover&quot; rel=&quot;gyfora&quot;&gt;gyfora&lt;/a&gt;. Are you suppressing certain INFO/DEBUG logs from being generated? I would have expected a bit more content after the log line about &quot;Shutting KubernetesApplicationClusterEntrypoint down with &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&quot;, e.g. the info that the currently running job was suspended in &lt;a href=&quot;https://github.com/apache/flink/blob/c3c836216eaaaf24c1add3b490c8f425fda01d7c/flink-runtime/src/main/java/org/apache/flink/runtime/executiongraph/DefaultExecutionGraph.java#L1060&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DefaultExecutionGraph:1060&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Btw. &lt;a href=&quot;https://raw.githubusercontent.com/XComp/flink-diagrams/main/diagrams/dispatcher-shutdown-sequence.svg&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this sequence diagram&lt;/a&gt; of the JobManager shutdown process might help if somebody else wants to look into it as well.&lt;/p&gt;</comment>
                            <comment id="17820679" author="mapohl" created="Mon, 26 Feb 2024 11:25:16 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I would have expected a bit more content after the log line about &quot;Shutting KubernetesApplicationClusterEntrypoint down with &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&quot;, e.g. the info that the currently running job was suspended in DefaultExecutionGraph:1060.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ok, never mind. The cancellation of the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; in the &lt;tt&gt;Restarting&lt;/tt&gt; state&apos;s constructor (&lt;a href=&quot;https://github.com/apache/flink/blob/676e8e5528f99eb8ba5747f7489b0f02ee025dd6/flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/adaptive/Restarting.java#L65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Restarting:65&lt;/a&gt;) switches the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; eventually into a globally terminal state prior to suspending the graph as part of the JM failover which prevents the suspend logic to kick in &lt;a href=&quot;https://github.com/apache/flink/blob/c3c836216eaaaf24c1add3b490c8f425fda01d7c/flink-runtime/src/main/java/org/apache/flink/runtime/executiongraph/DefaultExecutionGraph.java#L1029&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DefaultExecutionGraph:1029&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Suspending the job will still be executed in the &lt;tt&gt;Restarting&lt;/tt&gt; state (see &lt;a href=&quot;https://github.com/apache/flink/blob/16bac7802284563c95cfe18fcf153e91dc06216e/flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/adaptive/StateWithExecutionGraph.java#L168&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;StateWithExecutionGraph:168&lt;/a&gt;) resulting in the &lt;tt&gt;AdaptiveScheduler&lt;/tt&gt; reaching &lt;tt&gt;Finished&lt;/tt&gt; state with an &lt;tt&gt;ArchivedExecutionGraph&lt;/tt&gt; in &lt;tt&gt;CANCELED&lt;/tt&gt; state (which is &lt;a href=&quot;https://github.com/apache/flink/blob/582941b0f13d1cc51077e0e69fd100afe080779f/flink-core/src/main/java/org/apache/flink/api/common/JobStatus.java#L48&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;globally terminal&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;ExecutionGraph&lt;/tt&gt;&apos;s status is then translated to a successful &lt;tt&gt;JobManagerRunnerResult&lt;/tt&gt; instance in &lt;a href=&quot;https://github.com/apache/flink/blob/4882fbd9744d456e09ca60b6c7cf7a5b60326c73/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/DefaultJobMasterServiceProcess.java#L219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DefaultJobMasterServiceProcess:219&lt;/a&gt; which takes precendence over the completion of the &lt;tt&gt;JobManagerRunner&lt;/tt&gt;&apos;s result in &lt;a href=&quot;https://github.com/apache/flink/blob/c9fcb0c74b1354f4f0f1b7c7f62191b8cc6b5725/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMasterServiceLeadershipRunner.java#L143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JobMasterServiceLeadershipRunner:143&lt;/a&gt; that happens when closing the runner as part of the JM failover.&lt;/p&gt;

&lt;p&gt;But the actual race condition happens between the &lt;tt&gt;ExecutionGraph#cancel&lt;/tt&gt; call in the constructor of the &lt;tt&gt;Restarting&lt;/tt&gt; state and the &lt;tt&gt;ExecutionGraph#suspend&lt;/tt&gt; call in &lt;tt&gt;StateWithExecutionGraph#suspend&lt;/tt&gt;. The behavior we&apos;re seeing can only happen if the cancellation completes before the suspend call is triggered (because the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; will only then reach the globally-terminal JobStatus &lt;tt&gt;CANCELLED&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="17821080" author="mapohl" created="Tue, 27 Feb 2024 09:06:34 +0000"  >&lt;p&gt;master: &lt;a href=&quot;https://github.com/apache/flink/commit/3ba6f15043aac3e2d4744ad2431b4805ce5dec5a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3ba6f15043aac3e2d4744ad2431b4805ce5dec5a&lt;/a&gt;&lt;br/&gt;
1.19: &lt;a href=&quot;https://github.com/apache/flink/commit/d743ee33067dad18817d158f91db821cb494a31e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;d743ee33067dad18817d158f91db821cb494a31e&lt;/a&gt;&lt;br/&gt;
1.18: &lt;a href=&quot;https://github.com/apache/flink/commit/384f6b24de9941d452ec84f9a7f617a65cb207a8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;384f6b24de9941d452ec84f9a7f617a65cb207a8&lt;/a&gt;&lt;br/&gt;
1.17: 1.17: &lt;a href=&quot;https://github.com/apache/flink/commit/539a6fefa4cd049139e3be04f1672437e12744d5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;539a6fefa4cd049139e3be04f1672437e12744d5&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13568819">FLINK-34451</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nm74:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>