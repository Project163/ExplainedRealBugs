<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:48:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14938] Flink elasticsearch failure handler re-add indexrequest causes ConcurrentModificationException</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14938</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When use Elasticsearch connector failure handler (from official example) to re-add documents, Flink encountered ConcurrentModificationException.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
input.addSink(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ElasticsearchSink&amp;lt;&amp;gt;(
    config, transportAddresses,
    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ElasticsearchSinkFunction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;() {...},
    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActionRequestFailureHandler() {
        @Override
        void onFailure(ActionRequest action,
                Throwable failure,
                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; restStatusCode,
                RequestIndexer indexer) &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; Throwable {

            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ExceptionUtils.findThrowable(failure, EsRejectedExecutionException.class).isPresent()) {
                &lt;span class=&quot;code-comment&quot;&gt;// full queue; re-add document &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; indexing
&lt;/span&gt;                indexer.add(action);
            }
        }
}));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I found that in method BufferingNoOpRequestIndexer$processBufferedRequests, it will iterator a list of ActionRequest. However the failure handler will keep re-adding request to that list after bulk, which causes ConcurrentModificationException.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
void processBufferedRequests(RequestIndexer actualIndexer) {
   &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ActionRequest request : bufferedRequests) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (request &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; IndexRequest) {
         actualIndexer.add((IndexRequest) request);
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (request &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; DeleteRequest) {
         actualIndexer.add((DeleteRequest) request);
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (request &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; UpdateRequest) {
         actualIndexer.add((UpdateRequest) request);
      }
   }

   bufferedRequests.clear();
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think it should be a multi-thread bug and is it ok to use concurrent queue to maintain the failure request?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13270388">FLINK-14938</key>
            <summary>Flink elasticsearch failure handler re-add indexrequest causes ConcurrentModificationException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ysn2233">Shengnan YU</assignee>
                                    <reporter username="ysn2233">Shengnan YU</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 25 Nov 2019 08:32:42 +0000</created>
                <updated>Wed, 24 Jun 2020 09:38:36 +0000</updated>
                            <resolved>Wed, 24 Jun 2020 09:38:34 +0000</resolved>
                                    <version>1.8.1</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Connectors / ElasticSearch</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="16981381" author="ysn2233" created="Mon, 25 Nov 2019 08:41:08 +0000"  >&lt;p&gt;If it is a bug, could please assign this ticket to me to solve?&lt;/p&gt;</comment>
                            <comment id="16994661" author="rmetzger" created="Thu, 12 Dec 2019 13:25:40 +0000"  >&lt;p&gt;Thanks for looking into this. I&apos;ve assigned you!&lt;/p&gt;</comment>
                            <comment id="17044070" author="pqf" created="Tue, 25 Feb 2020 02:33:39 +0000"  >&lt;p&gt;Any update on this issue?&lt;/p&gt;</comment>
                            <comment id="17059695" author="ysn2233" created="Sun, 15 Mar 2020 14:27:59 +0000"  >&lt;p&gt;The easiest way to solve this issue is to use ConcurrentLinkedQueue instead of ArrayList in BufferingNoOpRequestIndexer. However use concurrent queue &apos;may&apos; affect performance if users don&apos;t have any failure handles or have nothing to do with concurrent concerns. Therefore I&apos;d like to create a new class ConcurrentBufferingNoOpRequestIndexer which use concurrent queue and users can decided which RequestIndexer to use when they build ElasticsearchSink.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What do you think of this solution? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt;&#160;Thank you very much.&lt;/p&gt;</comment>
                            <comment id="17093058" author="hwanju" created="Mon, 27 Apr 2020 06:32:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ysn2233&quot; class=&quot;user-hover&quot; rel=&quot;ysn2233&quot;&gt;ysn2233&lt;/a&gt; - I have a question on your proposed solution. I wonder if you&apos;ve gotten any performance measurement, which would&apos;ve led you to that hybrid solution. IMO, since this ElasticSearch sink path is involved in I/O to external services, any CPU penalty incurred by concurrency-aware data structure may be dwarfed or invisible by much high I/O latency, so using CurrentLinkedQueue seems to be just fine to me (I mean in terms of latency, but it could be some additional CPU cost, which I am also not sure about its significance quantitatively). We are also looking to the resolution of this problem, but wanted to check if you have performance test to confirm whether such cost matters.&lt;/p&gt;</comment>
                            <comment id="17143704" author="aljoscha" created="Wed, 24 Jun 2020 09:35:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ysn2233&quot; class=&quot;user-hover&quot; rel=&quot;ysn2233&quot;&gt;ysn2233&lt;/a&gt; opened a PR with the simpler solution. I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hwanju&quot; class=&quot;user-hover&quot; rel=&quot;hwanju&quot;&gt;hwanju&lt;/a&gt; that it shouldn&apos;t be a problem. If it turns out to be a problem we need to investigate further.&lt;/p&gt;</comment>
                            <comment id="17143705" author="aljoscha" created="Wed, 24 Jun 2020 09:38:34 +0000"  >&lt;p&gt;master: 44ea896d6c5bbfcabb79d9649dd15c834741c4b9&lt;br/&gt;
release-1.11: bb1f162d8e7cf3d24c01679492e53b3a041cdde9&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 20 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z08yuo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>