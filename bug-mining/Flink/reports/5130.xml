<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:53:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21488] Jdbc XA sink - XID generation conflicts between jobs</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21488</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I&apos;m using Flink 1.13&apos;s JDBC XA sink to write data to oracle DB using exactly once semantics.&lt;br/&gt;
I want to have two jobs doing this. One is working right now. When starting second one, I encountered errors:&lt;/p&gt;

&lt;p&gt;org.apache.flink.util.FlinkRuntimeException: unable to start XA transaction, xid: 201:0600000000000000:9b1d1b84e8ce79bb, error -3: resource manager error has occurred. &lt;span class=&quot;error&quot;&gt;&amp;#91;XAErr (-3): A resource manager error has occured in the transaction branch. ORA-2079 SQLErr (0)&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Oracle description:&lt;br/&gt;
ORA-02079: cannot join a committing distributed transaction&lt;br/&gt;
&#160; &#160; Cause: Once a transaction branch is prepared, no more new transaction branches are allowed to start, nor is the prepared transaction branch allowed to be joined.&lt;br/&gt;
&#160; &#160; Action: Check the application code as this is an XA protocol violation.&lt;/p&gt;

&lt;p&gt;I&apos;ve looked at the implementation of XID generation and noticed following line:&lt;/p&gt;

&lt;p&gt;private transient byte[] gtridBuffer; // globalTransactionId = checkpoint id (long)&lt;/p&gt;

&lt;p&gt;My hypothesis is that second job generated xid that referred to global transaction id that the first job created. If I&apos;m right, then I&apos;d suppose fix would rely on embedding part of job id inside of gtridBuffer.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13360640">FLINK-21488</key>
            <summary>Jdbc XA sink - XID generation conflicts between jobs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mobuchowski">Maciej Obuchowski</assignee>
                                    <reporter username="mobuchowski">Maciej Obuchowski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 24 Feb 2021 14:39:25 +0000</created>
                <updated>Tue, 14 Oct 2025 12:02:26 +0000</updated>
                            <resolved>Thu, 11 Mar 2021 13:17:56 +0000</resolved>
                                    <version>1.13.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                                    <component>Connectors / JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17290924" author="mobuchowski" created="Thu, 25 Feb 2021 13:53:43 +0000"  >&lt;p&gt;Turns out getting jobId from runtime context is not that easy. In my local fix I&apos;ve used random 4 bytes generated by job manager on job startup.&lt;/p&gt;

&lt;p&gt;If this solution is acceptable, I can provide PR.&lt;/p&gt;</comment>
                            <comment id="17292453" author="mobuchowski" created="Sun, 28 Feb 2021 17:41:52 +0000"  >&lt;p&gt;Sorry for bothering, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; but can you take a look at this issue?&lt;/p&gt;</comment>
                            <comment id="17292528" author="roman_khachatryan" created="Sun, 28 Feb 2021 21:54:19 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mobuchowski&quot; class=&quot;user-hover&quot; rel=&quot;mobuchowski&quot;&gt;mobuchowski&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;XID generation is apparently incorrect.&lt;/p&gt;

&lt;p&gt;I think swapping global and local branch IDs would work.&lt;/p&gt;

&lt;p&gt;Job ID, which is 128 bits, unfortunately doesn&apos;t fit into the global branch identifier (64 bits).&lt;/p&gt;</comment>
                            <comment id="17292533" author="mobuchowski" created="Sun, 28 Feb 2021 22:24:05 +0000"  >&lt;p&gt;XID global/branch identifiers max sizes are defined as 64 bytes, not bits, so it would fit. Not sure if there are any performance implications of using longer or shorter ids.&lt;/p&gt;

&lt;p&gt;However, seems to me that swapping those would be a simpler solution. &lt;br/&gt;
I&apos;ll test it tomorrow and will be able to provide PR after.&lt;/p&gt;</comment>
                            <comment id="17292534" author="roman_khachatryan" created="Sun, 28 Feb 2021 22:29:15 +0000"  >&lt;p&gt;Yes, you are right, thanks!&lt;/p&gt;</comment>
                            <comment id="17292824" author="mobuchowski" created="Mon, 1 Mar 2021 11:07:34 +0000"  >&lt;p&gt;Unfortunately, swapping those does not work. Using statically generated bytes as global transaction id makes second checkpoint fail - as Oracle treats this as starting second transaction branch with already prepared transaction.&#160; &lt;/p&gt;

&lt;p&gt;So, I believe that global transaction id has to be well, globally unique. And branch id is kind of irrelevant here as every transaction that this sink makes has only one branch.&lt;/p&gt;

&lt;p&gt;My proposed solutions right now are:&lt;br/&gt;
1) Keep &quot;semantic&quot; semantics of current generator, and make gtrId combination of job id, task index and checkpoint id. Problem with this solution is that we&apos;re adding 16 bytes to gtrId, and that getting job id in runtime is not trivial: &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/How-to-get-flink-JobId-in-runtime-td36756.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/How-to-get-flink-JobId-in-runtime-td36756.html&lt;/a&gt; &lt;br/&gt;
2) Add 4 or 8 byte static random component to gtrId. &lt;br/&gt;
3) Make gtrId random on each generateXid call.&lt;/p&gt;</comment>
                            <comment id="17293164" author="roman_khachatryan" created="Mon, 1 Mar 2021 20:34:09 +0000"  >&lt;p&gt;The 1st options seems preferable to me as it guarantees uniqueness in most cases (not all, however).&lt;/p&gt;

&lt;p&gt;I published a PR to simplify access to JobID via RuntimeContext: &lt;a href=&quot;https://github.com/apache/flink/pull/15053&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/15053&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17293626" author="mobuchowski" created="Tue, 2 Mar 2021 11:19:21 +0000"  >&lt;p&gt;Thanks. Will push PR as soon as it&apos;s merged.&lt;/p&gt;</comment>
                            <comment id="17299556" author="roman_khachatryan" created="Thu, 11 Mar 2021 13:17:56 +0000"  >&lt;p&gt;Merged into master as `cb987a114a5a496ef3399507a547f83140c20d9f` .. `46546c4887c226a32da8ecfaee42ede0749ef4b6`.&lt;/p&gt;

&lt;p&gt;Thanks for the fix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mobuchowski&quot; class=&quot;user-hover&quot; rel=&quot;mobuchowski&quot;&gt;mobuchowski&lt;/a&gt;&#160;!&lt;/p&gt;</comment>
                            <comment id="18029757" author="JIRAUSER303600" created="Tue, 14 Oct 2025 12:01:25 +0000"  >&lt;p&gt;Hello we tried to have a single job with multiple exactly once jdbc sinks. It failed with the same error as described in this issue. Is it possible that the current implementation of generating XIDs simply cannot handle multiple exactly once jdbc sinks in the same job?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0o0pc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>