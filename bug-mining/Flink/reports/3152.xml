<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:40:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-13226] KafkaProducerExactlyOnceITCase.testMultipleSinkOperators fails on Travis</title>
                <link>https://issues.apache.org/jira/browse/FLINK-13226</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;KafkaProducerExactlyOnceITCase.testMultipleSinkOperators&lt;/tt&gt; fails on Travis with not producing output for 300 s.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://api.travis-ci.org/v3/job/557290235/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/557290235/log.txt&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13244329">FLINK-13226</key>
            <summary>KafkaProducerExactlyOnceITCase.testMultipleSinkOperators fails on Travis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="becket_qin">Jiangjie Qin</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Thu, 11 Jul 2019 13:38:17 +0000</created>
                <updated>Wed, 11 Oct 2023 19:02:52 +0000</updated>
                            <resolved>Thu, 1 Aug 2019 07:28:16 +0000</resolved>
                                    <version>1.9.0</version>
                                    <fixVersion>1.9.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16885348" author="becket_qin" created="Mon, 15 Jul 2019 16:00:08 +0000"  >&lt;p&gt;I took a look at the stack trace here. We are hitting &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6635&quot; title=&quot;Producer close does not await pending transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6635&quot;&gt;&lt;del&gt;KAFKA-6635&lt;/del&gt;&lt;/a&gt; here which is causing a deadlock.&lt;/p&gt;

&lt;p&gt;The expected behavior of the test is the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;produce some messages to Kafka&#160;&lt;/li&gt;
	&lt;li&gt;flush and checkpoint some of the messages.&lt;/li&gt;
	&lt;li&gt;produce some more messages.&lt;/li&gt;
	&lt;li&gt;inject an artificial exception to cause the application&#160;to fail&lt;/li&gt;
	&lt;li&gt;failover, complete the producing and finish the job&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The process stuck at step 5.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The task main thread was about to exit and tried to grab checkpoint lock to&#160;release the operator chain outputs.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
&quot;Source: Custom Source -&amp;gt; Map -&amp;gt; (Sink: Unnamed, Sink: Unnamed) (1/1)&quot; #224 prio=5 os_prio=0 tid=0x00007f7360c28800 nid=0x36e4 waiting for monitor entry [0x00007f732d44d000]
 java.lang.Thread.State: BLOCKED (on object monitor)
 at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:489)
 - waiting to lock &amp;lt;0x000000009914c9d8&amp;gt; (a java.lang.Object)
 at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:685)
 at org.apache.flink.runtime.taskmanager.Task.run(Task.java:515)
 at java.lang.Thread.run(Thread.java:748)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But the checkpointing thread was holding the checkpoint lock and blocked waiting for the Kafka transaction to be committed.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
&quot;Async calls on Source: Custom Source -&amp;gt; Map -&amp;gt; (Sink: Unnamed, Sink: Unnamed) (1/1)&quot; #227 daemon prio=5 os_prio=0 tid=0x00007f7343ccf800 nid=0x36e7 waiting on condition [0x00007f732cf4a000]
 java.lang.Thread.State: WAITING (parking)
 at sun.misc.Unsafe.park(Native Method)
 - parking to wait for &amp;lt;0x00000000ec805fb8&amp;gt; (a java.util.concurrent.CountDownLatch$Sync)
 at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
 at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
 at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:997)
 at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1304)
 at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:231)
 at org.apache.kafka.clients.producer.internals.TransactionalRequestResult.await(TransactionalRequestResult.java:50)
 at org.apache.kafka.clients.producer.KafkaProducer.commitTransaction(KafkaProducer.java:698)
 at org.apache.flink.streaming.connectors.kafka.internal.FlinkKafkaInternalProducer.commitTransaction(FlinkKafkaInternalProducer.java:86)
 at org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer.commit(FlinkKafkaProducer.java:906)
 at org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer.commit(FlinkKafkaProducer.java:98)
 at org.apache.flink.streaming.api.functions.sink.TwoPhaseCommitSinkFunction.notifyCheckpointComplete(TwoPhaseCommitSinkFunction.java:283)
 at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.notifyCheckpointComplete(AbstractUdfStreamOperator.java:130)
 at org.apache.flink.streaming.runtime.tasks.StreamTask.notifyCheckpointComplete(StreamTask.java:827)
 - locked &amp;lt;0x000000009914c9d8&amp;gt; (a java.lang.Object)
 at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1178)
 at java.util.concurrent.CompletableFuture$AsyncRun.run(CompletableFuture.java:1626)
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
 at java.lang.Thread.run(Thread.java:748)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The KafkaProducer internal sender thread is supposed to complete the transaction commit and notify the thread committing transaction. However, the internal sender thread has already gone because the producers has been closed when the task main thread disposes the all the operators. Therefore the checkpointing thread will just block forever, so does the task main thread.&lt;/p&gt;

&lt;p&gt;This fix should be on the KafkaProducer side. However, currently the fix is only in Kafka 2.3.0. And there is no chance this to be backported to 0.11. Given that we do not have Kafka 2.3.0 dependency in Flink 1.9. We probably still need to fix it by ourselves in Flink first.&lt;/p&gt;

&lt;p&gt;I think the solution here is basically&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Ensure the closing of the FlinkKafkaProducer is mutually exclusive to any other thread.&lt;/li&gt;
	&lt;li&gt;After the FlinkKafkaProducer is closed, no further action is made to the producer.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16895051" author="till.rohrmann" created="Mon, 29 Jul 2019 08:27:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; please help reviewing.&lt;/p&gt;</comment>
                            <comment id="16897837" author="becket_qin" created="Thu, 1 Aug 2019 07:27:57 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.9&lt;br/&gt;
4f2d5f1d41efefd5704261777245afccebd44ea7&lt;br/&gt;
3c2f2e7a1e7abaf88d5734906f26ef4c8aa0df83&lt;br/&gt;
bb858ab8df711212779881c8514bbbf91fbedaca&lt;/p&gt;

&lt;p&gt;1.10&lt;br/&gt;
6d474988e3d71c9df8ee85912d5eed5a26869a50&lt;br/&gt;
cc3184a35f2430c94535a095c2f926e912f692bf&lt;br/&gt;
09f96b339f4890d7a44ae92c915ea8c0f6f244cb&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04kgg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>