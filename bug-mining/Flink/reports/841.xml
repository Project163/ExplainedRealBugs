<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:22:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-3385] Fix outer join skipping unprobed partitions</title>
                <link>https://issues.apache.org/jira/browse/FLINK-3385</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;tt&gt;MutableHashTable.nextRecord&lt;/tt&gt; performs three steps for a build-side outer join:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; nextRecord() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (buildSideOuterJoin) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; processProbeIter() || processUnmatchedBuildIter() || prepareNextPartition();
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; processProbeIter() || prepareNextPartition();
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;MutableHashTable.processUnmatchedBuildIter&lt;/tt&gt; eventually calls through to &lt;tt&gt;MutableHashTable.moveToNextBucket&lt;/tt&gt; which is unable to process spilled partitions:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (p.isInMemory()) {
				...
			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
			}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;MutableHashTable.prepareNextPartition&lt;/tt&gt; calls &lt;tt&gt;HashPartition.finalizeProbePhase&lt;/tt&gt; which only spills the partition (to be read and processed in the next instantiation of &lt;tt&gt;MutableHashTable&lt;/tt&gt;) if probe-side records were spilled. In an equi-join this is fine but with an outer join the unmatched build-side records must still be retained (though no further probing is necessary, so could this be short-circuited when loaded by the next &lt;tt&gt;MutableHashTable&lt;/tt&gt;?).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isInMemory()) {
			...
		}
		&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.probeSideRecordCounter == 0) {
			&lt;span class=&quot;code-comment&quot;&gt;// partition is empty, no spilled buffers
&lt;/span&gt;			&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the memory buffer
&lt;/span&gt;			freeMemory.add(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.probeSideBuffer.getCurrentSegment());

			&lt;span class=&quot;code-comment&quot;&gt;// delete the spill files
&lt;/span&gt;			&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.probeSideChannel.close();
			&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.buildSideChannel.deleteChannel();
			&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.probeSideChannel.deleteChannel();
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;
		}
		&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			&lt;span class=&quot;code-comment&quot;&gt;// flush the last probe side buffer and register &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; partition as pending
&lt;/span&gt;			&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.probeSideBuffer.close();
			&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.probeSideChannel.close();
			spilledPartitions.add(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 1;
		}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12938289">FLINK-3385</key>
            <summary>Fix outer join skipping unprobed partitions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="greghogan">Greg Hogan</assignee>
                                    <reporter username="greghogan">Greg Hogan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Feb 2016 19:07:07 +0000</created>
                <updated>Tue, 23 Feb 2016 08:22:39 +0000</updated>
                            <resolved>Tue, 23 Feb 2016 08:22:39 +0000</resolved>
                                                    <fixVersion>1.0.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15141490" author="greghogan" created="Wed, 10 Feb 2016 19:26:14 +0000"  >&lt;p&gt;Here is the simple function I was using to isolate this case, and constraining available memory with -Xmx200m. What is the best way to force spilling in an automated test?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testBrokenOuterJoin() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; NUMBER_OF_ELEMENTS = 2 * 1000 * 1000;

		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();
		env.setParallelism(1);

		DataSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; ds1 = env
			.fromParallelCollection(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NumberSequenceIterator(0, NUMBER_OF_ELEMENTS - 1), &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.class);

		DataSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; ds2 = ds1
			.filter(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FilterFunction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;() {
				@Override
				&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; filter(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; value) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
					&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
				}
			});

		DataSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; joinDs = ds1
			.leftOuterJoin(ds2, JoinHint.REPARTITION_HASH_FIRST)
			.where(&lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;)
			.equalTo(&lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;)
			.with(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JoinFunction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;() {
				@Override
				&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; join(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; first, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; second) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
					&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (first == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) ? second : first;
				}
			});

&lt;span class=&quot;code-comment&quot;&gt;//		List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; result = joinDs
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//			.collect();
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//		Collections.sort(result);
&lt;/span&gt;
		&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; count = joinDs
			.count();

		assertEquals(NUMBER_OF_ELEMENTS, count);
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15141551" author="fhueske" created="Wed, 10 Feb 2016 19:59:16 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=greghogan&quot; class=&quot;user-hover&quot; rel=&quot;greghogan&quot;&gt;greghogan&lt;/a&gt;! This is obviously a serious issue with the build-side outer join.&lt;br/&gt;
The &lt;tt&gt;HashTableITCase&lt;/tt&gt; has a few tests that enforce spilling to disk by providing only little memory to the hash table. It should be easy to port your code in to that test class.&lt;/p&gt;

&lt;p&gt;This bug should be fixed for the upcoming 1.0.0 release. &lt;br/&gt;
Do you want to do it?&lt;/p&gt;</comment>
                            <comment id="15141681" author="greghogan" created="Wed, 10 Feb 2016 21:16:46 +0000"  >&lt;p&gt;Yes, I will look into this some more.&lt;/p&gt;</comment>
                            <comment id="15154506" author="fhueske" created="Fri, 19 Feb 2016 17:05:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=greghogan&quot; class=&quot;user-hover&quot; rel=&quot;greghogan&quot;&gt;greghogan&lt;/a&gt;, have you started to work on this issue?&lt;br/&gt;
We are trying to close the blocking issues for the 1.0 release.&lt;/p&gt;

&lt;p&gt;Thanks, Fabian&lt;/p&gt;</comment>
                            <comment id="15154512" author="greghogan" created="Fri, 19 Feb 2016 17:11:07 +0000"  >&lt;p&gt;Yes, I literally have my test passing as of 5 minutes ago and was working on tidying it up.&lt;/p&gt;</comment>
                            <comment id="15154530" author="fhueske" created="Fri, 19 Feb 2016 17:30:59 +0000"  >&lt;p&gt;Great, thanks a lot!&lt;/p&gt;</comment>
                            <comment id="15154905" author="greghogan" created="Fri, 19 Feb 2016 21:40:03 +0000"  >&lt;p&gt;Will submit the pull request when Travis has finished. There was an additional fix, discovered with the unit tests running under severe memory constraints, where &lt;tt&gt;processUnmatchedBuildIter&lt;/tt&gt; would cause a &lt;tt&gt;NullPointerException&lt;/tt&gt; when all partitions had spilled to disk. That simple fix is included as a hotfix.&lt;/p&gt;</comment>
                            <comment id="15156041" author="greghogan" created="Sun, 21 Feb 2016 14:40:55 +0000"  >&lt;p&gt;Pull request is &lt;a href=&quot;https://github.com/apache/flink/pull/1680&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Had to rename the pull request, looks like if there are multiple commits the default name is the branch name rather than the commit log.&lt;/p&gt;</comment>
                            <comment id="15157232" author="githubbot" created="Mon, 22 Feb 2016 16:27:40 +0000"  >&lt;p&gt;Github user hsaputra commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1680#issuecomment-187253798&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1680#issuecomment-187253798&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Could add description on how is the fix being done and proposed result. Thanks&lt;/p&gt;</comment>
                            <comment id="15157252" author="githubbot" created="Mon, 22 Feb 2016 16:42:29 +0000"  >&lt;p&gt;Github user greghogan commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1680#issuecomment-187258482&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1680#issuecomment-187258482&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Unprobed, spilled partitions are now retained when performing a build-side outer join (and still discarded in all other cases).&lt;/p&gt;

&lt;p&gt;    When these unprobed, spilled partitions are loaded by `MutableHashTable.prepareNextPartition` we simply create an iterator over the spilled segments which are read by the appropriate HashJoinIterator in a single loop.&lt;/p&gt;</comment>
                            <comment id="15158005" author="githubbot" created="Tue, 23 Feb 2016 00:20:15 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1680#issuecomment-187448014&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1680#issuecomment-187448014&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the fix! Will merge this.&lt;/p&gt;</comment>
                            <comment id="15158521" author="githubbot" created="Tue, 23 Feb 2016 08:17:40 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1680&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1680&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15158525" author="fhueske" created="Tue, 23 Feb 2016 08:22:39 +0000"  >&lt;p&gt;Fixed with 1c48e3462e9ea16615651fc1984e61d5426fa864&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2sonj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>