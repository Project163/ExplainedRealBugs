<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:55:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-22006] Could not run more than 20 jobs in a native K8s session when K8s HA enabled</title>
                <link>https://issues.apache.org/jira/browse/FLINK-22006</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently, if we start a native K8s session cluster when K8s HA enabled, we could not run more than 20 streaming jobs.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The latest job is always initializing, and the previous one is created and waiting to be assigned. It seems that some internal resources have been&#160;exhausted, e.g. okhttp thread pool , tcp connections or something else.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13023095/13023095_image-2021-03-24-18-08-42-116.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13368291">FLINK-22006</key>
            <summary>Could not run more than 20 jobs in a native K8s session when K8s HA enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wangyang0918">Yang Wang</assignee>
                                    <reporter username="wangyang0918">Yang Wang</reporter>
                        <labels>
                            <label>k8s-ha</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 29 Mar 2021 06:28:25 +0000</created>
                <updated>Fri, 28 May 2021 09:00:11 +0000</updated>
                            <resolved>Wed, 7 Apr 2021 16:45:12 +0000</resolved>
                                    <version>1.12.2</version>
                    <version>1.13.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                    <fixVersion>1.12.3</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17310546" author="yittg" created="Mon, 29 Mar 2021 10:09:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt; Did you reproduce the issue?  I think it&apos;s easy to reproduce.&lt;/p&gt;

&lt;p&gt;And i believe the problem is about the okhttp connectionPool. Fabric8 kubernetes client will create a separate webSocket connection for each config map watching. So after it exhausting all connections in the connection pool, new webSocket request can not be established. Then the new Job can not be submitted successfully.&lt;/p&gt;

&lt;p&gt;So my advice is creating a single config map watching and dispatching events for different usages if possible and if we still using the fabric8 kubernetes client.&lt;/p&gt;

&lt;p&gt;But before this, i would give more effort to provide more detail to prove it.&lt;/p&gt;</comment>
                            <comment id="17310619" author="fly_in_gis" created="Mon, 29 Mar 2021 12:02:43 +0000"  >&lt;p&gt;Yes, I could reproduce this issue. And I believe the root cause is fabric8 Kubernetes client has configured the &lt;tt&gt;MaxRequests&lt;/tt&gt; of &lt;tt&gt;OkHttpClient#Dispatcher&lt;/tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; to 64&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;, which means we could not create more than 64 watchers in the JobManager pod.&lt;/p&gt;

&lt;p&gt;Normally, it could be configured in Flink via &lt;tt&gt;-Denv.java.opts=&quot;-Dkubernetes.max.concurrent.requests=1000&quot;&lt;/tt&gt;. Unfortunately, the fabric8 Kubernetes client version 4.9.2 has a bug&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;, which causes the max concurrent requests could not be set via system properties.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The fabric8 Kubernetes client 4.10 has introduced too many changes and I do not suggest to bump the dependency in Flink now. Instead, I think we could try to set the max concurrent requests in &lt;tt&gt;DefaultKubeClientFactory#fromConfiguration&lt;/tt&gt; when building the Kubernetes client.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Your suggestion about using a single ConfigMap watch is somewhat reasonable. However, in current HA design, &lt;tt&gt;DefaultLeaderRetrievalService&lt;/tt&gt; is not aware of all the running jobs. So it is not very easy to dispatch different watcher events to corresponding listeners. It is a big change and we need more discussion.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/fabric8io/kubernetes-client/blob/master/kubernetes-client/src/main/java/io/fabric8/kubernetes/client/utils/HttpClientUtils.java#L166&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/fabric8io/kubernetes-client/blob/master/kubernetes-client/src/main/java/io/fabric8/kubernetes/client/utils/HttpClientUtils.java#L166&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/fabric8io/kubernetes-client/blob/master/kubernetes-client/src/main/java/io/fabric8/kubernetes/client/Config.java#L135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/fabric8io/kubernetes-client/blob/master/kubernetes-client/src/main/java/io/fabric8/kubernetes/client/Config.java#L135&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/fabric8io/kubernetes-client/issues/2531&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/fabric8io/kubernetes-client/issues/2531&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17310715" author="yittg" created="Mon, 29 Mar 2021 15:08:13 +0000"  >&lt;p&gt;Yeah, there are the two configurations is relative, maxRequests and maxRequestsPerHost. For webSocket, maxRequestsPerHost is ignored&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. So the actual effective configuration is maxRequests with default value 64.&lt;/p&gt;

&lt;p&gt;And here are two small PoCs running with the corresponding dependency versions, and you can only get at most 64 ADDED events or 64 open logs.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.example;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; io.fabric8.kubernetes.api.model.ConfigMap;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; io.fabric8.kubernetes.client.*;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;K {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
      Config config = Config.autoConfigure(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;//      config.setMaxConcurrentRequests(1000);
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//      config.setMaxConcurrentRequestsPerHost(1000);
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; NamespacedKubernetesClient client = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultKubernetesClient(config);

      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 100; i++) {
          client.configMaps().inNamespace(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;&quot;&lt;/span&gt;).withName(&lt;span class=&quot;code-quote&quot;&gt;&quot;abc-&quot;&lt;/span&gt; + i).watch(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Watcher&amp;lt;ConfigMap&amp;gt;() {
              @Override
              &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void eventReceived(Action action, ConfigMap configMap) {
                  &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(action + configMap.getMetadata().getName());
              }

              @Override
              &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onClose(KubernetesClientException e) {}
          });
      }
  }
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.example;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; okhttp3.*;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;T {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
    OkHttpClient client = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OkHttpClient();
    &lt;span class=&quot;code-comment&quot;&gt;//    client.dispatcher().setMaxRequests(1000);
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;//    client.dispatcher().setMaxRequestsPerHost(1000);
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 100; i++) {
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; tag = &lt;span class=&quot;code-quote&quot;&gt;&quot;open&quot;&lt;/span&gt; + i;
      client.newWebSocket(
          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Request.Builder().url(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:9999&quot;&lt;/span&gt;).build(),
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WebSocketListener() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onOpen(WebSocket webSocket, Response response) {
              &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.onOpen(webSocket, response);
              &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(tag);
            }
          });
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And i think it&apos;s ok to walk around this issue by setting a larger value for maxRequests temporarily.&lt;/p&gt;

&lt;p&gt;1. &lt;a href=&quot;https://github.com/square/okhttp/blob/parent-3.12.1/okhttp/src/main/java/okhttp3/Dispatcher.java#L196&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/square/okhttp/blob/parent-3.12.1/okhttp/src/main/java/okhttp3/Dispatcher.java#L196&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17311097" author="fly_in_gis" created="Tue, 30 Mar 2021 03:14:45 +0000"  >&lt;p&gt;Thanks for the confirmation. I will start to work on this by supporting to set max concurrent requests via java opts &lt;tt&gt;kubernetes.max.concurrent.requests&lt;/tt&gt; in &lt;tt&gt;DefaultKubeClientFactory&lt;/tt&gt;. After then users could configure this value bigger via &lt;tt&gt;-Denv.java.opts=&quot;-Dkubernetes.max.concurrent.requests=1000&quot;&lt;/tt&gt; in Flink.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the future when we bump the fabric8 Kubernetes client to new version(greater than 4.13.0), the parsing java opts logics in &lt;tt&gt;DefaultKubeClientFactory&lt;/tt&gt; could be removed. But it is also harmless to keep them.&lt;/p&gt;</comment>
                            <comment id="17311374" author="till.rohrmann" created="Tue, 30 Mar 2021 10:28:14 +0000"  >&lt;p&gt;+1 for the quick fix and for fixing this problem properly by using a shared ConfigMap watcher in the next release.&lt;/p&gt;

&lt;p&gt;Does the Fabric8 client supports to watch multiple ConfigMaps using a single connection? Hopefully, I would assume that the change from Flink&apos;s perspective is not too large. The &lt;tt&gt;DefaultLeaderRetrievalService&lt;/tt&gt; share the same &lt;tt&gt;FlinkKubeClient&lt;/tt&gt; which could run the single ConfigMap watcher if we can add new ConfigMaps to watch lazily.&lt;/p&gt;</comment>
                            <comment id="17311412" author="yittg" created="Tue, 30 Mar 2021 11:00:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; Roughly speaking, yes. I think we can just replace the implementation of watchConfigMap in Fabric8FlinkKubeClient.But there are still some details to consider.&lt;br/&gt;
I&apos;m trying to figure out a RIGHT implementation demo. If it&apos;s ok, I will create an improvement ticket for it. Then we can make it happen, &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17311451" author="fly_in_gis" created="Tue, 30 Mar 2021 11:46:45 +0000"  >&lt;p&gt;Yes,&#160;Fabric8 Kubernetes client supports to watch multiple ConfigMaps using a single connection. Actually, we are watching all the TaskManager pods in a same way.&lt;/p&gt;

&lt;p&gt;For the implementation, wrapping&#160;&lt;tt&gt;Fabric8FlinkKubeClient#watchConfigMaps&lt;/tt&gt;&#160;with a dispatcher and single connection is a good solution. Then the caller will not care about the implementation details and we do not need any changes to the &lt;tt&gt;DefaultLeaderRetrievalService&lt;/tt&gt; and &lt;tt&gt;KubernetesLeaderRetrievalDriver&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17311996" author="yittg" created="Wed, 31 Mar 2021 03:03:25 +0000"  >&lt;p&gt;The watching for configMap is a little different from that for pods. The watchings for configMap will start and go after the watching starts. I think we should do something to keep the same semantic with watching separately.&lt;/p&gt;

&lt;p&gt;Here &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22054&quot; title=&quot;Using a shared watcher for ConfigMap watching&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22054&quot;&gt;&lt;del&gt;FLINK-22054&lt;/del&gt;&lt;/a&gt; i create another issue to track the sharded ConfigMap watcher proposal.&lt;/p&gt;</comment>
                            <comment id="17313291" author="till.rohrmann" created="Thu, 1 Apr 2021 16:30:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt; do you think that you have time for fixing this issue for the 1.13.0 release?&lt;/p&gt;</comment>
                            <comment id="17313546" author="fly_in_gis" created="Fri, 2 Apr 2021 03:47:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;I will attach a PR for this ticket today.&lt;/p&gt;</comment>
                            <comment id="17316483" author="till.rohrmann" created="Wed, 7 Apr 2021 16:45:12 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;master:&lt;br/&gt;
ec677a188e9239ca80a723206dbbd807789731e7&lt;br/&gt;
0eed15de872768cd2ec4a7a3384e49f7bbaeb483&lt;/p&gt;

&lt;p&gt;1.12.3.:&lt;br/&gt;
aef2392a591edc63b2c1734044cc1a43628a43b1&lt;br/&gt;
4ea99332e1997eebca1f3f0a9d9229b8265fe32c&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13368636">FLINK-22047</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13367137">FLINK-21942</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13368761">FLINK-22054</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13023095" name="image-2021-03-24-18-08-42-116.png" size="371566" author="wangyang0918" created="Mon, 29 Mar 2021 06:28:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 31 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0pb94:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>