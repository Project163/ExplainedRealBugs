<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:55:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21008] Residual HA related Kubernetes ConfigMaps and ZooKeeper nodes when cluster entrypoint received SIGTERM in shutdown</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21008</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Recently, in our internal use case for native K8s integration with K8s HA enabled, we found that the leader related ConfigMaps could be&#160;residual in some corner situations.&lt;/p&gt;

&lt;p&gt;After some investigations, I think it is possibly caused by the inappropriate shutdown process.&lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;ClusterEntrypoint#shutDownAsync&lt;/tt&gt;, we first call the&#160;&lt;tt&gt;closeClusterComponent&lt;/tt&gt;, which also includes deregistering the Flink application from cluster management(e.g. Yarn, K8s). Then we call the &lt;tt&gt;stopClusterServices&lt;/tt&gt; and &lt;tt&gt;cleanupDirectories&lt;/tt&gt;. Imagine that the cluster management do the deregister very fast, the JobManager process receives SIGNAL 15 before or is being executing the&#160;&lt;tt&gt;stopClusterServices&lt;/tt&gt; and &lt;tt&gt;cleanupDirectories&lt;/tt&gt;. The jvm process will directly exit then. So the two methods may not be executed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13353039">FLINK-21008</key>
            <summary>Residual HA related Kubernetes ConfigMaps and ZooKeeper nodes when cluster entrypoint received SIGTERM in shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wangyang0918">Yang Wang</assignee>
                                    <reporter username="wangyang0918">Yang Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 18 Jan 2021 09:49:45 +0000</created>
                <updated>Wed, 20 Apr 2022 10:21:19 +0000</updated>
                            <resolved>Fri, 9 Apr 2021 10:15:18 +0000</resolved>
                                    <version>1.11.3</version>
                    <version>1.12.1</version>
                    <version>1.13.0</version>
                                    <fixVersion>1.11.4</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                    <fixVersion>1.12.3</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17267793" author="till.rohrmann" created="Tue, 19 Jan 2021 09:58:45 +0000"  >&lt;p&gt;Is the problem that deregistering the application from K8s will trigger K8s to send a SIGTERM to the JobManager process? I guess then this behaves a bit differently from Yarn and needs to be changed. Is there a way to let the process properly terminate but still deleting the K8s resource (e.g. deployment)? Maybe we need to register a shutdown hook which waits on the &lt;tt&gt;ClusterEntrypoint&lt;/tt&gt; to have completed its shutdown.&lt;/p&gt;</comment>
                            <comment id="17267804" author="fly_in_gis" created="Tue, 19 Jan 2021 10:19:35 +0000"  >&lt;p&gt;You are right. Deregistering the application from K8s(aka delete the JobManager deployment) will let the kubelet send a&#160;SIGTERM to JobManager process. But the Yarn has the same behavior. The reason why we do not come into this issue when deploying Flink application on Yarn is that the&#160;SIGTERM is sent a little late. Because Yarn ResourceManager tells NodeManager to kill(SIGTERM and followed by a SIGKILL) the JobManager via heartbeat, which is 3 seconds by default. However, on Kubernetes, kubelet is informed via watcher, which is no delay.&lt;/p&gt;

&lt;p&gt;Assume that the cluster entrypoint costs more than 3 seconds for the internal clean up( &lt;tt&gt;stopClusterServices&lt;/tt&gt;&#160;and &lt;tt&gt;cleanupDirectories&lt;/tt&gt;), we will run into the same situation on Yarn deployment.&lt;/p&gt;</comment>
                            <comment id="17267821" author="till.rohrmann" created="Tue, 19 Jan 2021 10:41:55 +0000"  >&lt;p&gt;I see, then an alternative solution would be to signal the external system to shut down after the whole Flink clean up has been done. The problem here is that the communication logic with the external client is encapsulated in the &lt;tt&gt;ResourceManager&lt;/tt&gt; which at this point is already shut down.&lt;/p&gt;</comment>
                            <comment id="17267825" author="fly_in_gis" created="Tue, 19 Jan 2021 10:56:36 +0000"  >&lt;p&gt;Actually, maybe we do not need to respond to the&#160;SIGTERM in Yarn/K8s deployment since the cluster entrypoint will call the &lt;tt&gt;System.exit()&lt;/tt&gt; eventually.&lt;/p&gt;</comment>
                            <comment id="17267854" author="till.rohrmann" created="Tue, 19 Jan 2021 12:16:08 +0000"  >&lt;p&gt;Is it possible to ignore the SIGTERM signal in the JVM?&lt;/p&gt;</comment>
                            <comment id="17267983" author="fly_in_gis" created="Tue, 19 Jan 2021 15:50:08 +0000"  >&lt;p&gt;We could implement an empty &lt;tt&gt;SignalHandler&lt;/tt&gt;. And then register it in the &lt;tt&gt;KubernetesApplicationClusterEntrypoint&lt;/tt&gt; and &lt;tt&gt;KubernetesSessionClusterEntrypoint&lt;/tt&gt;. For Yarn related entrypoint, we could also have this done.&lt;/p&gt;</comment>
                            <comment id="17268028" author="till.rohrmann" created="Tue, 19 Jan 2021 16:42:07 +0000"  >&lt;p&gt;I think I would be in favour of triggering a &lt;tt&gt;ClusterEntrypoint.closeAsync()&lt;/tt&gt; if we see a SIGTERM and then wait on the completion. That way, we also cover the case properly when someone sends us SIGTERM and the system wasn&apos;t shutting down. What do you think?&lt;/p&gt;</comment>
                            <comment id="17268349" author="fly_in_gis" created="Wed, 20 Jan 2021 03:25:26 +0000"  >&lt;p&gt;Triggering &lt;tt&gt;ClusterEntrypoint.closeAsync()&lt;/tt&gt; for the SIGTERM is a better solution. Since ignoring the SIGTERM could cause other issues. For example, deleting a pod gracefully is&#160;impossible now.&lt;/p&gt;</comment>
                            <comment id="17268453" author="till.rohrmann" created="Wed, 20 Jan 2021 08:57:43 +0000"  >&lt;p&gt;Do you wanna try to take a stab at the problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17268502" author="fly_in_gis" created="Wed, 20 Jan 2021 10:41:09 +0000"  >&lt;p&gt;Yes. I will try to get this done by letting &lt;tt&gt;SignalHandler&lt;/tt&gt; could trigger the &lt;tt&gt;ClusterEntrypoint.closeAsync()&lt;/tt&gt; for SIGTERM.&lt;/p&gt;</comment>
                            <comment id="17270224" author="fly_in_gis" created="Fri, 22 Jan 2021 15:39:15 +0000"  >&lt;p&gt;After more consideration, I think it might be wrong to do the &lt;tt&gt;ClusterEntrypoint.closeAsync()&lt;/tt&gt; when retrieved the SIGTERM. Imagine that the JobManager entrypoint is running normally, we send a SIGTERM and then the HA related data will be cleaned up. It is not right.&lt;/p&gt;

&lt;p&gt;Only when we are calling the &lt;tt&gt;shutDownAsync&lt;/tt&gt; with &lt;tt&gt;cleanupHaData = true&lt;/tt&gt;, but SIGTERM received before &lt;tt&gt;haServices.closeAndCleanupAllData()&lt;/tt&gt; is executed. In such situation, we will have residual HA related ConfigMaps and ZooKeeper Nodes.&lt;/p&gt;

&lt;p&gt;So maybe using a shutdown hook to do the &lt;tt&gt;haServices.closeAndCleanupAllData()&lt;/tt&gt; could solve the problem. And whether &lt;tt&gt;ClusterEntrypoint#shutDownAsync&lt;/tt&gt; is fully executed or not does not matter.&lt;/p&gt;</comment>
                            <comment id="17270260" author="till.rohrmann" created="Fri, 22 Jan 2021 16:32:05 +0000"  >&lt;p&gt;Wouldn&apos;t it work if &lt;tt&gt;ClusterEntrypoint.closeAsync()&lt;/tt&gt; calls &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
shutDownAsync(
                        ApplicationStatus.UNKNOWN,
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;Cluster entrypoint has been closed externally.&quot;&lt;/span&gt;,
                        &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;meaning that a SIGTERM won&apos;t clean up the HA data. Now if the cluster entrypoint wants to shut down (e.g. because the job of the per-job cluster has finished), it will call &lt;tt&gt;shutDownAsync(.., .., true)&lt;/tt&gt; which will clean up the HA data.&lt;/p&gt;</comment>
                            <comment id="17271167" author="fly_in_gis" created="Mon, 25 Jan 2021 08:46:24 +0000"  >&lt;p&gt;This residual issue could be resolved if &lt;tt&gt;ClusterEntrypoint.closeAsync()&lt;/tt&gt;&#160;is executed with &lt;tt&gt;cleanupHaData = false&lt;/tt&gt;. I also think it is the right behavior. &quot;closed externally&quot; should not clean up the HA related data.&lt;/p&gt;

&lt;p&gt;Moreover, &lt;tt&gt;ClusterEntrypoint.shutDownAsync&lt;/tt&gt; will be guarded by &lt;tt&gt;lock&lt;/tt&gt; to guarantee that it is fully executed when received SIGTERM.&lt;/p&gt;</comment>
                            <comment id="17307082" author="till.rohrmann" created="Tue, 23 Mar 2021 13:52:56 +0000"  >&lt;p&gt;If we don&apos;t manage to complete this ticket for &lt;tt&gt;1.13.0&lt;/tt&gt; then it will be bumped to the next release.&lt;/p&gt;</comment>
                            <comment id="17309444" author="till.rohrmann" created="Fri, 26 Mar 2021 13:58:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt; do you think that we can fix this problem for the &lt;tt&gt;1.13.0&lt;/tt&gt; release?&lt;/p&gt;</comment>
                            <comment id="17309979" author="fly_in_gis" created="Sat, 27 Mar 2021 15:57:30 +0000"  >&lt;p&gt;Thanks for the reminding. I will try to provide a PR before next Monday.&lt;/p&gt;</comment>
                            <comment id="17317848" author="till.rohrmann" created="Fri, 9 Apr 2021 10:15:18 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;master: e2943006aec1febcfd1c33eef1b1f44367019a98&lt;br/&gt;
1.12.3: f541f9da2ccb7c07bc349fe32c8c8ded75cac4aa&lt;br/&gt;
1.11.4: 35babaf865550f0bfdcca0c5823559cccdb5140d&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13434865">FLINK-26772</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 31 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0mpz4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>