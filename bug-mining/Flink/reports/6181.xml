<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:08:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-25199] StreamEdges are not unique in self-union, which blocks propagation of watermarks</title>
                <link>https://issues.apache.org/jira/browse/FLINK-25199</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;It seems &lt;tt&gt;fromValues&lt;/tt&gt; that generates multiple rows does not emit any watermarks:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        StreamTableEnvironment tEnv = StreamTableEnvironment.create(env);

        Table inputTable =
                tEnv.fromValues(
                        DataTypes.ROW(
                                DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;weight&quot;&lt;/span&gt;, DataTypes.DOUBLE()),
                                DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;f0&quot;&lt;/span&gt;, DataTypes.STRING()),
                                DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;f1&quot;&lt;/span&gt;, DataTypes.DOUBLE()),
                                DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;f2&quot;&lt;/span&gt;, DataTypes.DOUBLE()),
                                DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;f3&quot;&lt;/span&gt;, DataTypes.DOUBLE()),
                                DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;f4&quot;&lt;/span&gt;, DataTypes.INT()),
                                DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;label&quot;&lt;/span&gt;, DataTypes.STRING())),
                        Row.of(1., &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, 1., 1., 1., 2, &lt;span class=&quot;code-quote&quot;&gt;&quot;l1&quot;&lt;/span&gt;),
                        Row.of(1., &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, 1., 1., 1., 2, &lt;span class=&quot;code-quote&quot;&gt;&quot;l1&quot;&lt;/span&gt;));

        DataStream&amp;lt;Row&amp;gt; input = tEnv.toDataStream(inputTable);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;fromValues(1, 2, 3)&lt;/tt&gt; or &lt;tt&gt;fromValues&lt;/tt&gt; with only 1 row works correctly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13415639">FLINK-25199</key>
            <summary>StreamEdges are not unique in self-union, which blocks propagation of watermarks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="twalthr">Timo Walther</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 6 Dec 2021 17:07:44 +0000</created>
                <updated>Mon, 7 Feb 2022 10:30:39 +0000</updated>
                            <resolved>Fri, 21 Jan 2022 15:12:53 +0000</resolved>
                                    <version>1.12.7</version>
                    <version>1.13.5</version>
                    <version>1.14.3</version>
                                    <fixVersion>1.13.6</fixVersion>
                    <fixVersion>1.14.4</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17459042" author="matriv" created="Tue, 14 Dec 2021 10:26:12 +0000"  >&lt;p&gt;This issue is not Table/SQL related but originates from self &lt;b&gt;union&lt;/b&gt;ing a datastream, so one can reproduce it with:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
DataStream&amp;lt;Integer&amp;gt; dataStream1 = env.fromElements(1, 2, 3).setParallelism(1);

// add a printout statement to print the emitted watermark
dataStream1.union(dataStream1).print();
// or  use .addSink(new DiscardingSink&amp;lt;&amp;gt;()); and debug to check that the writeWatermark() on the DiscardingSink is not called
env.execute();&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If instead of the &quot;self&quot; union we union 2 separate datastreams like:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DataStream&amp;lt;Integer&amp;gt; dataStream1 = env.fromElements(1, 2, 3).setParallelism(1);
DataStream&amp;lt;Integer&amp;gt; dataStream2 = dataStream1.map(i -&amp;gt; i + 1).setParallelism(1);

dataStream1.union(dataStream1).print(); //addSink(new DiscardingSink&amp;lt;&amp;gt;());
env.execute();&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then the watermark is emitted correctly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;From some debugging in&#160;&lt;b&gt;StatusWatermarkValve#findAndOutputNewMinWatermarkAcrossAlignedChannels&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The following is false:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (hasAlignedChannels &amp;amp;&amp;amp; newMinWatermark &amp;gt; lastOutputWatermark) {
    lastOutputWatermark = newMinWatermark;
    output.emitWatermark(new Watermark(lastOutputWatermark));
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Because there are 2 channels involved and in the for loop above that code ^^:&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;for (InputChannelStatus channelStatus : channelStatuses) {
    if (channelStatus.isWatermarkAligned) {
        hasAlignedChannels = true;
        newMinWatermark = Math.min(channelStatus.watermark, newMinWatermark);
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;One of the channels is updated with the watermark set to &lt;b&gt;Long.MAX_VALUE&lt;/b&gt; but the other channel still has the initial value of&#160;&lt;b&gt;Long.MIN_VALUE&lt;/b&gt; so the total &lt;b&gt;Math.min&lt;/b&gt;&#160;gives out&#160;&lt;b&gt;Long.MIN_VALUE.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That&apos;s because the &#160;&lt;b&gt;StatusWatermarkValve#&lt;/b&gt;&lt;b&gt;inputWatermark&lt;/b&gt;&#160;which updates the channel&apos;s watermark in line&#160;&lt;b&gt;95&lt;/b&gt; is always called from &lt;b&gt;AbstractStreamTaskNetworkInput#processElement&lt;/b&gt; with&lt;/p&gt;

&lt;p&gt;the same&#160;&lt;b&gt;lastChannel&lt;/b&gt; which is just one of the 2 channels used in this union case.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17479244" author="pnowojski" created="Thu, 20 Jan 2022 10:31:16 +0000"  >&lt;p&gt;The problem was quite strange. If there was a node that was self-unioned with itself, it was creating a situation with two identical StreamEdges. Both with the same partitioning, from the same source node to the same target node. &lt;/p&gt;

&lt;p&gt;This was causing issues when constructing output collectors and picking the correct RecordWriters, as StreamTask was not able to uniquely identify given StreamEdge and was assigning the same RecordWriter to both of the edges. As a result all stream elements&lt;br/&gt;
were sent twice through the same RecordWriter. It was actually pretty harmless apart of calculating the combined watermark downstream, since all watermarks were always comming just from one single edge/inputgate, and the unused edges were always stuck with min watermark.&lt;/p&gt;

&lt;p&gt;As a solution we are making sure that StreamEdges are unique by introducing a uniqueId field, incremented for every pair of StreamEdges connecting the same node.&lt;/p&gt;</comment>
                            <comment id="17480129" author="pnowojski" created="Fri, 21 Jan 2022 15:12:53 +0000"  >&lt;p&gt;merged commit 5192fd7 into apache:master&lt;br/&gt;
444641c9d3 to release-1.14&lt;br/&gt;
9c1bf6cdb3 to release-1.13&lt;/p&gt;</comment>
                            <comment id="17488012" author="twalthr" created="Mon, 7 Feb 2022 10:30:39 +0000"  >&lt;p&gt;Tests on the Table API end in master: b795dd55d449edba5670dc0c1010666f9d97bf02&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 40 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0xea8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>