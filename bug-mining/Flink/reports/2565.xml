<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9994] IntervalJoinOperator#Context#getTimestamp does not return the Max timestamp.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9994</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description></description>
                <environment></environment>
        <key id="13175391">FLINK-9994</key>
            <summary>IntervalJoinOperator#Context#getTimestamp does not return the Max timestamp.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkl0u">Kostas Kloudas</assignee>
                                    <reporter username="kkl0u">Kostas Kloudas</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 29 Jul 2018 11:43:01 +0000</created>
                <updated>Sun, 29 Jul 2018 18:55:15 +0000</updated>
                            <resolved>Sun, 29 Jul 2018 18:55:15 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.6.0</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16561091" author="githubbot" created="Sun, 29 Jul 2018 12:05:26 +0000"  >&lt;p&gt;kl0u opened a new pull request #6449: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9994&quot; title=&quot;IntervalJoinOperator#Context#getTimestamp does not return the Max timestamp.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9994&quot;&gt;&lt;del&gt;FLINK-9994&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream API&amp;#93;&lt;/span&gt; IntervalJoinOp Context#getTimestamp() returns max timestamp.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6449&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Although the `Context.getTimestamp()` in the `IntervalJoinOperator` should return the max timestamp between the elements in the joined pair, it currently returns the one of the &quot;left&quot; element. &lt;/p&gt;

&lt;p&gt;   This is a remain from past versions of the code, as the timestamp of the collector is correctly updated to the max timestamp between the ones in the matched pair.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   The main change is in the `collect(T1 left, T2 right, long leftTimestamp, long rightTimestamp)` of the `InternalJoinOperator`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   The tests that were testing this behavior were wrong and they are now fixed.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16561226" author="githubbot" created="Sun, 29 Jul 2018 18:41:30 +0000"  >&lt;p&gt;asfgit closed pull request #6449: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9994&quot; title=&quot;IntervalJoinOperator#Context#getTimestamp does not return the Max timestamp.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9994&quot;&gt;&lt;del&gt;FLINK-9994&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream API&amp;#93;&lt;/span&gt; IntervalJoinOp Context#getTimestamp() returns max timestamp.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6449&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/co/IntervalJoinOperator.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/co/IntervalJoinOperator.java&lt;br/&gt;
index 0c449e64f41..43085cb42c4 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/co/IntervalJoinOperator.java&lt;br/&gt;
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/co/IntervalJoinOperator.java&lt;br/&gt;
@@ -152,6 +152,7 @@ public IntervalJoinOperator(&lt;br/&gt;
 	@Override&lt;br/&gt;
 	public void open() throws Exception {&lt;br/&gt;
 		super.open();&lt;br/&gt;
+&lt;br/&gt;
 		collector = new TimestampedCollector&amp;lt;&amp;gt;(output);&lt;br/&gt;
 		context = new ContextImpl(userFunction);&lt;br/&gt;
 		internalTimerService =&lt;br/&gt;
@@ -204,15 +205,15 @@ public void processElement2(StreamRecord&amp;lt;T2&amp;gt; record) throws Exception {&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt; 	@SuppressWarnings(&quot;unchecked&quot;)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private &amp;lt;OUR, OTHER&amp;gt; void processElement(&lt;/li&gt;
	&lt;li&gt;StreamRecord&amp;lt;OUR&amp;gt; record,&lt;/li&gt;
	&lt;li&gt;MapState&amp;lt;Long, List&amp;lt;BufferEntry&amp;lt;OUR&amp;gt;&amp;gt;&amp;gt; ourBuffer,&lt;/li&gt;
	&lt;li&gt;MapState&amp;lt;Long, List&amp;lt;BufferEntry&amp;lt;OTHER&amp;gt;&amp;gt;&amp;gt; otherBuffer,&lt;/li&gt;
	&lt;li&gt;long relativeLowerBound,&lt;/li&gt;
	&lt;li&gt;long relativeUpperBound,&lt;/li&gt;
	&lt;li&gt;boolean isLeft) throws Exception {&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;final OUR ourValue = record.getValue();&lt;br/&gt;
+	private &amp;lt;THIS, OTHER&amp;gt; void processElement(&lt;br/&gt;
+			final StreamRecord&amp;lt;THIS&amp;gt; record,&lt;br/&gt;
+			final MapState&amp;lt;Long, List&amp;lt;IntervalJoinOperator.BufferEntry&amp;lt;THIS&amp;gt;&amp;gt;&amp;gt; ourBuffer,&lt;br/&gt;
+			final MapState&amp;lt;Long, List&amp;lt;IntervalJoinOperator.BufferEntry&amp;lt;OTHER&amp;gt;&amp;gt;&amp;gt; otherBuffer,&lt;br/&gt;
+			final long relativeLowerBound,&lt;br/&gt;
+			final long relativeUpperBound,&lt;br/&gt;
+			final boolean isLeft) throws Exception {&lt;br/&gt;
+&lt;br/&gt;
+		final THIS ourValue = record.getValue();&lt;br/&gt;
 		final long ourTimestamp = record.getTimestamp();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		if (ourTimestamp == Long.MIN_VALUE) {&lt;br/&gt;
@@ -257,14 +258,18 @@ private boolean isLate(long timestamp) {&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt; 	private void collect(T1 left, T2 right, long leftTimestamp, long rightTimestamp) throws Exception &lt;/p&gt;
{
-		long resultTimestamp = Math.max(leftTimestamp, rightTimestamp);
+		final long resultTimestamp = Math.max(leftTimestamp, rightTimestamp);
+
 		collector.setAbsoluteTimestamp(resultTimestamp);
-		context.leftTimestamp = leftTimestamp;
-		context.rightTimestamp = rightTimestamp;
+		context.updateTimestamps(leftTimestamp, rightTimestamp, resultTimestamp);
+
 		userFunction.processElement(left, right, context, collector);
 	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private &amp;lt;T&amp;gt; void addToBuffer(MapState&amp;lt;Long, List&amp;lt;BufferEntry&amp;lt;T&amp;gt;&amp;gt;&amp;gt; buffer, T value, long timestamp) throws Exception {&lt;br/&gt;
+	private static &amp;lt;T&amp;gt; void addToBuffer(&lt;br/&gt;
+			final MapState&amp;lt;Long, List&amp;lt;IntervalJoinOperator.BufferEntry&amp;lt;T&amp;gt;&amp;gt;&amp;gt; buffer,&lt;br/&gt;
+			final T value,&lt;br/&gt;
+			final long timestamp) throws Exception {&lt;br/&gt;
 		List&amp;lt;BufferEntry&amp;lt;T&amp;gt;&amp;gt; elemsInBucket = buffer.get(timestamp);&lt;br/&gt;
 		if (elemsInBucket == null) {&lt;br/&gt;
 			elemsInBucket = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
@@ -313,6 +318,8 @@ public void onProcessingTime(InternalTimer&amp;lt;K, String&amp;gt; timer) throws Exception {&lt;br/&gt;
 	 */&lt;br/&gt;
 	private final class ContextImpl extends ProcessJoinFunction&amp;lt;T1, T2, OUT&amp;gt;.Context {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+		private long resultTimestamp = Long.MIN_VALUE;&lt;br/&gt;
+&lt;br/&gt;
 		private long leftTimestamp = Long.MIN_VALUE;&lt;/p&gt;

&lt;p&gt; 		private long rightTimestamp = Long.MIN_VALUE;&lt;br/&gt;
@@ -321,6 +328,12 @@ private ContextImpl(ProcessJoinFunction&amp;lt;T1, T2, OUT&amp;gt; func) &lt;/p&gt;
{
 			func.super();
 		}

&lt;p&gt;+		private void updateTimestamps(long left, long right, long result) &lt;/p&gt;
{
+			this.leftTimestamp = left;
+			this.rightTimestamp = right;
+			this.resultTimestamp = result;
+		}
&lt;p&gt;+&lt;br/&gt;
 		@Override&lt;br/&gt;
 		public long getLeftTimestamp() {&lt;br/&gt;
 			return leftTimestamp;&lt;br/&gt;
@@ -333,7 +346,7 @@ public long getRightTimestamp() {&lt;/p&gt;

&lt;p&gt; 		@Override&lt;br/&gt;
 		public long getTimestamp() &lt;/p&gt;
{
-			return leftTimestamp;
+			return resultTimestamp;
 		}

&lt;p&gt; 		@Override&lt;br/&gt;
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/operators/co/IntervalJoinOperatorTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/operators/co/IntervalJoinOperatorTest.java&lt;br/&gt;
index ee3f4d8fc12..53f514b98da 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/operators/co/IntervalJoinOperatorTest.java&lt;br/&gt;
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/operators/co/IntervalJoinOperatorTest.java&lt;br/&gt;
@@ -481,13 +481,16 @@ public void testReturnsCorrectTimestamp() throws Exception {&lt;br/&gt;
 				TestElem.serializer(),&lt;br/&gt;
 				TestElem.serializer(),&lt;br/&gt;
 				new ProcessJoinFunction&amp;lt;TestElem, TestElem, Tuple2&amp;lt;TestElem, TestElem&amp;gt;&amp;gt;() {&lt;br/&gt;
+&lt;br/&gt;
+					private static final long serialVersionUID = 1L;&lt;br/&gt;
+&lt;br/&gt;
 					@Override&lt;br/&gt;
 					public void processElement(&lt;br/&gt;
 						TestElem left,&lt;br/&gt;
 						TestElem right,&lt;br/&gt;
 						Context ctx,&lt;br/&gt;
 						Collector&amp;lt;Tuple2&amp;lt;TestElem, TestElem&amp;gt;&amp;gt; out) throws Exception &lt;/p&gt;
{
-						Assert.assertEquals(left.ts, ctx.getTimestamp());
+						Assert.assertEquals(Math.max(left.ts, right.ts), ctx.getTimestamp());
 					}
&lt;p&gt; 				}&lt;br/&gt;
 			);&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16561233" author="kkl0u" created="Sun, 29 Jul 2018 18:55:15 +0000"  >&lt;p&gt;Merged on master with&#160;dc780303e1e4420033949049e4d9368a6d230d88&lt;/p&gt;

&lt;p&gt;and on release-1.6 with&#160;850983ec3a869f158cc900b9de6435e47779e3f9&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 16 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wg1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>