<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:42:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-15421] GroupAggsHandler throws java.time.LocalDateTime cannot be cast to java.sql.Timestamp</title>
                <link>https://issues.apache.org/jira/browse/FLINK-15421</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;`TimestmapType` has two types of physical representation: `Timestamp` and `LocalDateTime`. When we use following SQL, it will conflict each other:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SELECT 
  SUM(cnt) as s, 
  MAX(ts)
FROM 
  SELECT 
    `string`,
    `&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;`,
    COUNT(*) AS cnt,
    MAX(rowtime) as ts
  FROM T1
  GROUP BY `string`, `&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;`, TUMBLE(rowtime, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;10&apos;&lt;/span&gt; SECOND)
GROUP BY `string`
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with &apos;table.exec.emit.early-fire.enabled&apos; = true.&lt;/p&gt;

&lt;p&gt;The exceptions is below:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Caused by: java.lang.ClassCastException: java.time.LocalDateTime cannot be cast to java.sql.Timestamp&lt;br/&gt;
 at GroupAggsHandler$83.getValue(GroupAggsHandler$83.java:529)&lt;br/&gt;
 at org.apache.flink.table.runtime.operators.aggregate.GroupAggFunction.processElement(GroupAggFunction.java:164)&lt;br/&gt;
 at org.apache.flink.table.runtime.operators.aggregate.GroupAggFunction.processElement(GroupAggFunction.java:43)&lt;br/&gt;
 at org.apache.flink.streaming.api.operators.KeyedProcessOperator.processElement(KeyedProcessOperator.java:85)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.tasks.OneInputStreamTask$StreamTaskNetworkOutput.emitRecord(OneInputStreamTask.java:173)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.io.StreamTaskNetworkInput.processElement(StreamTaskNetworkInput.java:151)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.io.StreamTaskNetworkInput.emitNext(StreamTaskNetworkInput.java:128)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:69)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:311)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:187)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:488)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:470)&lt;br/&gt;
 at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:702)&lt;br/&gt;
 at org.apache.flink.runtime.taskmanager.Task.run(Task.java:527)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I also create a UT to quickly reproduce this bug in `WindowAggregateITCase`:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
def testEarlyFireWithTumblingWindow(): Unit = {
  val stream = failingDataSource(data)
    .assignTimestampsAndWatermarks(
      &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TimestampAndWatermarkWithOffset
        [(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, Int, &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Float&lt;/span&gt;, BigDecimal, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)](10L))
  val table = stream.toTable(tEnv,
    &lt;span class=&quot;code-quote&quot;&gt;&apos;rowtime.rowtime, &apos;&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;, &apos;&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;bigdec, &apos;&lt;/span&gt;string, &apos;name)
  tEnv.registerTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;T1&quot;&lt;/span&gt;, table)
  tEnv.getConfig.getConfiguration.setBoolean(&lt;span class=&quot;code-quote&quot;&gt;&quot;table.exec.emit.early-fire.enabled&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
  tEnv.getConfig.getConfiguration.setString(&lt;span class=&quot;code-quote&quot;&gt;&quot;table.exec.emit.early-fire.delay&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1000 ms&quot;&lt;/span&gt;)

  val sql =
    &quot;&quot;&quot;
      |SELECT
      |  SUM(cnt) as s,
      |  MAX(ts)
      |FROM
      |  (SELECT
      |    `string`,
      |    `&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;`,
      |    COUNT(*) AS cnt,
      |    MAX(rowtime) as ts
      |  FROM T1
      |  GROUP BY `string`, `&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;`, TUMBLE(rowtime, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;10&apos;&lt;/span&gt; SECOND))
      |GROUP BY `string`
      |&quot;&quot;&quot;.stripMargin

  tEnv.sqlQuery(sql).toRetractStream[Row].print()
  env.execute()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13276559">FLINK-15421</key>
            <summary>GroupAggsHandler throws java.time.LocalDateTime cannot be cast to java.sql.Timestamp</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="docete">Zhenghua Gao</assignee>
                                    <reporter username="libenchao">Benchao Li</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 27 Dec 2019 07:41:27 +0000</created>
                <updated>Tue, 31 Dec 2019 06:29:19 +0000</updated>
                            <resolved>Tue, 31 Dec 2019 06:29:19 +0000</resolved>
                                    <version>1.9.1</version>
                    <version>1.10.0</version>
                                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17003951" author="lzljs3620320" created="Fri, 27 Dec 2019 07:45:51 +0000"  >&lt;p&gt;CC: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=docete&quot; class=&quot;user-hover&quot; rel=&quot;docete&quot;&gt;docete&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17003973" author="lzljs3620320" created="Fri, 27 Dec 2019 07:51:48 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=libenchao&quot; class=&quot;user-hover&quot; rel=&quot;libenchao&quot;&gt;libenchao&lt;/a&gt;&#160;for reporting. Can you format the code in description?&lt;/p&gt;</comment>
                            <comment id="17003974" author="libenchao" created="Fri, 27 Dec 2019 07:53:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; Sorry about the format of the code. Could you tell me how to write a code block correctly in issue description ?&lt;/p&gt;</comment>
                            <comment id="17003977" author="lzljs3620320" created="Fri, 27 Dec 2019 08:02:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=libenchao&quot; class=&quot;user-hover&quot; rel=&quot;libenchao&quot;&gt;libenchao&lt;/a&gt;&#160;Maybe you can try + in the upper right corner and create code block.&lt;/p&gt;</comment>
                            <comment id="17005101" author="docete" created="Mon, 30 Dec 2019 02:50:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;&#160;I&#160;investigate this case and find the cause:&#160;&lt;/p&gt;

&lt;p&gt;1) the inner MAX(rowtime) would translate to&#160;&lt;b&gt;TimestampMaxAggFunction&lt;/b&gt; and returns `DataTypes.TIMESTAMP(3)` which by default bridged to java.time.LocalDateTime&lt;/p&gt;

&lt;p&gt;2) the outer MAX(ts) would translate to&#160;&lt;b&gt;TimestampMaxWithRetractAggFunction&lt;/b&gt;&#160;since the two-level GROUP BY, and assumes the input objects are java.sql.Timestamp&lt;/p&gt;

&lt;p&gt;Then&#160;exceptions above are thrown. We can hotfix it by change the value type of&#160;&lt;b&gt;TimestampMaxWithRetractAggFunction&lt;/b&gt;&#160;to java.time.LocalDateTime, since we have make the default conversion of TimestampType as java.time.LocalDateTime.&#160;&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="17005108" author="lzljs3620320" created="Mon, 30 Dec 2019 03:12:52 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=docete&quot; class=&quot;user-hover&quot; rel=&quot;docete&quot;&gt;docete&lt;/a&gt;, make sense, we can just return &quot;Types.LOCAL_DATE_TIME&quot;.&lt;/p&gt;</comment>
                            <comment id="17005109" author="lzljs3620320" created="Mon, 30 Dec 2019 03:13:48 +0000"  >&lt;p&gt;NOTE: &quot;MinWithRetractAggFunction&quot; need modify too.&lt;/p&gt;</comment>
                            <comment id="17005137" author="jark" created="Mon, 30 Dec 2019 05:49:32 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=docete&quot; class=&quot;user-hover&quot; rel=&quot;docete&quot;&gt;docete&lt;/a&gt;, I&apos;m sorry, I don&apos;t think so. &lt;/p&gt;

&lt;p&gt;IMO, it is a bug of agg code generation, not a user side problem. &lt;br/&gt;
I looked the implementation of TimestampMaxWithRetractAggFunction, the definition is totally right: declare the result &lt;br/&gt;
value type and input type are both &lt;tt&gt;Timestamp&lt;/tt&gt;. Actually, there are many user-defined aggregates are the same.&lt;br/&gt;
I even think it is a backward compatible problem.&lt;/p&gt;</comment>
                            <comment id="17005156" author="lzljs3620320" created="Mon, 30 Dec 2019 06:41:17 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;, Thanks for your reminding. After taking a deep look to aggregate code generation, it is a limitation of blink planner. But I don&apos;t think it could be a backward compatible bug or planner bug. It should be fixed in max aggregate function.&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=docete&quot; class=&quot;user-hover&quot; rel=&quot;docete&quot;&gt;docete&lt;/a&gt;, I was misunderstood by your &quot;two-level GROUP BY&quot;. It is not about &quot;two-level&quot;, consider use TimestampMaxWithRetractAggFunction directly: &quot;select my_user_max(timestamp &apos;2019-09-09&apos;) from T group by b&quot;. It will fail too.&lt;/p&gt;

&lt;p&gt;The real reason is that blink planner not support &quot;accumulate(acc, Object value)&quot; generic object with third-part data formats. Note, we only support internal/external format in this usage.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&#160;UDAF only defines &quot;getResultType&quot; and &quot;getAccumulatorType&quot;, if UDAF define&#160;&quot;accumulate(acc, Object input)&quot;, planner never know the real format of&#160;input, I think we only can support this after UDF type refactoring.&lt;/p&gt;</comment>
                            <comment id="17005165" author="jark" created="Mon, 30 Dec 2019 06:52:59 +0000"  >&lt;p&gt;Thanks for the explanation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;, so it is a by-desgin backward compatible problem. &lt;br/&gt;
Regarding to the &lt;tt&gt;TimestampMaxWithRetractAggFunction&lt;/tt&gt;, I&apos;m fine with the fixing way. &lt;br/&gt;
Assigned to you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=docete&quot; class=&quot;user-hover&quot; rel=&quot;docete&quot;&gt;docete&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17005278" author="docete" created="Mon, 30 Dec 2019 12:05:29 +0000"  >&lt;p&gt;Opened two PRs to fix this issue:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/pull/10722&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/10722&lt;/a&gt;&#160;for release-1.10 and master&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/pull/10723&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/10723&lt;/a&gt;&#160;for release-1.9&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17005948" author="jark" created="Tue, 31 Dec 2019 06:29:19 +0000"  >&lt;p&gt;1.11.0: ba4433540561ef942062c70eb6bce64c02d8a54a&lt;br/&gt;
1.10.0: f58a2ecf2c6a60c0c81f9ece13d58797407232fa &lt;br/&gt;
1.9.2: ecd4e42d4980928655ec3ba2f1517d12c29a1d94&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 46 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0a0xs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>