<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:41:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14398] Further split input unboxing code into separate methods</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14398</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In one of our production pipelines, we have a table with 1200+ columns.&#160; At runtime, it failed due to a method inside the generated code exceeding 64kb when compiled to bytecode.&lt;/p&gt;

&lt;p&gt;After we investigated the generated code, it appeared that the &lt;b&gt;map&lt;/b&gt; method inside a generated&#160;&lt;b&gt;RichMapFunction&lt;/b&gt; was too long. See attached file (codegen.example.txt).&lt;/p&gt;

&lt;p&gt;In the problematic &lt;b&gt;map&lt;/b&gt; method, &lt;b&gt;result setters&lt;/b&gt; were correctly split into individual methods and did not have the largest footprint.&lt;/p&gt;

&lt;p&gt;However, there were also 1000+ input unboxing expressions inside &lt;b&gt;reusableInputUnboxingExprs&lt;/b&gt;, which, individually were not trivial and when flattened linearly in the&#160;&lt;b&gt;map&lt;/b&gt; function&#160;&lt;a href=&quot;https://github.com/apache/flink/blob/release-1.8.0/flink-table/flink-table-planner/src/main/scala/org/apache/flink/table/codegen/FunctionCodeGenerator.scala#L187&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, pushed the method size beyond 64kb in bytecode.&lt;/p&gt;

&lt;p&gt;We think it is worthwhile to split these input unboxing code snippets into individual methods.&#160;&#160;We were able to verify, in our production environment, that splitting input unboxing code snippets into individual methods resolves the issue.&#160; Would love to hear thoughts from the team and find the best path to fix it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13262369">FLINK-14398</key>
            <summary>Further split input unboxing code into separate methods</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="haodang">Hao Dang</assignee>
                                    <reporter username="haodang">Hao Dang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 15 Oct 2019 13:55:54 +0000</created>
                <updated>Wed, 30 Oct 2019 06:04:49 +0000</updated>
                            <resolved>Wed, 30 Oct 2019 06:04:49 +0000</resolved>
                                    <version>1.8.0</version>
                                    <fixVersion>1.8.3</fixVersion>
                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Table SQL / Legacy Planner</component>
                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="16952596" author="jark" created="Wed, 16 Oct 2019 08:12:10 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=haodang&quot; class=&quot;user-hover&quot; rel=&quot;haodang&quot;&gt;haodang&lt;/a&gt;, thanks for reporting this. I think you are using the old planner (or called flink planner) , right? &lt;br/&gt;
Actually, old planner supports codegen splitting, did you try &lt;tt&gt;TableConfig#setMaxGeneratedCodeLength&lt;/tt&gt; ?&lt;/p&gt;</comment>
                            <comment id="16952607" author="twalthr" created="Wed, 16 Oct 2019 08:27:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; the code splitting is limited at the moment. It just splits by field but not within expressions or in this case for unboxing. I guess we need to introduce more logic here.&lt;/p&gt;</comment>
                            <comment id="16952611" author="haodang" created="Wed, 16 Oct 2019 08:32:45 +0000"  >&lt;p&gt;Indeed, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;. Thanks for the quick response.&lt;br/&gt;
 The code in the scenario above was already split based on the existing splitting logic. Yet the sheer number of code snippets produced by &lt;b&gt;reusableInputUnboxingExprs&lt;/b&gt; took a large footprint in the end, and we probably should split them as well, i.e. putting them into individual methods.&lt;/p&gt;</comment>
                            <comment id="16952629" author="jark" created="Wed, 16 Oct 2019 08:58:36 +0000"  >&lt;p&gt;Thanks. I agree with splitting can solve this problem. &lt;br/&gt;
But from the experience of our internal implementation, the main problem is how to do this in a good way, cover all the paths and take fields/methods/class length into account. It should be a good framework/API for developers to make some codegen class support splitting without introducing too much duplicate codes.&lt;/p&gt;

&lt;p&gt;So I think this deserves a design doc. And maybe we should aiming for blink planner first, because old planner will be deprecated in the future. &lt;/p&gt;</comment>
                            <comment id="16952632" author="jark" created="Wed, 16 Oct 2019 09:02:00 +0000"  >&lt;p&gt;For fixing, I think it&apos;s fine to fix it first in old planner in a simple way. &lt;/p&gt;</comment>
                            <comment id="16952676" author="haodang" created="Wed, 16 Oct 2019 09:51:45 +0000"  >&lt;p&gt;Totally agree on a proper design doc for scoping and planning as this is a fundamental piece of the system.&#160; We are happy to help in anyway possible to push the fix through, as we will be benefiting from it too.&lt;/p&gt;

&lt;p&gt;For fixing 1.8.0, would it make sense for us to make a PR to start with?&#160; We can go from there for further discussions.&#160; I haven&apos;t dig into versions newer than 1.8.0, thus cannot say for sure if there will be more work needed for fixing versions post 1.8.0 on top of our existing fix.&lt;/p&gt;

&lt;p&gt;Also, excuse me for my greenness here: &lt;em&gt;what&apos;s the difference between the blink planner vs. the old planner?&lt;/em&gt;&lt;/p&gt;</comment>
                            <comment id="16952684" author="twalthr" created="Wed, 16 Oct 2019 10:04:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; I agree, I think for the Blink planner we need a better code generation framework at some point. This is also the point when we can reimplement this code in Java.&lt;/p&gt;

&lt;p&gt;As a short term solution, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=haodang&quot; class=&quot;user-hover&quot; rel=&quot;haodang&quot;&gt;haodang&lt;/a&gt; feel free to open a PR for further code splitting. Should I assign this issue to you? The Blink planner is similar to the Flink planner but has been further developed internally at Alibaba and was open sourced recently. Many code parts look similar to the old planner. The old planner is still the default planner for now.&lt;/p&gt;</comment>
                            <comment id="16952747" author="haodang" created="Wed, 16 Oct 2019 11:42:55 +0000"  >&lt;p&gt;Thanks for the explanation!&lt;/p&gt;

&lt;p&gt;And yea, feel free to assign it to me - happy open a PR for that.&lt;/p&gt;</comment>
                            <comment id="16952771" author="twalthr" created="Wed, 16 Oct 2019 12:27:23 +0000"  >&lt;p&gt;I assigned it to you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=haodang&quot; class=&quot;user-hover&quot; rel=&quot;haodang&quot;&gt;haodang&lt;/a&gt;. It would be great to not introduce another config parameter and avoid splitting in most of the cases for performance reasons.&lt;/p&gt;</comment>
                            <comment id="16952786" author="haodang" created="Wed, 16 Oct 2019 12:46:34 +0000"  >&lt;p&gt;Sounds good, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt;.&#160; I should be able to put up a PR in the next few days.&lt;/p&gt;</comment>
                            <comment id="16962725" author="jark" created="Wed, 30 Oct 2019 06:04:49 +0000"  >&lt;p&gt;1.10.0: 4c87259c1b931318a917eba665a219b63788a735&lt;br/&gt;
1.9.2: 7fbada04fdafeb37bb6dc3e023ee502892e2e046&lt;br/&gt;
1.8.3: f6b855d9894bc783c760570053719b7a0c830ebb&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12983068" name="codegen.example.txt" size="748785" author="haodang" created="Tue, 15 Oct 2019 13:42:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07lu8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>