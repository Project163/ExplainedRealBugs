<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5667] Possible state data loss when task fails while checkpointing</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5667</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;It is possible that Flink loses state data when a &lt;tt&gt;Task&lt;/tt&gt; fails while a checkpoint is being drawn. The scenario is the following:&lt;/p&gt;

&lt;p&gt;Flink has finished the synchronous checkpointing part and starts the asynchronous part by creating and submitting a &lt;tt&gt;AsyncCheckpointRunnable&lt;/tt&gt; to an &lt;tt&gt;Executor&lt;/tt&gt;. This runnable is also registered at the closeable registry. If the &lt;tt&gt;Task&lt;/tt&gt; now fails before the &lt;tt&gt;AsyncCheckpointRunnable&lt;/tt&gt; has completed, it will be closed due to being registered in the closeable registry. The closing operation will discard all state handles and cancel all runnable state futures. However, it will not stop the runnable from sending an acknowledge message to the &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If this message completes the pending checkpoint, then this checkpoint will be transformed into a &lt;tt&gt;CompletedCheckpoint&lt;/tt&gt; which is faulty (some of the data has already been deleted). Depending on Flink&apos;s configuration, this will discard older completed checkpoints and thus we will have state data loss.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13038225">FLINK-5667</key>
            <summary>Possible state data loss when task fails while checkpointing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Jan 2017 18:48:37 +0000</created>
                <updated>Fri, 27 Jan 2017 19:14:06 +0000</updated>
                            <resolved>Fri, 27 Jan 2017 19:13:33 +0000</resolved>
                                    <version>1.2.0</version>
                    <version>1.3.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15842420" author="uce" created="Fri, 27 Jan 2017 09:08:00 +0000"  >&lt;p&gt;Very good catch! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15843013" author="githubbot" created="Fri, 27 Jan 2017 15:39:35 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3226&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5667&quot; title=&quot;Possible state data loss when task fails while checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5667&quot;&gt;&lt;del&gt;FLINK-5667&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;state&amp;#93;&lt;/span&gt; Synchronize asynchronous checkpointing and close operation&lt;/p&gt;

&lt;p&gt;    This PR synchronizes asynchronous checkpointing and close operations of a StreamTask.&lt;br/&gt;
    The synchronization prevents that an acknowledged checkpoint gets discarded and that&lt;br/&gt;
    a discarded checkpoint gets acknowledged. It achieves this by introducing an atomic&lt;br/&gt;
    state variable which guards against late close and acknowledge operations.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; asyncCheckpointingFix&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3226.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3226.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3226&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 16ce24f6d062ade2f3bb3d41059ced71b7040c52&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-27T15:26:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5667&quot; title=&quot;Possible state data loss when task fails while checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5667&quot;&gt;&lt;del&gt;FLINK-5667&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;state&amp;#93;&lt;/span&gt; Synchronize asynchronous checkpointing and close operation&lt;/p&gt;

&lt;p&gt;    This PR synchronizes asynchronous checkpointing and close operations of a StreamTask.&lt;br/&gt;
    The synchronization prevents that an acknowledged checkpoint gets discarded and that&lt;br/&gt;
    a discarded checkpoint gets acknowledged. It achieves this by introducing an atomic&lt;br/&gt;
    state variable which guards against late close and acknowledge operations.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15843015" author="githubbot" created="Fri, 27 Jan 2017 15:40:38 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3227&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;backport&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5667&quot; title=&quot;Possible state data loss when task fails while checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5667&quot;&gt;&lt;del&gt;FLINK-5667&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;state&amp;#93;&lt;/span&gt; Synchronize asynchronous checkpointing and close operation&lt;/p&gt;

&lt;p&gt;    Backport of #3226 onto `release-1.2` branch.&lt;/p&gt;

&lt;p&gt;    This PR synchronizes asynchronous checkpointing and close operations of a StreamTask.&lt;br/&gt;
    The synchronization prevents that an acknowledged checkpoint gets discarded and that&lt;br/&gt;
    a discarded checkpoint gets acknowledged. It achieves this by introducing an atomic&lt;br/&gt;
    state variable which guards against late close and acknowledge operations.&lt;/p&gt;

&lt;p&gt;    cc @uce, @StefanRRichter &lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; asyncCheckpointingFixBackport&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3227.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3227.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3227&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d0a2499f10060f159ad92500338125850a82c0c4&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-27T15:26:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5667&quot; title=&quot;Possible state data loss when task fails while checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5667&quot;&gt;&lt;del&gt;FLINK-5667&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;state&amp;#93;&lt;/span&gt; Synchronize asynchronous checkpointing and close operation&lt;/p&gt;

&lt;p&gt;    This PR synchronizes asynchronous checkpointing and close operations of a StreamTask.&lt;br/&gt;
    The synchronization prevents that an acknowledged checkpoint gets discarded and that&lt;br/&gt;
    a discarded checkpoint gets acknowledged. It achieves this by introducing an atomic&lt;br/&gt;
    state variable which guards against late close and acknowledge operations.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15843044" author="githubbot" created="Fri, 27 Jan 2017 16:03:09 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3226&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks! +1 to merge this and #3227. Verified that tests catch both orderings.&lt;/p&gt;</comment>
                            <comment id="15843149" author="githubbot" created="Fri, 27 Jan 2017 17:23:56 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3227#discussion_r98248743&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3227#discussion_r98248743&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java &amp;#8212;&lt;br/&gt;
    @@ -947,11 +951,17 @@ public void run() {&lt;br/&gt;
     						keyedStateHandleBackend,&lt;br/&gt;
     						keyedStateHandleStream);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;owner.getEnvironment().acknowledgeCheckpoint(checkpointMetaData, subtaskState);&lt;br/&gt;
    +				if (asyncCheckpointState.compareAndSet(CheckpointingOperation.AsynCheckpointState.RUNNING, CheckpointingOperation.AsynCheckpointState.COMPLETED)) {&lt;br/&gt;
    +					owner.getEnvironment().acknowledgeCheckpoint(checkpointMetaData, subtaskState);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think there is still a problem here: in case the RPC that acknowledges the checkpoint fails with exception, the `cleanup()` call in the `catch{}` will find the state already set to completed and will not perform any cleanup actions.&lt;/p&gt;</comment>
                            <comment id="15843334" author="githubbot" created="Fri, 27 Jan 2017 19:06:11 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3227#discussion_r98268538&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3227#discussion_r98268538&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java &amp;#8212;&lt;br/&gt;
    @@ -947,11 +951,17 @@ public void run() {&lt;br/&gt;
     						keyedStateHandleBackend,&lt;br/&gt;
     						keyedStateHandleStream);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;owner.getEnvironment().acknowledgeCheckpoint(checkpointMetaData, subtaskState);&lt;br/&gt;
    +				if (asyncCheckpointState.compareAndSet(CheckpointingOperation.AsynCheckpointState.RUNNING, CheckpointingOperation.AsynCheckpointState.COMPLETED)) {&lt;br/&gt;
    +					owner.getEnvironment().acknowledgeCheckpoint(checkpointMetaData, subtaskState);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    In order to harden it, I&apos;ll reset the state to `RUNNING` in the failure case if it was `COMPLETED`. Then cleanup should properly work.&lt;/p&gt;</comment>
                            <comment id="15843335" author="githubbot" created="Fri, 27 Jan 2017 19:07:19 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3226&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @uce. Will address @StefanRRichter comment from #3227 and then merge the PR.&lt;/p&gt;</comment>
                            <comment id="15843336" author="githubbot" created="Fri, 27 Jan 2017 19:07:46 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3227&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @StefanRRichter. I&apos;ll address your comment and then merge the PR.&lt;/p&gt;</comment>
                            <comment id="15843338" author="githubbot" created="Fri, 27 Jan 2017 19:08:44 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3226&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @tillrohrmann ! Very good to have this fixed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15843345" author="githubbot" created="Fri, 27 Jan 2017 19:12:23 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3226&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15843349" author="till.rohrmann" created="Fri, 27 Jan 2017 19:13:33 +0000"  >&lt;p&gt;1.2.0: 3400a87dce9940ac8da95c89ff9791ca6a687776&lt;br/&gt;
1.3.0: 0aa9db07800bcc3979dc89bba0b3697149b18ecd&lt;/p&gt;</comment>
                            <comment id="15843351" author="githubbot" created="Fri, 27 Jan 2017 19:14:06 +0000"  >&lt;p&gt;Github user tillrohrmann closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3227&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i399g7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>