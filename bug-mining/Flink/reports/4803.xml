<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19300] Timer loss after restoring from savepoint</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19300</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;While using heap-based timers, we are seeing occasional timer loss after restoring program from savepoint, especially when using a remote savepoint storage (s3).&#160;&lt;/p&gt;

&lt;p&gt;After some investigation, the issue seems to be related to &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-core/src/main/java/org/apache/flink/core/io/PostVersionedIOReadableWritable.java#L65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this line in deserialization&lt;/a&gt;. When trying to check the VERSIONED_IDENTIFIER, the input stream may not guarantee filling the byte array, causing timers to be dropped for the affected key group.&lt;/p&gt;

&lt;p&gt;Should keep reading until expected number of bytes are actually read or if end of the stream has been reached.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13328449">FLINK-19300</key>
            <summary>Timer loss after restoring from savepoint</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xianggao">Xiang Gao</assignee>
                                    <reporter username="xianggao">Xiang Gao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 21 Sep 2020 04:09:35 +0000</created>
                <updated>Wed, 8 Dec 2021 09:03:11 +0000</updated>
                            <resolved>Tue, 17 Nov 2020 04:56:55 +0000</resolved>
                                    <version>1.8.0</version>
                                    <fixVersion>1.11.3</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17199331" author="klion26" created="Mon, 21 Sep 2020 11:12:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xianggao&quot; class=&quot;user-hover&quot; rel=&quot;xianggao&quot;&gt;xianggao&lt;/a&gt;&#160;thanks for reporting the issue, I think you analysis is right,&#160;&lt;tt&gt;InputStream#read&lt;/tt&gt; can&apos;t guarantee to fully read the byte array.&lt;/p&gt;

&lt;p&gt;As this may loss the timer I&apos;m not sure this need to be a blocker or not?&lt;/p&gt;</comment>
                            <comment id="17203504" author="xianggao" created="Mon, 28 Sep 2020 20:20:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=klion26&quot; class=&quot;user-hover&quot; rel=&quot;klion26&quot;&gt;klion26&lt;/a&gt;&#160;Thanks for taking a look! I&apos;m not sure about the criteria for &quot;blocker&quot; issues. This issue seems to only exist in heap based timers, but losing timer is a bit dangerous.&lt;/p&gt;

&lt;p&gt;Wonder what&apos;s our process on patching this kind of issue. May I submit a PR for this?&lt;/p&gt;</comment>
                            <comment id="17229780" author="rmetzger" created="Wed, 11 Nov 2020 06:42:14 +0000"  >&lt;p&gt;Thanks a lot for reporting this. Which Flink version are you using?&lt;/p&gt;</comment>
                            <comment id="17229782" author="davidhw" created="Wed, 11 Nov 2020 06:51:19 +0000"  >&lt;p&gt;We&apos;re using Flink version 1.8.&lt;/p&gt;</comment>
                            <comment id="17229790" author="tzulitai" created="Wed, 11 Nov 2020 07:03:04 +0000"  >&lt;p&gt;This looks like a real issue, the typical &lt;tt&gt;read&lt;/tt&gt; v.s. &lt;tt&gt;readFully&lt;/tt&gt; mistake.&lt;/p&gt;

&lt;p&gt;This read path should only occur for the case where users are using RocksDB backends + heap-based timers (using the heap backend should be fine, would not bump into this).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xianggao&quot; class=&quot;user-hover&quot; rel=&quot;xianggao&quot;&gt;xianggao&lt;/a&gt; to help me understand the full problem: in your scenarios, I&apos;m assuming that the timer losses are caused by somehow the &lt;tt&gt;InternalTimerServiceSerializationProxy&lt;/tt&gt; silently skipping reading the timers, instead of some &lt;tt&gt;IOException&lt;/tt&gt; due to incorrect read attempts (and eventually fails the restore, instead of a timer loss). Could you clarify if my assumption is correct?&lt;/p&gt;

&lt;p&gt;As for the fix, I would suggest to try to reuse the &lt;tt&gt;java.io.DataInput#readFully&lt;/tt&gt; method instead or re-implementing it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] tmp = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[VERSIONED_IDENTIFIER.length];

DataInputView inputView = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataInputViewStreamWrapper(inputStream);
inputView.readFully(tmp);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can catch &lt;tt&gt;EOFException&lt;/tt&gt; to determine if end of stream is reached / not enough bytes available.&lt;/p&gt;
</comment>
                            <comment id="17229793" author="tzulitai" created="Wed, 11 Nov 2020 07:04:58 +0000"  >&lt;p&gt;As for priority of this issue:&lt;/p&gt;

&lt;p&gt;The bug looks like it&apos;s been there for quite a while already across many versions, but I&apos;d suggest to list it as a blocker for 1.12.0 and 1.11.3.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xianggao&quot; class=&quot;user-hover&quot; rel=&quot;xianggao&quot;&gt;xianggao&lt;/a&gt; Please do submit a PR for this, I&apos;ll try to review it as soon as possible.&lt;/p&gt;</comment>
                            <comment id="17229796" author="tzulitai" created="Wed, 11 Nov 2020 07:08:28 +0000"  >&lt;p&gt;Just a comment on the severity of the issue:&lt;/p&gt;

&lt;p&gt;It looks like timer loss is only possible if somehow, the key groups contain a &lt;tt&gt;0&lt;/tt&gt; at the very beginning of the stream. This seems to be the only possible case that would lead to the &lt;tt&gt;InternalTimerServiceSerializationProxy&lt;/tt&gt; silently skipping the rest of the reads, instead of failing the restore with some &lt;tt&gt;IOException&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17230163" author="xianggao" created="Wed, 11 Nov 2020 18:49:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt;,&#160;&lt;/p&gt;

&lt;p&gt;Yeah, your assumption is right on the behavior of the issue. The&#160;InternalTimerServiceSerializationProxy will silently skip timers instead of throwing error.&#160;&lt;/p&gt;

&lt;p&gt;Will submit a PR asap.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;</comment>
                            <comment id="17230306" author="xianggao" created="Thu, 12 Nov 2020 00:32:40 +0000"  >&lt;p&gt;Created a PR. Seems like in case of non-versioned payload, we would push back those read bytes. We might not know the correct number of bytes to push back if we use DataInputView.readFully() while catching EOF. Did something similar to&#160;DataInputView.readFully(), but keep the number of bytes so that we can push back when necessary.&lt;/p&gt;</comment>
                            <comment id="17233259" author="tzulitai" created="Tue, 17 Nov 2020 04:56:55 +0000"  >&lt;p&gt;flink/master: 4bd0ad19e6ac056106ba0d5c3a3440bd5054f89f&lt;br/&gt;
flink/release-1.11: f33c30feed2cdd36c04b373ef36f6c11a5f5d504&lt;/p&gt;

&lt;p&gt;Thanks for the contribution &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xianggao&quot; class=&quot;user-hover&quot; rel=&quot;xianggao&quot;&gt;xianggao&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13183584">FLINK-10297</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ir54:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>