<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10193] Default RPC timeout is used when triggering savepoint via JobMasterGateway</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10193</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When calling &lt;tt&gt;JobMasterGateway#triggerSavepoint(String, boolean, Time)&lt;/tt&gt;, the default timeout is used because the time parameter of the method  is not annotated with &lt;tt&gt;@RpcTimeout&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;&lt;b&gt;Expected behavior&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;timeout for the RPC should be &lt;tt&gt;RpcUtils.INF_TIMEOUT&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13180262">FLINK-10193</key>
            <summary>Default RPC timeout is used when triggering savepoint via JobMasterGateway</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gjy">Gary Yao</assignee>
                                    <reporter username="gjy">Gary Yao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 21 Aug 2018 17:55:49 +0000</created>
                <updated>Mon, 5 Nov 2018 10:49:04 +0000</updated>
                            <resolved>Fri, 7 Sep 2018 13:42:53 +0000</resolved>
                                    <version>1.5.3</version>
                    <version>1.6.0</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.5.4</fixVersion>
                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16588512" author="uce" created="Wed, 22 Aug 2018 08:03:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt; I&apos;ve changed the type of ticket from &lt;tt&gt;Improvement&lt;/tt&gt; to &lt;tt&gt;Bug&lt;/tt&gt; as this results in savepoints that take longer than the default ask timeout to be reported as &lt;tt&gt;COMPLETED&lt;/tt&gt; with a &lt;tt&gt;failure-cause&lt;/tt&gt; although the actual savepoint completes successfully:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;: {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;COMPLETED&quot;&lt;/span&gt;
  },
  &lt;span class=&quot;code-quote&quot;&gt;&quot;operation&quot;&lt;/span&gt;: {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;failure-cause&quot;&lt;/span&gt;: {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;java.util.concurrent.CompletionException&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;stack-trace&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;java.util.concurrent.CompletionException: akka.pattern.AskTimeoutException: Ask timed out on [Actor[akka:&lt;span class=&quot;code-comment&quot;&gt;//flink/user/jobmanager_0#42163687]] after [30000 ms]. Sender[&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;] sent message of type \&quot;&lt;/span&gt;org.apache.flink.runtime.rpc.messages.LocalFencedMessage\&lt;span class=&quot;code-quote&quot;&gt;&quot;.\n\tat java.util.concurrent.CompletableFuture.encodeRelay(CompletableFuture.java:326)\n\tat java.util.concurrent.CompletableFuture.completeRelay(CompletableFuture.java:338)\n\tat java.util.concurrent.CompletableFuture.uniRelay(CompletableFuture.java:911)\n\tat java.util.concurrent.CompletableFuture$UniRelay.tryFire(CompletableFuture.java:899)\n\tat java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:474)\n\tat java.util.concurrent.CompletableFuture.completeExceptionally...&amp;lt;ommitted &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; brevity&amp;gt;&quot;&lt;/span&gt;
&lt;/span&gt;    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This means that we can&apos;t use the REST API to reliably trigger savepoints. I&apos;ve verified this with a small program that blocks during checkpoints for a configurable amount of time. &lt;/p&gt;

&lt;p&gt;The only workaround as far as I know is to increase &lt;tt&gt;akka.ask.timeout&lt;/tt&gt; (although I would not recommend this as it affects other things as well). Note that increasing &lt;tt&gt;web.timeout&lt;/tt&gt; does not affect this.&lt;/p&gt;</comment>
                            <comment id="16588768" author="githubbot" created="Wed, 22 Aug 2018 12:01:21 +0000"  >&lt;p&gt;GJL opened a new pull request #6601: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; Add @RpcTimeout to JobMasterGateway.triggerSavepoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6601&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   &lt;b&gt;This adds the `@RpcTimeout` annotation to `JobMasterGateway.triggerSavepoint` so that the default timeout is overridden.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;   cc: @uce @tillrohrmann &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Add @RpcTimeout to `JobMasterGateway.triggerSavepoint`.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change added tests and can be verified as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Manually verified the change by running `SlowToCheckpoint` job attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; issue.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16588778" author="githubbot" created="Wed, 22 Aug 2018 12:17:33 +0000"  >&lt;p&gt;GJL commented on issue #6601: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; Add @RpcTimeout to JobMasterGateway.triggerSavepoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6601#issuecomment-415012048&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6601#issuecomment-415012048&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I see the following possibilities to test this:&lt;/p&gt;

&lt;p&gt;   1. Override `triggerSavepoint` to a NOP, and trigger savepoint twice with increasing timeouts. The second invocation should fail later.&lt;br/&gt;
   2. Check for presence of the annotation with reflection.&lt;/p&gt;

&lt;p&gt;   I deliberately did not add tests because Option 1 is slow and depends on&lt;br/&gt;
   &lt;em&gt;&quot;good&quot;&lt;/em&gt; thread scheduling. Option 2 is fragile and not refactoring friendly.&lt;/p&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16588783" author="githubbot" created="Wed, 22 Aug 2018 12:26:56 +0000"  >&lt;p&gt;GJL edited a comment on issue #6601: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; Add @RpcTimeout to JobMasterGateway.triggerSavepoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6601#issuecomment-415012048&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6601#issuecomment-415012048&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I see the following possibilities to unit test this:&lt;/p&gt;

&lt;p&gt;   1. Override `triggerSavepoint` to a NOP, and trigger savepoint twice with increasing timeouts. The second invocation should fail later.&lt;br/&gt;
   2. Check for presence of the annotation with reflection.&lt;/p&gt;

&lt;p&gt;   I deliberately did not add tests because Option 1 is slow and depends on&lt;br/&gt;
   &lt;em&gt;&quot;good&quot;&lt;/em&gt; thread scheduling. Option 2 is fragile and not refactoring friendly.&lt;/p&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16588799" author="githubbot" created="Wed, 22 Aug 2018 12:50:20 +0000"  >&lt;p&gt;tillrohrmann commented on issue #6601: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; Add @RpcTimeout to JobMasterGateway.triggerSavepoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6601#issuecomment-415020422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6601#issuecomment-415020422&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Can&apos;t we check in the `JobMaster#triggerSavepoint` method which `timeout` value was passed in? It is not a super good test but it would guard against this specific failure in the future.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16588975" author="githubbot" created="Wed, 22 Aug 2018 14:55:48 +0000"  >&lt;p&gt;GJL commented on issue #6601: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; Add @RpcTimeout to JobMasterGateway.triggerSavepoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6601#issuecomment-415061650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6601#issuecomment-415061650&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @tillrohrmann The value of the timeout from the perspective of the method implementation will always be what is passed to the RPC. This is regardless of whether the annotation is present or not because if the annotation is missing, the `AkkaInvocationHandler`, cannot know which item in the args array should be replaced with the default timeout. &lt;/p&gt;

&lt;p&gt;   If the call originates from the REST API, the value will be `RpcUtils.INF_TIMEOUT`:&lt;br/&gt;
   &lt;a href=&quot;https://github.com/apache/flink/blob/6258a4c333ce9dba914621b13eac2f7d91f5cb72/flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/job/savepoints/SavepointHandlers.java#L132&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/6258a4c333ce9dba914621b13eac2f7d91f5cb72/flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/job/savepoints/SavepointHandlers.java#L132&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;   I can add a test to the handler test suite but this will not verify my change. &lt;/p&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16596159" author="githubbot" created="Wed, 29 Aug 2018 10:03:41 +0000"  >&lt;p&gt;tillrohrmann commented on issue #6601: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; Add @RpcTimeout to JobMasterGateway.triggerSavepoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6601#issuecomment-416898324&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6601#issuecomment-416898324&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   You&apos;re right @GJL. Then I would vote for the first test case. Something along the lines:&lt;br/&gt;
   ```&lt;br/&gt;
   Future future1 = jm.triggerSavepoint(1 ms);&lt;br/&gt;
   Future future2 = jm.triggerSavepoint(inf);&lt;br/&gt;
   future1.get() fails with TimeoutException &amp;amp;&amp;amp; !future2.isDone()&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16604432" author="githubbot" created="Wed, 5 Sep 2018 13:54:01 +0000"  >&lt;p&gt;jelmerk commented on issue #6601: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; Add @RpcTimeout to JobMasterGateway.triggerSavepoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6601#issuecomment-418739345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6601#issuecomment-418739345&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Any ETA on this ? for non trivial jobs with a lot of state this is critical &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16604897" author="githubbot" created="Wed, 5 Sep 2018 20:21:28 +0000"  >&lt;p&gt;GJL commented on issue #6601: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; Add @RpcTimeout to JobMasterGateway.triggerSavepoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6601#issuecomment-418868217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6601#issuecomment-418868217&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @jelmerk Should be merged soon. We did not have much time recently due to Flink Forward.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16606004" author="githubbot" created="Thu, 6 Sep 2018 16:11:37 +0000"  >&lt;p&gt;tillrohrmann commented on issue #6601: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; Add @RpcTimeout to JobMasterGateway.triggerSavepoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6601#issuecomment-419152588&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6601#issuecomment-419152588&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for the contribution @GJL. Merging this PR.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16607137" author="githubbot" created="Fri, 7 Sep 2018 13:41:15 +0000"  >&lt;p&gt;asfgit closed pull request #6601: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10193&quot; title=&quot;Default RPC timeout is used when triggering savepoint via JobMasterGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10193&quot;&gt;&lt;del&gt;FLINK-10193&lt;/del&gt;&lt;/a&gt; Add @RpcTimeout to JobMasterGateway.triggerSavepoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6601&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
index 01cb2b6b099..4a66d32a2ac 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
@@ -95,7 +95,6 @@&lt;br/&gt;
 import org.apache.flink.runtime.rpc.FatalErrorHandler;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.FencedRpcEndpoint;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcService;&lt;br/&gt;
-import org.apache.flink.runtime.rpc.RpcTimeout;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.akka.AkkaRpcServiceUtils;&lt;br/&gt;
 import org.apache.flink.runtime.state.KeyGroupRange;&lt;br/&gt;
 import org.apache.flink.runtime.taskexecutor.AccumulatorReport;&lt;br/&gt;
@@ -909,7 +908,7 @@ public void heartbeatFromResourceManager(final ResourceID resourceID) {&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt; 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public CompletableFuture&amp;lt;JobDetails&amp;gt; requestJobDetails(@RpcTimeout Time timeout) {&lt;br/&gt;
+	public CompletableFuture&amp;lt;JobDetails&amp;gt; requestJobDetails(Time timeout) 
{
 		final ExecutionGraph currentExecutionGraph = executionGraph;
 		return CompletableFuture.supplyAsync(() -&amp;gt; WebMonitorUtils.createDetailsForJob(currentExecutionGraph), scheduledExecutorService);
 	}
&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMasterGateway.java b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMasterGateway.java&lt;br/&gt;
index 981222d17a6..bc073c192bd 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMasterGateway.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMasterGateway.java&lt;br/&gt;
@@ -268,7 +268,7 @@ void heartbeatFromTaskManager(&lt;br/&gt;
 	CompletableFuture&amp;lt;String&amp;gt; triggerSavepoint(&lt;br/&gt;
 		@Nullable final String targetDirectory,&lt;br/&gt;
 		final boolean cancelJob,&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;final Time timeout);&lt;br/&gt;
+		@RpcTimeout final Time timeout);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Requests the statistics on operator back pressure.&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
index 66ca769165a..9a2bc97b62b 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
@@ -92,6 +92,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.TaskManagerLocation;&lt;br/&gt;
 import org.apache.flink.runtime.testtasks.NoOpInvokable;&lt;br/&gt;
 import org.apache.flink.runtime.util.TestingFatalErrorHandler;&lt;br/&gt;
+import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
 import org.apache.flink.util.FlinkException;&lt;br/&gt;
 import org.apache.flink.util.InstantiationUtil;&lt;br/&gt;
 import org.apache.flink.util.TestLogger;&lt;br/&gt;
@@ -108,6 +109,7 @@&lt;br/&gt;
 import org.junit.rules.TemporaryFolder;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import javax.annotation.Nonnull;&lt;br/&gt;
+import javax.annotation.Nullable;&lt;/p&gt;

&lt;p&gt; import java.io.File;&lt;br/&gt;
 import java.io.FileOutputStream;&lt;br/&gt;
@@ -122,24 +124,28 @@&lt;br/&gt;
 import java.util.concurrent.BlockingQueue;&lt;br/&gt;
 import java.util.concurrent.CompletableFuture;&lt;br/&gt;
 import java.util.concurrent.CountDownLatch;&lt;br/&gt;
+import java.util.concurrent.ExecutionException;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;br/&gt;
+import java.util.concurrent.TimeoutException;&lt;/p&gt;

&lt;p&gt; import static org.hamcrest.MatcherAssert.assertThat;&lt;br/&gt;
 import static org.hamcrest.Matchers.contains;&lt;br/&gt;
 import static org.hamcrest.Matchers.containsInAnyOrder;&lt;br/&gt;
 import static org.hamcrest.Matchers.equalTo;&lt;br/&gt;
 import static org.hamcrest.Matchers.hasSize;&lt;br/&gt;
+import static org.hamcrest.Matchers.instanceOf;&lt;br/&gt;
 import static org.hamcrest.Matchers.is;&lt;br/&gt;
 import static org.hamcrest.Matchers.nullValue;&lt;br/&gt;
 import static org.junit.Assert.assertNotNull;&lt;br/&gt;
 import static org.junit.Assert.assertTrue;&lt;br/&gt;
+import static org.junit.Assert.fail;&lt;/p&gt;

&lt;p&gt; /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests for 
{@link JobMaster}
&lt;p&gt;.&lt;br/&gt;
  */&lt;br/&gt;
 public class JobMasterTest extends TestLogger {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;static final TestingInputSplit[] EMPTY_TESTING_INPUT_SPLITS = new TestingInputSplit&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;;&lt;br/&gt;
+	private static final TestingInputSplit[] EMPTY_TESTING_INPUT_SPLITS = new TestingInputSplit&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@ClassRule&lt;br/&gt;
 	public static TemporaryFolder temporaryFolder = new TemporaryFolder();&lt;br/&gt;
@@ -418,7 +424,7 @@ public void testAutomaticRestartingWhenCheckpointing() throws Exception {&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Tests that an existing checkpoint will have precedence over an savepoint&lt;br/&gt;
+	 * Tests that an existing checkpoint will have precedence over an savepoint.&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testCheckpointPrecedesSavepointRecovery() throws Exception {&lt;br/&gt;
@@ -470,7 +476,7 @@ public void testCheckpointPrecedesSavepointRecovery() throws Exception {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests that the JobMaster retries the scheduling of a job&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* in case of a missing slot offering from a registered TaskExecutor&lt;br/&gt;
+	 * in case of a missing slot offering from a registered TaskExecutor.&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testSlotRequestTimeoutWhenNoSlotOffering() throws Exception {&lt;br/&gt;
@@ -874,9 +880,9 @@ public void testRequestPartitionState() throws Exception 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: { 			final CompletableFuture&amp;lt;TaskDeploymentDescriptor&amp;gt; tddFuture = new CompletableFuture&amp;lt;&amp;gt;(); 			final TestingTaskExecutorGateway testingTaskExecutorGateway = new TestingTaskExecutorGatewayBuilder() 				.setSubmitTaskConsumer((taskDeploymentDescriptor, jobMasterId) -&amp;gt; {
-					  tddFuture.complete(taskDeploymentDescriptor);
-					  return CompletableFuture.completedFuture(Acknowledge.get());
-				  })+					tddFuture.complete(taskDeploymentDescriptor);+					return CompletableFuture.completedFuture(Acknowledge.get());+				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;)&lt;br/&gt;
 				.createTestingTaskExecutorGateway();&lt;br/&gt;
 			rpcService.registerGateway(testingTaskExecutorGateway.getAddress(), testingTaskExecutorGateway);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -917,6 +923,58 @@ public void testRequestPartitionState() throws Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Tests that the timeout in &lt;/p&gt;
{@link JobMasterGateway#triggerSavepoint(String, boolean, Time)}
&lt;p&gt;+	 * is respected.&lt;br/&gt;
+	 */&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testTriggerSavepointTimeout() throws Exception {&lt;br/&gt;
+		final JobMaster jobMaster = new JobMaster(&lt;br/&gt;
+			rpcService,&lt;br/&gt;
+			JobMasterConfiguration.fromConfiguration(configuration),&lt;br/&gt;
+			jmResourceId,&lt;br/&gt;
+			jobGraph,&lt;br/&gt;
+			haServices,&lt;br/&gt;
+			DefaultSlotPoolFactory.fromConfiguration(configuration, rpcService),&lt;br/&gt;
+			new TestingJobManagerSharedServicesBuilder().build(),&lt;br/&gt;
+			heartbeatServices,&lt;br/&gt;
+			blobServer,&lt;br/&gt;
+			UnregisteredJobManagerJobMetricGroupFactory.INSTANCE,&lt;br/&gt;
+			new NoOpOnCompletionActions(),&lt;br/&gt;
+			testingFatalErrorHandler,&lt;br/&gt;
+			JobMasterTest.class.getClassLoader()) {&lt;br/&gt;
+&lt;br/&gt;
+			@Override&lt;br/&gt;
+			public CompletableFuture&amp;lt;String&amp;gt; triggerSavepoint(&lt;br/&gt;
+					@Nullable final String targetDirectory,&lt;br/&gt;
+					final boolean cancelJob,&lt;br/&gt;
+					final Time timeout) &lt;/p&gt;
{
+				return new CompletableFuture&amp;lt;&amp;gt;();
+			}
&lt;p&gt;+		};&lt;br/&gt;
+&lt;br/&gt;
+		try {&lt;br/&gt;
+			final CompletableFuture&amp;lt;Acknowledge&amp;gt; startFuture = jobMaster.start(jobMasterId, testingTimeout);&lt;br/&gt;
+			startFuture.get(testingTimeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
+&lt;br/&gt;
+			final JobMasterGateway jobMasterGateway = jobMaster.getSelfGateway(JobMasterGateway.class);&lt;br/&gt;
+			final CompletableFuture&amp;lt;String&amp;gt; savepointFutureLowTimeout = jobMasterGateway.triggerSavepoint(&quot;/tmp&quot;, false, Time.milliseconds(1));&lt;br/&gt;
+			final CompletableFuture&amp;lt;String&amp;gt; savepointFutureHighTimeout = jobMasterGateway.triggerSavepoint(&quot;/tmp&quot;, false, RpcUtils.INF_TIMEOUT);&lt;br/&gt;
+&lt;br/&gt;
+			try &lt;/p&gt;
{
+				savepointFutureLowTimeout.get(testingTimeout.getSize(), testingTimeout.getUnit());
+				fail();
+			}
&lt;p&gt; catch (final ExecutionException e) &lt;/p&gt;
{
+				final Throwable cause = ExceptionUtils.stripExecutionException(e);
+				assertThat(cause, instanceOf(TimeoutException.class));
+			}
&lt;p&gt;+&lt;br/&gt;
+			assertThat(savepointFutureHighTimeout.isDone(), is(equalTo(false)));&lt;br/&gt;
+		} finally &lt;/p&gt;
{
+			RpcUtils.terminateRpcEndpoint(jobMaster, testingTimeout);
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
 	private JobGraph producerConsumerJobGraph() {&lt;br/&gt;
 		final JobVertex producer = new JobVertex(&quot;Producer&quot;);&lt;br/&gt;
 		producer.setInvokableClass(NoOpInvokable.class);&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16607138" author="till.rohrmann" created="Fri, 7 Sep 2018 13:42:53 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
1.7.0: bfbcd908bf9b59f64ddf8c783293addc098ee516&lt;br/&gt;
1.6.1: 5d93520ae2a051f141cc5e92cf73411ecbde4390&lt;br/&gt;
1.5.4: d1c77f9686c36bf09939efd9bbf07ac554b41902&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13193961">FLINK-10671</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12936606" name="SlowToCheckpoint.java" size="3232" author="uce" created="Wed, 22 Aug 2018 08:14:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3x9rz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>