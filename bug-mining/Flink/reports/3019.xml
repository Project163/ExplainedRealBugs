<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:39:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-12101] Race condition when concurrently running uploaded jars via REST</title>
                <link>https://issues.apache.org/jira/browse/FLINK-12101</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Flink enables to upload and run Jars via REST. When multiple uploaded jars are invoked interactively to generate the JobGraph, the static initialization of the &lt;tt&gt;ContextEnvironment&lt;/tt&gt;, when calls are interleaved, will override each other and produce a local execution of the jar. The local execution uses an incorrect class loader and throws an exception like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2019-04-02 14:25:05,549 ERROR &amp;lt;pipeline class&amp;gt;   - Failed to create job graph
java.lang.RuntimeException: Pipeline execution failed
    at org.apache.beam.runners.flink.FlinkRunner.run(FlinkRunner.java:117)
    at org.apache.beam.sdk.Pipeline.run(Pipeline.java:313)
    at org.apache.beam.sdk.Pipeline.run(Pipeline.java:299)
    at &amp;lt;pipeline class run&amp;gt;
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:498)
    at org.apache.flink.client.program.PackagedProgram.callMainMethod(PackagedProgram.java:529)
    at org.apache.flink.client.program.PackagedProgram.invokeInteractiveModeForExecution(PackagedProgram.java:421)
    at org.apache.flink.client.program.OptimizerPlanEnvironment.getOptimizedPlan(OptimizerPlanEnvironment.java:83)
    at org.apache.flink.client.program.PackagedProgramUtils.createJobGraph(PackagedProgramUtils.java:78)
    at org.apache.flink.client.program.PackagedProgramUtils.createJobGraph(PackagedProgramUtils.java:120)
    at org.apache.flink.runtime.webmonitor.handlers.utils.JarHandlerUtils$JarHandlerContext.toJobGraph(JarHandlerUtils.java:117)
    at org.apache.flink.runtime.webmonitor.handlers.JarRunHandler.lambda$getJobGraphAsync$7(JarRunHandler.java:151)
    at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1590)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
    at java.lang.Thread.run(Thread.java:748)
Caused by: org.apache.flink.runtime.client.JobExecutionException: Job execution failed.
    at org.apache.flink.runtime.jobmaster.JobResult.toJobExecutionResult(JobResult.java:146)
    at org.apache.flink.runtime.minicluster.MiniCluster.executeJobBlocking(MiniCluster.java:647)
    at org.apache.flink.streaming.api.environment.LocalStreamEnvironment.execute(LocalStreamEnvironment.java:123)
    at org.apache.beam.runners.flink.FlinkPipelineExecutionEnvironment.executePipeline(FlinkPipelineExecutionEnvironment.java:125)
    at org.apache.beam.runners.flink.FlinkRunner.run(FlinkRunner.java:114)
    ... 18 more
Caused by: org.apache.flink.streaming.runtime.tasks.StreamTaskException: Could not instantiate outputs in order.
    at org.apache.flink.streaming.api.graph.StreamConfig.getOutEdgesInOrder(StreamConfig.java:398)
    at org.apache.flink.streaming.runtime.tasks.StreamTask.createStreamRecordWriters(StreamTask.java:1164)
    at org.apache.flink.streaming.runtime.tasks.StreamTask.(StreamTask.java:212)
    at org.apache.flink.streaming.runtime.tasks.StreamTask.(StreamTask.java:190)
    at org.apache.flink.streaming.runtime.tasks.SourceStreamTask.(SourceStreamTask.java:51)
    at org.apache.flink.streaming.runtime.tasks.StoppableSourceStreamTask.(StoppableSourceStreamTask.java:39)
    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
    at org.apache.flink.runtime.taskmanager.Task.loadAndInstantiateInvokable(Task.java:1398)
    at org.apache.flink.runtime.taskmanager.Task.run(Task.java:682)
    ... 1 more
Caused by: java.lang.ClassNotFoundException: org.apache.beam.runners.flink.translation.wrappers.streaming.WorkItemKeySelector
    at java.net.URLClassLoader.findClass(URLClassLoader.java:382)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)
    at org.apache.flink.runtime.execution.librarycache.FlinkUserCodeClassLoaders$ChildFirstClassLoader.loadClass(FlinkUserCodeClassLoaders.java:129)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:357)
    at java.lang.Class.forName0(Native Method)
    at java.lang.Class.forName(Class.java:348)
    at org.apache.flink.util.InstantiationUtil$ClassLoaderObjectInputStream.resolveClass(InstantiationUtil.java:78)
    at java.io.ObjectInputStream.readNonProxyDesc(ObjectInputStream.java:1868)
    at java.io.ObjectInputStream.readClassDesc(ObjectInputStream.java:1751)
    at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2042)
    at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1573)
    at java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:2287)
    at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2211)
    at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2069)
    at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1573)
    at java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:2287)
    at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2211)
    at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2069)
    at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1573)
    at java.io.ObjectInputStream.readObject(ObjectInputStream.java:431)
    at java.util.ArrayList.readObject(ArrayList.java:797)
    at sun.reflect.GeneratedMethodAccessor20.invoke(Unknown Source)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:498)
    at java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1170)
    at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2178)
    at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2069)
    at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1573)
    at java.io.ObjectInputStream.readObject(ObjectInputStream.java:431)
    at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:566)
    at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:552)
    at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:540)
    at org.apache.flink.util.InstantiationUtil.readObjectFromConfig(InstantiationUtil.java:501)
    at org.apache.flink.streaming.api.graph.StreamConfig.getOutEdgesInOrder(StreamConfig.java:395)
    ... 12 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13225821">FLINK-12101</key>
            <summary>Race condition when concurrently running uploaded jars via REST</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xleesf">leesf</assignee>
                                    <reporter username="mxm">Maximilian Michels</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 3 Apr 2019 13:47:52 +0000</created>
                <updated>Thu, 6 Jun 2019 14:17:54 +0000</updated>
                            <resolved>Thu, 6 Jun 2019 14:17:54 +0000</resolved>
                                    <version>1.6.4</version>
                    <version>1.7.2</version>
                                    <fixVersion>1.9.0</fixVersion>
                                    <component>Command Line Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16812390" author="till.rohrmann" created="Mon, 8 Apr 2019 12:28:09 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mxm&quot; class=&quot;user-hover&quot; rel=&quot;mxm&quot;&gt;mxm&lt;/a&gt;. Before starting the implementation work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xleesf&quot; class=&quot;user-hover&quot; rel=&quot;xleesf&quot;&gt;xleesf&lt;/a&gt;, I would like to first understand what the problem is. From the stack trace it looks as if the &lt;tt&gt;JarRunHandler&lt;/tt&gt; actually starts a &lt;tt&gt;MiniCluster&lt;/tt&gt; to execute the program. This is clearly wrong and should not happen. It looks as if the &lt;tt&gt;FlinkPipelineExecutionEnvironment&lt;/tt&gt; is responsible for this. Thus, I&apos;m actually wondering whether the &lt;tt&gt;FlinkRunner&lt;/tt&gt; might be resetting the &lt;tt&gt;ExecutionEnvironmentFactory&lt;/tt&gt; which was set by the &lt;tt&gt;JarRunHandler&lt;/tt&gt; to instantiate an &lt;tt&gt;OptimizerPlanEnvironment&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16812397" author="till.rohrmann" created="Mon, 8 Apr 2019 12:47:07 +0000"  >&lt;p&gt;Ok, I think I understand the problem now. The following sequence produces the problem:&lt;/p&gt;

&lt;p&gt;1. Job1 enter getOptimizedPlan&lt;span class=&quot;error&quot;&gt;&amp;#91;thread-1&amp;#93;&lt;/span&gt;: setAsContext(OptimizerPlanEnvironment) --&amp;gt; ctxEnvFactory = Optimizer&lt;br/&gt;
2. Job2 enter getOptimizedPlan&lt;span class=&quot;error&quot;&gt;&amp;#91;thread-2&amp;#93;&lt;/span&gt;: setAsContext(OptimizerPlanEnvironment) --&amp;gt; ctxEnvFactory = Optimizer&lt;br/&gt;
3. Job1 finish getOptimizedPlan&lt;span class=&quot;error&quot;&gt;&amp;#91;thread-1&amp;#93;&lt;/span&gt;: unsetContext --&amp;gt; ctxEnvFactory = null&lt;br/&gt;
4. Job2 enter invokeInteractiveModeForExecution &lt;span class=&quot;error&quot;&gt;&amp;#91;thread-2&amp;#93;&lt;/span&gt;: start execution with ctxEnvFactory = null --&amp;gt; Instantiate a &lt;tt&gt;LocalEnvironment&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The problem seems to be the static field &lt;tt&gt;ExecutionEnvironment#contextEnvironmentFactory&lt;/tt&gt; which is shared by all jobs. A quick fix could be to use thread local variables to set the &lt;tt&gt;ContextEnvironmentFactory&lt;/tt&gt;. In order to not break existing setups we could only respect the thread local variable if &lt;tt&gt;ExecutionEnvironment#contextEnvironmentFactory&lt;/tt&gt; is &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16812418" author="till.rohrmann" created="Mon, 8 Apr 2019 13:16:16 +0000"  >&lt;p&gt;The problem is more related to Flink&apos;s &lt;tt&gt;flink-clients&lt;/tt&gt; module because it can also happen if you try to submit multiple jobs from the same process when using multiple threads.&lt;/p&gt;</comment>
                            <comment id="16812467" author="mxm" created="Mon, 8 Apr 2019 14:25:42 +0000"  >&lt;p&gt;Thanks for taking the time to look into this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;. Your analysis is spot-on. The problem is that the static context environment variable can be accessed by multiple threads. The ThreadLocal static variable could be a simple and backwards-compatible fix.&lt;/p&gt;</comment>
                            <comment id="16847425" author="till.rohrmann" created="Fri, 24 May 2019 09:58:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xleesf&quot; class=&quot;user-hover&quot; rel=&quot;xleesf&quot;&gt;xleesf&lt;/a&gt; did you have time to work on a fix for this issue?&lt;/p&gt;</comment>
                            <comment id="16848316" author="xleesf" created="Sun, 26 May 2019 01:46:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&#160;Sorry for lately participating in, will provide a PR soon.&lt;/p&gt;</comment>
                            <comment id="16857736" author="till.rohrmann" created="Thu, 6 Jun 2019 14:17:54 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
ad801b9be6e6485c57e426d6fde0c499e3f9be1d&lt;br/&gt;
ac84e0c84dee39da7339722aad5ed2dcf26e2d27&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 23 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01ey0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>