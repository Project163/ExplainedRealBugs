<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:44:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2336] ArrayIndexOufOBoundsException in TypeExtractor when mapping</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2336</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The line that causes this is&lt;br/&gt;
DataStream&amp;lt;O&amp;gt; outputStream = insideIterationStream.filter(outputFilter).map(m -&amp;gt; m.outputMessage);&lt;/p&gt;

&lt;p&gt;Problem occurs both when compiled using Javac and Eclipse&apos;s JDT compiler (in an environment where simple lambda type tests work)&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;main&quot; java.lang.ArrayIndexOutOfBoundsException: -1&lt;br/&gt;
	at java.util.ArrayList.elementData(Unknown Source)&lt;br/&gt;
	at java.util.ArrayList.get(Unknown Source)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.TypeExtractor.createTypeInfoFromInputs(TypeExtractor.java:553)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.TypeExtractor.createTypeInfoWithTypeHierarchy(TypeExtractor.java:468)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.TypeExtractor.privateCreateTypeInfo(TypeExtractor.java:370)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.TypeExtractor.getUnaryOperatorReturnType(TypeExtractor.java:254)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.TypeExtractor.getMapReturnTypes(TypeExtractor.java:91)&lt;br/&gt;
	at org.apache.flink.streaming.api.datastream.DataStream.map(DataStream.java:605)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12843839">FLINK-2336</key>
            <summary>ArrayIndexOufOBoundsException in TypeExtractor when mapping</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maguowei">Guowei Ma</assignee>
                                    <reporter username="william-saar">William Saar</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>usability</label>
                    </labels>
                <created>Thu, 9 Jul 2015 11:25:03 +0000</created>
                <updated>Thu, 5 Mar 2020 09:10:41 +0000</updated>
                            <resolved>Thu, 5 Mar 2020 09:10:37 +0000</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>1.10.1</fixVersion>
                    <fixVersion>1.11.0</fixVersion>
                                    <component>API / Type Serialization System</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="14620345" author="william" created="Thu, 9 Jul 2015 11:29:58 +0000"  >&lt;p&gt;When replacing the lambda with a MapFunction instance, one gets the following clearer error message&lt;/p&gt;

&lt;p&gt;Caused by: org.apache.flink.api.common.functions.InvalidTypesException: Type of TypeVariable &apos;O&apos; in &apos;class ...&apos; could not be determined. This is most likely a type erasure problem. The type extraction currently supports types with generic variables only in cases where all variables in the return type can be deduced from the input type(s).&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.TypeExtractor.createTypeInfoWithTypeHierarchy(TypeExtractor.java:473)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.TypeExtractor.privateCreateTypeInfo(TypeExtractor.java:361)&lt;/p&gt;</comment>
                            <comment id="14620389" author="stephanewen" created="Thu, 9 Jul 2015 12:01:30 +0000"  >&lt;p&gt;Can you post a simpifies data type that reproduces this problem. Then we can make a patch to fix this!&lt;/p&gt;</comment>
                            <comment id="17044710" author="0x26dres" created="Tue, 25 Feb 2020 18:05:17 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;, I&apos;ve got a similar issue with flink 1.9.2. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ArrayIndexOutOfBoundsException: -1

	at java.util.ArrayList.elementData(ArrayList.java:422)
	at java.util.ArrayList.get(ArrayList.java:435)
	at org.apache.flink.api.java.typeutils.TypeExtractor.createTypeInfoFromInputs(TypeExtractor.java:956)
	at org.apache.flink.api.java.typeutils.TypeExtractor.createSubTypesInfo(TypeExtractor.java:1128)
	at org.apache.flink.api.java.typeutils.TypeExtractor.createTypeInfoWithTypeHierarchy(TypeExtractor.java:853)
	at org.apache.flink.api.java.typeutils.TypeExtractor.privateCreateTypeInfo(TypeExtractor.java:812)
	at org.apache.flink.api.java.typeutils.TypeExtractor.getUnaryOperatorReturnType(TypeExtractor.java:582)
	at org.apache.flink.api.java.typeutils.TypeExtractor.getMapReturnTypes(TypeExtractor.java:175)
	at org.apache.flink.api.java.DataSet.map(DataSet.java:216)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here&apos;s a simple unit test that can reproduce it. Only the first test (with Tuple1::of) fails. Other examples using lambdas work fine.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;FlinkLearningTest {

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; ExecutionEnvironment createLocalBatchEnvironment() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ExecutionEnvironment.createLocalEnvironment(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration());
  }

  @Test(expected = IndexOutOfBoundsException.class)
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testWithMethodReference() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    ExecutionEnvironment env = createLocalBatchEnvironment();
    env.fromCollection(ImmutableList.of(&lt;span class=&quot;code-quote&quot;&gt;&quot;FOO&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BAR&quot;&lt;/span&gt;))
        .map(Tuple1::of)
        .returns(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TypeHint&amp;lt;Tuple1&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt;() {})
        .print();
  }

  @Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testWithLambda() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

    ExecutionEnvironment env = StreamUtil.createLocalBatchEnvironment();
    env.fromCollection(ImmutableList.of(&lt;span class=&quot;code-quote&quot;&gt;&quot;FOO&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BAR&quot;&lt;/span&gt;))
        .map(p -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Tuple1&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(p))
        .returns(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TypeHint&amp;lt;Tuple1&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt;() {})
        .print();
  }

  @Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testWithDiamondLambda() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

    ExecutionEnvironment env = StreamUtil.createLocalBatchEnvironment();
    env.fromCollection(ImmutableList.of(&lt;span class=&quot;code-quote&quot;&gt;&quot;FOO&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BAR&quot;&lt;/span&gt;))
        .map(p -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Tuple1&amp;lt;&amp;gt;(p))
        .returns(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TypeHint&amp;lt;Tuple1&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt;() {})
        .print();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17045400" author="stephanewen" created="Wed, 26 Feb 2020 11:22:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maguowei&quot; class=&quot;user-hover&quot; rel=&quot;maguowei&quot;&gt;maguowei&lt;/a&gt; Maybe this is interesting to you?&lt;/p&gt;</comment>
                            <comment id="17045473" author="maguowei" created="Wed, 26 Feb 2020 12:03:24 +0000"  >&lt;p&gt;OK I could follow this. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17045593" author="maguowei" created="Wed, 26 Feb 2020 14:46:50 +0000"  >&lt;p&gt;The reason why the first test throws IndexOutOfBoundsException is that when using the input to infer the output type, the type hierarchy array length is 0. In this case, null should be returned in advance(TypeExtractor.java:956).&lt;/p&gt;

&lt;p&gt;The reason why the next two tests did not throw an exception is that the types of these two lambdas have been erased, which is different from the branch the first test took.&lt;/p&gt;

&lt;p&gt;A simple modification is to add a line in TypeExtractor.java:956 to determine if the length of inputTypeHierarchy is 0 and return null in advance.&lt;/p&gt;

&lt;p&gt;Theoretically speaking, the first type of the lambda is not type erased, so we could infer the output through Input. In other words, we can build a custom ParameterizedType with rawtype = MapFunction.class and acutalTypeArguments as the lambda input and output. However, this requires the introduction of a custom ParameterizedType, and I feel we can wait until the TypeExtractor is refactored.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17045664" author="stephanewen" created="Wed, 26 Feb 2020 16:18:32 +0000"  >&lt;p&gt;Thank you for the detailed diagnosis.&lt;/p&gt;

&lt;p&gt;I agree that a quick fix now makes sense, and deferring a real fix to when the TypeExtractor is refactored, to avoid double work.&lt;/p&gt;</comment>
                            <comment id="17051930" author="stephanewen" created="Thu, 5 Mar 2020 09:10:37 +0000"  >&lt;p&gt;Fixed in&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Master (1.11.0) via cc75e01abcb6b6eed50591c94db9e2a26f179518&lt;/li&gt;
	&lt;li&gt;1.10.1 via 4ba39c1b5f144dc8925aaf821e4cc2a233375bbf&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 36 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2h1qn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>