<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:11:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-28843] Fail to find incremental handle when restoring from changelog checkpoint in claim mode</title>
                <link>https://issues.apache.org/jira/browse/FLINK-28843</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;ol&gt;
	&lt;li&gt;When native checkpoint is enabled and incremental checkpointing is enabled in rocksdb statebackend&#65292;if state data is greater than state.storage.fs.memory-threshold&#65292;it will be stored in a data file (FileStateHandle&#65292;RelativeFileStateHandle, etc) rather than stored with ByteStreamStateHandle in checkpoint metadata, like base-path1/chk-1/file1.&lt;/li&gt;
	&lt;li&gt;Then restore the job from base-path1/chk-1 in claim mode&#65292;using changelog statebackend&#65292;and the checkpoint path is set to base-path2, then new checkpoint will be saved in base-path2/chk-2, previous checkpoint file (base-path1/chk-1/file1) is needed.&lt;/li&gt;
	&lt;li&gt;Then restore the job from base-path2/chk-2 in changelog statebackend, flink will try to read base-path2/chk-2/file1, rather than the actual file location base-path1/chk-1/file1, which leads to FileNotFoundException and job failed.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;br/&gt;
How to reproduce?&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Set state.storage.fs.memory-threshold to a small value, like &apos;20b&apos;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;run org.apache.flink.test.checkpointing.ChangelogPeriodicMaterializationSwitchStateBackendITCase#testSwitchFromDisablingToEnablingInClaimMode&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13475516">FLINK-28843</key>
            <summary>Fail to find incremental handle when restoring from changelog checkpoint in claim mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frozen stone">Lihe Ma</assignee>
                                    <reporter username="frozen stone">Lihe Ma</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sat, 6 Aug 2022 03:09:56 +0000</created>
                <updated>Tue, 9 Aug 2022 03:10:06 +0000</updated>
                            <resolved>Tue, 9 Aug 2022 03:10:06 +0000</resolved>
                                    <version>1.15.0</version>
                    <version>1.15.1</version>
                                    <fixVersion>1.16.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17576147" author="yunta" created="Sat, 6 Aug 2022 06:24:52 +0000"  >&lt;p&gt;Thanks for reporting this bug!&lt;/p&gt;

&lt;p&gt;The root cause is that the native savepoint could contain the relative file state handles (all files under &lt;tt&gt;chk-x&lt;/tt&gt; folder would be &lt;tt&gt;RelativeFileStateHandle&lt;/tt&gt;), and the snapshot on changelog state-backend might not trigger the materialization part, which leads to the newly created &lt;tt&gt;chk-y&lt;/tt&gt; folder does not contain previous snapshots. Thus, once restoring from &lt;tt&gt;chk-y&lt;/tt&gt;, relocatable &lt;tt&gt;chk-x/file-1&lt;/tt&gt; would be transferred to &lt;tt&gt;chk-y/file-1&lt;/tt&gt;, resulting in the file not found exception.&lt;/p&gt;

&lt;p&gt;Since we already give docs that native savepoint is relocatable (refer to &lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/ops/state/checkpoints_vs_savepoints/#capabilities-and-limitations&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/ops/state/checkpoints_vs_savepoints/#capabilities-and-limitations&lt;/a&gt; ), we might have to let changelog state-backend trigger materialization on the 1st checkpoint if restored snapshot containing relative file state handles. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ym&quot; class=&quot;user-hover&quot; rel=&quot;ym&quot;&gt;ym&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Yanfei+Lei&quot; class=&quot;user-hover&quot; rel=&quot;Yanfei Lei&quot;&gt;Yanfei Lei&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17576403" author="frozen stone" created="Sun, 7 Aug 2022 15:21:53 +0000"  >&lt;p&gt;I think the root cause is that IncrementalKeyedStateHandle&#160; is not handled properly, only KeyGroupsStateHandle will be cast to absolute path during restore, maybe we could fix this by casting&#160; IncrementalRemoteKeyedStateHandle in the same way.&#160;&lt;/p&gt;</comment>
                            <comment id="17576495" author="yunta" created="Mon, 8 Aug 2022 02:22:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frozen+stone&quot; class=&quot;user-hover&quot; rel=&quot;frozen stone&quot;&gt;frozen stone&lt;/a&gt; I noticed that &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25872&quot; title=&quot;Restoring from non-changelog checkpoint with changelog state-backend enabled in CLAIM mode discards state in use&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25872&quot;&gt;&lt;del&gt;FLINK-25872&lt;/del&gt;&lt;/a&gt; has considered such cases via introducing &lt;tt&gt;ChangelogStateBackendHandle#castToAbsolutePath&lt;/tt&gt;, unfortunately, it just forget to cover the native savepoint of RocksDB state-backend.&#160;&lt;/p&gt;</comment>
                            <comment id="17576502" author="yanfei lei" created="Mon, 8 Aug 2022 02:36:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frozen+stone&quot; class=&quot;user-hover&quot; rel=&quot;frozen stone&quot;&gt;frozen stone&lt;/a&gt; Thanks for reporting this bug! I think your analysis is correct, I had assumed that all &#160;IncrementalKeyedStateHandle were located in /shared, and forgot the private handles of IncrementalKeyedStateHandle are located in /chk-x.&#160;&lt;/p&gt;</comment>
                            <comment id="17577106" author="yunta" created="Tue, 9 Aug 2022 03:10:06 +0000"  >&lt;p&gt;merged in master: 7f708d0ba42f727b3f8c3d77cef2108206cad2de&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13425462">FLINK-25872</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13473665">FLINK-28699</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 14 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17jb4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>