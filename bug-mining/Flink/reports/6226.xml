<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:09:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-25992] JobDispatcherITCase.testRecoverFromCheckpointAfterLosingAndRegainingLeadership fails on azure</title>
                <link>https://issues.apache.org/jira/browse/FLINK-25992</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=30871&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=24c3384f-1bcb-57b3-224f-51bf973bbee8&amp;amp;l=9154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=30871&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=24c3384f-1bcb-57b3-224f-51bf973bbee8&amp;amp;l=9154&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
19:41:35,515 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-9] WARN  org.apache.flink.runtime.taskmanager.Task                    [] - jobVertex (1/1)#0 (7efdea21f5f95490e02117063ce8a314) switched from RUNNING to FAILED with failure cause: java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; notify checkpoint ABORT.
	at org.apache.flink.runtime.taskmanager.Task.notifyCheckpoint(Task.java:1457)
	at org.apache.flink.runtime.taskmanager.Task.notifyCheckpointAborted(Task.java:1407)
	at org.apache.flink.runtime.taskexecutor.TaskExecutor.abortCheckpoint(TaskExecutor.java:1021)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.lambda$handleRpcInvocation$1(AkkaRpcActor.java:316)
	at org.apache.flink.runtime.concurrent.akka.ClassLoadingUtils.runWithContextClassLoader(ClassLoadingUtils.java:83)
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcInvocation(AkkaRpcActor.java:314)
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:217)
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleMessage(AkkaRpcActor.java:163)
	at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:24)
	at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:20)
	at scala.PartialFunction.applyOrElse(PartialFunction.scala:123)
	at scala.PartialFunction.applyOrElse$(PartialFunction.scala:122)
	at akka.japi.pf.UnitCaseStatement.applyOrElse(CaseStatements.scala:20)
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171)
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:172)
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:172)
	at akka.actor.Actor.aroundReceive(Actor.scala:537)
	at akka.actor.Actor.aroundReceive$(Actor.scala:535)
	at akka.actor.AbstractActor.aroundReceive(AbstractActor.scala:220)
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:580)
	at akka.actor.ActorCell.invoke(ActorCell.scala:548)
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:270)
	at akka.dispatch.Mailbox.run(Mailbox.scala:231)
	at akka.dispatch.Mailbox.exec(Mailbox.scala:243)
	at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
	at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)
	at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)
	at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:175)
Caused by: java.lang.UnsupportedOperationException: notifyCheckpointAbortAsync not supported by org.apache.flink.runtime.dispatcher.JobDispatcherITCase$AtLeastOneCheckpointInvokable
	at org.apache.flink.runtime.jobgraph.tasks.AbstractInvokable.notifyCheckpointAbortAsync(AbstractInvokable.java:205)
	at org.apache.flink.runtime.taskmanager.Task.notifyCheckpoint(Task.java:1430)
	... 31 more

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13427030">FLINK-25992</key>
            <summary>JobDispatcherITCase.testRecoverFromCheckpointAfterLosingAndRegainingLeadership fails on azure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Jiangang">Liu</assignee>
                                    <reporter username="roman">Roman Khachatryan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Mon, 7 Feb 2022 20:58:17 +0000</created>
                <updated>Fri, 18 Feb 2022 15:22:10 +0000</updated>
                            <resolved>Fri, 18 Feb 2022 15:22:10 +0000</resolved>
                                    <version>1.15.0</version>
                                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17488431" author="roman_khachatryan" created="Mon, 7 Feb 2022 21:01:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jiangang&quot; class=&quot;user-hover&quot; rel=&quot;Jiangang&quot;&gt;Jiangang&lt;/a&gt; could you please take a look?&lt;/p&gt;</comment>
                            <comment id="17488622" author="jiangang" created="Tue, 8 Feb 2022 06:43:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; Thanks for the report. Indeed, the class AtLeastOneCheckpointInvokable doesn&apos;t override the method notifyCheckpointAbortAsync. Since the code &apos;&lt;/p&gt;

&lt;p&gt;AtLeastOneCheckpointInvokable.atLeastOneCheckpointCompleted.await();&lt;/p&gt;

&lt;p&gt;&apos; is finished, there must be one complete checkpoint to recover later. I am confused with the AssertionError. The case is hard to reproduce in my local host. Can you show me the full log?&lt;/p&gt;</comment>
                            <comment id="17488648" author="roman_khachatryan" created="Tue, 8 Feb 2022 07:56:26 +0000"  >&lt;p&gt;Sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jiangang&quot; class=&quot;user-hover&quot; rel=&quot;Jiangang&quot;&gt;Jiangang&lt;/a&gt;, I&apos;ve attached the log file (you can also download it from the build main page following the artifacts link).&lt;/p&gt;</comment>
                            <comment id="17489297" author="jiangang" created="Wed, 9 Feb 2022 07:15:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; I am afraid that the reason is still uncertain from the log. From the log, the processing is as following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;When the first checkpoint expired, the UnsupportedOperationException is thrown and the job restarts.&lt;/li&gt;
	&lt;li&gt;The job is running and checkpoint 2 is done.&lt;/li&gt;
	&lt;li&gt;The leadership changes and the job restores from checkpoint 2.&lt;/li&gt;
	&lt;li&gt;We check that the restored checkpoint is not null.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I reproduce the processing in my local host but the test is still ok. So the UnsupportedOperationException will not cause the test fail. Other two things can be optimized as following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Implement the method notifyCheckpointAbortAsync.&lt;/li&gt;
	&lt;li&gt;Tune the checkpoint timeout to 1000 to avoid the failed checkpoint.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;But I am not sure whether the optimization can resolve the issue.&lt;/p&gt;</comment>
                            <comment id="17490043" author="roman_khachatryan" created="Thu, 10 Feb 2022 08:47:12 +0000"  >&lt;p&gt;Thanks for looking into it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jiangang&quot; class=&quot;user-hover&quot; rel=&quot;Jiangang&quot;&gt;Jiangang&lt;/a&gt;. The conclusion and proposed changes make sense to me.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Regarding the test failure, probably the root cause is in obtaining the StatsSnapshot on &lt;a href=&quot;https://github.com/apache/flink/blob/f5819cec01eab914e8d4e7db41587b715a557e3b/flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/JobDispatcherITCase.java#L143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line 143&lt;/a&gt; of JobDispatcherITCase: the check is made only once.&lt;/p&gt;

&lt;p&gt;At &lt;a href=&quot;https://github.com/apache/flink/blob/f5819cec01eab914e8d4e7db41587b715a557e3b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointStatsTracker.java#L122&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line 122&lt;/a&gt; of CheckpointStatsTracker, it checks if there is no update in progress; if there IS then it doesn&apos;t update the snapshot, and client receives the initial snapshot (with empty restoredCheckpoint); which fails the test.&lt;/p&gt;

&lt;p&gt;If that&apos;s the cause then JobDispatcherITCase should probably repeat this request until success or deadline.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="17490624" author="jiangang" created="Fri, 11 Feb 2022 01:51:42 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; . I have check the code and the log. When the job restores from the checkpoint 2, the method reportRestoredCheckpoint in CheckpointStatsTracker is called . So there is update in progress and the member dirty is set true. In method createSnapshot, only when statsReadWriteLock.tryLock() is false then snapshot will not be updated. Additionally, the method createSnapshot is also triggered when awaiting job status in line 138&#160; of JobDispatcherITCase.&#160;&lt;/p&gt;

&lt;p&gt;Based on the above info, it is hard to get the root reason. Your suggestion is valuable. But I am not sure wether it can resolve the problem thoroughly. What do you think?&lt;/p&gt;</comment>
                            <comment id="17492018" author="roman_khachatryan" created="Mon, 14 Feb 2022 14:23:32 +0000"  >&lt;p&gt;I think that the race condition is possible, and that race condition can be a root cause. &lt;br/&gt;
It&apos;s hard to say whether that is actually what happened in that particular case, but I&apos;d fix it anyways.&lt;br/&gt;
If the issue remains after that, we could re-open the ticket and continue the investigation.&lt;/p&gt;</comment>
                            <comment id="17492389" author="jiangang" created="Tue, 15 Feb 2022 06:47:01 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt;. Retry is a good way to avoid the race condition. If we have no other findings, this is an effect way to make the test stable. If so, I would like to fix it.&lt;/p&gt;</comment>
                            <comment id="17492415" author="roman_khachatryan" created="Tue, 15 Feb 2022 07:45:05 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jiangang&quot; class=&quot;user-hover&quot; rel=&quot;Jiangang&quot;&gt;Jiangang&lt;/a&gt;, that would be great!&lt;/p&gt;

&lt;p&gt;I&apos;ve assigned the ticket to you.&lt;/p&gt;</comment>
                            <comment id="17492956" author="jiangang" created="Wed, 16 Feb 2022 02:12:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; Fixed. Please take time to review the code. Thanks.&lt;/p&gt;</comment>
                            <comment id="17494669" author="roman_khachatryan" created="Fri, 18 Feb 2022 15:22:10 +0000"  >&lt;p&gt;Thanks for the fix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jiangang&quot; class=&quot;user-hover&quot; rel=&quot;Jiangang&quot;&gt;Jiangang&lt;/a&gt;, merged into master as a060302379a7a53fe10f699625e36245e6a90d50.&lt;br/&gt;
I think it should prevent any further test failures and going to close the ticket.&lt;br/&gt;
If not, please feel free to reopen the ticket.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13039758" name="mvn-2.log" size="51306548" author="roman" created="Tue, 8 Feb 2022 07:55:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 38 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0zbwo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>