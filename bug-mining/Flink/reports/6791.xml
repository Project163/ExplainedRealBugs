<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:15:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-29099] Deadlock for Single Subtask in Kinesis Consumer</title>
                <link>https://issues.apache.org/jira/browse/FLINK-29099</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Deadlock is reached as the result of:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;max lookahead reached for local watermark&lt;/li&gt;
	&lt;li&gt;idle state for subtask&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The lookahead prevents the RecordEmitter from emitting a new record. The idle state prevents the global watermark from being updated.&lt;/p&gt;

&lt;p&gt;To exit this deadlock state, we need to complete the &lt;a href=&quot;https://github.com/apache/flink/blob/221d70d9930f72147422ea24b399f006ebbfb8d7/flink-connectors/flink-connector-kinesis/src/main/java/org/apache/flink/streaming/connectors/kinesis/internals/KinesisDataFetcher.java#L1268&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TODO here&lt;/a&gt; which updates the global watermark while the subtask is marked idle, which will then allow us to emit a record again as the lookahead is no longer reached.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Context:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;We reached this scenario at Lyft as a result of prolonged CPU throttling on all FlinkKinesisConsumer threads for multiple minutes.&lt;/p&gt;

&lt;p&gt;Walking through the series of events for a single subtask:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;prolonged CPU throttling occurs and no logs are seen from any FlinkKinesisConsumer thread for up to 15 minutes&lt;/li&gt;
	&lt;li&gt;after CPU throttling the subtask is marked idle&lt;/li&gt;
	&lt;li&gt;the subtask has reached the lookahead for its local watermark relative to the global watermark&lt;/li&gt;
	&lt;li&gt;WatermarkSyncCallback indicates the subtask as idle and does not update the global watermark&lt;/li&gt;
	&lt;li&gt;emitQueue fills to max&lt;/li&gt;
	&lt;li&gt;RecordEmitter cannot emit records due to the max lookahead&lt;/li&gt;
	&lt;li&gt;Deadlock on subtask&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;At this point, we had not realized what had happened and processing of all other shards/subtasks had continued for multiple days. When we finally restarted the application, we saw the following behavior:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;global watermark recalculated after all subtasks consumed data based on the last kinesis record sequence number&lt;/li&gt;
	&lt;li&gt;global watermark moved back in time multiple days, to when the subtask was first marked idle&lt;/li&gt;
	&lt;li&gt;the single subtask processed data while all others remained idle due to the lookahead&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This would have continued until the subtask had caught up to the others and thus the global watermark is within reach of the lookahead for other subtasks.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Repro:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Too difficult to repro the exact scenario.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13478475">FLINK-29099</key>
            <summary>Deadlock for Single Subtask in Kinesis Consumer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sethsaperstein">seth saperstein</assignee>
                                    <reporter username="sethsaperstein">seth saperstein</reporter>
                        <labels>
                            <label>connector</label>
                            <label>consumer</label>
                            <label>kinesis</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 24 Aug 2022 19:05:06 +0000</created>
                <updated>Mon, 28 Nov 2022 23:37:01 +0000</updated>
                            <resolved>Mon, 28 Nov 2022 23:36:11 +0000</resolved>
                                    <version>1.9.3</version>
                    <version>1.10.3</version>
                    <version>1.11.6</version>
                    <version>1.12.7</version>
                    <version>1.13.6</version>
                    <version>1.14.5</version>
                    <version>1.15.3</version>
                                    <fixVersion>1.17.0</fixVersion>
                                    <component>Connectors / Kinesis</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                            <timeestimate seconds="172800">48h</timeestimate>
                                        <comments>
                            <comment id="17598071" author="premsantosh" created="Tue, 30 Aug 2022 20:55:36 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasWeise&quot; class=&quot;user-hover&quot; rel=&quot;thomasWeise&quot;&gt;thomasWeise&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17640298" author="thw" created="Mon, 28 Nov 2022 23:37:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sethsaperstein&quot; class=&quot;user-hover&quot; rel=&quot;sethsaperstein&quot;&gt;sethsaperstein&lt;/a&gt; thanks for the thorough investigation and fix!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z181g0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>