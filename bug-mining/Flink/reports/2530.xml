<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8731] TwoInputStreamTaskTest flaky on travis</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8731</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/zentol/flink/builds/344307861&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/zentol/flink/builds/344307861&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Tests run: 5, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 2.479 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.flink.streaming.runtime.tasks.TwoInputStreamTaskTest
testOpenCloseAndTimestamps(org.apache.flink.streaming.runtime.tasks.TwoInputStreamTaskTest)  Time elapsed: 0.05 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.Exception: error in task
	at org.apache.flink.streaming.runtime.tasks.StreamTaskTestHarness.waitForTaskCompletion(StreamTaskTestHarness.java:250)
	at org.apache.flink.streaming.runtime.tasks.StreamTaskTestHarness.waitForTaskCompletion(StreamTaskTestHarness.java:233)
	at org.apache.flink.streaming.runtime.tasks.TwoInputStreamTaskTest.testOpenCloseAndTimestamps(TwoInputStreamTaskTest.java:99)
Caused by: org.mockito.exceptions.misusing.WrongTypeOfReturnValue: 
&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; cannot be returned by getChannelIndex()
getChannelIndex() should &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
***
If you&lt;span class=&quot;code-quote&quot;&gt;&apos;re unsure why you&apos;&lt;/span&gt;re getting above error read on.
Due to the nature of the syntax above problem might occur because:
1. This exception *might* occur in wrongly written multi-threaded tests.
   Please refer to Mockito FAQ on limitations of concurrency testing.
2. A spy is stubbed using when(spy.foo()).then() syntax. It is safer to stub spies - 
   - with doReturn|Throw() family of methods. More in javadocs &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Mockito.spy() method.

	at org.apache.flink.runtime.io.network.partition.consumer.UnionInputGate.waitAndGetNextInputGate(UnionInputGate.java:212)
	at org.apache.flink.runtime.io.network.partition.consumer.UnionInputGate.getNextBufferOrEvent(UnionInputGate.java:158)
	at org.apache.flink.streaming.runtime.io.BarrierBuffer.getNextNonBlocked(BarrierBuffer.java:164)
	at org.apache.flink.streaming.runtime.io.StreamTwoInputProcessor.processInput(StreamTwoInputProcessor.java:292)
	at org.apache.flink.streaming.runtime.tasks.TwoInputStreamTask.run(TwoInputStreamTask.java:115)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:308)
	at org.apache.flink.streaming.runtime.tasks.StreamTaskTestHarness$TaskThread.run(StreamTaskTestHarness.java:437)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13139929">FLINK-8731</key>
            <summary>TwoInputStreamTaskTest flaky on travis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dwysakowicz">Dawid Wysakowicz</assignee>
                                    <reporter username="chesnay">Chesnay Schepler</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Wed, 21 Feb 2018 15:53:05 +0000</created>
                <updated>Thu, 28 Feb 2019 10:46:00 +0000</updated>
                            <resolved>Mon, 16 Jul 2018 12:30:58 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.2</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16419195" author="till.rohrmann" created="Thu, 29 Mar 2018 15:28:34 +0000"  >&lt;p&gt;Unblocking 1.5.0 since it seems to be a test setup problem with &lt;tt&gt;Mockito&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16544632" author="githubbot" created="Sun, 15 Jul 2018 18:44:01 +0000"  >&lt;p&gt;GitHub user dawidwys opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6338&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8731&quot; title=&quot;TwoInputStreamTaskTest flaky on travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8731&quot;&gt;&lt;del&gt;FLINK-8731&lt;/del&gt;&lt;/a&gt; Replaced mockito with custom mock in TestInputChannel&lt;/p&gt;

&lt;p&gt;    Replaced questionable usage if Mockito with custom written mock. &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dawidwys/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dawidwys/flink&lt;/a&gt; test-mock-lock&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6338.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6338.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6338&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit a2c78e6193c57bb69fc6f7d7b629ef0ec47171bb&lt;br/&gt;
Author: Dawid Wysakowicz &amp;lt;dwysakowicz@...&amp;gt;&lt;br/&gt;
Date:   2018-07-12T14:17:48Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8731&quot; title=&quot;TwoInputStreamTaskTest flaky on travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8731&quot;&gt;&lt;del&gt;FLINK-8731&lt;/del&gt;&lt;/a&gt; Replaced mockito with custom mock in TestInputChannel&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16544956" author="githubbot" created="Mon, 16 Jul 2018 08:42:01 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6338#discussion_r202606214&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6338#discussion_r202606214&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/TestInputChannel.java &amp;#8212;&lt;br/&gt;
    @@ -81,26 +72,21 @@ public TestInputChannel readBuffer(boolean moreAvailable) throws IOException, In&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	public TestInputChannel readEndOfPartitionEvent() throws IOException, InterruptedException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Answer&amp;lt;Optional&amp;lt;BufferAndAvailability&amp;gt;&amp;gt; answer = new Answer&amp;lt;Optional&amp;lt;BufferAndAvailability&amp;gt;&amp;gt;() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public Optional&amp;lt;BufferAndAvailability&amp;gt; answer(InvocationOnMock invocationOnMock) throws Throwable {&lt;/li&gt;
	&lt;li&gt;// Return true after finishing&lt;/li&gt;
	&lt;li&gt;when(mock.isReleased()).thenReturn(true);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;return Optional.of(new BufferAndAvailability(EventSerializer.toBuffer(EndOfPartitionEvent.INSTANCE), false, 0));&lt;br/&gt;
    +		mock.addBufferAndAvailability(&lt;br/&gt;
    +			new BufferAvailabilityProvider() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				@Override    +				public Optional&amp;lt;BufferAndAvailability&amp;gt; getBufferAvailability() throws IOException, InterruptedException {
    +					mock.setReleased();
    +					return Optional.of(new BufferAndAvailability(EventSerializer.toBuffer(EndOfPartitionEvent.INSTANCE),
    +						false,
    +						0));
    +				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;};&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (stubbing == null) 
{
    -			stubbing = when(mock.getNextBuffer()).thenAnswer(answer);
    -		}
&lt;p&gt; else &lt;/p&gt;
{
    -			stubbing = stubbing.thenAnswer(answer);
    -		}
&lt;p&gt;    -&lt;br/&gt;
    +		);&lt;br/&gt;
     		return this;&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public InputChannel getInputChannel() {&lt;br/&gt;
    +	public MockInputChannel getInputChannel() {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    It would be good if we could get by without exposing the mock. As far as i can tell on GitHub the only usages of `MockInputChannel` methods outside of this class are in `StreamTestSingleInputGate`:&lt;br/&gt;
    ```inputChannels&lt;span class=&quot;error&quot;&gt;&amp;#91;channelIndex&amp;#93;&lt;/span&gt;.getInputChannel().addBufferAndAvailability(answer);```&lt;br/&gt;
    ```inputChannels&lt;span class=&quot;error&quot;&gt;&amp;#91;channelIndex&amp;#93;&lt;/span&gt;.getInputChannel().setReleased();```&lt;/p&gt;

&lt;p&gt;    Since the `TestInputChannel` class is already accessed anyway we could move these methods to the TestChannel class.&lt;/p&gt;

&lt;p&gt;    Note that currently this exposes a package-private class with a public method, which means that anyone without package-private access will get a compile error. Either make this method package private, or make the class public.&lt;/p&gt;</comment>
                            <comment id="16544957" author="githubbot" created="Mon, 16 Jul 2018 08:42:01 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6338#discussion_r202604951&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6338#discussion_r202604951&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/TestInputChannel.java &amp;#8212;&lt;br/&gt;
    @@ -125,4 +111,79 @@ public InputChannel getInputChannel() &lt;/p&gt;
{
     
     		return mocks;
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	interface BufferAvailabilityProvider &lt;/p&gt;
{
    +		Optional&amp;lt;BufferAndAvailability&amp;gt; getBufferAvailability() throws IOException, InterruptedException;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class MockInputChannel extends InputChannel {&lt;br/&gt;
    +&lt;br/&gt;
    +		MockInputChannel(&lt;br/&gt;
    +			SingleInputGate inputGate,&lt;br/&gt;
    +			int channelIndex) &lt;/p&gt;
{
    +			super(inputGate, channelIndex, new ResultPartitionID(), 0, 0, new SimpleCounter());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		private final Queue&amp;lt;BufferAvailabilityProvider&amp;gt; buffers = new ConcurrentLinkedQueue&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		private BufferAvailabilityProvider lastProvider = null;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    move fields above constructor&lt;/p&gt;</comment>
                            <comment id="16545112" author="githubbot" created="Mon, 16 Jul 2018 12:00:55 +0000"  >&lt;p&gt;Github user dawidwys commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6338&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    merging&lt;/p&gt;</comment>
                            <comment id="16545115" author="githubbot" created="Mon, 16 Jul 2018 12:04:17 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6338&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16545116" author="dawidwys" created="Mon, 16 Jul 2018 12:06:22 +0000"  >&lt;p&gt;I&apos;ve replaced the mockito usage that was failing, therefore it should not occur any more.&lt;/p&gt;</comment>
                            <comment id="16545120" author="zentol" created="Mon, 16 Jul 2018 12:10:49 +0000"  >&lt;p&gt;Lets mark it as fixed then.&lt;/p&gt;</comment>
                            <comment id="16545141" author="dawidwys" created="Mon, 16 Jul 2018 12:27:27 +0000"  >&lt;p&gt;Sure, were about to do it, just was wondering if I should merge it to 1.5 branch as well.&lt;/p&gt;</comment>
                            <comment id="16545151" author="zentol" created="Mon, 16 Jul 2018 12:35:03 +0000"  >&lt;p&gt;We should merge this to 1.5 so we don&apos;t chase test failures on that branch.&lt;/p&gt;</comment>
                            <comment id="16545163" author="dawidwys" created="Mon, 16 Jul 2018 12:41:15 +0000"  >&lt;p&gt;Fixed in 1.5 via 15e4939833e7a4c9a5cf2a97bb7368ebd17ed0cc&lt;br/&gt;
Fixed in 1.6 via 010f6654709d2212f3d81c7ad73c73f7ebd47ea8&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13172041">FLINK-9847</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 18 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qfbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>