<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:36:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10419] ClassNotFoundException while deserializing user exceptions from checkpointing</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10419</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;It seems that somewhere in the operator&apos;s failure handling, we hand a user-code exception to the checkpoint coordinator via Java serialization but it will then fail during the de-serialization because the class is not available. This will result in the following error shadowing the real one:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ClassNotFoundException: org.apache.flink.streaming.connectors.kafka.FlinkKafka011Exception
        at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:424)
        at sun.misc.Launcher.loadClass(Launcher.java:338)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:357)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:348)
        at org.apache.flink.util.InstantiationUtil.resolveClass(InstantiationUtil.java:76)
        at java.io.ObjectInputStream.readNonProxyDesc(ObjectInputStream.java:1859)
        at java.io.ObjectInputStream.readClassDesc(ObjectInputStream.java:1745)
        at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2033)
        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1567)
        at java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:2278)
        at java.io.ObjectInputStream.defaultReadObject(ObjectInputStream.java:557)
        at java.lang.Throwable.readObject(Throwable.java:914)
        at sun.reflect.GeneratedMethodAccessor158.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1158)
        at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2169)
        at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2060)
        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1567)
        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:427)
        at org.apache.flink.runtime.rpc.messages.RemoteRpcInvocation.readObject(RemoteRpcInvocation.java:222)
        at sun.reflect.GeneratedMethodAccessor7.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1158)
        at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2169)
        at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2060)
        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1567)
        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:427)
        at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:502)
        at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:489)
        at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:477)
        at org.apache.flink.util.SerializedValue.deserializeValue(SerializedValue.java:58)
        at org.apache.flink.runtime.rpc.messages.RemoteRpcInvocation.deserializeMethodInvocation(RemoteRpcInvocation.java:118)
        at org.apache.flink.runtime.rpc.messages.RemoteRpcInvocation.getMethodName(RemoteRpcInvocation.java:59)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcInvocation(AkkaRpcActor.java:214)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:162)
        at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleRpcMessage(FencedAkkaRpcActor.java:70)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.onReceive(AkkaRpcActor.java:142)
        at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.onReceive(FencedAkkaRpcActor.java:40)
        at akka.actor.UntypedActor3728anonfun.applyOrElse(UntypedActor.scala:165)
        at akka.actor.Actor.aroundReceive(Actor.scala:502)
        at akka.actor.UntypedActor.aroundReceive(UntypedActor.scala:95)
        at akka.actor.ActorCell.receiveMessage(ActorCell.scala:526)
        at akka.actor.ActorCell.invoke(ActorCell.scala:495)
        at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:257)
        at akka.dispatch.Mailbox.run(Mailbox.scala:224)
        at akka.dispatch.Mailbox.exec(Mailbox.scala:234)
        at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
        at scala.concurrent.forkjoin.ForkJoinPool.runTask(ForkJoinPool.java:1339)
        at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
        at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13187266">FLINK-10419</key>
            <summary>ClassNotFoundException while deserializing user exceptions from checkpointing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dwysakowicz">Dawid Wysakowicz</assignee>
                                    <reporter username="nkruber">Nico Kruber</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 25 Sep 2018 11:29:22 +0000</created>
                <updated>Thu, 15 Nov 2018 08:52:45 +0000</updated>
                            <resolved>Thu, 15 Nov 2018 08:52:45 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.5.1</version>
                    <version>1.5.2</version>
                    <version>1.5.3</version>
                    <version>1.5.4</version>
                    <version>1.6.0</version>
                    <version>1.6.1</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.5.6</fixVersion>
                    <fixVersion>1.6.3</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16630660" author="nicok" created="Thu, 27 Sep 2018 15:56:11 +0000"  >&lt;p&gt;The initial error on the task managers leading to the error above apparently was the following, based on a too low Kafka brokers&apos; timeout for the transactions to commit:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
        at org.apache.flink.runtime.taskmanager.Task.run(Task.java:1258)
        at java.util.concurrent.Executors.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor.run(ThreadPoolExecutor.java:624)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: org.apache.kafka.common.errors.ProducerFencedException: Producer attempted an operation with an old epoch. Either there is a newer producer with the same transactionalId, or the producer&apos;s transaction has been expired by the broker.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16632161" author="xeli" created="Fri, 28 Sep 2018 17:33:35 +0000"  >&lt;p&gt;I have actually run into a very similar exception while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9311&quot; title=&quot;Add a Google Cloud PubSub connector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9311&quot;&gt;&lt;del&gt;FLINK-9311&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NoClassDefFoundError: io/grpc/netty/shaded/io/grpc/netty/NettyClientTransport$6
at io.grpc.netty.shaded.io.grpc.netty.NettyClientTransport.shutdownNow(NettyClientTransport.java:287)
at io.grpc.internal.KeepAliveManager$ClientKeepAlivePinger.onPingTimeout(KeepAliveManager.java:282)
at io.grpc.internal.KeepAliveManager$1.run(KeepAliveManager.java:58)
at io.grpc.internal.LogExceptionRunnable.run(LogExceptionRunnable.java:41)
at io.grpc.netty.shaded.io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)
at io.grpc.netty.shaded.io.netty.util.concurrent.ScheduledFutureTask.run(ScheduledFutureTask.java:125)
at io.grpc.netty.shaded.io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163)
at io.grpc.netty.shaded.io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:404)
at io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:465)
at io.grpc.netty.shaded.io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:884)
at io.grpc.netty.shaded.io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.ClassNotFoundException: io.grpc.netty.shaded.io.grpc.netty.NettyClientTransport$6
at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:424)
at org.apache.flink.runtime.execution.librarycache.FlinkUserCodeClassLoaders$ChildFirstClassLoader.loadClass(FlinkUserCodeClassLoaders.java:129)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:357)
... 12 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;How did you figure out the initial error?&lt;/p&gt;</comment>
                            <comment id="16632167" author="nicok" created="Fri, 28 Sep 2018 17:41:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Xeli&quot; class=&quot;user-hover&quot; rel=&quot;Xeli&quot;&gt;Xeli&lt;/a&gt;,&lt;br/&gt;
I don&apos;t think, your Exception is related - the one in the OP is on the JobManager during deserialization of an RPC message. Yours is throws on a TaskManager&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Without knowing the details there, could it be that you are instantiating something like a singleton whose lifecycle is beyond the job&apos;s lifecycle? In that case, it you try to load a new class, the original classloader may not be available anymore.&lt;br/&gt;
-&amp;gt; but that&apos;s off-topic here and may be discussed on the mailing list or separate JIRA.&lt;/p&gt;</comment>
                            <comment id="16635693" author="nicok" created="Tue, 2 Oct 2018 15:29:53 +0000"  >&lt;p&gt;One more note on my original issue:&lt;/p&gt;

&lt;p&gt;there should have been debugging messages in a wrapped &lt;tt&gt;ClassNotFoundException&lt;/tt&gt; from &lt;tt&gt;RemoteRpcInvocation.readObject(RemoteRpcInvocation.java:222)&lt;/tt&gt; to ease debugging but that&apos;s not the case here. Maybe further classloader issues (&lt;tt&gt;InstantiationUtil#deserializeObject()&lt;/tt&gt; sets the context classloader!) make this CNFE fall through? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; you both touched/implemented that code, could it be, that &lt;a href=&quot;https://github.com/apache/flink/commit/7b6b5a2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/7b6b5a2&lt;/a&gt; broke catching the CNFE there?&lt;/p&gt;</comment>
                            <comment id="16641029" author="till.rohrmann" created="Sun, 7 Oct 2018 10:56:22 +0000"  >&lt;p&gt;Hard to tell &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=NicoK&quot; class=&quot;user-hover&quot; rel=&quot;NicoK&quot;&gt;NicoK&lt;/a&gt;. I think the best way to debug this problem is to make it actually reproducible. Have you tried setting up a Flink job with a failing KafkaProducer?&lt;/p&gt;

&lt;p&gt;I agree that we should improve the error messages in the &lt;tt&gt;RemoteRpcInvocation.readObject&lt;/tt&gt; method.&lt;/p&gt;</comment>
                            <comment id="16641794" author="nicok" created="Mon, 8 Oct 2018 12:46:39 +0000"  >&lt;p&gt;Unfortunately, I couldn&apos;t reproduce it with any failure I introduced into different places in the &lt;tt&gt;Kafka011Producer&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;We could forcibly remove one wrapping into a &lt;tt&gt;SerializedThrowable&lt;/tt&gt; to see whether the error reporting (there was code that should have printed the method name, for example) is not working anymore. From a working error message, we&apos;d probably see the original error. I&apos;ll try that out, eventually...&lt;/p&gt;</comment>
                            <comment id="16676610" author="nicok" created="Tue, 6 Nov 2018 10:54:58 +0000"  >&lt;p&gt;With the new debug infos from &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10655&quot; title=&quot;RemoteRpcInvocation not overwriting ObjectInputStream&amp;#39;s ClassNotFoundException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10655&quot;&gt;&lt;del&gt;FLINK-10655&lt;/del&gt;&lt;/a&gt;, we finally have some useful information:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ClassNotFoundException: org.apache.flink.streaming.connectors.kafka.FlinkKafka011Exception
        at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:424)
        at sun.misc.Launcher.loadClass(Launcher.java:338)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:357)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:348)
        at org.apache.flink.util.InstantiationUtil.resolveClass(InstantiationUtil.java:76)
        at java.io.ObjectInputStream.readNonProxyDesc(ObjectInputStream.java:1859)
        at java.io.ObjectInputStream.readClassDesc(ObjectInputStream.java:1745)
        at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2033)
        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1567)
        at java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:2278)
        at java.io.ObjectInputStream.defaultReadObject(ObjectInputStream.java:557)
        at java.lang.Throwable.readObject(Throwable.java:914)
        at sun.reflect.GeneratedMethodAccessor188.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1158)
        at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2169)
        at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2060)
        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1567)
        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:427)
        at org.apache.flink.runtime.rpc.messages.RemoteRpcInvocation.readObject(RemoteRpcInvocation.java:228)
        at sun.reflect.GeneratedMethodAccessor6.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1158)
        at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2169)
        at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2060)
        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1567)
        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:427)
        at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:502)
        at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:489)
        at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:477)
        at org.apache.flink.util.SerializedValue.deserializeValue(SerializedValue.java:58)
        at org.apache.flink.runtime.rpc.messages.RemoteRpcInvocation.deserializeMethodInvocation(RemoteRpcInvocation.java:118)
        at org.apache.flink.runtime.rpc.messages.RemoteRpcInvocation.getMethodName(RemoteRpcInvocation.java:59)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcInvocation(AkkaRpcActor.java:214)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:162)
        at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleRpcMessage(FencedAkkaRpcActor.java:70)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.onReceive(AkkaRpcActor.java:142)
        at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.onReceive(FencedAkkaRpcActor.java:40)
        at akka.actor.UntypedActor20142anonfun.applyOrElse(UntypedActor.scala:165)
        at akka.actor.Actor.aroundReceive(Actor.scala:502)
        at akka.actor.UntypedActor.aroundReceive(UntypedActor.scala:95)
        at akka.actor.ActorCell.receiveMessage(ActorCell.scala:526)
        at akka.actor.ActorCell.invoke(ActorCell.scala:495)
        at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:257)
        at akka.dispatch.Mailbox.run(Mailbox.scala:224)
        at akka.dispatch.Mailbox.exec(Mailbox.scala:234)
        at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
        at scala.concurrent.forkjoin.ForkJoinPool.runTask(ForkJoinPool.java:1339)
        at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
        at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
        Suppressed: java.lang.ClassNotFoundException: Could not deserialize 3th argument of method declineCheckpoint(org.apache.flink.api.common.JobID: 0ba0e63563d44b6f88940024f72c597f, org.apache.flink.runtime.executiongraph.ExecutionAttemptID: f7f90177064ac6e1fc3cb42bd50d4216, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;: 1495, java.lang.Throwable, ...). This indicates that the argument type is not part of the system &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loader.
                at org.apache.flink.runtime.rpc.messages.RemoteRpcInvocation.readObject(RemoteRpcInvocation.java:238)
                ... 31 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It looks like in all cases, a &lt;tt&gt;DeclineCheckpoint&lt;/tt&gt; is being used for transfer and this should wrap the original exception into a &lt;tt&gt;SerializedThrowable&lt;/tt&gt;. However, there are some exceptions:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (reason == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ||
			reason.getClass() == AlignmentLimitExceededException.class ||
			reason.getClass() == CheckpointDeclineOnCancellationBarrierException.class ||
			reason.getClass() == CheckpointDeclineSubsumedException.class ||
			reason.getClass() == CheckpointDeclineTaskNotCheckpointingException.class ||
			reason.getClass() == CheckpointDeclineTaskNotReadyException.class ||
			reason.getClass() == InputEndOfStreamException.class)
		{
			&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; or known common exceptions that cannot reference any dynamically loaded code
&lt;/span&gt;			&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.reason = reason;
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			&lt;span class=&quot;code-comment&quot;&gt;// some other exception. replace with a serialized throwable, to be on the safe side
&lt;/span&gt;			&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.reason = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SerializedThrowable(reason);
		}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;All these exceptions do not allow a &lt;tt&gt;cause&lt;/tt&gt; to be given, but may carry additional &lt;tt&gt;suppressed&lt;/tt&gt; exceptions. I see two callers: &lt;tt&gt;AsyncCheckpointRunnable#handleExecutionException&lt;/tt&gt; and &lt;tt&gt;AbstractStreamOperator#snapshotState()&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16676768" author="githubbot" created="Tue, 6 Nov 2018 13:30:08 +0000"  >&lt;p&gt;NicoK opened a new pull request #7033: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;checkpoint&amp;#93;&lt;/span&gt; fix ClassNotFoundException while deserializing user exceptions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7033&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7033&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   `DeclineCheckpoint` tries to make sure that it does wrap any exception which can be and/or contain user code into a `SerializedThrowable`. It also contains special handling of a few exceptions that are not wrapped into `SerializedThrowable` (`CheckpointDeclineException` sub-classes are claimed to not contain user-code) but if these carry user-code exceptions as &lt;b&gt;suppressed&lt;/b&gt; exceptions, the deserialization at the JobManager will fail and the RPC call will not be processed at all - we thus rely on another method to actually get rid of the checkpoint, e.g. a timeout.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;remove the special handling of `CheckpointDeclineException` sub-classes&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change is already covered by existing tests, such as checkpoint tests and IT cases.&lt;/p&gt;

&lt;p&gt;   I also manually verified that no code is relying on checks such as `instanceof CheckpointDeclineException` or the explicitly mentioned sub-classes, so that it is ok to replace these with `SerializedThrowable` in the RPC.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The serializers: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: *&lt;b&gt;yes&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? *&lt;b&gt;JavaDocs&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16678327" author="githubbot" created="Wed, 7 Nov 2018 14:49:52 +0000"  >&lt;p&gt;NicoK commented on issue #7033: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;checkpoint&amp;#93;&lt;/span&gt; fix ClassNotFoundException while deserializing user exceptions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7033#issuecomment-436647987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7033#issuecomment-436647987&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   True, this only helps with the old non-Flip6 code. I guess, the `declineCheckpoint()` RPC method should have a `DeclineCheckpoint` parameter instead which then properly wraps the exception using this code. At the moment, I don&apos;t have time to follow-up on this though - closing for now in the hopes that someone else can take over maybe re-using this code (or going another way).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16678328" author="githubbot" created="Wed, 7 Nov 2018 14:49:53 +0000"  >&lt;p&gt;NicoK closed pull request #7033: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;checkpoint&amp;#93;&lt;/span&gt; fix ClassNotFoundException while deserializing user exceptions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7033&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7033&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/messages/checkpoint/DeclineCheckpoint.java b/flink-runtime/src/main/java/org/apache/flink/runtime/messages/checkpoint/DeclineCheckpoint.java&lt;br/&gt;
index 7b0b55c9a1b..f8f3c0117bd 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/messages/checkpoint/DeclineCheckpoint.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/messages/checkpoint/DeclineCheckpoint.java&lt;br/&gt;
@@ -19,12 +19,6 @@&lt;br/&gt;
 package org.apache.flink.runtime.messages.checkpoint;&lt;/p&gt;

&lt;p&gt; import org.apache.flink.api.common.JobID;&lt;br/&gt;
-import org.apache.flink.runtime.checkpoint.decline.AlignmentLimitExceededException;&lt;br/&gt;
-import org.apache.flink.runtime.checkpoint.decline.CheckpointDeclineOnCancellationBarrierException;&lt;br/&gt;
-import org.apache.flink.runtime.checkpoint.decline.CheckpointDeclineSubsumedException;&lt;br/&gt;
-import org.apache.flink.runtime.checkpoint.decline.CheckpointDeclineTaskNotCheckpointingException;&lt;br/&gt;
-import org.apache.flink.runtime.checkpoint.decline.CheckpointDeclineTaskNotReadyException;&lt;br/&gt;
-import org.apache.flink.runtime.checkpoint.decline.InputEndOfStreamException;&lt;br/&gt;
 import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
 import org.apache.flink.util.SerializedThrowable;&lt;/p&gt;

&lt;p&gt;@@ -38,7 +32,7 @@&lt;/p&gt;

&lt;p&gt; 	private static final long serialVersionUID = 2094094662279578953L;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** The reason why the checkpoint was declined */&lt;br/&gt;
+	/** The reason why the checkpoint was declined. */&lt;br/&gt;
 	private final Throwable reason;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	public DeclineCheckpoint(JobID job, ExecutionAttemptID taskExecutionId, long checkpointId) {&lt;br/&gt;
@@ -47,19 +41,12 @@ public DeclineCheckpoint(JobID job, ExecutionAttemptID taskExecutionId, long che&lt;/p&gt;

&lt;p&gt; 	public DeclineCheckpoint(JobID job, ExecutionAttemptID taskExecutionId, long checkpointId, Throwable reason) {&lt;br/&gt;
 		super(job, taskExecutionId, checkpointId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;if (reason == null ||&lt;/li&gt;
	&lt;li&gt;reason.getClass() == AlignmentLimitExceededException.class ||&lt;/li&gt;
	&lt;li&gt;reason.getClass() == CheckpointDeclineOnCancellationBarrierException.class ||&lt;/li&gt;
	&lt;li&gt;reason.getClass() == CheckpointDeclineSubsumedException.class ||&lt;/li&gt;
	&lt;li&gt;reason.getClass() == CheckpointDeclineTaskNotCheckpointingException.class ||&lt;/li&gt;
	&lt;li&gt;reason.getClass() == CheckpointDeclineTaskNotReadyException.class ||&lt;/li&gt;
	&lt;li&gt;reason.getClass() == InputEndOfStreamException.class)&lt;/li&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;// null or known common exceptions that cannot reference any dynamically loaded code&lt;br/&gt;
+&lt;br/&gt;
+		if (reason == null) 
{
 			this.reason = reason;
 		}
&lt;p&gt; else &lt;/p&gt;
{
-			// some other exception. replace with a serialized throwable, to be on the safe side
+			// exceptions may reference dynamically loaded code (exception itself, cause, suppressed)
+			// -&amp;gt; replace with a serialized throwable, to be on the safe side
 			this.reason = new SerializedThrowable(reason);
 		}
&lt;p&gt; 	}&lt;br/&gt;
@@ -68,7 +55,7 @@ public DeclineCheckpoint(JobID job, ExecutionAttemptID taskExecutionId, long che&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Gets the reason why the checkpoint was declined.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*&lt;br/&gt;
+	 *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@return The reason why the checkpoint was declined&lt;br/&gt;
 	 */&lt;br/&gt;
 	public Throwable getReason() {&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16684130" author="githubbot" created="Mon, 12 Nov 2018 17:24:28 +0000"  >&lt;p&gt;dawidwys opened a new pull request #7082: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7082&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Invoking `declineCheckpoint` RPC endpoint with `DeclineCheckpoint` message in order to properly handle possible user  code specific exceptions&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685038" author="githubbot" created="Tue, 13 Nov 2018 10:58:33 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7082: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7082#discussion_r232989225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7082#discussion_r232989225&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -248,6 +257,88 @@ public static void teardownClass() {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testDeclineCheckpointInvocationWithUserException() throws Exception {&lt;br/&gt;
+		RpcService rpcService1 = null;&lt;br/&gt;
+		RpcService rpcService2 = null;&lt;br/&gt;
+		try {&lt;br/&gt;
+			final ActorSystem actorSystem1 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+			final ActorSystem actorSystem2 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+&lt;br/&gt;
+			rpcService1 = new AkkaRpcService(actorSystem1, testingTimeout);&lt;br/&gt;
+			rpcService2 = new AkkaRpcService(actorSystem2, testingTimeout);&lt;br/&gt;
+&lt;br/&gt;
+			final CompletableFuture&amp;lt;Throwable&amp;gt; declineCheckpointMessageFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+			final JobManagerSharedServices jobManagerSharedServices = new TestingJobManagerSharedServicesBuilder().build();&lt;br/&gt;
+			final JobMasterConfiguration jobMasterConfiguration = JobMasterConfiguration.fromConfiguration(configuration);&lt;br/&gt;
+			final JobMaster jobMaster = new JobMaster(&lt;br/&gt;
+				rpcService1,&lt;br/&gt;
+				jobMasterConfiguration,&lt;br/&gt;
+				jmResourceId,&lt;br/&gt;
+				jobGraph,&lt;br/&gt;
+				haServices,&lt;br/&gt;
+				DefaultSlotPoolFactory.fromConfiguration(configuration, rpcService1),&lt;br/&gt;
+				jobManagerSharedServices,&lt;br/&gt;
+				heartbeatServices,&lt;br/&gt;
+				blobServer,&lt;br/&gt;
+				UnregisteredJobManagerJobMetricGroupFactory.INSTANCE,&lt;br/&gt;
+				new NoOpOnCompletionActions(),&lt;br/&gt;
+				testingFatalErrorHandler,&lt;br/&gt;
+				JobMasterTest.class.getClassLoader()) {&lt;br/&gt;
+				@Override&lt;br/&gt;
+				public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) &lt;/p&gt;
{
+					declineCheckpointMessageFuture.complete(declineCheckpoint.getReason());
+				}
&lt;p&gt;+			};&lt;br/&gt;
+&lt;br/&gt;
+			jobMaster.start(jobMasterId, testingTimeout).get();&lt;br/&gt;
+&lt;br/&gt;
+			final String className = &quot;UserException&quot;;&lt;br/&gt;
+			final URLClassLoader userClassLoader = ClassLoaderUtils.compileAndLoadJava(&lt;br/&gt;
+				temporaryFolder.newFolder(),&lt;br/&gt;
+				className + &quot;.java&quot;,&lt;br/&gt;
+				String.format(&quot;public class %s extends RuntimeException { public %s() &lt;/p&gt;
{super(\&quot;UserMessage\&quot;);}
&lt;p&gt; }&quot;,&lt;br/&gt;
+					className,&lt;br/&gt;
+					className));&lt;br/&gt;
+&lt;br/&gt;
+			Throwable userException = (Throwable) Class.forName(className, false, userClassLoader).newInstance();&lt;br/&gt;
+&lt;br/&gt;
+			CompletableFuture&amp;lt;JobMasterGateway&amp;gt; jobMasterGateway =&lt;br/&gt;
+				rpcService2.connect(jobMaster.getAddress(), jobMaster.getFencingToken(), JobMasterGateway.class);&lt;br/&gt;
+&lt;br/&gt;
+			jobMasterGateway.thenAccept(gateway -&amp;gt; {&lt;br/&gt;
+				try &lt;/p&gt;
{
+					gateway.declineCheckpoint(new DeclineCheckpoint(
+							jobGraph.getJobID(),
+							new ExecutionAttemptID(1, 1),
+							1,
+						userException
+						)
+					);
+				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
+					throw new RuntimeException(e);
+				}
&lt;p&gt;+			});&lt;br/&gt;
+&lt;br/&gt;
+			Throwable throwable = declineCheckpointMessageFuture.get(testingTimeout.toMilliseconds(),&lt;br/&gt;
+				TimeUnit.MILLISECONDS);&lt;br/&gt;
+			assertThat(throwable, instanceOf(SerializedThrowable.class));&lt;br/&gt;
+			assertThat(throwable.getMessage(), equalTo(userException.getMessage()));&lt;br/&gt;
+		} finally {&lt;br/&gt;
+			final Collection&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; terminationFutures = new ArrayList&amp;lt;&amp;gt;(2);&lt;br/&gt;
+&lt;br/&gt;
+			if (rpcService1 != null) &lt;/p&gt;
{
+				terminationFutures.add(rpcService1.stopService());
+			}
&lt;p&gt;+			if (rpcService2 != null) &lt;/p&gt;
{
+				terminationFutures.add(rpcService2.stopService());
+			}
&lt;p&gt;+&lt;br/&gt;
+			FutureUtils.waitForAll(terminationFutures).get(testingTimeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   We could also use `RpcUtils#terminateRpcService` or extend to take multiple `RpcServices` for termination.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685039" author="githubbot" created="Tue, 13 Nov 2018 10:58:33 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7082: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7082#discussion_r232988684&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7082#discussion_r232988684&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -248,6 +257,88 @@ public static void teardownClass() {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testDeclineCheckpointInvocationWithUserException() throws Exception {&lt;br/&gt;
+		RpcService rpcService1 = null;&lt;br/&gt;
+		RpcService rpcService2 = null;&lt;br/&gt;
+		try {&lt;br/&gt;
+			final ActorSystem actorSystem1 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+			final ActorSystem actorSystem2 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+&lt;br/&gt;
+			rpcService1 = new AkkaRpcService(actorSystem1, testingTimeout);&lt;br/&gt;
+			rpcService2 = new AkkaRpcService(actorSystem2, testingTimeout);&lt;br/&gt;
+&lt;br/&gt;
+			final CompletableFuture&amp;lt;Throwable&amp;gt; declineCheckpointMessageFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+			final JobManagerSharedServices jobManagerSharedServices = new TestingJobManagerSharedServicesBuilder().build();&lt;br/&gt;
+			final JobMasterConfiguration jobMasterConfiguration = JobMasterConfiguration.fromConfiguration(configuration);&lt;br/&gt;
+			final JobMaster jobMaster = new JobMaster(&lt;br/&gt;
+				rpcService1,&lt;br/&gt;
+				jobMasterConfiguration,&lt;br/&gt;
+				jmResourceId,&lt;br/&gt;
+				jobGraph,&lt;br/&gt;
+				haServices,&lt;br/&gt;
+				DefaultSlotPoolFactory.fromConfiguration(configuration, rpcService1),&lt;br/&gt;
+				jobManagerSharedServices,&lt;br/&gt;
+				heartbeatServices,&lt;br/&gt;
+				blobServer,&lt;br/&gt;
+				UnregisteredJobManagerJobMetricGroupFactory.INSTANCE,&lt;br/&gt;
+				new NoOpOnCompletionActions(),&lt;br/&gt;
+				testingFatalErrorHandler,&lt;br/&gt;
+				JobMasterTest.class.getClassLoader()) {&lt;br/&gt;
+				@Override&lt;br/&gt;
+				public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) &lt;/p&gt;
{
+					declineCheckpointMessageFuture.complete(declineCheckpoint.getReason());
+				}
&lt;p&gt;+			};&lt;br/&gt;
+&lt;br/&gt;
+			jobMaster.start(jobMasterId, testingTimeout).get();&lt;br/&gt;
+&lt;br/&gt;
+			final String className = &quot;UserException&quot;;&lt;br/&gt;
+			final URLClassLoader userClassLoader = ClassLoaderUtils.compileAndLoadJava(&lt;br/&gt;
+				temporaryFolder.newFolder(),&lt;br/&gt;
+				className + &quot;.java&quot;,&lt;br/&gt;
+				String.format(&quot;public class %s extends RuntimeException { public %s() &lt;/p&gt;
{super(\&quot;UserMessage\&quot;);}
&lt;p&gt; }&quot;,&lt;br/&gt;
+					className,&lt;br/&gt;
+					className));&lt;br/&gt;
+&lt;br/&gt;
+			Throwable userException = (Throwable) Class.forName(className, false, userClassLoader).newInstance();&lt;br/&gt;
+&lt;br/&gt;
+			CompletableFuture&amp;lt;JobMasterGateway&amp;gt; jobMasterGateway =&lt;br/&gt;
+				rpcService2.connect(jobMaster.getAddress(), jobMaster.getFencingToken(), JobMasterGateway.class);&lt;br/&gt;
+&lt;br/&gt;
+			jobMasterGateway.thenAccept(gateway -&amp;gt; {&lt;br/&gt;
+				try {&lt;br/&gt;
+					gateway.declineCheckpoint(new DeclineCheckpoint(&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   We could create the `DeclineCheckpoint` instance outside of the future callback. Then we would not need to handle the exception.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685040" author="githubbot" created="Tue, 13 Nov 2018 10:58:33 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7082: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7082#discussion_r232988398&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7082#discussion_r232988398&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -248,6 +257,88 @@ public static void teardownClass() {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testDeclineCheckpointInvocationWithUserException() throws Exception {&lt;br/&gt;
+		RpcService rpcService1 = null;&lt;br/&gt;
+		RpcService rpcService2 = null;&lt;br/&gt;
+		try {&lt;br/&gt;
+			final ActorSystem actorSystem1 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+			final ActorSystem actorSystem2 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+&lt;br/&gt;
+			rpcService1 = new AkkaRpcService(actorSystem1, testingTimeout);&lt;br/&gt;
+			rpcService2 = new AkkaRpcService(actorSystem2, testingTimeout);&lt;br/&gt;
+&lt;br/&gt;
+			final CompletableFuture&amp;lt;Throwable&amp;gt; declineCheckpointMessageFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+			final JobManagerSharedServices jobManagerSharedServices = new TestingJobManagerSharedServicesBuilder().build();&lt;br/&gt;
+			final JobMasterConfiguration jobMasterConfiguration = JobMasterConfiguration.fromConfiguration(configuration);&lt;br/&gt;
+			final JobMaster jobMaster = new JobMaster(&lt;br/&gt;
+				rpcService1,&lt;br/&gt;
+				jobMasterConfiguration,&lt;br/&gt;
+				jmResourceId,&lt;br/&gt;
+				jobGraph,&lt;br/&gt;
+				haServices,&lt;br/&gt;
+				DefaultSlotPoolFactory.fromConfiguration(configuration, rpcService1),&lt;br/&gt;
+				jobManagerSharedServices,&lt;br/&gt;
+				heartbeatServices,&lt;br/&gt;
+				blobServer,&lt;br/&gt;
+				UnregisteredJobManagerJobMetricGroupFactory.INSTANCE,&lt;br/&gt;
+				new NoOpOnCompletionActions(),&lt;br/&gt;
+				testingFatalErrorHandler,&lt;br/&gt;
+				JobMasterTest.class.getClassLoader()) {&lt;br/&gt;
+				@Override&lt;br/&gt;
+				public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) &lt;/p&gt;
{
+					declineCheckpointMessageFuture.complete(declineCheckpoint.getReason());
+				}
&lt;p&gt;+			};&lt;br/&gt;
+&lt;br/&gt;
+			jobMaster.start(jobMasterId, testingTimeout).get();&lt;br/&gt;
+&lt;br/&gt;
+			final String className = &quot;UserException&quot;;&lt;br/&gt;
+			final URLClassLoader userClassLoader = ClassLoaderUtils.compileAndLoadJava(&lt;br/&gt;
+				temporaryFolder.newFolder(),&lt;br/&gt;
+				className + &quot;.java&quot;,&lt;br/&gt;
+				String.format(&quot;public class %s extends RuntimeException { public %s() &lt;/p&gt;
{super(\&quot;UserMessage\&quot;);}
&lt;p&gt; }&quot;,&lt;br/&gt;
+					className,&lt;br/&gt;
+					className));&lt;br/&gt;
+&lt;br/&gt;
+			Throwable userException = (Throwable) Class.forName(className, false, userClassLoader).newInstance();&lt;br/&gt;
+&lt;br/&gt;
+			CompletableFuture&amp;lt;JobMasterGateway&amp;gt; jobMasterGateway =&lt;br/&gt;
+				rpcService2.connect(jobMaster.getAddress(), jobMaster.getFencingToken(), JobMasterGateway.class);&lt;br/&gt;
+&lt;br/&gt;
+			jobMasterGateway.thenAccept(gateway -&amp;gt; {&lt;br/&gt;
+				try {&lt;br/&gt;
+					gateway.declineCheckpoint(new DeclineCheckpoint(&lt;br/&gt;
+							jobGraph.getJobID(),&lt;br/&gt;
+							new ExecutionAttemptID(1, 1),&lt;br/&gt;
+							1,&lt;br/&gt;
+						userException&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   indentation wrong&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685463" author="githubbot" created="Tue, 13 Nov 2018 16:46:08 +0000"  >&lt;p&gt;dawidwys closed pull request #7082: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7082&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
index 22244f6cb8d..b8dc5545706 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
@@ -20,6 +20,7 @@&lt;/p&gt;

&lt;p&gt; import org.apache.flink.api.common.JobID;&lt;br/&gt;
 import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcGateway;&lt;/p&gt;

&lt;p&gt; public interface CheckpointCoordinatorGateway extends RpcGateway &lt;/p&gt;
{
@@ -31,9 +32,5 @@ void acknowledgeCheckpoint(
 			final CheckpointMetrics checkpointMetrics,
 			final TaskStateSnapshot subtaskState);
 
-	void declineCheckpoint(
-			JobID jobID,
-			ExecutionAttemptID executionAttemptID,
-			long checkpointId,
-			Throwable cause);
+	void declineCheckpoint(DeclineCheckpoint declineCheckpoint);
 }
&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
index 5d2d363cf71..40a675aca31 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
@@ -690,13 +690,7 @@ public void acknowledgeCheckpoint(&lt;/p&gt;

&lt;p&gt; 	// TODO: This method needs a leader session ID&lt;br/&gt;
 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void declineCheckpoint(&lt;/li&gt;
	&lt;li&gt;final JobID jobID,&lt;/li&gt;
	&lt;li&gt;final ExecutionAttemptID executionAttemptID,&lt;/li&gt;
	&lt;li&gt;final long checkpointID,&lt;/li&gt;
	&lt;li&gt;final Throwable reason) {&lt;/li&gt;
	&lt;li&gt;final DeclineCheckpoint decline = new DeclineCheckpoint(&lt;/li&gt;
	&lt;li&gt;jobID, executionAttemptID, checkpointID, reason);&lt;br/&gt;
+	public void declineCheckpoint(DeclineCheckpoint decline) {&lt;br/&gt;
 		final CheckpointCoordinator checkpointCoordinator = executionGraph.getCheckpointCoordinator();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		if (checkpointCoordinator != null) &lt;/p&gt;
{
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
index c90a8b5bbbc..2f656d09263 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
@@ -19,9 +19,13 @@
 package org.apache.flink.runtime.rpc;
 
 import org.apache.flink.api.common.time.Time;
+import org.apache.flink.runtime.concurrent.FutureUtils;
 
+import java.util.ArrayList;
+import java.util.Collection;
 import java.util.HashSet;
 import java.util.Set;
+import java.util.concurrent.CompletableFuture;
 import java.util.concurrent.ExecutionException;
 import java.util.concurrent.TimeUnit;
 import java.util.concurrent.TimeoutException;
@@ -87,6 +91,29 @@ public static void terminateRpcService(RpcService rpcService, Time timeout) thro
 		rpcService.stopService().get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Shuts the given rpc services down and waits for their termination.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param rpcServices to shut down&lt;br/&gt;
+	 * @param timeout for this operation&lt;br/&gt;
+	 * @throws InterruptedException if the operation has been interrupted&lt;br/&gt;
+	 * @throws ExecutionException if a problem occurred&lt;br/&gt;
+	 * @throws TimeoutException if a timeout occurred&lt;br/&gt;
+	 */&lt;br/&gt;
+	public static void terminateRpcServices(&lt;br/&gt;
+			Time timeout,&lt;br/&gt;
+			RpcService... rpcServices) throws InterruptedException, ExecutionException, TimeoutException {&lt;br/&gt;
+		final Collection&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; terminationFutures = new ArrayList&amp;lt;&amp;gt;(rpcServices.length);&lt;br/&gt;
+&lt;br/&gt;
+		for (RpcService service : rpcServices) {&lt;br/&gt;
+			if (service != null) &lt;/p&gt;
{
+				terminationFutures.add(service.stopService());
+			}
&lt;p&gt;+		}&lt;br/&gt;
+&lt;br/&gt;
+		FutureUtils.waitForAll(terminationFutures).get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
+	}&lt;br/&gt;
+&lt;br/&gt;
 	// We don&apos;t want this class to be instantiable&lt;br/&gt;
 	private RpcUtils() {}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
index c8f7357ab7e..10c9e2f123a 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
@@ -23,6 +23,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.CheckpointMetrics;&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.TaskStateSnapshot;&lt;br/&gt;
 import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.CheckpointResponder;&lt;br/&gt;
 import org.apache.flink.util.Preconditions;&lt;/p&gt;

&lt;p&gt;@@ -57,6 +58,9 @@ public void declineCheckpoint(&lt;br/&gt;
 			long checkpointId,&lt;br/&gt;
 			Throwable cause) &lt;/p&gt;
{
 
-		checkpointCoordinatorGateway.declineCheckpoint(jobID, executionAttemptID, checkpointId, cause);
+		checkpointCoordinatorGateway.declineCheckpoint(new DeclineCheckpoint(jobID,
+			executionAttemptID,
+			checkpointId,
+			cause));
 	}
&lt;p&gt; }&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
index f3c72545e69..b1f02845c14 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
@@ -33,6 +33,7 @@&lt;br/&gt;
 import org.apache.flink.core.io.InputSplitSource;&lt;br/&gt;
 import org.apache.flink.core.testutils.OneShotLatch;&lt;br/&gt;
 import org.apache.flink.queryablestate.KvStateID;&lt;br/&gt;
+import org.apache.flink.runtime.akka.AkkaUtils;&lt;br/&gt;
 import org.apache.flink.runtime.blob.BlobServer;&lt;br/&gt;
 import org.apache.flink.runtime.blob.VoidBlobStore;&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.CheckpointProperties;&lt;br/&gt;
@@ -84,14 +85,17 @@&lt;br/&gt;
 import org.apache.flink.runtime.leaderretrieval.SettableLeaderRetrievalService;&lt;br/&gt;
 import org.apache.flink.runtime.messages.Acknowledge;&lt;br/&gt;
 import org.apache.flink.runtime.messages.FlinkJobNotFoundException;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.query.KvStateLocation;&lt;br/&gt;
 import org.apache.flink.runtime.query.UnknownKvStateLocation;&lt;br/&gt;
 import org.apache.flink.runtime.registration.RegistrationResponse;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.ResourceManagerId;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.SlotRequest;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.utils.TestingResourceManagerGateway;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.RpcService;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcUtils;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.TestingRpcService;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.akka.AkkaRpcService;&lt;br/&gt;
 import org.apache.flink.runtime.state.CompletedCheckpointStorageLocation;&lt;br/&gt;
 import org.apache.flink.runtime.state.KeyGroupRange;&lt;br/&gt;
 import org.apache.flink.runtime.state.OperatorStreamStateHandle;&lt;br/&gt;
@@ -106,12 +110,15 @@&lt;br/&gt;
 import org.apache.flink.runtime.testtasks.BlockingNoOpInvokable;&lt;br/&gt;
 import org.apache.flink.runtime.testtasks.NoOpInvokable;&lt;br/&gt;
 import org.apache.flink.runtime.util.TestingFatalErrorHandler;&lt;br/&gt;
+import org.apache.flink.testutils.ClassLoaderUtils;&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
 import org.apache.flink.util.FlinkException;&lt;br/&gt;
 import org.apache.flink.util.InstantiationUtil;&lt;br/&gt;
+import org.apache.flink.util.SerializedThrowable;&lt;br/&gt;
 import org.apache.flink.util.TestLogger;&lt;br/&gt;
 import org.apache.flink.util.function.SupplierWithException;&lt;/p&gt;

&lt;p&gt;+import akka.actor.ActorSystem;&lt;br/&gt;
 import org.hamcrest.Matcher;&lt;br/&gt;
 import org.hamcrest.Matchers;&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
@@ -130,6 +137,7 @@&lt;br/&gt;
 import java.io.IOException;&lt;br/&gt;
 import java.net.InetAddress;&lt;br/&gt;
 import java.net.InetSocketAddress;&lt;br/&gt;
+import java.net.URLClassLoader;&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Arrays;&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
@@ -248,6 +256,75 @@ public static void teardownClass() {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testDeclineCheckpointInvocationWithUserException() throws Exception {&lt;br/&gt;
+		RpcService rpcService1 = null;&lt;br/&gt;
+		RpcService rpcService2 = null;&lt;br/&gt;
+		try {&lt;br/&gt;
+			final ActorSystem actorSystem1 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+			final ActorSystem actorSystem2 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+&lt;br/&gt;
+			rpcService1 = new AkkaRpcService(actorSystem1, testingTimeout);&lt;br/&gt;
+			rpcService2 = new AkkaRpcService(actorSystem2, testingTimeout);&lt;br/&gt;
+&lt;br/&gt;
+			final CompletableFuture&amp;lt;Throwable&amp;gt; declineCheckpointMessageFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+			final JobManagerSharedServices jobManagerSharedServices = new TestingJobManagerSharedServicesBuilder().build();&lt;br/&gt;
+			final JobMasterConfiguration jobMasterConfiguration = JobMasterConfiguration.fromConfiguration(configuration);&lt;br/&gt;
+			final JobMaster jobMaster = new JobMaster(&lt;br/&gt;
+				rpcService1,&lt;br/&gt;
+				jobMasterConfiguration,&lt;br/&gt;
+				jmResourceId,&lt;br/&gt;
+				jobGraph,&lt;br/&gt;
+				haServices,&lt;br/&gt;
+				DefaultSlotPoolFactory.fromConfiguration(configuration, rpcService1),&lt;br/&gt;
+				jobManagerSharedServices,&lt;br/&gt;
+				heartbeatServices,&lt;br/&gt;
+				blobServer,&lt;br/&gt;
+				UnregisteredJobManagerJobMetricGroupFactory.INSTANCE,&lt;br/&gt;
+				new NoOpOnCompletionActions(),&lt;br/&gt;
+				testingFatalErrorHandler,&lt;br/&gt;
+				JobMasterTest.class.getClassLoader()) {&lt;br/&gt;
+				@Override&lt;br/&gt;
+				public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) &lt;/p&gt;
{
+					declineCheckpointMessageFuture.complete(declineCheckpoint.getReason());
+				}
&lt;p&gt;+			};&lt;br/&gt;
+&lt;br/&gt;
+			jobMaster.start(jobMasterId, testingTimeout).get();&lt;br/&gt;
+&lt;br/&gt;
+			final String className = &quot;UserException&quot;;&lt;br/&gt;
+			final URLClassLoader userClassLoader = ClassLoaderUtils.compileAndLoadJava(&lt;br/&gt;
+				temporaryFolder.newFolder(),&lt;br/&gt;
+				className + &quot;.java&quot;,&lt;br/&gt;
+				String.format(&quot;public class %s extends RuntimeException { public %s() &lt;/p&gt;
{super(\&quot;UserMessage\&quot;);}
&lt;p&gt; }&quot;,&lt;br/&gt;
+					className,&lt;br/&gt;
+					className));&lt;br/&gt;
+&lt;br/&gt;
+			Throwable userException = (Throwable) Class.forName(className, false, userClassLoader).newInstance();&lt;br/&gt;
+&lt;br/&gt;
+			CompletableFuture&amp;lt;JobMasterGateway&amp;gt; jobMasterGateway =&lt;br/&gt;
+				rpcService2.connect(jobMaster.getAddress(), jobMaster.getFencingToken(), JobMasterGateway.class);&lt;br/&gt;
+&lt;br/&gt;
+			jobMasterGateway.thenAccept(gateway -&amp;gt; &lt;/p&gt;
{
+				gateway.declineCheckpoint(new DeclineCheckpoint(
+						jobGraph.getJobID(),
+						new ExecutionAttemptID(1, 1),
+						1,
+						userException
+					)
+				);
+			}
&lt;p&gt;);&lt;br/&gt;
+&lt;br/&gt;
+			Throwable throwable = declineCheckpointMessageFuture.get(testingTimeout.toMilliseconds(),&lt;br/&gt;
+				TimeUnit.MILLISECONDS);&lt;br/&gt;
+			assertThat(throwable, instanceOf(SerializedThrowable.class));&lt;br/&gt;
+			assertThat(throwable.getMessage(), equalTo(userException.getMessage()));&lt;br/&gt;
+		} finally &lt;/p&gt;
{
+			RpcUtils.terminateRpcServices(testingTimeout, rpcService1, rpcService2);
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testHeartbeatTimeoutWithTaskManager() throws Exception &lt;/p&gt;
{
 		final CompletableFuture&amp;lt;ResourceID&amp;gt; heartbeatResourceIdFuture = new CompletableFuture&amp;lt;&amp;gt;();
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
index c9c55a1da8f..f5f7f8e3415 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
@@ -41,6 +41,7 @@
 import org.apache.flink.runtime.jobmaster.SerializedInputSplit;
 import org.apache.flink.runtime.jobmaster.message.ClassloadingProps;
 import org.apache.flink.runtime.messages.Acknowledge;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;
 import org.apache.flink.runtime.messages.webmonitor.JobDetails;
 import org.apache.flink.runtime.query.KvStateLocation;
 import org.apache.flink.runtime.registration.RegistrationResponse;
@@ -144,7 +145,7 @@
 	private final Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer;
 
 	@Nonnull
-	private final Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer;
+	private final Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer;
 
 	@Nonnull
 	private final Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier;
@@ -183,7 +184,7 @@ public TestingJobMasterGateway(
 			@Nonnull Function&amp;lt;JobVertexID, CompletableFuture&amp;lt;OperatorBackPressureStatsResponse&amp;gt;&amp;gt; requestOperatorBackPressureStatsFunction,
 			@Nonnull BiConsumer&amp;lt;AllocationID, Throwable&amp;gt; notifyAllocationFailureConsumer,
 			@Nonnull Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer,
-			@Nonnull Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer,
+			@Nonnull Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer,
 			@Nonnull Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier,
 			@Nonnull BiFunction&amp;lt;JobID, String, CompletableFuture&amp;lt;KvStateLocation&amp;gt;&amp;gt; requestKvStateLocationFunction,
 			@Nonnull Function&amp;lt;Tuple6&amp;lt;JobID, JobVertexID, KeyGroupRange, String, KvStateID, InetSocketAddress&amp;gt;, CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; notifyKvStateRegisteredFunction,
@@ -335,8 +336,8 @@ public void acknowledgeCheckpoint(JobID jobID, ExecutionAttemptID executionAttem
 	}

&lt;p&gt; 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void declineCheckpoint(JobID jobID, ExecutionAttemptID executionAttemptID, long checkpointId, Throwable cause) {&lt;/li&gt;
	&lt;li&gt;declineCheckpointConsumer.accept(Tuple4.of(jobID, executionAttemptID, checkpointId, cause));&lt;br/&gt;
+	public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) 
{
+		declineCheckpointConsumer.accept(declineCheckpoint);
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Override&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
index e40b752f248..b52df9ee052 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
@@ -40,6 +40,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.jobmaster.SerializedInputSplit;&lt;br/&gt;
 import org.apache.flink.runtime.jobmaster.message.ClassloadingProps;&lt;br/&gt;
 import org.apache.flink.runtime.messages.Acknowledge;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.messages.webmonitor.JobDetails;&lt;br/&gt;
 import org.apache.flink.runtime.query.KvStateLocation;&lt;br/&gt;
 import org.apache.flink.runtime.query.UnknownKvStateLocation;&lt;br/&gt;
@@ -96,7 +97,7 @@&lt;br/&gt;
 	private Function&amp;lt;JobVertexID, CompletableFuture&amp;lt;OperatorBackPressureStatsResponse&amp;gt;&amp;gt; requestOperatorBackPressureStatsFunction = ignored -&amp;gt; CompletableFuture.completedFuture(OperatorBackPressureStatsResponse.of(null));&lt;br/&gt;
 	private BiConsumer&amp;lt;AllocationID, Throwable&amp;gt; notifyAllocationFailureConsumer = (ignoredA, ignoredB) -&amp;gt; {};&lt;br/&gt;
 	private Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer = ignored -&amp;gt; {};&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer = ignored -&amp;gt; {};&lt;br/&gt;
+	private Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer = ignored -&amp;gt; {};&lt;br/&gt;
 	private Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier = () -&amp;gt; JOB_MASTER_ID;&lt;br/&gt;
 	private BiFunction&amp;lt;JobID, String, CompletableFuture&amp;lt;KvStateLocation&amp;gt;&amp;gt; requestKvStateLocationFunction = (ignoredA, registrationName) -&amp;gt; FutureUtils.completedExceptionally(new UnknownKvStateLocation(registrationName));&lt;br/&gt;
 	private Function&amp;lt;Tuple6&amp;lt;JobID, JobVertexID, KeyGroupRange, String, KvStateID, InetSocketAddress&amp;gt;, CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; notifyKvStateRegisteredFunction = ignored -&amp;gt; CompletableFuture.completedFuture(Acknowledge.get());&lt;br/&gt;
@@ -222,7 +223,7 @@ public TestingJobMasterGatewayBuilder setAcknowledgeCheckpointConsumer(Consumer&amp;lt;&lt;br/&gt;
 		return this;&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public TestingJobMasterGatewayBuilder setDeclineCheckpointConsumer(Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer) {&lt;br/&gt;
+	public TestingJobMasterGatewayBuilder setDeclineCheckpointConsumer(Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer) 
{
 		this.declineCheckpointConsumer = declineCheckpointConsumer;
 		return this;
 	}&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685474" author="githubbot" created="Tue, 13 Nov 2018 16:54:11 +0000"  >&lt;p&gt;dawidwys opened a new pull request #7089: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7089&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Invoking `declineCheckpoint` RPC endpoint with `DeclineCheckpoint` message in order to properly handle possible user  code specific exceptions&lt;/p&gt;

&lt;p&gt;   backport for 1.6&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;How to verify the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Added IT test:&lt;/p&gt;

&lt;p&gt;   `org.apache.flink.runtime.jobmaster.JobMasterTest#testDeclineCheckpointInvocationWithUserException`&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685475" author="githubbot" created="Tue, 13 Nov 2018 16:55:03 +0000"  >&lt;p&gt;dawidwys opened a new pull request #7090: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7090&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7090&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Invoking `declineCheckpoint` RPC endpoint with `DeclineCheckpoint` message in order to properly handle possible user  code specific exceptions&lt;/p&gt;

&lt;p&gt;   backport for 1.5&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;How to verify the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Added IT test:&lt;/p&gt;

&lt;p&gt;   `org.apache.flink.runtime.jobmaster.JobMasterTest#testDeclineCheckpointInvocationWithUserException`&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16686182" author="githubbot" created="Wed, 14 Nov 2018 08:07:03 +0000"  >&lt;p&gt;dawidwys closed pull request #7089: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7089&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
index 22244f6cb8d..b8dc5545706 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
@@ -20,6 +20,7 @@&lt;/p&gt;

&lt;p&gt; import org.apache.flink.api.common.JobID;&lt;br/&gt;
 import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcGateway;&lt;/p&gt;

&lt;p&gt; public interface CheckpointCoordinatorGateway extends RpcGateway &lt;/p&gt;
{
@@ -31,9 +32,5 @@ void acknowledgeCheckpoint(
 			final CheckpointMetrics checkpointMetrics,
 			final TaskStateSnapshot subtaskState);
 
-	void declineCheckpoint(
-			JobID jobID,
-			ExecutionAttemptID executionAttemptID,
-			long checkpointId,
-			Throwable cause);
+	void declineCheckpoint(DeclineCheckpoint declineCheckpoint);
 }
&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
index c19346ff8d0..c8a8e882913 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
@@ -688,13 +688,7 @@ public void acknowledgeCheckpoint(&lt;/p&gt;

&lt;p&gt; 	// TODO: This method needs a leader session ID&lt;br/&gt;
 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void declineCheckpoint(&lt;/li&gt;
	&lt;li&gt;final JobID jobID,&lt;/li&gt;
	&lt;li&gt;final ExecutionAttemptID executionAttemptID,&lt;/li&gt;
	&lt;li&gt;final long checkpointID,&lt;/li&gt;
	&lt;li&gt;final Throwable reason) {&lt;/li&gt;
	&lt;li&gt;final DeclineCheckpoint decline = new DeclineCheckpoint(&lt;/li&gt;
	&lt;li&gt;jobID, executionAttemptID, checkpointID, reason);&lt;br/&gt;
+	public void declineCheckpoint(DeclineCheckpoint decline) {&lt;br/&gt;
 		final CheckpointCoordinator checkpointCoordinator = executionGraph.getCheckpointCoordinator();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		if (checkpointCoordinator != null) &lt;/p&gt;
{
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
index c90a8b5bbbc..2f656d09263 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
@@ -19,9 +19,13 @@
 package org.apache.flink.runtime.rpc;
 
 import org.apache.flink.api.common.time.Time;
+import org.apache.flink.runtime.concurrent.FutureUtils;
 
+import java.util.ArrayList;
+import java.util.Collection;
 import java.util.HashSet;
 import java.util.Set;
+import java.util.concurrent.CompletableFuture;
 import java.util.concurrent.ExecutionException;
 import java.util.concurrent.TimeUnit;
 import java.util.concurrent.TimeoutException;
@@ -87,6 +91,29 @@ public static void terminateRpcService(RpcService rpcService, Time timeout) thro
 		rpcService.stopService().get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Shuts the given rpc services down and waits for their termination.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param rpcServices to shut down&lt;br/&gt;
+	 * @param timeout for this operation&lt;br/&gt;
+	 * @throws InterruptedException if the operation has been interrupted&lt;br/&gt;
+	 * @throws ExecutionException if a problem occurred&lt;br/&gt;
+	 * @throws TimeoutException if a timeout occurred&lt;br/&gt;
+	 */&lt;br/&gt;
+	public static void terminateRpcServices(&lt;br/&gt;
+			Time timeout,&lt;br/&gt;
+			RpcService... rpcServices) throws InterruptedException, ExecutionException, TimeoutException {&lt;br/&gt;
+		final Collection&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; terminationFutures = new ArrayList&amp;lt;&amp;gt;(rpcServices.length);&lt;br/&gt;
+&lt;br/&gt;
+		for (RpcService service : rpcServices) {&lt;br/&gt;
+			if (service != null) &lt;/p&gt;
{
+				terminationFutures.add(service.stopService());
+			}
&lt;p&gt;+		}&lt;br/&gt;
+&lt;br/&gt;
+		FutureUtils.waitForAll(terminationFutures).get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
+	}&lt;br/&gt;
+&lt;br/&gt;
 	// We don&apos;t want this class to be instantiable&lt;br/&gt;
 	private RpcUtils() {}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
index c8f7357ab7e..10c9e2f123a 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
@@ -23,6 +23,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.CheckpointMetrics;&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.TaskStateSnapshot;&lt;br/&gt;
 import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.CheckpointResponder;&lt;br/&gt;
 import org.apache.flink.util.Preconditions;&lt;/p&gt;

&lt;p&gt;@@ -57,6 +58,9 @@ public void declineCheckpoint(&lt;br/&gt;
 			long checkpointId,&lt;br/&gt;
 			Throwable cause) &lt;/p&gt;
{
 
-		checkpointCoordinatorGateway.declineCheckpoint(jobID, executionAttemptID, checkpointId, cause);
+		checkpointCoordinatorGateway.declineCheckpoint(new DeclineCheckpoint(jobID,
+			executionAttemptID,
+			checkpointId,
+			cause));
 	}
&lt;p&gt; }&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
index 86afa90762e..184f5a6f024 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
@@ -27,6 +27,7 @@&lt;br/&gt;
 import org.apache.flink.configuration.Configuration;&lt;br/&gt;
 import org.apache.flink.configuration.JobManagerOptions;&lt;br/&gt;
 import org.apache.flink.core.testutils.OneShotLatch;&lt;br/&gt;
+import org.apache.flink.runtime.akka.AkkaUtils;&lt;br/&gt;
 import org.apache.flink.runtime.blob.BlobServer;&lt;br/&gt;
 import org.apache.flink.runtime.blob.VoidBlobStore;&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.CheckpointProperties;&lt;br/&gt;
@@ -67,12 +68,15 @@&lt;br/&gt;
 import org.apache.flink.runtime.jobmaster.slotpool.DefaultSlotPoolFactory;&lt;br/&gt;
 import org.apache.flink.runtime.leaderretrieval.SettableLeaderRetrievalService;&lt;br/&gt;
 import org.apache.flink.runtime.messages.Acknowledge;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.registration.RegistrationResponse;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.ResourceManagerId;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.SlotRequest;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.utils.TestingResourceManagerGateway;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.RpcService;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcUtils;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.TestingRpcService;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.akka.AkkaRpcService;&lt;br/&gt;
 import org.apache.flink.runtime.state.CompletedCheckpointStorageLocation;&lt;br/&gt;
 import org.apache.flink.runtime.state.StreamStateHandle;&lt;br/&gt;
 import org.apache.flink.runtime.taskexecutor.TestingTaskExecutorGateway;&lt;br/&gt;
@@ -83,10 +87,13 @@&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.TaskManagerLocation;&lt;br/&gt;
 import org.apache.flink.runtime.testtasks.NoOpInvokable;&lt;br/&gt;
 import org.apache.flink.runtime.util.TestingFatalErrorHandler;&lt;br/&gt;
+import org.apache.flink.testutils.ClassLoaderUtils;&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
 import org.apache.flink.util.FlinkException;&lt;br/&gt;
+import org.apache.flink.util.SerializedThrowable;&lt;br/&gt;
 import org.apache.flink.util.TestLogger;&lt;/p&gt;

&lt;p&gt;+import akka.actor.ActorSystem;&lt;br/&gt;
 import org.hamcrest.Matchers;&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
 import org.junit.AfterClass;&lt;br/&gt;
@@ -102,6 +109,7 @@&lt;br/&gt;
 import java.io.File;&lt;br/&gt;
 import java.io.FileOutputStream;&lt;br/&gt;
 import java.io.IOException;&lt;br/&gt;
+import java.net.URLClassLoader;&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
 import java.util.concurrent.ArrayBlockingQueue;&lt;br/&gt;
@@ -211,6 +219,75 @@ public static void teardownClass() {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testDeclineCheckpointInvocationWithUserException() throws Exception {&lt;br/&gt;
+		RpcService rpcService1 = null;&lt;br/&gt;
+		RpcService rpcService2 = null;&lt;br/&gt;
+		try {&lt;br/&gt;
+			final ActorSystem actorSystem1 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+			final ActorSystem actorSystem2 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+&lt;br/&gt;
+			rpcService1 = new AkkaRpcService(actorSystem1, testingTimeout);&lt;br/&gt;
+			rpcService2 = new AkkaRpcService(actorSystem2, testingTimeout);&lt;br/&gt;
+&lt;br/&gt;
+			final CompletableFuture&amp;lt;Throwable&amp;gt; declineCheckpointMessageFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+			final JobManagerSharedServices jobManagerSharedServices = new TestingJobManagerSharedServicesBuilder().build();&lt;br/&gt;
+			final JobMasterConfiguration jobMasterConfiguration = JobMasterConfiguration.fromConfiguration(configuration);&lt;br/&gt;
+			final JobMaster jobMaster = new JobMaster(&lt;br/&gt;
+				rpcService1,&lt;br/&gt;
+				jobMasterConfiguration,&lt;br/&gt;
+				jmResourceId,&lt;br/&gt;
+				jobGraph,&lt;br/&gt;
+				haServices,&lt;br/&gt;
+				DefaultSlotPoolFactory.fromConfiguration(configuration, rpcService1),&lt;br/&gt;
+				jobManagerSharedServices,&lt;br/&gt;
+				heartbeatServices,&lt;br/&gt;
+				blobServer,&lt;br/&gt;
+				UnregisteredJobManagerJobMetricGroupFactory.INSTANCE,&lt;br/&gt;
+				new NoOpOnCompletionActions(),&lt;br/&gt;
+				testingFatalErrorHandler,&lt;br/&gt;
+				JobMasterTest.class.getClassLoader()) {&lt;br/&gt;
+				@Override&lt;br/&gt;
+				public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) &lt;/p&gt;
{
+					declineCheckpointMessageFuture.complete(declineCheckpoint.getReason());
+				}
&lt;p&gt;+			};&lt;br/&gt;
+&lt;br/&gt;
+			jobMaster.start(jobMasterId, testingTimeout).get();&lt;br/&gt;
+&lt;br/&gt;
+			final String className = &quot;UserException&quot;;&lt;br/&gt;
+			final URLClassLoader userClassLoader = ClassLoaderUtils.compileAndLoadJava(&lt;br/&gt;
+				temporaryFolder.newFolder(),&lt;br/&gt;
+				className + &quot;.java&quot;,&lt;br/&gt;
+				String.format(&quot;public class %s extends RuntimeException { public %s() &lt;/p&gt;
{super(\&quot;UserMessage\&quot;);}
&lt;p&gt; }&quot;,&lt;br/&gt;
+					className,&lt;br/&gt;
+					className));&lt;br/&gt;
+&lt;br/&gt;
+			Throwable userException = (Throwable) Class.forName(className, false, userClassLoader).newInstance();&lt;br/&gt;
+&lt;br/&gt;
+			CompletableFuture&amp;lt;JobMasterGateway&amp;gt; jobMasterGateway =&lt;br/&gt;
+				rpcService2.connect(jobMaster.getAddress(), jobMaster.getFencingToken(), JobMasterGateway.class);&lt;br/&gt;
+&lt;br/&gt;
+			jobMasterGateway.thenAccept(gateway -&amp;gt; &lt;/p&gt;
{
+				gateway.declineCheckpoint(new DeclineCheckpoint(
+						jobGraph.getJobID(),
+						new ExecutionAttemptID(1, 1),
+						1,
+						userException
+					)
+				);
+			}
&lt;p&gt;);&lt;br/&gt;
+&lt;br/&gt;
+			Throwable throwable = declineCheckpointMessageFuture.get(testingTimeout.toMilliseconds(),&lt;br/&gt;
+				TimeUnit.MILLISECONDS);&lt;br/&gt;
+			assertThat(throwable, instanceOf(SerializedThrowable.class));&lt;br/&gt;
+			assertThat(throwable.getMessage(), equalTo(userException.getMessage()));&lt;br/&gt;
+		} finally &lt;/p&gt;
{
+			RpcUtils.terminateRpcServices(testingTimeout, rpcService1, rpcService2);
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testHeartbeatTimeoutWithTaskManager() throws Exception &lt;/p&gt;
{
 		final CompletableFuture&amp;lt;ResourceID&amp;gt; heartbeatResourceIdFuture = new CompletableFuture&amp;lt;&amp;gt;();
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
index c9c55a1da8f..f5f7f8e3415 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
@@ -41,6 +41,7 @@
 import org.apache.flink.runtime.jobmaster.SerializedInputSplit;
 import org.apache.flink.runtime.jobmaster.message.ClassloadingProps;
 import org.apache.flink.runtime.messages.Acknowledge;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;
 import org.apache.flink.runtime.messages.webmonitor.JobDetails;
 import org.apache.flink.runtime.query.KvStateLocation;
 import org.apache.flink.runtime.registration.RegistrationResponse;
@@ -144,7 +145,7 @@
 	private final Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer;
 
 	@Nonnull
-	private final Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer;
+	private final Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer;
 
 	@Nonnull
 	private final Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier;
@@ -183,7 +184,7 @@ public TestingJobMasterGateway(
 			@Nonnull Function&amp;lt;JobVertexID, CompletableFuture&amp;lt;OperatorBackPressureStatsResponse&amp;gt;&amp;gt; requestOperatorBackPressureStatsFunction,
 			@Nonnull BiConsumer&amp;lt;AllocationID, Throwable&amp;gt; notifyAllocationFailureConsumer,
 			@Nonnull Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer,
-			@Nonnull Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer,
+			@Nonnull Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer,
 			@Nonnull Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier,
 			@Nonnull BiFunction&amp;lt;JobID, String, CompletableFuture&amp;lt;KvStateLocation&amp;gt;&amp;gt; requestKvStateLocationFunction,
 			@Nonnull Function&amp;lt;Tuple6&amp;lt;JobID, JobVertexID, KeyGroupRange, String, KvStateID, InetSocketAddress&amp;gt;, CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; notifyKvStateRegisteredFunction,
@@ -335,8 +336,8 @@ public void acknowledgeCheckpoint(JobID jobID, ExecutionAttemptID executionAttem
 	}

&lt;p&gt; 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void declineCheckpoint(JobID jobID, ExecutionAttemptID executionAttemptID, long checkpointId, Throwable cause) {&lt;/li&gt;
	&lt;li&gt;declineCheckpointConsumer.accept(Tuple4.of(jobID, executionAttemptID, checkpointId, cause));&lt;br/&gt;
+	public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) 
{
+		declineCheckpointConsumer.accept(declineCheckpoint);
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Override&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
index e40b752f248..b52df9ee052 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
@@ -40,6 +40,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.jobmaster.SerializedInputSplit;&lt;br/&gt;
 import org.apache.flink.runtime.jobmaster.message.ClassloadingProps;&lt;br/&gt;
 import org.apache.flink.runtime.messages.Acknowledge;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.messages.webmonitor.JobDetails;&lt;br/&gt;
 import org.apache.flink.runtime.query.KvStateLocation;&lt;br/&gt;
 import org.apache.flink.runtime.query.UnknownKvStateLocation;&lt;br/&gt;
@@ -96,7 +97,7 @@&lt;br/&gt;
 	private Function&amp;lt;JobVertexID, CompletableFuture&amp;lt;OperatorBackPressureStatsResponse&amp;gt;&amp;gt; requestOperatorBackPressureStatsFunction = ignored -&amp;gt; CompletableFuture.completedFuture(OperatorBackPressureStatsResponse.of(null));&lt;br/&gt;
 	private BiConsumer&amp;lt;AllocationID, Throwable&amp;gt; notifyAllocationFailureConsumer = (ignoredA, ignoredB) -&amp;gt; {};&lt;br/&gt;
 	private Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer = ignored -&amp;gt; {};&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer = ignored -&amp;gt; {};&lt;br/&gt;
+	private Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer = ignored -&amp;gt; {};&lt;br/&gt;
 	private Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier = () -&amp;gt; JOB_MASTER_ID;&lt;br/&gt;
 	private BiFunction&amp;lt;JobID, String, CompletableFuture&amp;lt;KvStateLocation&amp;gt;&amp;gt; requestKvStateLocationFunction = (ignoredA, registrationName) -&amp;gt; FutureUtils.completedExceptionally(new UnknownKvStateLocation(registrationName));&lt;br/&gt;
 	private Function&amp;lt;Tuple6&amp;lt;JobID, JobVertexID, KeyGroupRange, String, KvStateID, InetSocketAddress&amp;gt;, CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; notifyKvStateRegisteredFunction = ignored -&amp;gt; CompletableFuture.completedFuture(Acknowledge.get());&lt;br/&gt;
@@ -222,7 +223,7 @@ public TestingJobMasterGatewayBuilder setAcknowledgeCheckpointConsumer(Consumer&amp;lt;&lt;br/&gt;
 		return this;&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public TestingJobMasterGatewayBuilder setDeclineCheckpointConsumer(Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer) {&lt;br/&gt;
+	public TestingJobMasterGatewayBuilder setDeclineCheckpointConsumer(Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer) 
{
 		this.declineCheckpointConsumer = declineCheckpointConsumer;
 		return this;
 	}&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16686192" author="githubbot" created="Wed, 14 Nov 2018 08:22:10 +0000"  >&lt;p&gt;dawidwys opened a new pull request #7093:  &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7093&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7093&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Invoking `declineCheckpoint` RPC endpoint with `DeclineCheckpoint` message in order to properly handle possible user  code specific exceptions&lt;/p&gt;

&lt;p&gt;   backport of #7082 for 1.7&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;How to verify the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Added IT test:&lt;/p&gt;

&lt;p&gt;   `org.apache.flink.runtime.jobmaster.JobMasterTest#testDeclineCheckpointInvocationWithUserException`&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16686195" author="githubbot" created="Wed, 14 Nov 2018 08:25:35 +0000"  >&lt;p&gt;dawidwys commented on issue #7090: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7090#issuecomment-438577794&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7090#issuecomment-438577794&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @tillrohrmann do you think it is ok to backport #7005? The `ClassLoaderUtils` were introduced in that PR that I am using in #7082. Changes in #7005 are somewhat related anyway.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16686347" author="githubbot" created="Wed, 14 Nov 2018 10:51:45 +0000"  >&lt;p&gt;dawidwys closed pull request #7093:  &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7093&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7093&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
index 22244f6cb8d..b8dc5545706 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
@@ -20,6 +20,7 @@&lt;/p&gt;

&lt;p&gt; import org.apache.flink.api.common.JobID;&lt;br/&gt;
 import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcGateway;&lt;/p&gt;

&lt;p&gt; public interface CheckpointCoordinatorGateway extends RpcGateway &lt;/p&gt;
{
@@ -31,9 +32,5 @@ void acknowledgeCheckpoint(
 			final CheckpointMetrics checkpointMetrics,
 			final TaskStateSnapshot subtaskState);
 
-	void declineCheckpoint(
-			JobID jobID,
-			ExecutionAttemptID executionAttemptID,
-			long checkpointId,
-			Throwable cause);
+	void declineCheckpoint(DeclineCheckpoint declineCheckpoint);
 }
&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
index 5d2d363cf71..40a675aca31 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
@@ -690,13 +690,7 @@ public void acknowledgeCheckpoint(&lt;/p&gt;

&lt;p&gt; 	// TODO: This method needs a leader session ID&lt;br/&gt;
 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void declineCheckpoint(&lt;/li&gt;
	&lt;li&gt;final JobID jobID,&lt;/li&gt;
	&lt;li&gt;final ExecutionAttemptID executionAttemptID,&lt;/li&gt;
	&lt;li&gt;final long checkpointID,&lt;/li&gt;
	&lt;li&gt;final Throwable reason) {&lt;/li&gt;
	&lt;li&gt;final DeclineCheckpoint decline = new DeclineCheckpoint(&lt;/li&gt;
	&lt;li&gt;jobID, executionAttemptID, checkpointID, reason);&lt;br/&gt;
+	public void declineCheckpoint(DeclineCheckpoint decline) {&lt;br/&gt;
 		final CheckpointCoordinator checkpointCoordinator = executionGraph.getCheckpointCoordinator();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		if (checkpointCoordinator != null) &lt;/p&gt;
{
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
index c90a8b5bbbc..2f656d09263 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
@@ -19,9 +19,13 @@
 package org.apache.flink.runtime.rpc;
 
 import org.apache.flink.api.common.time.Time;
+import org.apache.flink.runtime.concurrent.FutureUtils;
 
+import java.util.ArrayList;
+import java.util.Collection;
 import java.util.HashSet;
 import java.util.Set;
+import java.util.concurrent.CompletableFuture;
 import java.util.concurrent.ExecutionException;
 import java.util.concurrent.TimeUnit;
 import java.util.concurrent.TimeoutException;
@@ -87,6 +91,29 @@ public static void terminateRpcService(RpcService rpcService, Time timeout) thro
 		rpcService.stopService().get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Shuts the given rpc services down and waits for their termination.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param rpcServices to shut down&lt;br/&gt;
+	 * @param timeout for this operation&lt;br/&gt;
+	 * @throws InterruptedException if the operation has been interrupted&lt;br/&gt;
+	 * @throws ExecutionException if a problem occurred&lt;br/&gt;
+	 * @throws TimeoutException if a timeout occurred&lt;br/&gt;
+	 */&lt;br/&gt;
+	public static void terminateRpcServices(&lt;br/&gt;
+			Time timeout,&lt;br/&gt;
+			RpcService... rpcServices) throws InterruptedException, ExecutionException, TimeoutException {&lt;br/&gt;
+		final Collection&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; terminationFutures = new ArrayList&amp;lt;&amp;gt;(rpcServices.length);&lt;br/&gt;
+&lt;br/&gt;
+		for (RpcService service : rpcServices) {&lt;br/&gt;
+			if (service != null) &lt;/p&gt;
{
+				terminationFutures.add(service.stopService());
+			}
&lt;p&gt;+		}&lt;br/&gt;
+&lt;br/&gt;
+		FutureUtils.waitForAll(terminationFutures).get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
+	}&lt;br/&gt;
+&lt;br/&gt;
 	// We don&apos;t want this class to be instantiable&lt;br/&gt;
 	private RpcUtils() {}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
index c8f7357ab7e..10c9e2f123a 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
@@ -23,6 +23,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.CheckpointMetrics;&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.TaskStateSnapshot;&lt;br/&gt;
 import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.CheckpointResponder;&lt;br/&gt;
 import org.apache.flink.util.Preconditions;&lt;/p&gt;

&lt;p&gt;@@ -57,6 +58,9 @@ public void declineCheckpoint(&lt;br/&gt;
 			long checkpointId,&lt;br/&gt;
 			Throwable cause) &lt;/p&gt;
{
 
-		checkpointCoordinatorGateway.declineCheckpoint(jobID, executionAttemptID, checkpointId, cause);
+		checkpointCoordinatorGateway.declineCheckpoint(new DeclineCheckpoint(jobID,
+			executionAttemptID,
+			checkpointId,
+			cause));
 	}
&lt;p&gt; }&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
index f3c72545e69..b1f02845c14 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
@@ -33,6 +33,7 @@&lt;br/&gt;
 import org.apache.flink.core.io.InputSplitSource;&lt;br/&gt;
 import org.apache.flink.core.testutils.OneShotLatch;&lt;br/&gt;
 import org.apache.flink.queryablestate.KvStateID;&lt;br/&gt;
+import org.apache.flink.runtime.akka.AkkaUtils;&lt;br/&gt;
 import org.apache.flink.runtime.blob.BlobServer;&lt;br/&gt;
 import org.apache.flink.runtime.blob.VoidBlobStore;&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.CheckpointProperties;&lt;br/&gt;
@@ -84,14 +85,17 @@&lt;br/&gt;
 import org.apache.flink.runtime.leaderretrieval.SettableLeaderRetrievalService;&lt;br/&gt;
 import org.apache.flink.runtime.messages.Acknowledge;&lt;br/&gt;
 import org.apache.flink.runtime.messages.FlinkJobNotFoundException;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.query.KvStateLocation;&lt;br/&gt;
 import org.apache.flink.runtime.query.UnknownKvStateLocation;&lt;br/&gt;
 import org.apache.flink.runtime.registration.RegistrationResponse;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.ResourceManagerId;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.SlotRequest;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.utils.TestingResourceManagerGateway;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.RpcService;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcUtils;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.TestingRpcService;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.akka.AkkaRpcService;&lt;br/&gt;
 import org.apache.flink.runtime.state.CompletedCheckpointStorageLocation;&lt;br/&gt;
 import org.apache.flink.runtime.state.KeyGroupRange;&lt;br/&gt;
 import org.apache.flink.runtime.state.OperatorStreamStateHandle;&lt;br/&gt;
@@ -106,12 +110,15 @@&lt;br/&gt;
 import org.apache.flink.runtime.testtasks.BlockingNoOpInvokable;&lt;br/&gt;
 import org.apache.flink.runtime.testtasks.NoOpInvokable;&lt;br/&gt;
 import org.apache.flink.runtime.util.TestingFatalErrorHandler;&lt;br/&gt;
+import org.apache.flink.testutils.ClassLoaderUtils;&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
 import org.apache.flink.util.FlinkException;&lt;br/&gt;
 import org.apache.flink.util.InstantiationUtil;&lt;br/&gt;
+import org.apache.flink.util.SerializedThrowable;&lt;br/&gt;
 import org.apache.flink.util.TestLogger;&lt;br/&gt;
 import org.apache.flink.util.function.SupplierWithException;&lt;/p&gt;

&lt;p&gt;+import akka.actor.ActorSystem;&lt;br/&gt;
 import org.hamcrest.Matcher;&lt;br/&gt;
 import org.hamcrest.Matchers;&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
@@ -130,6 +137,7 @@&lt;br/&gt;
 import java.io.IOException;&lt;br/&gt;
 import java.net.InetAddress;&lt;br/&gt;
 import java.net.InetSocketAddress;&lt;br/&gt;
+import java.net.URLClassLoader;&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Arrays;&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
@@ -248,6 +256,75 @@ public static void teardownClass() {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testDeclineCheckpointInvocationWithUserException() throws Exception {&lt;br/&gt;
+		RpcService rpcService1 = null;&lt;br/&gt;
+		RpcService rpcService2 = null;&lt;br/&gt;
+		try {&lt;br/&gt;
+			final ActorSystem actorSystem1 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+			final ActorSystem actorSystem2 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+&lt;br/&gt;
+			rpcService1 = new AkkaRpcService(actorSystem1, testingTimeout);&lt;br/&gt;
+			rpcService2 = new AkkaRpcService(actorSystem2, testingTimeout);&lt;br/&gt;
+&lt;br/&gt;
+			final CompletableFuture&amp;lt;Throwable&amp;gt; declineCheckpointMessageFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+			final JobManagerSharedServices jobManagerSharedServices = new TestingJobManagerSharedServicesBuilder().build();&lt;br/&gt;
+			final JobMasterConfiguration jobMasterConfiguration = JobMasterConfiguration.fromConfiguration(configuration);&lt;br/&gt;
+			final JobMaster jobMaster = new JobMaster(&lt;br/&gt;
+				rpcService1,&lt;br/&gt;
+				jobMasterConfiguration,&lt;br/&gt;
+				jmResourceId,&lt;br/&gt;
+				jobGraph,&lt;br/&gt;
+				haServices,&lt;br/&gt;
+				DefaultSlotPoolFactory.fromConfiguration(configuration, rpcService1),&lt;br/&gt;
+				jobManagerSharedServices,&lt;br/&gt;
+				heartbeatServices,&lt;br/&gt;
+				blobServer,&lt;br/&gt;
+				UnregisteredJobManagerJobMetricGroupFactory.INSTANCE,&lt;br/&gt;
+				new NoOpOnCompletionActions(),&lt;br/&gt;
+				testingFatalErrorHandler,&lt;br/&gt;
+				JobMasterTest.class.getClassLoader()) {&lt;br/&gt;
+				@Override&lt;br/&gt;
+				public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) &lt;/p&gt;
{
+					declineCheckpointMessageFuture.complete(declineCheckpoint.getReason());
+				}
&lt;p&gt;+			};&lt;br/&gt;
+&lt;br/&gt;
+			jobMaster.start(jobMasterId, testingTimeout).get();&lt;br/&gt;
+&lt;br/&gt;
+			final String className = &quot;UserException&quot;;&lt;br/&gt;
+			final URLClassLoader userClassLoader = ClassLoaderUtils.compileAndLoadJava(&lt;br/&gt;
+				temporaryFolder.newFolder(),&lt;br/&gt;
+				className + &quot;.java&quot;,&lt;br/&gt;
+				String.format(&quot;public class %s extends RuntimeException { public %s() &lt;/p&gt;
{super(\&quot;UserMessage\&quot;);}
&lt;p&gt; }&quot;,&lt;br/&gt;
+					className,&lt;br/&gt;
+					className));&lt;br/&gt;
+&lt;br/&gt;
+			Throwable userException = (Throwable) Class.forName(className, false, userClassLoader).newInstance();&lt;br/&gt;
+&lt;br/&gt;
+			CompletableFuture&amp;lt;JobMasterGateway&amp;gt; jobMasterGateway =&lt;br/&gt;
+				rpcService2.connect(jobMaster.getAddress(), jobMaster.getFencingToken(), JobMasterGateway.class);&lt;br/&gt;
+&lt;br/&gt;
+			jobMasterGateway.thenAccept(gateway -&amp;gt; &lt;/p&gt;
{
+				gateway.declineCheckpoint(new DeclineCheckpoint(
+						jobGraph.getJobID(),
+						new ExecutionAttemptID(1, 1),
+						1,
+						userException
+					)
+				);
+			}
&lt;p&gt;);&lt;br/&gt;
+&lt;br/&gt;
+			Throwable throwable = declineCheckpointMessageFuture.get(testingTimeout.toMilliseconds(),&lt;br/&gt;
+				TimeUnit.MILLISECONDS);&lt;br/&gt;
+			assertThat(throwable, instanceOf(SerializedThrowable.class));&lt;br/&gt;
+			assertThat(throwable.getMessage(), equalTo(userException.getMessage()));&lt;br/&gt;
+		} finally &lt;/p&gt;
{
+			RpcUtils.terminateRpcServices(testingTimeout, rpcService1, rpcService2);
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testHeartbeatTimeoutWithTaskManager() throws Exception &lt;/p&gt;
{
 		final CompletableFuture&amp;lt;ResourceID&amp;gt; heartbeatResourceIdFuture = new CompletableFuture&amp;lt;&amp;gt;();
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
index c9c55a1da8f..f5f7f8e3415 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
@@ -41,6 +41,7 @@
 import org.apache.flink.runtime.jobmaster.SerializedInputSplit;
 import org.apache.flink.runtime.jobmaster.message.ClassloadingProps;
 import org.apache.flink.runtime.messages.Acknowledge;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;
 import org.apache.flink.runtime.messages.webmonitor.JobDetails;
 import org.apache.flink.runtime.query.KvStateLocation;
 import org.apache.flink.runtime.registration.RegistrationResponse;
@@ -144,7 +145,7 @@
 	private final Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer;
 
 	@Nonnull
-	private final Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer;
+	private final Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer;
 
 	@Nonnull
 	private final Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier;
@@ -183,7 +184,7 @@ public TestingJobMasterGateway(
 			@Nonnull Function&amp;lt;JobVertexID, CompletableFuture&amp;lt;OperatorBackPressureStatsResponse&amp;gt;&amp;gt; requestOperatorBackPressureStatsFunction,
 			@Nonnull BiConsumer&amp;lt;AllocationID, Throwable&amp;gt; notifyAllocationFailureConsumer,
 			@Nonnull Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer,
-			@Nonnull Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer,
+			@Nonnull Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer,
 			@Nonnull Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier,
 			@Nonnull BiFunction&amp;lt;JobID, String, CompletableFuture&amp;lt;KvStateLocation&amp;gt;&amp;gt; requestKvStateLocationFunction,
 			@Nonnull Function&amp;lt;Tuple6&amp;lt;JobID, JobVertexID, KeyGroupRange, String, KvStateID, InetSocketAddress&amp;gt;, CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; notifyKvStateRegisteredFunction,
@@ -335,8 +336,8 @@ public void acknowledgeCheckpoint(JobID jobID, ExecutionAttemptID executionAttem
 	}

&lt;p&gt; 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void declineCheckpoint(JobID jobID, ExecutionAttemptID executionAttemptID, long checkpointId, Throwable cause) {&lt;/li&gt;
	&lt;li&gt;declineCheckpointConsumer.accept(Tuple4.of(jobID, executionAttemptID, checkpointId, cause));&lt;br/&gt;
+	public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) 
{
+		declineCheckpointConsumer.accept(declineCheckpoint);
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Override&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
index e40b752f248..b52df9ee052 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
@@ -40,6 +40,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.jobmaster.SerializedInputSplit;&lt;br/&gt;
 import org.apache.flink.runtime.jobmaster.message.ClassloadingProps;&lt;br/&gt;
 import org.apache.flink.runtime.messages.Acknowledge;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.messages.webmonitor.JobDetails;&lt;br/&gt;
 import org.apache.flink.runtime.query.KvStateLocation;&lt;br/&gt;
 import org.apache.flink.runtime.query.UnknownKvStateLocation;&lt;br/&gt;
@@ -96,7 +97,7 @@&lt;br/&gt;
 	private Function&amp;lt;JobVertexID, CompletableFuture&amp;lt;OperatorBackPressureStatsResponse&amp;gt;&amp;gt; requestOperatorBackPressureStatsFunction = ignored -&amp;gt; CompletableFuture.completedFuture(OperatorBackPressureStatsResponse.of(null));&lt;br/&gt;
 	private BiConsumer&amp;lt;AllocationID, Throwable&amp;gt; notifyAllocationFailureConsumer = (ignoredA, ignoredB) -&amp;gt; {};&lt;br/&gt;
 	private Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer = ignored -&amp;gt; {};&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer = ignored -&amp;gt; {};&lt;br/&gt;
+	private Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer = ignored -&amp;gt; {};&lt;br/&gt;
 	private Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier = () -&amp;gt; JOB_MASTER_ID;&lt;br/&gt;
 	private BiFunction&amp;lt;JobID, String, CompletableFuture&amp;lt;KvStateLocation&amp;gt;&amp;gt; requestKvStateLocationFunction = (ignoredA, registrationName) -&amp;gt; FutureUtils.completedExceptionally(new UnknownKvStateLocation(registrationName));&lt;br/&gt;
 	private Function&amp;lt;Tuple6&amp;lt;JobID, JobVertexID, KeyGroupRange, String, KvStateID, InetSocketAddress&amp;gt;, CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; notifyKvStateRegisteredFunction = ignored -&amp;gt; CompletableFuture.completedFuture(Acknowledge.get());&lt;br/&gt;
@@ -222,7 +223,7 @@ public TestingJobMasterGatewayBuilder setAcknowledgeCheckpointConsumer(Consumer&amp;lt;&lt;br/&gt;
 		return this;&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public TestingJobMasterGatewayBuilder setDeclineCheckpointConsumer(Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer) {&lt;br/&gt;
+	public TestingJobMasterGatewayBuilder setDeclineCheckpointConsumer(Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer) 
{
 		this.declineCheckpointConsumer = declineCheckpointConsumer;
 		return this;
 	}&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16686356" author="githubbot" created="Wed, 14 Nov 2018 10:53:35 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7093:  &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7093#discussion_r233398912&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7093#discussion_r233398912&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -248,6 +256,75 @@ public static void teardownClass() {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testDeclineCheckpointInvocationWithUserException() throws Exception {&lt;br/&gt;
+		RpcService rpcService1 = null;&lt;br/&gt;
+		RpcService rpcService2 = null;&lt;br/&gt;
+		try {&lt;br/&gt;
+			final ActorSystem actorSystem1 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+			final ActorSystem actorSystem2 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+&lt;br/&gt;
+			rpcService1 = new AkkaRpcService(actorSystem1, testingTimeout);&lt;br/&gt;
+			rpcService2 = new AkkaRpcService(actorSystem2, testingTimeout);&lt;br/&gt;
+&lt;br/&gt;
+			final CompletableFuture&amp;lt;Throwable&amp;gt; declineCheckpointMessageFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+			final JobManagerSharedServices jobManagerSharedServices = new TestingJobManagerSharedServicesBuilder().build();&lt;br/&gt;
+			final JobMasterConfiguration jobMasterConfiguration = JobMasterConfiguration.fromConfiguration(configuration);&lt;br/&gt;
+			final JobMaster jobMaster = new JobMaster(&lt;br/&gt;
+				rpcService1,&lt;br/&gt;
+				jobMasterConfiguration,&lt;br/&gt;
+				jmResourceId,&lt;br/&gt;
+				jobGraph,&lt;br/&gt;
+				haServices,&lt;br/&gt;
+				DefaultSlotPoolFactory.fromConfiguration(configuration, rpcService1),&lt;br/&gt;
+				jobManagerSharedServices,&lt;br/&gt;
+				heartbeatServices,&lt;br/&gt;
+				blobServer,&lt;br/&gt;
+				UnregisteredJobManagerJobMetricGroupFactory.INSTANCE,&lt;br/&gt;
+				new NoOpOnCompletionActions(),&lt;br/&gt;
+				testingFatalErrorHandler,&lt;br/&gt;
+				JobMasterTest.class.getClassLoader()) {&lt;br/&gt;
+				@Override&lt;br/&gt;
+				public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) &lt;/p&gt;
{
+					declineCheckpointMessageFuture.complete(declineCheckpoint.getReason());
+				}
&lt;p&gt;+			};&lt;br/&gt;
+&lt;br/&gt;
+			jobMaster.start(jobMasterId, testingTimeout).get();&lt;br/&gt;
+&lt;br/&gt;
+			final String className = &quot;UserException&quot;;&lt;br/&gt;
+			final URLClassLoader userClassLoader = ClassLoaderUtils.compileAndLoadJava(&lt;br/&gt;
+				temporaryFolder.newFolder(),&lt;br/&gt;
+				className + &quot;.java&quot;,&lt;br/&gt;
+				String.format(&quot;public class %s extends RuntimeException { public %s() &lt;/p&gt;
{super(\&quot;UserMessage\&quot;);}
&lt;p&gt; }&quot;,&lt;br/&gt;
+					className,&lt;br/&gt;
+					className));&lt;br/&gt;
+&lt;br/&gt;
+			Throwable userException = (Throwable) Class.forName(className, false, userClassLoader).newInstance();&lt;br/&gt;
+&lt;br/&gt;
+			CompletableFuture&amp;lt;JobMasterGateway&amp;gt; jobMasterGateway =&lt;br/&gt;
+				rpcService2.connect(jobMaster.getAddress(), jobMaster.getFencingToken(), JobMasterGateway.class);&lt;br/&gt;
+&lt;br/&gt;
+			jobMasterGateway.thenAccept(gateway -&amp;gt; {&lt;br/&gt;
+				gateway.declineCheckpoint(new DeclineCheckpoint(&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Could we actually instantiate a `RpcCheckpointResponder` instead of calling directly on the gateway. I think this is also part of the code which should be tested.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16686446" author="githubbot" created="Wed, 14 Nov 2018 12:26:49 +0000"  >&lt;p&gt;dawidwys opened a new pull request #7096: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Call JobMasterGateway through RpcCheckpointResponder in&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7096&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7096&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Improved test to call `JobMasterGateway` through `RpcCheckpointResponder`.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16687637" author="githubbot" created="Thu, 15 Nov 2018 08:25:33 +0000"  >&lt;p&gt;dawidwys closed pull request #7090: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Using DeclineCheckpoint message class when invoking RPC declineCheckpoint &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7090&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7090&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-core/src/test/java/org/apache/flink/api/common/typeutils/base/EnumSerializerUpgradeTest.java b/flink-core/src/test/java/org/apache/flink/api/common/typeutils/base/EnumSerializerUpgradeTest.java&lt;br/&gt;
index 6502eb32942..2bcae452287 100644&lt;br/&gt;
&amp;#8212; a/flink-core/src/test/java/org/apache/flink/api/common/typeutils/base/EnumSerializerUpgradeTest.java&lt;br/&gt;
+++ b/flink-core/src/test/java/org/apache/flink/api/common/typeutils/base/EnumSerializerUpgradeTest.java&lt;br/&gt;
@@ -23,21 +23,17 @@&lt;br/&gt;
 import org.apache.flink.api.common.typeutils.TypeSerializerSerializationUtil;&lt;br/&gt;
 import org.apache.flink.core.memory.DataInputViewStreamWrapper;&lt;br/&gt;
 import org.apache.flink.core.memory.DataOutputViewStreamWrapper;&lt;br/&gt;
+import org.apache.flink.testutils.ClassLoaderUtils;&lt;br/&gt;
 import org.apache.flink.util.TestLogger;&lt;br/&gt;
+&lt;br/&gt;
 import org.junit.Assert;&lt;br/&gt;
 import org.junit.ClassRule;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
 import org.junit.rules.TemporaryFolder;&lt;/p&gt;

&lt;p&gt;-import javax.tools.JavaCompiler;&lt;br/&gt;
-import javax.tools.ToolProvider;&lt;br/&gt;
 import java.io.ByteArrayInputStream;&lt;br/&gt;
 import java.io.ByteArrayOutputStream;&lt;br/&gt;
-import java.io.File;&lt;br/&gt;
-import java.io.FileWriter;&lt;br/&gt;
 import java.io.IOException;&lt;br/&gt;
-import java.net.URL;&lt;br/&gt;
-import java.net.URLClassLoader;&lt;/p&gt;

&lt;p&gt; public class EnumSerializerUpgradeTest extends TestLogger {&lt;/p&gt;

&lt;p&gt;@@ -87,7 +83,7 @@ public void checkDifferentFieldOrder() throws Exception {&lt;br/&gt;
 	private static CompatibilityResult checkCompatibility(String enumSourceA, String enumSourceB)&lt;br/&gt;
 		throws IOException, ClassNotFoundException &lt;/p&gt;
{
 
-		ClassLoader classLoader = compileAndLoadEnum(
+		ClassLoader classLoader = ClassLoaderUtils.compileAndLoadJava(
 			temporaryFolder.newFolder(), ENUM_NAME + &quot;.java&quot;, enumSourceA);
 
 		EnumSerializer enumSerializer = new EnumSerializer(classLoader.loadClass(ENUM_NAME));
@@ -102,7 +98,7 @@ private static CompatibilityResult checkCompatibility(String enumSourceA, String
 			snapshotBytes = outBuffer.toByteArray();
 		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ClassLoader classLoader2 = compileAndLoadEnum(&lt;br/&gt;
+		ClassLoader classLoader2 = ClassLoaderUtils.compileAndLoadJava(&lt;br/&gt;
 			temporaryFolder.newFolder(), ENUM_NAME + &quot;.java&quot;, enumSourceB);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		TypeSerializerConfigSnapshot restoredSnapshot;&lt;br/&gt;
@@ -116,29 +112,4 @@ private static CompatibilityResult checkCompatibility(String enumSourceA, String&lt;br/&gt;
 		EnumSerializer enumSerializer2 = new EnumSerializer(classLoader2.loadClass(ENUM_NAME));&lt;br/&gt;
 		return enumSerializer2.ensureCompatibility(restoredSnapshot);&lt;br/&gt;
 	}&lt;br/&gt;
-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static ClassLoader compileAndLoadEnum(File root, String filename, String source) throws IOException {&lt;/li&gt;
	&lt;li&gt;File file = writeSourceFile(root, filename, source);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;compileClass(file);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;return new URLClassLoader(&lt;/li&gt;
	&lt;li&gt;new URL[]
{root.toURI().toURL()},&lt;br/&gt;
-			Thread.currentThread().getContextClassLoader());&lt;br/&gt;
-	}&lt;br/&gt;
-&lt;br/&gt;
-	private static File writeSourceFile(File root, String filename, String source) throws IOException {
-		File file = new File(root, filename);
-		FileWriter fileWriter = new FileWriter(file);
-
-		fileWriter.write(source);
-		fileWriter.close();
-
-		return file;
-	}&lt;br/&gt;
-&lt;br/&gt;
-	private static int compileClass(File sourceFile) {
-		JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();
-		return compiler.run(null, null, null, sourceFile.getPath());
-	}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-core/src/test/java/org/apache/flink/testutils/ClassLoaderUtils.java b/flink-core/src/test/java/org/apache/flink/testutils/ClassLoaderUtils.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..0688c1df156&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/flink-core/src/test/java/org/apache/flink/testutils/ClassLoaderUtils.java&lt;br/&gt;
@@ -0,0 +1,59 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.testutils;&lt;br/&gt;
+&lt;br/&gt;
+import javax.tools.JavaCompiler;&lt;br/&gt;
+import javax.tools.ToolProvider;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.File;&lt;br/&gt;
+import java.io.FileWriter;&lt;br/&gt;
+import java.io.IOException;&lt;br/&gt;
+import java.net.URL;&lt;br/&gt;
+import java.net.URLClassLoader;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Utilities to create class loaders.&lt;br/&gt;
+ */&lt;br/&gt;
+public class ClassLoaderUtils {&lt;br/&gt;
+	public static URLClassLoader compileAndLoadJava(File root, String filename, String source) throws&lt;br/&gt;
+		IOException {&lt;br/&gt;
+		File file = writeSourceFile(root, filename, source);&lt;br/&gt;
+&lt;br/&gt;
+		compileClass(file);&lt;br/&gt;
+&lt;br/&gt;
+		return new URLClassLoader(&lt;br/&gt;
+			new URL[]{root.toURI().toURL()}
&lt;p&gt;,&lt;br/&gt;
+			Thread.currentThread().getContextClassLoader());&lt;br/&gt;
+	}&lt;br/&gt;
+&lt;br/&gt;
+	private static File writeSourceFile(File root, String filename, String source) throws IOException &lt;/p&gt;
{
+		File file = new File(root, filename);
+		FileWriter fileWriter = new FileWriter(file);
+
+		fileWriter.write(source);
+		fileWriter.close();
+
+		return file;
+	}
&lt;p&gt;+&lt;br/&gt;
+	private static int compileClass(File sourceFile) &lt;/p&gt;
{
+		JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();
+		return compiler.run(null, null, null, &quot;-proc:none&quot;, sourceFile.getPath());
+	}
&lt;p&gt;+}&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
index 22244f6cb8d..b8dc5545706 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinatorGateway.java&lt;br/&gt;
@@ -20,6 +20,7 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import org.apache.flink.api.common.JobID;&lt;br/&gt;
 import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcGateway;&lt;/p&gt;

&lt;p&gt; public interface CheckpointCoordinatorGateway extends RpcGateway &lt;/p&gt;
{
@@ -31,9 +32,5 @@ void acknowledgeCheckpoint(
 			final CheckpointMetrics checkpointMetrics,
 			final TaskStateSnapshot subtaskState);
 
-	void declineCheckpoint(
-			JobID jobID,
-			ExecutionAttemptID executionAttemptID,
-			long checkpointId,
-			Throwable cause);
+	void declineCheckpoint(DeclineCheckpoint declineCheckpoint);
 }
&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
index cd102b32f89..269f23e6781 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
@@ -687,13 +687,7 @@ public void acknowledgeCheckpoint(&lt;/p&gt;

&lt;p&gt; 	// TODO: This method needs a leader session ID&lt;br/&gt;
 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void declineCheckpoint(&lt;/li&gt;
	&lt;li&gt;final JobID jobID,&lt;/li&gt;
	&lt;li&gt;final ExecutionAttemptID executionAttemptID,&lt;/li&gt;
	&lt;li&gt;final long checkpointID,&lt;/li&gt;
	&lt;li&gt;final Throwable reason) {&lt;/li&gt;
	&lt;li&gt;final DeclineCheckpoint decline = new DeclineCheckpoint(&lt;/li&gt;
	&lt;li&gt;jobID, executionAttemptID, checkpointID, reason);&lt;br/&gt;
+	public void declineCheckpoint(DeclineCheckpoint decline) {&lt;br/&gt;
 		final CheckpointCoordinator checkpointCoordinator = executionGraph.getCheckpointCoordinator();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		if (checkpointCoordinator != null) &lt;/p&gt;
{
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
index c90a8b5bbbc..2f656d09263 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/RpcUtils.java
@@ -19,9 +19,13 @@
 package org.apache.flink.runtime.rpc;
 
 import org.apache.flink.api.common.time.Time;
+import org.apache.flink.runtime.concurrent.FutureUtils;
 
+import java.util.ArrayList;
+import java.util.Collection;
 import java.util.HashSet;
 import java.util.Set;
+import java.util.concurrent.CompletableFuture;
 import java.util.concurrent.ExecutionException;
 import java.util.concurrent.TimeUnit;
 import java.util.concurrent.TimeoutException;
@@ -87,6 +91,29 @@ public static void terminateRpcService(RpcService rpcService, Time timeout) thro
 		rpcService.stopService().get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Shuts the given rpc services down and waits for their termination.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param rpcServices to shut down&lt;br/&gt;
+	 * @param timeout for this operation&lt;br/&gt;
+	 * @throws InterruptedException if the operation has been interrupted&lt;br/&gt;
+	 * @throws ExecutionException if a problem occurred&lt;br/&gt;
+	 * @throws TimeoutException if a timeout occurred&lt;br/&gt;
+	 */&lt;br/&gt;
+	public static void terminateRpcServices(&lt;br/&gt;
+			Time timeout,&lt;br/&gt;
+			RpcService... rpcServices) throws InterruptedException, ExecutionException, TimeoutException {&lt;br/&gt;
+		final Collection&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; terminationFutures = new ArrayList&amp;lt;&amp;gt;(rpcServices.length);&lt;br/&gt;
+&lt;br/&gt;
+		for (RpcService service : rpcServices) {&lt;br/&gt;
+			if (service != null) &lt;/p&gt;
{
+				terminationFutures.add(service.stopService());
+			}
&lt;p&gt;+		}&lt;br/&gt;
+&lt;br/&gt;
+		FutureUtils.waitForAll(terminationFutures).get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
+	}&lt;br/&gt;
+&lt;br/&gt;
 	// We don&apos;t want this class to be instantiable&lt;br/&gt;
 	private RpcUtils() {}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/messages/RemoteRpcInvocation.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/messages/RemoteRpcInvocation.java&lt;br/&gt;
index 7b9fb887670..486816de8e8 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/messages/RemoteRpcInvocation.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rpc/messages/RemoteRpcInvocation.java&lt;br/&gt;
@@ -203,12 +203,18 @@ private void readObject(ObjectInputStream ois) throws IOException, ClassNotFound&lt;br/&gt;
 				try &lt;/p&gt;
{
 					parameterTypes[i] = (Class&amp;lt;?&amp;gt;) ois.readObject();
 				}
&lt;p&gt; catch (IOException e) &lt;/p&gt;
{
+					StringBuilder incompleteMethod = getIncompleteMethodString(i, 0);
 					throw new IOException(&quot;Could not deserialize &quot; + i + &quot;th parameter type of method &quot; +
-						methodName + &apos;.&apos;, e);
+						incompleteMethod + &apos;.&apos;, e);
 				}
&lt;p&gt; catch (ClassNotFoundException e) &lt;/p&gt;
{
-					throw new ClassNotFoundException(&quot;Could not deserialize &quot; + i + &quot;th &quot; +
-						&quot;parameter type of method &quot; + methodName + &quot;. This indicates that the parameter &quot; +
-						&quot;type is not part of the system class loader.&quot;, e);
+					// note: wrapping this CNFE into another CNFE does not overwrite the Exception
+					//       stored in the ObjectInputStream (see ObjectInputStream#readSerialData)
+					// -&amp;gt; add a suppressed exception that adds a more specific message
+					StringBuilder incompleteMethod = getIncompleteMethodString(i, 0);
+					e.addSuppressed(new ClassNotFoundException(&quot;Could not deserialize &quot; + i + &quot;th &quot; +
+						&quot;parameter type of method &quot; + incompleteMethod + &quot;. This indicates that the parameter &quot; +
+						&quot;type is not part of the system class loader.&quot;));
+					throw e;
 				}
&lt;p&gt; 			}&lt;/p&gt;

&lt;p&gt;@@ -221,17 +227,37 @@ private void readObject(ObjectInputStream ois) throws IOException, ClassNotFound&lt;br/&gt;
 					try &lt;/p&gt;
{
 						args[i] = ois.readObject();
 					}
&lt;p&gt; catch (IOException e) &lt;/p&gt;
{
+						StringBuilder incompleteMethod = getIncompleteMethodString(length, i);
 						throw new IOException(&quot;Could not deserialize &quot; + i + &quot;th argument of method &quot; +
-							methodName + &apos;.&apos;, e);
+							incompleteMethod + &apos;.&apos;, e);
 					}
&lt;p&gt; catch (ClassNotFoundException e) &lt;/p&gt;
{
-						throw new ClassNotFoundException(&quot;Could not deserialize &quot; + i + &quot;th &quot; +
-							&quot;argument of method &quot; + methodName + &quot;. This indicates that the argument &quot; +
-							&quot;type is not part of the system class loader.&quot;, e);
+						// note: wrapping this CNFE into another CNFE does not overwrite the Exception
+						//       stored in the ObjectInputStream (see ObjectInputStream#readSerialData)
+						// -&amp;gt; add a suppressed exception that adds a more specific message
+						StringBuilder incompleteMethod = getIncompleteMethodString(length, i);
+						e.addSuppressed(new ClassNotFoundException(&quot;Could not deserialize &quot; + i + &quot;th &quot; +
+							&quot;argument of method &quot; + incompleteMethod + &quot;. This indicates that the argument &quot; +
+							&quot;type is not part of the system class loader.&quot;));
+						throw e;
 					}
&lt;p&gt; 				}&lt;br/&gt;
 			} else &lt;/p&gt;
{
 				args = null;
 			}
&lt;p&gt; 		}&lt;br/&gt;
+&lt;br/&gt;
+		private StringBuilder getIncompleteMethodString(int lastMethodTypeIdx, int lastArgumentIdx) {&lt;br/&gt;
+			StringBuilder incompleteMethod = new StringBuilder();&lt;br/&gt;
+			incompleteMethod.append(methodName).append(&apos;(&apos;);&lt;br/&gt;
+			for (int i = 0; i &amp;lt; lastMethodTypeIdx; ++i) {&lt;br/&gt;
+				incompleteMethod.append(parameterTypes&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.getCanonicalName());&lt;br/&gt;
+				if (i &amp;lt; lastArgumentIdx) &lt;/p&gt;
{
+					incompleteMethod.append(&quot;: &quot;).append(args[i]);
+				}
&lt;p&gt;+				incompleteMethod.append(&quot;, &quot;);&lt;br/&gt;
+			}&lt;br/&gt;
+			incompleteMethod.append(&quot;...)&quot;); // some parameters could not be deserialized&lt;br/&gt;
+			return incompleteMethod;&lt;br/&gt;
+		}&lt;br/&gt;
 	}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
index c8f7357ab7e..10c9e2f123a 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
@@ -23,6 +23,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.CheckpointMetrics;&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.TaskStateSnapshot;&lt;br/&gt;
 import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.CheckpointResponder;&lt;br/&gt;
 import org.apache.flink.util.Preconditions;&lt;/p&gt;

&lt;p&gt;@@ -57,6 +58,9 @@ public void declineCheckpoint(&lt;br/&gt;
 			long checkpointId,&lt;br/&gt;
 			Throwable cause) &lt;/p&gt;
{
 
-		checkpointCoordinatorGateway.declineCheckpoint(jobID, executionAttemptID, checkpointId, cause);
+		checkpointCoordinatorGateway.declineCheckpoint(new DeclineCheckpoint(jobID,
+			executionAttemptID,
+			checkpointId,
+			cause));
 	}
&lt;p&gt; }&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/classloading/ClassLoaderTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/classloading/ClassLoaderTest.java&lt;br/&gt;
index c02278c5088..7c664ce0b32 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/classloading/ClassLoaderTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/classloading/ClassLoaderTest.java&lt;br/&gt;
@@ -19,21 +19,78 @@&lt;br/&gt;
 package org.apache.flink.runtime.classloading;&lt;/p&gt;

&lt;p&gt; import org.apache.flink.runtime.execution.librarycache.FlinkUserCodeClassLoaders;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.messages.RemoteRpcInvocation;&lt;br/&gt;
+import org.apache.flink.testutils.ClassLoaderUtils;&lt;br/&gt;
+import org.apache.flink.util.SerializedValue;&lt;br/&gt;
 import org.apache.flink.util.TestLogger;&lt;/p&gt;

&lt;p&gt;+import org.junit.ClassRule;&lt;br/&gt;
+import org.junit.Rule;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
+import org.junit.rules.ExpectedException;&lt;br/&gt;
+import org.junit.rules.TemporaryFolder;&lt;/p&gt;

&lt;p&gt; import java.net.URL;&lt;br/&gt;
 import java.net.URLClassLoader;&lt;/p&gt;

&lt;p&gt;+import static org.hamcrest.CoreMatchers.allOf;&lt;br/&gt;
+import static org.hamcrest.CoreMatchers.containsString;&lt;br/&gt;
+import static org.hamcrest.CoreMatchers.isA;&lt;br/&gt;
+import static org.hamcrest.Matchers.hasItemInArray;&lt;br/&gt;
+import static org.hamcrest.Matchers.hasProperty;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
 import static org.junit.Assert.assertNotEquals;&lt;/p&gt;

&lt;p&gt; /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Tests for classloading and class loder utilities.&lt;br/&gt;
+ * Tests for classloading and class loader utilities.&lt;br/&gt;
  */&lt;br/&gt;
 public class ClassLoaderTest extends TestLogger {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+	@ClassRule&lt;br/&gt;
+	public static TemporaryFolder temporaryFolder = new TemporaryFolder();&lt;br/&gt;
+&lt;br/&gt;
+	@Rule&lt;br/&gt;
+	public ExpectedException expectedException = ExpectedException.none();&lt;br/&gt;
+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testMessageDecodingWithUnavailableClass() throws Exception {&lt;br/&gt;
+		final ClassLoader systemClassLoader = getClass().getClassLoader();&lt;br/&gt;
+&lt;br/&gt;
+		final String className = &quot;UserClass&quot;;&lt;br/&gt;
+		final URLClassLoader userClassLoader = ClassLoaderUtils.compileAndLoadJava(&lt;br/&gt;
+			temporaryFolder.newFolder(),&lt;br/&gt;
+			className + &quot;.java&quot;,&lt;br/&gt;
+			&quot;import java.io.Serializable;\n&quot;&lt;br/&gt;
+				+ &quot;public class &quot; + className + &quot; implements Serializable {}&quot;);&lt;br/&gt;
+&lt;br/&gt;
+		RemoteRpcInvocation method = new RemoteRpcInvocation(&lt;br/&gt;
+			&quot;test&quot;,&lt;br/&gt;
+			new Class&amp;lt;?&amp;gt;[] &lt;/p&gt;
{
+				int.class,
+				Class.forName(className, false, userClassLoader)}
&lt;p&gt;,&lt;br/&gt;
+			new Object[] &lt;/p&gt;
{
+				1,
+				Class.forName(className, false, userClassLoader).newInstance()}
&lt;p&gt;);&lt;br/&gt;
+&lt;br/&gt;
+		SerializedValue&amp;lt;RemoteRpcInvocation&amp;gt; serializedMethod = new SerializedValue&amp;lt;&amp;gt;(method);&lt;br/&gt;
+&lt;br/&gt;
+		expectedException.expect(ClassNotFoundException.class);&lt;br/&gt;
+		expectedException.expect(&lt;br/&gt;
+			allOf(&lt;br/&gt;
+				isA(ClassNotFoundException.class),&lt;br/&gt;
+				hasProperty(&quot;suppressed&quot;,&lt;br/&gt;
+					hasItemInArray(&lt;br/&gt;
+						allOf(&lt;br/&gt;
+							isA(ClassNotFoundException.class),&lt;br/&gt;
+							hasProperty(&quot;message&quot;,&lt;br/&gt;
+								containsString(&quot;Could not deserialize 1th parameter type of method test(int, ...).&quot;)))))));&lt;br/&gt;
+&lt;br/&gt;
+		RemoteRpcInvocation deserializedMethod = serializedMethod.deserializeValue(systemClassLoader);&lt;br/&gt;
+		deserializedMethod.getMethodName();&lt;br/&gt;
+&lt;br/&gt;
+		userClassLoader.close();&lt;br/&gt;
+	}&lt;br/&gt;
+&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testParentFirstClassLoading() throws Exception {&lt;br/&gt;
 		final ClassLoader parentClassLoader = getClass().getClassLoader();&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
index b231b041ead..5fce5deac6e 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
@@ -27,6 +27,7 @@&lt;br/&gt;
 import org.apache.flink.configuration.Configuration;&lt;br/&gt;
 import org.apache.flink.configuration.JobManagerOptions;&lt;br/&gt;
 import org.apache.flink.core.testutils.OneShotLatch;&lt;br/&gt;
+import org.apache.flink.runtime.akka.AkkaUtils;&lt;br/&gt;
 import org.apache.flink.runtime.blob.BlobServer;&lt;br/&gt;
 import org.apache.flink.runtime.blob.VoidBlobStore;&lt;br/&gt;
 import org.apache.flink.runtime.checkpoint.CheckpointProperties;&lt;br/&gt;
@@ -64,26 +65,33 @@&lt;br/&gt;
 import org.apache.flink.runtime.jobmaster.slotpool.DefaultSlotPoolFactory;&lt;br/&gt;
 import org.apache.flink.runtime.leaderretrieval.SettableLeaderRetrievalService;&lt;br/&gt;
 import org.apache.flink.runtime.messages.Acknowledge;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.registration.RegistrationResponse;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.ResourceManagerId;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.SlotRequest;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.utils.TestingResourceManagerGateway;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.RpcService;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcUtils;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.TestingRpcService;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.akka.AkkaRpcService;&lt;br/&gt;
 import org.apache.flink.runtime.state.CompletedCheckpointStorageLocation;&lt;br/&gt;
 import org.apache.flink.runtime.state.StreamStateHandle;&lt;br/&gt;
 import org.apache.flink.runtime.taskexecutor.TestingTaskExecutorGateway;&lt;br/&gt;
 import org.apache.flink.runtime.taskexecutor.TestingTaskExecutorGatewayBuilder;&lt;br/&gt;
+import org.apache.flink.runtime.taskexecutor.rpc.RpcCheckpointResponder;&lt;br/&gt;
 import org.apache.flink.runtime.taskexecutor.slot.SlotOffer;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.LocalTaskManagerLocation;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.TaskExecutionState;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.TaskManagerLocation;&lt;br/&gt;
 import org.apache.flink.runtime.testtasks.NoOpInvokable;&lt;br/&gt;
 import org.apache.flink.runtime.util.TestingFatalErrorHandler;&lt;br/&gt;
+import org.apache.flink.testutils.ClassLoaderUtils;&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
 import org.apache.flink.util.FlinkException;&lt;br/&gt;
+import org.apache.flink.util.SerializedThrowable;&lt;br/&gt;
 import org.apache.flink.util.TestLogger;&lt;/p&gt;

&lt;p&gt;+import akka.actor.ActorSystem;&lt;br/&gt;
 import org.hamcrest.Matchers;&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
 import org.junit.AfterClass;&lt;br/&gt;
@@ -99,6 +107,7 @@&lt;br/&gt;
 import java.io.File;&lt;br/&gt;
 import java.io.FileOutputStream;&lt;br/&gt;
 import java.io.IOException;&lt;br/&gt;
+import java.net.URLClassLoader;&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
 import java.util.concurrent.ArrayBlockingQueue;&lt;br/&gt;
@@ -206,6 +215,73 @@ public static void teardownClass() {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testDeclineCheckpointInvocationWithUserException() throws Exception {&lt;br/&gt;
+		RpcService rpcService1 = null;&lt;br/&gt;
+		RpcService rpcService2 = null;&lt;br/&gt;
+		try {&lt;br/&gt;
+			final ActorSystem actorSystem1 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+			final ActorSystem actorSystem2 = AkkaUtils.createDefaultActorSystem();&lt;br/&gt;
+&lt;br/&gt;
+			rpcService1 = new AkkaRpcService(actorSystem1, testingTimeout);&lt;br/&gt;
+			rpcService2 = new AkkaRpcService(actorSystem2, testingTimeout);&lt;br/&gt;
+&lt;br/&gt;
+			final CompletableFuture&amp;lt;Throwable&amp;gt; declineCheckpointMessageFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+			final JobManagerSharedServices jobManagerSharedServices = new TestingJobManagerSharedServicesBuilder().build();&lt;br/&gt;
+			final JobMasterConfiguration jobMasterConfiguration = JobMasterConfiguration.fromConfiguration(configuration);&lt;br/&gt;
+			final JobMaster jobMaster = new JobMaster(&lt;br/&gt;
+				rpcService1,&lt;br/&gt;
+				jobMasterConfiguration,&lt;br/&gt;
+				jmResourceId,&lt;br/&gt;
+				jobGraph,&lt;br/&gt;
+				haServices,&lt;br/&gt;
+				DefaultSlotPoolFactory.fromConfiguration(configuration, rpcService1),&lt;br/&gt;
+				jobManagerSharedServices,&lt;br/&gt;
+				heartbeatServices,&lt;br/&gt;
+				blobServer,&lt;br/&gt;
+				UnregisteredJobManagerJobMetricGroupFactory.INSTANCE,&lt;br/&gt;
+				new NoOpOnCompletionActions(),&lt;br/&gt;
+				testingFatalErrorHandler,&lt;br/&gt;
+				JobMasterTest.class.getClassLoader()) {&lt;br/&gt;
+				@Override&lt;br/&gt;
+				public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) &lt;/p&gt;
{
+					declineCheckpointMessageFuture.complete(declineCheckpoint.getReason());
+				}
&lt;p&gt;+			};&lt;br/&gt;
+&lt;br/&gt;
+			jobMaster.start(jobMasterId, testingTimeout).get();&lt;br/&gt;
+&lt;br/&gt;
+			final String className = &quot;UserException&quot;;&lt;br/&gt;
+			final URLClassLoader userClassLoader = ClassLoaderUtils.compileAndLoadJava(&lt;br/&gt;
+				temporaryFolder.newFolder(),&lt;br/&gt;
+				className + &quot;.java&quot;,&lt;br/&gt;
+				String.format(&quot;public class %s extends RuntimeException { public %s() &lt;/p&gt;
{super(\&quot;UserMessage\&quot;);}
&lt;p&gt; }&quot;,&lt;br/&gt;
+					className,&lt;br/&gt;
+					className));&lt;br/&gt;
+&lt;br/&gt;
+			Throwable userException = (Throwable) Class.forName(className, false, userClassLoader).newInstance();&lt;br/&gt;
+&lt;br/&gt;
+			JobMasterGateway jobMasterGateway =&lt;br/&gt;
+				rpcService2.connect(jobMaster.getAddress(), jobMaster.getFencingToken(), JobMasterGateway.class).get();&lt;br/&gt;
+&lt;br/&gt;
+			RpcCheckpointResponder rpcCheckpointResponder = new RpcCheckpointResponder(jobMasterGateway);&lt;br/&gt;
+			rpcCheckpointResponder.declineCheckpoint(&lt;br/&gt;
+				jobGraph.getJobID(),&lt;br/&gt;
+				new ExecutionAttemptID(1, 1),&lt;br/&gt;
+				1,&lt;br/&gt;
+				userException&lt;br/&gt;
+			);&lt;br/&gt;
+&lt;br/&gt;
+			Throwable throwable = declineCheckpointMessageFuture.get(testingTimeout.toMilliseconds(),&lt;br/&gt;
+				TimeUnit.MILLISECONDS);&lt;br/&gt;
+			assertThat(throwable, instanceOf(SerializedThrowable.class));&lt;br/&gt;
+			assertThat(throwable.getMessage(), equalTo(userException.getMessage()));&lt;br/&gt;
+		} finally &lt;/p&gt;
{
+			RpcUtils.terminateRpcServices(testingTimeout, rpcService1, rpcService2);
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testHeartbeatTimeoutWithTaskManager() throws Exception &lt;/p&gt;
{
 		final CompletableFuture&amp;lt;ResourceID&amp;gt; heartbeatResourceIdFuture = new CompletableFuture&amp;lt;&amp;gt;();
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
index c9c55a1da8f..f5f7f8e3415 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGateway.java
@@ -41,6 +41,7 @@
 import org.apache.flink.runtime.jobmaster.SerializedInputSplit;
 import org.apache.flink.runtime.jobmaster.message.ClassloadingProps;
 import org.apache.flink.runtime.messages.Acknowledge;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;
 import org.apache.flink.runtime.messages.webmonitor.JobDetails;
 import org.apache.flink.runtime.query.KvStateLocation;
 import org.apache.flink.runtime.registration.RegistrationResponse;
@@ -144,7 +145,7 @@
 	private final Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer;
 
 	@Nonnull
-	private final Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer;
+	private final Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer;
 
 	@Nonnull
 	private final Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier;
@@ -183,7 +184,7 @@ public TestingJobMasterGateway(
 			@Nonnull Function&amp;lt;JobVertexID, CompletableFuture&amp;lt;OperatorBackPressureStatsResponse&amp;gt;&amp;gt; requestOperatorBackPressureStatsFunction,
 			@Nonnull BiConsumer&amp;lt;AllocationID, Throwable&amp;gt; notifyAllocationFailureConsumer,
 			@Nonnull Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer,
-			@Nonnull Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer,
+			@Nonnull Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer,
 			@Nonnull Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier,
 			@Nonnull BiFunction&amp;lt;JobID, String, CompletableFuture&amp;lt;KvStateLocation&amp;gt;&amp;gt; requestKvStateLocationFunction,
 			@Nonnull Function&amp;lt;Tuple6&amp;lt;JobID, JobVertexID, KeyGroupRange, String, KvStateID, InetSocketAddress&amp;gt;, CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; notifyKvStateRegisteredFunction,
@@ -335,8 +336,8 @@ public void acknowledgeCheckpoint(JobID jobID, ExecutionAttemptID executionAttem
 	}

&lt;p&gt; 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void declineCheckpoint(JobID jobID, ExecutionAttemptID executionAttemptID, long checkpointId, Throwable cause) {&lt;/li&gt;
	&lt;li&gt;declineCheckpointConsumer.accept(Tuple4.of(jobID, executionAttemptID, checkpointId, cause));&lt;br/&gt;
+	public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) 
{
+		declineCheckpointConsumer.accept(declineCheckpoint);
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Override&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
index e40b752f248..b52df9ee052 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/utils/TestingJobMasterGatewayBuilder.java&lt;br/&gt;
@@ -40,6 +40,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.jobmaster.SerializedInputSplit;&lt;br/&gt;
 import org.apache.flink.runtime.jobmaster.message.ClassloadingProps;&lt;br/&gt;
 import org.apache.flink.runtime.messages.Acknowledge;&lt;br/&gt;
+import org.apache.flink.runtime.messages.checkpoint.DeclineCheckpoint;&lt;br/&gt;
 import org.apache.flink.runtime.messages.webmonitor.JobDetails;&lt;br/&gt;
 import org.apache.flink.runtime.query.KvStateLocation;&lt;br/&gt;
 import org.apache.flink.runtime.query.UnknownKvStateLocation;&lt;br/&gt;
@@ -96,7 +97,7 @@&lt;br/&gt;
 	private Function&amp;lt;JobVertexID, CompletableFuture&amp;lt;OperatorBackPressureStatsResponse&amp;gt;&amp;gt; requestOperatorBackPressureStatsFunction = ignored -&amp;gt; CompletableFuture.completedFuture(OperatorBackPressureStatsResponse.of(null));&lt;br/&gt;
 	private BiConsumer&amp;lt;AllocationID, Throwable&amp;gt; notifyAllocationFailureConsumer = (ignoredA, ignoredB) -&amp;gt; {};&lt;br/&gt;
 	private Consumer&amp;lt;Tuple5&amp;lt;JobID, ExecutionAttemptID, Long, CheckpointMetrics, TaskStateSnapshot&amp;gt;&amp;gt; acknowledgeCheckpointConsumer = ignored -&amp;gt; {};&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer = ignored -&amp;gt; {};&lt;br/&gt;
+	private Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer = ignored -&amp;gt; {};&lt;br/&gt;
 	private Supplier&amp;lt;JobMasterId&amp;gt; fencingTokenSupplier = () -&amp;gt; JOB_MASTER_ID;&lt;br/&gt;
 	private BiFunction&amp;lt;JobID, String, CompletableFuture&amp;lt;KvStateLocation&amp;gt;&amp;gt; requestKvStateLocationFunction = (ignoredA, registrationName) -&amp;gt; FutureUtils.completedExceptionally(new UnknownKvStateLocation(registrationName));&lt;br/&gt;
 	private Function&amp;lt;Tuple6&amp;lt;JobID, JobVertexID, KeyGroupRange, String, KvStateID, InetSocketAddress&amp;gt;, CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; notifyKvStateRegisteredFunction = ignored -&amp;gt; CompletableFuture.completedFuture(Acknowledge.get());&lt;br/&gt;
@@ -222,7 +223,7 @@ public TestingJobMasterGatewayBuilder setAcknowledgeCheckpointConsumer(Consumer&amp;lt;&lt;br/&gt;
 		return this;&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public TestingJobMasterGatewayBuilder setDeclineCheckpointConsumer(Consumer&amp;lt;Tuple4&amp;lt;JobID, ExecutionAttemptID, Long, Throwable&amp;gt;&amp;gt; declineCheckpointConsumer) {&lt;br/&gt;
+	public TestingJobMasterGatewayBuilder setDeclineCheckpointConsumer(Consumer&amp;lt;DeclineCheckpoint&amp;gt; declineCheckpointConsumer) 
{
 		this.declineCheckpointConsumer = declineCheckpointConsumer;
 		return this;
 	}&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16687638" author="githubbot" created="Thu, 15 Nov 2018 08:26:25 +0000"  >&lt;p&gt;dawidwys closed pull request #7096: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10419&quot; title=&quot;ClassNotFoundException while deserializing user exceptions from checkpointing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10419&quot;&gt;&lt;del&gt;FLINK-10419&lt;/del&gt;&lt;/a&gt; Call JobMasterGateway through RpcCheckpointResponder in&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7096&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7096&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
index b1f02845c14..de3f7875098 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java&lt;br/&gt;
@@ -103,6 +103,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.state.memory.ByteStreamStateHandle;&lt;br/&gt;
 import org.apache.flink.runtime.taskexecutor.TestingTaskExecutorGateway;&lt;br/&gt;
 import org.apache.flink.runtime.taskexecutor.TestingTaskExecutorGatewayBuilder;&lt;br/&gt;
+import org.apache.flink.runtime.taskexecutor.rpc.RpcCheckpointResponder;&lt;br/&gt;
 import org.apache.flink.runtime.taskexecutor.slot.SlotOffer;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.LocalTaskManagerLocation;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.TaskExecutionState;&lt;br/&gt;
@@ -303,18 +304,16 @@ public void declineCheckpoint(DeclineCheckpoint declineCheckpoint) {&lt;/p&gt;

&lt;p&gt; 			Throwable userException = (Throwable) Class.forName(className, false, userClassLoader).newInstance();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CompletableFuture&amp;lt;JobMasterGateway&amp;gt; jobMasterGateway =&lt;/li&gt;
	&lt;li&gt;rpcService2.connect(jobMaster.getAddress(), jobMaster.getFencingToken(), JobMasterGateway.class);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;jobMasterGateway.thenAccept(gateway -&amp;gt; 
{
-				gateway.declineCheckpoint(new DeclineCheckpoint(
-						jobGraph.getJobID(),
-						new ExecutionAttemptID(1, 1),
-						1,
-						userException
-					)
-				);
-			}
&lt;p&gt;);&lt;br/&gt;
+			JobMasterGateway jobMasterGateway =&lt;br/&gt;
+				rpcService2.connect(jobMaster.getAddress(), jobMaster.getFencingToken(), JobMasterGateway.class).get();&lt;br/&gt;
+&lt;br/&gt;
+			RpcCheckpointResponder rpcCheckpointResponder = new RpcCheckpointResponder(jobMasterGateway);&lt;br/&gt;
+			rpcCheckpointResponder.declineCheckpoint(&lt;br/&gt;
+				jobGraph.getJobID(),&lt;br/&gt;
+				new ExecutionAttemptID(1, 1),&lt;br/&gt;
+				1,&lt;br/&gt;
+				userException&lt;br/&gt;
+			);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			Throwable throwable = declineCheckpointMessageFuture.get(testingTimeout.toMilliseconds(),&lt;br/&gt;
 				TimeUnit.MILLISECONDS);&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16687661" author="dawidwys" created="Thu, 15 Nov 2018 08:52:45 +0000"  >&lt;p&gt;Fixed in master via: 8ba4a36ed0c0febf2e9a8e8bc4b176188632e50d&lt;br/&gt;
Fixed in 1.7 via: 480d5e364ac905e36b8aa652c249d0d4c10eb219&lt;br/&gt;
Fixed in 1.6 via: f4dd6410c3383d3de20fb2e9991609b22d02acc6&lt;br/&gt;
Fixed in 1.5 via: a4e135ba9014558abb4232068aac36fb734c57ec&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ygmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>