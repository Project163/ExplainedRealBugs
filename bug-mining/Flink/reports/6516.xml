<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:11:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-28274] ContinuousFileMonitoringFunction doesn&apos;t work with reactive mode</title>
                <link>https://issues.apache.org/jira/browse/FLINK-28274</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;This issue was first reported in the Flink Slack: &lt;a href=&quot;https://apache-flink.slack.com/archives/C03G7LJTS2G/p1656257678477659&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://apache-flink.slack.com/archives/C03G7LJTS2G/p1656257678477659&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It seems that reactive mode is changing the parallelism of the `ContinuousFileMonitoringFunction`, which is supposed to always run with a parallelism of 1.&lt;/p&gt;

&lt;p&gt;This is the error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INITIALIZING to FAILED with failure cause: java.lang.IllegalArgumentException: ContinuousFileMonitoringFunction retrieved invalid state.
	at org.apache.flink.util.Preconditions.checkArgument(Preconditions.java:138)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can see from the logs that the parallelism is changing on a rescale event:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-06-27 13:38:54,979 | INFO  | .executiongraph.ExecutionGraph  | Source: Custom File Source (1/1) (cbaad20beee908b95c9fe5c34ba76bfa) switched from RUNNING to CANCELING.
2022-06-27 13:38:55,254 | INFO  | .executiongraph.ExecutionGraph  | Source: Custom File Source (1/1) (cbaad20beee908b95c9fe5c34ba76bfa) switched from CANCELING to CANCELED.
2022-06-27 13:38:55,657 | INFO  | .executiongraph.ExecutionGraph  | Source: Custom File Source (2/2) (6ceaacbe8d9aa507b0a56c850082da8c) switched from DEPLOYING to INITIALIZING.
2022-06-27 13:38:55,722 | INFO  | .executiongraph.ExecutionGraph  | Source: Custom File Source (2/2) (6ceaacbe8d9aa507b0a56c850082da8c) switched from INITIALIZING to RUNNING.
2022-06-27 13:44:54,058 | INFO  | .executiongraph.ExecutionGraph  | Source: Custom File Source (1/2) (665b12194741744d6bba4408a252fa45) switched from RUNNING to CANCELING.
2022-06-27 13:45:00,825 | INFO  | .executiongraph.ExecutionGraph  | Source: Custom File Source (1/2) (3cc408fd0eb9ddfa97b22f4dfc09d8dc) switched from DEPLOYING to INITIALIZING.
2022-06-27 13:45:00,826 | INFO  | .executiongraph.ExecutionGraph  | Source: Custom File Source (1/2) (3cc408fd0eb9ddfa97b22f4dfc09d8dc) switched from INITIALIZING to RUNNING.
2022-06-27 13:45:01,434 | INFO  | .executiongraph.ExecutionGraph  | Source: Custom File Source (2/2) (79338042d84b6458c34760bc85145512) switched from DEPLOYING to INITIALIZING.
2022-06-27 13:45:02,427 | INFO  | .executiongraph.ExecutionGraph  | Source: Custom File Source (2/2) (79338042d84b6458c34760bc85145512) switched from INITIALIZING to RUNNING.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13468793">FLINK-28274</key>
            <summary>ContinuousFileMonitoringFunction doesn&apos;t work with reactive mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Leo Zhou">zhouli</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 28 Jun 2022 06:34:08 +0000</created>
                <updated>Wed, 6 Jul 2022 06:12:33 +0000</updated>
                            <resolved>Wed, 6 Jul 2022 06:12:33 +0000</resolved>
                                    <version>1.16.0</version>
                                    <fixVersion>1.16.0</fixVersion>
                                    <component>API / DataStream</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17559556" author="rmetzger" created="Tue, 28 Jun 2022 06:40:06 +0000"  >&lt;p&gt;I currently don&apos;t have the capacity to look into fixing this, but if somebody is interested, this is what I would do:&lt;br/&gt;
1. Add a new test using the file monitoring source to the ReactiveModeITCase and verify that the test really fails. Maybe this is not the best way to test the fix, but its a starting point for locally reproducing the issue.&lt;br/&gt;
2. I guess that the &#8220;computeVertexParallelismStoreForExecution&#8221; method is where you&#8217;ll find the logic where reactive mode sets the parallelism&lt;br/&gt;
3. The fix is either ensuring that maxParallelism for the monitoring function is set correctly, or somehow telling the adaptive scheduler to not change the parallelism of that function (in a generic way)&lt;/p&gt;</comment>
                            <comment id="17561034" author="leo zhou" created="Thu, 30 Jun 2022 13:06:21 +0000"  >&lt;p&gt;---The fix is either ensuring that maxParallelism for the monitoring function is set correctly, or somehow telling the adaptive scheduler to not change the parallelism of that function (in a generic way)&lt;/p&gt;

&lt;p&gt;I prefer to set the max parallelism for the monitoring function correctly. Since ContinuousFileMonitoringFunction is a legacy source function, we&apos;d better not change the adaptive scheduler for&#160; this issue.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/adaptive/AdaptiveScheduler.java#L344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AdaptiveScheduler.java#L344&lt;/a&gt; will calculate the maxParallelism for vertex only if no max parallelism was configured, so if we can ensure that maxParallelism for the monitoring function is 1, then reactive mode would not change the parallelism of the `ContinuousFileMonitoringFunction`.&lt;/p&gt;

&lt;p&gt;Since `ContinuousFileMonitoringFunction` is only used in &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/StreamExecutionEnvironment.java#L1855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;StreamExecutionEnvironment.java#L1855&lt;/a&gt; , It&apos;s safe to explicitly set the max parallelism here.&lt;/p&gt;</comment>
                            <comment id="17561038" author="rmetzger" created="Thu, 30 Jun 2022 13:15:06 +0000"  >&lt;p&gt;Thanks for your research. I agree that we shouldn&apos;t include source-specific logic into the adaptive scheduler for this.&lt;/p&gt;

&lt;p&gt;I like the idea of setting maxParallelism in the SEE (I currently can not imagine any issues with that, but we&apos;ll see if all the tests are passing properly once you&apos;ve done the change &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;</comment>
                            <comment id="17561061" author="leo zhou" created="Thu, 30 Jun 2022 13:59:48 +0000"  >&lt;p&gt;HI &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt; , could you assign this ticket to me before I open a PR ?&lt;/p&gt;</comment>
                            <comment id="17562195" author="martijnvisser" created="Mon, 4 Jul 2022 14:44:18 +0000"  >&lt;p&gt;Does this problem only occur for &lt;/p&gt;
{ContinuousFileMonitoringFunction}
&lt;p&gt; or also for the new &lt;/p&gt;
{FileSource}
&lt;p&gt;? &lt;/p&gt;</comment>
                            <comment id="17562311" author="wanglijie95" created="Tue, 5 Jul 2022 02:37:45 +0000"  >&lt;p&gt;I think it only occur for &lt;tt&gt;ContinuousFileMonitoringFunction (legacy file source)&lt;/tt&gt;. From what I understand, the &lt;tt&gt;ContinuousFileMonitoringFunction&lt;/tt&gt; plays the role of SplitEnumerator in legacy file source (parallelism must be 1). The new FileSource does not need it, so new FileSource shouldn&apos;t have this problem.&lt;/p&gt;</comment>
                            <comment id="17562313" author="wanglijie95" created="Tue, 5 Jul 2022 02:42:40 +0000"  >&lt;p&gt;I have one more question, does it also occur with other operators whose parallelism must be 1 (For example, &lt;tt&gt;GlobalAgg&lt;/tt&gt; in Table/SQL)?&lt;/p&gt;</comment>
                            <comment id="17562395" author="martijnvisser" created="Tue, 5 Jul 2022 06:52:48 +0000"  >&lt;p&gt;Honest question: why fix it if it&apos;s only occurring in a legacy component and there is a solution for it, using the target approach? Especially since &lt;/p&gt;
{ContinuousFileMonitoringFunction}
&lt;p&gt; is internal as well. &lt;/p&gt;</comment>
                            <comment id="17562419" author="leo zhou" created="Tue, 5 Jul 2022 07:35:03 +0000"  >&lt;p&gt;&amp;#8211; Does this problem only occur for {ContinuousFileMonitoringFunction} or also for the new {FileSource}&lt;/p&gt;

&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wanglijie95&quot; class=&quot;user-hover&quot; rel=&quot;wanglijie95&quot;&gt;wanglijie95&lt;/a&gt; said, with FLIP-27, FileSource does not need &lt;tt&gt;ContinuousFileMonitoringFunction&lt;/tt&gt;&#160; to plays the role of SplitEnumerator, so this problem won&apos;t occur for new FileSource.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;#8211; does it also occur with other operators whose parallelism must be 1 ?&lt;/p&gt;

&lt;p&gt;From what I understand, if the max parallelism is not set to 1, it&apos;s possible that this problem may occur for these operators whose parallelism must be 1.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;#8211; why fix it if it&apos;s only occurring in a legacy component ?&lt;/p&gt;

&lt;p&gt;The legacy source are still widely used, for example, When reading files with datastream api, the first thought is to use readFile/readTextFile() methods, especially for starters. Since the fix work won&apos;t take much effort, may be it&apos;s worthy.&lt;/p&gt;</comment>
                            <comment id="17562423" author="martijnvisser" created="Tue, 5 Jul 2022 07:41:10 +0000"  >&lt;p&gt;&amp;#8211; The legacy source are still widely used, for example, When reading files with datastream api, the first thought is to use readFile/readTextFile() methods, especially for starters. Since the fix work won&apos;t take much effort, may be it&apos;s worthy.&lt;/p&gt;

&lt;p&gt;I don&apos;t think that the usage is a good reason, because that&apos;s always the case when something new is introduced. Without an incentive for users to migrate, they will never do so. It probably makes sense to fix it in this case, but I still think that we are doing something wrong as a Flink community since people shouldn&apos;t use &lt;/p&gt;
{Internal}
&lt;p&gt; interfaces at all. &lt;/p&gt;</comment>
                            <comment id="17562433" author="leo zhou" created="Tue, 5 Jul 2022 07:48:43 +0000"  >&lt;p&gt;`Without an incentive for users to migrate, they will never do so. `&#160; cannot agree more &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17562982" author="rmetzger" created="Wed, 6 Jul 2022 06:10:48 +0000"  >&lt;p&gt;Merged to master in &lt;a href=&quot;https://github.com/apache/flink/commit/c71762686b1ef9c8fbc1cdb58bc0c9c2dbaa2da9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/c71762686b1ef9c8fbc1cdb58bc0c9c2dbaa2da9&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17562985" author="rmetzger" created="Wed, 6 Jul 2022 06:12:33 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Leo+Zhou&quot; class=&quot;user-hover&quot; rel=&quot;Leo Zhou&quot;&gt;Leo Zhou&lt;/a&gt; for the fix!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 18 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z16euw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>