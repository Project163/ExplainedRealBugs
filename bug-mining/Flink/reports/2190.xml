<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8492] Improve cost estimation for Calcs</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8492</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Considering the following test,&#160;unsupported exception will be thrown&#160;due to&#160;multi calc existing between correlate and TableFunctionScan.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;@Test
def testCrossJoinWithMultiFilter(): Unit = {
  val t = testData(env).toTable(tEnv).as(&lt;span class=&quot;code-quote&quot;&gt;&apos;a, &apos;&lt;/span&gt;b, &apos;c)
  val func0 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TableFunc0

  val result = t
    .join(func0(&lt;span class=&quot;code-quote&quot;&gt;&apos;c) as(&apos;&lt;/span&gt;d, &apos;e))
    .select(&lt;span class=&quot;code-quote&quot;&gt;&apos;c, &apos;&lt;/span&gt;d, &apos;e)
    .where(&apos;e &amp;gt; 10)
    .where(&apos;e &amp;gt; 20)
    .select(&lt;span class=&quot;code-quote&quot;&gt;&apos;c, &apos;&lt;/span&gt;d)
    .toAppendStream[Row]

  result.addSink(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamITCase.StringSink[Row])
  env.execute()

  val expected = mutable.MutableList(&lt;span class=&quot;code-quote&quot;&gt;&quot;Jack#22,Jack,22&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Anna#44,Anna,44&quot;&lt;/span&gt;)
  assertEquals(expected.sorted, StreamITCase.testResults.sorted)
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I can see two options to fix this problem:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Adapt calcite OptRule to merge the continuous calc.&lt;/li&gt;
	&lt;li&gt;Merge multi calc in correlate convert rule.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I prefer the second one, not only it is easy to implement but also i think with or without an optimize rule should not&#160;influence flink&#160;functionality.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13133034">FLINK-8492</key>
            <summary>Improve cost estimation for Calcs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hequn8128">Hequn Cheng</assignee>
                                    <reporter username="hequn8128">Hequn Cheng</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Jan 2018 12:50:03 +0000</created>
                <updated>Wed, 31 Jan 2018 13:15:47 +0000</updated>
                            <resolved>Wed, 31 Jan 2018 13:15:29 +0000</resolved>
                                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16335784" author="fhueske" created="Tue, 23 Jan 2018 13:43:25 +0000"  >&lt;p&gt;Isn&apos;t there already a rule that merges calcs and could be moved to a different optimization phase?&lt;br/&gt;
Wouldn&apos;t this be the preferred solution, since merging calcs should always be beneficial?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16335891" author="hequn8128" created="Tue, 23 Jan 2018 15:08:22 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt;, thanks for your reply.&#160;We can move calc rules (FilterToCalcRule,ProjectToCalcRule and CalcMergeRule) into normalize phrase, this will make the above test case pass, but the current&#160;logical&#160;optimize phase may&#160;re-introduce&#160;multi calcs due to project push down for other cases, and&#160;volcano&#160;seems to chose the un-merged plan as the smallest cost plan.&lt;/p&gt;</comment>
                            <comment id="16335963" author="fhueske" created="Tue, 23 Jan 2018 15:59:02 +0000"  >&lt;p&gt;If I see that right, the calc merging rules are applied in the same phase as the correlate convert rule, correct?&lt;br/&gt;
If that is the case, the rules should be applied and merge the calcs. Is this due to the cost model?&lt;/p&gt;</comment>
                            <comment id="16336105" author="fhueske" created="Tue, 23 Jan 2018 17:21:55 +0000"  >&lt;p&gt;OK, I think I found a simple fix. The problem is in fact a cost modeling issue.&lt;br/&gt;
We do not penalize having multiple calcs due to the cost function in &lt;tt&gt;CommonCalc.computeSelfCost()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If we add a constant &lt;tt&gt;1&lt;/tt&gt; to &lt;tt&gt;compCnt&lt;/tt&gt;, the calcs will be merged because this reduces the cost.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt;[flink] def computeSelfCost(
      calcProgram: RexProgram,
      planner: RelOptPlanner,
      rowCnt: &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;): RelOptCost = {

    &lt;span class=&quot;code-comment&quot;&gt;// compute number of expressions that &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not access a field or literal, i.e. computations,
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// conditions, etc. We only want to account &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; computations, not &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; simple projections.
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// CASTs in RexProgram are reduced as far as possible by ReduceExpressionsRule
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// in normalization stage. So we should ignore CASTs here in optimization stage.
&lt;/span&gt;    val compCnt = calcProgram.getExprList.asScala.toList.count {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _: RexInputRef =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _: RexLiteral =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; c: RexCall &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; c.getOperator.getName.equals(&lt;span class=&quot;code-quote&quot;&gt;&quot;CAST&quot;&lt;/span&gt;) =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
    } + 1   &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;------ THIS IS THE FIX
&lt;/span&gt;
    val newRowCnt = estimateRowCount(calcProgram, rowCnt)
    planner.getCostFactory.makeCost(newRowCnt, newRowCnt * compCnt, 0)
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16336778" author="hequn8128" created="Wed, 24 Jan 2018 02:23:54 +0000"  >&lt;p&gt;Cool, It&apos;s an excellent solution! I will submit a pr soon. Thanks for your help.&#160;&lt;/p&gt;</comment>
                            <comment id="16336937" author="githubbot" created="Wed, 24 Jan 2018 05:27:47 +0000"  >&lt;p&gt;GitHub user hequn8128 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8492&quot; title=&quot;Improve cost estimation for Calcs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8492&quot;&gt;&lt;del&gt;FLINK-8492&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix calc cost bug&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Fix calc cost bug. Currently, unsupported exception will be thrown when multi calc existing between correlate and TableFunctionScan.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add a constant 1 to compCnt in `CommonCalc`&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change added tests and can be verified as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added integration tests for udtf with multi cals&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hequn8128/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hequn8128/flink&lt;/a&gt; 8492&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5347&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit bf1b4d4773c3690dfe73a0e71b22730d8b5eb99c&lt;br/&gt;
Author: hequn8128 &amp;lt;chenghequn@...&amp;gt;&lt;br/&gt;
Date:   2018-01-24T04:25:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8492&quot; title=&quot;Improve cost estimation for Calcs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8492&quot;&gt;&lt;del&gt;FLINK-8492&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix calc cost bug&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16337112" author="githubbot" created="Wed, 24 Jan 2018 08:17:06 +0000"  >&lt;p&gt;Github user twalthr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you @hequn8128. I will merge this...&lt;/p&gt;</comment>
                            <comment id="16337282" author="githubbot" created="Wed, 24 Jan 2018 09:44:59 +0000"  >&lt;p&gt;Github user hequn8128 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @twalthr thanks for your review. I will take a look and update the pr.&lt;/p&gt;</comment>
                            <comment id="16337710" author="githubbot" created="Wed, 24 Jan 2018 15:02:26 +0000"  >&lt;p&gt;Github user hequn8128 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi, @fhueske @twalthr ,&lt;/p&gt;

&lt;p&gt;    To solve the problem, we need to make the `estimateRowCount` in `CommonCalc` more accurate. I will update the pr tomorrow. Anyway, cost model can&apos;t solve the problem deterministically. The cost is just an estimate, so multi-cals will exist under some circumstances. &lt;/p&gt;

&lt;p&gt;    As for correlate, to make sure unsupported exception won&apos;t be thrown, i will double check whether multi calcs are exist, and merge the calcs if need to. &lt;/p&gt;

&lt;p&gt;    What do you think ? Thanks, Hequn.&lt;/p&gt;</comment>
                            <comment id="16339126" author="githubbot" created="Thu, 25 Jan 2018 11:59:47 +0000"  >&lt;p&gt;Github user hequn8128 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    hi @fhueske @twalthr , the pr has been updated. It would be great if you can take a look at it.&lt;/p&gt;

&lt;p&gt;    Changes mainly include: &lt;br/&gt;
    1. Adapt estimateRowCount to be more accurate. The original implementation use a constant 0.75 to reduce the result which makes row count of merged calc bigger than the row count of un-merged calcs. Current implementation use a more accurate selectivity to reduce the result row count.&lt;br/&gt;
    2. Merge calcs in convert rule of correrate. Double check to make sure unsupported exception won&apos;t be thrown&lt;/p&gt;</comment>
                            <comment id="16339416" author="githubbot" created="Thu, 25 Jan 2018 15:57:22 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347#discussion_r163877879&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347#discussion_r163877879&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/CommonCalc.scala &amp;#8212;&lt;br/&gt;
    @@ -149,26 +152,42 @@ trait CommonCalc {&lt;br/&gt;
         // conditions, etc. We only want to account for computations, not for simple projections.&lt;br/&gt;
         // CASTs in RexProgram are reduced as far as possible by ReduceExpressionsRule&lt;br/&gt;
         // in normalization stage. So we should ignore CASTs here in optimization stage.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val compCnt = calcProgram.getExprList.asScala.toList.count 
{
    -      case _: RexInputRef =&amp;gt; false
    -      case _: RexLiteral =&amp;gt; false
    -      case c: RexCall if c.getOperator.getName.equals(&quot;CAST&quot;) =&amp;gt; false
    -      case _ =&amp;gt; true
    -    }
&lt;p&gt;    +    // Also, we add 1 to take calc RelNode number into consideration, so the cost of merged calc&lt;br/&gt;
    +    // RelNode will less than the total cost of un-merged calcs.&lt;br/&gt;
    +    val compCnt = calcProgram.getExprList.asScala.toList.count(isCom(_)) + 1&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val newRowCnt = estimateRowCount(calcProgram, rowCnt)&lt;br/&gt;
    +    val newRowCnt = estimateRowCount(rexBuilder, calcProgram, rowCnt)&lt;br/&gt;
         planner.getCostFactory.makeCost(newRowCnt, newRowCnt * compCnt, 0)&lt;br/&gt;
       }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;       private&lt;span class=&quot;error&quot;&gt;&amp;#91;flink&amp;#93;&lt;/span&gt; def estimateRowCount(&lt;br/&gt;
    +      rexBuilder: RexBuilder,&lt;br/&gt;
           calcProgram: RexProgram,&lt;br/&gt;
           rowCnt: Double): Double = {&lt;/p&gt;

&lt;p&gt;         if (calcProgram.getCondition != null) {&lt;br/&gt;
           // we reduce the result card to push filters down&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;(rowCnt * 0.75).max(1.0)&lt;br/&gt;
    +      val exprs = RexUtil.composeConjunction(
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    use `calcProgram.expandLocalRef(calcProgram.getCondition())` to only include the expressions that are relevant for the condition.&lt;/p&gt;</comment>
                            <comment id="16339417" author="githubbot" created="Thu, 25 Jan 2018 15:57:22 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347#discussion_r163878119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347#discussion_r163878119&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/CommonCalc.scala &amp;#8212;&lt;br/&gt;
    @@ -149,26 +152,42 @@ trait CommonCalc {&lt;br/&gt;
         // conditions, etc. We only want to account for computations, not for simple projections.&lt;br/&gt;
         // CASTs in RexProgram are reduced as far as possible by ReduceExpressionsRule&lt;br/&gt;
         // in normalization stage. So we should ignore CASTs here in optimization stage.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val compCnt = calcProgram.getExprList.asScala.toList.count 
{
    -      case _: RexInputRef =&amp;gt; false
    -      case _: RexLiteral =&amp;gt; false
    -      case c: RexCall if c.getOperator.getName.equals(&quot;CAST&quot;) =&amp;gt; false
    -      case _ =&amp;gt; true
    -    }
&lt;p&gt;    +    // Also, we add 1 to take calc RelNode number into consideration, so the cost of merged calc&lt;br/&gt;
    +    // RelNode will less than the total cost of un-merged calcs.&lt;br/&gt;
    +    val compCnt = calcProgram.getExprList.asScala.toList.count(isCom(_)) + 1&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val newRowCnt = estimateRowCount(calcProgram, rowCnt)&lt;br/&gt;
    +    val newRowCnt = estimateRowCount(rexBuilder, calcProgram, rowCnt)&lt;br/&gt;
         planner.getCostFactory.makeCost(newRowCnt, newRowCnt * compCnt, 0)&lt;br/&gt;
       }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;       private&lt;span class=&quot;error&quot;&gt;&amp;#91;flink&amp;#93;&lt;/span&gt; def estimateRowCount(&lt;br/&gt;
    +      rexBuilder: RexBuilder,&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    we don&apos;t need the `RexBuilder` if we get the condition `RexNode` from the `RexProgram`.&lt;/p&gt;</comment>
                            <comment id="16339418" author="githubbot" created="Thu, 25 Jan 2018 15:57:22 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347#discussion_r163879206&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347#discussion_r163879206&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/CommonCalc.scala &amp;#8212;&lt;br/&gt;
    @@ -141,6 +143,7 @@ trait CommonCalc {&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       private&lt;span class=&quot;error&quot;&gt;&amp;#91;flink&amp;#93;&lt;/span&gt; def computeSelfCost(&lt;br/&gt;
    +      rexBuilder: RexBuilder,&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    We don&apos;t need the `RexBuilder`&lt;/p&gt;</comment>
                            <comment id="16339419" author="githubbot" created="Thu, 25 Jan 2018 15:57:22 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347#discussion_r163880994&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347#discussion_r163880994&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/common/CorrelateUtil.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,79 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.plan.rules.common&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.calcite.plan.volcano.RelSubset&lt;br/&gt;
    +import org.apache.calcite.rel.RelNode&lt;br/&gt;
    +import org.apache.calcite.rex.&lt;/p&gt;
{RexProgram, RexProgramBuilder}
&lt;p&gt;    +import org.apache.flink.table.api.TableException&lt;br/&gt;
    +import org.apache.flink.table.plan.nodes.logical.&lt;/p&gt;
{FlinkLogicalCalc, FlinkLogicalTableFunctionScan}
&lt;p&gt;    +&lt;br/&gt;
    +/**&lt;br/&gt;
    +  * An utility for datasteam and dataset correlate rules.&lt;br/&gt;
    +  */&lt;br/&gt;
    +object CorrelateUtil {&lt;br/&gt;
    +&lt;br/&gt;
    +  /**&lt;br/&gt;
    +    * Find only calc and table function&lt;br/&gt;
    +    */&lt;br/&gt;
    +  def findCalcAndTableFunction(calc: FlinkLogicalCalc): Boolean = {&lt;br/&gt;
    +    val child = calc.getInput.asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;RelSubset&amp;#93;&lt;/span&gt;.getOriginal&lt;br/&gt;
    +    child match &lt;/p&gt;
{
    +      case scan: FlinkLogicalTableFunctionScan =&amp;gt; true
    +      case calc: FlinkLogicalCalc =&amp;gt; findCalcAndTableFunction(calc)
    +      case _ =&amp;gt; false
    +    }
&lt;p&gt;    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  /**&lt;br/&gt;
    +    * Get [&lt;span class=&quot;error&quot;&gt;&amp;#91;FlinkLogicalTableFunctionScan&amp;#93;&lt;/span&gt;] from the input calc.&lt;br/&gt;
    +    */&lt;br/&gt;
    +  def getTableScan(calc: FlinkLogicalCalc): RelNode = {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    rename to `getTableFunctionScan`&lt;/p&gt;</comment>
                            <comment id="16339420" author="githubbot" created="Thu, 25 Jan 2018 15:57:23 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347#discussion_r163880920&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347#discussion_r163880920&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/common/CorrelateUtil.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,79 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.plan.rules.common&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.calcite.plan.volcano.RelSubset&lt;br/&gt;
    +import org.apache.calcite.rel.RelNode&lt;br/&gt;
    +import org.apache.calcite.rex.&lt;/p&gt;
{RexProgram, RexProgramBuilder}
&lt;p&gt;    +import org.apache.flink.table.api.TableException&lt;br/&gt;
    +import org.apache.flink.table.plan.nodes.logical.&lt;/p&gt;
{FlinkLogicalCalc, FlinkLogicalTableFunctionScan}
&lt;p&gt;    +&lt;br/&gt;
    +/**&lt;br/&gt;
    +  * An utility for datasteam and dataset correlate rules.&lt;br/&gt;
    +  */&lt;br/&gt;
    +object CorrelateUtil {&lt;br/&gt;
    +&lt;br/&gt;
    +  /**&lt;br/&gt;
    +    * Find only calc and table function&lt;br/&gt;
    +    */&lt;br/&gt;
    +  def findCalcAndTableFunction(calc: FlinkLogicalCalc): Boolean = {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    remove (functionality replaced by `getTableScan`.&lt;/p&gt;</comment>
                            <comment id="16339421" author="githubbot" created="Thu, 25 Jan 2018 15:57:24 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347#discussion_r163880732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347#discussion_r163880732&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/common/CorrelateUtil.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,79 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.plan.rules.common&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.calcite.plan.volcano.RelSubset&lt;br/&gt;
    +import org.apache.calcite.rel.RelNode&lt;br/&gt;
    +import org.apache.calcite.rex.&lt;/p&gt;
{RexProgram, RexProgramBuilder}
&lt;p&gt;    +import org.apache.flink.table.api.TableException&lt;br/&gt;
    +import org.apache.flink.table.plan.nodes.logical.&lt;/p&gt;
{FlinkLogicalCalc, FlinkLogicalTableFunctionScan}
&lt;p&gt;    +&lt;br/&gt;
    +/**&lt;br/&gt;
    +  * An utility for datasteam and dataset correlate rules.&lt;br/&gt;
    +  */&lt;br/&gt;
    +object CorrelateUtil {&lt;br/&gt;
    +&lt;br/&gt;
    +  /**&lt;br/&gt;
    +    * Find only calc and table function&lt;br/&gt;
    +    */&lt;br/&gt;
    +  def findCalcAndTableFunction(calc: FlinkLogicalCalc): Boolean = {&lt;br/&gt;
    +    val child = calc.getInput.asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;RelSubset&amp;#93;&lt;/span&gt;.getOriginal&lt;br/&gt;
    +    child match &lt;/p&gt;
{
    +      case scan: FlinkLogicalTableFunctionScan =&amp;gt; true
    +      case calc: FlinkLogicalCalc =&amp;gt; findCalcAndTableFunction(calc)
    +      case _ =&amp;gt; false
    +    }
&lt;p&gt;    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  /**&lt;br/&gt;
    +    * Get [&lt;span class=&quot;error&quot;&gt;&amp;#91;FlinkLogicalTableFunctionScan&amp;#93;&lt;/span&gt;] from the input calc.&lt;br/&gt;
    +    */&lt;br/&gt;
    +  def getTableScan(calc: FlinkLogicalCalc): RelNode = {&lt;br/&gt;
    +    val child = calc.getInput.asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;RelSubset&amp;#93;&lt;/span&gt;.getOriginal&lt;br/&gt;
    +    child match {&lt;br/&gt;
    +      case scan: FlinkLogicalTableFunctionScan =&amp;gt; scan&lt;br/&gt;
    +      case calc: FlinkLogicalCalc =&amp;gt; getTableScan(calc)&lt;br/&gt;
    +      case _ =&amp;gt; throw TableException(&quot;This must be a bug, could not find table scan&quot;)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Combine this method with `findCalcAndTableFunction` and return an `Option&lt;span class=&quot;error&quot;&gt;&amp;#91;FlinkLogicalTableFunctionScan&amp;#93;&lt;/span&gt;`.&lt;br/&gt;
    If the function returns `None` there no table function at the end.&lt;/p&gt;</comment>
                            <comment id="16341007" author="githubbot" created="Fri, 26 Jan 2018 12:55:54 +0000"  >&lt;p&gt;Github user hequn8128 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    hi, @fhueske Thanks for your suggestions. The pr has been updated according to your comments.&lt;/p&gt;</comment>
                            <comment id="16341033" author="githubbot" created="Fri, 26 Jan 2018 13:16:28 +0000"  >&lt;p&gt;Github user fhueske commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the fix @hequn8128!&lt;br/&gt;
    PR is good to merge.&lt;/p&gt;</comment>
                            <comment id="16346761" author="githubbot" created="Wed, 31 Jan 2018 12:49:23 +0000"  >&lt;p&gt;Github user twalthr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @hequn8128 and @fhueske. I will merge this...&lt;/p&gt;</comment>
                            <comment id="16346789" author="twalthr" created="Wed, 31 Jan 2018 13:15:29 +0000"  >&lt;p&gt;Fixed in 1.5: 8cf2be7e2be72c3b4cc3af36e64bcf30b27ec5bb&lt;/p&gt;</comment>
                            <comment id="16346790" author="githubbot" created="Wed, 31 Jan 2018 13:15:47 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5347&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p8uf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>