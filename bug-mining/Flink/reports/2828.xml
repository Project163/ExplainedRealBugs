<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:38:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10761] MetricGroup#getAllVariables can deadlock</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10761</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;tt&gt;AbstractMetricGroup#getAllVariables&lt;/tt&gt; acquires the locks of both the current and all parent groups when assembling the variables map. This can lead to a deadlock if metrics are registered concurrently on a child and parent if the child registration is applied first and the reporter uses said method (which many do).&lt;/p&gt;

&lt;p&gt;Assume we have a MetricGroup Mc(hild) and Mp(arent).&lt;/p&gt;

&lt;p&gt;2 separate threads Tc and Tp each register a metric on their respective group, acquiring the lock.&lt;br/&gt;
Let&apos;s assume that Tc has a slight headstart.&lt;br/&gt;
Tc will now call &lt;tt&gt;MetricRegistry#register&lt;/tt&gt; first, acquiring the MR lock.&lt;br/&gt;
Tp will block on this lock.&lt;/p&gt;

&lt;p&gt;Tc now iterates over all reporters calling &lt;tt&gt;MetricReporter#notifyOfAddedMetric&lt;/tt&gt;. Assume that in this method &lt;tt&gt;MetricGroup#getAllVariables&lt;/tt&gt; is called on Mc by Tc.&lt;br/&gt;
Tc still holds the lock to Mc, and attempts to acquire the lock to Mp.&lt;br/&gt;
The lock to Mp is still held by Tp however, which waits for the MR lock to be released by Tc.&lt;/p&gt;

&lt;p&gt;Thus a deadlock is created. This may deadlock anything, be it minor threads, tasks, or entire components.&lt;/p&gt;

&lt;p&gt;This has not surfaced so far since usually metrics are no longer added to a group once children have been created (since the component initialization at that point is complete).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13195886">FLINK-10761</key>
            <summary>MetricGroup#getAllVariables can deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="chesnay">Chesnay Schepler</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 2 Nov 2018 12:23:30 +0000</created>
                <updated>Wed, 2 Oct 2019 17:49:04 +0000</updated>
                            <resolved>Thu, 3 Jan 2019 17:16:12 +0000</resolved>
                                    <version>1.5.5</version>
                    <version>1.6.2</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.6.4</fixVersion>
                    <fixVersion>1.7.2</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16673059" author="till.rohrmann" created="Fri, 2 Nov 2018 12:55:35 +0000"  >&lt;p&gt;Is this strictly a blocker given that it is in Flink for a couple of versions &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;. I think we should try to fix for 1.7, though.&lt;/p&gt;</comment>
                            <comment id="16673077" author="zentol" created="Fri, 2 Nov 2018 13:06:07 +0000"  >&lt;p&gt;Probably doesn&apos;t have to be a blocker considering we&apos;ve never observed it so far outside of dev branches.&lt;br/&gt;
It&apos;s fairly unlikely to happen; the only case i can imagine on master is a registration in a UDF from a separate thread while a latency histogram is being registered. This is quite specific, but would deadlock a single task.&lt;/p&gt;</comment>
                            <comment id="16673144" author="zentol" created="Fri, 2 Nov 2018 14:16:56 +0000"  >&lt;p&gt;This is a bit difficult to solve since multiple methods may violate the lock-order. It would be easier to fix if asynchronous registration of metrics is already in place, as in that case no thread could be blocked while registering a metric, and thus while holding a MetricGroup lock.&lt;/p&gt;

&lt;p&gt;Given that these issues aren&apos;t new and have never been observed I&apos;m unblocking the 1.7 release. We should look into these issues for 1.8 as part of a general concurrency-cleanup in the metric system.&lt;/p&gt;</comment>
                            <comment id="16733242" author="zentol" created="Thu, 3 Jan 2019 17:16:12 +0000"  >&lt;p&gt;master: aa92438c4aa6218c5d7e67083152733271697089&lt;br/&gt;
1.7: 45d53d27e4dec934057404674e38c6eab2e66e62&lt;br/&gt;
1.6: cb85e62b5b122b7cbb9eeb72a116dd133467a920&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s002bk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>