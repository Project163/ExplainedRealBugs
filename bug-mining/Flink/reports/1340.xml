<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5179] MetricRegistry life-cycle issues with HA</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5179</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The TaskManager&apos;s MetricRegistry is started when the TaskManager is created, and shutdown in the TaskManager&apos;s postStop method.&lt;/p&gt;

&lt;p&gt;However, the registry is also shutdown within the TaskManager&apos;s disassociateFromJobManager method; however it is not restarted when the connection is re-established.&lt;/p&gt;

&lt;p&gt;Effectively this means that a TaskManager that ever reconnected to a JobManager will not report any metrics, since the reporters are shutdown as well. Metrics will neither be sent to the WebInterface anymore.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13023751">FLINK-5179</key>
            <summary>MetricRegistry life-cycle issues with HA</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="chesnay">Chesnay Schepler</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Nov 2016 14:51:53 +0000</created>
                <updated>Tue, 6 Dec 2016 14:51:12 +0000</updated>
                            <resolved>Tue, 6 Dec 2016 14:50:15 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15702206" author="githubbot" created="Mon, 28 Nov 2016 15:19:21 +0000"  >&lt;p&gt;GitHub user zentol opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5179&quot; title=&quot;MetricRegistry life-cycle issues with HA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5179&quot;&gt;&lt;del&gt;FLINK-5179&lt;/del&gt;&lt;/a&gt; Correct TM MetricRegistry and TmMG lifecycle&lt;/p&gt;

&lt;p&gt;    This PR corrects the life-cycle of the MetricRegistry and TaskManagerMetricGroup of the TaskManager.&lt;/p&gt;

&lt;p&gt;    The MetricRegistry is no longer shutdown when the TaskManager disassociates from the JobManager; the registry, and by extension the reporters, will now live and be active as long as the TaskManager is running.&lt;/p&gt;

&lt;p&gt;    The TaskManagerMetricGroup is now properly closed when disassociating from the JobManager.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zentol/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/flink&lt;/a&gt; 5179_registry_lifecycle&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2886&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 32ee9b30f6cff3b17d30ad9b1920afb711c5263c&lt;br/&gt;
Author: zentol &amp;lt;chesnay@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-11-28T15:10:33Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5179&quot; title=&quot;MetricRegistry life-cycle issues with HA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5179&quot;&gt;&lt;del&gt;FLINK-5179&lt;/del&gt;&lt;/a&gt; Correct TM MetricRegistry and TmMG lifecycle&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15714804" author="githubbot" created="Fri, 2 Dec 2016 11:00:33 +0000"  >&lt;p&gt;Github user rmetzger commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I wonder if there is an easy way to add a test case for this?&lt;br/&gt;
    Maybe you could add a check to one of the HA tests?&lt;/p&gt;</comment>
                            <comment id="15714824" author="githubbot" created="Fri, 2 Dec 2016 11:07:52 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    That should be possible; I&apos;ll look into it.&lt;/p&gt;</comment>
                            <comment id="15715034" author="githubbot" created="Fri, 2 Dec 2016 12:42:45 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @rmetzger I&apos;ve added a test case.&lt;/p&gt;</comment>
                            <comment id="15715251" author="githubbot" created="Fri, 2 Dec 2016 14:21:25 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This has been marked as a blocker for 1.1.4. Is there a chance that we will get this in today?&lt;/p&gt;</comment>
                            <comment id="15715273" author="githubbot" created="Fri, 2 Dec 2016 14:31:42 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Someone has to review the test and then we&apos;re good to go IMO.&lt;/p&gt;</comment>
                            <comment id="15715275" author="githubbot" created="Fri, 2 Dec 2016 14:32:46 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Actually, i don&apos;t know whether @rmetzger did review the functional changes; but that&apos;s only a single line.&lt;/p&gt;</comment>
                            <comment id="15715290" author="githubbot" created="Fri, 2 Dec 2016 14:37:52 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886#discussion_r90651728&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886#discussion_r90651728&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/taskmanager/TaskManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1046,11 +1046,10 @@ class TaskManager(&lt;br/&gt;
           network.getKvStateRegistry.unregisterListener()&lt;br/&gt;
         }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// failsafe shutdown of the metrics registry&lt;br/&gt;
         try {&lt;/li&gt;
	&lt;li&gt;metricsRegistry.shutdown()&lt;br/&gt;
    +      taskManagerMetricGroup.close()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    When is this shut down then?&lt;/p&gt;</comment>
                            <comment id="15715302" author="githubbot" created="Fri, 2 Dec 2016 14:44:36 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886#discussion_r90652945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886#discussion_r90652945&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/taskmanager/TaskManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1046,11 +1046,10 @@ class TaskManager(&lt;br/&gt;
           network.getKvStateRegistry.unregisterListener()&lt;br/&gt;
         }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// failsafe shutdown of the metrics registry&lt;br/&gt;
         try {&lt;/li&gt;
	&lt;li&gt;metricsRegistry.shutdown()&lt;br/&gt;
    +      taskManagerMetricGroup.close()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    When the taskmanager is shutdown, in postStop().&lt;/p&gt;</comment>
                            <comment id="15715309" author="githubbot" created="Fri, 2 Dec 2016 14:46:45 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886#discussion_r90653350&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886#discussion_r90653350&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/taskmanager/TaskManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1046,11 +1046,10 @@ class TaskManager(&lt;br/&gt;
           network.getKvStateRegistry.unregisterListener()&lt;br/&gt;
         }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// failsafe shutdown of the metrics registry&lt;br/&gt;
         try {&lt;/li&gt;
	&lt;li&gt;metricsRegistry.shutdown()&lt;br/&gt;
    +      taskManagerMetricGroup.close()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    That was already the case before this PR.&lt;/p&gt;</comment>
                            <comment id="15715333" author="githubbot" created="Fri, 2 Dec 2016 14:55:54 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The changes and the test look good to me. While waiting for Travis, I will test this with an HA cluster. We can merge this if everything succeeds.&lt;/p&gt;</comment>
                            <comment id="15721904" author="githubbot" created="Mon, 5 Dec 2016 10:39:32 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I tested this, but could not reproduce the reported erroneous behaviour. After the task manager reconnects to a new job manager, the metrics are still being reported. I tested this with JMX and Log4j reporters. The changes look reasonable to me though. @rmetzger @zentol Should we merge this for 1.1.4?&lt;/p&gt;</comment>
                            <comment id="15722285" author="githubbot" created="Mon, 5 Dec 2016 13:37:16 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Can you open a PR with a backport of this for 1.1.4 please?&lt;/p&gt;</comment>
                            <comment id="15722377" author="githubbot" created="Mon, 5 Dec 2016 14:18:18 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Sorry, while back-porting i realized this issue does not affect 1.1.4. I&apos;ve adjusted the JIRA as such.&lt;/p&gt;</comment>
                            <comment id="15722426" author="githubbot" created="Mon, 5 Dec 2016 14:39:20 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    OK that also explains why it didn&apos;t occur for me with the current release-1.1 branch. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15725372" author="githubbot" created="Tue, 6 Dec 2016 12:42:33 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Tested this vs. the current master and it works as expected. In the current master, the metrics are not updated after the TM disassociates from the JM. With this PR the reporter is closed, restarted  and metrics are being reported again.&lt;/p&gt;

&lt;p&gt;    In general, I&apos;m wondering whether we should introduce an explicit suspended state where the metrics are still available and only reset after recovery. I was testing this with JMX and wondered whether it can be problematic for users if the reporter are down during JM recovery.&lt;/p&gt;</comment>
                            <comment id="15725421" author="githubbot" created="Tue, 6 Dec 2016 12:56:15 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The reporter isn&apos;t closed and restarted; instead all metrics are being de-registered and then re-registered. This is necessary since the ID of the TM changes upon re-association with the JM.&lt;/p&gt;

&lt;p&gt;    It would make sense to only un-register the metrics after we associate with a new JM; this should reduce the downtime of taskmanager metrics.&lt;/p&gt;</comment>
                            <comment id="15725715" author="uce" created="Tue, 6 Dec 2016 14:50:15 +0000"  >&lt;p&gt;Fixed in e5f4e3d (master).&lt;/p&gt;</comment>
                            <comment id="15725717" author="githubbot" created="Tue, 6 Dec 2016 14:51:12 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2886&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36uif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>