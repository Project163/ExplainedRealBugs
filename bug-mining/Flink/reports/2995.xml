<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:39:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-12260] Slot allocation failure by taskmanager registration timeout and race</title>
                <link>https://issues.apache.org/jira/browse/FLINK-12260</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In 1.6.2., we have seen slot allocation failure keep happening for long time. Having looked at the log, I see the following behavior:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;TM sends a registration request R1 to resource manager.&lt;/li&gt;
	&lt;li&gt;R1 times out after 100ms, which is initial timeout.&lt;/li&gt;
	&lt;li&gt;TM retries a registration request R2 to resource manager (with timeout 200ms).&lt;/li&gt;
	&lt;li&gt;R2 arrives first at resource manager and registered, and then TM gets successful response moving onto step 5 below.&lt;/li&gt;
	&lt;li&gt;On successful registration, R2&apos;s instance is put to taskManagerRegistrations&lt;/li&gt;
	&lt;li&gt;Then R1 arrives at resource manager and realizes the same TM resource ID is already registered, which then unregisters R2&apos;s instance ID from taskManagerRegistrations. A new instance ID for R1 is registered to workerRegistration.&lt;/li&gt;
	&lt;li&gt;R1&apos;s response is not handled though since it already timed out (see akka temp actor resolve failure below), hence no registration to taskManagerRegistrations.&lt;/li&gt;
	&lt;li&gt;TM keeps heartbeating to the resource manager with slot status.&lt;/li&gt;
	&lt;li&gt;Resource manager ignores this slot status, since taskManagerRegistrations contains R2, not R1, which replaced R2 in&#160;workerRegistration at step 6.&lt;/li&gt;
	&lt;li&gt;Slot request can never be fulfilled, timing out.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The following is the debug logs for the above steps:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
JM log:

2019-04-11 22:39:40.000,Registering TaskManager with ResourceID 46c8e0d0fcf2c306f11954a1040d5677 (akka.ssl.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@flink-taskmanager:6122/user/taskmanager_0) at ResourceManager
&lt;/span&gt;
2019-04-11 22:39:40.000,Registering TaskManager 46c8e0d0fcf2c306f11954a1040d5677 under deade132e2c41c52019cdc27977266cf at the SlotManager.

2019-04-11 22:39:40.000,Replacing old registration of TaskExecutor 46c8e0d0fcf2c306f11954a1040d5677.

2019-04-11 22:39:40.000,Unregister TaskManager deade132e2c41c52019cdc27977266cf from the SlotManager.

2019-04-11 22:39:40.000,Registering TaskManager with ResourceID 46c8e0d0fcf2c306f11954a1040d5677 (akka.ssl.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@flink-taskmanager:6122/user/taskmanager_0) at ResourceManager
&lt;/span&gt;
TM log:

2019-04-11 22:39:40.000,Registration at ResourceManager attempt 1 (timeout=100ms)

2019-04-11 22:39:40.000,Registration at ResourceManager (akka.ssl.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@flink-jobmanager:6123/user/resourcemanager) attempt 1 timed out after 100 ms
&lt;/span&gt;
2019-04-11 22:39:40.000,Registration at ResourceManager attempt 2 (timeout=200ms)

2019-04-11 22:39:40.000,Successful registration at resource manager akka.ssl.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@flink-jobmanager:6123/user/resourcemanager under registration id deade132e2c41c52019cdc27977266cf.
&lt;/span&gt;
2019-04-11 22:39:41.000,resolve of path sequence [/temp/$c] failed&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As RPC calls seem to use akka ask, which creates temporary source actor, I think multiple RPC calls could&apos;ve arrived out or order by different actor pairs and the symptom above seems to be due to&#160;that. If so, it could have attempt account in the call argument to prevent unexpected unregistration? At this point, what I have done is only log analysis, so I could do further analysis, but before that wanted to check if it&apos;s a known issue.&#160;I also searched with some relevant terms and log pieces, but couldn&apos;t find the duplicate. Please deduplicate if any.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13228978">FLINK-12260</key>
            <summary>Slot allocation failure by taskmanager registration timeout and race</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hwanju">Hwanju Kim</assignee>
                                    <reporter username="hwanju">Hwanju Kim</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 19 Apr 2019 00:02:19 +0000</created>
                <updated>Tue, 14 May 2019 09:19:09 +0000</updated>
                            <resolved>Tue, 14 May 2019 09:19:09 +0000</resolved>
                                    <version>1.6.3</version>
                                    <fixVersion>1.7.3</fixVersion>
                    <fixVersion>1.8.1</fixVersion>
                    <fixVersion>1.9.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="16824317" author="till.rohrmann" created="Tue, 23 Apr 2019 16:46:55 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hwanju&quot; class=&quot;user-hover&quot; rel=&quot;hwanju&quot;&gt;hwanju&lt;/a&gt;. This sounds like a Flink problem to me. Are you able to reproduce the problem? If yes, then it would be helpful to modify the logging statement in line &lt;tt&gt;ResourceManager.java:727&lt;/tt&gt; into &lt;tt&gt;log.info(&quot;Registering TaskManager with ResourceID {} ({}) at ResourceManager under instance id {}&quot;, taskExecutorResourceId, taskExecutorAddress, registration.getInstanceID());&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Something which looks a bit odd is that all logging statement happened at the same time even though there should be a timeout of &lt;tt&gt;100&lt;/tt&gt; ms in between. &lt;/p&gt;

&lt;p&gt;At the moment I&apos;m not sure whether I can fully backtrack the problem to its cause. Maybe the problem is caused by the &lt;tt&gt;RetryingRegistration&lt;/tt&gt; which uses a thread pool of multiple threads to send the registration requests. The additional logs would be tremendously helpful for further debugging this problem.&lt;/p&gt;</comment>
                            <comment id="16824319" author="till.rohrmann" created="Tue, 23 Apr 2019 16:49:00 +0000"  >&lt;p&gt;I think introducing an attempt counter should solve the problem. But before we fix it that way I would like to fully understand how this out of orderness happens.&lt;/p&gt;</comment>
                            <comment id="16824340" author="hwanju" created="Tue, 23 Apr 2019 17:14:19 +0000"  >&lt;p&gt;Thanks Till for the comment. I haven&apos;t attempted to reproduce the issue locally, and I will try reproducing the issue with the better logging and will update this thread once I get more info.&lt;/p&gt;

&lt;p&gt;Regarding odd timestamps of the logs, this is our logging issue we plan to fix,&#160;which loses millisecond granularity when sending flink logs to long-term log archive. As this was the postmortem analysis, I couldn&apos;t gather the live flink logs, that was why the logs zeroed out milliseconds part.&lt;/p&gt;</comment>
                            <comment id="16827369" author="hwanju" created="Fri, 26 Apr 2019 23:29:57 +0000"  >&lt;p&gt;I got repro but&#160;in somewhat tricky way, since it&apos;s definitely rarely happening race. But as mentioned, once it falls into this state, it can&apos;t get out of the state (by assuming that we&apos;re not using active resource manager).&lt;/p&gt;

&lt;p&gt;In the repro, I injected artificial delay to RM-&amp;gt;TM connection on&#160;task executor registration, which can timeout the first registration request resulting in 2nd try. Since RM-&amp;gt;TM connection is carried out in a separate thread via akka ask call, delaying here can&apos;t block the resource manager endpoint mailbox processing, so any further request can be processed during the delay. I&#160;initially added the delay in handling registerTaskExecutorInternal, but as it uses RPC&apos;s executor, the delay blocks all the further retries, hence not reproducing the race. With the delay in TM connection, 2nd task registration attempt can overtake the 1st one going ahead&#160;with TM registration, and then the resumed 1st request unregisters the TM registration. Although I mimicked the race on RM side, I think still sender side can also have potential delay (like by network) during tell part in akka ask causing timeout and leading to 2nd try racing 1st one. The latter was trickier to mimic, so I tried the first approach.&#160;&lt;/p&gt;

&lt;p&gt;The following is the JM/TM logs.&lt;/p&gt;

&lt;p&gt;JM log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-04-26 17:14:44,921 DEBUG org.apache.flink.runtime.rpc.akka.AkkaRpcService - Try to connect to remote RPC endpoint with address akka.ssl.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@192.168.69.15:6122/user/taskmanager_0. Returning a org.apache.flink.runtime.taskexecutor.TaskExecutorGateway gateway. 
&lt;/span&gt;2019-04-26 17:14:44,924 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService - [REPRO] thread 19 attempt 1
2019-04-26 17:14:44,996 INFO&#160; org.apache.flink.runtime.rpc.akka.AkkaRpcService&#160; &#160; &#160; &#160; &#160; &#160; &#160; - [REPRO] thread 22 sleep...
2019-04-26 17:14:45,021 DEBUG org.apache.flink.runtime.rpc.akka.AkkaRpcService - Try to connect to remote RPC endpoint with address akka.ssl.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@192.168.69.15:6122/user/taskmanager_0. Returning a org.apache.flink.runtime.taskexecutor.TaskExecutorGateway gateway.
&lt;/span&gt;2019-04-26 17:14:45,022 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService - [REPRO] thread 19 attempt 2
2019-04-26 17:14:45,038 INFO&#160; org.apache.flink.runtime.resourcemanager.StandaloneResourceManager&#160; - Registering TaskManager with ResourceID d0a410ee9060e62e0c7ef9e46f6418da (akka.ssl.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@192.168.69.15:6122/user/taskmanager_0) at ResourceManager under instance id fa4408b5412bb8c18a6a7e58fdc8ff18
&lt;/span&gt;2019-04-26 17:14:45,093 DEBUG org.apache.flink.runtime.resourcemanager.slotmanager.SlotManager&#160; - Registering TaskManager d0a410ee9060e62e0c7ef9e46f6418da under fa4408b5412bb8c18a6a7e58fdc8ff18 at the SlotManager.
2019-04-26 17:14:45,997 INFO&#160; org.apache.flink.runtime.rpc.akka.AkkaRpcService&#160; &#160; &#160; &#160; &#160; &#160; &#160; - [REPRO] thread 22 done
2019-04-26 17:14:45,998 DEBUG org.apache.flink.runtime.resourcemanager.StandaloneResourceManager&#160; - Replacing old registration of TaskExecutor d0a410ee9060e62e0c7ef9e46f6418da.
2019-04-26 17:14:45,998 DEBUG org.apache.flink.runtime.resourcemanager.slotmanager.SlotManager&#160; - Unregister TaskManager fa4408b5412bb8c18a6a7e58fdc8ff18 from the SlotManager.
2019-04-26 17:14:46,000 INFO&#160; org.apache.flink.runtime.resourcemanager.StandaloneResourceManager&#160; - Registering TaskManager with ResourceID d0a410ee9060e62e0c7ef9e46f6418da (akka.ssl.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@192.168.69.15:6122/user/taskmanager_0) at ResourceManager under instance id&#160;ebad00b418637d2774b8f131d49cc79e
&lt;/span&gt;2019-04-26 17:14:46,000 DEBUG org.apache.flink.runtime.resourcemanager.StandaloneResourceManager&#160; - The target with resource ID d0a410ee9060e62e0c7ef9e46f6418da is already been monitored.
2019-04-26 17:14:47,387 DEBUG org.apache.flink.runtime.resourcemanager.slotmanager.SlotManager&#160; - Received slot report from instance ebad00b418637d2774b8f131d49cc79e.
2019-04-26 17:14:47,387 DEBUG org.apache.flink.runtime.resourcemanager.slotmanager.SlotManager&#160; - Received slot report &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; unknown task manager with instance id ebad00b418637d2774b8f131d49cc79e. Ignoring &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; report.
2019-04-26 17:19:48,045 INFO&#160; org.apache.flink.runtime.executiongraph.ExecutionGraph&#160; &#160; &#160; &#160; - Job&#160; (ed0fbfff272391d1f2a98de45fda6453) switched from state RUNNING to FAILING.
org.apache.flink.runtime.jobmanager.scheduler.NoResourceAvailableException: Could not allocate all requires slots within timeout of 300000 ms. Slots required: 1, slots allocated: 0
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;TM log:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-04-26 17:14:44,897 INFO&#160; org.apache.flink.runtime.taskexecutor.TaskExecutor&#160; &#160; &#160; &#160; &#160; &#160; - Resolved ResourceManager address, beginning registration
2019-04-26 17:14:44,897 INFO&#160; org.apache.flink.runtime.taskexecutor.TaskExecutor&#160; &#160; &#160; &#160; &#160; &#160; - Registration at ResourceManager attempt 1 (timeout=100ms)
2019-04-26 17:14:45,017 DEBUG org.apache.flink.runtime.taskexecutor.TaskExecutor&#160; &#160; &#160; &#160; &#160; &#160; - Registration at ResourceManager (akka.ssl.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@flink-jobmanager:6123/user/resourcemanager) attempt 1 timed out after 100 ms
&lt;/span&gt;2019-04-26 17:14:45,017 INFO&#160; org.apache.flink.runtime.taskexecutor.TaskExecutor&#160; &#160; &#160; &#160; &#160; &#160; - Registration at ResourceManager attempt 2 (timeout=200ms)
2019-04-26 17:14:45,047 INFO&#160; org.apache.flink.runtime.taskexecutor.TaskExecutor&#160; &#160; &#160; &#160; &#160; &#160; - Successful registration at resource manager akka.ssl.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@flink-jobmanager:6123/user/resourcemanager under registration id fa4408b5412bb8c18a6a7e58fdc8ff18.
&lt;/span&gt;2019-04-26 17:14:46,006 DEBUG akka.actor.LocalActorRefProvider(akka:&lt;span class=&quot;code-comment&quot;&gt;//flink)&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; - resolve of path sequence [/temp/$c] failed
&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This&#160;is the&#160;diff for log and reproduce (against 1.6.2) &#8211; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12967185/12967185_FLINK-12260-repro.diff&quot; title=&quot;FLINK-12260-repro.diff attached to FLINK-12260&quot;&gt;FLINK-12260-repro.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;(The current repro method is not systematic rather a tweak due to tricky race)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&#160;may be&#160;testing with attempt count approach.&lt;/p&gt;</comment>
                            <comment id="16827919" author="jiaxl" created="Sun, 28 Apr 2019 10:58:57 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;If this issue is still open, I&apos;d like to fix this problem with an attempt count, as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&#160;suggested.&#160;&#160;&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="16829084" author="till.rohrmann" created="Mon, 29 Apr 2019 09:56:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiaxl&quot; class=&quot;user-hover&quot; rel=&quot;jiaxl&quot;&gt;jiaxl&lt;/a&gt; I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hwanju&quot; class=&quot;user-hover&quot; rel=&quot;hwanju&quot;&gt;hwanju&lt;/a&gt; is already working on a fix for it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hwanju&quot; class=&quot;user-hover&quot; rel=&quot;hwanju&quot;&gt;hwanju&lt;/a&gt; if I understood you correctly, then I think the solution could be keeping a reference to the &lt;tt&gt;CompletableFuture&amp;lt;TaskExecutorGateway&amp;gt; taskExecutorGatewayFuture&lt;/tt&gt; future returned in &lt;tt&gt;ResourceManager.java:373&lt;/tt&gt; and then check in the callback for referential equality &lt;tt&gt;ResourceManager.java:376&lt;/tt&gt;. Then we would not have to add another field to the RPC call.&lt;/p&gt;

&lt;p&gt;This is a really good discovery. Thanks a lot for investigating this problem!&lt;/p&gt;</comment>
                            <comment id="16830100" author="hwanju" created="Tue, 30 Apr 2019 09:21:56 +0000"  >&lt;p&gt;Thanks Till. I had tested with attempt count addition to RPC before your comment. I worked as expected.&lt;/p&gt;

&lt;p&gt;At any rate, I may need some clarification on your idea about reference equality, regarding how it could address this issue. Although the repro uses delay in task executor connection, as mentioned, the race may happen&#160;on sender side. Even for dealing with race in the task executor connection, I am curious how reference check alone would work. If receiver-only approach&#160;can work, it would be better compared to attempt count one.&lt;/p&gt;</comment>
                            <comment id="16830167" author="till.rohrmann" created="Tue, 30 Apr 2019 10:33:39 +0000"  >&lt;p&gt;I&apos;m still a bit skeptical that there is a race condition on the sender side. We only trigger the second registration call after the first one has produced a timeout. A timeout can only be produced if we have sent a request to the receiver side.&lt;/p&gt;

&lt;p&gt;My proposal would be the following:&lt;/p&gt;

&lt;p&gt;We have a &lt;tt&gt;Map&amp;lt;ResourceID, CompletableFuture&amp;lt;TaskExecutorGateway&amp;gt;&amp;gt; taskExecutorGatewayFutures&lt;/tt&gt; of pending &lt;tt&gt;TaskExecutor&lt;/tt&gt; connections. When we enter the method &lt;tt&gt;ResourceManager#registerTaskExecutor&lt;/tt&gt; we create a new future and update &lt;tt&gt;taskExecutorGatewayFutures&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Inside the &lt;tt&gt;handleAsync&lt;/tt&gt; call on the future we check whether we are still the pending &lt;tt&gt;TaskExecutor&lt;/tt&gt; connection:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; taskExecutorGatewayFuture.handleAsync(
	(TaskExecutorGateway taskExecutorGateway, Throwable throwable) -&amp;gt; {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (taskExecutorGatewayFutures.get(taskExecutorResourceId) == taskExecutorGatewayFuture) {
			taskExecutorGatewayFutures.remove(taskExecutorResourceId);
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RegistrationResponse.Decline(throwable.getMessage());
			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; registerTaskExecutorInternal(
					taskExecutorGateway,
					taskExecutorAddress,
					taskExecutorResourceId,
					dataPort,
					hardwareDescription);
			}
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Ignoring outdated TaskExecutorGateway connection.&quot;&lt;/span&gt;);
		}
	},
	getMainThreadExecutor());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Given that the &lt;tt&gt;registerTaskExecutor&lt;/tt&gt; calls come in order, this should prevent that an earlier register call overrides a later one.&lt;/p&gt;</comment>
                            <comment id="16830862" author="hwanju" created="Wed, 1 May 2019 04:57:09 +0000"  >&lt;p&gt;Thanks for the clarification. I thought you meant it without introducing any additional map, but now it seems clear.&lt;/p&gt;

&lt;p&gt;I&#160;had tried thinking conservative approach as I couldn&apos;t 100% rule out the possibility of sender-side race. As we may have a potential simpler solution, I looked at the code again a little further. Initially what led me to any possibility of race is this part:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val a = PromiseActorRef(ref.provider, timeout, targetName = actorRef, message.getClass.getName, sender)
actorRef.tell(message, a)
a.result.&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is&#160;internalAsk from invokeRpc and PromiseActorRef internally does&#160;scheduler.scheduleOnce(timeout.duration) for the timer. The tell of actorRef is sending a message to RM through RemoteActorRef and EndpointManager where the message&#160;is passed to Dispatcher, which enqueues the message to mbox and executes mbox via executor thread. My impression was that as tell is asynchronous via executor service, the timer of PromiseActorRef set up before can fire before the message&#160;hit the road off the sender. Although that&apos;d be possible, the message at least seems to be enqueued to mbox for RM endpoint and thus the order can be preserved against the next attempt after timeout. So, the ordering seems fine. In addition I was also concerned the case where two different ask calls might happen to use two different TCP connections leading any possible out-of-order delivery. Although not 100% exercising the relevant code, it seems to use a single connection associated by akka endpoints and I checked that&apos;s true by packet capture.&#160;&lt;/p&gt;

&lt;p&gt;So, based on the code inspection and no successful repro on sender-side, we can currently conclude that the race is likely happening in task executor connection/handshake on the receiver-side (as repro does). I will test it out with the Till&apos;s proposal. On our side, once this fix ends up being applied, we can keep eyes on our test apps, which intermittently hit this issue, to see if there&apos;s any other race issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16831537" author="till.rohrmann" created="Thu, 2 May 2019 10:38:13 +0000"  >&lt;p&gt;Thanks a lot for your detailed analysis of the ask code path in Akka &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hwanju&quot; class=&quot;user-hover&quot; rel=&quot;hwanju&quot;&gt;hwanju&lt;/a&gt;. Do you wanna open a PR for this fix? You can ping me for the review.&lt;/p&gt;</comment>
                            <comment id="16832313" author="hwanju" created="Fri, 3 May 2019 07:36:14 +0000"  >&lt;p&gt;Sure. I will ping you once I will have tested the fix.&lt;/p&gt;</comment>
                            <comment id="16839244" author="till.rohrmann" created="Tue, 14 May 2019 09:19:09 +0000"  >&lt;p&gt;Merged via&lt;/p&gt;

&lt;p&gt;1.9.0:&lt;br/&gt;
07773d0d9251d6ad8c1770de985d33be8e72b032&lt;br/&gt;
2284f777ecd3b62b412bd0fdb9dbcf492314c589&lt;/p&gt;

&lt;p&gt;1.8.1:&lt;br/&gt;
28b539da749949c656259c68e4a0a98e081551cf&lt;br/&gt;
a043e41fe14113d2bf3b9b25438680759619e418&lt;/p&gt;

&lt;p&gt;1.7.3:&lt;br/&gt;
bcd35b9b51e96b231bc64d3b45583bfcf47c3d18&lt;br/&gt;
ca85285cda0f0cb6f82ed55a25aa4c439be1c2b2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12967185" name="FLINK-12260-repro.diff" size="3236" author="hwanju" created="Fri, 26 Apr 2019 23:28:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01y2g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>