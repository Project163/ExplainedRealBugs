<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-17470] Flink task executor process permanently hangs on `flink-daemon.sh stop`, deletes PID file</title>
                <link>https://issues.apache.org/jira/browse/FLINK-17470</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Hi Flink team!&lt;/p&gt;

&lt;p&gt;We&apos;ve attempted to upgrade our flink 1.9 cluster to 1.10, but are experiencing reproducible instability on shutdown. Speciically, it appears that the `kill` issued in the `stop` case of flink-daemon.sh is causing the task executor process to hang permanently. Specifically, the process seems to be hanging in the `org.apache.flink.runtime.util.JvmShutdownSafeguard$DelayedTerminator.run` in a `Thread.sleep()` call. I think this is a bizarre behavior. Also note that every thread in the process is BLOCKED. on a `pthread_cond_wait` call. Is this an OS level issue? Banging my head on a wall here. See attached stack traces for details.&lt;/p&gt;</description>
                <environment>&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ uname -a
Linux hostname.local 3.10.0-1062.9.1.el7.x86_64 #1 SMP Fri Dec 6 15:49:49 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
$ lsb_release -a
LSB Version:	:core-4.1-amd64:core-4.1-noarch
Distributor ID:	CentOS
Description:	CentOS Linux release 7.7.1908 (Core)
Release:	7.7.1908
Codename:	Core
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Flink version 1.10&lt;br/&gt;
&#160;&lt;/p&gt;</environment>
        <key id="13301908">FLINK-17470</key>
            <summary>Flink task executor process permanently hangs on `flink-daemon.sh stop`, deletes PID file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rmetzger">Robert Metzger</assignee>
                                    <reporter username="hherman">Hunter Herman</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 29 Apr 2020 20:17:22 +0000</created>
                <updated>Fri, 20 Nov 2020 12:04:54 +0000</updated>
                            <resolved>Fri, 20 Nov 2020 12:04:54 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17111891" author="stephanewen" created="Wed, 20 May 2020 08:04:16 +0000"  >&lt;p&gt;What JVM version are you using? Maybe there is different behavior in newer JVM versions?&lt;/p&gt;

&lt;p&gt;Nothing changed in The JvmShutdownGuard since many releases, so curious that this changed reproducibly in your setup.&lt;/p&gt;</comment>
                            <comment id="17113493" author="hherman" created="Thu, 21 May 2020 19:38:19 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;! Thanks for the reply. Here&apos;s the version of java we&apos;re using (we use Azul):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
openjdk version &lt;span class=&quot;code-quote&quot;&gt;&quot;1.8.0_232&quot;&lt;/span&gt;
OpenJDK &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Environment (Zulu 8.42.0.14-SA-linux64) (build 1.8.0_232-b18)
OpenJDK 64-Bit Server VM (Zulu 8.42.0.14-SA-linux64) (build 25.232-b18, mixed mode)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17114846" author="stephanewen" created="Sat, 23 May 2020 15:42:58 +0000"  >&lt;p&gt;Have you run Flink 1.9 on the exact same version? And does Flink 1.9 still shut down the JVM properly, while 1.10 does not?&lt;/p&gt;</comment>
                            <comment id="17117471" author="hherman" created="Wed, 27 May 2020 07:38:55 +0000"  >&lt;p&gt;We have observed the same problem with 1.9 on the same system setup/java version, however far less frequently. Flink 1.10 experiences this issue around 1 in 3 or 4 restarts, while flink 1.9 seems more like 1 in 15 or so. &lt;/p&gt;</comment>
                            <comment id="17119316" author="rmetzger" created="Fri, 29 May 2020 06:47:06 +0000"  >&lt;p&gt;Just a side note: Flink&apos;s end to end tests (which run Flink using the scripts) are also running on a JVM from Azul, specifically: &lt;tt&gt;OpenJDK 64-Bit Server VM - Azul Systems, Inc. - 1.8/25.252-b14&lt;/tt&gt;. I have never observed shutdown instabilities there. &lt;/p&gt;

&lt;p&gt;From the blog post (&lt;a href=&quot;https://blogs.oracle.com/poonam/hung-jvm-due-to-the-threads-stuck-in-pthreadcondtimedwait&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://blogs.oracle.com/poonam/hung-jvm-due-to-the-threads-stuck-in-pthreadcondtimedwait&lt;/a&gt;) you&apos;ve mentioned on the mailing list it seems that the fix in the linux kernel (&lt;a href=&quot;https://github.com/torvalds/linux/commit/76835b0ebf8a7fe85beb03c75121419a7dec52f0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/torvalds/linux/commit/76835b0ebf8a7fe85beb03c75121419a7dec52f0&lt;/a&gt;) is available since 3.18. You are on Linux 3.10. Would you be able to validate if this issue still persists on Linux 3.18+ ?&lt;/p&gt;</comment>
                            <comment id="17140749" author="hherman" created="Fri, 19 Jun 2020 18:42:12 +0000"  >&lt;p&gt;We&apos;re using CentOS 7, which defaults to the 3.10 kernel, so it would be very difficult for us to bump the kernel across the world (&lt;a href=&quot;https://wiki.centos.org/About/Product&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.centos.org/About/Product&lt;/a&gt;); is there any other way for us to go about trying to fix this? &lt;/p&gt;</comment>
                            <comment id="17142822" author="stephanewen" created="Tue, 23 Jun 2020 10:25:03 +0000"  >&lt;p&gt;I think one think you can do is change the &lt;tt&gt;&quot;flink-daemon.sh stop&quot;&lt;/tt&gt; command to use SIGKILL instead of SIGTERM.&lt;/p&gt;

&lt;p&gt;That should work by avoiding all types of shutdown hooks. It will be not as graceful of an exit, tough. For example, Flink won&apos;t clean up its temp directory itself, so you need to eventually clean that up (unless your system environment takes care of that eventually).&lt;/p&gt;

&lt;p&gt;An advanced version, you could try to extend that script to send a SIGTERM and a SIGKILL some X seconds later, if the process still exists. That&apos;s what Flink does internally but gets hung up due to the JVM/Kernel issue. I don&apos;t know from the top of my head how to best do that in bash, though.&lt;/p&gt;</comment>
                            <comment id="17164255" author="till.rohrmann" created="Fri, 24 Jul 2020 08:24:55 +0000"  >&lt;p&gt;Introducing this kind of safety net could be a good idea. Based on &lt;a href=&quot;https://stackoverflow.com/a/687994/4815083&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/a/687994/4815083&lt;/a&gt; we could add something like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
kill -s SIGTERM $$ &amp;amp;&amp;amp; kill -0 $$ || exit 0

((t = delay))

&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; ((t &amp;gt; 0)); &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
    sleep $interval
    kill -0 $$ || exit 0
    ((t -= interval))
done

kill -s SIGKILL $$
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17204205" author="hherman" created="Tue, 29 Sep 2020 18:47:50 +0000"  >&lt;p&gt;The `kill -9` solution has been working for us in prod. Thanks for taking the time to look at it. The other ticket you referenced &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; is fascinating. &lt;/p&gt;</comment>
                            <comment id="17229049" author="rmetzger" created="Tue, 10 Nov 2020 08:10:06 +0000"  >&lt;p&gt;I will open a PR for the SIGTERM to SIGKILL script extension.&lt;/p&gt;</comment>
                            <comment id="17232753" author="rmetzger" created="Mon, 16 Nov 2020 13:22:19 +0000"  >&lt;p&gt;Improved stop behavior in the standalone scripts in &lt;a href=&quot;https://github.com/apache/flink/commit/30ae028774f389f21bdef0a7fa03c90e178cfa03&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/30ae028774f389f21bdef0a7fa03c90e178cfa03&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17234617" author="aljoscha" created="Wed, 18 Nov 2020 13:34:42 +0000"  >&lt;p&gt;This fails on my machine with&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/Users/aljoscha/Dev/flink/flink-dist/target/flink-1.12-SNAPSHOT-bin/flink-1.12-SNAPSHOT/bin/flink-daemon.sh: line 98: timeout: command not found
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;when running &lt;tt&gt;bin/stop-cluster.sh&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I think that&apos;s not a good out-of-box experience for users.&lt;/p&gt;</comment>
                            <comment id="17234626" author="rmetzger" created="Wed, 18 Nov 2020 13:47:00 +0000"  >&lt;p&gt;Can you share more details on your environment?&lt;/p&gt;</comment>
                            <comment id="17234630" author="aljoscha" created="Wed, 18 Nov 2020 13:50:43 +0000"  >&lt;p&gt;Ah sorry, yes. I&apos;m running macOS Catalina (10.15.7), otherwise I don&apos;t know what could be happening. What is &lt;tt&gt;timeout&lt;/tt&gt; on your machine? Is it a shell builtin, or an actual program? What&apos;s the output of &lt;tt&gt;which timeout&lt;/tt&gt; or &lt;tt&gt;whereis timeout&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="17234638" author="rmetzger" created="Wed, 18 Nov 2020 13:57:18 +0000"  >&lt;p&gt;Damn. Looks like I have &quot;timeout&quot; through &quot;coreutils&quot; (installed via homebrew). It is also available in our CI environment, that&apos;s why I didn&apos;t catch this. I&apos;ll reopen this ticket until I&apos;ve figured a solution.&lt;/p&gt;</comment>
                            <comment id="17236098" author="rmetzger" created="Fri, 20 Nov 2020 12:04:54 +0000"  >&lt;p&gt;Fix merged in &lt;a href=&quot;https://github.com/apache/flink/commit/7e05b335845ee6a0688914cdc862bea107bbf114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/7e05b335845ee6a0688914cdc862bea107bbf114&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13290629">FLINK-16510</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13001647" name="flink_jstack.log" size="249650" author="hherman" created="Wed, 29 Apr 2020 20:17:15 +0000"/>
                            <attachment id="13001646" name="flink_mixed_jstack.log" size="158233" author="hherman" created="Wed, 29 Apr 2020 20:17:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 51 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0e880:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>In Flink 1.12 we changed the behavior of the standalone scripts to issue a SIGKILL if a SIGTERM did not succeed in shutting down a Flink process.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>