<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:21:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-36451] Kubernetes Application JobManager Potential Deadlock and TaskManager Pod Residuals</title>
                <link>https://issues.apache.org/jira/browse/FLINK-36451</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In Kubernetes Application Mode, when there is significant etcd latency or instability, the Flink JobManager may enter a deadlock situation. Additionally, TaskManager pods are not cleaned up properly, resulting in stale resources that prevent the Flink job from recovering correctly. This issue occurs during frequent service restarts or network instability.&lt;/p&gt;</description>
                <environment>&lt;ul&gt;
	&lt;li&gt;Flink version: 1.19.1&lt;/li&gt;
	&lt;li&gt;- Deployment mode: Flink Kubernetes Application Mode&lt;/li&gt;
	&lt;li&gt;- JVM version: OpenJDK 17&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13594764">FLINK-36451</key>
            <summary>Kubernetes Application JobManager Potential Deadlock and TaskManager Pod Residuals</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mapohl">Matthias Pohl</assignee>
                                    <reporter username="xiechenling">xiechenling</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 9 Oct 2024 10:04:11 +0000</created>
                <updated>Mon, 20 Jan 2025 08:54:19 +0000</updated>
                            <resolved>Wed, 11 Dec 2024 15:41:50 +0000</resolved>
                                    <version>1.19.1</version>
                                    <fixVersion>2.0.0</fixVersion>
                    <fixVersion>1.19.2</fixVersion>
                    <fixVersion>1.20.1</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17895568" author="mapohl" created="Tue, 5 Nov 2024 11:11:29 +0000"  >&lt;p&gt;Thanks for sharing, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xiechenling&quot; class=&quot;user-hover&quot; rel=&quot;xiechenling&quot;&gt;xiechenling&lt;/a&gt;. I will have a look at it.&lt;/p&gt;</comment>
                            <comment id="17895936" author="mapohl" created="Wed, 6 Nov 2024 11:50:43 +0000"  >&lt;p&gt;The problem is that we have two code paths running concurrently (in the contenders main thread and in the main thread of the &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt;) that acquire the same locks in reversed order:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Certain operations in the contender (the DispatcherLeaderProcess in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-36451&quot; title=&quot;Kubernetes Application JobManager Potential Deadlock and TaskManager Pod Residuals&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-36451&quot;&gt;&lt;del&gt;FLINK-36451&lt;/del&gt;&lt;/a&gt; and similarly the JobMasterServiceLeadershipRunner) need to be called only as leader. These operations are executed from within the contender and acquire the contender&#8217;s lock first before acquiring the LeaderElectionService lock (to check for leadership)).&lt;/li&gt;
	&lt;li&gt;In the meantime, any leadership change event will trigger the same locks in reverse order: First, locking the DefaultLeaderElectionService lock and then informing the registered contenders. Notifying the contenders will require acquiring their locks as part of the process.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With unstable leadership happening quite often, the chance of running into a deadlock increases. This is an issue that does not only affect the k8s but also the ZooKeeper leader election.&lt;/p&gt;

&lt;p&gt;The solution should be to run any leader election-related operations solely on the &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt; main thread to ensure sequential execution. This allows us to remove the lock within the &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt;. We have to ensure, though, that the operations that are performed on the &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt; main thread are light-weight (similar to the requirements of Flink&apos;s &lt;tt&gt;RpcEndpoint&lt;/tt&gt; main thread).&lt;/p&gt;</comment>
                            <comment id="17904215" author="mapohl" created="Mon, 9 Dec 2024 16:29:13 +0000"  >&lt;p&gt;Fix is merged to &lt;tt&gt;master&lt;/tt&gt;. I&apos;m preparing the backports for 1.19 and 1.20 now.&lt;/p&gt;</comment>
                            <comment id="17904388" author="mapohl" created="Tue, 10 Dec 2024 08:18:27 +0000"  >&lt;ul&gt;
	&lt;li&gt;master:
	&lt;ul&gt;
		&lt;li&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/b32181bb95d8865b8d3eac3c6a6ed4f0f0c14a98&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;b32181bb95d8865b8d3eac3c6a6ed4f0f0c14a98&lt;/a&gt;&lt;/li&gt;
		&lt;li&gt;hotfix: &lt;a href=&quot;https://github.com/apache/flink/commit/0df38635655b87df85e7f0d786b7f4ef285debce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;0df38635655b87df85e7f0d786b7f4ef285debce&lt;/a&gt;&lt;/li&gt;
		&lt;li&gt;hotfix: &lt;a href=&quot;https://github.com/apache/flink/commit/e3b060357eca3566e69180639f6337a9249c8c2a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;e3b060357eca3566e69180639f6337a9249c8c2a&lt;/a&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;1.20:
	&lt;ul&gt;
		&lt;li&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/09a7e7e2ac1c0ed51faaadfde21791e4fc7feb8e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;09a7e7e2ac1c0ed51faaadfde21791e4fc7feb8e&lt;/a&gt;&lt;/li&gt;
		&lt;li&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/8be40eaec4f260c3863699558192740032066605&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;8be40eaec4f260c3863699558192740032066605&lt;/a&gt;&lt;/li&gt;
		&lt;li&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/494cf93bc009158629ab5e944bbf55c1c0cfbe70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;494cf93bc009158629ab5e944bbf55c1c0cfbe70&lt;/a&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;1.19:
	&lt;ul&gt;
		&lt;li&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/61b1c337c900a646d2cf23757ce22ef563b8f337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;61b1c337c900a646d2cf23757ce22ef563b8f337&lt;/a&gt;&lt;/li&gt;
		&lt;li&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/5bd04777cc812278f4961dfb602fcfcb2cf52ee9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5bd04777cc812278f4961dfb602fcfcb2cf52ee9&lt;/a&gt;&lt;/li&gt;
		&lt;li&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/ca54ab7f0116e83e51ec8d31cfc95271130dda92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ca54ab7f0116e83e51ec8d31cfc95271130dda92&lt;/a&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                            <outwardlinks description="Testing discovered">
                                        <issuelink>
            <issuekey id="13601703">FLINK-36888</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13072072" name="1.png" size="144300" author="xiechenling" created="Wed, 9 Oct 2024 10:04:03 +0000"/>
                            <attachment id="13072071" name="2.png" size="53619" author="xiechenling" created="Wed, 9 Oct 2024 10:04:06 +0000"/>
                            <attachment id="13072074" name="jobmanager.log" size="107448" author="xiechenling" created="Wed, 9 Oct 2024 10:02:45 +0000"/>
                            <attachment id="13072073" name="jstack.txt" size="100614" author="xiechenling" created="Wed, 9 Oct 2024 10:02:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            48 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1rvgo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>