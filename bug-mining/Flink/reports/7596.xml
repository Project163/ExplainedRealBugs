<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:21:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-35886] Incorrect watermark idleness timeout accounting when subtask is backpressured/blocked</title>
                <link>https://issues.apache.org/jira/browse/FLINK-35886</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently when using watermark with idleness in Flink, idleness can be incorrectly detected when reading records from a source that is blocked by the runtime. For example this can easily happen when source is either backpressured, or blocked by the watermark alignment. In those cases, despite there are more records to be read from the source (or source&#8217;s split), runtime is deciding not to poll (or being unable to) those records. In such case idleness timeout can kick in, marking source/source split as idle, which can lead to incorrect combined watermark calculations and dropping of incorrectly marked late records.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Watermarkalignment&quot;&gt;&lt;/a&gt;Watermark alignment&lt;/h4&gt;

&lt;p&gt;If there are two source splits, A and B , and maxAllowedWatermarkDrift is set to 30s. &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Partition A emitted watermark 1042 sec, while partition B sits at watermark 1000 sec.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;1042s - 1000s &amp;gt; maxAllowedWatermarkDrift&lt;/tt&gt;, so partition A is blocked by the watermark alignment.&lt;/li&gt;
	&lt;li&gt;For the duration of idleTimeout, partition B is emitting some large batch of records, that do not advance watermark of that partition by much. For example either watermark for partition B stays 1000s, or is updated by a small amount to for example 1005s.&lt;/li&gt;
	&lt;li&gt;idleTimeout kicks in, marking partition A as idle&lt;/li&gt;
	&lt;li&gt;partition B finishes emitting large batch of those older records, and let&apos;s say now there is a gap in rowtimes. Previously partition B was emitting records with rowtime ~1000s, now it jumps to for example ~5000s.&lt;/li&gt;
	&lt;li&gt;As partition A is idle, combined watermark jumps to ~5000s as well.&lt;/li&gt;
	&lt;li&gt;Watermark alignment unblocks partition A, and it continues emitting records with rowtime ~1042s. But now all of those records are dropped due to being late.&lt;/li&gt;
&lt;/ol&gt;


&lt;h4&gt;&lt;a name=&quot;Backpressure&quot;&gt;&lt;/a&gt;Backpressure&lt;/h4&gt;

&lt;p&gt;When there are two SourceOperator&#8217;s, A and B. Due to for example some data skew, it could happen that either only A gets backpressured, or A is backpressured quicker/sooner. Either way, during that time when A is backpressured, while B is not, B can bump the combined watermark high enough, so that when backpressure recedes, fresh records from A will be considered as late, leading to incorrect results.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13586691">FLINK-35886</key>
            <summary>Incorrect watermark idleness timeout accounting when subtask is backpressured/blocked</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 23 Jul 2024 15:23:29 +0000</created>
                <updated>Mon, 24 Mar 2025 09:32:00 +0000</updated>
                            <resolved>Wed, 21 Aug 2024 06:56:35 +0000</resolved>
                                    <version>1.18.1</version>
                    <version>1.20.0</version>
                    <version>1.19.1</version>
                                    <fixVersion>1.19.2</fixVersion>
                    <fixVersion>1.20.1</fixVersion>
                    <fixVersion>2.0-preview</fixVersion>
                                    <component>API / DataStream</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                                                            <comments>
                            <comment id="17868098" author="pnowojski" created="Tue, 23 Jul 2024 15:24:27 +0000"  >&lt;p&gt;I think this problem requires a public API change, so I have published a FLIP for this: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/FLINK/FLIP-471%3A++Fixing+watermark+idleness+timeout+accounting&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/FLINK/FLIP-471%3A++Fixing+watermark+idleness+timeout+accounting&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17874458" author="pnowojski" created="Sat, 17 Aug 2024 08:57:18 +0000"  >&lt;p&gt;Merged to master as 308f05a911d..5f6200c7191&lt;/p&gt;</comment>
                            <comment id="17875370" author="pnowojski" created="Wed, 21 Aug 2024 06:56:35 +0000"  >&lt;p&gt;Merged to 1.20 as &lt;span class=&quot;error&quot;&gt;&amp;#91;d1fe68e3358..62750753ad4&amp;#93;&lt;/span&gt;&lt;br/&gt;
Merged to 1.19 as &lt;span class=&quot;error&quot;&gt;&amp;#91;f10d5e3be03..5da82f8ca4e&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17916974" author="afedulov" created="Sat, 25 Jan 2025 22:42:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; unfortunately &lt;a href=&quot;https://github.com/apache/flink/commit/0c5af25063cb2e6b94f2e74ce7e7177fc5ed0c24&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; commit breaks the japicmp check:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[ERROR] Failed to execute goal com.github.siom79.japicmp:japicmp-maven-plugin:0.17.1:cmp (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;) on project flink-core: There is at least one incompatibility: org.apache.flink.api.common.eventtime.WatermarkGeneratorSupplier$Context.getInputActivityClock():METHOD_NEW_DEFAULT,org.apache.flink.util.clock.Clock:METHOD_ABSTRACT_ADDED_IN_IMPLEMENTED_INTERFACE -&amp;gt; [Help 1]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This currently presents a blocker for 1.20.1 release. Could you please look into providing a fix?&lt;/p&gt;</comment>
                            <comment id="17916975" author="afedulov" created="Sat, 25 Jan 2025 23:06:23 +0000"  >&lt;p&gt;It seems that this commit is missing from release-1.20&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/5da82f8c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/5da82f8c&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I wonder how it managed to pass the CI, it fails both during the release process on&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
tools $ releasing/deploy_staging_jars.sh&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and on&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 mvn&#160;verify -Dcommons.japicmp.breakBuildOnBinaryIncompatibleModifications=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -DskipTests -T 1C&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As I see, you already had some suspicion about it &lt;a href=&quot;https://github.com/apache/flink/pull/25222/files#r1723776966&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/25222/files#r1723776966&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; &#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17921389" author="afedulov" created="Mon, 27 Jan 2025 13:50:31 +0000"  >&lt;p&gt;Here is why this did not get captured by the CI: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-37098?focusedCommentId=17921143&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17921143&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-37098?focusedCommentId=17921143&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17921143&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17924419" author="pnowojski" created="Thu, 6 Feb 2025 08:28:37 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=afedulov&quot; class=&quot;user-hover&quot; rel=&quot;afedulov&quot;&gt;afedulov&lt;/a&gt;, sorry I was out of office and now I&apos;m going back through the notifications. However I noticed that you have already cherry-picked the japi exclusion for this bug fix from 1.19 to 1.20, so everything has been already fixed?&lt;/p&gt;

&lt;p&gt;fed8c110558 &lt;span class=&quot;error&quot;&gt;&amp;#91;10 days ago&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-35886&quot; title=&quot;Incorrect watermark idleness timeout accounting when subtask is backpressured/blocked&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-35886&quot;&gt;&lt;del&gt;FLINK-35886&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;source&amp;#93;&lt;/span&gt; Exclude japi checks for the API changes&lt;/p&gt;

&lt;p&gt;?&lt;/p&gt;</comment>
                            <comment id="17924501" author="afedulov" created="Thu, 6 Feb 2025 11:32:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;,&lt;br/&gt;
no worries. Yes, we resolved it by applying the same exclusions you already had for the 1.19.2 branch. Japi checks on the 1.20-release branch where misconfigured, that&apos;s why the PR&apos;s CI passed there without this necessary adjustment.&lt;/p&gt;</comment>
                            <comment id="17924901" author="pnowojski" created="Fri, 7 Feb 2025 14:13:34 +0000"  >&lt;p&gt;Thanks for fixing it!&lt;/p&gt;</comment>
                            <comment id="17937821" author="JIRAUSER301498" created="Mon, 24 Mar 2025 09:22:34 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; &lt;br/&gt;
This change causes an issue with using custom metrics in Watermark Generators. Its due a change from lambda to anonymous class.&lt;br/&gt;
Details: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-37545&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-37545&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13612837">FLINK-37545</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="13599355">FLINK-36751</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qhps:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>For detecting idleness, the way how idleness timeout is calculated has changed. Previously the time, when source or source&amp;#39;s split has been backpressured or blocked due to watermark alignment, was accounted towards the idleness timeout. This could lead to a situation where sources or some splits were incorrectly switching to idle, while they were being unable to make any progress and had some more records to emit, which in turn could result in incorrectly calculated watermarks and erroneous late data. This has been fixed for 1.19.2, 1.20.1 and 2.0.0.&lt;br/&gt;
&lt;br/&gt;
This change required some API changes, like introduction of `org.apache.flink.api.common.eventtime.WatermarkGeneratorSupplier.Context#getInputActivityClock`. However this shouldn&amp;#39;t create compatibility problems for users upgrading from prior Flink versions.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>