<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20333] Flink standalone cluster throws metaspace OOM after submitting multiple PyFlink UDF jobs.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20333</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently the&#160;Flink standalone cluster will throw metaspace OOM&#160;after submitting multiple PyFlink UDF jobs. The root cause is that currently the PyFlink classes are running in user classloader and so each job creates a separate user class loader to load PyFlink related classes. There are many soft references and Finalizers in memory (introduced by the underlying Netty), which prevents the garbage collection of the user classloader of already finished PyFlink jobs.&#160;&lt;/p&gt;

&lt;p&gt;Due to their existence, it needs multiple full gc to reclaim the classloader of the completed job. If only one full gc is performed before the metaspace space is insufficient, then OOM will occur.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13342506">FLINK-20333</key>
            <summary>Flink standalone cluster throws metaspace OOM after submitting multiple PyFlink UDF jobs.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zhongwei">Wei Zhong</assignee>
                                    <reporter username="zhongwei">Wei Zhong</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 25 Nov 2020 03:53:54 +0000</created>
                <updated>Tue, 14 Sep 2021 05:46:06 +0000</updated>
                            <resolved>Wed, 25 Nov 2020 11:21:37 +0000</resolved>
                                                    <fixVersion>1.11.3</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>API / Python</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17238687" author="dian.fu" created="Wed, 25 Nov 2020 11:21:38 +0000"  >&lt;p&gt;Fixed in&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;master via c354f7bd679b9fa8c1e0d75feb3827ccca7f317b&lt;/li&gt;
	&lt;li&gt;release-1.11 via 18392118c38dc6a1b3a76a76bc2d0fb3ee2f8d7f&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17238754" author="f.pompermaier" created="Wed, 25 Nov 2020 13:44:53 +0000"  >&lt;p&gt;Could this problem affect also normal java jobs? I have the same leak in my Flink session cluster...actually this is the suggested leak message that the Eclipse MAT gives to me:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
5,416 instances of &lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&quot;&lt;/span&gt;, loaded by &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;system &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loader&amp;gt;&quot;&lt;/span&gt; occupy 2,706,048 (11.04%)bytes.
Biggest instances:

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.io.ObjectStreamClass$Caches @ 0xe0f52f98&#160;-&#160;402,896 (1.64%) bytes. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After some job resubmission I get the follogin exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.OutOfMemoryError: Metaspace. The metaspace out-of-memory error has occurred. This can mean two things: either the job requires a larger size of JVM metaspace to load classes or there is a &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loading leak. In the first &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;taskmanager.memory.jvm-metaspace.size&apos;&lt;/span&gt; configuration option should be increased. If the error persists (usually in cluster after several job (re-)submissions) then there is probably a &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loading leak in user code or some of its dependencies which has to be investigated and fixed. The task executor has to be shutdown...
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.defineClass1(Native Method) ~[?:?]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.defineClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:1017) ~[?:?]
        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:174) ~[?:?]
        at java.net.URLClassLoader.defineClass(URLClassLoader.java:550) ~[?:?]
        at java.net.URLClassLoader$1.run(URLClassLoader.java:458) ~[?:?]
        at java.net.URLClassLoader$1.run(URLClassLoader.java:452) ~[?:?]
        at java.security.AccessController.doPrivileged(Native Method) ~[?:?]
        at java.net.URLClassLoader.findClass(URLClassLoader.java:451) ~[?:?]
        at org.apache.flink.util.ChildFirstClassLoader.loadClassWithoutExceptionHandling(ChildFirstClassLoader.java:71) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
        at org.apache.flink.util.FlinkUserCodeClassLoader.loadClass(FlinkUserCodeClassLoader.java:48) [flink-dist_2.12-1.11.0.jar:1.11.0]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:522) [?:?
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;]&lt;/p&gt;</comment>
                            <comment id="17239008" author="zhongwei" created="Thu, 26 Nov 2020 02:05:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=f.pompermaier&quot; class=&quot;user-hover&quot; rel=&quot;f.pompermaier&quot;&gt;f.pompermaier&lt;/a&gt;, as the `org.apache.flink.streaming.runtime.tasks.StreamTask` also implements the `finalize()` method,&#160;this problem will&#160;affect the normal java jobs which load user code into the flink runtime.&#160;&lt;/p&gt;</comment>
                            <comment id="17414278" author="pd17" created="Mon, 13 Sep 2021 15:58:11 +0000"  >&lt;p&gt;Hi, Is this issue resolved for java client... Asking this because in prod task manager with 256Mb jvm metaspace... i am getting metaspace OOM by deploying 4-5 jobs on single task manager irrespective of their parallelism. I am using flink 1.12.0 version. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dian.fu&quot; class=&quot;user-hover&quot; rel=&quot;dian.fu&quot;&gt;dian.fu&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17414698" author="dianfu" created="Tue, 14 Sep 2021 03:55:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pd17&quot; class=&quot;user-hover&quot; rel=&quot;pd17&quot;&gt;pd17&lt;/a&gt; What do you mean by &quot;java client&quot;?&lt;/p&gt;</comment>
                            <comment id="17414723" author="pd17" created="Tue, 14 Sep 2021 05:15:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dianfu&quot; class=&quot;user-hover&quot; rel=&quot;dianfu&quot;&gt;dianfu&lt;/a&gt;&#160;So what i meant was that in my case i am writing flink udf in java (Java Jobs) and using flink-core 1.12.0 maven dependency. And i am facing metaspace OOM on redeployment of jobs on a single task manager. Just wanted to know if this is a common and open issue or has it been resolved&lt;/p&gt;</comment>
                            <comment id="17414734" author="dianfu" created="Tue, 14 Sep 2021 05:46:06 +0000"  >&lt;p&gt;I think it also depends on how you handle the jars (not only the UDF jars, but also connector jars, etc), e.g. whether placing them in the lib directory which are loaded by the context class loader or submitted using pipeline.jars/pipeline.classpaths which are loaded by the user class loader. Could you try to place the jars in the lib directory and see if the issue still exists?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kwuo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>