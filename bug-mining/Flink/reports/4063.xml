<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:46:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-17350] StreamTask should always fail immediately on failures in synchronous part of a checkpoint</title>
                <link>https://issues.apache.org/jira/browse/FLINK-17350</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;This bugs also Affects 1.5.x branch.&lt;/p&gt;

&lt;p&gt;As described in point 1 here: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17327?focusedCommentId=17090576&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17090576&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-17327?focusedCommentId=17090576&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17090576&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;setTolerableCheckpointFailureNumber(...)&lt;/tt&gt; and its deprecated &lt;tt&gt;setFailTaskOnCheckpointError(...)&lt;/tt&gt; predecessor are implemented incorrectly. Since Flink 1.5 (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4809&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-4809&lt;/a&gt;) they can lead to operators (and especially sinks with an external state) end up in an inconsistent state. That&apos;s also true even if they are not used, because of another issue: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17351&quot; title=&quot;CheckpointCoordinator and CheckpointFailureManager ignores checkpoint timeouts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17351&quot;&gt;&lt;del&gt;FLINK-17351&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If we mix this with intermittent external system failure. Sink reports an exception, transaction was lost/aborted, Sink is in failed state, but if there will be a happy coincidence that it manages to accept further records, this exception can be lost and all of the records in those failed checkpoints will be lost forever as well.&lt;/p&gt;

&lt;p&gt;For details please check &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17327&quot; title=&quot;Kafka unavailability could cause Flink TM shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17327&quot;&gt;&lt;del&gt;FLINK-17327&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13300558">FLINK-17350</key>
            <summary>StreamTask should always fail immediately on failures in synchronous part of a checkpoint</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 23 Apr 2020 12:49:55 +0000</created>
                <updated>Fri, 16 Oct 2020 10:32:14 +0000</updated>
                            <resolved>Sat, 16 May 2020 08:12:41 +0000</resolved>
                                    <version>1.6.4</version>
                    <version>1.7.2</version>
                    <version>1.8.3</version>
                    <version>1.9.2</version>
                    <version>1.10.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17090608" author="pnowojski" created="Thu, 23 Apr 2020 13:18:02 +0000"  >&lt;p&gt;There are two potential solutions. &lt;/p&gt;

&lt;p&gt;Option I.&lt;/p&gt;

&lt;p&gt;We should just fail the task immediately on any failure in synchronous checkpoint part as we did before &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4809&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-4809&lt;/a&gt; . This also includes failures in &lt;tt&gt;notifyCheckpointCompleted&lt;/tt&gt; calls. &lt;/p&gt;

&lt;p&gt;Option II.&lt;/p&gt;

&lt;p&gt;If we want to keep the &lt;tt&gt;setTolerableCheckpointFailureNumber(...)&lt;/tt&gt; for synchronous failures, as some operators may be able to tolerate snapshot/committing failures, It would have to be implemented inside operators:&lt;br/&gt;
FlinkKafkaProducer would have to remember an exception and keep re-throwing it, or throw &quot;Rejecting writes because of a previous failure&quot;. Or provide some API (interface? getter boolean canTolerateCheckpointingFailure()? wrapping an exception with FlinkAbortCheckpointException(...) and tolerate failures of only exception type?) for StreamTask to detect if operator can recover from checkpoint failures or not and implement this logic somewhere in the StreamTask/OperatorChain/OperatorWrapper&lt;/p&gt;

&lt;p&gt;I&apos;m strongly in favour of Option I, as it&apos;s much simpler and Option II doesn&apos;t seem to be adding much value and would require support from the operators side.&lt;/p&gt;

&lt;p&gt;Asynchronous failures are acceptable, as the in-memory state of operators/functions is kept consistent, just waiting for &lt;tt&gt;notifyCheckpointCompleted&lt;/tt&gt; call, so from the operators&apos; perspective, ignoring asynchronous failure of Checkpoint N and successfully completing Checkpoint N+1 is indistinguishable from &lt;tt&gt;notifyCheckpointCompleted&lt;/tt&gt; for Checkpoint N being lost in transit - which is a valid and correctly handled scenario by our exactly once sinks.&lt;/p&gt;</comment>
                            <comment id="17108911" author="pnowojski" created="Sat, 16 May 2020 08:12:41 +0000"  >&lt;p&gt;Merged to master as 74e3d9f8bb..8ea458137e&lt;/p&gt;

&lt;p&gt;I&apos;m reluctant to back port this fix, as:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;it&apos;s changing behaviour of checkpointing failures&lt;/li&gt;
	&lt;li&gt;most likely this bug is only visible for operators with external state (like exactly-once sinks)&lt;/li&gt;
	&lt;li&gt;our kafka sink was only theoretically affected by this - practically despite ignoring the failure, sink wouldn&apos;t recover and would start throwing some timeout exceptions eventually&lt;/li&gt;
	&lt;li&gt;it&apos;s not trivial to back port the fix, as the relevant code has been changing over the time&lt;/li&gt;
&lt;/ol&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13300291">FLINK-17327</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13011614">FLINK-4809</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13300559">FLINK-17351</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 26 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dzw8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Failures in synchronous part of checkpointing (like an exceptions thrown by an operator) will fail it&amp;#39;s Task (and job) immediately, regardless of the configuration parameters. Since Flink 1.5 such failures could be ignored by setting `setTolerableCheckpointFailureNumber(...)` or its deprecated `setFailTaskOnCheckpointError(...)` predecessor. Now both options will only affect asynchronous failures.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>