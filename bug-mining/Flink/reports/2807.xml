<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:38:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10482] java.lang.IllegalArgumentException: Negative number of in progress checkpoints</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10482</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Recently I found the following log on my JobManager log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018-10-02 17:44:50,090 [flink-akka.actor.default-dispatcher-4117] ERROR org.apache.flink.runtime.rest.handler.job.JobDetailsHandler&#160; - Implementation error: Unhandled exception.
 java.lang.IllegalArgumentException: Negative number of in progress checkpoints
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.util.Preconditions.checkArgument(Preconditions.java:139)
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.checkpoint.CheckpointStatsCounts.&amp;lt;init&amp;gt;(CheckpointStatsCounts.java:72)
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.checkpoint.CheckpointStatsCounts.createSnapshot(CheckpointStatsCounts.java:177)
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.checkpoint.CheckpointStatsTracker.createSnapshot(CheckpointStatsTracker.java:166)
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.executiongraph.ExecutionGraph.getCheckpointStatsSnapshot(ExecutionGraph.java:553)
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.executiongraph.ArchivedExecutionGraph.createFrom(ArchivedExecutionGraph.java:340)
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.jobmaster.JobMaster.requestJob(JobMaster.java:923)
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at sun.reflect.GeneratedMethodAccessor101.invoke(Unknown Source)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.lang.reflect.Method.invoke(Method.java:498)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcInvocation(AkkaRpcActor.java:247)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:162)
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleRpcMessage(FencedAkkaRpcActor.java:70)
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.onReceive(AkkaRpcActor.java:142)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.onReceive(FencedAkkaRpcActor.java:40)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at akka.actor.UntypedActor$$anonfun$receive$1.applyOrElse(UntypedActor.scala:165)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at akka.actor.Actor$class.aroundReceive(Actor.scala:502)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at akka.actor.UntypedActor.aroundReceive(UntypedActor.scala:95)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at akka.actor.ActorCell.receiveMessage(ActorCell.scala:526)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at akka.actor.ActorCell.invoke(ActorCell.scala:495)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:257)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at akka.dispatch.Mailbox.run(Mailbox.scala:224)&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at akka.dispatch.Mailbox.exec(Mailbox.scala:234)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)&#160;&#160;&#160;&#160;&#160; &#160;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Related: The job details don&apos;t appear, the screen shows only the skeleton, but no information (like the pipeline, substasks, etc).&lt;/p&gt;

&lt;p&gt;One thing that may have caused this is that the job was failing &#8211; an uncaught exception on our code &#8211; and, during one of its restarts, I issued a &quot;flink cancel &amp;lt;jobid&amp;gt;&quot;. The job was cancelled, but the JobManager interface took a very long time to put the slots as available again.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13188934">FLINK-10482</key>
            <summary>java.lang.IllegalArgumentException: Negative number of in progress checkpoints</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="azagrebin">Andrey Zagrebin</assignee>
                                    <reporter username="JBiason">Julio Biason</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 2 Oct 2018 17:49:21 +0000</created>
                <updated>Fri, 7 Dec 2018 10:46:08 +0000</updated>
                            <resolved>Fri, 7 Dec 2018 10:45:03 +0000</resolved>
                                    <version>1.6.1</version>
                                    <fixVersion>1.5.6</fixVersion>
                    <fixVersion>1.6.3</fixVersion>
                    <fixVersion>1.7.1</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16637875" author="till.rohrmann" created="Thu, 4 Oct 2018 07:13:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=GJL&quot; class=&quot;user-hover&quot; rel=&quot;GJL&quot;&gt;GJL&lt;/a&gt; could this one be related to your recent findings?&lt;/p&gt;</comment>
                            <comment id="16656892" author="gjy" created="Fri, 19 Oct 2018 14:54:41 +0000"  >&lt;p&gt;While working on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10309&quot; title=&quot;Cancel with savepoint fails with java.net.ConnectException when using the per job-mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10309&quot;&gt;&lt;del&gt;FLINK-10309&lt;/del&gt;&lt;/a&gt;, I discovered &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10615&quot; title=&quot;Cancel with savepoint can fail the job&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10615&quot;&gt;&lt;del&gt;FLINK-10615&lt;/del&gt;&lt;/a&gt;, which can also cause the issue described here. If I recall correctly, the reason is that a pending checkpoint may be &lt;a href=&quot;https://github.com/apache/flink/blob/d2480af40f5145d865196a95ec58a415482d8cff/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/PendingCheckpoint.java#L512&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;aborted multiple times&lt;/a&gt;, which messes up the statistics.&lt;/p&gt;</comment>
                            <comment id="16681680" author="azagrebin" created="Fri, 9 Nov 2018 16:39:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JBiason&quot; class=&quot;user-hover&quot; rel=&quot;JBiason&quot;&gt;JBiason&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;do you still have the full log? can you post it here?&lt;br/&gt;
do you see there something like this:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Incremented the completed number of checkpoints without incrementing the in progress checkpoints before.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;?&lt;/p&gt;</comment>
                            <comment id="16688527" author="githubbot" created="Thu, 15 Nov 2018 19:08:08 +0000"  >&lt;p&gt;azagrebin opened a new pull request #7118: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10482&quot; title=&quot;java.lang.IllegalArgumentException: Negative number of in progress checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10482&quot;&gt;&lt;del&gt;FLINK-10482&lt;/del&gt;&lt;/a&gt; Fix double counting of checkpoint stat&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7118&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This PR fixes double counting of checkpoints in progress in their statistics.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If savepoint fails, restart checkpoint coordinator only if job is still running (prevents from double stop of checkpoint coordinator in case of global failure)&lt;/li&gt;
	&lt;li&gt;clear pending checkpoint in checkpoint coordinator stop method before aborting them (prevents from double aborting them if stop is called inside abort)&lt;/li&gt;
	&lt;li&gt;log error if number of checkpoints in progress is negative but do not throw exception and do not fail the job (prevents stats bugs from failing the job)&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   submit DataStreamAllroundTestProgram in a loop in aws emr, wait for failure, check there was no negative number of checkpoints logs&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16708889" author="githubbot" created="Tue, 4 Dec 2018 15:42:00 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7118: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10482&quot; title=&quot;java.lang.IllegalArgumentException: Negative number of in progress checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10482&quot;&gt;&lt;del&gt;FLINK-10482&lt;/del&gt;&lt;/a&gt; Fix double counting of checkpoint stat&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7118#discussion_r238705914&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7118#discussion_r238705914&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCounts.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -181,4 +183,15 @@ CheckpointStatsCounts createSnapshot() &lt;/p&gt;
{
 			numCompletedCheckpoints,
 			numFailedCheckpoints);
 	}
&lt;p&gt;+&lt;br/&gt;
+	private boolean assertDecrementOfInProgressCheckpointsNumber() {&lt;br/&gt;
+		boolean decrementLeadsToNegativeNumber = numInProgressCheckpoints - 1 &amp;lt; 0;&lt;br/&gt;
+		if (decrementLeadsToNegativeNumber) {&lt;br/&gt;
+			String errorMessage = &quot;Incremented the completed number of checkpoints &quot; +&lt;br/&gt;
+				&quot;without incrementing the in progress checkpoints before.&quot;;&lt;br/&gt;
+			LOG.warn(errorMessage);&lt;br/&gt;
+			LOG.debug(&quot;Inconsistent CheckpointStatsCounts&quot;, new IllegalStateException(errorMessage));&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Let&apos;s remove this logging statement.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16708891" author="githubbot" created="Tue, 4 Dec 2018 15:42:00 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7118: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10482&quot; title=&quot;java.lang.IllegalArgumentException: Negative number of in progress checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10482&quot;&gt;&lt;del&gt;FLINK-10482&lt;/del&gt;&lt;/a&gt; Fix double counting of checkpoint stat&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7118#discussion_r238709753&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7118#discussion_r238709753&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -970,7 +970,7 @@ public void heartbeatFromResourceManager(final ResourceID resourceID) &lt;/p&gt;
{
 				return path;
 			}
&lt;p&gt;, getMainThreadExecutor())&lt;br/&gt;
 			.exceptionally(throwable -&amp;gt; {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (cancelJob) {&lt;br/&gt;
+				if (cancelJob &amp;amp;&amp;amp; executionGraph.getState() == JobStatus.RUNNING) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   What situation are we filtering out with this change?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16708892" author="githubbot" created="Tue, 4 Dec 2018 15:42:00 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7118: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10482&quot; title=&quot;java.lang.IllegalArgumentException: Negative number of in progress checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10482&quot;&gt;&lt;del&gt;FLINK-10482&lt;/del&gt;&lt;/a&gt; Fix double counting of checkpoint stat&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7118#discussion_r238715678&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7118#discussion_r238715678&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1195,11 +1196,16 @@ public void stopCheckpointScheduler() &lt;/p&gt;
{
 				currentPeriodicTrigger = null;
 			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (PendingCheckpoint p : pendingCheckpoints.values()) {&lt;br/&gt;
+			// take a snapshot of pendingCheckpoints to clear them and prevent aborting them twice&lt;br/&gt;
+			// in case of subsequent call of stopCheckpointScheduler()&lt;br/&gt;
+			List&amp;lt;PendingCheckpoint&amp;gt; pendingCheckpointsSnapshot =&lt;br/&gt;
+				new ArrayList&amp;lt;&amp;gt;(pendingCheckpoints.values());&lt;br/&gt;
+			pendingCheckpoints.clear();&lt;br/&gt;
+&lt;br/&gt;
+			for (PendingCheckpoint p : pendingCheckpointsSnapshot) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Just as a note, I guess we could have solved the problem also by changing `JobMaster.java:965-975` into a `handleAsync` part because the problem seems to be that by aborting a `PendingCheckpoint` we fail the savepoint future which is then directly triggers the execution of the `exceptionally` handler. By decoupling the `exceptionally` handler from the `stopCheckpointScheduler` call, there should not be any concurrency problem.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16708893" author="githubbot" created="Tue, 4 Dec 2018 15:42:01 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7118: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10482&quot; title=&quot;java.lang.IllegalArgumentException: Negative number of in progress checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10482&quot;&gt;&lt;del&gt;FLINK-10482&lt;/del&gt;&lt;/a&gt; Fix double counting of checkpoint stat&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7118#discussion_r238705456&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7118#discussion_r238705456&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCounts.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -181,4 +183,15 @@ CheckpointStatsCounts createSnapshot() &lt;/p&gt;
{
 			numCompletedCheckpoints,
 			numFailedCheckpoints);
 	}
&lt;p&gt;+&lt;br/&gt;
+	private boolean assertDecrementOfInProgressCheckpointsNumber() {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   maybe rename method into `canDecrementOfInProgressCheckpointsNumber`.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16708906" author="githubbot" created="Tue, 4 Dec 2018 15:51:49 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #7118: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10482&quot; title=&quot;java.lang.IllegalArgumentException: Negative number of in progress checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10482&quot;&gt;&lt;del&gt;FLINK-10482&lt;/del&gt;&lt;/a&gt; Fix double counting of checkpoint stat&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7118#discussion_r238720755&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7118#discussion_r238720755&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCounts.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -181,4 +183,15 @@ CheckpointStatsCounts createSnapshot() &lt;/p&gt;
{
 			numCompletedCheckpoints,
 			numFailedCheckpoints);
 	}
&lt;p&gt;+&lt;br/&gt;
+	private boolean assertDecrementOfInProgressCheckpointsNumber() {&lt;br/&gt;
+		boolean decrementLeadsToNegativeNumber = numInProgressCheckpoints - 1 &amp;lt; 0;&lt;br/&gt;
+		if (decrementLeadsToNegativeNumber) {&lt;br/&gt;
+			String errorMessage = &quot;Incremented the completed number of checkpoints &quot; +&lt;br/&gt;
+				&quot;without incrementing the in progress checkpoints before.&quot;;&lt;br/&gt;
+			LOG.warn(errorMessage);&lt;br/&gt;
+			LOG.debug(&quot;Inconsistent CheckpointStatsCounts&quot;, new IllegalStateException(errorMessage));&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   thanks, debugging leftover&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16710221" author="githubbot" created="Wed, 5 Dec 2018 15:21:02 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #7118: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10482&quot; title=&quot;java.lang.IllegalArgumentException: Negative number of in progress checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10482&quot;&gt;&lt;del&gt;FLINK-10482&lt;/del&gt;&lt;/a&gt; Fix double counting of checkpoint stat&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7118#discussion_r239108282&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7118#discussion_r239108282&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1195,11 +1196,16 @@ public void stopCheckpointScheduler() &lt;/p&gt;
{
 				currentPeriodicTrigger = null;
 			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (PendingCheckpoint p : pendingCheckpoints.values()) {&lt;br/&gt;
+			// take a snapshot of pendingCheckpoints to clear them and prevent aborting them twice&lt;br/&gt;
+			// in case of subsequent call of stopCheckpointScheduler()&lt;br/&gt;
+			List&amp;lt;PendingCheckpoint&amp;gt; pendingCheckpointsSnapshot =&lt;br/&gt;
+				new ArrayList&amp;lt;&amp;gt;(pendingCheckpoints.values());&lt;br/&gt;
+			pendingCheckpoints.clear();&lt;br/&gt;
+&lt;br/&gt;
+			for (PendingCheckpoint p : pendingCheckpointsSnapshot) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Agree, this fix will solve the original problem without other changes.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16710357" author="githubbot" created="Wed, 5 Dec 2018 17:09:59 +0000"  >&lt;p&gt;azagrebin commented on issue #7118: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10482&quot; title=&quot;java.lang.IllegalArgumentException: Negative number of in progress checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10482&quot;&gt;&lt;del&gt;FLINK-10482&lt;/del&gt;&lt;/a&gt; Fix double counting of checkpoint stat&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7118#issuecomment-444564761&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7118#issuecomment-444564761&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thank you for the review @tillrohrmann ! I addressed the comments.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16712640" author="till.rohrmann" created="Fri, 7 Dec 2018 10:45:03 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
1.8.0: 114cb2cabe5a2c236f02089675a57ec44bb1e4bd&lt;br/&gt;
1.7.1: f19bc72e910615a4d122f2fe3777fde6774bc001&lt;br/&gt;
1.6.3: 0664e02cad06a4494293e5f350554f1c1279d936&lt;br/&gt;
1.5.6: ddbef1be626a60d2d9a6c7c162c806a5d2953818&lt;/p&gt;</comment>
                            <comment id="16712643" author="githubbot" created="Fri, 7 Dec 2018 10:46:08 +0000"  >&lt;p&gt;tillrohrmann commented on issue #7118: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10482&quot; title=&quot;java.lang.IllegalArgumentException: Negative number of in progress checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10482&quot;&gt;&lt;del&gt;FLINK-10482&lt;/del&gt;&lt;/a&gt; Fix double counting of checkpoint stat&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7118#issuecomment-445194513&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7118#issuecomment-445194513&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Manually merged.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16712644" author="githubbot" created="Fri, 7 Dec 2018 10:46:08 +0000"  >&lt;p&gt;tillrohrmann closed pull request #7118: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10482&quot; title=&quot;java.lang.IllegalArgumentException: Negative number of in progress checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10482&quot;&gt;&lt;del&gt;FLINK-10482&lt;/del&gt;&lt;/a&gt; Fix double counting of checkpoint stat&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7118&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCounts.java b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCounts.java&lt;br/&gt;
index dad45eb669c..9e15aebd048 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCounts.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCounts.java&lt;br/&gt;
@@ -18,6 +18,9 @@&lt;/p&gt;

&lt;p&gt; package org.apache.flink.runtime.checkpoint;&lt;/p&gt;

&lt;p&gt;+import org.slf4j.Logger;&lt;br/&gt;
+import org.slf4j.LoggerFactory;&lt;br/&gt;
+&lt;br/&gt;
 import java.io.Serializable;&lt;/p&gt;

&lt;p&gt; import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
@@ -26,6 +29,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Counts of checkpoints.&lt;br/&gt;
  */&lt;br/&gt;
 public class CheckpointStatsCounts implements Serializable {&lt;br/&gt;
+	private static final Logger LOG = LoggerFactory.getLogger(CheckpointStatsCounts.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	private static final long serialVersionUID = -5229425063269482528L;&lt;/p&gt;

&lt;p&gt;@@ -147,9 +151,8 @@ void incrementInProgressCheckpoints() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;{@link #incrementInProgressCheckpoints()}.&lt;br/&gt;
 	 */&lt;br/&gt;
 	void incrementCompletedCheckpoints() {&lt;br/&gt;
-		if (--numInProgressCheckpoints &amp;lt; 0) {&lt;br/&gt;
-			throw new IllegalStateException(&quot;Incremented the completed number of checkpoints &quot; +&lt;br/&gt;
-				&quot;without incrementing the in progress checkpoints before.&quot;);&lt;br/&gt;
+		if (canDecrementOfInProgressCheckpointsNumber()) {
+			numInProgressCheckpoints--;
 		}&lt;br/&gt;
 		numCompletedCheckpoints++;&lt;br/&gt;
 	}&lt;br/&gt;
@@ -161,9 +164,8 @@ void incrementCompletedCheckpoints() {&lt;br/&gt;
 	 * {@link #incrementInProgressCheckpoints()}
&lt;p&gt;.&lt;br/&gt;
 	 */&lt;br/&gt;
 	void incrementFailedCheckpoints() {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (--numInProgressCheckpoints &amp;lt; 0) {&lt;/li&gt;
	&lt;li&gt;throw new IllegalStateException(&quot;Incremented the completed number of checkpoints &quot; +&lt;/li&gt;
	&lt;li&gt;&quot;without incrementing the in progress checkpoints before.&quot;);&lt;br/&gt;
+		if (canDecrementOfInProgressCheckpointsNumber()) 
{
+			numInProgressCheckpoints--;
 		}
&lt;p&gt; 		numFailedCheckpoints++;&lt;br/&gt;
 	}&lt;br/&gt;
@@ -181,4 +183,14 @@ CheckpointStatsCounts createSnapshot() &lt;/p&gt;
{
 			numCompletedCheckpoints,
 			numFailedCheckpoints);
 	}
&lt;p&gt;+&lt;br/&gt;
+	private boolean canDecrementOfInProgressCheckpointsNumber() &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+		boolean decrementLeadsToNegativeNumber = numInProgressCheckpoints - 1 &amp;lt; 0;+		if (decrementLeadsToNegativeNumber) {
+			String errorMessage = &quot;Incremented the completed number of checkpoints &quot; +
+				&quot;without incrementing the in progress checkpoints before.&quot;;
+			LOG.warn(errorMessage);
+		}+		return !decrementLeadsToNegativeNumber;+	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; }&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
index 5d2d363cf71..54c14af8983 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java&lt;br/&gt;
@@ -962,19 +962,18 @@ public void heartbeatFromResourceManager(final ResourceID resourceID) {&lt;br/&gt;
 		return checkpointCoordinator&lt;br/&gt;
 			.triggerSavepoint(System.currentTimeMillis(), targetDirectory)&lt;br/&gt;
 			.thenApply(CompletedCheckpoint::getExternalPointer)&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;.thenApplyAsync(path -&amp;gt; {&lt;/li&gt;
	&lt;li&gt;if (cancelJob) {&lt;br/&gt;
+			.handleAsync((path, throwable) -&amp;gt; {&lt;br/&gt;
+				if (throwable != null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+					if (cancelJob) {
+						startCheckpointScheduler(checkpointCoordinator);
+					}+					throw new CompletionException(throwable);+				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else if (cancelJob) {&lt;br/&gt;
 					log.info(&quot;Savepoint stored in {}. Now cancelling {}.&quot;, path, jobGraph.getJobID());&lt;br/&gt;
 					cancel(timeout);&lt;br/&gt;
 				}&lt;br/&gt;
 				return path;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;}, getMainThreadExecutor())&lt;/li&gt;
	&lt;li&gt;.exceptionally(throwable -&amp;gt; {&lt;/li&gt;
	&lt;li&gt;if (cancelJob) 
{
-					startCheckpointScheduler(checkpointCoordinator);
-				}&lt;/li&gt;
	&lt;li&gt;throw new CompletionException(throwable);&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
+			}, getMainThreadExecutor());&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	private void startCheckpointScheduler(final CheckpointCoordinator checkpointCoordinator) {&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCountsTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCountsTest.java&lt;br/&gt;
index cf1e7f7f82d..2d09b46464f 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCountsTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/CheckpointStatsCountsTest.java&lt;br/&gt;
@@ -21,15 +21,16 @@&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt; import static org.junit.Assert.assertEquals;&lt;br/&gt;
-import static org.junit.Assert.fail;&lt;br/&gt;
+import static org.junit.Assert.assertTrue;&lt;/p&gt;

&lt;p&gt;+/** Test checkpoint statistics counters. */&lt;br/&gt;
 public class CheckpointStatsCountsTest {&lt;/p&gt;

&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests that counts are reported correctly.&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Test&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void testCounts() throws Exception {&lt;br/&gt;
+	public void testCounts() {&lt;br/&gt;
 		CheckpointStatsCounts counts = new CheckpointStatsCounts();&lt;br/&gt;
 		assertEquals(0, counts.getNumberOfRestoredCheckpoints());&lt;br/&gt;
 		assertEquals(0, counts.getTotalNumberOfCheckpoints());&lt;br/&gt;
@@ -80,19 +81,15 @@ public void testCounts() throws Exception {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;incrementing the in progress checkpoints before throws an Exception.&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Test&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void testCompleteOrFailWithoutInProgressCheckpoint() throws Exception {&lt;br/&gt;
+	public void testCompleteOrFailWithoutInProgressCheckpoint() {&lt;br/&gt;
 		CheckpointStatsCounts counts = new CheckpointStatsCounts();&lt;/li&gt;
	&lt;li&gt;try 
{
-			counts.incrementCompletedCheckpoints();
-			fail(&quot;Did not throw expected Exception&quot;);
-		}
&lt;p&gt; catch (IllegalStateException ignored) &lt;/p&gt;
{
-		}&lt;br/&gt;
-&lt;br/&gt;
-		try {
-			counts.incrementFailedCheckpoints();
-			fail(&quot;Did not throw expected Exception&quot;);
-		} catch (IllegalStateException ignored) {-		}
&lt;p&gt;+		counts.incrementCompletedCheckpoints();&lt;br/&gt;
+		assertTrue(&quot;Number of checkpoints in progress should never be negative&quot;,&lt;br/&gt;
+			counts.getNumberOfInProgressCheckpoints() &amp;gt;= 0);&lt;br/&gt;
+&lt;br/&gt;
+		counts.incrementFailedCheckpoints();&lt;br/&gt;
+		assertTrue(&quot;Number of checkpoints in progress should never be negative&quot;,&lt;br/&gt;
+			counts.getNumberOfInProgressCheckpoints() &amp;gt;= 0);&lt;br/&gt;
 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;br/&gt;
@@ -100,7 +97,7 @@ public void testCompleteOrFailWithoutInProgressCheckpoint() throws Exception {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;parent.&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Test&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void testCreateSnapshot() throws Exception {&lt;br/&gt;
+	public void testCreateSnapshot() {&lt;br/&gt;
 		CheckpointStatsCounts counts = new CheckpointStatsCounts();&lt;br/&gt;
 		counts.incrementRestoredCheckpoints();&lt;br/&gt;
 		counts.incrementRestoredCheckpoints();&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13192862">FLINK-10615</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3yqw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>