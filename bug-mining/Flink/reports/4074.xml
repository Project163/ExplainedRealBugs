<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:46:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-15758] Investigate potential out-of-memory problems due to managed unsafe memory allocation</title>
                <link>https://issues.apache.org/jira/browse/FLINK-15758</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;After&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13985&quot; title=&quot;Use unsafe memory for managed memory.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13985&quot;&gt;&lt;del&gt;FLINK-13985&lt;/del&gt;&lt;/a&gt;, managed memory is allocated from UNSAFE, not as direct nio buffers as before 1.10.&lt;/p&gt;

&lt;p&gt;in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14894&quot; title=&quot;HybridOffHeapUnsafeMemorySegmentTest#testByteBufferWrap failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14894&quot;&gt;&lt;del&gt;FLINK-14894&lt;/del&gt;&lt;/a&gt;, there was an attempt to release this memory only when all Java handles of the unsafe memory are about to be GC&apos;ed. It is similar to how it was with&#160;direct nio buffers before 1.10 but the unsafe memory is not tracked by direct memory limit (-XX:MaxDirectMemorySize). The problem is that over-allocating of unsafe memory will not hit the direct limit and will not cause GC immediately which will be the only way to release it. In this case, it causes out-of-memory failures w/o triggering GC to release a lot of potentially already unused memory.&lt;/p&gt;

&lt;p&gt;We have to investigate further optimisations, like:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;directly monitoring phantom reference queue of the cleaner (if JVM detects quickly that there are no more reference to the memory) and explicitly release memory ready for GC asap, e.g. after Task exit&lt;/li&gt;
	&lt;li&gt;monitor allocated memory amount and block allocation until GC releases occupied memory instead of failing with&#160;out-of-memory&#160;immediately&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13281453">FLINK-15758</key>
            <summary>Investigate potential out-of-memory problems due to managed unsafe memory allocation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="azagrebin">Andrey Zagrebin</assignee>
                                    <reporter username="azagrebin">Andrey Zagrebin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 24 Jan 2020 18:20:08 +0000</created>
                <updated>Wed, 27 Jan 2021 06:46:36 +0000</updated>
                            <resolved>Tue, 19 May 2020 07:47:41 +0000</resolved>
                                                    <fixVersion>1.10.2</fixVersion>
                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="17024400" author="till.rohrmann" created="Mon, 27 Jan 2020 15:00:09 +0000"  >&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14894?focusedCommentId=17024394&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17024394&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-14894?focusedCommentId=17024394&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17024394&lt;/a&gt; says there is indeed a problem with higher memory pressure if the fix of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14894&quot; title=&quot;HybridOffHeapUnsafeMemorySegmentTest#testByteBufferWrap failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14894&quot;&gt;&lt;del&gt;FLINK-14894&lt;/del&gt;&lt;/a&gt; is applied. We reverted this fix momentarily and need to properly fix this problem by monitoring the unsafe memory usage and trigger a clean if required.&lt;/p&gt;</comment>
                            <comment id="17026626" author="azagrebin" created="Thu, 30 Jan 2020 12:03:06 +0000"  >&lt;p&gt;After looking more into this topic, the problem could be resolved with the following step:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Simply MemoryManager by removing KeyedBudgetManager as the managed memory is only on-heap now&lt;/li&gt;
	&lt;li&gt;Implement custom unsafe memory control,&#160;similar to what JVM does to control direct memory limit:
	&lt;ul&gt;
		&lt;li&gt;Use AtomicLong to control allocated memory and optimistic allocation retry (like in nio.Bits#tryReserveMemory)&lt;/li&gt;
		&lt;li&gt;Try to speed up running GC phantom ref cleaners with&#160;SharedSecrets.getJavaLangRefAccess and fallback to full GC if allocation fails before trowing OutOfMemoryError (like in nio.Bits#reserveMemory)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The last step will require wrapping of&#160;JavaLangRefAccess logic with the reflection calls as it was relocated in Java 9 and the API has changed.&lt;/p&gt;</comment>
                            <comment id="17110942" author="azagrebin" created="Tue, 19 May 2020 07:47:41 +0000"  >&lt;p&gt;merged into master by 10c29b73fdbc2bcfe7cb6f9394ad8db7836041c3&lt;br/&gt;
merged into 1.10 by 2a4520935c8b546ac05f664f947d143b06322000&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13269832">FLINK-14894</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13337630">FLINK-19852</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13306044">FLINK-17822</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13318259">FLINK-18646</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13346693">FLINK-20663</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13255135">FLINK-13985</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0aueg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>