<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:38:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-11537] ExecutionGraph does not reach terminal state when JobMaster lost leadership</title>
                <link>https://issues.apache.org/jira/browse/FLINK-11537</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;ExecutionGraph&lt;/tt&gt; sometimes does not reach a terminal state if the &lt;tt&gt;JobMaster&lt;/tt&gt; lost the leadership. The reason is that we use the fenced main thread executor to execute &lt;tt&gt;ExecutionGraph&lt;/tt&gt; changes and we don&apos;t wait for the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; to reach the terminal state before we set the fencing token &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;One possible solution would be to wait for the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; to reach the terminal state before clearing the fencing token. This has, however, the downside that the &lt;tt&gt;JobMaster&lt;/tt&gt; is still reachable until the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; has been properly terminated. Alternatively, we could use the unfenced main thread executor to send the cancel calls out.&lt;/p&gt;

&lt;p&gt;A Travis run where the problem occurred is here: &lt;a href=&quot;https://travis-ci.org/tillrohrmann/flink/jobs/489119926&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/tillrohrmann/flink/jobs/489119926&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Update: The underlying problem is that &lt;tt&gt;ExecutionGraph#suspend&lt;/tt&gt; does not transition the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; atomically into a terminal state. Changing this should solve the underlying problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13214119">FLINK-11537</key>
            <summary>ExecutionGraph does not reach terminal state when JobMaster lost leadership</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Feb 2019 09:45:52 +0000</created>
                <updated>Thu, 9 Apr 2020 16:32:45 +0000</updated>
                            <resolved>Wed, 20 Feb 2019 17:20:55 +0000</resolved>
                                    <version>1.8.0</version>
                                    <fixVersion>1.8.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16762483" author="uce" created="Thu, 7 Feb 2019 08:37:53 +0000"  >&lt;p&gt;Is this related to/a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10439?&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-10439?&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16764757" author="stephanewen" created="Mon, 11 Feb 2019 08:41:17 +0000"  >&lt;p&gt;This seems quite a fundamental thing which may warrant some more thoughts.&lt;/p&gt;

&lt;p&gt;Just a thought: we could, have fencing tokens for the execution graph and that never changes. When leadership is lost, the old executiongraph and its fencing token stay around. Gaining leadership builds a new execution graph with a new fencing token.&lt;/p&gt;</comment>
                            <comment id="16768040" author="till.rohrmann" created="Thu, 14 Feb 2019 09:45:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=uce&quot; class=&quot;user-hover&quot; rel=&quot;uce&quot;&gt;uce&lt;/a&gt; yes this seems to be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10439&quot; title=&quot;Race condition during job suspension&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10439&quot;&gt;&lt;del&gt;FLINK-10439&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I agree that this needs to work properly.&lt;/p&gt;

&lt;p&gt;Having multiple fencing tokens, one per &lt;tt&gt;ExecutionGraph&lt;/tt&gt;, is currently not supported by the &lt;tt&gt;FencedRpcEndpoint&lt;/tt&gt;. Since the &lt;tt&gt;updateTaskExecutionState&lt;/tt&gt; are sent from the &lt;tt&gt;TaskExecutor&lt;/tt&gt; to the &lt;tt&gt;JobMaster&lt;/tt&gt;, it is also hard to distinguish between messages dedicated for different &lt;tt&gt;ExecutionGraphs&lt;/tt&gt; on the &lt;tt&gt;AkkaRpcActor&lt;/tt&gt; level.&lt;/p&gt;

&lt;p&gt;I think waiting for the termination of the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; before giving up the leadership could work. Of course, the &lt;tt&gt;JobMaster&lt;/tt&gt; won&apos;t be able to regain leadership until he has completed the leadership revocation. That way it would also better reflect the lifecycle dependencies between the leadership of the &lt;tt&gt;JobMaster&lt;/tt&gt; and the lifetime of the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; --&amp;gt; the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; is bound to the leader session of the &lt;tt&gt;JobMaster&lt;/tt&gt; and we need to terminate the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; when ending the leader session.&lt;/p&gt;</comment>
                            <comment id="16768044" author="stephanewen" created="Thu, 14 Feb 2019 09:54:21 +0000"  >&lt;p&gt;I feel a bit uneasy about holding off releasing leadership.&lt;br/&gt;
Is that even something that can be delayed, won&apos;t ZK / etcd / consul simply assign another leader?&lt;/p&gt;

&lt;p&gt;What would speak against going directly to state &quot;SUSPENDED&quot;, skipping &quot;SUSPENDING&quot;. The ExecutionGraph fires out cancellation messages (or not, when we do JM reconciliation in the future).&lt;/p&gt;

&lt;p&gt;That&apos;s it, the TMs would cancel and the confirmation of the cancellation would be ignored (which should be fine).&lt;/p&gt;</comment>
                            <comment id="16768134" author="till.rohrmann" created="Thu, 14 Feb 2019 12:22:33 +0000"  >&lt;p&gt;Holding off releasing the leadership would only happen locally for the &lt;tt&gt;JobMaster&lt;/tt&gt; and not globally. In the meantime, ZK/etcd/consul will elect a new leader and if it should be the same &lt;tt&gt;JobMaster&lt;/tt&gt;, then it would not get the leadership until it has completed the leadership revocation.&lt;/p&gt;

&lt;p&gt;Similarly to &lt;tt&gt;JobStatus#CANCELLING&lt;/tt&gt;, &lt;tt&gt;JobStatus#SUSPENDING&lt;/tt&gt; has been introduced to reflect that suspending the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; in the current implementation entails a clean up phase where all &lt;tt&gt;Executions&lt;/tt&gt; will get canceled. Only after all &lt;tt&gt;Executions&lt;/tt&gt; have reached a terminal state, the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; will transition into the state &lt;tt&gt;SUSPENDED&lt;/tt&gt;. The idea behind this implementation was to properly bind the lifetime of a remote &lt;tt&gt;Task&lt;/tt&gt; to the lifetime of the &lt;tt&gt;ExecutionGraph&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;We can also change the implementation of &lt;tt&gt;ExecutionGraph#suspend&lt;/tt&gt; to transition the &lt;tt&gt;Executions&lt;/tt&gt; directly into a terminal state &lt;tt&gt;CANCELLED&lt;/tt&gt; instead of &lt;tt&gt;CANCELLING&lt;/tt&gt; and waiting for the state transition. I would consider this a slightly orthogonal issue though (e.g. make &lt;tt&gt;ExecutionGraph#suspend&lt;/tt&gt; atomically transition to terminal state) and still think that it would be worthwhile to wait until the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; reaches a terminal state before setting the &lt;tt&gt;JobMaster&apos;s&lt;/tt&gt; fencing token to &lt;tt&gt;null&lt;/tt&gt;. With a changed &lt;tt&gt;#suspend&lt;/tt&gt; behaviour the fencing token would then be nulled immediately.&lt;/p&gt;
</comment>
                            <comment id="16768138" author="stephanewen" created="Thu, 14 Feb 2019 12:30:14 +0000"  >&lt;p&gt;Suspending is not a clean form of shutdown (as cancelling attempts to be).&lt;br/&gt;
It also does not do most cleanup (it is not globally terminal).&lt;/p&gt;

&lt;p&gt;I think the problem comes from the following mismatch;&lt;br/&gt;
  1. The JM tries to transition the EG gracefully to cancellation as if it were still in change of graceful coordination&lt;br/&gt;
  2. The JM has lost authority over the execution in the first place&lt;/p&gt;

&lt;p&gt;I would break with behavior (1). The JM should not attempt graceful coordination. It can send out best effort cancellation (which should anyways be ignored by the TM if the TM has discovered a new leader already). The TM will cancel tasks anyways once it learns about the new leader.&lt;/p&gt;

&lt;p&gt;Trying to tweak (2) (the JM retains some form of leader authority) so that we can keep (1) (graceful cancellation) seems counter intuitive to me.&lt;/p&gt;</comment>
                            <comment id="16771788" author="till.rohrmann" created="Tue, 19 Feb 2019 10:07:24 +0000"  >&lt;p&gt;I agree that we should make the suspend operation atomically finish instead of requiring a round trip to collect the cancellation completions.&lt;/p&gt;</comment>
                            <comment id="16773215" author="till.rohrmann" created="Wed, 20 Feb 2019 17:20:55 +0000"  >&lt;p&gt;Fixed via c9e392b53b48c8ae0b189905a9b4cf878bf741e4&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13187609">FLINK-10439</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13187609">FLINK-10439</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 38 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi0pf4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>