<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9324] SingleLogicalSlot returns completed release future before slot is properly returned</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9324</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;SingleLogicalSlot#releaseSlot&lt;/tt&gt; method returns a future which is completed once the slot has been returned to the &lt;tt&gt;SlotOwner&lt;/tt&gt;. Unfortunately, we don&apos;t wait for the &lt;tt&gt;SlotOwner&apos;s&lt;/tt&gt; response to complete the future but complete it directly after the call has been made. This causes that the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; can get restarted in case of a recovery before all of its slots have been returned to the &lt;tt&gt;SlotPool&lt;/tt&gt;. As a consequence, the allocation of the new tasks might require more than the max parallelism because of collisions with old tasks (in case of slot sharing).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13158232">FLINK-9324</key>
            <summary>SingleLogicalSlot returns completed release future before slot is properly returned</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>flip-6</label>
                    </labels>
                <created>Wed, 9 May 2018 16:20:04 +0000</created>
                <updated>Thu, 10 May 2018 14:24:21 +0000</updated>
                            <resolved>Thu, 10 May 2018 14:24:21 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16469038" author="githubbot" created="Wed, 9 May 2018 16:30:23 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5980&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5980&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9324&quot; title=&quot;SingleLogicalSlot returns completed release future before slot is properly returned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9324&quot;&gt;&lt;del&gt;FLINK-9324&lt;/del&gt;&lt;/a&gt; Wait for slot release before completing release future in SingleLogicalSlot&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This commit properly waits for the completion of the SingleLogicalSlot&apos;s release future&lt;br/&gt;
    until the SlotOwner has acknowledged the release. That way the ExecutionGraph will only&lt;br/&gt;
    recover after all of its slots have been returned to the SlotPool.&lt;/p&gt;

&lt;p&gt;    As a side effect, the changes in this commit should reduce the number of redundant release&lt;br/&gt;
    calls sent to the SlotOwner which cluttered the debug logs.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Simplify `AllocatedSlot#Payload` interface&lt;/li&gt;
	&lt;li&gt;Don&apos;t require calls coming from the SlotPool to wait for the completion of the payload terminal state future before releasing the slot --&amp;gt; The idea is that the SlotPool knows when the slots on the TM are emptied. Therefore, we only need to fail the payload.&lt;/li&gt;
	&lt;li&gt;Properly wait for the `SlotOwner` to acknowledge the release of the slot&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added `SingleLogicalSlotTest`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; waitForSlotRelease&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5980.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5980.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5980&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 978e7ec2ca4d53f123c66ca01b65f24f905969c0&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-05-09T13:29:36Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9324&quot; title=&quot;SingleLogicalSlot returns completed release future before slot is properly returned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9324&quot;&gt;&lt;del&gt;FLINK-9324&lt;/del&gt;&lt;/a&gt; Wait for slot release before completing release future in SingleLogicalSlot&lt;/p&gt;

&lt;p&gt;    This commit properly waits for the completion of the SingleLogicalSlot&apos;s release future&lt;br/&gt;
    until the SlotOwner has acknowledged the release. That way the ExecutionGraph will only&lt;br/&gt;
    recover after all of its slots have been returned to the SlotPool.&lt;/p&gt;

&lt;p&gt;    As a side effect, the changes in this commit should reduce the number of redundant release&lt;br/&gt;
    calls sent to the SlotOwner which cluttered the debug logs.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16469585" author="githubbot" created="Wed, 9 May 2018 22:12:54 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5980#discussion_r187191338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5980#discussion_r187191338&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SingleLogicalSlot.java &amp;#8212;&lt;br/&gt;
    @@ -159,10 +159,51 @@ public SlotSharingGroupId getSlotSharingGroupId() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the logical slot.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;@param cause of the payload release&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @return true if the logical slot&apos;s payload could be released, otherwise false&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Override&lt;/li&gt;
	&lt;li&gt;public boolean release(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;return releaseSlot(cause).isDone();&lt;br/&gt;
    +	public void release(Throwable cause) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		if (STATE_UPDATER.compareAndSet(this, State.ALIVE, State.RELEASING)) {
    +			signalPayloadRelease(cause);
    +		}    +		state = State.RELEASED;    +		releaseFuture.complete(null);    +	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +	private CompletableFuture&amp;lt;?&amp;gt; signalPayloadRelease(Throwable cause) &lt;/p&gt;
{
    +		tryAssignPayload(TERMINATED_PAYLOAD);
    +		payload.fail(cause);
    +
    +		return payload.getTerminalStateFuture();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void returnSlotToOwner(CompletableFuture&amp;lt;?&amp;gt; terminalStateFuture) {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; slotReturnFuture = terminalStateFuture.handle((Object ignored, Throwable throwable) -&amp;gt; {&lt;br/&gt;
    +			if (state == State.RELEASING) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    What happens if this gets set concurrently to `RELEASED`? This would only work if `slotOwner.returnAllocatedSlot(this)` works in both cases (releasing and released) and the second path (returning the completed future) is the optimization/fast path if it is already released. (double checking the assumption).&lt;/p&gt;</comment>
                            <comment id="16469586" author="githubbot" created="Wed, 9 May 2018 22:12:54 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5980#discussion_r187189887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5980#discussion_r187189887&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SingleLogicalSlot.java &amp;#8212;&lt;br/&gt;
    @@ -159,10 +159,51 @@ public SlotSharingGroupId getSlotSharingGroupId() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the logical slot.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;@param cause of the payload release&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @return true if the logical slot&apos;s payload could be released, otherwise false&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Override&lt;/li&gt;
	&lt;li&gt;public boolean release(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;return releaseSlot(cause).isDone();&lt;br/&gt;
    +	public void release(Throwable cause) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		if (STATE_UPDATER.compareAndSet(this, State.ALIVE, State.RELEASING)) {
    +			signalPayloadRelease(cause);
    +		}    +		state = State.RELEASED;    +		releaseFuture.complete(null);    +	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +	private CompletableFuture&amp;lt;?&amp;gt; signalPayloadRelease(Throwable cause) &lt;/p&gt;
{
    +		tryAssignPayload(TERMINATED_PAYLOAD);
    +		payload.fail(cause);
    +
    +		return payload.getTerminalStateFuture();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void returnSlotToOwner(CompletableFuture&amp;lt;?&amp;gt; terminalStateFuture) {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; slotReturnFuture = terminalStateFuture.handle((Object ignored, Throwable throwable) -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (state == State.RELEASING) {
    +				return slotOwner.returnAllocatedSlot(this);
    +			} else {
    +				return CompletableFuture.completedFuture(true);
    +			}    +		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;).thenCompose(Function.identity());&lt;br/&gt;
    +&lt;br/&gt;
    +		slotReturnFuture.whenComplete(&lt;br/&gt;
    +			(Object ignored, Throwable throwable) -&amp;gt; {&lt;br/&gt;
    +				state = State.RELEASED;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Mutating a private member field from within a lambda - would it make sense to have a (package) private method `markReleased()` or so?&lt;/p&gt;</comment>
                            <comment id="16470247" author="githubbot" created="Thu, 10 May 2018 11:32:09 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5980#discussion_r187305983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5980#discussion_r187305983&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SingleLogicalSlot.java &amp;#8212;&lt;br/&gt;
    @@ -159,10 +159,51 @@ public SlotSharingGroupId getSlotSharingGroupId() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the logical slot.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;@param cause of the payload release&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @return true if the logical slot&apos;s payload could be released, otherwise false&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Override&lt;/li&gt;
	&lt;li&gt;public boolean release(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;return releaseSlot(cause).isDone();&lt;br/&gt;
    +	public void release(Throwable cause) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		if (STATE_UPDATER.compareAndSet(this, State.ALIVE, State.RELEASING)) {
    +			signalPayloadRelease(cause);
    +		}    +		state = State.RELEASED;    +		releaseFuture.complete(null);    +	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +	private CompletableFuture&amp;lt;?&amp;gt; signalPayloadRelease(Throwable cause) &lt;/p&gt;
{
    +		tryAssignPayload(TERMINATED_PAYLOAD);
    +		payload.fail(cause);
    +
    +		return payload.getTerminalStateFuture();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void returnSlotToOwner(CompletableFuture&amp;lt;?&amp;gt; terminalStateFuture) {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; slotReturnFuture = terminalStateFuture.handle((Object ignored, Throwable throwable) -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (state == State.RELEASING) {
    +				return slotOwner.returnAllocatedSlot(this);
    +			} else {
    +				return CompletableFuture.completedFuture(true);
    +			}    +		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;).thenCompose(Function.identity());&lt;br/&gt;
    +&lt;br/&gt;
    +		slotReturnFuture.whenComplete(&lt;br/&gt;
    +			(Object ignored, Throwable throwable) -&amp;gt; {&lt;br/&gt;
    +				state = State.RELEASED;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    yes, this is cleaner&lt;/p&gt;</comment>
                            <comment id="16470248" author="githubbot" created="Thu, 10 May 2018 11:36:34 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5980#discussion_r187306715&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5980#discussion_r187306715&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SingleLogicalSlot.java &amp;#8212;&lt;br/&gt;
    @@ -159,10 +159,51 @@ public SlotSharingGroupId getSlotSharingGroupId() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the logical slot.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;@param cause of the payload release&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @return true if the logical slot&apos;s payload could be released, otherwise false&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Override&lt;/li&gt;
	&lt;li&gt;public boolean release(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;return releaseSlot(cause).isDone();&lt;br/&gt;
    +	public void release(Throwable cause) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		if (STATE_UPDATER.compareAndSet(this, State.ALIVE, State.RELEASING)) {
    +			signalPayloadRelease(cause);
    +		}    +		state = State.RELEASED;    +		releaseFuture.complete(null);    +	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +	private CompletableFuture&amp;lt;?&amp;gt; signalPayloadRelease(Throwable cause) &lt;/p&gt;
{
    +		tryAssignPayload(TERMINATED_PAYLOAD);
    +		payload.fail(cause);
    +
    +		return payload.getTerminalStateFuture();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void returnSlotToOwner(CompletableFuture&amp;lt;?&amp;gt; terminalStateFuture) {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; slotReturnFuture = terminalStateFuture.handle((Object ignored, Throwable throwable) -&amp;gt; {&lt;br/&gt;
    +			if (state == State.RELEASING) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    True, this entails a logical coupling which is currently the case. I&apos;ll add the double check to make it independent of this assumption.&lt;/p&gt;</comment>
                            <comment id="16470253" author="githubbot" created="Thu, 10 May 2018 11:44:01 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5980#discussion_r187307945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5980#discussion_r187307945&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SingleLogicalSlot.java &amp;#8212;&lt;br/&gt;
    @@ -159,10 +159,51 @@ public SlotSharingGroupId getSlotSharingGroupId() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the logical slot.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;@param cause of the payload release&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @return true if the logical slot&apos;s payload could be released, otherwise false&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Override&lt;/li&gt;
	&lt;li&gt;public boolean release(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;return releaseSlot(cause).isDone();&lt;br/&gt;
    +	public void release(Throwable cause) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		if (STATE_UPDATER.compareAndSet(this, State.ALIVE, State.RELEASING)) {
    +			signalPayloadRelease(cause);
    +		}    +		state = State.RELEASED;    +		releaseFuture.complete(null);    +	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +	private CompletableFuture&amp;lt;?&amp;gt; signalPayloadRelease(Throwable cause) &lt;/p&gt;
{
    +		tryAssignPayload(TERMINATED_PAYLOAD);
    +		payload.fail(cause);
    +
    +		return payload.getTerminalStateFuture();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void returnSlotToOwner(CompletableFuture&amp;lt;?&amp;gt; terminalStateFuture) {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; slotReturnFuture = terminalStateFuture.handle((Object ignored, Throwable throwable) -&amp;gt; {&lt;br/&gt;
    +			if (state == State.RELEASING) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    After thinking about this part, I think also a double check won&apos;t strictly prevent this from happening. The problem is that we don&apos;t know when the `SlotOwner` processes the return slot message. What could happen is the following: We send the release message and see afterwards that the state is still `RELEASING`. Before the `SlotOwner` processes the release slot message, it will trigger the `AllocatedSlot.Payload#release` call which releases the slot from the `SlotOwners` side. After this has happened, the owner processes the release message. Consequently, the slot owner has to work in both cases (`RELEASING` and `RELEASED`). With the double check we only make it less likely to happen.&lt;/p&gt;</comment>
                            <comment id="16470255" author="githubbot" created="Thu, 10 May 2018 11:45:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5980&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5980&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @StephanEwen. I&apos;ve addressed your comments and added some more tests. Once Travis passes, I&apos;ll merge it.&lt;/p&gt;</comment>
                            <comment id="16470447" author="githubbot" created="Thu, 10 May 2018 14:23:39 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5980&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5980&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16470452" author="till.rohrmann" created="Thu, 10 May 2018 14:24:21 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
master: c7eb6acaf95a6656ec6bd0a0b401c1944473e7f2&lt;br/&gt;
1.5.0: 7470b96536f8471855a43ce6f1856cec4bb9fbea&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3tj07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>