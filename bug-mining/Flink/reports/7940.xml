<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:23:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-38558] Checkpoint rescale and restore fails with RocksDB Heap timer</title>
                <link>https://issues.apache.org/jira/browse/FLINK-38558</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In Flink 1.20, when using the RocksDB state backend with timer service configured as Heap (state.backend.rocksdb.timer-service.factory: Heap), rescaling a job from a checkpoint fails during restore, throwing the following exception:&lt;br/&gt;
java.lang.Exception: Exception while creating StreamOperatorStateContext.&lt;br/&gt;
at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:332)&lt;br/&gt;
...&lt;br/&gt;
Caused by: java.lang.IllegalArgumentException: KeyGroupRange&lt;/p&gt;

{startKeyGroup=0, endKeyGroup=31}

&lt;p&gt;does not contain key group 32&lt;br/&gt;
at org.apache.flink.util.Preconditions.checkArgument(Preconditions.java:160)&lt;br/&gt;
at org.apache.flink.runtime.state.heap.HeapPriorityQueueSet.globalKeyGroupToLocalIndex(HeapPriorityQueueSet.java:160)&lt;br/&gt;
at org.apache.flink.runtime.state.heap.HeapPriorityQueueSet.getDedupMapForKeyGroup(HeapPriorityQueueSet.java:149)&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;And restoring from a savepoint works fine with the exact same configuration.&lt;/p&gt;

&lt;p&gt;Root Cause Analysis:&lt;/p&gt;

&lt;p&gt;1. When state.backend.rocksdb.timer-service.factory=heap, timers in checkpoints are snapshotted into RawKeyedState. During restore, these timers are added to HeapPriorityQueueSet, which validates against the current key group range. However, timers are not pruned during rescaling, leading to a mismatch (e.g., a timer belonging to key group 32 when the current range is 0-31), triggering the IllegalArgumentException.&lt;br/&gt;
2. The reason savepoints work is due to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21344&quot; title=&quot;Support switching from/to rocks db with heap timers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21344&quot;&gt;&lt;del&gt;FLINK-21344&lt;/del&gt;&lt;/a&gt;, which stops serializing heap timers in the RocksDB state backend during savepoint creation. This avoids the key group validation issue during savepoint restore.&lt;/p&gt;

&lt;p&gt;We could use the folloing code to reproduce:&lt;br/&gt;
1. Firstly, waiting the following job (parallelism = 2) complete checkpoint&lt;br/&gt;
Configuration config = new Configuration();&lt;br/&gt;
config.set(StateBackendOptions.STATE_BACKEND, &quot;rocksdb&quot;);&lt;br/&gt;
config.set(AUTO_WATERMARK_INTERVAL, Duration.ofMillis(200));&lt;br/&gt;
config.set(&lt;br/&gt;
CheckpointingOptions.CHECKPOINTS_DIRECTORY, &quot;xxxx&quot;);&lt;br/&gt;
config.set(ExecutionCheckpointingOptions.CHECKPOINTING_INTERVAL, Duration.ofMillis(10_000));&lt;br/&gt;
config.set(ExecutionCheckpointingOptions.EXTERNALIZED_CHECKPOINT, RETAIN_ON_CANCELLATION);&lt;br/&gt;
config.setString(&quot;state.backend.rocksdb.timer-service.factory&quot;, &quot;HEAP&quot;);&lt;/p&gt;

&lt;p&gt;StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(config);&lt;br/&gt;
env.disableOperatorChaining();&lt;br/&gt;
env.setParallelism(2);&lt;/p&gt;

&lt;p&gt;StreamTableEnvironment tEnv = StreamTableEnvironment.create(env);&lt;/p&gt;

&lt;p&gt;DataStreamSource&amp;lt;Row&amp;gt; source =&lt;br/&gt;
env.addSource(&lt;br/&gt;
new SourceFunction&amp;lt;Row&amp;gt;() {&lt;br/&gt;
private boolean running = true;&lt;br/&gt;
private int ts = 1000;&lt;br/&gt;
private Random rnd = new Random();&lt;/p&gt;

&lt;p&gt;@Override&lt;br/&gt;
public void run(SourceContext&amp;lt;Row&amp;gt; ctx) throws Exception {&lt;br/&gt;
while (running)&lt;/p&gt;

{ Thread.sleep(1); ts += rnd.nextInt(1); ctx.collect( Row.ofKind( RowKind.INSERT, Instant.ofEpochMilli(ts), &quot;USD&quot;, rnd.nextInt(300))); ctx.collect( Row.ofKind( RowKind.INSERT, Instant.ofEpochMilli(ts), &quot;CHD&quot;, rnd.nextInt(200))); ctx.collect( Row.ofKind( RowKind.INSERT, Instant.ofEpochMilli(ts), &quot;BST&quot;, rnd.nextInt(200))); }

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;@Override&lt;br/&gt;
public void cancel()&lt;/p&gt;

{ running = false; }

&lt;p&gt;},&lt;br/&gt;
TypeExtractor.getForObject(&lt;br/&gt;
Row.ofKind(RowKind.INSERT, Instant.ofEpochMilli(0), &quot;USD&quot;, 1)));&lt;br/&gt;
// Create a table from change log stream&lt;br/&gt;
Table rateTable =&lt;br/&gt;
tEnv.fromDataStream(&lt;br/&gt;
source,&lt;br/&gt;
Schema.newBuilder()&lt;br/&gt;
.column(&quot;f0&quot;, DataTypes.TIMESTAMP_LTZ(3))&lt;br/&gt;
.column(&quot;f1&quot;, DataTypes.STRING().notNull())&lt;br/&gt;
.column(&quot;f2&quot;, DataTypes.INT().notNull())&lt;br/&gt;
.watermark(&quot;f0&quot;, &quot;f0 - INTERVAL &apos;2&apos; SECONDS&quot;)&lt;br/&gt;
.primaryKey(&quot;f1&quot;)&lt;br/&gt;
.build())&lt;br/&gt;
.as(&quot;ts&quot;, &quot;product&quot;, &quot;amount&quot;);&lt;/p&gt;

&lt;p&gt;// Register the table as a view, it will be accessible under a name&lt;br/&gt;
tEnv.createTemporaryView(&quot;source&quot;, rateTable);&lt;/p&gt;

&lt;p&gt;String query =&lt;br/&gt;
&quot;SELECT\n&quot;&lt;br/&gt;
+ &quot; CAST(window_start AS STRING) as window_start,\n&quot;&lt;br/&gt;
+ &quot; CAST(window_end AS STRING) as window_end,\n&quot;&lt;br/&gt;
+ &quot; sum(amount) as pv,\n&quot;&lt;br/&gt;
+ &quot; count(1) AS uv,\n&quot;&lt;br/&gt;
+ &quot; `product`\n&quot;&lt;br/&gt;
+ &quot;FROM\n&quot;&lt;br/&gt;
+ &quot; TABLE(\n&quot;&lt;br/&gt;
+ &quot; CUMULATE(\n&quot;&lt;br/&gt;
+ &quot; TABLE source,\n&quot;&lt;br/&gt;
+ &quot; DESCRIPTOR(ts),\n&quot;&lt;br/&gt;
+ &quot; INTERVAL &apos;10&apos; MINUTES,\n&quot;&lt;br/&gt;
+ &quot; INTERVAL &apos;60&apos; MINUTES\n&quot;&lt;br/&gt;
+ &quot; )\n&quot;&lt;br/&gt;
+ &quot; )\n&quot;&lt;br/&gt;
+ &quot;GROUP BY\n&quot;&lt;br/&gt;
+ &quot; window_start,\n&quot;&lt;br/&gt;
+ &quot; window_end,\n&quot;&lt;br/&gt;
+ &quot; product;&quot;;&lt;br/&gt;
tEnv.executeSql(query);&lt;/p&gt;

&lt;p&gt;2. Secondly, restore from cp with new parallelism (p = 4)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13632370">FLINK-38558</key>
            <summary>Checkpoint rescale and restore fails with RocksDB Heap timer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="guoyangze">Yangze Guo</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 24 Oct 2025 08:30:46 +0000</created>
                <updated>Fri, 31 Oct 2025 12:45:33 +0000</updated>
                            <resolved>Fri, 31 Oct 2025 12:45:33 +0000</resolved>
                                    <version>1.20.3</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="18032705" author="karmagyz" created="Fri, 24 Oct 2025 08:31:11 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zakelly&quot; class=&quot;user-hover&quot; rel=&quot;zakelly&quot;&gt;Zakelly&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18033446" author="zakelly" created="Tue, 28 Oct 2025 06:05:14 +0000"  >&lt;p&gt;Thanks for reporting this!&lt;/p&gt;

&lt;p&gt;I think the StateBackend#isSafeToReuseKVState is implemented wrong so the object reuse is performed wrong, resulting in broken checkpoint. Fixing it.&lt;/p&gt;</comment>
                            <comment id="18034390" author="zakelly" created="Fri, 31 Oct 2025 12:45:07 +0000"  >&lt;p&gt;Merge 162025a into master&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 week, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1yaao:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>