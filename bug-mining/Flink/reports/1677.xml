<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5101] Test CassandraConnectorITCase instable</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5101</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I observed this test fail on Travis (very rarely):&lt;/p&gt;

&lt;p&gt; Running org.apache.flink.streaming.connectors.cassandra.CassandraConnectorITCase&lt;/p&gt;


&lt;p&gt;Tests run: 7, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 80.843 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.flink.streaming.connectors.cassandra.CassandraConnectorITCase&lt;br/&gt;
testCassandraBatchFormats(org.apache.flink.streaming.connectors.cassandra.CassandraConnectorITCase)  Time elapsed: 5.82 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;br/&gt;
java.lang.AssertionError: expected:&amp;lt;40&amp;gt; but was:&amp;lt;20&amp;gt;&lt;br/&gt;
	at org.junit.Assert.fail(Assert.java:88)&lt;br/&gt;
	at org.junit.Assert.failNotEquals(Assert.java:834)&lt;br/&gt;
	at org.junit.Assert.assertEquals(Assert.java:645)&lt;br/&gt;
	at org.junit.Assert.assertEquals(Assert.java:631)&lt;br/&gt;
	at org.apache.flink.streaming.connectors.cassandra.CassandraConnectorITCase.testCassandraBatchFormats(CassandraConnectorITCase.java:442)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13021798">FLINK-5101</key>
            <summary>Test CassandraConnectorITCase instable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="srichter">Stefan Richter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Nov 2016 17:30:17 +0000</created>
                <updated>Fri, 12 May 2017 21:47:35 +0000</updated>
                            <resolved>Fri, 12 May 2017 21:47:35 +0000</resolved>
                                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Connectors / Cassandra</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="15695581" author="githubbot" created="Fri, 25 Nov 2016 10:57:06 +0000"  >&lt;p&gt;GitHub user zentol opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5101&quot; title=&quot;Test CassandraConnectorITCase instable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5101&quot;&gt;&lt;del&gt;FLINK-5101&lt;/del&gt;&lt;/a&gt; Refactor CassandraConnectorITCase&lt;/p&gt;

&lt;p&gt;    This PR refactors the CassandraConnectorITCase to be a bit more stable and easier to debug.&lt;/p&gt;

&lt;p&gt;    The following changes were made:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we no longer run actual flink jobs; all tests directly interact with the sink to save resources&lt;/li&gt;
	&lt;li&gt;every test uses a different table, preventing race conditions related to truncating the table&lt;/li&gt;
	&lt;li&gt;the at-least-once sinks were modified to track pending updates&lt;br/&gt;
    =&amp;gt; the pojo sink was modified to use a method that returns an actually useful `Future`&lt;br/&gt;
    =&amp;gt; since the sink waits in `close()` for pending updates it can no longer occur that a test checks a condition prematurely, improving stability&lt;/li&gt;
	&lt;li&gt;the initial connection is established across a time-span of 30 seconds, increasing the chance that cassandra has started before the tests are run&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zentol/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/flink&lt;/a&gt; 4177_cass_test&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2866&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit e2cb8b9dc1131422dc97c0c08cbacd39cb747a44&lt;br/&gt;
Author: zentol &amp;lt;chesnay@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-11-23T15:59:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5101&quot; title=&quot;Test CassandraConnectorITCase instable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5101&quot;&gt;&lt;del&gt;FLINK-5101&lt;/del&gt;&lt;/a&gt; Track pending records in CassandraSinkBase&lt;/p&gt;

&lt;p&gt;commit 4c74937fac3e112f24a1af62d529153ce3aabb68&lt;br/&gt;
Author: zentol &amp;lt;chesnay@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-11-23T16:29:51Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5101&quot; title=&quot;Test CassandraConnectorITCase instable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5101&quot;&gt;&lt;del&gt;FLINK-5101&lt;/del&gt;&lt;/a&gt; Refactor CassandraConnectorITCase&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15811549" author="githubbot" created="Mon, 9 Jan 2017 11:33:33 +0000"  >&lt;p&gt;Github user LorenzBuehmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3072&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3072&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hm, ok. One test failed, but that&apos;s strange since it has nothing to do with Scopt nor the Moreover, it failed only for one profile. According to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5101&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-5101&lt;/a&gt; it is a random problem with the Cassandra unit test. So, how to proceed?&lt;/p&gt;</comment>
                            <comment id="15834414" author="githubbot" created="Mon, 23 Jan 2017 12:50:19 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r97310954&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r97310954&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-connectors/flink-connector-cassandra/src/test/java/org/apache/flink/streaming/connectors/cassandra/CassandraConnectorITCase.java &amp;#8212;&lt;br/&gt;
    @@ -371,70 +351,77 @@ public void testCassandraCommitter() throws Exception {&lt;/p&gt;

&lt;p&gt;     	@Test&lt;br/&gt;
     	public void testCassandraTupleAtLeastOnceSink() throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();&lt;/li&gt;
	&lt;li&gt;env.setParallelism(1);&lt;br/&gt;
    +		CassandraTupleSink&amp;lt;Tuple3&amp;lt;String, Integer, Integer&amp;gt;&amp;gt; sink = new CassandraTupleSink&amp;lt;&amp;gt;(injectTableName(INSERT_DATA_QUERY), builder);&lt;br/&gt;
    +&lt;br/&gt;
    +		sink.open(new Configuration());&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;DataStream&amp;lt;Tuple3&amp;lt;String, Integer, Integer&amp;gt;&amp;gt; source = env.fromCollection(collection);&lt;/li&gt;
	&lt;li&gt;source.addSink(new CassandraTupleSink&amp;lt;Tuple3&amp;lt;String, Integer, Integer&amp;gt;&amp;gt;(INSERT_DATA_QUERY, builder));&lt;br/&gt;
    +		for (Tuple3&amp;lt;String, Integer, Integer&amp;gt; value : collection) 
{
    +			sink.send(value);
    +		}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;env.execute();&lt;br/&gt;
    +		sink.close();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ResultSet rs = session.execute(SELECT_DATA_QUERY);&lt;br/&gt;
    +		synchronized (sink.updatesPending) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Is this needed when `close()` already waits for pending requests?&lt;/p&gt;</comment>
                            <comment id="15834415" author="githubbot" created="Mon, 23 Jan 2017 12:50:19 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r97310432&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r97310432&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-connectors/flink-connector-cassandra/src/test/java/org/apache/flink/streaming/connectors/cassandra/CassandraConnectorITCase.java &amp;#8212;&lt;br/&gt;
    @@ -173,39 +157,49 @@ public static void startCassandra() throws IOException &lt;/p&gt;
{
     			cassandra.start();
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			Thread.sleep(1000 * 10);
    -		}
&lt;p&gt; catch (InterruptedException e) { //give cassandra a few seconds to start up&lt;br/&gt;
    +		// give cassandra a few seconds to start up&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Can we skip this and simply rely on the loop below that tries to connect?&lt;/p&gt;</comment>
                            <comment id="15834416" author="githubbot" created="Mon, 23 Jan 2017 12:50:19 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r97310987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r97310987&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-connectors/flink-connector-cassandra/src/test/java/org/apache/flink/streaming/connectors/cassandra/CassandraConnectorITCase.java &amp;#8212;&lt;br/&gt;
    @@ -371,70 +351,77 @@ public void testCassandraCommitter() throws Exception {&lt;/p&gt;

&lt;p&gt;     	@Test&lt;br/&gt;
     	public void testCassandraTupleAtLeastOnceSink() throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();&lt;/li&gt;
	&lt;li&gt;env.setParallelism(1);&lt;br/&gt;
    +		CassandraTupleSink&amp;lt;Tuple3&amp;lt;String, Integer, Integer&amp;gt;&amp;gt; sink = new CassandraTupleSink&amp;lt;&amp;gt;(injectTableName(INSERT_DATA_QUERY), builder);&lt;br/&gt;
    +&lt;br/&gt;
    +		sink.open(new Configuration());&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;DataStream&amp;lt;Tuple3&amp;lt;String, Integer, Integer&amp;gt;&amp;gt; source = env.fromCollection(collection);&lt;/li&gt;
	&lt;li&gt;source.addSink(new CassandraTupleSink&amp;lt;Tuple3&amp;lt;String, Integer, Integer&amp;gt;&amp;gt;(INSERT_DATA_QUERY, builder));&lt;br/&gt;
    +		for (Tuple3&amp;lt;String, Integer, Integer&amp;gt; value : collection) 
{
    +			sink.send(value);
    +		}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;env.execute();&lt;br/&gt;
    +		sink.close();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ResultSet rs = session.execute(SELECT_DATA_QUERY);&lt;br/&gt;
    +		synchronized (sink.updatesPending) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (sink.updatesPending.get() != 0) {
    +				sink.updatesPending.wait();
    +			}    +		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +		ResultSet rs = session.execute(injectTableName(SELECT_DATA_QUERY));&lt;br/&gt;
     		Assert.assertEquals(20, rs.all().size());&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	@Test&lt;br/&gt;
     	public void testCassandraPojoAtLeastOnceSink() throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();&lt;/li&gt;
	&lt;li&gt;env.setParallelism(1);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;DataStreamSource&amp;lt;Pojo&amp;gt; source = env&lt;/li&gt;
	&lt;li&gt;.addSource(new SourceFunction&amp;lt;Pojo&amp;gt;() {&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;private boolean running = true;&lt;/li&gt;
	&lt;li&gt;private volatile int cnt = 0;&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void run(SourceContext&amp;lt;Pojo&amp;gt; ctx) throws Exception {&lt;/li&gt;
	&lt;li&gt;while (running) {&lt;/li&gt;
	&lt;li&gt;ctx.collect(new Pojo(UUID.randomUUID().toString(), cnt, 0));&lt;/li&gt;
	&lt;li&gt;cnt++;&lt;/li&gt;
	&lt;li&gt;if (cnt == 20) 
{
    -							cancel();
    -						}&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
    +		session.execute(CREATE_TABLE_QUERY.replace(TABLE_NAME_VARIABLE, &quot;test&quot;));&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void cancel() 
{
    -					running = false;
    -				}&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
    +		CassandraPojoSink&amp;lt;Pojo&amp;gt; sink = new CassandraPojoSink&amp;lt;&amp;gt;(Pojo.class, builder);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;source.addSink(new CassandraPojoSink&amp;lt;&amp;gt;(Pojo.class, builder));&lt;br/&gt;
    +		sink.open(new Configuration());&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;env.execute();&lt;br/&gt;
    +		for (int x = 0; x &amp;lt; 20; x++) 
{
    +			sink.send(new Pojo(UUID.randomUUID().toString(), x, 0));
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		sink.close();&lt;br/&gt;
    +&lt;br/&gt;
    +		synchronized (sink.updatesPending) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Same as above&lt;/p&gt;</comment>
                            <comment id="15834417" author="githubbot" created="Mon, 23 Jan 2017 12:50:19 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r97310568&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r97310568&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-connectors/flink-connector-cassandra/src/test/java/org/apache/flink/streaming/connectors/cassandra/CassandraConnectorITCase.java &amp;#8212;&lt;br/&gt;
    @@ -173,39 +157,49 @@ public static void startCassandra() throws IOException &lt;/p&gt;
{
     			cassandra.start();
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			Thread.sleep(1000 * 10);
    -		}
&lt;p&gt; catch (InterruptedException e) { //give cassandra a few seconds to start up&lt;br/&gt;
    +		// give cassandra a few seconds to start up&lt;br/&gt;
    +		long start = System.currentTimeMillis();&lt;br/&gt;
    +		long deadline = start + 1000 * 10;&lt;br/&gt;
    +		while (System.currentTimeMillis() &amp;lt; deadline) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			try {
    +				Thread.sleep(1000);
    +			} catch (InterruptedException ignored) {
    +			}     		}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cluster = builder.getCluster();&lt;/li&gt;
	&lt;li&gt;session = cluster.connect();&lt;br/&gt;
    +		// start establishing a connection within 30 seconds&lt;br/&gt;
    +		start = System.currentTimeMillis();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I would suggest to use `System.nanoTime()`, because `System.curremtTimeMillis` is not stable. Seems especially unstable on Travis.&lt;/p&gt;</comment>
                            <comment id="15834418" author="githubbot" created="Mon, 23 Jan 2017 12:50:19 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r97309628&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r97309628&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-connectors/flink-connector-cassandra/src/main/java/org/apache/flink/streaming/connectors/cassandra/CassandraSinkBase.java &amp;#8212;&lt;br/&gt;
    @@ -69,17 +87,27 @@ public void onFailure(Throwable t) {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void invoke(IN value) throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (exception != null) {&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;invoke() failed&quot;, exception);&lt;br/&gt;
    +		Throwable e = exception.get();&lt;br/&gt;
    +		if (e != null) 
{
    +			throw new IOException(&quot;Error while sending value.&quot;, e);
     		}
&lt;p&gt;     		ListenableFuture&amp;lt;V&amp;gt; result = send(value);&lt;br/&gt;
    +		updatesPending.incrementAndGet();&lt;br/&gt;
     		Futures.addCallback(result, callback);&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	public abstract ListenableFuture&amp;lt;V&amp;gt; send(IN value);&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void close() {&lt;br/&gt;
    +		while (updatesPending.get() &amp;gt; 0) {&lt;br/&gt;
    +			synchronized (updatesPending) {&lt;br/&gt;
    +				try &lt;/p&gt;
{
    +					updatesPending.wait();
    +				}
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
    +				}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Probably better here even: Throw an exception, because closing is incomplete when interrupted (and cannot guarantee correctness)&lt;/p&gt;</comment>
                            <comment id="15834419" author="githubbot" created="Mon, 23 Jan 2017 12:50:19 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r97310489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r97310489&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-connectors/flink-connector-cassandra/src/test/java/org/apache/flink/streaming/connectors/cassandra/CassandraConnectorITCase.java &amp;#8212;&lt;br/&gt;
    @@ -173,39 +157,49 @@ public static void startCassandra() throws IOException &lt;/p&gt;
{
     			cassandra.start();
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			Thread.sleep(1000 * 10);
    -		}
&lt;p&gt; catch (InterruptedException e) { //give cassandra a few seconds to start up&lt;br/&gt;
    +		// give cassandra a few seconds to start up&lt;br/&gt;
    +		long start = System.currentTimeMillis();&lt;br/&gt;
    +		long deadline = start + 1000 * 10;&lt;br/&gt;
    +		while (System.currentTimeMillis() &amp;lt; deadline) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			try {
    +				Thread.sleep(1000);
    +			} catch (InterruptedException ignored) {
    +			}     		}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cluster = builder.getCluster();&lt;/li&gt;
	&lt;li&gt;session = cluster.connect();&lt;br/&gt;
    +		// start establishing a connection within 30 seconds&lt;br/&gt;
    +		start = System.currentTimeMillis();&lt;br/&gt;
    +		deadline = start + 1000 * 30;&lt;br/&gt;
    +		while (true) {&lt;br/&gt;
    +			try 
{
    +				cluster = builder.getCluster();
    +				session = cluster.connect();
    +				break;
    +			}
&lt;p&gt; catch (Exception e) {&lt;br/&gt;
    +				if (System.currentTimeMillis() &amp;gt; deadline) &lt;/p&gt;
{
    +					throw e;
    +				}
&lt;p&gt;    +				try {&lt;br/&gt;
    +					Thread.sleep(2000);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    How about reducing this to, say 500ms, to make it react a bit sooner once the connection can be established.&lt;/p&gt;</comment>
                            <comment id="15834420" author="githubbot" created="Mon, 23 Jan 2017 12:50:19 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r97309082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r97309082&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-connectors/flink-connector-cassandra/src/main/java/org/apache/flink/streaming/connectors/cassandra/CassandraSinkBase.java &amp;#8212;&lt;br/&gt;
    @@ -69,17 +87,27 @@ public void onFailure(Throwable t) {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void invoke(IN value) throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (exception != null) {&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;invoke() failed&quot;, exception);&lt;br/&gt;
    +		Throwable e = exception.get();&lt;br/&gt;
    +		if (e != null) 
{
    +			throw new IOException(&quot;Error while sending value.&quot;, e);
     		}
&lt;p&gt;     		ListenableFuture&amp;lt;V&amp;gt; result = send(value);&lt;br/&gt;
    +		updatesPending.incrementAndGet();&lt;br/&gt;
     		Futures.addCallback(result, callback);&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	public abstract ListenableFuture&amp;lt;V&amp;gt; send(IN value);&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void close() {&lt;br/&gt;
    +		while (updatesPending.get() &amp;gt; 0) {&lt;br/&gt;
    +			synchronized (updatesPending) {&lt;br/&gt;
    +				try &lt;/p&gt;
{
    +					updatesPending.wait();
    +				}
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
    +				}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Good practice is to set the interruption flag back: `Thread.currentThread().interrupt();`&lt;/p&gt;</comment>
                            <comment id="15834421" author="githubbot" created="Mon, 23 Jan 2017 12:50:19 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r97309712&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r97309712&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-connectors/flink-connector-cassandra/src/main/java/org/apache/flink/streaming/connectors/cassandra/CassandraSinkBase.java &amp;#8212;&lt;br/&gt;
    @@ -94,5 +122,9 @@ public void close() {&lt;br/&gt;
     		} catch (Exception e) &lt;/p&gt;
{
     			LOG.error(&quot;Error while closing cluster.&quot;, e);
     		}
&lt;p&gt;    +		Throwable e = exception.get();&lt;br/&gt;
    +		if (e != null) {&lt;br/&gt;
    +			LOG.error(&quot;Error while sending value.&quot;, e);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This needs to be rethrown, otherwise close() may complete without an exception, but the result may be incomplete.&lt;/p&gt;</comment>
                            <comment id="15834423" author="githubbot" created="Mon, 23 Jan 2017 12:50:52 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Good set of changes. Some comments for small adjustments, otherwise +1 for the approch&lt;/p&gt;</comment>
                            <comment id="15839554" author="githubbot" created="Thu, 26 Jan 2017 10:54:02 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen I&apos;ve addressed your comments and Travis is passing &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15839946" author="githubbot" created="Thu, 26 Jan 2017 16:23:56 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r98026925&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r98026925&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-cassandra/src/main/java/org/apache/flink/streaming/connectors/cassandra/CassandraSinkBase.java &amp;#8212;&lt;br/&gt;
    @@ -40,26 +42,42 @@&lt;br/&gt;
     	protected transient Cluster cluster;&lt;br/&gt;
     	protected transient Session session;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected transient Throwable exception = null;&lt;br/&gt;
    +	protected transient AtomicReference&amp;lt;Throwable&amp;gt; exception;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Does `exception` have to be an `AtomicReference`, or does a volatile variable suffice?&lt;/p&gt;</comment>
                            <comment id="15839947" author="githubbot" created="Thu, 26 Jan 2017 16:23:56 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r98018710&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r98018710&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-cassandra/src/test/java/org/apache/flink/streaming/connectors/cassandra/CassandraConnectorITCase.java &amp;#8212;&lt;br/&gt;
    @@ -173,39 +157,39 @@ public static void startCassandra() throws IOException &lt;/p&gt;
{
     			cassandra.start();
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			Thread.sleep(1000 * 10);
    -		}
&lt;p&gt; catch (InterruptedException e) { //give cassandra a few seconds to start up&lt;br/&gt;
    +		// start establishing a connection within 30 seconds&lt;br/&gt;
    +		long start = System.nanoTime();&lt;br/&gt;
    +		long deadline = start + 1000 * 30;&lt;br/&gt;
    +		while (true) {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				cluster = builder.getCluster();
    +				session = cluster.connect();
    +				break;
    +			}
&lt;p&gt; catch (Exception e) {&lt;br/&gt;
    +				if (System.currentTimeMillis() &amp;gt; deadline) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This should also be `System.nanoTime()`&lt;/p&gt;</comment>
                            <comment id="15839948" author="githubbot" created="Thu, 26 Jan 2017 16:23:57 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r98018596&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r98018596&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-cassandra/src/test/java/org/apache/flink/streaming/connectors/cassandra/CassandraConnectorITCase.java &amp;#8212;&lt;br/&gt;
    @@ -173,39 +157,39 @@ public static void startCassandra() throws IOException &lt;/p&gt;
{
     			cassandra.start();
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			Thread.sleep(1000 * 10);
    -		}
&lt;p&gt; catch (InterruptedException e) { //give cassandra a few seconds to start up&lt;br/&gt;
    +		// start establishing a connection within 30 seconds&lt;br/&gt;
    +		long start = System.nanoTime();&lt;br/&gt;
    +		long deadline = start + 1000 * 30;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This needs to be `long deadline = start + 30_000_000_000` (because its nanos)&lt;/p&gt;</comment>
                            <comment id="15839949" author="githubbot" created="Thu, 26 Jan 2017 16:26:22 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks much better, one mixup is still in the tests.&lt;br/&gt;
    The comment about the Atomic Reference is a minor improvement comment.&lt;/p&gt;</comment>
                            <comment id="15853842" author="githubbot" created="Mon, 6 Feb 2017 11:04:48 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866#discussion_r99562651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866#discussion_r99562651&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-cassandra/src/main/java/org/apache/flink/streaming/connectors/cassandra/CassandraSinkBase.java &amp;#8212;&lt;br/&gt;
    @@ -40,26 +42,42 @@&lt;br/&gt;
     	protected transient Cluster cluster;&lt;br/&gt;
     	protected transient Session session;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected transient Throwable exception = null;&lt;br/&gt;
    +	protected transient AtomicReference&amp;lt;Throwable&amp;gt; exception;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    it can be volatile.&lt;/p&gt;</comment>
                            <comment id="15878616" author="githubbot" created="Wed, 22 Feb 2017 16:21:45 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen I&apos;ve addressed your comments and rebased the branch.&lt;/p&gt;</comment>
                            <comment id="16008741" author="githubbot" created="Fri, 12 May 2017 21:44:32 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2866&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16008750" author="zentol" created="Fri, 12 May 2017 21:47:35 +0000"  >&lt;p&gt;1.3: a85b1881d184c02075441f57f3364ec80b2d4f4d &amp;amp; 5d6b5a6773a795a3266b6298ae26d4f158ce18c4&lt;br/&gt;
1.4: 948bb9f674a9c4cf95491f3d9a92b38eed6b64e8 &amp;amp; 0be04b454f58d5575bd6fab5755aa1264f363b91&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 27 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36igf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>