<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:21:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-3087] Table API do not support multi count in aggregation.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-3087</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Multi &lt;tt&gt;count&lt;/tt&gt; in aggregation is not supported, for example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;table.select(&lt;span class=&quot;code-quote&quot;&gt;&quot;a.count&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b.count&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It&apos;s valid in grammar, besides, &lt;tt&gt;a.count&lt;/tt&gt; and &lt;tt&gt;b.count&lt;/tt&gt; may have different values actually if NULL value handling is enabled.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12916554">FLINK-3087</key>
            <summary>Table API do not support multi count in aggregation.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chengxiang li">Chengxiang Li</assignee>
                                    <reporter username="chengxiang li">Chengxiang Li</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Nov 2015 06:39:23 +0000</created>
                <updated>Wed, 2 Dec 2015 09:33:14 +0000</updated>
                            <resolved>Wed, 2 Dec 2015 09:33:14 +0000</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>1.0.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15029534" author="githubbot" created="Fri, 27 Nov 2015 07:03:07 +0000"  >&lt;p&gt;GitHub user ChengXiangLi opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3087&quot; title=&quot;Table API do not support multi count in aggregation.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3087&quot;&gt;&lt;del&gt;FLINK-3087&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Table-API&amp;#93;&lt;/span&gt; support multi count in aggregation&lt;/p&gt;

&lt;p&gt;    The `Literal(1)` is used as the IntermediateField of `Count` aggregation, so multi `Count` looks the same in `ExpandAggregations`.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ChengXiangLi/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ChengXiangLi/flink&lt;/a&gt; countAggregation&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1414&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d83690c521b22e7af339353ed1b06b3d199e9c42&lt;br/&gt;
Author: chengxiang li &amp;lt;chengxiang.li@intel.com&amp;gt;&lt;br/&gt;
Date:   2015-11-27T06:46:29Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3087&quot; title=&quot;Table API do not support multi count in aggregation.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3087&quot;&gt;&lt;del&gt;FLINK-3087&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Table-API&amp;#93;&lt;/span&gt; support multi count in aggregation&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15029935" author="githubbot" created="Fri, 27 Nov 2015 14:45:03 +0000"  >&lt;p&gt;Github user aljoscha commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414#issuecomment-160153032&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414#issuecomment-160153032&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi,&lt;br/&gt;
    the reason it was implemented as it was is to eliminate common subexpressions. For example, if you wrote:&lt;br/&gt;
    ```&lt;br/&gt;
    select(a.count, b.count)&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    the resulting expansion would be&lt;br/&gt;
    ```&lt;br/&gt;
    intermediate = select(1.count as intermediate.1)&lt;br/&gt;
    agg = intermediate.aggregate(intermediate.1, sum)&lt;br/&gt;
    result = agg.select(intermediate.1, intermediate.1)&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    You see, the `1` would only be aggregated once here.&lt;/p&gt;

&lt;p&gt;    The problem was that selecting `intermediate.1` twice is not allowed since the field names have to be unique.&lt;/p&gt;

&lt;p&gt;    Changing `ExpandAggregations` to this should do the trick:&lt;br/&gt;
    ```&lt;br/&gt;
    var intermediateCount = 0&lt;br/&gt;
    var resultCount = 0&lt;br/&gt;
    selection foreach {  f =&amp;gt;&lt;br/&gt;
      f.transformPre {&lt;br/&gt;
        case agg: Aggregation =&amp;gt;&lt;br/&gt;
          val intermediateReferences = agg.getIntermediateFields.zip(agg.getAggregations) map {&lt;br/&gt;
            case (expr, basicAgg) =&amp;gt;&lt;br/&gt;
              aggregations.get((expr, basicAgg)) match &lt;/p&gt;
{
                case Some(intermediateName) =&amp;gt;
                  resultCount = resultCount + 1
                  val resultName = s&quot;result.$resultCount&quot;
                  Naming(ResolvedFieldReference(intermediateName, expr.typeInfo), resultName)
                case None =&amp;gt;
                  intermediateCount = intermediateCount + 1
                  val intermediateName = s&quot;intermediate.$intermediateCount&quot;
                  intermediateFields += Naming(expr, intermediateName)
                  aggregations((expr, basicAgg)) = intermediateName
                  resultCount = resultCount + 1
                  val resultName = s&quot;result.$resultCount&quot;
                  Naming(ResolvedFieldReference(intermediateName, expr.typeInfo), resultName)
              }
&lt;p&gt;          }&lt;/p&gt;

&lt;p&gt;          aggregationIntermediates(agg) = intermediateReferences&lt;br/&gt;
          // Return a NOP so that we don&apos;t add the children of the aggregation&lt;br/&gt;
          // to intermediate fields. We already added the necessary fields to the list&lt;br/&gt;
          // of intermediate fields.&lt;br/&gt;
          NopExpression()&lt;/p&gt;

&lt;p&gt;        case fa: ResolvedFieldReference =&amp;gt;&lt;br/&gt;
          if (!fa.name.startsWith(&quot;intermediate&quot;)) &lt;/p&gt;
{
            intermediateFields += Naming(fa, fa.name)
          }
&lt;p&gt;          fa&lt;br/&gt;
      }&lt;br/&gt;
    }&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    Now the aggregations will be expanded to:&lt;br/&gt;
    ```&lt;br/&gt;
    intermediate = select(1.count as intermediate.1)&lt;br/&gt;
    agg = intermediate.aggregate(intermediate.1, sum)&lt;br/&gt;
    result = agg.select(intermediate.1 as result.1, intermediate.1 as result.2)&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    This also required changing `ExpressionCodeGenerator.scala`, line 111 to:&lt;br/&gt;
    ```&lt;br/&gt;
    def cleanExpr(e: Expression): Expression = {&lt;br/&gt;
      e match &lt;/p&gt;
{
        case expressions.Naming(namedExpr, _) =&amp;gt; cleanExpr(namedExpr)
        case _ =&amp;gt; e
      }
&lt;p&gt;    }&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    because there is another bug that doesn&apos;t allow having nested Namings &#224; la `Naming(Naming(expr, intermediate.1, result.1))`.&lt;/p&gt;

</comment>
                            <comment id="15029936" author="githubbot" created="Fri, 27 Nov 2015 14:45:22 +0000"  >&lt;p&gt;Github user aljoscha commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414#issuecomment-160153085&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414#issuecomment-160153085&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    It&apos;s good that you found the problem and added a test. :smile: &lt;/p&gt;</comment>
                            <comment id="15032883" author="githubbot" created="Tue, 1 Dec 2015 01:51:53 +0000"  >&lt;p&gt;Github user ChengXiangLi commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414#issuecomment-160822216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414#issuecomment-160822216&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    `a.count` and `b.count` may not the same all the times(for example is `a` contains NULL values), that&apos;s why i try to aggregate it twice. But NULL value is not allowed until now, so i can update the PR in your way and revisit this issue after NULL value handling in Table API is enabled.&lt;/p&gt;</comment>
                            <comment id="15033232" author="githubbot" created="Tue, 1 Dec 2015 07:10:56 +0000"  >&lt;p&gt;Github user aljoscha commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414#issuecomment-160879522&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414#issuecomment-160879522&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Oh, you are way ahead of me. :sweat_smile: You are right, keep it that way since we will probably have support for Null values in the future.&lt;/p&gt;

&lt;p&gt;    I&apos;ll merge it later if there are no objections. @twalthr ?&lt;/p&gt;</comment>
                            <comment id="15033587" author="githubbot" created="Tue, 1 Dec 2015 12:12:37 +0000"  >&lt;p&gt;Github user twalthr commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414#issuecomment-160949963&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414#issuecomment-160949963&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks good. No objecttions.&lt;/p&gt;</comment>
                            <comment id="15033620" author="githubbot" created="Tue, 1 Dec 2015 12:39:18 +0000"  >&lt;p&gt;Github user aljoscha commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414#issuecomment-160956025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414#issuecomment-160956025&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Ah, I see you changed it to my (wrong) suggestion. @ChengXiangLi Do you want to change it back to your initial version (plus maybe the fix for the naming and cleanExpr). Or should it be changed when adding support for null values?&lt;/p&gt;</comment>
                            <comment id="15035101" author="githubbot" created="Wed, 2 Dec 2015 01:49:46 +0000"  >&lt;p&gt;Github user ChengXiangLi commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414#issuecomment-161153580&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414#issuecomment-161153580&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Let&apos;s reuse the count aggregation now, as it&apos;s better for performance now. I would revisit this after NULL value handling is enabled.&lt;/p&gt;</comment>
                            <comment id="15035522" author="githubbot" created="Wed, 2 Dec 2015 09:21:28 +0000"  >&lt;p&gt;Github user aljoscha commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414#issuecomment-161232136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414#issuecomment-161232136&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Alright, I merged it. Could you please close it if github doesn&apos;t do so automatically.&lt;/p&gt;

&lt;p&gt;    Thanks for the work!&lt;/p&gt;</comment>
                            <comment id="15035540" author="githubbot" created="Wed, 2 Dec 2015 09:32:26 +0000"  >&lt;p&gt;Github user ChengXiangLi closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1414&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1414&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ozwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>