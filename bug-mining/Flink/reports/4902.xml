<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20396] Add &quot;OperatorCoordinator.resetSubtask()&quot; to fix order problems of &quot;subtaskFailed()&quot;</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20396</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;There are no strong order guarantees between &lt;tt&gt;OperatorCoordinator.subtaskFailed()&lt;/tt&gt; and &lt;tt&gt;OperatorCoordinator.notifyCheckpointComplete()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It can happen that a checkpoint completes after the notification for task failure is sent:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;OperatorCoordinator.checkpoint()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;OperatorCoordinator.subtaskFailed()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;OperatorCoordinator.checkpointComplete()&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The subtask failure here does not know whether the previous checkpoint completed or not. It cannot decide what state the subtask will be in after recovery.&lt;br/&gt;
There is no easy fix right now to strictly guarantee the order of the method calls, so alternatively we need to provide the necessary information to reason about the status of tasks.&lt;/p&gt;

&lt;p&gt;We should replace &lt;tt&gt;OperatorCoordinator.subtaskFailed(int subtask)&lt;/tt&gt; with &lt;tt&gt;OperatorCoordinator.subtaskRestored(int subtask, long checkpoint)&lt;/tt&gt;. That implementations get the explicit checkpoint ID for the subtask recovery, and can align that with the IDs of checkpoints that were taken.&lt;/p&gt;

&lt;p&gt;It is still (in rare cases) possible that for a specific checkpoint C, &lt;tt&gt;OperatorCoordinator.subtaskRestored(subtaskIndex, C))&lt;/tt&gt; comes before &lt;tt&gt;OperatorCoordinator.checkpointComplete(C)&lt;/tt&gt;.&lt;/p&gt;


&lt;h3&gt;&lt;a name=&quot;Background&quot;&gt;&lt;/a&gt;Background&lt;/h3&gt;

&lt;p&gt;The Checkpointing Procedure is partially asynchronous on the &lt;tt&gt;JobManager&lt;/tt&gt; / &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt;: After all subtasks acknowledged the checkpoint, the finalization (writing out metadata and registering the checkpoint in ZooKeeper) happens in an I/O thread, and the checkpoint completes after that.&lt;/p&gt;

&lt;p&gt;This sequence of events can happen:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;tasks acks checkpoint&lt;/li&gt;
	&lt;li&gt;checkpoint fully acknowledged, finalization starts&lt;/li&gt;
	&lt;li&gt;task fails&lt;/li&gt;
	&lt;li&gt;task failure notification is dispatched&lt;/li&gt;
	&lt;li&gt;checkpoint completes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For task failures and checkpoint completion, no order is defined.&lt;/p&gt;

&lt;p&gt;However, for task restore and checkpoint completion, the order is well defined: When a task is restored, pending checkpoints are either canceled or complete. None can be within finalization. That is currently guaranteed with a lock in the &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt;.&lt;br/&gt;
(An implication of that being that restores can be blocking operations in the scheduler, which is not ideal from the perspective of making the scheduler async/non-blocking, but it is currently essential for correctness).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13343003">FLINK-20396</key>
            <summary>Add &quot;OperatorCoordinator.resetSubtask()&quot; to fix order problems of &quot;subtaskFailed()&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 27 Nov 2020 14:14:03 +0000</created>
                <updated>Sat, 12 Dec 2020 11:58:14 +0000</updated>
                            <resolved>Mon, 30 Nov 2020 11:58:57 +0000</resolved>
                                    <version>1.11.2</version>
                                    <fixVersion>1.11.3</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                                                            <comments>
                            <comment id="17239774" author="stephanewen" created="Fri, 27 Nov 2020 16:43:01 +0000"  >&lt;p&gt;In the first version, I would add the &lt;tt&gt;subtaskReset()&lt;/tt&gt; method in addition to the &lt;tt&gt;subtaskFailed()&lt;/tt&gt; method because of two reasons:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;subtaskFailed()&lt;/tt&gt; can potentially do slightly faster cleanup (for example unregistering readers)&lt;/li&gt;
	&lt;li&gt;It is complex to communicate a failure cause to &lt;tt&gt;subtaskReset()&lt;/tt&gt;. If we want to make actions dependent on exception types, we need to handle that in the &lt;tt&gt;subtaskFailed()&lt;/tt&gt; method.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We can decide to remove &lt;tt&gt;subtaskFailed()&lt;/tt&gt; in the future, if we feel we don&apos;t need the slightly faster notification, or the failure reason.&lt;/p&gt;

&lt;p&gt;If we want to retain the failure reason, but do not care about the slightly faster notification, we can consolidate the two into a single method &lt;tt&gt;subtaskReset(int subtask, long checkpointId, Throwable failureCause);&lt;/tt&gt;.&lt;br/&gt;
The &lt;tt&gt;OperatorCoordinatorHolder&lt;/tt&gt; can remember the exceptions per subtask between failure and restore to pass them to the coordinator.&lt;br/&gt;
Because that needs potentially noticeably more heap memory (retain many exceptions with stack traces) I would suggest to do that change &quot;if needed&quot; and not immediately.&lt;/p&gt;</comment>
                            <comment id="17240708" author="stephanewen" created="Mon, 30 Nov 2020 11:58:57 +0000"  >&lt;p&gt;Fixed in&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1.12.0 (release-1.12) via bc870f66c9baf8ed0f36d75c27222a4a929428a0&lt;/li&gt;
	&lt;li&gt;1.13.0 (master) via 0ea11b854b3eff58e21983c95d06c425f3982ec1&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13343193">FLINK-20413</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="13343005">FLINK-20397</subtask>
                            <subtask id="13343043">FLINK-20406</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kzwo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>