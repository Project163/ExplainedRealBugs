<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:53:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21553] WindowDistinctAggregateITCase#testHopWindow_Cube is unstable</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21553</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;See &lt;a href=&quot;https://dev.azure.com/imjark/Flink/_build/results?buildId=422&amp;amp;view=logs&amp;amp;j=d1352042-8a7d-50b6-3946-a85d176b7981&amp;amp;t=b2322052-d503-5552-81e2-b3a532a1d7e8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/imjark/Flink/_build/results?buildId=422&amp;amp;view=logs&amp;amp;j=d1352042-8a7d-50b6-3946-a85d176b7981&amp;amp;t=b2322052-d503-5552-81e2-b3a532a1d7e8&lt;/a&gt;&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13021429/13021429_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</description>
                <environment></environment>
        <key id="13361759">FLINK-21553</key>
            <summary>WindowDistinctAggregateITCase#testHopWindow_Cube is unstable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jingzhang">Jing Zhang</assignee>
                                    <reporter username="jark">Jark Wu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Tue, 2 Mar 2021 06:40:37 +0000</created>
                <updated>Thu, 1 Apr 2021 15:10:57 +0000</updated>
                            <resolved>Thu, 4 Mar 2021 12:19:00 +0000</resolved>
                                                    <fixVersion>1.13.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17293993" author="dawidwys" created="Tue, 2 Mar 2021 21:25:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=14013&amp;amp;view=logs&amp;amp;j=e25d5e7e-2a9c-5589-4940-0b638d75a414&amp;amp;t=a6e0f756-5bb9-5ea8-a468-5f60db442a29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=14013&amp;amp;view=logs&amp;amp;j=e25d5e7e-2a9c-5589-4940-0b638d75a414&amp;amp;t=a6e0f756-5bb9-5ea8-a468-5f60db442a29&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17294240" author="qingru zhang" created="Wed, 3 Mar 2021 03:02:04 +0000"  >&lt;p&gt;Could you assign the issue to me ? I would like to find out the root cause.&lt;/p&gt;</comment>
                            <comment id="17294291" author="maguowei" created="Wed, 3 Mar 2021 05:47:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=14013&amp;amp;view=logs&amp;amp;j=e25d5e7e-2a9c-5589-4940-0b638d75a414&amp;amp;t=a6e0f756-5bb9-5ea8-a468-5f60db442a29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=14013&amp;amp;view=logs&amp;amp;j=e25d5e7e-2a9c-5589-4940-0b638d75a414&amp;amp;t=a6e0f756-5bb9-5ea8-a468-5f60db442a29&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17294354" author="dawidwys" created="Wed, 3 Mar 2021 07:54:08 +0000"  >&lt;p&gt;Is &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21482&quot; title=&quot;Support grouping set syntax for Window TVF based aggregation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21482&quot;&gt;&lt;del&gt;FLINK-21482&lt;/del&gt;&lt;/a&gt; the root cause? The test fails quite frequently. How do you feel about reverting the change?&lt;/p&gt;</comment>
                            <comment id="17294390" author="qingru zhang" created="Wed, 3 Mar 2021 08:58:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maguowei&quot; class=&quot;user-hover&quot; rel=&quot;maguowei&quot;&gt;maguowei&lt;/a&gt;,&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21482&quot; title=&quot;Support grouping set syntax for Window TVF based aggregation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21482&quot;&gt;&lt;del&gt;FLINK-21482&lt;/del&gt;&lt;/a&gt;&#160; is not the root cause, it does only fix a minor bug about WindowProperties inference about `Expand` node and add more test cases to cover groupsets/cube/rollup syntax in wtf. The unstable ITCase may reflect something went wrong in the physical operator. If the issue is a blocker, reverting the change is OK for me. I&#160;would continue to find root cause&#160;to prevent a deep bug in the Operator.&lt;/p&gt;</comment>
                            <comment id="17294421" author="dawidwys" created="Wed, 3 Mar 2021 09:38:09 +0000"  >&lt;p&gt;I mean if you are saying the &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21482&quot; title=&quot;Support grouping set syntax for Window TVF based aggregation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21482&quot;&gt;&lt;del&gt;FLINK-21482&lt;/del&gt;&lt;/a&gt; does not cause the test to fail it doesn&apos;t make sense to revert it.&lt;/p&gt;</comment>
                            <comment id="17294544" author="jark" created="Wed, 3 Mar 2021 14:05:38 +0000"  >&lt;p&gt;We can disable this test temporarily if it fails frequently.&lt;/p&gt;</comment>
                            <comment id="17294981" author="qingru zhang" created="Thu, 4 Mar 2021 04:10:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guoweima&quot; class=&quot;user-hover&quot; rel=&quot;guoweima&quot;&gt;guoweima&lt;/a&gt;&#160;Now when flush buffer to state, `CombineRecordsFunction` only copy window key because window key is reused. However, it forgets to copy record which is also reused. I think it&apos;s the root cause of the failure case. For above failed case, there exists `count(distinct distinctKey)` in sql,&#160;&#160;distinctKey is the UK of MapState. If pushed object directly to&#160; state when flush buffer to state, it may be updated after it is pushed into HeapStateBackend because it is a reused object in `AbstractBytesMultiMap`.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//&#20195;&#30721;&#21344;&#20301;&#31526;
&lt;/span&gt;@Test
def testHopWindow_Cube(): Unit = {
  &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.codehaus.janino.source_debugging.enable&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
  &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.codehaus.janino.source_debugging.dir&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;/Users/zhangjing/IdeaProjects/flink/flink-table/flink-table-planner-blink/src/main/java&quot;&lt;/span&gt;)
  val inputData: Seq[Row] = List(
    row(&lt;span class=&quot;code-quote&quot;&gt;&quot;2020-10-10 00:00:01&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hi&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;),
    row(&lt;span class=&quot;code-quote&quot;&gt;&quot;2020-10-10 00:00:03&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Comment#1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;),
    row(&lt;span class=&quot;code-quote&quot;&gt;&quot;2020-10-10 00:00:04&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;),

    row(&lt;span class=&quot;code-quote&quot;&gt;&quot;2020-10-10 00:00:07&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;),
    row(&lt;span class=&quot;code-quote&quot;&gt;&quot;2020-10-10 00:00:06&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hi&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;), &lt;span class=&quot;code-comment&quot;&gt;// out of order
&lt;/span&gt;    row(&lt;span class=&quot;code-quote&quot;&gt;&quot;2020-10-10 00:00:08&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Comment#2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;)
  )
  val dataId = TestValuesTableFactory.registerData(inputData)
  tEnv.executeSql(
    s&quot;&quot;&quot;
       |CREATE TABLE T2 (
       | `ts` STRING,
       | `string` STRING,
       | `name` STRING,
       | `rowtime` AS TO_TIMESTAMP(`ts`),
       | WATERMARK &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; `rowtime` AS `rowtime` - INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; SECOND
       |) WITH (
       | &lt;span class=&quot;code-quote&quot;&gt;&apos;connector&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;values&apos;&lt;/span&gt;,
       | &lt;span class=&quot;code-quote&quot;&gt;&apos;data-id&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;$dataId&apos;&lt;/span&gt;,
       | &lt;span class=&quot;code-quote&quot;&gt;&apos;failing-source&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt;
       |)
       |&quot;&quot;&quot;.stripMargin)
  val sql =
    &quot;&quot;&quot;
      |SELECT
      |  GROUPING_ID(`name`),
      |  `name`,
      |  window_start,
      |  window_end,
      |  COUNT(DISTINCT `string`)
      |FROM TABLE(
      |   HOP(TABLE T2, DESCRIPTOR(rowtime), INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;5&apos;&lt;/span&gt; SECOND, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;10&apos;&lt;/span&gt; SECOND))
      |GROUP BY CUBE(`name`), window_start, window_end
    &quot;&quot;&quot;.stripMargin

  val sink = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TestingAppendSink
  tEnv.sqlQuery(sql).toAppendStream[Row].addSink(sink)
  env.execute()

  val data = Seq(
    &lt;span class=&quot;code-quote&quot;&gt;&quot;0,a,2020-10-09T23:59:55,2020-10-10T00:00:05,2&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;0,a,2020-10-10T00:00,2020-10-10T00:00:10,3&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;0,a,2020-10-10T00:00:05,2020-10-10T00:00:15,1&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;0,b,2020-10-10T00:00,2020-10-10T00:00:10,2&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;0,b,2020-10-10T00:00:05,2020-10-10T00:00:15,2&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;1,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,2020-10-09T23:59:55,2020-10-10T00:00:05,2&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;1,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,2020-10-10T00:00,2020-10-10T00:00:10,4&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;1,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,2020-10-10T00:00:05,2020-10-10T00:00:15,3&quot;&lt;/span&gt;
  )
  assertEquals(
    data.sorted.mkString(&lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt;),
    sink.getAppendResults.sorted.mkString(&lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt;))
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I simplify the failure case as above case, which could fails&#160;frequently (1 per 3~4 times based on &lt;b&gt;HeapStateBackend + SplitDistinct: false&lt;/b&gt;) on my local machine. The state in HeapStateBackend is following pic1 when test pass, while state are pic2 or pic3 when test failure.&lt;br/&gt;
 &#160;&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13021538/13021538_image-2021-03-04-12-05-59-802.png&quot; height=&quot;292&quot; width=&quot;1308&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13021539/13021539_image-2021-03-04-12-07-53-566.png&quot; height=&quot;361&quot; width=&quot;1420&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13021540/13021540_image-2021-03-04-12-08-07-097.png&quot; height=&quot;211&quot; width=&quot;1297&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
 &#160;&lt;br/&gt;
 After copy record, the case could always be passed.&lt;/p&gt;</comment>
                            <comment id="17295243" author="jark" created="Thu, 4 Mar 2021 12:19:00 +0000"  >&lt;p&gt;Fixed in master: 40e5c27b2d621a946a82a4371f829491d14f4c42&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13362011">FLINK-21574</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13021538" name="image-2021-03-04-12-05-59-802.png" size="466180" author="jingzhang" created="Thu, 4 Mar 2021 04:06:03 +0000"/>
                            <attachment id="13021539" name="image-2021-03-04-12-07-53-566.png" size="553863" author="jingzhang" created="Thu, 4 Mar 2021 04:07:54 +0000"/>
                            <attachment id="13021540" name="image-2021-03-04-12-08-07-097.png" size="339025" author="jingzhang" created="Thu, 4 Mar 2021 04:08:07 +0000"/>
                            <attachment id="13021429" name="screenshot-1.png" size="1463713" author="jark" created="Tue, 2 Mar 2021 06:41:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 36 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0o740:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>