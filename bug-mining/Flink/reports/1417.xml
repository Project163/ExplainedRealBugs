<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5394] the estimateRowCount method of DataSetCalc didn&apos;t work in TableAPI</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5394</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The estimateRowCount method of DataSetCalc didn&apos;t work now. &lt;br/&gt;
If I run the following code,&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Table table = tableEnv
  .fromDataSet(data, &lt;span class=&quot;code-quote&quot;&gt;&quot;a, b, c&quot;&lt;/span&gt;)
  .where(&lt;span class=&quot;code-quote&quot;&gt;&quot;a == 1&quot;&lt;/span&gt;)
  .groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;)
  .select(&lt;span class=&quot;code-quote&quot;&gt;&quot;a, a.avg, b.sum, c.count&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the cost of every node in Optimized node tree is :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DataSetAggregate(groupBy=[a], select=[a, AVG(a) AS TMP_0, SUM(b) AS TMP_1, COUNT(c) AS TMP_2]): rowcount = 1000.0, cumulative cost = {3000.0 rows, 5000.0 cpu, 28000.0 io}
  DataSetCalc(select=[a, b, c], where=[=(a, 1)]): rowcount = 1000.0, cumulative cost = {2000.0 rows, 2000.0 cpu, 0.0 io}
      DataSetScan(table=[[_DataSetTable_0]]): rowcount = 1000.0, cumulative cost = {1000.0 rows, 1000.0 cpu, 0.0 io}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We expect the input rowcount of DataSetAggregate less than 1000, however the actual input rowcount is still 1000 because the the estimateRowCount method of DataSetCalc didn&apos;t work. &lt;/p&gt;

&lt;p&gt;There are two reasons caused to this:&lt;br/&gt;
1. Didn&apos;t provide custom metadataProvider yet. So when DataSetAggregate calls RelMetadataQuery.getRowCount(DataSetCalc) to estimate its input rowcount which would dispatch to RelMdRowCount.&lt;br/&gt;
2. DataSetCalc is subclass of SingleRel. So previous function call would match getRowCount(SingleRel rel, RelMetadataQuery mq) which would never use DataSetCalc.estimateRowCount.&lt;/p&gt;

&lt;p&gt;The question would also appear to all Flink RelNodes which are subclass of SingleRel.&lt;/p&gt;

&lt;p&gt;I plan to resolve this problem by adding a FlinkRelMdRowCount which contains specific getRowCount of Flink RelNodes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13030674">FLINK-5394</key>
            <summary>the estimateRowCount method of DataSetCalc didn&apos;t work in TableAPI</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jingzhang">Jing Zhang</assignee>
                                    <reporter username="jingzhang">Jing Zhang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Dec 2016 11:05:55 +0000</created>
                <updated>Thu, 27 Jan 2022 17:43:56 +0000</updated>
                            <resolved>Tue, 17 Jan 2017 11:58:50 +0000</resolved>
                                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                                                            <comments>
                            <comment id="15797712" author="githubbot" created="Wed, 4 Jan 2017 09:11:45 +0000"  >&lt;p&gt;GitHub user beyond1920 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5394&quot; title=&quot;the estimateRowCount method of DataSetCalc didn&amp;#39;t work in TableAPI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5394&quot;&gt;&lt;del&gt;FLINK-5394&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Table API &amp;amp; SQL&amp;#93;&lt;/span&gt;the estimateRowCount method of DataSetCalc didn&apos;t work&lt;/p&gt;

&lt;p&gt;    This pr aims to fix a bug which is referenced by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5394&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-5394&lt;/a&gt;.&lt;br/&gt;
    The main changes including:&lt;br/&gt;
    1. add FlinkRelMdRowCount and  FlinkDefaultRelMetadataProvider to override getRowCount  of some Flink RelNodes&lt;br/&gt;
    2. add getRowCount method in DatasetSort to provide more accurate estimate&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/alibaba/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/alibaba/flink&lt;/a&gt; flink-5394&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3058.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3058.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3058&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 8099920fb8759ed1068e7b8153816a7b63089e45&lt;br/&gt;
Author: beyond1920 &amp;lt;beyond1920@126.com&amp;gt;&lt;br/&gt;
Date:   2016-12-29T07:52:17Z&lt;/p&gt;

&lt;p&gt;    the estimateRowCount method of DataSetCalc didn&apos;t work now, fix it&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15815100" author="githubbot" created="Tue, 10 Jan 2017 14:28:53 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3058#discussion_r95372931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3058#discussion_r95372931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/dataset/DataSetSort.scala &amp;#8212;&lt;br/&gt;
    @@ -71,6 +72,21 @@ class DataSetSort(&lt;br/&gt;
         )&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;    +  override def estimateRowCount(metadata: RelMetadataQuery): Double = {&lt;br/&gt;
    +    val inputRowCnt = metadata.getRowCount(this.getInput)&lt;br/&gt;
    +    if (inputRowCnt == null) &lt;/p&gt;
{
    +      inputRowCnt
    +    }
&lt;p&gt; else {&lt;br/&gt;
    +      val rowCount = Math.max(inputRowCnt - limitStart, 0D)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Returning a cardinality estimate of `0` is not a good idea because all remaining operations might appear to have no costs at all. Rather be conservative and return `1` which is still low but does not invalidate any subsequent costs.&lt;/p&gt;</comment>
                            <comment id="15821535" author="githubbot" created="Fri, 13 Jan 2017 10:03:48 +0000"  >&lt;p&gt;Github user beyond1920 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3058#discussion_r95967156&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3058#discussion_r95967156&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/dataset/DataSetSort.scala &amp;#8212;&lt;br/&gt;
    @@ -71,6 +72,21 @@ class DataSetSort(&lt;br/&gt;
         )&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;    +  override def estimateRowCount(metadata: RelMetadataQuery): Double = {&lt;br/&gt;
    +    val inputRowCnt = metadata.getRowCount(this.getInput)&lt;br/&gt;
    +    if (inputRowCnt == null) &lt;/p&gt;
{
    +      inputRowCnt
    +    }
&lt;p&gt; else {&lt;br/&gt;
    +      val rowCount = Math.max(inputRowCnt - limitStart, 0D)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Hmm, the estimation 0 only  happens if inputRowCount &amp;lt;= start and (fetch  is null or fetchValue&amp;lt;=0). I think this estimation is reasonable in this case.  Besides, why choose return 1 instead of 0.1 or 0.01 or other values?&lt;/p&gt;</comment>
                            <comment id="15821550" author="githubbot" created="Fri, 13 Jan 2017 10:14:18 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3058#discussion_r95968750&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3058#discussion_r95968750&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/dataset/DataSetSort.scala &amp;#8212;&lt;br/&gt;
    @@ -71,6 +72,21 @@ class DataSetSort(&lt;br/&gt;
         )&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;    +  override def estimateRowCount(metadata: RelMetadataQuery): Double = {&lt;br/&gt;
    +    val inputRowCnt = metadata.getRowCount(this.getInput)&lt;br/&gt;
    +    if (inputRowCnt == null) &lt;/p&gt;
{
    +      inputRowCnt
    +    }
&lt;p&gt; else {&lt;br/&gt;
    +      val rowCount = Math.max(inputRowCnt - limitStart, 0D)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    inputRowCount might also just be an estimate and not guaranteed to be precise. Returning 1 is more robust, because it does not result in no-cost operators downstream.&lt;/p&gt;</comment>
                            <comment id="15822763" author="githubbot" created="Sat, 14 Jan 2017 09:05:49 +0000"  >&lt;p&gt;Github user beyond1920 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3058#discussion_r96112195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3058#discussion_r96112195&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/dataset/DataSetSort.scala &amp;#8212;&lt;br/&gt;
    @@ -71,6 +72,21 @@ class DataSetSort(&lt;br/&gt;
         )&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;    +  override def estimateRowCount(metadata: RelMetadataQuery): Double = {&lt;br/&gt;
    +    val inputRowCnt = metadata.getRowCount(this.getInput)&lt;br/&gt;
    +    if (inputRowCnt == null) &lt;/p&gt;
{
    +      inputRowCnt
    +    }
&lt;p&gt; else {&lt;br/&gt;
    +      val rowCount = Math.max(inputRowCnt - limitStart, 0D)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes, that make sense.  I already fix it. Thanks @fhueske .&lt;/p&gt;</comment>
                            <comment id="15824320" author="githubbot" created="Mon, 16 Jan 2017 17:18:55 +0000"  >&lt;p&gt;Github user twalthr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I will also look at it tomorrow.&lt;/p&gt;</comment>
                            <comment id="15825846" author="githubbot" created="Tue, 17 Jan 2017 10:58:57 +0000"  >&lt;p&gt;Github user twalthr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I have no objections. I will merge this.&lt;/p&gt;</comment>
                            <comment id="15825849" author="githubbot" created="Tue, 17 Jan 2017 11:00:15 +0000"  >&lt;p&gt;Github user fhueske commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    cool, thanks @twalthr &lt;/p&gt;</comment>
                            <comment id="15825937" author="githubbot" created="Tue, 17 Jan 2017 11:55:19 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3058&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15825942" author="twalthr" created="Tue, 17 Jan 2017 11:58:50 +0000"  >&lt;p&gt;Fixed in 1.3.0: b1913a4af5ff5794629e66e2f4b0d26054d3fc29&lt;br/&gt;
Fixed in 1.2.0: 02b0e65034cb74944aebff33d44470483a5f26e7&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="13055843">FLINK-6037</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3818f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>