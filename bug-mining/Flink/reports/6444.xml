<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:10:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-27420] Suspended SlotManager fails to re-register metrics when started again</title>
                <link>https://issues.apache.org/jira/browse/FLINK-27420</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The symptom is that SlotManager metrics are missing (taskslotsavailable and taskslotstotal) when a SlotManager is suspended and then restarted. We noticed this issue when running 1.13.5, but I believe this impacts 1.14.x, 1.15.x, and master.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When a SlotManager is suspended, the &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/slotmanager/DeclarativeSlotManager.java#L214&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;metrics group is closed&lt;/a&gt;. When the SlotManager is &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/slotmanager/DeclarativeSlotManager.java#L181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;started again&lt;/a&gt;, it makes an attempt to &lt;a href=&quot;#L199-L202],&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;reregister metrics&lt;/a&gt; but that fails because the underlying metrics group &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroup.java#L393&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;is still closed&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I was able to trace through this issue by restarting zookeeper nodes in a staging environment and watching the JM with a debugger.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;A concise test, which currently fails, shows the expected behavior &#8211; &lt;a href=&quot;https://github.com/apache/flink/compare/master...baugarten:baugarten/slot-manager-missing-metrics?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/compare/master...baugarten:baugarten/slot-manager-missing-metrics?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am happy to provide a PR to fix this issue, but first would like to verify that this is not intended.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13441896">FLINK-27420</key>
            <summary>Suspended SlotManager fails to re-register metrics when started again</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="baugarten">Ben Augarten</assignee>
                                    <reporter username="baugarten">Ben Augarten</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 26 Apr 2022 20:17:47 +0000</created>
                <updated>Mon, 20 Jun 2022 09:55:43 +0000</updated>
                            <resolved>Mon, 20 Jun 2022 09:55:43 +0000</resolved>
                                    <version>1.13.5</version>
                                    <fixVersion>1.14.5</fixVersion>
                    <fixVersion>1.15.1</fixVersion>
                    <fixVersion>1.16.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                    <component>Runtime / Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17528478" author="maguowei" created="Wed, 27 Apr 2022 01:48:32 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baugarten&quot; class=&quot;user-hover&quot; rel=&quot;baugarten&quot;&gt;baugarten&lt;/a&gt; for reporting this. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xtsong&quot; class=&quot;user-hover&quot; rel=&quot;xtsong&quot;&gt;xtsong&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17528495" author="xintongsong" created="Wed, 27 Apr 2022 02:55:34 +0000"  >&lt;p&gt;Thanks for reporting this, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baugarten&quot; class=&quot;user-hover&quot; rel=&quot;baugarten&quot;&gt;baugarten&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This is indeed a valid issue. I&apos;d like to add a bit more clarification.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;For 1.13, I don&apos;t think it is supported for the JM process to live through multiple leader sessions, i.e. being revoked and re-granted leadership without failing the process. I know some of the codes look like it is supported, but unfortunately it never really worked until &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23240&quot; title=&quot;ResumeCheckpointManuallyITCase.testExternalizedFSCheckpointsWithLocalRecoveryZookeeper fails on azure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23240&quot;&gt;&lt;del&gt;FLINK-23240&lt;/del&gt;&lt;/a&gt; which is fixed in 1.14.4.&lt;/li&gt;
	&lt;li&gt;For 1.14 &amp;amp; 1.15, yes, the issue still exist. Since 1.14, for each leader session we create a new ResourceManager instance. However, some of the components and services are preserved in &lt;tt&gt;ResourceManagerProcessContext&lt;/tt&gt; and are reused across multiple RM instances. If these components / services are closed, they need to be restarted properly. I&apos;ve checked the current implementation, and it seems the only things that are affected are &lt;tt&gt;resourceManagerMetricGroup&lt;/tt&gt; and &lt;tt&gt;slotManagerMetricGroup&lt;/tt&gt;. I think the easiest way to fix this is probably to store &lt;tt&gt;metricRegistry&lt;/tt&gt; rather than the metric groups in &lt;tt&gt;ResourceManagerProcessContext&lt;/tt&gt;, so that we can create new metric group instances for each leader session.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="17529041" author="baugarten" created="Wed, 27 Apr 2022 20:26:19 +0000"  >&lt;p&gt;Thanks for adding that context!&lt;/p&gt;

&lt;p&gt;For 1.14 &amp;amp; 1.15, I looked through the implementation of `ResourceManagerServiceImpl`, which seems to be new in 1.14, and I follow what you&apos;re saying. I agree that the `resourceManagerMetricGroup` and `slotManagerMetricGroup` are the only metrics affected and that storing the `metricRegistry` (and `hostname`, which is required to create the metric group) and creating the metric group with each new leader session makes the most sense. I can start on this change and could post a PR tomorrow during US working hours.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m not sure I follow your point about 1.13 though. I currently run 1.13 in standalone, session mode and the JM process does seem to live through multiple leader sessions. Regardless, my understanding is that Flink only supports the latest two versions, which would be 1.14 and 1.15, so a patch for 1.13 is not desired &#8211; is that correct?&lt;/p&gt;</comment>
                            <comment id="17529153" author="xintongsong" created="Thu, 28 Apr 2022 02:17:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baugarten&quot; class=&quot;user-hover&quot; rel=&quot;baugarten&quot;&gt;baugarten&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for volunteering to fix this. I&apos;ve assigned you to this ticket.&lt;/p&gt;

&lt;p&gt;Regarding 1.13, I&apos;m surprised that you have the JM process live through multiple leader sessions. IIRC, we had tried it before making the changes in 1.14, and JM process was terminated after losing the leadership. Unfortunately I cannot recall more details about how it was terminated. Anyway, if that works for you, I&apos;d be fine with also fixing this for 1.13.&lt;/p&gt;

&lt;p&gt;According to the &lt;a href=&quot;https://flink.apache.org/downloads.html#update-policy-for-old-releases&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Update Policy for old releases&lt;/a&gt;, the Flink community provides supports for the latest 2 versions, but is also open to discussing bugfix releases for older versions. Actually, it is not rare that we ship bugfix release for the 3rd latest version. To sum up, although I don&apos;t know whether (and when) there will be a next bugfix release for 1.13.x, I would not consider a patch for 1.13 is not desired.&lt;/p&gt;</comment>
                            <comment id="17529741" author="baugarten" created="Fri, 29 Apr 2022 03:32:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xtsong&quot; class=&quot;user-hover&quot; rel=&quot;xtsong&quot;&gt;xtsong&lt;/a&gt; &#8211; thanks, I posted a PR against master here: &lt;a href=&quot;https://github.com/apache/flink/pull/19607&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/19607&lt;/a&gt;. Let me know if you&apos;d like any changes to the PR and I&apos;m happy to make them. I can post PRs against release-1.14 and release-1.15 after.&lt;/p&gt;

&lt;p&gt;That&apos;s good to know that there might be another bugfix release for 1.13.x. I&apos;m going to work on a patch for 1.13 as well because most of our applications run on 1.13.&lt;/p&gt;</comment>
                            <comment id="17529866" author="xintongsong" created="Fri, 29 Apr 2022 08:48:24 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;master (1.16): 525e3170c622da65becfab3e8afe97303b07b7db&lt;/li&gt;
	&lt;li&gt;release-1.15: &lt;del&gt;e0c82d6d52871dbbea70c9b41384d2d33179bec0&lt;/del&gt; fbc8e460cd0f80ecb4387855ab982d896e95af3b&lt;/li&gt;
	&lt;li&gt;release-1.14: &lt;del&gt;054b59bb97d14e453745e18f8d9cc90b109bb33a&lt;/del&gt; ff060543bc8867bdc97e4c3138c4999894f2909e&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Leave the ticket open to fix for 1.13&lt;/p&gt;</comment>
                            <comment id="17531039" author="gaoyunhaii" created="Tue, 3 May 2022 05:04:55 +0000"  >&lt;p&gt;Hi, I&apos;ll first revert the commits on 1.15 and 1.14 since they fails the compilations. Let&apos;s have a double check and re-merge the commit. &lt;/p&gt;</comment>
                            <comment id="17531222" author="nicolaus weidner" created="Tue, 3 May 2022 14:25:37 +0000"  >&lt;p&gt;Looks fine on master, but in the backports, a test was backported without checking that the same variables are available. E.g. on release-1.15,  delegationTokenManager is undefined: &lt;a href=&quot;https://github.com/apache/flink/blob/e0c82d6d52871dbbea70c9b41384d2d33179bec0/flink-runtime/src/test/java/org/apache/flink/runtime/resourcemanager/ResourceManagerServiceImplTest.java#L520&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/e0c82d6d52871dbbea70c9b41384d2d33179bec0/flink-runtime/src/test/java/org/apache/flink/runtime/resourcemanager/ResourceManagerServiceImplTest.java#L520&lt;/a&gt;. It was added in this commit: &lt;a href=&quot;https://github.com/apache/flink/commit/26aa543b3bbe2b606bbc6d332a2ef7c5b46d25eb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/26aa543b3bbe2b606bbc6d332a2ef7c5b46d25eb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I didn&apos;t check for the specific issue on release-1.14&lt;/p&gt;</comment>
                            <comment id="17532016" author="xintongsong" created="Thu, 5 May 2022 03:27:30 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; for fixing the broken branches, and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Nicolaus+Weidner&quot; class=&quot;user-hover&quot; rel=&quot;Nicolaus Weidner&quot;&gt;Nicolaus Weidner&lt;/a&gt; for looking into this.&lt;/p&gt;

&lt;p&gt;I noticed that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baugarten&quot; class=&quot;user-hover&quot; rel=&quot;baugarten&quot;&gt;baugarten&lt;/a&gt; has already opened a new PR for the 1.15 &amp;amp; 1.14 branches. I&apos;ll help with finalizing the PR.&lt;/p&gt;</comment>
                            <comment id="17554569" author="danderson" created="Wed, 15 Jun 2022 12:52:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xtsong&quot; class=&quot;user-hover&quot; rel=&quot;xtsong&quot;&gt;xtsong&lt;/a&gt; What&apos;s the status here? Do you want to finalize this for 1.15.1? I don&apos;t intend to block the release on it, but we are waiting on something else at the moment.&lt;/p&gt;</comment>
                            <comment id="17554582" author="xintongsong" created="Wed, 15 Jun 2022 13:06:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danderson&quot; class=&quot;user-hover&quot; rel=&quot;danderson&quot;&gt;danderson&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;This has already been fixed for:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;master (1.16.0): 525e3170c622da65becfab3e8afe97303b07b7db&lt;/li&gt;
	&lt;li&gt;1.15.1: fbc8e460cd0f80ecb4387855ab982d896e95af3b&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The ticket is kept open for 1.13 &amp;amp; 1.14, where the current patch does not apply.&lt;/p&gt;</comment>
                            <comment id="17554587" author="xintongsong" created="Wed, 15 Jun 2022 13:13:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baugarten&quot; class=&quot;user-hover&quot; rel=&quot;baugarten&quot;&gt;baugarten&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Are you still going to work on this? If you don&apos;t have the time, I can take it over and fix for 1.14. I&apos;ll probably leave it as is for 1.13.&lt;/p&gt;</comment>
                            <comment id="17556303" author="xintongsong" created="Mon, 20 Jun 2022 09:55:43 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;master (1.16): 525e3170c622da65becfab3e8afe97303b07b7db&lt;/li&gt;
	&lt;li&gt;release-1.15: fbc8e460cd0f80ecb4387855ab982d896e95af3b&lt;/li&gt;
	&lt;li&gt;release-1.14: ff060543bc8867bdc97e4c3138c4999894f2909e&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z11ubk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>