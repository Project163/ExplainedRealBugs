<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9287] KafkaProducer011 seems to leak threads when not in exactly-once mode</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9287</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;tt&gt;KafkaProducer011&lt;/tt&gt; appears to be leaking &lt;tt&gt;kafka-producer-network-thread&lt;/tt&gt; threads.&#160; As far as I can tell it happens when it is not in EXACTLY_ONCE mode, it seems that it creates a &lt;tt&gt;FlinkKafkaProducer&lt;/tt&gt;&#160;but never closes it, even when the &lt;tt&gt;FlinkKafkaProducer011&lt;/tt&gt; itself is closed.&lt;/p&gt;

&lt;p&gt;I observed this when running a local cluster and submitting and then cancelling a job, a lot of kafka threads were left alive afterwards.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13156564">FLINK-9287</key>
            <summary>KafkaProducer011 seems to leak threads when not in exactly-once mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="facboy">Christopher Ng</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 May 2018 10:41:46 +0000</created>
                <updated>Mon, 7 May 2018 07:50:48 +0000</updated>
                            <resolved>Mon, 7 May 2018 06:29:58 +0000</resolved>
                                    <version>1.4.2</version>
                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16461158" author="pnowojski" created="Wed, 2 May 2018 15:16:28 +0000"  >&lt;p&gt;Yes, indeed there is such bug. The problem boils down to &lt;tt&gt;org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer011#abort&lt;/tt&gt;&#160;being used for both aborting transactions and closing them at the end of the operator&apos;s lifecycle. For&#160;EXACTLY_ONCE in both cases we should be closing &lt;tt&gt;FlinkKafkaProducer&lt;/tt&gt;&#160;but for AT_LEAST_ONCE and NONE we should be closing them only during operator close - which is not happening.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure, but maybe we should split&#160;EXACTLY_ONCE and NON-EXACTLY_ONCE implementations, instead of trying to squeeze in both of them at the same time into one class. &lt;/p&gt;

&lt;p&gt;CC:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16462480" author="githubbot" created="Thu, 3 May 2018 13:58:22 +0000"  >&lt;p&gt;GitHub user pnowojski opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5952&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5952&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9287&quot; title=&quot;KafkaProducer011 seems to leak threads when not in exactly-once mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9287&quot;&gt;&lt;del&gt;FLINK-9287&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Properly clean up resources in non EXACTLY_ONCE FlinkKafkaProducer011&lt;/p&gt;

&lt;p&gt;    Previously FlinkKafkaProducer was not being closed for AT_LEAST_ONCE and NONE Semantics when closing FlinkKafkaProducer011. This was leading to resources leaking (for example increasing number of active threads). &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This bug fix might be hard to test automatically. This PR adds a new test proposal in separate commit, however it might be flaky if there are other tests being executed in parallel.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/pnowojski/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pnowojski/flink&lt;/a&gt; f9287&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5952.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5952.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5952&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c9139a90dd6a2afb25a4eb3102e1abedf90d8f5f&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@...&amp;gt;&lt;br/&gt;
Date:   2018-05-03T13:50:53Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9287&quot; title=&quot;KafkaProducer011 seems to leak threads when not in exactly-once mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9287&quot;&gt;&lt;del&gt;FLINK-9287&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Properly clean up resources in non EXACTLY_ONCE FlinkKafkaProducer011&lt;/p&gt;

&lt;p&gt;    Previously FlinkKafkaProducer was not being closed for AT_LEAST_ONCE and NONE Semantics&lt;br/&gt;
    when closing FlinkKafkaProducer011. This was leading to resources leaking (for example&lt;br/&gt;
    increasing number of active threads)&lt;/p&gt;

&lt;p&gt;commit 5a1d0962f3fb92a87ee809b5a09106f5c4d05caf&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@...&amp;gt;&lt;br/&gt;
Date:   2018-05-03T13:53:40Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9287&quot; title=&quot;KafkaProducer011 seems to leak threads when not in exactly-once mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9287&quot;&gt;&lt;del&gt;FLINK-9287&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Ensure threads count do not grow in FlinkKafkaProducer011&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16463519" author="githubbot" created="Fri, 4 May 2018 07:59:05 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5952&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5952&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Would filtering the thread count by thread name be helpful here?&lt;/p&gt;

&lt;p&gt;    Another possible approach to test this:&lt;br/&gt;
    Maybe we can simply verify that the current transaction producer is closed after the cleanup?&lt;br/&gt;
    This would require making the `getCurrentTransaction()` method visible for tests, though. We&apos;ll also need to have a `isClosed()` method on the `FlinkKafkaProducer`.&lt;/p&gt;</comment>
                            <comment id="16465348" author="githubbot" created="Mon, 7 May 2018 01:41:21 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5952&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5952&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    As discussed offline, both approaches I mentioned wouldn&apos;t seem to work.&lt;br/&gt;
    I&apos;ll merge as is, let&apos;s keep an eye on it to see if the test is flaky.&lt;/p&gt;</comment>
                            <comment id="16465485" author="githubbot" created="Mon, 7 May 2018 06:28:48 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5952&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5952&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16465486" author="tzulitai" created="Mon, 7 May 2018 06:29:51 +0000"  >&lt;p&gt;Merged.&lt;/p&gt;

&lt;p&gt;1.6.0:&#160;c8657bf9dee23bc13a281423284644013de9b850&lt;br/&gt;
1.5.0:&#160;a1ca628a031d658c1cc33037ede7aa92d93814f7&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 28 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3t947:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>