<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:56:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18071] CoordinatorEventsExactlyOnceITCase.checkListContainsSequence fails on CI</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18071</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;CI: &lt;a href=&quot;https://dev.azure.com/georgeryan1322/Flink/_build/results?buildId=330&amp;amp;view=logs&amp;amp;j=6e58d712-c5cc-52fb-0895-6ff7bd56c46b&amp;amp;t=f30a8e80-b2cf-535c-9952-7f521a4ae374&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/georgeryan1322/Flink/_build/results?buildId=330&amp;amp;view=logs&amp;amp;j=6e58d712-c5cc-52fb-0895-6ff7bd56c46b&amp;amp;t=f30a8e80-b2cf-535c-9952-7f521a4ae374&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[ERROR] Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 8.795 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.flink.runtime.operators.coordination.CoordinatorEventsExactlyOnceITCase
[ERROR] test(org.apache.flink.runtime.operators.coordination.CoordinatorEventsExactlyOnceITCase)  Time elapsed: 4.647 s  &amp;lt;&amp;lt;&amp;lt; FAILURE!
java.lang.AssertionError: List did not contain expected sequence of 200 elements, but was: [152, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199]
	at org.junit.Assert.fail(Assert.java:88)
	at org.apache.flink.runtime.operators.coordination.CoordinatorEventsExactlyOnceITCase.failList(CoordinatorEventsExactlyOnceITCase.java:160)
	at org.apache.flink.runtime.operators.coordination.CoordinatorEventsExactlyOnceITCase.checkListContainsSequence(CoordinatorEventsExactlyOnceITCase.java:148)
	at org.apache.flink.runtime.operators.coordination.CoordinatorEventsExactlyOnceITCase.test(CoordinatorEventsExactlyOnceITCase.java:143)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13308969">FLINK-18071</key>
            <summary>CoordinatorEventsExactlyOnceITCase.checkListContainsSequence fails on CI</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Tue, 2 Jun 2020 14:45:05 +0000</created>
                <updated>Fri, 28 May 2021 09:08:55 +0000</updated>
                            <resolved>Fri, 16 Apr 2021 15:05:31 +0000</resolved>
                                    <version>1.11.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                    <fixVersion>1.12.3</fixVersion>
                                    <component>Runtime / Coordination</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17124615" author="rmetzger" created="Wed, 3 Jun 2020 05:38:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=2587&amp;amp;view=logs&amp;amp;j=6bfdaf55-0c08-5e3f-a2d2-2a0285fd41cf&amp;amp;t=93018cfc-6498-565b-e034-4b68eb90fc80&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=2587&amp;amp;view=logs&amp;amp;j=6bfdaf55-0c08-5e3f-a2d2-2a0285fd41cf&amp;amp;t=93018cfc-6498-565b-e034-4b68eb90fc80&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17125842" author="rmetzger" created="Thu, 4 Jun 2020 11:22:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=2697&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=4ed44b66-cdd6-5dcf-5f6a-88b07dda665d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=2697&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=4ed44b66-cdd6-5dcf-5f6a-88b07dda665d&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17128011" author="stephanewen" created="Mon, 8 Jun 2020 08:21:10 +0000"  >&lt;p&gt;I can take a look at this later in the week. I think I know already where this comes from.&lt;/p&gt;</comment>
                            <comment id="17128338" author="gaoyunhaii" created="Mon, 8 Jun 2020 14:21:10 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;, I also debugged the case today, it seems come from the concurrency between the timer thread to send event and the thread to reset the buffered events. The timer thread may scheduling the event sending, but before the sending finished, failover happens and another thread called resetForTask and cleared the buffered events. However, the first thread will be awaked later and continue to send the outdated event, which will be inserted to the valve buffers and cause repeat.&lt;/p&gt;</comment>
                            <comment id="17128798" author="yunta" created="Tue, 9 Jun 2020 02:51:30 +0000"  >&lt;p&gt;Another instance: &lt;a href=&quot;https://myasuka.visualstudio.com/flink/_build/results?buildId=93&amp;amp;view=logs&amp;amp;j=6e58d712-c5cc-52fb-0895-6ff7bd56c46b&amp;amp;t=e3cf9aa2-7cef-56d5-4b97-323ea6f63062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://myasuka.visualstudio.com/flink/_build/results?buildId=93&amp;amp;view=logs&amp;amp;j=6e58d712-c5cc-52fb-0895-6ff7bd56c46b&amp;amp;t=e3cf9aa2-7cef-56d5-4b97-323ea6f63062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17138314" author="rmetzger" created="Wed, 17 Jun 2020 10:16:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/rmetzger/Flink/_build/results?buildId=8175&amp;amp;view=logs&amp;amp;j=d32c604a-b7f9-5ba5-2c7b-abfbb079eb71&amp;amp;t=33e2a6e6-1879-5933-d255-52ddc890fe5b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/rmetzger/Flink/_build/results?buildId=8175&amp;amp;view=logs&amp;amp;j=d32c604a-b7f9-5ba5-2c7b-abfbb079eb71&amp;amp;t=33e2a6e6-1879-5933-d255-52ddc890fe5b&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17139355" author="stephanewen" created="Thu, 18 Jun 2020 11:53:45 +0000"  >&lt;p&gt;What do you think about ignoring this test temporarily?&lt;/p&gt;

&lt;p&gt;The reason is that this is most likely not a test instability, but there are some corner-case race conditions in the &quot;exactly-once&quot; communication between Operator Coordinator and Operator.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jqin&quot; class=&quot;user-hover&quot; rel=&quot;jqin&quot;&gt;jqin&lt;/a&gt; and me have this on our radar and have a design for improvement, but the change is quite complex; it involves checking against versioning/attempt information of executions during message sending.&lt;br/&gt;
This change is a few weeks away and will only make it into 1.11.1 I believe.&lt;/p&gt;</comment>
                            <comment id="17139359" author="stephanewen" created="Thu, 18 Jun 2020 11:57:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; Yes, you diagnosis is correct. The events that linger in the sending thread cause the problem. A discussion between &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jqin&quot; class=&quot;user-hover&quot; rel=&quot;jqin&quot;&gt;jqin&lt;/a&gt; and me concluded that the &lt;tt&gt;contect.sendEvent()&lt;/tt&gt; (which is the synchronous part) needs to attach version information (similar to execution attempt number) so that we can filter out the event later.&lt;/p&gt;

&lt;p&gt;We are not 100% clear, though, on what exactly the contract is that we want to offer in the Operator Coordinator API. We would like to avoid that implementors need to check delivery status of events.&lt;/p&gt;</comment>
                            <comment id="17140482" author="gaoyunhaii" created="Fri, 19 Jun 2020 12:03:38 +0000"  >&lt;p&gt;+1 for that fixing this issue should provide a more easy-to-use interface for operator coordinator users, and attaching version information should be the right direction to fix this issue. &lt;/p&gt;</comment>
                            <comment id="17155081" author="jark" created="Fri, 10 Jul 2020 04:03:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt;, what&apos;s the status of this issue? Is this really a blocker of 1.11.1 release?&lt;/p&gt;</comment>
                            <comment id="17157087" author="dian.fu" created="Tue, 14 Jul 2020 02:35:06 +0000"  >&lt;p&gt;Also cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jqin&quot; class=&quot;user-hover&quot; rel=&quot;jqin&quot;&gt;jqin&lt;/a&gt;, could you help to confirm if this should be a blocker of 1.11.1? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jqin&quot; class=&quot;user-hover&quot; rel=&quot;jqin&quot;&gt;jqin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17157121" author="becket_qin" created="Tue, 14 Jul 2020 03:21:30 +0000"  >&lt;p&gt;It is a known caveat and may involve some major change in JM to fix. Impact wise, it is not that critical. Therefore let&apos;s not block on this issue. I&apos;ll move it to 1.11.2.&lt;/p&gt;</comment>
                            <comment id="17157122" author="dian.fu" created="Tue, 14 Jul 2020 03:23:26 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17221239" author="xintongsong" created="Tue, 27 Oct 2020 08:26:02 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hi folks,&lt;br/&gt;
Any updates on this issue? Should this be fixed in 1.11.3?&lt;/p&gt;</comment>
                            <comment id="17221314" author="stephanewen" created="Tue, 27 Oct 2020 10:51:54 +0000"  >&lt;p&gt;I&apos;ll try to get to this one towards end of this week.&lt;/p&gt;

&lt;p&gt;It would be great to fix it in 1.11.3, but not necessarily a blocker. I think this is a pretty rare race condition that needed quite some effort to provoke frequently in the tests.&lt;/p&gt;</comment>
                            <comment id="17222717" author="xintongsong" created="Thu, 29 Oct 2020 06:22:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; Thanks for the updates. Sounds good to me.&lt;/p&gt;</comment>
                            <comment id="17234196" author="xintongsong" created="Wed, 18 Nov 2020 02:59:45 +0000"  >&lt;p&gt;I&apos;m deferring the fix version to 1.11.4 for now. Will change it back if it makes the 1.11.3 release in the end.&lt;/p&gt;</comment>
                            <comment id="17309441" author="till.rohrmann" created="Fri, 26 Mar 2021 13:54:01 +0000"  >&lt;p&gt;Are there any plans to fix this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; for the upcoming release? If you don&apos;t intend to work on it, then please unassign yourself from the ticket.&lt;/p&gt;</comment>
                            <comment id="17310940" author="stephanewen" created="Mon, 29 Mar 2021 19:28:13 +0000"  >&lt;p&gt;Let me unassign myself for now.&lt;/p&gt;

&lt;p&gt;If anyone else would approach this issue, please share your thoughts here how to fix this before approaching this issue.&lt;br/&gt;
There may be a good solution for this as well by looking into using restoreTask notifications rather than taskFailure notifications, which have more well defined ordering with checkpoints. &lt;/p&gt;</comment>
                            <comment id="17314074" author="kezhuw" created="Fri, 2 Apr 2021 20:37:45 +0000"  >&lt;p&gt;Hi all, I dug and thought some time about this. I want to share what I got. I might be wrong though, forgive me then please.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Symptomcause&quot;&gt;&lt;/a&gt;Symptom cause&lt;/h4&gt;

&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; pointed out before, there are lingering sendings after &lt;tt&gt;resetToCheckpoint&lt;/tt&gt;. Adds following snippets to &lt;tt&gt;sendNextEvent&lt;/tt&gt; before event sending makes this test fails often.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// This will fails 749620d007e93a6fba6a7d9cb759ec68c7670b00 quite often.
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(50);

&lt;span class=&quot;code-comment&quot;&gt;// Following make it more often in 1.13 (ps. it is not that often without &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; comparing to above commit).
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (periodicTask == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;CoordinatorEventsExactlyOnceITCase&lt;/tt&gt; tests only global failover, but not region failover. So, a simple wrapper with &lt;tt&gt;RecreateOnResetOperatorCoordinator.Provider&lt;/tt&gt; (plus some minor changes) will pass this test.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Rootcause&quot;&gt;&lt;/a&gt;Root cause&lt;/h4&gt;

&lt;p&gt;Initially, I thought we might be able do something in runtime to guard this. But after tackling the code bit, I realized that it will be hard to guard region failover to achieve exactly once in current api:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Currently, events are sending through &lt;tt&gt;Context.sendEvent(OperatorEvent evt, int targetSubtask)&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Without strict promise from implementation of &lt;tt&gt;OperatorCoordinator&lt;/tt&gt;, possibility to sending event from old incarnation after failed/reset will not be zero.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;To achieve exactly once guarantee, we either have to enforce strict promise from implementation of &lt;tt&gt;OperatorCoordinator&lt;/tt&gt; or we need to change the api a bit to my knowledge. I don&apos;t think strict promise enforcement to implementation is a good choice, it is just too fragile when there are 100 different implementations and hard to figure out where bad things happen.&lt;/p&gt;

&lt;p&gt;For api changes, I draft followings:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Drop &lt;tt&gt;Context.sendEvent(OperatorEvent evt, int targetSubtask)&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Add &lt;tt&gt;void OperatorCoordinator#subtaskReady(int subtask, SubtaskContext context)&lt;/tt&gt;. This will be called just before first event from operator.&lt;/li&gt;
	&lt;li&gt;Main method of &lt;tt&gt;SubtaskContext&lt;/tt&gt; is &lt;tt&gt;CompletableFuture&amp;lt;Acknowledge&amp;gt; sendEvent(OperatorEvent evt) throws TaskNotRunningException&lt;/tt&gt;. This method will bind to single execution attempt. This guarantee that &lt;tt&gt;sendEvent&lt;/tt&gt; will not mess up multiple runs of task. &lt;tt&gt;SubtaskContext&lt;/tt&gt; could also extend from &lt;tt&gt;Context&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Explicit restriction: operator coordinator will not be able to send event to operator instance before ready. I don&apos;t see any reason to send event first from coordinator.&lt;/li&gt;
	&lt;li&gt;Optimization: quiesce &lt;tt&gt;SubtaskContext&lt;/tt&gt; on both global/region failure and fail sending after quiesced.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Squash all to one: add subtask readiness to operator coordinator and bind sending with single execution attempt after ready.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Otherthoughts&quot;&gt;&lt;/a&gt;Other thoughts&lt;/h4&gt;
&lt;p&gt;Currently, to create operator coordinator on &lt;tt&gt;resetToCheckpoint&lt;/tt&gt;, one has to extend &lt;tt&gt;RecreateOnResetOperatorCoordinator.Provider&lt;/tt&gt;. It is a bit verbose and less explicit in api. I suggest to add tag interfaces to let runtime wrapping providers from client side automatically. This also mean these tag interfaces will be part of coordinator api. Personally, I think recreating coordinator on reset is a bit simple to use especially for complex coordinator. I guess it might be worth to propagate that in api.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; What do you think ? There are might be other approaches to solve this. Glad to hear.&lt;/p&gt;</comment>
                            <comment id="17314987" author="kezhuw" created="Mon, 5 Apr 2021 17:24:22 +0000"  >&lt;p&gt;Hi all, I pushed a &#160;&lt;a href=&quot;https://github.com/kezhuw/flink/commits/FLINK-18071-operator-coordinator-subtask-context-poc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;poc branch&lt;/a&gt; for evaluation.&lt;/p&gt;

&lt;p&gt;I do mainly two things in that branch:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Add proposed readiness api. I changed to &lt;tt&gt;void OperatorCoordinator#subtaskReady(int subtask, SubtaskContext context, OperatorEvent event)&lt;/tt&gt;. I guess it could help for certain use cases.&lt;/li&gt;
	&lt;li&gt;Adjust and divide &lt;tt&gt;CoordinatorEventsExactlyOnceITCase&lt;/tt&gt; to &lt;tt&gt;CoordinatorEventsExactlyOnceUsingCoordinatorSendingITCase&lt;/tt&gt; and &lt;tt&gt;CoordinatorEventsExactlyOnceUsingSubtaskSendingITCase&lt;/tt&gt;. The only difference between the two is which method is used in sending operation. &lt;tt&gt;Context.sendEvent&lt;/tt&gt; fails constantly after elaborated sleep operation injected.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I am no sure whether it is fair for &lt;tt&gt;Context.sendEvent&lt;/tt&gt; in this poc test comparison. But it should demonstrate a bit that &lt;tt&gt;Context.sendEvent&lt;/tt&gt; is more error prone to use and will cost more attention from coordinator implementations.&lt;/p&gt;

&lt;p&gt;The key part in using &lt;tt&gt;SubtaskContext&lt;/tt&gt; is &quot;don&apos;t mess up old and new context&quot;. This might be relative easy to obey comparing to ensure no old sending incarnations given that blocking operations are restricted in fail/reset notification methods.&lt;/p&gt;

&lt;p&gt;I think &lt;tt&gt;SubtaskContext&lt;/tt&gt; might eliminate necessity of &lt;tt&gt;RecreateOnResetOperatorCoordinator.Provider&lt;/tt&gt; in some cases. Recreating is still more simple though.&lt;/p&gt;</comment>
                            <comment id="17316448" author="dawidwys" created="Wed, 7 Apr 2021 16:02:40 +0000"  >&lt;p&gt;Is there a committer that will have time in 1.13 to help get this ticket in? If not, can we move the fix version to the next release? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="17317534" author="stephanewen" created="Thu, 8 Apr 2021 22:42:44 +0000"  >&lt;p&gt;I am happy to shepherd this issue. I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; has a good idea for the fix. Regarding the release, I&apos;d say let&apos;s not block the release on this. It is a rare race that requires a join of multiple FLIP-27 sources to happen. Let fix it asap, but not block the release.&lt;/p&gt;

&lt;p&gt;I was thinking to fix it a bit different, but Kezhu&apos;s approach also looks very promising. I&apos;ll try to dig through this a bit and comment back tomorrow.&lt;/p&gt;
</comment>
                            <comment id="17318955" author="stephanewen" created="Mon, 12 Apr 2021 00:51:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; I adopted your ideas into my work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21996&quot; title=&quot;Transient RPC failure without TaskManager failure can lead to split assignment loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21996&quot;&gt;&lt;del&gt;FLINK-21996&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
The fix for that issue also needs exact matching of events to execution attempts, which the SubtaskGateway gives us.&lt;br/&gt;
I implemented it a bit different. The WIP branch is here, if you want to take a look: &lt;a href=&quot;https://github.com/StephanEwen/flink/commits/split_fix_2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StephanEwen/flink/commits/split_fix_2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17318962" author="kezhuw" created="Mon, 12 Apr 2021 01:44:06 +0000"  >&lt;p&gt;Sure, I will take a look at. Thanks for delivery. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17319171" author="stephanewen" created="Mon, 12 Apr 2021 08:52:18 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; for your comments on the code branch. There is an PR for the first set of commits, if you are interested. &lt;/p&gt;</comment>
                            <comment id="17320601" author="stephanewen" created="Tue, 13 Apr 2021 23:58:37 +0000"  >&lt;p&gt;I have a PR with a nice solution, and a strengthened test: &lt;a href=&quot;https://github.com/apache/flink/pull/15601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/15601&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The solution is partly based on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt;&apos;s proposal, with some adjustment, like decoupling the ready notifications from events sent by readers. I think the solution is pretty nice in the end (I am quite happy with the outcome now), I think it is a pretty simple model that gives you an intuitive model for consistency between the Coordinator&apos;s view of the world (running tasks) and the interaction with the world.&lt;/p&gt;

&lt;p&gt;That change is also a precondition for &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21996&quot; title=&quot;Transient RPC failure without TaskManager failure can lead to split assignment loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21996&quot;&gt;&lt;del&gt;FLINK-21996&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17323885" author="stephanewen" created="Fri, 16 Apr 2021 15:05:32 +0000"  >&lt;p&gt;Fixed in 1.13.0 via&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;4595ec755308ba0608910e67561ba9f7e6e00c43&lt;/li&gt;
	&lt;li&gt;07fc4477909b6ec2374cc38f8aa445ebfe6b3b4d&lt;/li&gt;
	&lt;li&gt;605d158f013ba0fd43fa0ae68b8936b9288ac715&lt;/li&gt;
	&lt;li&gt;58c5e8c3cc43ddaee0fa63b8fb209eb2a4006eb7&lt;/li&gt;
	&lt;li&gt;4b51987321ac75a936e0e6e3389c5288b2c2c205&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17325739" author="stephanewen" created="Tue, 20 Apr 2021 12:09:43 +0000"  >&lt;p&gt;Fixed in 1.12.3 via&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;33bb107fa5e3a6aaa8800a41b97eaac677399109&lt;/li&gt;
	&lt;li&gt;bafdebd6d73f0268f0657a3265d142bd9de27c93&lt;/li&gt;
	&lt;li&gt;52e52a67c8a8b13b0fce4b6cc9954632b41a93e4&lt;/li&gt;
	&lt;li&gt;207e25516fa66cc56457dbecaffd15ed0d515e34&lt;/li&gt;
	&lt;li&gt;d2f5df3e7383733a1f291f6f7fd3ba23ccea79e1&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13367996">FLINK-21996</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13372021">FLINK-22259</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13309445">FLINK-18128</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ffeg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>