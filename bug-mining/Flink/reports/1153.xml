<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:24:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4021] Problem of setting autoread for netty channel when more tasks sharing the same Tcp connection</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4021</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;More than one task sharing the same Tcp connection for shuffling data.&lt;br/&gt;
If the downstream task said as &quot;A&quot; has no available memory segment to read netty buffer from network, it will set autoread as false for the channel.&lt;br/&gt;
When the task A is failed or has available segments again, the netty handler will be notified to process the staging buffers first, then reset autoread as true. But in some scenarios, the autoread will not be set as true any more.&lt;br/&gt;
That is when processing staging buffers, first find the corresponding input channel for the buffer, if the task for that input channel is failed, the decodeMsg method in PartitionRequestClientHandler will return false, that means setting autoread as true will not be done anymore.&lt;br/&gt;
In summary,  if one task &quot;A&quot; sets the autoread as false because of no available segments, and resulting in some staging buffers. If another task &quot;B&quot; is failed by accident corresponding to one staging buffer. When task A trys to reset autoread as true, the process can not work because of task B failed.&lt;br/&gt;
I have fixed this problem in our application by adding one boolean parameter in decodeBufferOrEvent method to distinguish whether this method is invoke by netty IO thread channel read or staged message handler task in PartitionRequestClientHandler.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12975754">FLINK-4021</key>
            <summary>Problem of setting autoread for netty channel when more tasks sharing the same Tcp connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zjwang">Zhijiang</assignee>
                                    <reporter username="zjwang">Zhijiang</reporter>
                        <labels>
                    </labels>
                <created>Sat, 4 Jun 2016 16:45:43 +0000</created>
                <updated>Fri, 19 Aug 2016 12:22:21 +0000</updated>
                            <resolved>Fri, 19 Aug 2016 12:22:20 +0000</resolved>
                                    <version>1.0.2</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Runtime / Network</component>
                        <due>Mon, 13 Jun 2016 00:00:00 +0000</due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15333658" author="rmetzger" created="Thu, 16 Jun 2016 12:16:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=uce&quot; class=&quot;user-hover&quot; rel=&quot;uce&quot;&gt;uce&lt;/a&gt;, is this an issue that should go into 1.1.0 ?&lt;/p&gt;</comment>
                            <comment id="15333683" author="uce" created="Thu, 16 Jun 2016 12:34:42 +0000"  >&lt;p&gt;No, cleared the fix version.&lt;/p&gt;</comment>
                            <comment id="15341655" author="githubbot" created="Tue, 21 Jun 2016 12:10:30 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2141&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you for this PR. I will try to look into it next week. I think we should wait for the 1.1 release before we merge this though.&lt;/p&gt;</comment>
                            <comment id="15420965" author="githubbot" created="Mon, 15 Aug 2016 13:22:58 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2141#discussion_r74760105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2141#discussion_r74760105&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/PartitionRequestClientHandler.java &amp;#8212;&lt;br/&gt;
    @@ -292,7 +296,11 @@ else if (bufferListener.waitForBuffer(bufferProvider, bufferOrEvent)) &lt;/p&gt;
{
     						return false;
     					}
&lt;p&gt;     					else if (bufferProvider.isDestroyed()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return false;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We usually have a white space between keywords like `if` or `else`:&lt;br/&gt;
    ```java&lt;br/&gt;
    if (isStagedBuffer) &lt;/p&gt;
{
        return true;
    }
&lt;p&gt; else &lt;/p&gt;
{
        return false;
    }
&lt;p&gt;    ```&lt;/p&gt;

&lt;p&gt;    In this case, you can simplify the return value to `return isStagedBuffer`. Same for the other place where you use this.&lt;/p&gt;</comment>
                            <comment id="15420973" author="githubbot" created="Mon, 15 Aug 2016 13:30:38 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2141&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Very impressive that you made it through that part of the system. It&apos;s very poorly documented and overly complex. The change looks good and ensures that a staged buffer that cannot be decoded because of a closed buffer pool does not leave the channel with auto read set to false. This is currently not a problem as all tasks of the job are failed, but with partial recovery this will lead to problems if the channel is kept alive by other consuming tasks.&lt;/p&gt;

&lt;p&gt;    We could add the following as a test for this in `PartitionRequestClientHandlerTest`. What do you think? This covers both branches that you added.&lt;/p&gt;

&lt;p&gt;    ```java&lt;br/&gt;
    /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests that an unsuccessful message decode call for a staged message&lt;/li&gt;
	&lt;li&gt;does not leave the channel with auto read set to false.&lt;br/&gt;
     */&lt;br/&gt;
    @Test&lt;br/&gt;
    @SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
    public void testAutoReadAfterUnsuccessfulStagedMessage() throws Exception {&lt;br/&gt;
    	PartitionRequestClientHandler handler = new PartitionRequestClientHandler();&lt;br/&gt;
    	EmbeddedChannel channel = new EmbeddedChannel(handler);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    	final AtomicReference&amp;lt;EventListener&amp;lt;Buffer&amp;gt;&amp;gt; listener = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;    	BufferProvider bufferProvider = mock(BufferProvider.class);&lt;br/&gt;
    	when(bufferProvider.addListener(any(EventListener.class))).thenAnswer(new Answer&amp;lt;Boolean&amp;gt;() {&lt;br/&gt;
    		@Override&lt;br/&gt;
    		@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
    		public Boolean answer(InvocationOnMock invocation) throws Throwable &lt;/p&gt;
{
    			listener.set((EventListener&amp;lt;Buffer&amp;gt;) invocation.getArguments()[0]);
    			return true;
    		}
&lt;p&gt;    	});&lt;/p&gt;

&lt;p&gt;    	when(bufferProvider.requestBuffer()).thenReturn(null);&lt;/p&gt;

&lt;p&gt;    	InputChannelID channelId = new InputChannelID(0, 0);&lt;br/&gt;
    	RemoteInputChannel inputChannel = mock(RemoteInputChannel.class);&lt;br/&gt;
    	when(inputChannel.getInputChannelId()).thenReturn(channelId);&lt;/p&gt;

&lt;p&gt;    	handler.addInputChannel(inputChannel);&lt;/p&gt;

&lt;p&gt;    	BufferResponse msg = createBufferResponse(channelId, channel);&lt;/p&gt;

&lt;p&gt;    	// Write 1st buffer msg. No buffer is available, therefore the buffer&lt;br/&gt;
    	// should be staged and auto read should be set to false.&lt;br/&gt;
    	assertTrue(channel.config().isAutoRead());&lt;br/&gt;
    	channel.writeInbound(msg);&lt;/p&gt;

&lt;p&gt;    	// No buffer available, auto read false&lt;br/&gt;
    	assertFalse(channel.config().isAutoRead());&lt;/p&gt;

&lt;p&gt;    	// Write more buffers... all staged.&lt;br/&gt;
    	msg = createBufferResponse(channelId, channel);&lt;br/&gt;
    	channel.writeInbound(msg);&lt;/p&gt;

&lt;p&gt;    	msg = createBufferResponse(channelId, channel);&lt;br/&gt;
    	channel.writeInbound(msg);&lt;/p&gt;

&lt;p&gt;    	// Notify about buffer =&amp;gt; handle 1st msg&lt;br/&gt;
    	Buffer availableBuffer = createBuffer(false);&lt;br/&gt;
    	listener.get().onEvent(availableBuffer);&lt;/p&gt;

&lt;p&gt;    	// Start processing of staged buffers (in run pending tasks). Make&lt;br/&gt;
    	// sure that the buffer provider acts like it&apos;s destroyed.&lt;br/&gt;
    	when(bufferProvider.addListener(any(EventListener.class))).thenReturn(false);&lt;br/&gt;
    	when(bufferProvider.isDestroyed()).thenReturn(true);&lt;/p&gt;

&lt;p&gt;    	// The 3rd staged msg has a null buffer provider&lt;br/&gt;
    	when(inputChannel.getBufferProvider()).thenReturn(bufferProvider, bufferProvider, null);&lt;/p&gt;

&lt;p&gt;    	// Execute all tasks that are scheduled in the event loop. Further&lt;br/&gt;
    	// eventLoop().execute() calls are directly executed, if they are&lt;br/&gt;
    	// called in the scope of this call.&lt;br/&gt;
    	channel.runPendingTasks();&lt;/p&gt;

&lt;p&gt;    	assertTrue(channel.config().isAutoRead());&lt;br/&gt;
    }&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="15423984" author="zjwang" created="Wed, 17 Aug 2016 06:39:27 +0000"  >&lt;p&gt;Thank you for advice, it is indeed simple by &apos;return isStagedBuffer&apos; directly. &lt;/p&gt;</comment>
                            <comment id="15423994" author="zjwang" created="Wed, 17 Aug 2016 06:47:36 +0000"  >&lt;p&gt;Yeah, you are right. It is no problem in current flink failover mode. Maybe it is suitable for FLIP1 &apos;https://cwiki.apache.org/confluence/display/FLINK/FLIP-1+%3A+Fine+Grained+Recovery+from+Task+Failures&apos;.&lt;br/&gt;
And we already improved the task failures by just restarting the source and failed ones, so noticed this issue.&lt;br/&gt;
I forgot to add the testing for the function, thank you for confirming it.&lt;br/&gt;
And what other jobs should I do next?&lt;/p&gt;</comment>
                            <comment id="15424179" author="uce" created="Wed, 17 Aug 2016 09:12:10 +0000"  >&lt;p&gt;After you address the comments (replace return and add the test) and add another commit to the pull request branch, I would go ahead and merge this. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; If you push to the PR branch, it will be automatically reflected in the PR on GitHub.&lt;/p&gt;</comment>
                            <comment id="15424183" author="zjwang" created="Wed, 17 Aug 2016 09:17:18 +0000"  >&lt;p&gt;got it, i will modify the return and add the test to PR branch this week. &lt;/p&gt;</comment>
                            <comment id="15427950" author="githubbot" created="Fri, 19 Aug 2016 10:11:11 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2141&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;m going to address the comments and merge this&lt;/p&gt;</comment>
                            <comment id="15428088" author="githubbot" created="Fri, 19 Aug 2016 12:21:07 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2141&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15428089" author="uce" created="Fri, 19 Aug 2016 12:22:21 +0000"  >&lt;p&gt;Fixed in 6615ee7, 7dbcffb (master).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 13 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yzo7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>