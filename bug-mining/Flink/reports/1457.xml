<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5464] MetricQueryService throws NullPointerException on JobManager</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5464</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I&apos;m using Flink 699f4b0.&lt;/p&gt;

&lt;p&gt;My JobManager log contains many of these log entries:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2017-01-11 19:42:05,778 WARN  org.apache.flink.runtime.webmonitor.metrics.MetricFetcher     - Fetching metrics failed.
akka.pattern.AskTimeoutException: Ask timed out on [Actor[akka:&lt;span class=&quot;code-comment&quot;&gt;//flink/user/MetricQueryService#-970662317]] after [10000 ms]
&lt;/span&gt;	at akka.pattern.PromiseActorRef$$anonfun$1.apply$mcV$sp(AskSupport.scala:334)
	at akka.actor.Scheduler$$anon$7.run(Scheduler.scala:117)
	at scala.concurrent.Future$InternalCallbackExecutor$.scala$concurrent$Future$InternalCallbackExecutor$$unbatchedExecute(Future.scala:694)
	at scala.concurrent.Future$InternalCallbackExecutor$.execute(Future.scala:691)
	at akka.actor.LightArrayRevolverScheduler$TaskHolder.executeTask(Scheduler.scala:474)
	at akka.actor.LightArrayRevolverScheduler$$anon$8.executeBucket$1(Scheduler.scala:425)
	at akka.actor.LightArrayRevolverScheduler$$anon$8.nextTick(Scheduler.scala:429)
	at akka.actor.LightArrayRevolverScheduler$$anon$8.run(Scheduler.scala:381)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
2017-01-11 19:42:07,765 WARN  org.apache.flink.runtime.metrics.dump.MetricQueryService      - An exception occurred &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing a message.
java.lang.NullPointerException
	at org.apache.flink.runtime.metrics.dump.MetricDumpSerialization.serializeGauge(MetricDumpSerialization.java:162)
	at org.apache.flink.runtime.metrics.dump.MetricDumpSerialization.access$300(MetricDumpSerialization.java:47)
	at org.apache.flink.runtime.metrics.dump.MetricDumpSerialization$MetricDumpSerializer.serialize(MetricDumpSerialization.java:90)
	at org.apache.flink.runtime.metrics.dump.MetricQueryService.onReceive(MetricQueryService.java:109)
	at akka.actor.UntypedActor$$anonfun$receive$1.applyOrElse(UntypedActor.scala:167)
	at akka.actor.Actor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;aroundReceive(Actor.scala:467)
	at akka.actor.UntypedActor.aroundReceive(UntypedActor.scala:97)
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:516)
	at akka.actor.ActorCell.invoke(ActorCell.scala:487)
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:238)
	at akka.dispatch.Mailbox.run(Mailbox.scala:220)
	at akka.dispatch.ForkJoinExecutorConfigurator$AkkaForkJoinTask.exec(AbstractDispatcher.scala:397)
	at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
	at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
	at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13033957">FLINK-5464</key>
            <summary>MetricQueryService throws NullPointerException on JobManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Jan 2017 20:33:52 +0000</created>
                <updated>Mon, 23 Jan 2017 21:22:11 +0000</updated>
                            <resolved>Mon, 23 Jan 2017 21:22:11 +0000</resolved>
                                    <version>1.2.0</version>
                    <version>1.3.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                    <component>Runtime / Web Frontend</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15820801" author="zentol" created="Thu, 12 Jan 2017 11:36:08 +0000"  >&lt;p&gt;There are 2 possible cases for this: Either the supplied gauge was null, or it was not null but the value it supplies is null. Neither of these cases are checked at the moment.&lt;/p&gt;</comment>
                            <comment id="15820823" author="githubbot" created="Thu, 12 Jan 2017 11:51:18 +0000"  >&lt;p&gt;GitHub user zentol opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5464&quot; title=&quot;MetricQueryService throws NullPointerException on JobManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5464&quot;&gt;&lt;del&gt;FLINK-5464&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Prevent some NPEs&lt;/p&gt;

&lt;p&gt;    This PR prevents some NullPointerExceptions from occurring in the metric system.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When registering a metric that is null the metric is ignored, and a warning is logged.&lt;/li&gt;
	&lt;li&gt;i.e ```group.counter(&quot;counter&quot;, null);```&lt;/li&gt;
	&lt;li&gt;The MetricDumpSerialization completely ignores gauges if their value is null.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zentol/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/flink&lt;/a&gt; 5464_mqs_npe&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3103.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3103.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3103&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 0912848b3ce54842fc6810aa0b041db5547ac690&lt;br/&gt;
Author: zentol &amp;lt;chesnay@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-12T11:41:56Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5464&quot; title=&quot;MetricQueryService throws NullPointerException on JobManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5464&quot;&gt;&lt;del&gt;FLINK-5464&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Ignore metrics that are null&lt;/p&gt;

&lt;p&gt;commit 941c83a599221fc57c02605e2c3bc348d70aa8b2&lt;br/&gt;
Author: zentol &amp;lt;chesnay@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-12T11:42:26Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5464&quot; title=&quot;MetricQueryService throws NullPointerException on JobManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5464&quot;&gt;&lt;del&gt;FLINK-5464&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Prevent Gauge NPE in serialization&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15821684" author="githubbot" created="Fri, 13 Jan 2017 11:45:05 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    cc @rmetzger &lt;/p&gt;</comment>
                            <comment id="15821920" author="githubbot" created="Fri, 13 Jan 2017 15:47:37 +0000"  >&lt;p&gt;Github user rmetzger commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    While testing this PR, I found that the jobmanager.log is now full with exceptions like this one:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    java.io.EOFException&lt;br/&gt;
            at java.io.DataInputStream.readInt(DataInputStream.java:392)&lt;br/&gt;
            at org.apache.flink.runtime.metrics.dump.MetricDumpSerialization.deserializeString(MetricDumpSerialization.java:230)&lt;br/&gt;
            at org.apache.flink.runtime.metrics.dump.MetricDumpSerialization.deserializeMetricInfo(MetricDumpSerialization.java:278)&lt;br/&gt;
            at org.apache.flink.runtime.metrics.dump.MetricDumpSerialization.deserializeGauge(MetricDumpSerialization.java:243)&lt;br/&gt;
            at org.apache.flink.runtime.metrics.dump.MetricDumpSerialization.access$800(MetricDumpSerialization.java:47)&lt;br/&gt;
            at org.apache.flink.runtime.metrics.dump.MetricDumpSerialization$MetricDumpDeserializer.deserialize(MetricDumpSerialization.java:214)&lt;br/&gt;
            at org.apache.flink.runtime.webmonitor.metrics.MetricFetcher.addMetrics(MetricFetcher.java:196)&lt;br/&gt;
            at org.apache.flink.runtime.webmonitor.metrics.MetricFetcher.access$500(MetricFetcher.java:58)&lt;br/&gt;
            at org.apache.flink.runtime.webmonitor.metrics.MetricFetcher$4.onSuccess(MetricFetcher.java:188)&lt;br/&gt;
            at akka.dispatch.OnSuccess.internal(Future.scala:212)&lt;br/&gt;
            at akka.dispatch.japi$CallbackBridge.apply(Future.scala:175)&lt;br/&gt;
            at akka.dispatch.japi$CallbackBridge.apply(Future.scala:172)&lt;br/&gt;
            at scala.PartialFunction$class.applyOrElse(PartialFunction.scala:118)&lt;br/&gt;
            at scala.runtime.AbstractPartialFunction.applyOrElse(AbstractPartialFunction.scala:25)&lt;br/&gt;
            at scala.concurrent.Future$$anonfun$onSuccess$1.apply(Future.scala:117)&lt;br/&gt;
            at scala.concurrent.Future$$anonfun$onSuccess$1.apply(Future.scala:115)&lt;br/&gt;
            at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:32)&lt;br/&gt;
            at java.util.concurrent.ForkJoinTask$AdaptedRunnable.exec(ForkJoinTask.java:1265)&lt;br/&gt;
            at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:334)&lt;br/&gt;
            at java.util.concurrent.ForkJoinWorkerThread.execTask(ForkJoinWorkerThread.java:604)&lt;br/&gt;
            at java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:784)&lt;br/&gt;
            at java.util.concurrent.ForkJoinPool.work(ForkJoinPool.java:646)&lt;br/&gt;
            at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:398)&lt;br/&gt;
    ```&lt;/p&gt;
</comment>
                            <comment id="15822472" author="githubbot" created="Fri, 13 Jan 2017 22:40:08 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    yeah I&apos;ll have to rethink this :/&lt;/p&gt;

&lt;p&gt;    I wanted to just ignore gauges returning null (since nothing in the web-interface accounts for that case), but did not adjust the count of metrics that are submitted. urgh.&lt;/p&gt;</comment>
                            <comment id="15822473" author="githubbot" created="Fri, 13 Jan 2017 22:40:09 +0000"  >&lt;p&gt;Github user zentol closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3103&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15823880" author="githubbot" created="Mon, 16 Jan 2017 12:30:39 +0000"  >&lt;p&gt;GitHub user zentol opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5464&quot; title=&quot;MetricQueryService throws NullPointerException on JobManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5464&quot;&gt;&lt;del&gt;FLINK-5464&lt;/del&gt;&lt;/a&gt; Improve MetricDumpSerialization error handling&lt;/p&gt;

&lt;p&gt;    Rework of #3103.&lt;/p&gt;

&lt;p&gt;    The key change introduced in the previous PR remains; if a gauge returns null it is not serialized.&lt;/p&gt;

&lt;p&gt;    However, I&apos;ve extended the PR to harden the entire serialization process against exceptions. The major gain here is that a single failed serialization does no longer destroys the entire dump; instead it is simply omitted.&lt;/p&gt;

&lt;p&gt;    In order to allow that I had to replace the ```OutputStream```s with a ```ByteBuffer```. The former doesn&apos;t really allow you to handle failures in between serialization steps, as you can&apos;t reset the stream in any way. The ```ByteBuffer``` is manually resized if a ```BufferOverflowException``` occurs.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;```MetricDump(De)Serializer#(de)serialize``` will no longer throw any exception but catch and log them instead&lt;/li&gt;
	&lt;li&gt;Exceptions during the serialization of a metric will cause that metric to be skipped.&lt;/li&gt;
	&lt;li&gt;added test for handling of gauge returning null&lt;/li&gt;
	&lt;li&gt;added test for manual resizing of backing array&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zentol/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/flink&lt;/a&gt; 5464_mqs_npe&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3128&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 8610a47c407afe2140cd4b5651ebc794ef3feec8&lt;br/&gt;
Author: zentol &amp;lt;chesnay@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-12T11:41:56Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5464&quot; title=&quot;MetricQueryService throws NullPointerException on JobManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5464&quot;&gt;&lt;del&gt;FLINK-5464&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Ignore metrics that are null&lt;/p&gt;

&lt;p&gt;commit 442c0a4dee002b73e5b86d6c7bb274484a8900ac&lt;br/&gt;
Author: zentol &amp;lt;chesnay@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-16T10:25:58Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Remove unused variable in MetricDumpSerializerTest&lt;/p&gt;

&lt;p&gt;commit 0f813ebf53414b1b68c6dfe8e3e1dbc896054c36&lt;br/&gt;
Author: zentol &amp;lt;chesnay@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-12T11:42:26Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5464&quot; title=&quot;MetricQueryService throws NullPointerException on JobManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5464&quot;&gt;&lt;del&gt;FLINK-5464&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Improve MetricDumpSerialization exception handling&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15828361" author="githubbot" created="Wed, 18 Jan 2017 16:29:00 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;ve had an offline chat with @rmetzger and @uce. We agreed that using a ByteBuffer and resizing it manually was a bit undesirable.&lt;/p&gt;

&lt;p&gt;    Instead we opted for the following approach:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;use DataOutputSerializer instead of DataOutputStream; it is a bit more efficient of strings, which make up the majority of serialized data, and is also backed by a resizing array&lt;/li&gt;
	&lt;li&gt;restructure the serialize methods to be symmetric with the deserialize methods&lt;/li&gt;
	&lt;li&gt;Access the metric values before serializing anything and reduce them to primitives or strings. The assumption is that if this succeeds the following serialization will succeed; and can only fail due to critical errors that will prevent serialization completely or programming errors on our part.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15834507" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97314773&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97314773&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -50,12 +51,27 @@&lt;br/&gt;
     	private MetricDumpSerialization() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	public static class MetricSerializationResult {&lt;br/&gt;
    +		public final byte[] data;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Wonderning whether to call this `serializedMetrics`&lt;/p&gt;</comment>
                            <comment id="15834508" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97316854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97316854&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -191,62 +233,65 @@ private static void serializeMeter(DataOutputStream dos, Meter meter) throws IOE&lt;br/&gt;
     		 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param data serialized metrics&lt;/li&gt;
	&lt;li&gt;@return A list containing the deserialized metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws IOException&lt;br/&gt;
     		 */&lt;/li&gt;
	&lt;li&gt;public List&amp;lt;MetricDump&amp;gt; deserialize(byte[] data) throws IOException {&lt;/li&gt;
	&lt;li&gt;ByteArrayInputStream bais = new ByteArrayInputStream(data);&lt;/li&gt;
	&lt;li&gt;DataInputStream dis = new DataInputStream(bais);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int numCounters = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numGauges = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numHistograms = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numMeters = dis.readInt();&lt;br/&gt;
    +		public List&amp;lt;MetricDump&amp;gt; deserialize(MetricDumpSerialization.MetricSerializationResult data) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    In line 230, an empty line is missing before `class MetricDumpDeserializer`.&lt;/p&gt;</comment>
                            <comment id="15834509" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97315450&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97315450&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -64,122 +80,148 @@ private MetricDumpSerialization() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param gauges     gauges to serialize&lt;/li&gt;
	&lt;li&gt;@param histograms histograms to serialize&lt;/li&gt;
	&lt;li&gt;@return byte array containing the serialized metrics&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws IOException&lt;br/&gt;
     		 */&lt;/li&gt;
	&lt;li&gt;public byte[] serialize(&lt;br/&gt;
    +		public MetricSerializationResult serialize(&lt;br/&gt;
     			Map&amp;lt;Counter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; counters,&lt;br/&gt;
     			Map&amp;lt;Gauge&amp;lt;?&amp;gt;, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; gauges,&lt;br/&gt;
     			Map&amp;lt;Histogram, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; histograms,&lt;/li&gt;
	&lt;li&gt;Map&amp;lt;Meter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; meters) throws IOException {&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;baos.reset();&lt;/li&gt;
	&lt;li&gt;dos.writeInt(counters.size());&lt;/li&gt;
	&lt;li&gt;dos.writeInt(gauges.size());&lt;/li&gt;
	&lt;li&gt;dos.writeInt(histograms.size());&lt;/li&gt;
	&lt;li&gt;dos.writeInt(meters.size());&lt;br/&gt;
    +			Map&amp;lt;Meter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; meters) {&lt;br/&gt;
    +&lt;br/&gt;
    +			buffer.clear();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numCounters = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Counter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : counters.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeCounter(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeCounter(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numCounters++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize counter.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numGauges = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Gauge&amp;lt;?&amp;gt;, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : gauges.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeGauge(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeGauge(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numGauges++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize gauge.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numHistograms = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Histogram, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : histograms.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeHistogram(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeHistogram(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numHistograms++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize histogram.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numMeters = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Meter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : meters.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeMeter(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeMeter(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numMeters++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize meter.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return baos.toByteArray();&lt;br/&gt;
    +			return new MetricSerializationResult(buffer.getCopyOfBuffer(), numCounters, numGauges, numMeters, numHistograms);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Empty line before return?&lt;/p&gt;</comment>
                            <comment id="15834510" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97315164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97315164&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -50,12 +51,27 @@&lt;br/&gt;
     	private MetricDumpSerialization() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	public static class MetricSerializationResult {&lt;br/&gt;
    +		public final byte[] data;&lt;br/&gt;
    +		public final int numCounters;&lt;br/&gt;
    +		public final int numGauges;&lt;br/&gt;
    +		public final int numMeters;&lt;br/&gt;
    +		public final int numHistograms;&lt;br/&gt;
    +		&lt;br/&gt;
    +		public MetricSerializationResult(byte[] data, int numCounters, int numGauges, int numMeters, int numHistograms) {&lt;br/&gt;
    +			this.data = data;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Let&apos;s add simple sanity checks `checkNotNull(data)` and `checkArgument(num* &amp;gt;= 0)` for the other fields.&lt;/p&gt;</comment>
                            <comment id="15834511" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97317434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97317434&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -191,62 +233,65 @@ private static void serializeMeter(DataOutputStream dos, Meter meter) throws IOE&lt;br/&gt;
     		 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param data serialized metrics&lt;/li&gt;
	&lt;li&gt;@return A list containing the deserialized metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws IOException&lt;br/&gt;
     		 */&lt;/li&gt;
	&lt;li&gt;public List&amp;lt;MetricDump&amp;gt; deserialize(byte[] data) throws IOException {&lt;/li&gt;
	&lt;li&gt;ByteArrayInputStream bais = new ByteArrayInputStream(data);&lt;/li&gt;
	&lt;li&gt;DataInputStream dis = new DataInputStream(bais);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int numCounters = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numGauges = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numHistograms = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numMeters = dis.readInt();&lt;br/&gt;
    +		public List&amp;lt;MetricDump&amp;gt; deserialize(MetricDumpSerialization.MetricSerializationResult data) {&lt;br/&gt;
    +			DataInputView in = new DataInputDeserializer(data.data, 0, data.data.length);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;List&amp;lt;MetricDump&amp;gt; metrics = new ArrayList&amp;lt;&amp;gt;(numCounters + numGauges + numHistograms);&lt;br/&gt;
    +			List&amp;lt;MetricDump&amp;gt; metrics = new ArrayList&amp;lt;&amp;gt;(data.numCounters + data.numGauges + data.numHistograms + data.numMeters);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int x = 0; x &amp;lt; numCounters; x++) {&lt;/li&gt;
	&lt;li&gt;metrics.add(deserializeCounter(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numCounters; x++) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				try {
    +					metrics.add(deserializeCounter(in));
    +				} catch (Exception e) {
    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);
    +				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
    -			for (int x = 0; x &amp;lt; numGauges; x++) {&lt;br/&gt;
    -				metrics.add(deserializeGauge(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numGauges; x++) {&lt;br/&gt;
    +				try {
    +					metrics.add(deserializeGauge(in));
    +				} catch (Exception e) {    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);    +				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int x = 0; x &amp;lt; numHistograms; x++) {&lt;/li&gt;
	&lt;li&gt;metrics.add(deserializeHistogram(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numHistograms; x++) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				try {
    +					metrics.add(deserializeHistogram(in));
    +				} catch (Exception e) {
    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);
    +				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
    -			for (int x = 0; x &amp;lt; numMeters; x++) {&lt;br/&gt;
    -				metrics.add(deserializeMeter(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numMeters; x++) {&lt;br/&gt;
    +				try {
    +					metrics.add(deserializeMeter(in));
    +				} catch (Exception e) {    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);    +				}     			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return metrics;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Code does not compile because of the missing return.&lt;/p&gt;</comment>
                            <comment id="15834512" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97316605&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97316605&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -64,122 +80,148 @@ private MetricDumpSerialization() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param gauges     gauges to serialize&lt;/li&gt;
	&lt;li&gt;@param histograms histograms to serialize&lt;/li&gt;
	&lt;li&gt;@return byte array containing the serialized metrics&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws IOException&lt;br/&gt;
     		 */&lt;/li&gt;
	&lt;li&gt;public byte[] serialize(&lt;br/&gt;
    +		public MetricSerializationResult serialize(&lt;br/&gt;
     			Map&amp;lt;Counter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; counters,&lt;br/&gt;
     			Map&amp;lt;Gauge&amp;lt;?&amp;gt;, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; gauges,&lt;br/&gt;
     			Map&amp;lt;Histogram, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; histograms,&lt;/li&gt;
	&lt;li&gt;Map&amp;lt;Meter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; meters) throws IOException {&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;baos.reset();&lt;/li&gt;
	&lt;li&gt;dos.writeInt(counters.size());&lt;/li&gt;
	&lt;li&gt;dos.writeInt(gauges.size());&lt;/li&gt;
	&lt;li&gt;dos.writeInt(histograms.size());&lt;/li&gt;
	&lt;li&gt;dos.writeInt(meters.size());&lt;br/&gt;
    +			Map&amp;lt;Meter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; meters) {&lt;br/&gt;
    +&lt;br/&gt;
    +			buffer.clear();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numCounters = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Counter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : counters.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeCounter(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeCounter(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numCounters++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize counter.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numGauges = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Gauge&amp;lt;?&amp;gt;, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : gauges.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeGauge(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeGauge(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numGauges++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize gauge.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numHistograms = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Histogram, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : histograms.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeHistogram(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeHistogram(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numHistograms++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize histogram.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numMeters = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Meter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : meters.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeMeter(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeMeter(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numMeters++;
    +				}
&lt;p&gt; catch (Exception e) {&lt;br/&gt;
    +					LOG.warn(&quot;Failed to serialize meter.&quot;, e);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Should we decrease the log level to `debug` (here and the other lines)? The user won&apos;t be able to act on the warning and in most cases this should work and we don&apos;t risk printing out many log messages (as happened before a couple of times).&lt;/p&gt;</comment>
                            <comment id="15834513" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97315979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97315979&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -64,122 +80,148 @@ private MetricDumpSerialization() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param gauges     gauges to serialize&lt;/li&gt;
	&lt;li&gt;@param histograms histograms to serialize&lt;/li&gt;
	&lt;li&gt;@return byte array containing the serialized metrics&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws IOException&lt;br/&gt;
     		 */&lt;/li&gt;
	&lt;li&gt;public byte[] serialize(&lt;br/&gt;
    +		public MetricSerializationResult serialize(&lt;br/&gt;
     			Map&amp;lt;Counter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; counters,&lt;br/&gt;
     			Map&amp;lt;Gauge&amp;lt;?&amp;gt;, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; gauges,&lt;br/&gt;
     			Map&amp;lt;Histogram, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; histograms,&lt;/li&gt;
	&lt;li&gt;Map&amp;lt;Meter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; meters) throws IOException {&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;baos.reset();&lt;/li&gt;
	&lt;li&gt;dos.writeInt(counters.size());&lt;/li&gt;
	&lt;li&gt;dos.writeInt(gauges.size());&lt;/li&gt;
	&lt;li&gt;dos.writeInt(histograms.size());&lt;/li&gt;
	&lt;li&gt;dos.writeInt(meters.size());&lt;br/&gt;
    +			Map&amp;lt;Meter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; meters) {&lt;br/&gt;
    +&lt;br/&gt;
    +			buffer.clear();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numCounters = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Counter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : counters.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeCounter(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeCounter(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numCounters++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize counter.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numGauges = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Gauge&amp;lt;?&amp;gt;, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : gauges.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeGauge(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeGauge(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numGauges++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize gauge.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numHistograms = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Histogram, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : histograms.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeHistogram(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeHistogram(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numHistograms++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize histogram.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +			int numMeters = 0;&lt;br/&gt;
     			for (Map.Entry&amp;lt;Meter, Tuple2&amp;lt;QueryScopeInfo, String&amp;gt;&amp;gt; entry : meters.entrySet()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializeMetricInfo(dos, entry.getValue().f0);&lt;/li&gt;
	&lt;li&gt;serializeString(dos, entry.getValue().f1);&lt;/li&gt;
	&lt;li&gt;serializeMeter(dos, entry.getKey());&lt;br/&gt;
    +				try 
{
    +					serializeMeter(buffer, entry.getValue().f0, entry.getValue().f1, entry.getKey());
    +					numMeters++;
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					LOG.warn(&quot;Failed to serialize meter.&quot;, e);
    +				}
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return baos.toByteArray();&lt;br/&gt;
    +			return new MetricSerializationResult(buffer.getCopyOfBuffer(), numCounters, numGauges, numMeters, numHistograms);&lt;br/&gt;
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public void close() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -				dos.close();
    -			}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    -				LOG.debug(&quot;Failed to close OutputStream.&quot;, e);
    -			}&lt;br/&gt;
    -			try {
    -				baos.close();
    -			} catch (Exception e) {    -				LOG.debug(&quot;Failed to close OutputStream.&quot;, e);    -			}
&lt;p&gt;    +			buffer = null;&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static void serializeMetricInfo(DataOutputStream dos, QueryScopeInfo info) throws IOException {&lt;/li&gt;
	&lt;li&gt;serializeString(dos, info.scope);&lt;/li&gt;
	&lt;li&gt;dos.writeByte(info.getCategory());&lt;br/&gt;
    +	private static void serializeMetricInfo(DataOutput out, QueryScopeInfo info) throws IOException 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		out.writeUTF(info.scope);    +		out.writeByte(info.getCategory());     		switch (info.getCategory()) {
     			case INFO_CATEGORY_JM:
     				break;
     			case INFO_CATEGORY_TM:
     				String tmID = ((QueryScopeInfo.TaskManagerQueryScopeInfo) info).taskManagerID;
    -				serializeString(dos, tmID);
    +				out.writeUTF(tmID);
     				break;
     			case INFO_CATEGORY_JOB:
     				QueryScopeInfo.JobQueryScopeInfo jobInfo = (QueryScopeInfo.JobQueryScopeInfo) info;
    -				serializeString(dos, jobInfo.jobID);
    +				out.writeUTF(jobInfo.jobID);
     				break;
     			case INFO_CATEGORY_TASK:
     				QueryScopeInfo.TaskQueryScopeInfo taskInfo = (QueryScopeInfo.TaskQueryScopeInfo) info;
    -				serializeString(dos, taskInfo.jobID);
    -				serializeString(dos, taskInfo.vertexID);
    -				dos.writeInt(taskInfo.subtaskIndex);
    +				out.writeUTF(taskInfo.jobID);
    +				out.writeUTF(taskInfo.vertexID);
    +				out.writeInt(taskInfo.subtaskIndex);
     				break;
     			case INFO_CATEGORY_OPERATOR:
     				QueryScopeInfo.OperatorQueryScopeInfo operatorInfo = (QueryScopeInfo.OperatorQueryScopeInfo) info;
    -				serializeString(dos, operatorInfo.jobID);
    -				serializeString(dos, operatorInfo.vertexID);
    -				dos.writeInt(operatorInfo.subtaskIndex);
    -				serializeString(dos, operatorInfo.operatorName);
    +				out.writeUTF(operatorInfo.jobID);
    +				out.writeUTF(operatorInfo.vertexID);
    +				out.writeInt(operatorInfo.subtaskIndex);
    +				out.writeUTF(operatorInfo.operatorName);
     				break;
    +			default:
    +				throw new IOException(&quot;Unknown scope category: &quot; + info.getCategory());
     		}     	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static void serializeString(DataOutputStream dos, String string) throws IOException {&lt;/li&gt;
	&lt;li&gt;byte[] bytes = string.getBytes();&lt;/li&gt;
	&lt;li&gt;dos.writeInt(bytes.length);&lt;/li&gt;
	&lt;li&gt;dos.write(bytes);&lt;br/&gt;
    +	private static void serializeCounter(DataOutput out, QueryScopeInfo info, String name, Counter counter) throws IOException 
{
    +		long count = counter.getCount();
    +		serializeMetricInfo(out, info);
    +		out.writeUTF(name);
    +		out.writeLong(count);
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static void serializeCounter(DataOutputStream dos, Counter counter) throws IOException 
{
    -		dos.writeLong(counter.getCount());
    -	}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;private static void serializeGauge(DataOutputStream dos, Gauge&amp;lt;?&amp;gt; gauge) throws IOException {&lt;/li&gt;
	&lt;li&gt;serializeString(dos, gauge.getValue().toString());&lt;br/&gt;
    +	private static void serializeGauge(DataOutput out, QueryScopeInfo info, String name, Gauge&amp;lt;?&amp;gt; gauge) throws IOException 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		Object value = gauge.getValue();    +		if (value == null) {
    +			throw new NullPointerException(&quot;Value returned by gauge &quot; + name + &quot; was null.&quot;);
    +		}    +		String stringValue = gauge.getValue().toString();    +		if (stringValue == null) {
    +			throw new NullPointerException(&quot;toString() of the value returned by gauge &quot; + name + &quot; returned null.&quot;);
    +		}    +		serializeMetricInfo(out, info);    +		out.writeUTF(name);    +		out.writeUTF(stringValue);     	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static void serializeHistogram(DataOutputStream dos, Histogram histogram) throws IOException {&lt;br/&gt;
    +	private static void serializeHistogram(DataOutput out, QueryScopeInfo info, String name, Histogram histogram) throws IOException {&lt;br/&gt;
     		HistogramStatistics stat = histogram.getStatistics();&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;dos.writeLong(stat.getMin());&lt;/li&gt;
	&lt;li&gt;dos.writeLong(stat.getMax());&lt;/li&gt;
	&lt;li&gt;dos.writeDouble(stat.getMean());&lt;/li&gt;
	&lt;li&gt;dos.writeDouble(stat.getQuantile(0.5));&lt;/li&gt;
	&lt;li&gt;dos.writeDouble(stat.getStdDev());&lt;/li&gt;
	&lt;li&gt;dos.writeDouble(stat.getQuantile(0.75));&lt;/li&gt;
	&lt;li&gt;dos.writeDouble(stat.getQuantile(0.90));&lt;/li&gt;
	&lt;li&gt;dos.writeDouble(stat.getQuantile(0.95));&lt;/li&gt;
	&lt;li&gt;dos.writeDouble(stat.getQuantile(0.98));&lt;/li&gt;
	&lt;li&gt;dos.writeDouble(stat.getQuantile(0.99));&lt;/li&gt;
	&lt;li&gt;dos.writeDouble(stat.getQuantile(0.999));&lt;br/&gt;
    +		long min = stat.getMin();&lt;br/&gt;
    +		long max = stat.getMax();&lt;br/&gt;
    +		double mean = stat.getMean();&lt;br/&gt;
    +		double mediam = stat.getQuantile(0.5);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Typo `mediam` -&amp;gt; `median`&lt;/p&gt;</comment>
                            <comment id="15834514" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97314569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97314569&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -17,19 +17,20 @@&lt;br/&gt;
      */&lt;br/&gt;
     package org.apache.flink.runtime.metrics.dump;&lt;/p&gt;

&lt;p&gt;    -import org.apache.commons.io.output.ByteArrayOutputStream;&lt;br/&gt;
     import org.apache.flink.api.java.tuple.Tuple2;&lt;br/&gt;
    +import org.apache.flink.core.memory.DataInputView;&lt;br/&gt;
     import org.apache.flink.metrics.Counter;&lt;br/&gt;
     import org.apache.flink.metrics.Gauge;&lt;br/&gt;
     import org.apache.flink.metrics.Histogram;&lt;br/&gt;
     import org.apache.flink.metrics.HistogramStatistics;&lt;br/&gt;
     import org.apache.flink.metrics.Meter;&lt;br/&gt;
    +import org.apache.flink.runtime.util.DataInputDeserializer;&lt;br/&gt;
    +import org.apache.flink.runtime.util.DataOutputSerializer;&lt;br/&gt;
     import org.slf4j.Logger;&lt;br/&gt;
     import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;    -import java.io.ByteArrayInputStream;&lt;br/&gt;
    -import java.io.DataInputStream;&lt;br/&gt;
    -import java.io.DataOutputStream;&lt;br/&gt;
    +import java.io.DataInput;&lt;br/&gt;
    +import java.io.DataOutput;&lt;br/&gt;
     import java.io.IOException;&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    In line 49 (above the `LOG` field) an empty line is missing&lt;/p&gt;</comment>
                            <comment id="15834515" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97316951&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97316951&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -191,62 +233,65 @@ private static void serializeMeter(DataOutputStream dos, Meter meter) throws IOE&lt;br/&gt;
     		 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param data serialized metrics&lt;/li&gt;
	&lt;li&gt;@return A list containing the deserialized metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws IOException&lt;br/&gt;
     		 */&lt;/li&gt;
	&lt;li&gt;public List&amp;lt;MetricDump&amp;gt; deserialize(byte[] data) throws IOException {&lt;/li&gt;
	&lt;li&gt;ByteArrayInputStream bais = new ByteArrayInputStream(data);&lt;/li&gt;
	&lt;li&gt;DataInputStream dis = new DataInputStream(bais);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int numCounters = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numGauges = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numHistograms = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numMeters = dis.readInt();&lt;br/&gt;
    +		public List&amp;lt;MetricDump&amp;gt; deserialize(MetricDumpSerialization.MetricSerializationResult data) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Furthermore, after that line. And there is an empty line after the JavaDoc of `deserialize`.&lt;/p&gt;</comment>
                            <comment id="15834516" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97317481&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97317481&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -191,62 +233,65 @@ private static void serializeMeter(DataOutputStream dos, Meter meter) throws IOE&lt;br/&gt;
     		 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param data serialized metrics&lt;/li&gt;
	&lt;li&gt;@return A list containing the deserialized metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws IOException&lt;br/&gt;
     		 */&lt;/li&gt;
	&lt;li&gt;public List&amp;lt;MetricDump&amp;gt; deserialize(byte[] data) throws IOException {&lt;/li&gt;
	&lt;li&gt;ByteArrayInputStream bais = new ByteArrayInputStream(data);&lt;/li&gt;
	&lt;li&gt;DataInputStream dis = new DataInputStream(bais);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int numCounters = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numGauges = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numHistograms = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numMeters = dis.readInt();&lt;br/&gt;
    +		public List&amp;lt;MetricDump&amp;gt; deserialize(MetricDumpSerialization.MetricSerializationResult data) {&lt;br/&gt;
    +			DataInputView in = new DataInputDeserializer(data.data, 0, data.data.length);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;List&amp;lt;MetricDump&amp;gt; metrics = new ArrayList&amp;lt;&amp;gt;(numCounters + numGauges + numHistograms);&lt;br/&gt;
    +			List&amp;lt;MetricDump&amp;gt; metrics = new ArrayList&amp;lt;&amp;gt;(data.numCounters + data.numGauges + data.numHistograms + data.numMeters);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int x = 0; x &amp;lt; numCounters; x++) {&lt;/li&gt;
	&lt;li&gt;metrics.add(deserializeCounter(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numCounters; x++) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				try {
    +					metrics.add(deserializeCounter(in));
    +				} catch (Exception e) {
    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);
    +				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
    -			for (int x = 0; x &amp;lt; numGauges; x++) {&lt;br/&gt;
    -				metrics.add(deserializeGauge(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numGauges; x++) {&lt;br/&gt;
    +				try {
    +					metrics.add(deserializeGauge(in));
    +				} catch (Exception e) {    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);    +				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int x = 0; x &amp;lt; numHistograms; x++) {&lt;/li&gt;
	&lt;li&gt;metrics.add(deserializeHistogram(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numHistograms; x++) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				try {
    +					metrics.add(deserializeHistogram(in));
    +				} catch (Exception e) {
    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);
    +				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
    -			for (int x = 0; x &amp;lt; numMeters; x++) {&lt;br/&gt;
    -				metrics.add(deserializeMeter(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numMeters; x++) {&lt;br/&gt;
    +				try {
    +					metrics.add(deserializeMeter(in));
    +				} catch (Exception e) {    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);    +				}     			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return metrics;&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static String deserializeString(DataInputStream dis) throws IOException 
{
    -		int stringLength = dis.readInt();
    -		byte[] bytes = new byte[stringLength];
    -		dis.readFully(bytes);
    -		return new String(bytes);
    -	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static MetricDump.CounterDump deserializeCounter(DataInputStream dis) throws IOException {&lt;br/&gt;
    +	private static MetricDump.CounterDump deserializeCounter(DataInputView dis) throws IOException {&lt;br/&gt;
     		QueryScopeInfo scope = deserializeMetricInfo(dis);&lt;/li&gt;
	&lt;li&gt;String name = deserializeString(dis);&lt;/li&gt;
	&lt;li&gt;return new MetricDump.CounterDump(scope, name, dis.readLong());&lt;br/&gt;
    +		String name = dis.readUTF();&lt;br/&gt;
    +		long count = dis.readLong();&lt;br/&gt;
    +		return new MetricDump.CounterDump(scope, name, count);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Should we add an empty line before the `return`s?&lt;/p&gt;</comment>
                            <comment id="15834517" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97315205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97315205&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -50,12 +51,27 @@&lt;br/&gt;
     	private MetricDumpSerialization() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	public static class MetricSerializationResult {&lt;br/&gt;
    +		public final byte[] data;&lt;br/&gt;
    +		public final int numCounters;&lt;br/&gt;
    +		public final int numGauges;&lt;br/&gt;
    +		public final int numMeters;&lt;br/&gt;
    +		public final int numHistograms;&lt;br/&gt;
    +		&lt;br/&gt;
    +		public MetricSerializationResult(byte[] data, int numCounters, int numGauges, int numMeters, int numHistograms) &lt;/p&gt;
{
    +			this.data = data;
    +			this.numCounters = numCounters;
    +			this.numGauges = numGauges;
    +			this.numMeters = numMeters;
    +			this.numHistograms = numHistograms;
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
     	//-------------------------------------------------------------------------&lt;br/&gt;
     	// Serialization&lt;br/&gt;
     	//-------------------------------------------------------------------------&lt;br/&gt;
     	public static class MetricDumpSerializer {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private ByteArrayOutputStream baos = new ByteArrayOutputStream(4096);&lt;/li&gt;
	&lt;li&gt;private DataOutputStream dos = new DataOutputStream(baos);&lt;br/&gt;
    +		private DataOutputSerializer buffer = new DataOutputSerializer(1024 * 32);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Empty line missing before this line.&lt;/p&gt;</comment>
                            <comment id="15834518" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97319035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97319035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -50,12 +51,27 @@&lt;br/&gt;
     	private MetricDumpSerialization() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	public static class MetricSerializationResult {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This is not `Serializable` and would fail when send with Akka. The following test fails:&lt;br/&gt;
    ```java &lt;br/&gt;
    @Test&lt;br/&gt;
    public void testJavaSerialization() throws IOException &lt;/p&gt;
{
    	MetricDumpSerialization.MetricDumpSerializer serializer = new MetricDumpSerialization.MetricDumpSerializer();
    
    	final ByteArrayOutputStream bos = new ByteArrayOutputStream(1024);
    	final ObjectOutputStream oos = new ObjectOutputStream(bos);
    
    	oos.writeObject(serializer.serialize(
    		new HashMap&amp;lt;Counter, Tuple2&amp;lt;QueryScopeInfo,String&amp;gt;&amp;gt;(),
    		new HashMap&amp;lt;Gauge&amp;lt;?&amp;gt;, Tuple2&amp;lt;QueryScopeInfo,String&amp;gt;&amp;gt;(),
    		new HashMap&amp;lt;Histogram, Tuple2&amp;lt;QueryScopeInfo,String&amp;gt;&amp;gt;(),
    		new HashMap&amp;lt;Meter, Tuple2&amp;lt;QueryScopeInfo,String&amp;gt;&amp;gt;()));
    }
&lt;p&gt;    ```&lt;/p&gt;</comment>
                            <comment id="15834519" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97314949&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97314949&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -50,12 +51,27 @@&lt;br/&gt;
     	private MetricDumpSerialization() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	public static class MetricSerializationResult {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Can you add a short class level comment about why we added this? The problem with determining number of metrics before hand etc.&lt;/p&gt;</comment>
                            <comment id="15834520" author="githubbot" created="Mon, 23 Jan 2017 13:47:53 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97316717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97316717&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -50,12 +51,27 @@&lt;br/&gt;
     	private MetricDumpSerialization() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	public static class MetricSerializationResult {&lt;br/&gt;
    +		public final byte[] data;&lt;br/&gt;
    +		public final int numCounters;&lt;br/&gt;
    +		public final int numGauges;&lt;br/&gt;
    +		public final int numMeters;&lt;br/&gt;
    +		public final int numHistograms;&lt;br/&gt;
    +		&lt;br/&gt;
    +		public MetricSerializationResult(byte[] data, int numCounters, int numGauges, int numMeters, int numHistograms) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Let&apos;s decrease the visibility of the constructor as much as possible.&lt;/p&gt;</comment>
                            <comment id="15834654" author="githubbot" created="Mon, 23 Jan 2017 14:27:16 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97327512&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97327512&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -191,62 +233,65 @@ private static void serializeMeter(DataOutputStream dos, Meter meter) throws IOE&lt;br/&gt;
     		 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param data serialized metrics&lt;/li&gt;
	&lt;li&gt;@return A list containing the deserialized metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws IOException&lt;br/&gt;
     		 */&lt;/li&gt;
	&lt;li&gt;public List&amp;lt;MetricDump&amp;gt; deserialize(byte[] data) throws IOException {&lt;/li&gt;
	&lt;li&gt;ByteArrayInputStream bais = new ByteArrayInputStream(data);&lt;/li&gt;
	&lt;li&gt;DataInputStream dis = new DataInputStream(bais);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int numCounters = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numGauges = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numHistograms = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numMeters = dis.readInt();&lt;br/&gt;
    +		public List&amp;lt;MetricDump&amp;gt; deserialize(MetricDumpSerialization.MetricSerializationResult data) {&lt;br/&gt;
    +			DataInputView in = new DataInputDeserializer(data.data, 0, data.data.length);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;List&amp;lt;MetricDump&amp;gt; metrics = new ArrayList&amp;lt;&amp;gt;(numCounters + numGauges + numHistograms);&lt;br/&gt;
    +			List&amp;lt;MetricDump&amp;gt; metrics = new ArrayList&amp;lt;&amp;gt;(data.numCounters + data.numGauges + data.numHistograms + data.numMeters);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int x = 0; x &amp;lt; numCounters; x++) {&lt;/li&gt;
	&lt;li&gt;metrics.add(deserializeCounter(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numCounters; x++) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				try {
    +					metrics.add(deserializeCounter(in));
    +				} catch (Exception e) {
    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);
    +				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
    -			for (int x = 0; x &amp;lt; numGauges; x++) {&lt;br/&gt;
    -				metrics.add(deserializeGauge(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numGauges; x++) {&lt;br/&gt;
    +				try {
    +					metrics.add(deserializeGauge(in));
    +				} catch (Exception e) {    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);    +				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int x = 0; x &amp;lt; numHistograms; x++) {&lt;/li&gt;
	&lt;li&gt;metrics.add(deserializeHistogram(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numHistograms; x++) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				try {
    +					metrics.add(deserializeHistogram(in));
    +				} catch (Exception e) {
    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);
    +				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
    -			for (int x = 0; x &amp;lt; numMeters; x++) {&lt;br/&gt;
    -				metrics.add(deserializeMeter(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numMeters; x++) {&lt;br/&gt;
    +				try {
    +					metrics.add(deserializeMeter(in));
    +				} catch (Exception e) {    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);    +				}     			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return metrics;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    It appears i forgot to push some of the last-minute fixes :/&lt;/p&gt;</comment>
                            <comment id="15834655" author="githubbot" created="Mon, 23 Jan 2017 14:28:05 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97327675&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97327675&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -191,62 +233,65 @@ private static void serializeMeter(DataOutputStream dos, Meter meter) throws IOE&lt;br/&gt;
     		 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param data serialized metrics&lt;/li&gt;
	&lt;li&gt;@return A list containing the deserialized metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws IOException&lt;br/&gt;
     		 */&lt;/li&gt;
	&lt;li&gt;public List&amp;lt;MetricDump&amp;gt; deserialize(byte[] data) throws IOException {&lt;/li&gt;
	&lt;li&gt;ByteArrayInputStream bais = new ByteArrayInputStream(data);&lt;/li&gt;
	&lt;li&gt;DataInputStream dis = new DataInputStream(bais);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int numCounters = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numGauges = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numHistograms = dis.readInt();&lt;/li&gt;
	&lt;li&gt;int numMeters = dis.readInt();&lt;br/&gt;
    +		public List&amp;lt;MetricDump&amp;gt; deserialize(MetricDumpSerialization.MetricSerializationResult data) {&lt;br/&gt;
    +			DataInputView in = new DataInputDeserializer(data.data, 0, data.data.length);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;List&amp;lt;MetricDump&amp;gt; metrics = new ArrayList&amp;lt;&amp;gt;(numCounters + numGauges + numHistograms);&lt;br/&gt;
    +			List&amp;lt;MetricDump&amp;gt; metrics = new ArrayList&amp;lt;&amp;gt;(data.numCounters + data.numGauges + data.numHistograms + data.numMeters);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int x = 0; x &amp;lt; numCounters; x++) {&lt;/li&gt;
	&lt;li&gt;metrics.add(deserializeCounter(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numCounters; x++) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				try {
    +					metrics.add(deserializeCounter(in));
    +				} catch (Exception e) {
    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);
    +				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
    -			for (int x = 0; x &amp;lt; numGauges; x++) {&lt;br/&gt;
    -				metrics.add(deserializeGauge(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numGauges; x++) {&lt;br/&gt;
    +				try {
    +					metrics.add(deserializeGauge(in));
    +				} catch (Exception e) {    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);    +				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int x = 0; x &amp;lt; numHistograms; x++) {&lt;/li&gt;
	&lt;li&gt;metrics.add(deserializeHistogram(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numHistograms; x++) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				try {
    +					metrics.add(deserializeHistogram(in));
    +				} catch (Exception e) {
    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);
    +				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
    -			for (int x = 0; x &amp;lt; numMeters; x++) {&lt;br/&gt;
    -				metrics.add(deserializeMeter(dis));&lt;br/&gt;
    +			for (int x = 0; x &amp;lt; data.numMeters; x++) {&lt;br/&gt;
    +				try {
    +					metrics.add(deserializeMeter(in));
    +				} catch (Exception e) {    +					LOG.warn(&quot;Failed to deserialize counter.&quot;, e);    +				}     			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return metrics;&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static String deserializeString(DataInputStream dis) throws IOException 
{
    -		int stringLength = dis.readInt();
    -		byte[] bytes = new byte[stringLength];
    -		dis.readFully(bytes);
    -		return new String(bytes);
    -	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static MetricDump.CounterDump deserializeCounter(DataInputStream dis) throws IOException {&lt;br/&gt;
    +	private static MetricDump.CounterDump deserializeCounter(DataInputView dis) throws IOException {&lt;br/&gt;
     		QueryScopeInfo scope = deserializeMetricInfo(dis);&lt;/li&gt;
	&lt;li&gt;String name = deserializeString(dis);&lt;/li&gt;
	&lt;li&gt;return new MetricDump.CounterDump(scope, name, dis.readLong());&lt;br/&gt;
    +		String name = dis.readUTF();&lt;br/&gt;
    +		long count = dis.readLong();&lt;br/&gt;
    +		return new MetricDump.CounterDump(scope, name, count);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Personally for short methods i think it&apos;s overkill. I would do it for methods like `deserializaHistogram` though.&lt;/p&gt;</comment>
                            <comment id="15834724" author="githubbot" created="Mon, 23 Jan 2017 15:13:57 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @uce I&apos;ve addressed your comments.&lt;/p&gt;</comment>
                            <comment id="15834770" author="githubbot" created="Mon, 23 Jan 2017 15:39:25 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128#discussion_r97343787&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128#discussion_r97343787&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/dump/MetricDumpSerialization.java &amp;#8212;&lt;br/&gt;
    @@ -70,16 +93,26 @@ public MetricSerializationResult(byte[] data, int numCounters, int numGauges, in&lt;br/&gt;
     	//-------------------------------------------------------------------------&lt;br/&gt;
     	// Serialization&lt;br/&gt;
     	//-------------------------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
     	public static class MetricDumpSerializer {&lt;br/&gt;
    +&lt;br/&gt;
     		private DataOutputSerializer buffer = new DataOutputSerializer(1024 * 32);&lt;/p&gt;

&lt;p&gt;     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Serializes the given metrics and returns the resulting byte array.&lt;br/&gt;
    +		 * &lt;br/&gt;
    +		 * Should a 
{@link Metric}
&lt;p&gt; accessed in this method throw an exception it will be omitted from the returned&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Very nice &lt;/p&gt;</comment>
                            <comment id="15834837" author="githubbot" created="Mon, 23 Jan 2017 16:27:51 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging.&lt;/p&gt;</comment>
                            <comment id="15835215" author="githubbot" created="Mon, 23 Jan 2017 21:18:59 +0000"  >&lt;p&gt;Github user zentol closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3128&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15835223" author="zentol" created="Mon, 23 Jan 2017 21:22:11 +0000"  >&lt;p&gt;master: 77047244a1ca2456c2b9fdf7083dd3a7c3aba029 &amp;amp; a8e85a2d5abcaf2defab27be0027190ac3ecb5d5&lt;br/&gt;
1.2: 30419ff4a173965a144bf6e44810cf0d17f3962d &amp;amp; b323f66a6b3861b42fb0ae0c5b7cb4163529525a&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38kpj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>