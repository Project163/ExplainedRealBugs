<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:22:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-36663] [Window]The first processWatermark() after Sliding Window restore may have extra expired data.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-36663</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The root cause is that the currentWatermark of TimerService is not restored after restore.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13072634/13072634_image-2024-11-06-19-43-58-569.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This will cause problems when using the sliding window, such as hopping window. Because when flushing WindowBuffer, it is necessary to determine whether the current &amp;lt;key, slice_end&amp;gt; is expired. Here, the currentWatermark in the TimerService is used, and the currentWatermark in the TimerService will only be updated to the &amp;lt;currentWatermark saved in the window&amp;gt; when advance.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13072633/13072633_image-2024-11-06-19-47-37-225.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This will cause that after restore and before the first advance, if processElement(&amp;lt;key, slice_end&amp;gt; ), the slice_end has been triggered, but because this slice is included in other untriggered windows, the data &amp;lt;key, slice_end&amp;gt; will be written to the windowBuffer. (At this time, &amp;lt;the currentWatermark in the window&amp;gt; is used to determine whether the data is expired, and &amp;lt;the currentWatermark in the window&amp;gt; is restored):&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13072632/13072632_image-2024-11-06-19-50-35-362.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;However, because &amp;lt;the currentWatermark in timeService&amp;gt; is used when flushWindowBuffer, it is determined that the slice has not expired and the timer is registered.&lt;br/&gt;
This will cause an expired slice_end to be registered, resulting in an expired window being triggered and output extra data.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have writen a UT to prove this problem:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://aone.alibaba-inc.com/v2/api/workitem/adapter/file/url?fileIdentifier=workitem%2Falibaba%2F875140%2F1730810319419%E6%88%AA%E5%B1%8F2024-11-05%2020.38.19.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Triggering restore will have different results. You can remove the restore part in the red box and the test will pass.&lt;/p&gt;

&lt;p&gt;use hopping window, window size = 3000, we have window range:[-1000,2000), &lt;span class=&quot;error&quot;&gt;&amp;#91;0, 3000&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;processWatermark (currentWatermark = 2001)&lt;/p&gt;

&lt;p&gt;processElement:&#160; &#160; &#160;the expired record &amp;lt;&quot;key2&quot;, 1, fromEpochMillis(1500L)&amp;gt;&lt;/p&gt;

&lt;p&gt;if no restore after processWatermark (currentWatermark = 2001):&lt;/p&gt;

&lt;p&gt;the expired record will not output in window range [-1000,2000).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;if restore after processWatermark (currentWatermark = 2001):&lt;/p&gt;

&lt;p&gt;the expired record will not output in window range [-1000,2000).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Repair suggestions&#65306;&lt;/p&gt;

&lt;p&gt;While restoring the window currentWatermark, restore the currentWatermark in the timeService&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13597897">FLINK-36663</key>
            <summary>[Window]The first processWatermark() after Sliding Window restore may have extra expired data.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xingmo">kaitian</assignee>
                                    <reporter username="xingmo">kaitian</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>window</label>
                    </labels>
                <created>Wed, 6 Nov 2024 12:06:47 +0000</created>
                <updated>Fri, 11 Jul 2025 01:55:08 +0000</updated>
                            <resolved>Tue, 8 Jul 2025 07:09:22 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>1.20.1</version>
                    <version>2.1.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="17903051" author="tomncooper" created="Wed, 4 Dec 2024 16:35:39 +0000"  >&lt;p&gt;Instead of pasting screen shots could you not have used {{&lt;tt&gt;code:java&lt;/tt&gt;}} blocks? It makes this issue very hard to parse.&lt;/p&gt;</comment>
                            <comment id="18003678" author="xuyangzhong" created="Tue, 8 Jul 2025 07:08:01 +0000"  >&lt;p&gt;Merged into&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master: fdce52cfa2ee914d5613976857399e60e84662aa&lt;/li&gt;
	&lt;li&gt;2.1: 6e98fcb525301903e79dc9c61941b24446d3897c&lt;/li&gt;
	&lt;li&gt;2.0: c5689c41f660370d12c80eb9231dd73a2893320c&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13622675">FLINK-38055</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13072634" name="image-2024-11-06-19-43-58-569.png" size="1262713" author="xingmo" created="Wed, 6 Nov 2024 11:44:00 +0000"/>
                            <attachment id="13072633" name="image-2024-11-06-19-47-37-225.png" size="1806431" author="xingmo" created="Wed, 6 Nov 2024 11:47:39 +0000"/>
                            <attachment id="13072632" name="image-2024-11-06-19-50-35-362.png" size="1968397" author="xingmo" created="Wed, 6 Nov 2024 11:50:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1seq8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>