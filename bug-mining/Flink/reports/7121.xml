<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:17:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-30596] Multiple POST /jars/:jarid/run requests with the same jobId, runs duplicate jobs</title>
                <link>https://issues.apache.org/jira/browse/FLINK-30596</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Analysis from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The problem is the following: When submitting a job, then the &lt;tt&gt;Dispatcher&lt;/tt&gt; will wait for the termination of a previous &lt;tt&gt;JobMaster&lt;/tt&gt;. This is done to enable the proper cleanup of the job resources. In the initial submission case, there is no previous &lt;tt&gt;JobMaster&lt;/tt&gt; with the same &lt;tt&gt;jobId&lt;/tt&gt;. The problem is now that Flink schedules the &lt;a href=&quot;https://github.com/apache/flink/blob/5f924bc84227a3a6c67b44e82c45fe444393f577/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java#L571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;persistAndRunJob&lt;/tt&gt;&lt;/a&gt; action, which runs the newly submitted job, as &lt;a href=&quot;https://github.com/apache/flink/blob/5f924bc84227a3a6c67b44e82c45fe444393f577/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java#L1312-L1318&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;an asynchronous task&lt;/a&gt;. This is done to ensure that the action is run on the &lt;tt&gt;Dispatcher&lt;/tt&gt;&apos;s main thread since the termination future can be run on a different thread. Due to this behaviour, there can be other tasks enqueued in the &lt;tt&gt;Dispatcher&lt;/tt&gt;&apos;s work queue which are executed before. Such a task could be another job submission which wouldn&apos;t see that there is already a job submitted with the same &lt;tt&gt;jobId&lt;/tt&gt; since &lt;a href=&quot;https://github.com/apache/flink/blob/5f924bc84227a3a6c67b44e82c45fe444393f577/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java#L602&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;we only do this in &lt;tt&gt;runJob&lt;/tt&gt;&lt;/a&gt; which is called by &lt;tt&gt;persistAndRunJob&lt;/tt&gt;. This is the reason why you don&apos;t see a duplicate job submission exception for the second job submission. Even worse, this will eventually &lt;a href=&quot;https://github.com/apache/flink/blob/5f924bc84227a3a6c67b44e82c45fe444393f577/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java#L611-L615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;lead to an invalid state&lt;/a&gt; and fail the whole cluster entrypoint.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The following fix to the &lt;tt&gt;Dispatcher&lt;/tt&gt; seems to fix the issue, but before submitting a PR, I wanted to post this for possible follow up discussions:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; CompletableFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; waitForTerminatingJob(
            JobID jobId, JobGraph jobGraph, ThrowingConsumer&amp;lt;JobGraph, ?&amp;gt; action) {
        ...
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; FutureUtils.thenAcceptAsyncIfNotDone(
                jobManagerTerminationFuture,
                getMainThreadExecutor(),
                FunctionUtils.uncheckedConsumer(
                    (ignored) -&amp;gt; {
                        jobManagerRunnerTerminationFutures.remove(jobId);
                        action.accept(jobGraph);
                    }));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13517089">FLINK-30596</key>
            <summary>Multiple POST /jars/:jarid/run requests with the same jobId, runs duplicate jobs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="morezaei00">Mohsen Rezaei</assignee>
                                    <reporter username="morezaei00">Mohsen Rezaei</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 6 Jan 2023 21:57:28 +0000</created>
                <updated>Fri, 14 Jul 2023 16:21:11 +0000</updated>
                            <resolved>Mon, 3 Jul 2023 09:31:16 +0000</resolved>
                                    <version>1.17.0</version>
                    <version>1.16.1</version>
                    <version>1.18.0</version>
                                    <fixVersion>1.18.0</fixVersion>
                    <fixVersion>1.16.3</fixVersion>
                    <fixVersion>1.17.2</fixVersion>
                                    <component>Runtime / REST</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17683297" author="weijie guo" created="Thu, 2 Feb 2023 09:11:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=morezaei00&quot; class=&quot;user-hover&quot; rel=&quot;morezaei00&quot;&gt;morezaei00&lt;/a&gt; Are you still doing this work? If not, I would like to continue.&lt;/p&gt;</comment>
                            <comment id="17683529" author="JIRAUSER298550" created="Thu, 2 Feb 2023 18:53:54 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt;, I&apos;d opened a discussion on the dev listing for feedback on the change, but it appears that there are no objections/feedback.&lt;/p&gt;

&lt;p&gt;I&apos;ll go ahead and create a PR for this today.&lt;/p&gt;</comment>
                            <comment id="17686006" author="JIRAUSER298550" created="Wed, 8 Feb 2023 17:39:53 +0000"  >&lt;p&gt;I was hoping to shine some light on this issue given that it affects any application using the REST endpoints to run/submit jobs, causing confusion on the actual state of the submitted jobs in a cluster.&lt;/p&gt;

&lt;p&gt;I&apos;ve created a PR against the &lt;tt&gt;master&lt;/tt&gt; branch, and I&apos;d like to be able to port it back to &lt;tt&gt;1.16.2&lt;/tt&gt; and &lt;tt&gt;1.15.4&lt;/tt&gt; to close the loop on the issue for the last three major releases:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/pull/21849&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/21849&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Could I get someone from the Runtime team to take a look at the PR?&lt;/p&gt;</comment>
                            <comment id="17723038" author="renqs" created="Tue, 16 May 2023 08:12:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=morezaei00&quot; class=&quot;user-hover&quot; rel=&quot;morezaei00&quot;&gt;morezaei00&lt;/a&gt; Any updates on this issue? Thanks&lt;/p&gt;</comment>
                            <comment id="17738183" author="zentol" created="Wed, 28 Jun 2023 15:45:49 +0000"  >&lt;p&gt;master: b528d9b81c03345c0415490fc41e27968313e5f0&lt;br/&gt;
1.17: 91e1314fedafc7a23fc239dcbb7907ec2b32d1bb&lt;br/&gt;
1.16: 9b073c97e5e758dcfda40bc064fadd5b52dd4327&lt;/p&gt;</comment>
                            <comment id="17738358" author="JIRAUSER298550" created="Thu, 29 Jun 2023 04:12:03 +0000"  >&lt;p&gt;I&apos;ve backported the fix for 1.17 and 1.16. Please see GitHub links.&lt;/p&gt;</comment>
                            <comment id="17738434" author="zentol" created="Thu, 29 Jun 2023 08:39:59 +0000"  >&lt;p&gt;I&apos;ve already started the backports and was just waiting for CI, closing the PRs.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1emuw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>