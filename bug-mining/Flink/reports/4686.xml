<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19154] Application mode deletes HA data in case of suspended ZooKeeper connection</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19154</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;A user reported that Flink&apos;s application mode deletes HA data in case of a suspended ZooKeeper connection &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. &lt;/p&gt;

&lt;p&gt;The problem seems to be that the &lt;tt&gt;ApplicationDispatcherBootstrap&lt;/tt&gt; class produces an exception (that the request job can no longer be found because of a lost ZooKeeper connection) which will be interpreted as a job failure. Due to this interpretation, the cluster will be shut down with a terminal state of FAILED which will cause the HA data to be cleaned up. The exact problem occurs in the &lt;tt&gt;JobStatusPollingUtils.getJobResult&lt;/tt&gt; which is called by &lt;tt&gt;ApplicationDispatcherBootstrap.getJobResult()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The above described behaviour can be found in this log &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Checkpoint-metadata-deleted-by-Flink-after-ZK-connection-issues-td37937.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Checkpoint-metadata-deleted-by-Flink-after-ZK-connection-issues-td37937.html&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://pastebin.com/raw/uH9KDU2L&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://pastebin.com/raw/uH9KDU2L&lt;/a&gt;&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Run a stand-alone cluster that runs a single job (if you are familiar with the way Ververica Platform runs Flink jobs, we use a very similar approach). It runs Flink 1.11.1 straight from the official docker image.&lt;/p&gt;</environment>
        <key id="13326280">FLINK-19154</key>
            <summary>Application mode deletes HA data in case of suspended ZooKeeper connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkl0u">Kostas Kloudas</assignee>
                                    <reporter username="568793005@qq.com">Husky Zeng</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 7 Sep 2020 09:36:03 +0000</created>
                <updated>Mon, 2 Nov 2020 08:44:50 +0000</updated>
                            <resolved>Mon, 26 Oct 2020 13:40:54 +0000</resolved>
                                    <version>1.11.1</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.11.3</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Client / Job Submission</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="17192192" author="rmetzger" created="Tue, 8 Sep 2020 12:55:12 +0000"  >&lt;p&gt;Let&apos;s first understand the problem properly on the user mailing list.&lt;/p&gt;</comment>
                            <comment id="17203246" author="till.rohrmann" created="Mon, 28 Sep 2020 13:57:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkl0u&quot; class=&quot;user-hover&quot; rel=&quot;kkl0u&quot;&gt;kkl0u&lt;/a&gt;, there seems to be a problem with the application mode and the failure handling. I believe that some framework errors are treated as a proper Flink job failure which leads to the deletion of HA data even though one would like to keep this data. Could you take care of this problem?&lt;/p&gt;

&lt;p&gt;I think there are two problems here: First of all not every exception bubbling up in the future returned by &lt;tt&gt;ApplicationDispatcherBootstrap.fixJobIdAndRunApplicationAsync()&lt;/tt&gt; indicates a job failure. Some of them can also indicate a framework failure which should not lead to the clean up of HA data. The other problem is that the polling logic cannot properly handle a temporary connection loss to ZooKeeper which is a normal situation.&lt;/p&gt;</comment>
                            <comment id="17203288" author="kkl0u" created="Mon, 28 Sep 2020 15:06:32 +0000"  >&lt;p&gt;I will have a look.&lt;/p&gt;</comment>
                            <comment id="17204168" author="casidiablo" created="Tue, 29 Sep 2020 17:47:09 +0000"  >&lt;p&gt;Hello guys! Good timing. This happened again yesterday. And it happened around the time one of our zookeeper nodes restarted (typical kubernetes shuffling, so not a ZK issue). I would be super happy to provide more details.&lt;/p&gt;

&lt;p&gt;One interesting but challenging characteristic of this bug is that this only affected one of the jobs out of more than 40 we run. The other jobs just restarted, but their state was preserved.&lt;/p&gt;

&lt;p&gt;But for one of the jobs we were unlucky and the job manager wiped out the state out of ZK. Pretty much the same logs as stated in this ticket.&lt;/p&gt;</comment>
                            <comment id="17204747" author="kkl0u" created="Wed, 30 Sep 2020 13:57:35 +0000"  >&lt;p&gt;Disclaimer: I am not super-familiar with ZK and the steps involved in HA failover and what I am saying may be wrong. &lt;/p&gt;

&lt;p&gt;From the discussion here I understand that there is a ZK transitive issue and Flink detects it and restarts the affected jobs. During the restarting process, Flink tells ZK to delete the HA data. &lt;/p&gt;

&lt;p&gt;In this last part, there seems to be a race condition, right? ZK is down (triggered the failure) and then it comes back up. In the meantime jobs are shutting down and tell ZK to delete their data. Can it be that for most of the jobs ZK is still down when they try to delete their HA data and the request fails while for the &quot;unlucky one&quot; this is not the case?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=casidiablo&quot; class=&quot;user-hover&quot; rel=&quot;casidiablo&quot;&gt;casidiablo&lt;/a&gt; Is there anything in the logs of the jobs that successfully restarted (their logs during failure) that could justify such an explanation?&lt;/p&gt;</comment>
                            <comment id="17204790" author="till.rohrmann" created="Wed, 30 Sep 2020 14:51:04 +0000"  >&lt;p&gt;I think the causing problem is &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-09-04 17:32:07,950 WARN  org.apache.flink.client.deployment.application.ApplicationDispatcherBootstrap [] - Application FAILED: 
java.util.concurrent.CompletionException: org.apache.flink.runtime.messages.FlinkJobNotFoundException: Could not find Flink job (00000000000000000000000000000000)
	at org.apache.flink.runtime.dispatcher.Dispatcher.lambda$requestJobStatus$17(Dispatcher.java:529) ~[flink-dist_2.11-1.11.1.jar:1.11.1]
	at java.util.concurrent.CompletableFuture.uniExceptionally(CompletableFuture.java:884) ~[?:1.8.0_262]
	at java.util.concurrent.CompletableFuture.uniExceptionallyStage(CompletableFuture.java:898) ~[?:1.8.0_262]
	at java.util.concurrent.CompletableFuture.exceptionally(CompletableFuture.java:2209) ~[?:1.8.0_262]
	at org.apache.flink.runtime.dispatcher.Dispatcher.requestJobStatus(Dispatcher.java:523) ~[flink-dist_2.11-1.11.1.jar:1.11.1]
	at org.apache.flink.client.deployment.application.JobStatusPollingUtils.lambda$getJobResult$0(JobStatusPollingUtils.java:57) ~[flink-dist_2.11-1.11.1.jar:1.11.1]
	at org.apache.flink.client.deployment.application.JobStatusPollingUtils.pollJobResultAsync(JobStatusPollingUtils.java:81) ~[flink-dist_2.11-1.11.1.jar:1.11.1]
	at org.apache.flink.client.deployment.application.JobStatusPollingUtils.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$3(JobStatusPollingUtils.java:96) ~[flink-dist_2.11-1.11.1.jar:1.11.1]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [?:1.8.0_262]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) [?:1.8.0_262]
	at org.apache.flink.runtime.concurrent.akka.ActorSystemScheduledExecutorAdapter$ScheduledFutureTask.run(ActorSystemScheduledExecutorAdapter.java:154) [flink-dist_2.11-1.11.1.jar:1.11.1]
	at akka.dispatch.TaskInvocation.run(AbstractDispatcher.scala:40) [usercode.jar:?]
	at akka.dispatch.ForkJoinExecutorConfigurator$AkkaForkJoinTask.exec(ForkJoinExecutorConfigurator.scala:44) [usercode.jar:?]
	at akka.dispatch.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260) [usercode.jar:?]
	at akka.dispatch.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339) [usercode.jar:?]
	at akka.dispatch.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979) [usercode.jar:?]
	at akka.dispatch.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107) [usercode.jar:?]
Caused by: org.apache.flink.runtime.messages.FlinkJobNotFoundException: Could not find Flink job (00000000000000000000000000000000)
	at org.apache.flink.runtime.dispatcher.Dispatcher.getJobMasterGatewayFuture(Dispatcher.java:807) ~[flink-dist_2.11-1.11.1.jar:1.11.1]
	at org.apache.flink.runtime.dispatcher.Dispatcher.requestJobStatus(Dispatcher.java:518) ~[flink-dist_2.11-1.11.1.jar:1.11.1]
	... 12 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which is caused by the ZK being down. Since we treat exceptions coming from the &lt;tt&gt;ApplicationDispatcherBootstrap.fixJobIdAndRunApplicationAsync&lt;/tt&gt; as a &lt;tt&gt;FAILED&lt;/tt&gt; job state, Flink will clean the HA data up.&lt;/p&gt;</comment>
                            <comment id="17204791" author="kkl0u" created="Wed, 30 Sep 2020 14:55:16 +0000"  >&lt;p&gt;Yes, I agree. This is what we have to disambiguate. Some exceptions should be treated as job failures and some not. But this seems like a pretty impossible task that even if it is done correctly, it is also hard to maintain, right? There does not seem to be a specific type of exception that we should filter out.&lt;/p&gt;</comment>
                            <comment id="17204824" author="till.rohrmann" created="Wed, 30 Sep 2020 15:41:00 +0000"  >&lt;p&gt;At the moment there is no easy distinction between framework exceptions and user code exceptions, unfortunately.&lt;/p&gt;</comment>
                            <comment id="17207847" author="rmetzger" created="Mon, 5 Oct 2020 06:25:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkl0u&quot; class=&quot;user-hover&quot; rel=&quot;kkl0u&quot;&gt;kkl0u&lt;/a&gt; can I assign you to this ticket?&lt;/p&gt;</comment>
                            <comment id="17207896" author="kkl0u" created="Mon, 5 Oct 2020 08:03:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt; I assigned it to me. &lt;/p&gt;</comment>
                            <comment id="17211377" author="casidiablo" created="Fri, 9 Oct 2020 20:39:12 +0000"  >&lt;p&gt;I failed to capture the logs from the pods where this didn&apos;t happen... but it happened again to almost ALL of our jobs. This is a really nasty bug with a huge impact on production systems.&lt;/p&gt;

&lt;p&gt;I really hope it gets the traction and attention it needs. I don&apos;t know why no one else has reported it (we barely run 70 Flink jobs, I&apos;m sure there are companies running way more).&lt;/p&gt;</comment>
                            <comment id="17211397" author="kkl0u" created="Fri, 9 Oct 2020 21:00:31 +0000"  >&lt;p&gt;Hi Christian, I have a fix and I am planning to open a PR soon. I will send you here when I do so that you can also check it out.&lt;/p&gt;</comment>
                            <comment id="17211405" author="kkl0u" created="Fri, 9 Oct 2020 21:05:51 +0000"  >&lt;p&gt;This is the branch &lt;a href=&quot;https://github.com/kl0u/flink/tree/FLINK-19154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kl0u/flink/tree/FLINK-19154&lt;/a&gt; based on which I am planning to open a PR as soon as our tests give the green light. It would be really helpful if you could try it out and let us know if this solves the issue.&lt;/p&gt;</comment>
                            <comment id="17220700" author="kkl0u" created="Mon, 26 Oct 2020 13:40:54 +0000"  >&lt;p&gt;master: f29a18e0f01c5bddffb8fa60c7b769b8c418f453&lt;br/&gt;
1.11: 3dd57624b2df7a856352a64a89af8606ae0c61a4&lt;/p&gt;</comment>
                            <comment id="17221652" author="casidiablo" created="Tue, 27 Oct 2020 18:34:45 +0000"  >&lt;p&gt;When are you guys planning to release these changes?&lt;/p&gt;

&lt;p&gt;I tried using them (i.e. building a Flink docker image with these changes) but hit a wall: these changes are not backwards compatible.&lt;/p&gt;

&lt;p&gt;The changes to the `flink-clients` (moving the AbstractDispatcherBootstrap class) mean that not only I need to upgrade the Flink cluster but also re compile all my jobs against these new changes. Since these changes are not in Maven yet, I also need to publish the jars to my own repository, etc.&lt;/p&gt;

&lt;p&gt;What&apos;s more, since this is not backwards compatible, I guess it makes no sense to make it part of the 1.11 branch?&lt;/p&gt;</comment>
                            <comment id="17221779" author="casidiablo" created="Tue, 27 Oct 2020 21:42:10 +0000"  >&lt;p&gt;For the record, this does seem to fix the issue. We haven&apos;t been able to reproduce the problem after upgrading our test environment to this new version&lt;/p&gt;</comment>
                            <comment id="17221998" author="tzulitai" created="Wed, 28 Oct 2020 07:16:09 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=casidiablo&quot; class=&quot;user-hover&quot; rel=&quot;casidiablo&quot;&gt;casidiablo&lt;/a&gt;, there is an ongoing discussion for releasing Flink 1.11.3 that would include this fix.&lt;br/&gt;
Hopefully this should happen soon:&lt;br/&gt;
&lt;a href=&quot;http://apache-flink-mailing-list-archive.1008284.n3.nabble.com/DISCUSS-Releasing-Apache-Flink-1-11-3-td45989.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-mailing-list-archive.1008284.n3.nabble.com/DISCUSS-Releasing-Apache-Flink-1-11-3-td45989.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17222045" author="till.rohrmann" created="Wed, 28 Oct 2020 08:56:25 +0000"  >&lt;p&gt;Thanks for trying this fix out &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=casidiablo&quot; class=&quot;user-hover&quot; rel=&quot;casidiablo&quot;&gt;casidiablo&lt;/a&gt; and happy to hear that it solved your problem.&lt;/p&gt;

&lt;p&gt;If you want to use Flink&apos;s snapshot artifacts, then you have to add&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;repositories&amp;gt;
  &amp;lt;repository&amp;gt;
    &amp;lt;id&amp;gt;snapshot&amp;lt;/id&amp;gt;
    &amp;lt;name&amp;gt;Apache Snapshot repository&amp;lt;/name&amp;gt;
    &amp;lt;url&amp;gt;https:&lt;span class=&quot;code-comment&quot;&gt;//repository.apache.org/content/repositories/snapshots/&amp;lt;/url&amp;gt;
&lt;/span&gt;    &amp;lt;snapshotPolicy&amp;gt;always&amp;lt;/snapshotPolicy&amp;gt;
  &amp;lt;/repository&amp;gt;
&amp;lt;/repositories&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to your &lt;tt&gt;pom.xml&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If you do not bundle Flink dependencies with your user jar which you put into your image, then it should actually not be necessary to recompile the user jar (unless we introduced an incompatible change with Flink 1.12).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13338278">FLINK-19909</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0idso:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>