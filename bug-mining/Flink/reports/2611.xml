<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10150] Chained batch operators interfere with each other other</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10150</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The flink web ui displays an inconsistent number of &quot;Records received&quot; / &quot;Records sent&#8221; in the job overview &quot;Subtasks&quot; view.&lt;/p&gt;

&lt;p&gt;When I run the example wordcount batch job with a small input file on flink 1.3.2&#160;I get&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;3 records sent by the first subtask and&lt;/li&gt;
	&lt;li&gt;3 records received by the second subtask&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is the result I would expect.&lt;/p&gt;


&lt;p&gt;If I run the same job on flink 1.4.0 / 1.5.2 / 1.6.0 I get&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;13 records sent by the first subtask and&lt;/li&gt;
	&lt;li&gt;3 records received by the second subtask&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In real life jobs the numbers are much more strange.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13179069">FLINK-10150</key>
            <summary>Chained batch operators interfere with each other other</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="lethum">Helmut Zechmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 15 Aug 2018 13:06:33 +0000</created>
                <updated>Thu, 25 Oct 2018 09:07:31 +0000</updated>
                            <resolved>Wed, 5 Sep 2018 08:04:59 +0000</resolved>
                                    <version>1.4.0</version>
                    <version>1.5.0</version>
                    <version>1.6.0</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.5.4</fixVersion>
                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                    <component>Runtime / Web Frontend</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16587716" author="githubbot" created="Tue, 21 Aug 2018 16:46:11 +0000"  >&lt;p&gt;zentol opened a new pull request #6599: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10150&quot; title=&quot;Chained batch operators interfere with each other other&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10150&quot;&gt;&lt;del&gt;FLINK-10150&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Fix OperatorMetricGroup creation for Batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6599&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6599&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This PR fixes a severe issue in the metric system where chained batch operators would always operate on the same `OperatorMetricGroup`. As a result most Flink-provided metrics were not exposed for chained operators at all, while other metrics, like task-level IO metrics, were render incorrect.&lt;/p&gt;

&lt;p&gt;   The problem is that we used the tasks `VertexID` to identify operators; which is obviously identical for all operators in a chain. We now use the vertexID and operator name to identify them.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul&gt;
	&lt;li&gt;fix identification in `TaskMetricGroup` by using both the ID and operator name&lt;/li&gt;
	&lt;li&gt;extend `MockEnvironment&lt;span class=&quot;error&quot;&gt;&amp;#91;Builder&amp;#93;&lt;/span&gt;` to allow the `TaskMetricGroup` to be set&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change added tests:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;ChainedOperatorsMetricTest&lt;/li&gt;
	&lt;li&gt;run a basic wordcount as described in the JIRA and verify the results via the UI/reporter of your choice&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16596294" author="githubbot" created="Wed, 29 Aug 2018 13:04:23 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #6599: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10150&quot; title=&quot;Chained batch operators interfere with each other other&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10150&quot;&gt;&lt;del&gt;FLINK-10150&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Fix OperatorMetricGroup creation for Batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6599#discussion_r213666345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6599#discussion_r213666345&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -144,15 +144,17 @@ public OperatorMetricGroup addOperator(OperatorID operatorID, String name) &lt;/p&gt;
{
 			name = name.substring(0, METRICS_OPERATOR_NAME_MAX_LENGTH);
 		}
&lt;p&gt; 		OperatorMetricGroup operator = new OperatorMetricGroup(this.registry, this, operatorID, name);&lt;br/&gt;
+		// unique OperatorIDs only exist in streaming, so we have to rely on the name for batch operators&lt;br/&gt;
+		final String key = operatorID + name;&lt;/p&gt;

&lt;p&gt; 		synchronized (this) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;OperatorMetricGroup previous = operators.put(operatorID, operator);&lt;br/&gt;
+			OperatorMetricGroup previous = operators.put(key, operator);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I suggest to reduce the code under `synchronized` using:&lt;br/&gt;
   ```&lt;br/&gt;
   return operators.putIfAbsent(key, operator);&lt;br/&gt;
   ```&lt;br/&gt;
   Also, I would rename `addOperator` function name to `getOrAddOperatorMetric`.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601901" author="githubbot" created="Mon, 3 Sep 2018 08:43:39 +0000"  >&lt;p&gt;zentol commented on a change in pull request #6599: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10150&quot; title=&quot;Chained batch operators interfere with each other other&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10150&quot;&gt;&lt;del&gt;FLINK-10150&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Fix OperatorMetricGroup creation for Batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6599#discussion_r214614670&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6599#discussion_r214614670&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -144,15 +144,17 @@ public OperatorMetricGroup addOperator(OperatorID operatorID, String name) &lt;/p&gt;
{
 			name = name.substring(0, METRICS_OPERATOR_NAME_MAX_LENGTH);
 		}
&lt;p&gt; 		OperatorMetricGroup operator = new OperatorMetricGroup(this.registry, this, operatorID, name);&lt;br/&gt;
+		// unique OperatorIDs only exist in streaming, so we have to rely on the name for batch operators&lt;br/&gt;
+		final String key = operatorID + name;&lt;/p&gt;

&lt;p&gt; 		synchronized (this) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;OperatorMetricGroup previous = operators.put(operatorID, operator);&lt;br/&gt;
+			OperatorMetricGroup previous = operators.put(key, operator);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I will rename the method but leave the code as is. It was intentionally written that way so that we only do a single lookup on the happy path. The default implementation of `putIfAbsent` is just syntactic sugar for separate get/put calls. While the HashMap &lt;em&gt;implementation&lt;/em&gt; of this method is indeed more efficient in this regard this is an implementation detail.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16602142" author="githubbot" created="Mon, 3 Sep 2018 13:03:34 +0000"  >&lt;p&gt;zentol closed pull request #6599: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10150&quot; title=&quot;Chained batch operators interfere with each other other&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10150&quot;&gt;&lt;del&gt;FLINK-10150&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Fix OperatorMetricGroup creation for Batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6599&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6599&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java b/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
index 441dbf8ea58..39d98d82fc8 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
@@ -42,7 +42,7 @@&lt;br/&gt;
 @Internal&lt;br/&gt;
 public class TaskMetricGroup extends ComponentMetricGroup&amp;lt;TaskManagerJobMetricGroup&amp;gt; {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final Map&amp;lt;OperatorID, OperatorMetricGroup&amp;gt; operators = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+	private final Map&amp;lt;String, OperatorMetricGroup&amp;gt; operators = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	static final int METRICS_OPERATOR_NAME_MAX_LENGTH = 80;&lt;/p&gt;

&lt;p&gt;@@ -134,25 +134,27 @@ public TaskIOMetricGroup getIOMetricGroup() {&lt;br/&gt;
 	//  operators and cleanup&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public OperatorMetricGroup addOperator(String name) {&lt;/li&gt;
	&lt;li&gt;return addOperator(OperatorID.fromJobVertexID(vertexId), name);&lt;br/&gt;
+	public OperatorMetricGroup getOrAddOperator(String name) 
{
+		return getOrAddOperator(OperatorID.fromJobVertexID(vertexId), name);
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public OperatorMetricGroup addOperator(OperatorID operatorID, String name) {&lt;br/&gt;
+	public OperatorMetricGroup getOrAddOperator(OperatorID operatorID, String name) {&lt;br/&gt;
 		if (name != null &amp;amp;&amp;amp; name.length() &amp;gt; METRICS_OPERATOR_NAME_MAX_LENGTH) {&lt;br/&gt;
 			LOG.warn(&quot;The operator name {} exceeded the {} characters length limit and was truncated.&quot;, name, METRICS_OPERATOR_NAME_MAX_LENGTH);&lt;br/&gt;
 			name = name.substring(0, METRICS_OPERATOR_NAME_MAX_LENGTH);&lt;br/&gt;
 		}&lt;br/&gt;
 		OperatorMetricGroup operator = new OperatorMetricGroup(this.registry, this, operatorID, name);&lt;br/&gt;
+		// unique OperatorIDs only exist in streaming, so we have to rely on the name for batch operators&lt;br/&gt;
+		final String key = operatorID + name;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		synchronized (this) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;OperatorMetricGroup previous = operators.put(operatorID, operator);&lt;br/&gt;
+			OperatorMetricGroup previous = operators.put(key, operator);&lt;br/&gt;
 			if (previous == null) 
{
 				// no operator group so far
 				return operator;
 			}
&lt;p&gt; else &lt;/p&gt;
{
 				// already had an operator group. restore that one.
-				operators.put(operatorID, previous);
+				operators.put(key, previous);
 				return previous;
 			}
&lt;p&gt; 		}&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/UnregisteredMetricGroups.java b/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/UnregisteredMetricGroups.java&lt;br/&gt;
index 3869aa642f9..8c635eb994d 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/UnregisteredMetricGroups.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/UnregisteredMetricGroups.java&lt;br/&gt;
@@ -145,7 +145,7 @@ protected UnregisteredTaskMetricGroup() {&lt;br/&gt;
 		}&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public OperatorMetricGroup addOperator(OperatorID operatorID, String name) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+		public OperatorMetricGroup getOrAddOperator(OperatorID operatorID, String name) {
 			return createUnregisteredOperatorMetricGroup();
 		} 	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/BatchTask.java b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/BatchTask.java&lt;br/&gt;
index e6978697b47..d5f2fd01678 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/BatchTask.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/BatchTask.java&lt;br/&gt;
@@ -254,7 +254,7 @@ public void invoke() throws Exception {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		String headName =  getEnvironment().getTaskInfo().getTaskName().split(&quot;-&amp;gt;&quot;)&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;.trim();&lt;br/&gt;
 		this.metrics = getEnvironment().getMetricGroup()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.addOperator(headName.startsWith(&quot;CHAIN&quot;) ? headName.substring(6) : headName);&lt;br/&gt;
+			.getOrAddOperator(headName.startsWith(&quot;CHAIN&quot;) ? headName.substring(6) : headName);&lt;br/&gt;
 		this.metrics.getIOMetricGroup().reuseInputMetricsForTask();&lt;br/&gt;
 		if (config.getNumberOfChainedStubs() == 0) {&lt;br/&gt;
 			this.metrics.getIOMetricGroup().reuseOutputMetricsForTask();&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/DataSinkTask.java b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/DataSinkTask.java&lt;br/&gt;
index 0ea376e8c4d..2c263012d47 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/DataSinkTask.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/DataSinkTask.java&lt;br/&gt;
@@ -409,6 +409,6 @@ public DistributedRuntimeUDFContext createRuntimeContext() 
{
 
 		return new DistributedRuntimeUDFContext(env.getTaskInfo(), getUserCodeClassLoader(),
 				getExecutionConfig(), env.getDistributedCacheEntries(), env.getAccumulatorRegistry().getUserMap(), 
-				getEnvironment().getMetricGroup().addOperator(getEnvironment().getTaskInfo().getTaskName()));
+				getEnvironment().getMetricGroup().getOrAddOperator(getEnvironment().getTaskInfo().getTaskName()));
 	}
&lt;p&gt; }&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/DataSourceTask.java b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/DataSourceTask.java&lt;br/&gt;
index cdfe1fa12f9..a5ccfab8696 100644&lt;/p&gt;&lt;/li&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/DataSourceTask.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/DataSourceTask.java&lt;br/&gt;
@@ -402,6 +402,6 @@ public DistributedRuntimeUDFContext createRuntimeContext() 
{
 		sourceName = sourceName.startsWith(&quot;CHAIN&quot;) ? sourceName.substring(6) : sourceName;
 		return new DistributedRuntimeUDFContext(env.getTaskInfo(), getUserCodeClassLoader(),
 				getExecutionConfig(), env.getDistributedCacheEntries(), env.getAccumulatorRegistry().getUserMap(), 
-				getEnvironment().getMetricGroup().addOperator(sourceName));
+				getEnvironment().getMetricGroup().getOrAddOperator(sourceName));
 	}
&lt;p&gt; }&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/chaining/ChainedDriver.java b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/chaining/ChainedDriver.java&lt;br/&gt;
index 442a53c504a..7dd3a14e5ba 100644&lt;/p&gt;&lt;/li&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/chaining/ChainedDriver.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/chaining/ChainedDriver.java&lt;br/&gt;
@@ -69,7 +69,7 @@ public void setup(TaskConfig config, String taskName, Collector&amp;lt;OT&amp;gt; outputCollec&lt;br/&gt;
 		this.config = config;&lt;br/&gt;
 		this.taskName = taskName;&lt;br/&gt;
 		this.userCodeClassLoader = userCodeClassLoader;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;this.metrics = parent.getEnvironment().getMetricGroup().addOperator(taskName);&lt;br/&gt;
+		this.metrics = parent.getEnvironment().getMetricGroup().getOrAddOperator(taskName);&lt;br/&gt;
 		this.numRecordsIn = this.metrics.getIOMetricGroup().getNumRecordsInCounter();&lt;br/&gt;
 		this.numRecordsOut = this.metrics.getIOMetricGroup().getNumRecordsOutCounter();&lt;br/&gt;
 		this.outputCollector = new CountingCollector&amp;lt;&amp;gt;(outputCollector, numRecordsOut);&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/OperatorGroupTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/OperatorGroupTest.java&lt;br/&gt;
index 58198e4f923..2f62f5593a7 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/OperatorGroupTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/OperatorGroupTest.java&lt;br/&gt;
@@ -93,7 +93,7 @@ public void testGenerateScopeCustom() throws Exception {&lt;br/&gt;
 			OperatorMetricGroup operatorGroup =&lt;br/&gt;
 				new TaskManagerMetricGroup(registry, &quot;theHostName&quot;, tmID)&lt;br/&gt;
 					.addTaskForJob(jid, &quot;myJobName&quot;, vertexId, new ExecutionAttemptID(), &quot;aTaskname&quot;, 13, 2)&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;.addOperator(operatorID, operatorName);&lt;br/&gt;
+					.getOrAddOperator(operatorID, operatorName);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			assertArrayEquals(&lt;br/&gt;
 				new String[]&lt;/p&gt;
{tmID, jid.toString(), vertexId.toString(), operatorName, operatorID.toString()}
&lt;p&gt;,&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroupTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroupTest.java&lt;br/&gt;
index d9e6158ccc8..079c7c63e38 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroupTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroupTest.java&lt;br/&gt;
@@ -176,7 +176,7 @@ public void testOperatorNameTruncation() throws Exception {&lt;br/&gt;
 		TaskMetricGroup taskMetricGroup = new TaskMetricGroup(registry, job, new JobVertexID(), new AbstractID(), &quot;task&quot;, 0, 0);&lt;/p&gt;

&lt;p&gt; 		String originalName = new String(new char&lt;span class=&quot;error&quot;&gt;&amp;#91;100&amp;#93;&lt;/span&gt;).replace(&quot;\0&quot;, &quot;-&quot;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;OperatorMetricGroup operatorMetricGroup = taskMetricGroup.addOperator(originalName);&lt;br/&gt;
+		OperatorMetricGroup operatorMetricGroup = taskMetricGroup.getOrAddOperator(originalName);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		String storedName = operatorMetricGroup.getScopeComponents()&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;;&lt;br/&gt;
 		Assert.assertEquals(TaskMetricGroup.METRICS_OPERATOR_NAME_MAX_LENGTH, storedName.length());&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/chaining/ChainedOperatorsMetricTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/chaining/ChainedOperatorsMetricTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..c393af50b98&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/chaining/ChainedOperatorsMetricTest.java&lt;br/&gt;
@@ -0,0 +1,175 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.runtime.operators.chaining;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.flink.api.common.functions.FlatMapFunction;&lt;br/&gt;
+import org.apache.flink.api.common.functions.RichFlatMapFunction;&lt;br/&gt;
+import org.apache.flink.api.common.operators.util.UserCodeClassWrapper;&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeSerializerFactory;&lt;br/&gt;
+import org.apache.flink.configuration.Configuration;&lt;br/&gt;
+import org.apache.flink.metrics.Counter;&lt;br/&gt;
+import org.apache.flink.runtime.jobgraph.JobVertexID;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.NoOpMetricRegistry;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.OperatorIOMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.OperatorMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.TaskIOMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.TaskMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
+import org.apache.flink.runtime.operators.BatchTask;&lt;br/&gt;
+import org.apache.flink.runtime.operators.DriverStrategy;&lt;br/&gt;
+import org.apache.flink.runtime.operators.FlatMapDriver;&lt;br/&gt;
+import org.apache.flink.runtime.operators.shipping.ShipStrategyType;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.MockEnvironmentBuilder;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.TaskTestBase;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.UniformRecordGenerator;&lt;br/&gt;
+import org.apache.flink.runtime.operators.util.TaskConfig;&lt;br/&gt;
+import org.apache.flink.runtime.testutils.recordutils.RecordSerializerFactory;&lt;br/&gt;
+import org.apache.flink.types.Record;&lt;br/&gt;
+import org.apache.flink.util.AbstractID;&lt;br/&gt;
+import org.apache.flink.util.Collector;&lt;br/&gt;
+&lt;br/&gt;
+import org.junit.Assert;&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.ArrayList;&lt;br/&gt;
+import java.util.List;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Metrics related tests for batch task chains.&lt;br/&gt;
+ */&lt;br/&gt;
+public class ChainedOperatorsMetricTest extends TaskTestBase {&lt;br/&gt;
+&lt;br/&gt;
+	private static final int MEMORY_MANAGER_SIZE = 1024 * 1024 * 3;&lt;br/&gt;
+&lt;br/&gt;
+	private static final int NETWORK_BUFFER_SIZE = 1024;&lt;br/&gt;
+&lt;br/&gt;
+	private static final TypeSerializerFactory&amp;lt;Record&amp;gt; serFact = RecordSerializerFactory.get();&lt;br/&gt;
+&lt;br/&gt;
+	private final List&amp;lt;Record&amp;gt; outList = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+	private static final String HEAD_OPERATOR_NAME = &quot;headoperator&quot;;&lt;br/&gt;
+	private static final String CHAINED_OPERATOR_NAME = &quot;chainedoperator&quot;;&lt;br/&gt;
+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testOperatorIOMetricReuse() throws Exception {&lt;br/&gt;
+		// environment&lt;br/&gt;
+		initEnvironment(MEMORY_MANAGER_SIZE, NETWORK_BUFFER_SIZE);&lt;br/&gt;
+		this.mockEnv = new MockEnvironmentBuilder()&lt;br/&gt;
+			.setTaskName(HEAD_OPERATOR_NAME)&lt;br/&gt;
+			.setMemorySize(MEMORY_MANAGER_SIZE)&lt;br/&gt;
+			.setInputSplitProvider(this.inputSplitProvider)&lt;br/&gt;
+			.setBufferSize(NETWORK_BUFFER_SIZE)&lt;br/&gt;
+			.setMetricGroup(new TaskMetricGroup(&lt;br/&gt;
+				NoOpMetricRegistry.INSTANCE,&lt;br/&gt;
+				UnregisteredMetricGroups.createUnregisteredTaskManagerJobMetricGroup(),&lt;br/&gt;
+				new JobVertexID(),&lt;br/&gt;
+				new AbstractID(),&lt;br/&gt;
+				&quot;task&quot;,&lt;br/&gt;
+				0,&lt;br/&gt;
+				0))&lt;br/&gt;
+			.build();&lt;br/&gt;
+&lt;br/&gt;
+		final int keyCnt = 100;&lt;br/&gt;
+		final int valCnt = 20;&lt;br/&gt;
+		final int numRecords = keyCnt * valCnt;&lt;br/&gt;
+		addInput(new UniformRecordGenerator(keyCnt, valCnt, false), 0);&lt;br/&gt;
+		addOutput(this.outList);&lt;br/&gt;
+&lt;br/&gt;
+		// the chained operator&lt;br/&gt;
+		addChainedOperator();&lt;br/&gt;
+&lt;br/&gt;
+		// creates the head operator and assembles the chain&lt;br/&gt;
+		registerTask(FlatMapDriver.class, DuplicatingFlatMapFunction.class);&lt;br/&gt;
+		final BatchTask&amp;lt;FlatMapFunction&amp;lt;Record, Record&amp;gt;, Record&amp;gt; testTask = new BatchTask&amp;lt;&amp;gt;(this.mockEnv);&lt;br/&gt;
+&lt;br/&gt;
+		testTask.invoke();&lt;br/&gt;
+&lt;br/&gt;
+		Assert.assertEquals(numRecords * 2 * 2, this.outList.size());&lt;br/&gt;
+&lt;br/&gt;
+		final TaskMetricGroup taskMetricGroup = mockEnv.getMetricGroup();&lt;br/&gt;
+&lt;br/&gt;
+		// verify task-level metrics&lt;br/&gt;
+		&lt;/p&gt;
{
+			final TaskIOMetricGroup ioMetricGroup = taskMetricGroup.getIOMetricGroup();
+			final Counter numRecordsInCounter = ioMetricGroup.getNumRecordsInCounter();
+			final Counter numRecordsOutCounter = ioMetricGroup.getNumRecordsOutCounter();
+
+			Assert.assertEquals(numRecords, numRecordsInCounter.getCount());
+			Assert.assertEquals(numRecords * 2 * 2, numRecordsOutCounter.getCount());
+		}
&lt;p&gt;+&lt;br/&gt;
+		// verify head operator metrics&lt;br/&gt;
+		&lt;/p&gt;
{
+			// this only returns the existing group and doesn&apos;t create a new one
+			final OperatorMetricGroup operatorMetricGroup1 = taskMetricGroup.getOrAddOperator(HEAD_OPERATOR_NAME);
+			final OperatorIOMetricGroup ioMetricGroup = operatorMetricGroup1.getIOMetricGroup();
+			final Counter numRecordsInCounter = ioMetricGroup.getNumRecordsInCounter();
+			final Counter numRecordsOutCounter = ioMetricGroup.getNumRecordsOutCounter();
+
+			Assert.assertEquals(numRecords, numRecordsInCounter.getCount());
+			Assert.assertEquals(numRecords * 2, numRecordsOutCounter.getCount());
+		}
&lt;p&gt;+&lt;br/&gt;
+		// verify chained operator metrics&lt;br/&gt;
+		&lt;/p&gt;
{
+			// this only returns the existing group and doesn&apos;t create a new one
+			final OperatorMetricGroup operatorMetricGroup1 = taskMetricGroup.getOrAddOperator(CHAINED_OPERATOR_NAME);
+			final OperatorIOMetricGroup ioMetricGroup = operatorMetricGroup1.getIOMetricGroup();
+			final Counter numRecordsInCounter = ioMetricGroup.getNumRecordsInCounter();
+			final Counter numRecordsOutCounter = ioMetricGroup.getNumRecordsOutCounter();
+
+			Assert.assertEquals(numRecords * 2, numRecordsInCounter.getCount());
+			Assert.assertEquals(numRecords * 2 * 2, numRecordsOutCounter.getCount());
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
+	private void addChainedOperator() &lt;/p&gt;
{
+		final TaskConfig chainedConfig = new TaskConfig(new Configuration());
+
+		// input
+		chainedConfig.addInputToGroup(0);
+		chainedConfig.setInputSerializer(serFact, 0);
+
+		// output
+		chainedConfig.addOutputShipStrategy(ShipStrategyType.FORWARD);
+		chainedConfig.setOutputSerializer(serFact);
+
+		// driver
+		chainedConfig.setDriverStrategy(DriverStrategy.FLAT_MAP);
+
+		// udf
+		chainedConfig.setStubWrapper(new UserCodeClassWrapper&amp;lt;&amp;gt;(DuplicatingFlatMapFunction.class));
+
+		getTaskConfig().addChainedTask(ChainedFlatMapDriver.class, chainedConfig, CHAINED_OPERATOR_NAME);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Simple &lt;/p&gt;
{@link FlatMapFunction}
&lt;p&gt; that duplicates the input.&lt;br/&gt;
+	 */&lt;br/&gt;
+	public static class DuplicatingFlatMapFunction extends RichFlatMapFunction&amp;lt;Record, Record&amp;gt; {&lt;br/&gt;
+&lt;br/&gt;
+		private static final long serialVersionUID = -1152068682935346164L;&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public void flatMap(final Record value, final Collector&amp;lt;Record&amp;gt; out) throws Exception &lt;/p&gt;
{
+			out.collect(value);
+			out.collect(value);
+		}
&lt;p&gt;+	}&lt;br/&gt;
+}&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java&lt;br/&gt;
index 4bf94e93463..68858bc0cea 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java&lt;br/&gt;
@@ -41,7 +41,6 @@&lt;br/&gt;
 import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
 import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
 import org.apache.flink.runtime.metrics.groups.TaskMetricGroup;&lt;br/&gt;
-import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
 import org.apache.flink.runtime.query.KvStateRegistry;&lt;br/&gt;
 import org.apache.flink.runtime.query.TaskKvStateRegistry;&lt;br/&gt;
 import org.apache.flink.runtime.state.TaskStateManager;&lt;br/&gt;
@@ -108,6 +107,8 @@&lt;/p&gt;

&lt;p&gt; 	private Optional&amp;lt;Throwable&amp;gt; actualExternalFailureCause = Optional.empty();&lt;/p&gt;

&lt;p&gt;+	private final TaskMetricGroup taskMetricGroup;&lt;br/&gt;
+&lt;br/&gt;
 	public static MockEnvironmentBuilder builder() &lt;/p&gt;
{
 		return new MockEnvironmentBuilder();
 	}
&lt;p&gt;@@ -125,7 +126,8 @@ protected MockEnvironment(&lt;br/&gt;
 		int maxParallelism,&lt;br/&gt;
 		int parallelism,&lt;br/&gt;
 		int subtaskIndex,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ClassLoader userCodeClassLoader) {&lt;br/&gt;
+		ClassLoader userCodeClassLoader,&lt;br/&gt;
+		TaskMetricGroup taskMetricGroup) 
{
 
 		this.jobID = jobID;
 		this.jobVertexID = jobVertexID;
@@ -150,6 +152,8 @@ protected MockEnvironment(
 
 		this.userCodeClassLoader = Preconditions.checkNotNull(userCodeClassLoader);
 		this.taskStateManager = Preconditions.checkNotNull(taskStateManager);
+
+		this.taskMetricGroup = taskMetricGroup;
 	}&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;@@ -213,7 +217,7 @@ public TaskManagerRuntimeInfo getTaskManagerInfo() {&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public TaskMetricGroup getMetricGroup() &lt;/p&gt;
{
-		return UnregisteredMetricGroups.createUnregisteredTaskMetricGroup();
+		return taskMetricGroup;
 	}

&lt;p&gt; 	@Override&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java&lt;br/&gt;
index dfb10d4293a..dfcc5f312e0 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java&lt;br/&gt;
@@ -23,6 +23,8 @@&lt;br/&gt;
 import org.apache.flink.configuration.Configuration;&lt;br/&gt;
 import org.apache.flink.runtime.jobgraph.JobVertexID;&lt;br/&gt;
 import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.TaskMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
 import org.apache.flink.runtime.state.TaskStateManager;&lt;br/&gt;
 import org.apache.flink.runtime.state.TestTaskStateManager;&lt;/p&gt;

&lt;p&gt;@@ -40,6 +42,7 @@&lt;br/&gt;
 	private ClassLoader userCodeClassLoader = Thread.currentThread().getContextClassLoader();&lt;br/&gt;
 	private JobID jobID = new JobID();&lt;br/&gt;
 	private JobVertexID jobVertexID = new JobVertexID();&lt;br/&gt;
+	private TaskMetricGroup taskMetricGroup = UnregisteredMetricGroups.createUnregisteredTaskMetricGroup();&lt;/p&gt;

&lt;p&gt; 	public MockEnvironmentBuilder setTaskName(String taskName) {&lt;br/&gt;
 		this.taskName = taskName;&lt;br/&gt;
@@ -106,6 +109,11 @@ public MockEnvironmentBuilder setJobVertexID(JobVertexID jobVertexID) &lt;/p&gt;
{
 		return this;
 	}

&lt;p&gt;+	public MockEnvironmentBuilder setMetricGroup(TaskMetricGroup taskMetricGroup) &lt;/p&gt;
{
+		this.taskMetricGroup = taskMetricGroup;
+		return this;
+	}
&lt;p&gt;+&lt;br/&gt;
 	public MockEnvironment build() {&lt;br/&gt;
 		return new MockEnvironment(&lt;br/&gt;
 			jobID,&lt;br/&gt;
@@ -120,6 +128,7 @@ public MockEnvironment build() &lt;/p&gt;
{
 			maxParallelism,
 			parallelism,
 			subtaskIndex,
-			userCodeClassLoader);
+			userCodeClassLoader,
+			taskMetricGroup);
 	}
&lt;p&gt; }&lt;br/&gt;
diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/AbstractStreamOperator.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/AbstractStreamOperator.java&lt;br/&gt;
index 52ba3e4f1f5..f52168bd9b9 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/AbstractStreamOperator.java&lt;br/&gt;
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/AbstractStreamOperator.java&lt;br/&gt;
@@ -171,7 +171,7 @@ public void setup(StreamTask&amp;lt;?, ?&amp;gt; containingTask, StreamConfig config, Output&amp;lt;S&lt;br/&gt;
 		this.container = containingTask;&lt;br/&gt;
 		this.config = config;&lt;br/&gt;
 		try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;OperatorMetricGroup operatorMetricGroup = environment.getMetricGroup().addOperator(config.getOperatorID(), config.getOperatorName());&lt;br/&gt;
+			OperatorMetricGroup operatorMetricGroup = environment.getMetricGroup().getOrAddOperator(config.getOperatorID(), config.getOperatorName());&lt;br/&gt;
 			this.output = new CountingOutput(output, operatorMetricGroup.getIOMetricGroup().getNumRecordsOutCounter());&lt;br/&gt;
 			if (config.isChainStart()) {&lt;br/&gt;
 				operatorMetricGroup.getIOMetricGroup().reuseInputMetricsForTask();&lt;br/&gt;
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/OneInputStreamTaskTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/OneInputStreamTaskTest.java&lt;br/&gt;
index 96eaa78ed1a..f6d5021b884 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/OneInputStreamTaskTest.java&lt;br/&gt;
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/OneInputStreamTaskTest.java&lt;br/&gt;
@@ -626,7 +626,7 @@ public void testOperatorMetricReuse() throws Exception {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		final TaskMetricGroup taskMetricGroup = new UnregisteredMetricGroups.UnregisteredTaskMetricGroup() {&lt;br/&gt;
 			@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public OperatorMetricGroup addOperator(OperatorID operatorID, String name) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+			public OperatorMetricGroup getOrAddOperator(OperatorID operatorID, String name) {
 				return new OperatorMetricGroup(NoOpMetricRegistry.INSTANCE, this, operatorID, name);
 			}&lt;br/&gt;
 		};&lt;br/&gt;
@@ -682,13 +682,13 @@ public void testWatermarkMetrics() throws Exception {&lt;br/&gt;
 		InterceptingOperatorMetricGroup chainedOperatorMetricGroup = new InterceptingOperatorMetricGroup();&lt;br/&gt;
 		InterceptingTaskMetricGroup taskMetricGroup = new InterceptingTaskMetricGroup() {&lt;br/&gt;
 			@Override&lt;br/&gt;
-			public OperatorMetricGroup addOperator(OperatorID id, String name) {&lt;br/&gt;
+			public OperatorMetricGroup getOrAddOperator(OperatorID id, String name) {&lt;br/&gt;
 				if (id.equals(headOperatorId)) {
 					return headOperatorMetricGroup;
 				} else if (id.equals(chainedOperatorId)) {
 					return chainedOperatorMetricGroup;
 				} else {
-					return super.addOperator(id, name);
+					return super.getOrAddOperator(id, name);
 				}&lt;br/&gt;
 			}&lt;br/&gt;
 		};&lt;br/&gt;
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/TwoInputStreamTaskTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/TwoInputStreamTaskTest.java&lt;br/&gt;
index 5d151573582..c48b6474988 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/TwoInputStreamTaskTest.java&lt;br/&gt;
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/TwoInputStreamTaskTest.java&lt;br/&gt;
@@ -402,7 +402,7 @@ public void testOperatorMetricReuse() throws Exception {&lt;br/&gt;
 &lt;br/&gt;
 		final TaskMetricGroup taskMetricGroup = new UnregisteredMetricGroups.UnregisteredTaskMetricGroup() {&lt;br/&gt;
 			@Override&lt;br/&gt;
-			public OperatorMetricGroup addOperator(OperatorID operatorID, String name) {&lt;br/&gt;
+			public OperatorMetricGroup getOrAddOperator(OperatorID operatorID, String name) { 				return new OperatorMetricGroup(NoOpMetricRegistry.INSTANCE, this, operatorID, name); 			} 		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;;&lt;br/&gt;
@@ -470,13 +470,13 @@ public void testWatermarkMetrics() throws Exception {&lt;br/&gt;
 		InterceptingOperatorMetricGroup chainedOperatorMetricGroup = new InterceptingOperatorMetricGroup();&lt;br/&gt;
 		InterceptingTaskMetricGroup taskMetricGroup = new InterceptingTaskMetricGroup() {&lt;br/&gt;
 			@Override&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;public OperatorMetricGroup addOperator(OperatorID id, String name) {&lt;br/&gt;
+			public OperatorMetricGroup getOrAddOperator(OperatorID id, String name) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: { 				if (id.equals(headOperatorId)) {
 					return headOperatorMetricGroup;
 				} else if (id.equals(chainedOperatorId)) {
 					return chainedOperatorMetricGroup;
 				} else {
-					return super.addOperator(id, name);
+					return super.getOrAddOperator(id, name);
 				} 			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; 		};&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16602146" author="githubbot" created="Mon, 3 Sep 2018 13:05:06 +0000"  >&lt;p&gt;zentol opened a new pull request #6654: &lt;span class=&quot;error&quot;&gt;&amp;#91;1.5&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10150&quot; title=&quot;Chained batch operators interfere with each other other&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10150&quot;&gt;&lt;del&gt;FLINK-10150&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Fix OperatorMetricGroup creation for Batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6654&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6654&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Back-port of #6599 for 1.5.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16602147" author="githubbot" created="Mon, 3 Sep 2018 13:05:52 +0000"  >&lt;p&gt;zentol opened a new pull request #6655: &lt;span class=&quot;error&quot;&gt;&amp;#91;1.6&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10150&quot; title=&quot;Chained batch operators interfere with each other other&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10150&quot;&gt;&lt;del&gt;FLINK-10150&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Fix OperatorMetricGroup creation for Batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6655&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6655&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Back-port of #6599 for 1.6.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16602676" author="githubbot" created="Tue, 4 Sep 2018 07:13:01 +0000"  >&lt;p&gt;zentol closed pull request #6654: &lt;span class=&quot;error&quot;&gt;&amp;#91;1.5&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10150&quot; title=&quot;Chained batch operators interfere with each other other&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10150&quot;&gt;&lt;del&gt;FLINK-10150&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Fix OperatorMetricGroup creation for Batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6654&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6654&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java b/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
index 441dbf8ea58..124fbf22872 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
@@ -42,7 +42,7 @@&lt;br/&gt;
 @Internal&lt;br/&gt;
 public class TaskMetricGroup extends ComponentMetricGroup&amp;lt;TaskManagerJobMetricGroup&amp;gt; {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final Map&amp;lt;OperatorID, OperatorMetricGroup&amp;gt; operators = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+	private final Map&amp;lt;String, OperatorMetricGroup&amp;gt; operators = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	static final int METRICS_OPERATOR_NAME_MAX_LENGTH = 80;&lt;/p&gt;

&lt;p&gt;@@ -144,15 +144,17 @@ public OperatorMetricGroup addOperator(OperatorID operatorID, String name) &lt;/p&gt;
{
 			name = name.substring(0, METRICS_OPERATOR_NAME_MAX_LENGTH);
 		}
&lt;p&gt; 		OperatorMetricGroup operator = new OperatorMetricGroup(this.registry, this, operatorID, name);&lt;br/&gt;
+		// unique OperatorIDs only exist in streaming, so we have to rely on the name for batch operators&lt;br/&gt;
+		final String key = operatorID + name;&lt;/p&gt;

&lt;p&gt; 		synchronized (this) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;OperatorMetricGroup previous = operators.put(operatorID, operator);&lt;br/&gt;
+			OperatorMetricGroup previous = operators.put(key, operator);&lt;br/&gt;
 			if (previous == null) 
{
 				// no operator group so far
 				return operator;
 			}
&lt;p&gt; else &lt;/p&gt;
{
 				// already had an operator group. restore that one.
-				operators.put(operatorID, previous);
+				operators.put(key, previous);
 				return previous;
 			}
&lt;p&gt; 		}&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/chaining/ChainedOperatorsMetricTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/chaining/ChainedOperatorsMetricTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..29ff6e86671&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;/dev/null&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/chaining/ChainedOperatorsMetricTest.java&lt;br/&gt;
@@ -0,0 +1,175 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.runtime.operators.chaining;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.flink.api.common.functions.FlatMapFunction;&lt;br/&gt;
+import org.apache.flink.api.common.functions.RichFlatMapFunction;&lt;br/&gt;
+import org.apache.flink.api.common.operators.util.UserCodeClassWrapper;&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeSerializerFactory;&lt;br/&gt;
+import org.apache.flink.configuration.Configuration;&lt;br/&gt;
+import org.apache.flink.metrics.Counter;&lt;br/&gt;
+import org.apache.flink.runtime.jobgraph.JobVertexID;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.NoOpMetricRegistry;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.OperatorIOMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.OperatorMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.TaskIOMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.TaskMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
+import org.apache.flink.runtime.operators.BatchTask;&lt;br/&gt;
+import org.apache.flink.runtime.operators.DriverStrategy;&lt;br/&gt;
+import org.apache.flink.runtime.operators.FlatMapDriver;&lt;br/&gt;
+import org.apache.flink.runtime.operators.shipping.ShipStrategyType;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.MockEnvironmentBuilder;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.TaskTestBase;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.UniformRecordGenerator;&lt;br/&gt;
+import org.apache.flink.runtime.operators.util.TaskConfig;&lt;br/&gt;
+import org.apache.flink.runtime.testutils.recordutils.RecordSerializerFactory;&lt;br/&gt;
+import org.apache.flink.types.Record;&lt;br/&gt;
+import org.apache.flink.util.AbstractID;&lt;br/&gt;
+import org.apache.flink.util.Collector;&lt;br/&gt;
+&lt;br/&gt;
+import org.junit.Assert;&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.ArrayList;&lt;br/&gt;
+import java.util.List;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Metrics related tests for batch task chains.&lt;br/&gt;
+ */&lt;br/&gt;
+public class ChainedOperatorsMetricTest extends TaskTestBase {&lt;br/&gt;
+&lt;br/&gt;
+	private static final int MEMORY_MANAGER_SIZE = 1024 * 1024 * 3;&lt;br/&gt;
+&lt;br/&gt;
+	private static final int NETWORK_BUFFER_SIZE = 1024;&lt;br/&gt;
+&lt;br/&gt;
+	private static final TypeSerializerFactory&amp;lt;Record&amp;gt; serFact = RecordSerializerFactory.get();&lt;br/&gt;
+&lt;br/&gt;
+	private final List&amp;lt;Record&amp;gt; outList = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+	private static final String HEAD_OPERATOR_NAME = &quot;headoperator&quot;;&lt;br/&gt;
+	private static final String CHAINED_OPERATOR_NAME = &quot;chainedoperator&quot;;&lt;br/&gt;
+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testOperatorIOMetricReuse() throws Exception 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+		// environment+		initEnvironment(MEMORY_MANAGER_SIZE, NETWORK_BUFFER_SIZE);+		this.mockEnv = new MockEnvironmentBuilder()+			.setTaskName(HEAD_OPERATOR_NAME)+			.setMemorySize(MEMORY_MANAGER_SIZE)+			.setInputSplitProvider(this.inputSplitProvider)+			.setBufferSize(NETWORK_BUFFER_SIZE)+			.setMetricGroup(new TaskMetricGroup(+				NoOpMetricRegistry.INSTANCE,+				UnregisteredMetricGroups.createUnregisteredTaskManagerJobMetricGroup(),+				new JobVertexID(),+				new AbstractID(),+				&amp;quot;task&amp;quot;,+				0,+				0))+			.build();++		final int keyCnt = 100;+		final int valCnt = 20;+		final int numRecords = keyCnt * valCnt;+		addInput(new UniformRecordGenerator(keyCnt, valCnt, false), 0);+		addOutput(this.outList);++		// the chained operator+		addChainedOperator();++		// creates the head operator and assembles the chain+		registerTask(FlatMapDriver.class, DuplicatingFlatMapFunction.class);+		final BatchTask&amp;lt;FlatMapFunction&amp;lt;Record, Record&amp;gt;, Record&amp;gt; testTask = new BatchTask&amp;lt;&amp;gt;(this.mockEnv);++		testTask.invoke();++		Assert.assertEquals(numRecords * 2 * 2, this.outList.size());++		final TaskMetricGroup taskMetricGroup = mockEnv.getMetricGroup();++		// verify task-level metrics+		{
+			final TaskIOMetricGroup ioMetricGroup = taskMetricGroup.getIOMetricGroup();
+			final Counter numRecordsInCounter = ioMetricGroup.getNumRecordsInCounter();
+			final Counter numRecordsOutCounter = ioMetricGroup.getNumRecordsOutCounter();
+
+			Assert.assertEquals(numRecords, numRecordsInCounter.getCount());
+			Assert.assertEquals(numRecords * 2 * 2, numRecordsOutCounter.getCount());
+		}++		// verify head operator metrics+		{
+			// this only returns the existing group and doesn&apos;t create a new one
+			final OperatorMetricGroup operatorMetricGroup1 = taskMetricGroup.addOperator(HEAD_OPERATOR_NAME);
+			final OperatorIOMetricGroup ioMetricGroup = operatorMetricGroup1.getIOMetricGroup();
+			final Counter numRecordsInCounter = ioMetricGroup.getNumRecordsInCounter();
+			final Counter numRecordsOutCounter = ioMetricGroup.getNumRecordsOutCounter();
+
+			Assert.assertEquals(numRecords, numRecordsInCounter.getCount());
+			Assert.assertEquals(numRecords * 2, numRecordsOutCounter.getCount());
+		}++		// verify chained operator metrics+		{
+			// this only returns the existing group and doesn&apos;t create a new one
+			final OperatorMetricGroup operatorMetricGroup1 = taskMetricGroup.addOperator(CHAINED_OPERATOR_NAME);
+			final OperatorIOMetricGroup ioMetricGroup = operatorMetricGroup1.getIOMetricGroup();
+			final Counter numRecordsInCounter = ioMetricGroup.getNumRecordsInCounter();
+			final Counter numRecordsOutCounter = ioMetricGroup.getNumRecordsOutCounter();
+
+			Assert.assertEquals(numRecords * 2, numRecordsInCounter.getCount());
+			Assert.assertEquals(numRecords * 2 * 2, numRecordsOutCounter.getCount());
+		}+	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+	private void addChainedOperator() &lt;/p&gt;
{
+		final TaskConfig chainedConfig = new TaskConfig(new Configuration());
+
+		// input
+		chainedConfig.addInputToGroup(0);
+		chainedConfig.setInputSerializer(serFact, 0);
+
+		// output
+		chainedConfig.addOutputShipStrategy(ShipStrategyType.FORWARD);
+		chainedConfig.setOutputSerializer(serFact);
+
+		// driver
+		chainedConfig.setDriverStrategy(DriverStrategy.FLAT_MAP);
+
+		// udf
+		chainedConfig.setStubWrapper(new UserCodeClassWrapper&amp;lt;&amp;gt;(DuplicatingFlatMapFunction.class));
+
+		getTaskConfig().addChainedTask(ChainedFlatMapDriver.class, chainedConfig, CHAINED_OPERATOR_NAME);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Simple &lt;/p&gt;
{@link FlatMapFunction}
&lt;p&gt; that duplicates the input.&lt;br/&gt;
+	 */&lt;br/&gt;
+	public static class DuplicatingFlatMapFunction extends RichFlatMapFunction&amp;lt;Record, Record&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {++		private static final long serialVersionUID = -1152068682935346164L;++		@Override+		public void flatMap(final Record value, final Collector&amp;lt;Record&amp;gt; out) throws Exception {
+			out.collect(value);
+			out.collect(value);
+		}+	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+}&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java&lt;br/&gt;
index 4bf94e93463..68858bc0cea 100644&lt;/p&gt;&lt;/li&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java&lt;br/&gt;
@@ -41,7 +41,6 @@&lt;br/&gt;
 import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
 import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
 import org.apache.flink.runtime.metrics.groups.TaskMetricGroup;&lt;br/&gt;
-import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
 import org.apache.flink.runtime.query.KvStateRegistry;&lt;br/&gt;
 import org.apache.flink.runtime.query.TaskKvStateRegistry;&lt;br/&gt;
 import org.apache.flink.runtime.state.TaskStateManager;&lt;br/&gt;
@@ -108,6 +107,8 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	private Optional&amp;lt;Throwable&amp;gt; actualExternalFailureCause = Optional.empty();&lt;/p&gt;

&lt;p&gt;+	private final TaskMetricGroup taskMetricGroup;&lt;br/&gt;
+&lt;br/&gt;
 	public static MockEnvironmentBuilder builder() &lt;/p&gt;
{
 		return new MockEnvironmentBuilder();
 	}
&lt;p&gt;@@ -125,7 +126,8 @@ protected MockEnvironment(&lt;br/&gt;
 		int maxParallelism,&lt;br/&gt;
 		int parallelism,&lt;br/&gt;
 		int subtaskIndex,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ClassLoader userCodeClassLoader) {&lt;br/&gt;
+		ClassLoader userCodeClassLoader,&lt;br/&gt;
+		TaskMetricGroup taskMetricGroup) 
{
 
 		this.jobID = jobID;
 		this.jobVertexID = jobVertexID;
@@ -150,6 +152,8 @@ protected MockEnvironment(
 
 		this.userCodeClassLoader = Preconditions.checkNotNull(userCodeClassLoader);
 		this.taskStateManager = Preconditions.checkNotNull(taskStateManager);
+
+		this.taskMetricGroup = taskMetricGroup;
 	}&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;@@ -213,7 +217,7 @@ public TaskManagerRuntimeInfo getTaskManagerInfo() {&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public TaskMetricGroup getMetricGroup() &lt;/p&gt;
{
-		return UnregisteredMetricGroups.createUnregisteredTaskMetricGroup();
+		return taskMetricGroup;
 	}

&lt;p&gt; 	@Override&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java&lt;br/&gt;
index dfb10d4293a..dfcc5f312e0 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java&lt;br/&gt;
@@ -23,6 +23,8 @@&lt;br/&gt;
 import org.apache.flink.configuration.Configuration;&lt;br/&gt;
 import org.apache.flink.runtime.jobgraph.JobVertexID;&lt;br/&gt;
 import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.TaskMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
 import org.apache.flink.runtime.state.TaskStateManager;&lt;br/&gt;
 import org.apache.flink.runtime.state.TestTaskStateManager;&lt;/p&gt;

&lt;p&gt;@@ -40,6 +42,7 @@&lt;br/&gt;
 	private ClassLoader userCodeClassLoader = Thread.currentThread().getContextClassLoader();&lt;br/&gt;
 	private JobID jobID = new JobID();&lt;br/&gt;
 	private JobVertexID jobVertexID = new JobVertexID();&lt;br/&gt;
+	private TaskMetricGroup taskMetricGroup = UnregisteredMetricGroups.createUnregisteredTaskMetricGroup();&lt;/p&gt;

&lt;p&gt; 	public MockEnvironmentBuilder setTaskName(String taskName) {&lt;br/&gt;
 		this.taskName = taskName;&lt;br/&gt;
@@ -106,6 +109,11 @@ public MockEnvironmentBuilder setJobVertexID(JobVertexID jobVertexID) &lt;/p&gt;
{
 		return this;
 	}

&lt;p&gt;+	public MockEnvironmentBuilder setMetricGroup(TaskMetricGroup taskMetricGroup) &lt;/p&gt;
{
+		this.taskMetricGroup = taskMetricGroup;
+		return this;
+	}
&lt;p&gt;+&lt;br/&gt;
 	public MockEnvironment build() {&lt;br/&gt;
 		return new MockEnvironment(&lt;br/&gt;
 			jobID,&lt;br/&gt;
@@ -120,6 +128,7 @@ public MockEnvironment build() &lt;/p&gt;
{
 			maxParallelism,
 			parallelism,
 			subtaskIndex,
-			userCodeClassLoader);
+			userCodeClassLoader,
+			taskMetricGroup);
 	}
&lt;p&gt; }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16602677" author="githubbot" created="Tue, 4 Sep 2018 07:13:03 +0000"  >&lt;p&gt;zentol closed pull request #6655: &lt;span class=&quot;error&quot;&gt;&amp;#91;1.6&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10150&quot; title=&quot;Chained batch operators interfere with each other other&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10150&quot;&gt;&lt;del&gt;FLINK-10150&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Fix OperatorMetricGroup creation for Batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6655&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6655&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java b/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
index 441dbf8ea58..124fbf22872 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskMetricGroup.java&lt;br/&gt;
@@ -42,7 +42,7 @@&lt;br/&gt;
 @Internal&lt;br/&gt;
 public class TaskMetricGroup extends ComponentMetricGroup&amp;lt;TaskManagerJobMetricGroup&amp;gt; {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final Map&amp;lt;OperatorID, OperatorMetricGroup&amp;gt; operators = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+	private final Map&amp;lt;String, OperatorMetricGroup&amp;gt; operators = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	static final int METRICS_OPERATOR_NAME_MAX_LENGTH = 80;&lt;/p&gt;

&lt;p&gt;@@ -144,15 +144,17 @@ public OperatorMetricGroup addOperator(OperatorID operatorID, String name) &lt;/p&gt;
{
 			name = name.substring(0, METRICS_OPERATOR_NAME_MAX_LENGTH);
 		}
&lt;p&gt; 		OperatorMetricGroup operator = new OperatorMetricGroup(this.registry, this, operatorID, name);&lt;br/&gt;
+		// unique OperatorIDs only exist in streaming, so we have to rely on the name for batch operators&lt;br/&gt;
+		final String key = operatorID + name;&lt;/p&gt;

&lt;p&gt; 		synchronized (this) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;OperatorMetricGroup previous = operators.put(operatorID, operator);&lt;br/&gt;
+			OperatorMetricGroup previous = operators.put(key, operator);&lt;br/&gt;
 			if (previous == null) 
{
 				// no operator group so far
 				return operator;
 			}
&lt;p&gt; else &lt;/p&gt;
{
 				// already had an operator group. restore that one.
-				operators.put(operatorID, previous);
+				operators.put(key, previous);
 				return previous;
 			}
&lt;p&gt; 		}&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/chaining/ChainedOperatorsMetricTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/chaining/ChainedOperatorsMetricTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..29ff6e86671&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;/dev/null&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/chaining/ChainedOperatorsMetricTest.java&lt;br/&gt;
@@ -0,0 +1,175 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.runtime.operators.chaining;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.flink.api.common.functions.FlatMapFunction;&lt;br/&gt;
+import org.apache.flink.api.common.functions.RichFlatMapFunction;&lt;br/&gt;
+import org.apache.flink.api.common.operators.util.UserCodeClassWrapper;&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeSerializerFactory;&lt;br/&gt;
+import org.apache.flink.configuration.Configuration;&lt;br/&gt;
+import org.apache.flink.metrics.Counter;&lt;br/&gt;
+import org.apache.flink.runtime.jobgraph.JobVertexID;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.NoOpMetricRegistry;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.OperatorIOMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.OperatorMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.TaskIOMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.TaskMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
+import org.apache.flink.runtime.operators.BatchTask;&lt;br/&gt;
+import org.apache.flink.runtime.operators.DriverStrategy;&lt;br/&gt;
+import org.apache.flink.runtime.operators.FlatMapDriver;&lt;br/&gt;
+import org.apache.flink.runtime.operators.shipping.ShipStrategyType;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.MockEnvironmentBuilder;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.TaskTestBase;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.UniformRecordGenerator;&lt;br/&gt;
+import org.apache.flink.runtime.operators.util.TaskConfig;&lt;br/&gt;
+import org.apache.flink.runtime.testutils.recordutils.RecordSerializerFactory;&lt;br/&gt;
+import org.apache.flink.types.Record;&lt;br/&gt;
+import org.apache.flink.util.AbstractID;&lt;br/&gt;
+import org.apache.flink.util.Collector;&lt;br/&gt;
+&lt;br/&gt;
+import org.junit.Assert;&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.ArrayList;&lt;br/&gt;
+import java.util.List;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Metrics related tests for batch task chains.&lt;br/&gt;
+ */&lt;br/&gt;
+public class ChainedOperatorsMetricTest extends TaskTestBase {&lt;br/&gt;
+&lt;br/&gt;
+	private static final int MEMORY_MANAGER_SIZE = 1024 * 1024 * 3;&lt;br/&gt;
+&lt;br/&gt;
+	private static final int NETWORK_BUFFER_SIZE = 1024;&lt;br/&gt;
+&lt;br/&gt;
+	private static final TypeSerializerFactory&amp;lt;Record&amp;gt; serFact = RecordSerializerFactory.get();&lt;br/&gt;
+&lt;br/&gt;
+	private final List&amp;lt;Record&amp;gt; outList = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+	private static final String HEAD_OPERATOR_NAME = &quot;headoperator&quot;;&lt;br/&gt;
+	private static final String CHAINED_OPERATOR_NAME = &quot;chainedoperator&quot;;&lt;br/&gt;
+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testOperatorIOMetricReuse() throws Exception 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+		// environment+		initEnvironment(MEMORY_MANAGER_SIZE, NETWORK_BUFFER_SIZE);+		this.mockEnv = new MockEnvironmentBuilder()+			.setTaskName(HEAD_OPERATOR_NAME)+			.setMemorySize(MEMORY_MANAGER_SIZE)+			.setInputSplitProvider(this.inputSplitProvider)+			.setBufferSize(NETWORK_BUFFER_SIZE)+			.setMetricGroup(new TaskMetricGroup(+				NoOpMetricRegistry.INSTANCE,+				UnregisteredMetricGroups.createUnregisteredTaskManagerJobMetricGroup(),+				new JobVertexID(),+				new AbstractID(),+				&amp;quot;task&amp;quot;,+				0,+				0))+			.build();++		final int keyCnt = 100;+		final int valCnt = 20;+		final int numRecords = keyCnt * valCnt;+		addInput(new UniformRecordGenerator(keyCnt, valCnt, false), 0);+		addOutput(this.outList);++		// the chained operator+		addChainedOperator();++		// creates the head operator and assembles the chain+		registerTask(FlatMapDriver.class, DuplicatingFlatMapFunction.class);+		final BatchTask&amp;lt;FlatMapFunction&amp;lt;Record, Record&amp;gt;, Record&amp;gt; testTask = new BatchTask&amp;lt;&amp;gt;(this.mockEnv);++		testTask.invoke();++		Assert.assertEquals(numRecords * 2 * 2, this.outList.size());++		final TaskMetricGroup taskMetricGroup = mockEnv.getMetricGroup();++		// verify task-level metrics+		{
+			final TaskIOMetricGroup ioMetricGroup = taskMetricGroup.getIOMetricGroup();
+			final Counter numRecordsInCounter = ioMetricGroup.getNumRecordsInCounter();
+			final Counter numRecordsOutCounter = ioMetricGroup.getNumRecordsOutCounter();
+
+			Assert.assertEquals(numRecords, numRecordsInCounter.getCount());
+			Assert.assertEquals(numRecords * 2 * 2, numRecordsOutCounter.getCount());
+		}++		// verify head operator metrics+		{
+			// this only returns the existing group and doesn&apos;t create a new one
+			final OperatorMetricGroup operatorMetricGroup1 = taskMetricGroup.addOperator(HEAD_OPERATOR_NAME);
+			final OperatorIOMetricGroup ioMetricGroup = operatorMetricGroup1.getIOMetricGroup();
+			final Counter numRecordsInCounter = ioMetricGroup.getNumRecordsInCounter();
+			final Counter numRecordsOutCounter = ioMetricGroup.getNumRecordsOutCounter();
+
+			Assert.assertEquals(numRecords, numRecordsInCounter.getCount());
+			Assert.assertEquals(numRecords * 2, numRecordsOutCounter.getCount());
+		}++		// verify chained operator metrics+		{
+			// this only returns the existing group and doesn&apos;t create a new one
+			final OperatorMetricGroup operatorMetricGroup1 = taskMetricGroup.addOperator(CHAINED_OPERATOR_NAME);
+			final OperatorIOMetricGroup ioMetricGroup = operatorMetricGroup1.getIOMetricGroup();
+			final Counter numRecordsInCounter = ioMetricGroup.getNumRecordsInCounter();
+			final Counter numRecordsOutCounter = ioMetricGroup.getNumRecordsOutCounter();
+
+			Assert.assertEquals(numRecords * 2, numRecordsInCounter.getCount());
+			Assert.assertEquals(numRecords * 2 * 2, numRecordsOutCounter.getCount());
+		}+	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+	private void addChainedOperator() &lt;/p&gt;
{
+		final TaskConfig chainedConfig = new TaskConfig(new Configuration());
+
+		// input
+		chainedConfig.addInputToGroup(0);
+		chainedConfig.setInputSerializer(serFact, 0);
+
+		// output
+		chainedConfig.addOutputShipStrategy(ShipStrategyType.FORWARD);
+		chainedConfig.setOutputSerializer(serFact);
+
+		// driver
+		chainedConfig.setDriverStrategy(DriverStrategy.FLAT_MAP);
+
+		// udf
+		chainedConfig.setStubWrapper(new UserCodeClassWrapper&amp;lt;&amp;gt;(DuplicatingFlatMapFunction.class));
+
+		getTaskConfig().addChainedTask(ChainedFlatMapDriver.class, chainedConfig, CHAINED_OPERATOR_NAME);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Simple &lt;/p&gt;
{@link FlatMapFunction}
&lt;p&gt; that duplicates the input.&lt;br/&gt;
+	 */&lt;br/&gt;
+	public static class DuplicatingFlatMapFunction extends RichFlatMapFunction&amp;lt;Record, Record&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {++		private static final long serialVersionUID = -1152068682935346164L;++		@Override+		public void flatMap(final Record value, final Collector&amp;lt;Record&amp;gt; out) throws Exception {
+			out.collect(value);
+			out.collect(value);
+		}+	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+}&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java&lt;br/&gt;
index 4bf94e93463..68858bc0cea 100644&lt;/p&gt;&lt;/li&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java&lt;br/&gt;
@@ -41,7 +41,6 @@&lt;br/&gt;
 import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
 import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
 import org.apache.flink.runtime.metrics.groups.TaskMetricGroup;&lt;br/&gt;
-import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
 import org.apache.flink.runtime.query.KvStateRegistry;&lt;br/&gt;
 import org.apache.flink.runtime.query.TaskKvStateRegistry;&lt;br/&gt;
 import org.apache.flink.runtime.state.TaskStateManager;&lt;br/&gt;
@@ -108,6 +107,8 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	private Optional&amp;lt;Throwable&amp;gt; actualExternalFailureCause = Optional.empty();&lt;/p&gt;

&lt;p&gt;+	private final TaskMetricGroup taskMetricGroup;&lt;br/&gt;
+&lt;br/&gt;
 	public static MockEnvironmentBuilder builder() &lt;/p&gt;
{
 		return new MockEnvironmentBuilder();
 	}
&lt;p&gt;@@ -125,7 +126,8 @@ protected MockEnvironment(&lt;br/&gt;
 		int maxParallelism,&lt;br/&gt;
 		int parallelism,&lt;br/&gt;
 		int subtaskIndex,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ClassLoader userCodeClassLoader) {&lt;br/&gt;
+		ClassLoader userCodeClassLoader,&lt;br/&gt;
+		TaskMetricGroup taskMetricGroup) 
{
 
 		this.jobID = jobID;
 		this.jobVertexID = jobVertexID;
@@ -150,6 +152,8 @@ protected MockEnvironment(
 
 		this.userCodeClassLoader = Preconditions.checkNotNull(userCodeClassLoader);
 		this.taskStateManager = Preconditions.checkNotNull(taskStateManager);
+
+		this.taskMetricGroup = taskMetricGroup;
 	}&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;@@ -213,7 +217,7 @@ public TaskManagerRuntimeInfo getTaskManagerInfo() {&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public TaskMetricGroup getMetricGroup() &lt;/p&gt;
{
-		return UnregisteredMetricGroups.createUnregisteredTaskMetricGroup();
+		return taskMetricGroup;
 	}

&lt;p&gt; 	@Override&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java&lt;br/&gt;
index dfb10d4293a..dfcc5f312e0 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironmentBuilder.java&lt;br/&gt;
@@ -23,6 +23,8 @@&lt;br/&gt;
 import org.apache.flink.configuration.Configuration;&lt;br/&gt;
 import org.apache.flink.runtime.jobgraph.JobVertexID;&lt;br/&gt;
 import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.TaskMetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
 import org.apache.flink.runtime.state.TaskStateManager;&lt;br/&gt;
 import org.apache.flink.runtime.state.TestTaskStateManager;&lt;/p&gt;

&lt;p&gt;@@ -40,6 +42,7 @@&lt;br/&gt;
 	private ClassLoader userCodeClassLoader = Thread.currentThread().getContextClassLoader();&lt;br/&gt;
 	private JobID jobID = new JobID();&lt;br/&gt;
 	private JobVertexID jobVertexID = new JobVertexID();&lt;br/&gt;
+	private TaskMetricGroup taskMetricGroup = UnregisteredMetricGroups.createUnregisteredTaskMetricGroup();&lt;/p&gt;

&lt;p&gt; 	public MockEnvironmentBuilder setTaskName(String taskName) {&lt;br/&gt;
 		this.taskName = taskName;&lt;br/&gt;
@@ -106,6 +109,11 @@ public MockEnvironmentBuilder setJobVertexID(JobVertexID jobVertexID) &lt;/p&gt;
{
 		return this;
 	}

&lt;p&gt;+	public MockEnvironmentBuilder setMetricGroup(TaskMetricGroup taskMetricGroup) &lt;/p&gt;
{
+		this.taskMetricGroup = taskMetricGroup;
+		return this;
+	}
&lt;p&gt;+&lt;br/&gt;
 	public MockEnvironment build() {&lt;br/&gt;
 		return new MockEnvironment(&lt;br/&gt;
 			jobID,&lt;br/&gt;
@@ -120,6 +128,7 @@ public MockEnvironment build() &lt;/p&gt;
{
 			maxParallelism,
 			parallelism,
 			subtaskIndex,
-			userCodeClassLoader);
+			userCodeClassLoader,
+			taskMetricGroup);
 	}
&lt;p&gt; }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16604087" author="zentol" created="Wed, 5 Sep 2018 08:04:59 +0000"  >&lt;p&gt;master: 93ac95866e4473982a89e563d58ef0e374b3c0ba&lt;br/&gt;
1.6: 38f75527335a711ee0374a0fd3d28087d8568fb9&lt;br/&gt;
1.5: 37b93a38c722648e26e655e8513ed0d6d76dc7e0&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13183609">FLINK-10300</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12935690" name="record_counts_flink_1_3.png" size="51770" author="lethum" created="Wed, 15 Aug 2018 13:03:48 +0000"/>
                            <attachment id="12935689" name="record_counts_flink_1_4.png" size="48956" author="lethum" created="Wed, 15 Aug 2018 13:03:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3x2g7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>