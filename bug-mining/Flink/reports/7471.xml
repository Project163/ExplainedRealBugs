<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:20:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-34954] Kryo input implementation NoFetchingInput fails to handle zero length bytes</title>
                <link>https://issues.apache.org/jira/browse/FLINK-34954</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;If the serailized bytes are empty, `NoFetchingInput` will run into error when Kryo tries to deserialize it.&lt;/p&gt;

&lt;p&gt;Example: a protobuf 3 object that contains only default values will be serialized as 0 length byte array, and the deserialization later will fail. Illustration:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import com.esotericsoftware.kryo.Kryo
import com.esotericsoftware.kryo.io.{ByteBufferInput, ByteBufferOutput, Input, Output}
import com.google.protobuf.{DescriptorProtos, Message}import com.twitter.chill.protobuf.ProtobufSerializer
import org.apache.flink.api.java.typeutils.runtime.NoFetchingInput
import java.io.ByteArrayInputStream
&#160;
object ProtoSerializationTest {
&#160; def main(args: Array[String]) = { &#160; &#160; 
    val chillProtoSerializer = new ProtobufSerializer
  &#160; val protomessage = DescriptorProtos.DescriptorProto.getDefaultInstance
&#160; &#160; val output: Output = new ByteBufferOutput(1000)
  &#160; chillProtoSerializer.write(null, output, protomessage)
  &#160; val serialized: Array[Byte] = output.toBytes
  &#160; println(s&quot;Serialized : $serialized&quot;)
  &#160; val input: Input = new NoFetchingInput(new ByteArrayInputStream(serialized))
  &#160; val deserialized = chillProtoSerializer.read(null, input, classOf[BillableClick].asInstanceOf[Class[Message]])
  &#160; println(deserialized)
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Error&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;main&quot; java.lang.RuntimeException: Could not create class com.criteo.glup.BillableClickProto$BillableClick
&#160; &#160; at com.twitter.chill.protobuf.ProtobufSerializer.read(ProtobufSerializer.java:76)
&#160; &#160; at com.criteo.streaming.common.bootstrap.ProtoSerialization$.main(ProtoSerialization.scala:22)
&#160; &#160; at ProtoSerialization.main(ProtoSerialization.scala)
Caused by: com.esotericsoftware.kryo.KryoException: java.io.EOFException: No more bytes left.
&#160; &#160; at org.apache.flink.api.java.typeutils.runtime.NoFetchingInput.readBytes(NoFetchingInput.java:128)
&#160; &#160; at com.esotericsoftware.kryo.io.Input.readBytes(Input.java:332)
&#160; &#160; at com.twitter.chill.protobuf.ProtobufSerializer.read(ProtobufSerializer.java:73)
&#160; &#160; ... 2 more
Caused by: java.io.EOFException: No more bytes left.
  &#160; ... 5 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13573579">FLINK-34954</key>
            <summary>Kryo input implementation NoFetchingInput fails to handle zero length bytes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="q.xu">Qinghui Xu</assignee>
                                    <reporter username="q.xu">Qinghui Xu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 27 Mar 2024 19:17:28 +0000</created>
                <updated>Tue, 21 May 2024 08:42:52 +0000</updated>
                            <resolved>Fri, 19 Apr 2024 09:56:42 +0000</resolved>
                                    <version>1.19.0</version>
                                    <fixVersion>1.20.0</fixVersion>
                                    <component>API / Type Serialization System</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17838937" author="dannycranmer" created="Fri, 19 Apr 2024 09:56:30 +0000"  >&lt;p&gt;Thanks for the bug report and fix, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=q.xu&quot; class=&quot;user-hover&quot; rel=&quot;q.xu&quot;&gt;q.xu&lt;/a&gt; .&lt;/p&gt;</comment>
                            <comment id="17838938" author="dannycranmer" created="Fri, 19 Apr 2024 09:56:37 +0000"  >&lt;p&gt;Merged commit &lt;a href=&quot;https://github.com/apache/flink/commit/39779829b8853c61c9da9eaf193f0fedf5857f7b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;3977982&lt;/tt&gt;&lt;/a&gt;&#160;into&#160;apache:master&lt;/p&gt;</comment>
                            <comment id="17844507" author="fanrui" created="Wed, 8 May 2024 03:30:48 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=q.xu&quot; class=&quot;user-hover&quot; rel=&quot;q.xu&quot;&gt;q.xu&lt;/a&gt; , I wanna check with you did you meet this issue in your production job? or it only happens for your test code.&lt;/p&gt;

&lt;p&gt;After I read the flink related code in detail, I guess this issue never happen for flink job.&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;Reason%3A&quot;&gt;&lt;/a&gt;Reason:&lt;/h1&gt;

&lt;p&gt;This exception happens inside of NoFetchingInput.readBytes, and when inputStream.read return -1.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Whydoesn%27tflinkjobthrowexception%3F&quot;&gt;&lt;/a&gt;Why doesn&apos;t flink job throw exception?&lt;/h2&gt;

&lt;p&gt;In flink code, the inputStream is DataInputViewStream, check KryoSerializer#deserialize method.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160; DataInputViewStream inputStream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataInputViewStream(source);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; input = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoFetchingInput(inputStream);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;DataInputViewStream#read calls org.apache.flink.core.memory.DataInputView#read(byte[], int, int). From its comment, we can see : &amp;lt;p&amp;gt;If &amp;lt;code&amp;gt;len&amp;lt;/code&amp;gt; is zero, then no bytes are read and &amp;lt;code&amp;gt;0&amp;lt;/code&amp;gt; is returned;&lt;/p&gt;

&lt;p&gt;So when length is 0, inputStream.read will return 0. And NoFetchingInput.readBytes won&apos;t throw exception.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Whydoesyourtestdemothrowexception%3F&quot;&gt;&lt;/a&gt;Why does your test demo throw exception?&lt;/h2&gt;

&lt;p&gt;Your demo is using java.io.ByteArrayInputStream as the inputStream. From its comment, we can see&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
* @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;  the total number of bytes read into the buffer, or
*          &amp;lt;code&amp;gt;-1&amp;lt;/code&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there is no more data because the end of
*          the stream has been reached. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It returns -1 even if length is 0.&lt;/p&gt;

&lt;p&gt;When return value is -1, &#160;NoFetchingInput.readBytes will throw exception.&lt;/p&gt;

&lt;p&gt;Please correct me if anything is wrong, thanks~&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13576866">FLINK-35215</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1o9e8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>