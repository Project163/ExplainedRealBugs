<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:44:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-16262] Class loader problem with FlinkKafkaProducer.Semantic.EXACTLY_ONCE and usrlib directory</title>
                <link>https://issues.apache.org/jira/browse/FLINK-16262</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We&apos;re using Docker images modeled after&#160;&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-container/docker/Dockerfile&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-container/docker/Dockerfile&lt;/a&gt;&#160;(using Java 11)&lt;/p&gt;

&lt;p&gt;When I try to switch a Kafka producer from AT_LEAST_ONCE to EXACTLY_ONCE, the taskmanager startup fails with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-02-24 18:25:16.389 INFO&#160; o.a.f.r.t.Task &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Create Case Fixer -&amp;gt; Sink: Findings local-krei04-kba-digitalweb-uc1 (1/1) (72f7764c6f6c614e5355562ed3d27209) switched from RUNNING to FAILED.
org.apache.kafka.common.config.ConfigException: Invalid value org.apache.kafka.common.serialization.ByteArraySerializer &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; configuration key.serializer: &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; org.apache.kafka.common.serialization.ByteArraySerializer could not be found.
 at org.apache.kafka.common.config.ConfigDef.parseType(ConfigDef.java:718)
 at org.apache.kafka.common.config.ConfigDef.parseValue(ConfigDef.java:471)
 at org.apache.kafka.common.config.ConfigDef.parse(ConfigDef.java:464)
 at org.apache.kafka.common.config.AbstractConfig.&amp;lt;init&amp;gt;(AbstractConfig.java:62)
 at org.apache.kafka.common.config.AbstractConfig.&amp;lt;init&amp;gt;(AbstractConfig.java:75)
 at org.apache.kafka.clients.producer.ProducerConfig.&amp;lt;init&amp;gt;(ProducerConfig.java:396)
 at org.apache.kafka.clients.producer.KafkaProducer.&amp;lt;init&amp;gt;(KafkaProducer.java:326)
 at org.apache.kafka.clients.producer.KafkaProducer.&amp;lt;init&amp;gt;(KafkaProducer.java:298)
 at org.apache.flink.streaming.connectors.kafka.internal.FlinkKafkaInternalProducer.&amp;lt;init&amp;gt;(FlinkKafkaInternalProducer.java:76)
 at org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer.lambda$abortTransactions$2(FlinkKafkaProducer.java:1107)
 at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(Unknown Source)
 at java.base/java.util.HashMap$KeySpliterator.forEachRemaining(Unknown Source)
 at java.base/java.util.stream.AbstractPipeline.copyInto(Unknown Source)
 at java.base/java.util.stream.ForEachOps$ForEachTask.compute(Unknown Source)
 at java.base/java.util.concurrent.CountedCompleter.exec(Unknown Source)
 at java.base/java.util.concurrent.ForkJoinTask.doExec(Unknown Source)
 at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(Unknown Source)
 at java.base/java.util.concurrent.ForkJoinPool.scan(Unknown Source)
 at java.base/java.util.concurrent.ForkJoinPool.runWorker(Unknown Source)
 at java.base/java.util.concurrent.ForkJoinWorkerThread.run(Unknown Source)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This looks like a class loading issue: If I copy our JAR to FLINK_LIB_DIR instead of&#160;FLINK_USR_LIB_DIR, everything works fine.&lt;/p&gt;

&lt;p&gt;(AT_LEAST_ONCE producers works fine with the JAR in FLINK_USR_LIB_DIR)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;openjdk:11-jre with a slightly modified Flink 1.10.0 build (nothing changed regarding Kafka and/or class loading).&lt;/p&gt;</environment>
        <key id="13287287">FLINK-16262</key>
            <summary>Class loader problem with FlinkKafkaProducer.Semantic.EXACTLY_ONCE and usrlib directory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maguowei">Guowei Ma</assignee>
                                    <reporter username="jkreileder">J&#252;rgen Kreileder</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 24 Feb 2020 18:38:09 +0000</created>
                <updated>Thu, 2 Apr 2020 10:37:18 +0000</updated>
                            <resolved>Sat, 28 Mar 2020 13:43:40 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.1</fixVersion>
                    <fixVersion>1.11.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17044332" author="gjy" created="Tue, 25 Feb 2020 11:00:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maguowei&quot; class=&quot;user-hover&quot; rel=&quot;maguowei&quot;&gt;maguowei&lt;/a&gt; Do you see something suspicious? &lt;/p&gt;</comment>
                            <comment id="17045377" author="maguowei" created="Wed, 26 Feb 2020 10:44:39 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkreileder&quot; class=&quot;user-hover&quot; rel=&quot;jkreileder&quot;&gt;jkreileder&lt;/a&gt;&#160;could you provide more information? such as&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The version of Kafka connector&lt;/li&gt;
	&lt;li&gt;&#160;List the files in the lib and usrlib directories in the container.&lt;/li&gt;
	&lt;li&gt;&#160;Do you change the docker-entrypoint.sh ?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17045510" author="jkreileder" created="Wed, 26 Feb 2020 12:48:03 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maguowei&quot; class=&quot;user-hover&quot; rel=&quot;maguowei&quot;&gt;maguowei&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;1. We&apos;re using the universal connector, i.e. flink-connector-kafka_2.12&lt;/p&gt;

&lt;p&gt;2.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
flink@2194d2cf5949:~$ ls -al lib usrlib
lib:
total 105236
drwxr-xr-x 2 flink flink&#160; &#160; &#160; 4096 Feb 24 13:47 .
drwxr-xr-x 1 flink flink&#160; &#160; &#160; 4096 Feb 25 12:35 ..
-rw-r--r-- 1 flink flink 101157478 Feb 12 22:39 flink-dist_2.12-1.10.0-empolis.jar
-rw-r--r-- 1 flink flink &#160; 1051320 Feb 12 22:36 flink-metrics-influxdb-1.10.0-empolis.jar
-rw-r--r-- 1 flink flink&#160; &#160; 489884 Feb 12 21:52 log4j-1.2.17.jar
-rw-r--r-- 1 flink flink &#160; 4210517 Feb&#160; 9 10:45 ojdbc8-19.3.0.0.jar
-rw-r--r-- 1 flink flink&#160; &#160; 825943 Feb&#160; 9 10:45 postgresql-42.2.5.jar
-rw-r--r-- 1 flink flink&#160; &#160; &#160; 9931 Feb 12 21:52 slf4j-log4j12-1.7.15.jar


usrlib:
total 40176
drwxr-xr-x 2 flink flink &#160; &#160; 4096 Feb 25 12:35 .
drwxr-xr-x 1 flink flink &#160; &#160; 4096 Feb 25 12:35 ..
-rw-r--r-- 1 flink flink 41129331 Feb 25 12:35 iana-stack.jar&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;flink-1.10.0-empolis is a Java 11/Scala 2.12 build.&lt;br/&gt;
 iana-stack.jar is an uber JAR which has flink-connector-kafka_2.12 and kafka-clients:2.2.0 included.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[info]   | +-org.apache.flink:flink-connector-kafka-base_2.12:1.10.0-empolis
[info]   | | +-com.google.code.findbugs:jsr305:1.3.9
[info]   | | +-org.apache.flink:force-shading:1.10.0-empolis
[info]   | | +-org.slf4j:slf4j-api:1.7.15 (evicted by: 1.7.25)
[info]   | | +-org.slf4j:slf4j-api:1.7.25
[info]   | | 
[info]   | +-org.apache.flink:force-shading:1.10.0-empolis
[info]   | +-org.apache.kafka:kafka-clients:2.2.0
[info]   | | +-com.github.luben:zstd-jni:1.3.8-1
[info]   | | +-org.lz4:lz4-java:1.5.0
[info]   | | +-org.slf4j:slf4j-api:1.7.25
[info]   | | +-org.xerial.snappy:snappy-java:1.1.7.2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3. Yes, we&apos;re use a customized docker entrypoint based on&#160;&lt;a href=&quot;https://github.com/docker-flink/docker-flink/blob/master/docker-entrypoint.sh&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/docker-flink/docker-flink/blob/master/docker-entrypoint.sh&lt;/a&gt;. The only changes are env-variable based modifications of conf/log4j-console.properties and generation of savepoint options.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17045695" author="maguowei" created="Wed, 26 Feb 2020 16:45:03 +0000"  >&lt;p&gt;1. The direct cause of this problem should be that FlinkKafkaProducer has been using system classloader instead of user classloader in &lt;em&gt;abortTransactions&lt;/em&gt;&#160;in whatever situation.&lt;br/&gt;
2. FlinkKafkaProducer: line 1098 &lt;em&gt;transactionalIds.parallelStream().forEach(.....)&lt;/em&gt;. This would use a static thread pool and the context Classloader of this thread pool should be the system.&lt;/p&gt;

&lt;p&gt;I think this is a FlinkKafkaProducer bug that should be fixed.&#160; I would contact the committer to double-check it tomorrow.&lt;/p&gt;

&lt;p&gt;Thanks for your reporting.&lt;/p&gt;</comment>
                            <comment id="17046584" author="pnowojski" created="Thu, 27 Feb 2020 12:51:18 +0000"  >&lt;p&gt;Yes, I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maguowei&quot; class=&quot;user-hover&quot; rel=&quot;maguowei&quot;&gt;maguowei&lt;/a&gt; is right. The problem is with &lt;tt&gt;parallelStream()&lt;/tt&gt; not setting the thread context ClassLoader. I think the easiest solution would be to set the correct context class loader manually (we have a helper class for that &lt;tt&gt;org.apache.flink.util.TemporaryClassLoaderContext&lt;/tt&gt;). &lt;/p&gt;

&lt;p&gt;Also I don&apos;t think this is a blocker strictly speaking, as this error is probably in the code since Flink 1.5. Or has something changed in Flink 1.10? &lt;/p&gt;</comment>
                            <comment id="17046592" author="gjy" created="Thu, 27 Feb 2020 12:56:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; In 1.10 we enabled user code class loading for per-job clusters. Before the job jar was just added to the classpath.&lt;/p&gt;</comment>
                            <comment id="17046687" author="pnowojski" created="Thu, 27 Feb 2020 14:41:27 +0000"  >&lt;p&gt;Ok, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;. I think this is a combination of what you said and this change: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13498&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-13498&lt;/a&gt; which actually introduced the bug. So it&apos;s a new thing in 1.10. I&apos;ve restored the BLOCKER status. &lt;/p&gt;

&lt;p&gt;It would be nice to provide a test coverage for this issue, but I don&apos;t see if it could be done without adding another end to end test? I&apos;m not sure if that&apos;s worth it?&lt;/p&gt;</comment>
                            <comment id="17048804" author="maguowei" created="Mon, 2 Mar 2020 05:55:36 +0000"  >&lt;p&gt;Thanks for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;&apos;s&#160; explanation. This also reminds one thing. Currently, in the Yarn/Mesos per job the user class loader is not enabled by default. I think maybe we should keep the same behavior in per-job clusters. For example we could provide a arguments &#8211;with-usrlib to build.sh. Only if user give this parameter to build.sh we should copy the user jar to usrlib/ directory.&lt;/p&gt;

&lt;p&gt;What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17049007" author="gjy" created="Mon, 2 Mar 2020 10:28:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maguowei&quot; class=&quot;user-hover&quot; rel=&quot;maguowei&quot;&gt;maguowei&lt;/a&gt; It sounds reasonable to make this behavior configurable for the docker images. That should be a new ticket however. IIRC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; is currently consolidating our Dockerfiles.&lt;/p&gt;</comment>
                            <comment id="17050211" author="azagrebin" created="Tue, 3 Mar 2020 13:38:46 +0000"  >&lt;p&gt;As a quick fix for build.sh, I would be ok with &#8211;with-usrlib.&lt;br/&gt;
For the note, there is a preliminary plan for refactoring user facing docker components (still to discuss as FLIP). There we want to rather improve user documentation about how to extend the mainstream docker hub image instead of maintaining the build.sh script. In this regard, we may end up completely removing the scripts.&lt;/p&gt;</comment>
                            <comment id="17051031" author="pnowojski" created="Wed, 4 Mar 2020 09:23:30 +0000"  >&lt;p&gt;I think there is no need for quick fix, as we have the proper fix almost done (just missing test coverage)&lt;/p&gt;</comment>
                            <comment id="17061795" author="maguowei" created="Wed, 18 Mar 2020 15:07:05 +0000"  >&lt;p&gt;hi,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkreileder&quot; class=&quot;user-hover&quot; rel=&quot;jkreileder&quot;&gt;jkreileder&lt;/a&gt;&#160;could you reproduce this problem in the session mode?&lt;/p&gt;</comment>
                            <comment id="17069460" author="zjwang" created="Sat, 28 Mar 2020 13:43:40 +0000"  >&lt;p&gt;Merged in release-1.10:&#160;e39cfe7660daaeed4213f04ccbce6de1e8d90fe5&lt;/p&gt;

&lt;p&gt;Merged in master:&#160;ff0d0c979d7cf67648ecf91850e782e99d557240&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13247871">FLINK-13498</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 33 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0bu48:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>