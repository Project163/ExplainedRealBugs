<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:44:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14316] Stuck in &quot;Job leader ... lost leadership&quot; error</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14316</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;This is the first exception caused restart loop. Later exceptions are the same. Job seems to stuck in this permanent failure state.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-10-03 21:42:46,159 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph        - Source: clpevents -&amp;gt; device_filter -&amp;gt; processed_imps -&amp;gt; ios_processed_impression -&amp;gt; i
mps_ts_assigner (449/1360) (d237f5e99b6a4a580498821473763edb) switched from SCHEDULED to FAILED.
java.lang.Exception: Job leader &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job id ecb9ad9be934edf7b1a4f7b9dd6df365 lost leadership.
        at org.apache.flink.runtime.taskexecutor.TaskExecutor$JobLeaderListenerImpl.lambda$jobManagerLostLeadership$1(TaskExecutor.java:1526)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRunAsync(AkkaRpcActor.java:332)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:158)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.onReceive(AkkaRpcActor.java:142)
        at akka.actor.UntypedActor$$anonfun$receive$1.applyOrElse(UntypedActor.scala:165)
        at akka.actor.Actor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;aroundReceive(Actor.scala:502)
        at akka.actor.UntypedActor.aroundReceive(UntypedActor.scala:95)
        at akka.actor.ActorCell.receiveMessage(ActorCell.scala:526)
        at akka.actor.ActorCell.invoke(ActorCell.scala:495)
        at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:257)
        at akka.dispatch.Mailbox.run(Mailbox.scala:224)
        at akka.dispatch.Mailbox.exec(Mailbox.scala:234)
        at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
        at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
        at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
        at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13260454">FLINK-14316</key>
            <summary>Stuck in &quot;Job leader ... lost leadership&quot; error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="stevenz3wu">Steven Zhen Wu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 3 Oct 2019 21:58:53 +0000</created>
                <updated>Fri, 17 Apr 2020 02:22:25 +0000</updated>
                            <resolved>Thu, 2 Apr 2020 09:01:08 +0000</resolved>
                                    <version>1.7.2</version>
                                    <fixVersion>1.9.3</fixVersion>
                    <fixVersion>1.10.1</fixVersion>
                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16944374" author="till.rohrmann" created="Fri, 4 Oct 2019 10:03:07 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevenz3wu&quot; class=&quot;user-hover&quot; rel=&quot;stevenz3wu&quot;&gt;stevenz3wu&lt;/a&gt;. Does the same problem occur with Flink &lt;tt&gt;1.8&lt;/tt&gt; or &lt;tt&gt;1.9&lt;/tt&gt;? I&apos;m asking because the community no longer supports Flink &lt;tt&gt;1.7&lt;/tt&gt; and below.&lt;/p&gt;</comment>
                            <comment id="16944638" author="stevenz3wu" created="Fri, 4 Oct 2019 16:16:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; don&apos;t know. we are just beginning rolling out of 1.9. It will take some time for those large-state jobs to pick up 1.9.&lt;/p&gt;</comment>
                            <comment id="16945780" author="till.rohrmann" created="Mon, 7 Oct 2019 10:42:59 +0000"  >&lt;p&gt;Thanks for the information. Can you provide us with the full logs of the run where the problem occurred?&lt;/p&gt;</comment>
                            <comment id="16946322" author="stevenz3wu" created="Mon, 7 Oct 2019 23:07:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; in the uploaded tar ball, there is one TM log file. the rest are JM log files.&lt;/p&gt;

&lt;p&gt;This is the line from TM log that TM thinks JM lost leadership.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-10-06 16:11:36,471 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor            - JobManager &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 3bb42eb7602c5ba25740d8360b1f0e27 with leader id 9aa48c6a49d009f7fb287754b61d4af8 lost leadership.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16946326" author="stevenz3wu" created="Mon, 7 Oct 2019 23:10:50 +0000"  >&lt;p&gt;From TM log, I also noticed that&#160;ZooKeeperLeaderRetrievalService started, stopped, then started again.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-10-06 16:07:32,509 INFO  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Starting ZooKeeperLeaderRetrievalService /leader/resource_manager_lock.
...
2019-10-06 16:07:35,018 INFO  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Stopping ZooKeeperLeaderRetrievalService /leader/resource_manager_lock.
...
2019-10-06 16:07:37,546 INFO  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Starting ZooKeeperLeaderRetrievalService /leader/resource_manager_lock.

 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16946327" author="stevenz3wu" created="Mon, 7 Oct 2019 23:13:57 +0000"  >&lt;p&gt;My colleague &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pgoyal&quot; class=&quot;user-hover&quot; rel=&quot;pgoyal&quot;&gt;pgoyal&lt;/a&gt; will attach a patch, which does seems to fix this specific problem.&lt;/p&gt;

&lt;p&gt;However, we still don&apos;t know how we get here. there is no change in the application/Flink code. and we suddenly start to experience this problem. Maybe some dynamics change in the infrastructure/env that caused this problem to show up.&lt;/p&gt;</comment>
                            <comment id="16946580" author="pgoyal" created="Tue, 8 Oct 2019 07:28:17 +0000"  >&lt;p&gt;Added the patch that seemed to help. In addition to the original exception that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevenz3wu&quot; class=&quot;user-hover&quot; rel=&quot;stevenz3wu&quot;&gt;stevenz3wu&lt;/a&gt;&#160; posted, We also observed the following IllegalStateExceptions that made us look into the&#160;RegisteredRpcConnection class and try this change.&#160;&lt;/p&gt;

&lt;p&gt;__________________________________________&lt;/p&gt;

&lt;p&gt;Caused by: java.lang.IllegalStateException: &lt;font color=&quot;#de350b&quot;&gt;The RPC connection is already started&lt;/font&gt;&lt;br/&gt;
 at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195)&lt;br/&gt;
 at org.apache.flink.runtime.registration.RegisteredRpcConnection.start(RegisteredRpcConnection.java:92)&lt;br/&gt;
 at org.apache.flink.runtime.taskexecutor.JobLeaderService$JobManagerLeaderListener.notifyLeaderAddress(JobLeaderService.java:327)&lt;/p&gt;

&lt;p&gt;_______________________________________________&lt;/p&gt;

&lt;p&gt;Caused by: java.lang.IllegalStateException: &lt;font color=&quot;#de350b&quot;&gt;The RPC connection is already closed&lt;/font&gt;&lt;br/&gt;
 at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195)&lt;br/&gt;
 at org.apache.flink.runtime.registration.RegisteredRpcConnection.start(RegisteredRpcConnection.java:91)&lt;br/&gt;
 at org.apache.flink.runtime.taskexecutor.JobLeaderService$JobManagerLeaderListener.notifyLeaderAddress(JobLeaderService.java:327)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16950470" author="stevenz3wu" created="Sun, 13 Oct 2019 20:34:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;we would love to hear your thoughts on two specific questions&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Piyush&apos;s patch clearly fixed whatever bug that caused this issue. Do you see any other implication/downside of such a change? if it is good, we can create an official PR to upstream.&lt;/li&gt;
	&lt;li&gt;We still haven&apos;t been able to identify the root cause for this bug to show up. This job has been running stable and there is no code change. Any idea?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Some background for this job&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;235 containers. each with 8 CPUs/slots. parallelism is 1,880. When running into this problem, we also tried 50 containers (with 400 parallelism) and it was still failing.&lt;/li&gt;
	&lt;li&gt;it is a large-state job (a few TBs), although we don&apos;t think it matters. we tried to redeploy the job with empty state and it still suffered the same failure loop.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16951016" author="till.rohrmann" created="Mon, 14 Oct 2019 13:56:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevenz3wu&quot; class=&quot;user-hover&quot; rel=&quot;stevenz3wu&quot;&gt;stevenz3wu&lt;/a&gt; sorry for being unresponsive the last couple of days. I&apos;ll still have this issue on my to do list and will look into it in the next couple of days. I hope to be able to give you an answer to your questions by then.&lt;/p&gt;</comment>
                            <comment id="17071999" author="till.rohrmann" created="Tue, 31 Mar 2020 17:29:22 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevenz3wu&quot; class=&quot;user-hover&quot; rel=&quot;stevenz3wu&quot;&gt;stevenz3wu&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pgoyal&quot; class=&quot;user-hover&quot; rel=&quot;pgoyal&quot;&gt;pgoyal&lt;/a&gt;, sorry for my late reply. &lt;/p&gt;

&lt;p&gt;The logs did not show any specific problems and it looked as if there were some network issues causing the TM to think that the JM lost its leadership. However, what Piyush wrote and the patch itself pointed me into the right direction. The problem is that we don&apos;t reset the &lt;tt&gt;rpcConnection&lt;/tt&gt; in the &lt;tt&gt;JobManagerLeaderListener&lt;/tt&gt; if the JM loses its leadership. Due to this, Flink will try to reuse the &lt;tt&gt;rpcConnection&lt;/tt&gt; if a TM learns about the new old leader (JM with the same leader session id). This, however, fails because of the &lt;tt&gt;checkState&lt;/tt&gt; in &lt;tt&gt;RegisteredRpcConnection.start&lt;/tt&gt; method because it already contains a &lt;tt&gt;pendingRegistration&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The patch works because it will always create a new &lt;tt&gt;RpcConnection&lt;/tt&gt;. Alternatively, one could null the &lt;tt&gt;rpcConnection&lt;/tt&gt; when the leader loses the leadership. I actually fixed this problem in 1.11 (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16836&quot; title=&quot;Losing leadership does not clear rpc connection in JobManagerLeaderListener&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-16836&quot;&gt;&lt;del&gt;FLINK-16836&lt;/del&gt;&lt;/a&gt;) because of another problem. I will backport this fix to 1.10 and 1.9.&lt;/p&gt;

&lt;p&gt;Last but not least, you might ask why did the problem not occur in the logs you&apos;ve attached. I think the reason is because it took ZooKeeper long enough to realize that the old JobManager is still the leader so that the slots on the &lt;tt&gt;TaskExecutor&lt;/tt&gt; could time out. Once all slots belonging a job have timed out, the &lt;tt&gt;JobManagerLeaderListener&lt;/tt&gt; will be closed.&lt;/p&gt;

&lt;p&gt;Thanks again for reporting this issue and sorry for the long waiting time.&lt;/p&gt;
</comment>
                            <comment id="17072298" author="stevenz3wu" created="Wed, 1 Apr 2020 01:41:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;thanks a lot for the follow-up. we will upgrade to `1.10.1` as soon as it is released.&lt;/p&gt;</comment>
                            <comment id="17072313" author="carp84" created="Wed, 1 Apr 2020 02:31:15 +0000"  >&lt;p&gt;1.10.1 is in good shape and ideally the first RC is coming in the next one or two weeks. The status will be updated in &lt;a href=&quot;https://s.apache.org/bhquo&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this ML thread&lt;/a&gt;, JFYI. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevenz3wu&quot; class=&quot;user-hover&quot; rel=&quot;stevenz3wu&quot;&gt;stevenz3wu&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17073532" author="till.rohrmann" created="Thu, 2 Apr 2020 09:01:08 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.11.0: 356e2b61f2ddd5cdefbe74b31db41b97210ceec6&lt;br/&gt;
1.10.1: 7ee7f23e6c5c972fb9055d82ffe63a2bc0160969&lt;br/&gt;
1.9.3: 323c406ef5c1cfccb17fc65053d2d13dc648366d&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13294511">FLINK-16836</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12982434" name="FLINK-14316.tgz" size="8989574" author="stevenz3wu" created="Mon, 7 Oct 2019 23:03:56 +0000"/>
                            <attachment id="12982468" name="RpcConnection.patch" size="1309" author="pgoyal" created="Tue, 8 Oct 2019 07:27:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07a0w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>