<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:49:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-17073] Slow checkpoint cleanup causing OOMs</title>
                <link>https://issues.apache.org/jira/browse/FLINK-17073</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;A user reported that he sees a decline in checkpoint cleanup speed when upgrading from Flink 1.7.2 to 1.10.0. The result is that a lot of cleanup tasks are waiting in the execution queue occupying memory. Ultimately, the JM process dies with an OOM.&lt;/p&gt;

&lt;p&gt;Compared to Flink 1.7.2, we introduced a dedicated &lt;tt&gt;ioExecutor&lt;/tt&gt; which is used by the &lt;tt&gt;HighAvailabilityServices&lt;/tt&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11851&quot; title=&quot;ClusterEntrypoint provides wrong executor to HaServices&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11851&quot;&gt;&lt;del&gt;FLINK-11851&lt;/del&gt;&lt;/a&gt;). Before, we use the &lt;tt&gt;AkkaRpcService&lt;/tt&gt; thread pool which was a &lt;tt&gt;ForkJoinPool&lt;/tt&gt; with a max parallelism of 64. Now it is a &lt;tt&gt;FixedThreadPool&lt;/tt&gt; with as many threads as CPU cores. This change might have caused the decline in completed checkpoint discard throughput. This suspicion needs to be validated before trying to fix it!&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://lists.apache.org/thread.html/r390e5d775878918edca0b6c9f18de96f828c266a888e34ed30ce8494%40%3Cuser.flink.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/r390e5d775878918edca0b6c9f18de96f828c266a888e34ed30ce8494%40%3Cuser.flink.apache.org%3E&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13297397">FLINK-17073</key>
            <summary>Slow checkpoint cleanup causing OOMs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="echauchot">Etienne Chauchot</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 9 Apr 2020 14:24:23 +0000</created>
                <updated>Fri, 28 May 2021 07:00:35 +0000</updated>
                            <resolved>Wed, 14 Oct 2020 14:27:58 +0000</resolved>
                                    <version>1.7.3</version>
                    <version>1.8.0</version>
                    <version>1.9.0</version>
                    <version>1.10.0</version>
                    <version>1.11.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>16</watches>
                                                                                                                <comments>
                            <comment id="17084058" author="zentol" created="Wed, 15 Apr 2020 12:54:12 +0000"  >&lt;p&gt;Seems like the underlying issue is that we aren&apos;t limiting the number of tasks that can be queued up (which I &lt;em&gt;think&lt;/em&gt; would implicitly slow down checkpointing since it would delay the completion of a pending checkpoint). Ignoring potential architectural problems, this should make the system way more resilient to these kind of issues than an increase of the pool size would.&lt;/p&gt;</comment>
                            <comment id="17084096" author="till.rohrmann" created="Wed, 15 Apr 2020 13:39:54 +0000"  >&lt;p&gt;I agree, but this would require bigger architectural changes. In the meantime I would suggest to make the number of IO threads configurable for the user. That way, users can work around this problem until the proper fix has been put in place.&lt;/p&gt;</comment>
                            <comment id="17084107" author="till.rohrmann" created="Wed, 15 Apr 2020 14:06:15 +0000"  >&lt;p&gt;Maybe we could create a related issue which introduces the configuration option and keep this one for the proper fix which might entail to throttle the checkpoint throughput based on the cleanup backlog.&lt;/p&gt;</comment>
                            <comment id="17084149" author="yunta" created="Wed, 15 Apr 2020 14:50:36 +0000"  >&lt;p&gt;I prefer to the configuration solution to keep the behavior the same as before. Current Flink architecture cannot totally prevent this problem if the speed of creating checkpoint larger than the speed of deleting previous checkpoints. Increase the pool size could not prevent this but only mitigate the possibility.&lt;/p&gt;</comment>
                            <comment id="17093738" author="pnowojski" created="Mon, 27 Apr 2020 16:55:07 +0000"  >&lt;p&gt;I haven&apos;t analysed the issue, so I&apos;m not sure if indeed backpressuring is the right thing to do, but assuming that is the case, it&apos;s not a bug fix, but an improvement/new feature, so I&apos;ve created another ticket for that &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17421&quot; title=&quot;Backpressure new checkpoints if previous were not managed to be cleaned up yet &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17421&quot;&gt;&lt;del&gt;FLINK-17421&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Btw, IMO &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17248&quot; title=&quot;Make the thread nums of io executor of ClusterEntrypoint and MiniCluster configurable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17248&quot;&gt;&lt;del&gt;FLINK-17248&lt;/del&gt;&lt;/a&gt; is a duplicate of this ticket, as it&apos;s fixing regression reported in this issue.&lt;/p&gt;</comment>
                            <comment id="17094277" author="till.rohrmann" created="Tue, 28 Apr 2020 08:16:19 +0000"  >&lt;p&gt;I would like to keep this ticket and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17248&quot; title=&quot;Make the thread nums of io executor of ClusterEntrypoint and MiniCluster configurable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17248&quot;&gt;&lt;del&gt;FLINK-17248&lt;/del&gt;&lt;/a&gt; separate. The reason is that I believe that the latter will just mitigate the problem and the true bug is that we don&apos;t limit the number of concurrent checkpoint clean up tasks. In that sense, it has always been broken. Moreover, this ticket is not about a regression we want to fix. The underlying problem only surfaced due to changing the executor.&lt;/p&gt;

&lt;p&gt;What we can do is to say that &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17421&quot; title=&quot;Backpressure new checkpoints if previous were not managed to be cleaned up yet &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17421&quot;&gt;&lt;del&gt;FLINK-17421&lt;/del&gt;&lt;/a&gt; will fix this bug here. Hence, once &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17421&quot; title=&quot;Backpressure new checkpoints if previous were not managed to be cleaned up yet &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17421&quot;&gt;&lt;del&gt;FLINK-17421&lt;/del&gt;&lt;/a&gt; is closed, we can close this bug issue.&lt;/p&gt;</comment>
                            <comment id="17098770" author="pnowojski" created="Mon, 4 May 2020 08:28:05 +0000"  >&lt;p&gt;As it&apos;s a rare issue that in this particular case will have a workaround (increasing number of threads in the thread pool), I&apos;m reducing the priority. Also because of other independent efforts in the &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; code, it&apos;s unlikely the bug fix will be back-ported to previous releases.&lt;/p&gt;</comment>
                            <comment id="17108270" author="echauchot" created="Fri, 15 May 2020 13:17:18 +0000"  >&lt;p&gt;Hi, I just started contributing to Flink. I&apos;d like to take a look at this subject as it can be a good introduction to Flink architecture IMHO. As the temporary workaround discussed above has been implemented&#160;[here|&lt;a href=&quot;https://github.com/apache/flink/pull/11957&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/11957&lt;/a&gt;] maybe it is time to tackle the above subject. One thing I wonder is: if we want to limit the number of CompletedCheckpoints submitted to the IOExecutor for cleaning, what happens if&#160;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ZooKeeperCompletedCheckpointStore&lt;/em&gt;&#160; tries to submit a new CompletedCheckpoint when the limit has already been reached ? Shall it delay the submission waiting for the current number of submitted tasks to decrease?&lt;/p&gt;</comment>
                            <comment id="17108305" author="till.rohrmann" created="Fri, 15 May 2020 13:52:08 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;, I think what needs to happen is that we backpressure the whole checkpointing mechanism if the cleanup cannot keep up with it. This means that we don&apos;t trigger new checkpoints. This is far from trivial to realize, though, and on top of it, it needs to be properly designed. I&apos;m not entirely sure whether this is really a good task to get started with.&lt;/p&gt;</comment>
                            <comment id="17108315" author="echauchot" created="Fri, 15 May 2020 14:02:52 +0000"  >&lt;p&gt;ok, fair enough, I&apos;ll pick another one.&lt;/p&gt;</comment>
                            <comment id="17116660" author="echauchot" created="Tue, 26 May 2020 11:48:04 +0000"  >&lt;p&gt;Anyway I&apos;d like to take part to the design discussions regarding checkpoint backpressure in order to learn about these topics.&lt;/p&gt;</comment>
                            <comment id="17143678" author="echauchot" created="Wed, 24 Jun 2020 09:03:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160; I&apos;m thinking about this issue, I&apos;ll start a first design doc for the checkpoint backpressure system. I&apos;ll send it here and on the ML.&lt;/p&gt;</comment>
                            <comment id="17144715" author="till.rohrmann" created="Thu, 25 Jun 2020 07:31:09 +0000"  >&lt;p&gt;Yes, your help is highly appreciated. Given that this is not a trivial problem I would suggest to sync with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt; about the next steps.&lt;/p&gt;</comment>
                            <comment id="17144726" author="echauchot" created="Thu, 25 Jun 2020 07:48:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, I wrote&#160;[this|&lt;a href=&quot;https://s.apache.org/checkpoint-backpressure&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://s.apache.org/checkpoint-backpressure&lt;/a&gt;]&#160;FLIP style design document for checkpoint backpressure. Can you tell me what you think? Also I don&apos;t have the rights to create FLIP design documents in flink confluence workspace so I did the FLIP in a google doc. Can you give me the rights?&lt;/p&gt;</comment>
                            <comment id="17144733" author="echauchot" created="Thu, 25 Jun 2020 08:03:31 +0000"  >&lt;p&gt;I&apos;m always glad to help ! No problem about syncing with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;. Not an trivial problem indeed, but I figured out that it could be a good way to learn quite a lot about Flink internals&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17150791" author="pnowojski" created="Fri, 3 Jul 2020 07:29:53 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;, I&apos;m OoO since last two weeks and will be back on July 13th. Can we sync offline on this issue?&lt;/p&gt;</comment>
                            <comment id="17151618" author="sleepy" created="Sun, 5 Jul 2020 16:46:00 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;, thanks for doing so much. I left a couple of comments in design doc. The second proposal seems to be a reliable and light solution &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17151881" author="echauchot" created="Mon, 6 Jul 2020 08:46:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;no problem. Sorry for bothering you during your days off &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;&#160;thanks for reviewing this doc, I&apos;ll look at your comments.&lt;/p&gt;</comment>
                            <comment id="17161316" author="echauchot" created="Mon, 20 Jul 2020 15:17:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;&#160;can you assign this ticket to me please ?&lt;/p&gt;</comment>
                            <comment id="17161657" author="sleepy" created="Tue, 21 Jul 2020 01:56:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;, sorry I don&apos;t have the&#160;authorization of issue assignment. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;, could you help to assign the ticket to him?&lt;/p&gt;</comment>
                            <comment id="17161704" author="zjwang" created="Tue, 21 Jul 2020 04:55:05 +0000"  >&lt;p&gt;I have assigned it to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17161882" author="echauchot" created="Tue, 21 Jul 2020 09:07:39 +0000"  >&lt;p&gt;thanks guys !&lt;/p&gt;</comment>
                            <comment id="17162112" author="roman_khachatryan" created="Tue, 21 Jul 2020 15:32:01 +0000"  >&lt;p&gt;I think an alternative (or complementary) temporary solution is to use a bounded queue when creating&#160;ioExecutor.&lt;/p&gt;

&lt;p&gt;This way, we solve this issue and also possible others, which we don&apos;t account for in design doc.&lt;/p&gt;</comment>
                            <comment id="17162168" author="roman_khachatryan" created="Tue, 21 Jul 2020 16:48:24 +0000"  >&lt;p&gt;As for the long-term solution, I&apos;d propose the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Extract &lt;b&gt;ZooKeeperCompletedCheckpointStore.tryRemoveCompletedCheckpoint&lt;/b&gt;&#160;(along with &lt;b&gt;executor&lt;/b&gt;) to a new class, e.g.&#160;&lt;b&gt;CheckpointCleaner&lt;/b&gt; that maintains a queue of checkpoints to remove&lt;/li&gt;
	&lt;li&gt;On removal completion, it calls &lt;b&gt;CheckpointCoordinator&lt;/b&gt;.timer.execute(&lt;b&gt;executeQueuedRequest&lt;/b&gt;)&lt;/li&gt;
	&lt;li&gt;In &lt;b&gt;CheckpointRequestDecider.chooseRequestToExecute&lt;/b&gt;, check&#160;&lt;b&gt;CheckpointCleaner.numberOfCheckpointsToRemove&lt;/b&gt;&#160;and return if it&apos;s greater than the threshold (see below)&#160;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;CheckpointCleaner&lt;/b&gt;&#160;reports&#160;**this count in a thread-safe manner (performance isn&apos;t an issue here)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This way, we ensure these properties:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;if checkpoint can&apos;t be started, it&apos;s queued (if the queue has space) but not started&lt;/li&gt;
	&lt;li&gt;once a subsumed checkpoint is removed, we check the queue, and if possible, start the checkpoint&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;It&apos;s possible that we check the queue twice (1st in chooseRequestToExecute, 2nd in CheckpointCleaner), but that&apos;s OK, we&apos;ll just execute the next request if possible.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Regarding adding an additional configuration parameter for the threshold, I don&apos;t see much value in it. Conceptually,&#160;we don&apos;t want to proceed as long as there are checkpoints to remove from the previous completion.&lt;/p&gt;

&lt;p&gt;So we can use max-concurrent-checkpoints as a threshold (maybe multiplied by some constant factor to account for spikes and savepoints).&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17164623" author="echauchot" created="Fri, 24 Jul 2020 20:31:01 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;thanks for the suggestions! Overall this is what I intended to do modulo these minor things:&lt;/p&gt;

&lt;p&gt;In 1. I meant to use the &lt;em&gt;CompletedCheckpoints&lt;/em&gt;&#160;dequeue to keep track of the checkpoints to clean and avoid adding a new queue&lt;/p&gt;

&lt;p&gt;In 2. Yes indeed, it needs to call&#160;&lt;em&gt;executeQueuedRequest,&lt;/em&gt;&#160;but it needs also not to call it when the previous checkpoint cleaning is not done (still need to figure out how to sync cleaning with work in CheckpointCoordinator) so that checkpoint cleaning becomes part of the checkpoint process and not a side fire-and-forget process. This behavior will be configurable to avoid lowering checkpoint rate when CP cleaning rate is not a problem. Once cleaning is part of the standard checkpointing process, checking in flight checkpoints will tell how many potential cleaning checkpoints there are and if there are too much, drop any new CP trigger request.&lt;/p&gt;

&lt;p&gt;In 3. yes that is what I meant in &quot;drop any new CP trigger request&quot; above.&lt;/p&gt;

&lt;p&gt;In 4.&#160; I&apos;m not clear yet about concurrency in checkpointing.&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="17165518" author="sleepy" created="Mon, 27 Jul 2020 07:59:23 +0000"  >&lt;p&gt;To &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;, thanks for nice suggestions!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think an alternative (or complementary) temporary solution is to use a bounded queue when creating ioExecutor.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m not a fan of this temporary solution. We have to consider how to treat the invoker which launches asynchronous IO operations through &lt;tt&gt;ioExecutor&lt;/tt&gt; if the queue is full. Make them failed or wait till there is some space available? I&apos;m afraid it&apos;s not a small work to review all the places calls &lt;tt&gt;ioExecutor&lt;/tt&gt;. If we want a temporary solution, maybe we could just increase the thread count. &lt;/p&gt;

&lt;p&gt;Regarding to the long-term solution. Actually Etienne and me have not discuss many of the implementation details. I just gave some suggestions to make sure it&apos;s in the right direction. It&apos;s cool to have your detailed suggestions. It may help a lot for the contributor who is not familiar with this part. I just thought we don&apos;t have to discuss too much details here. It might be better to give contributor more free space. We could pay more attention on code review to guarantee it&apos;s correct and reasonable.&lt;/p&gt;

&lt;p&gt;BTW, just a tiny suggestion, code refactoring is not necessary, we should focus on solving the issue first. After that, we could consider if we could do some refactoring to make the codes more readable or elegant. &lt;/p&gt;

&lt;p&gt;To &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;, besides the implementation, is there any question about the plan? Please feel free to ask anything that you don&apos;t understand. &lt;/p&gt;</comment>
                            <comment id="17165710" author="roman_khachatryan" created="Mon, 27 Jul 2020 13:37:05 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;, sure, I just shared my view of how it can be implemented.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;,&#160;&lt;/p&gt;

&lt;p&gt;for (1) I don&apos;t think having a separate queue is an issue, rather the opposite (the class + thread manages its own work queue).&lt;/p&gt;

&lt;p&gt;for (2) I think checking the aforementioned queue size (+ number of deletions in progress) is enough, isn&apos;t it?&lt;/p&gt;</comment>
                            <comment id="17166244" author="sleepy" created="Tue, 28 Jul 2020 08:12:05 +0000"  >&lt;p&gt;BTW &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;, before writing any codes, it would be great to write an implementation plan first. That&apos;s a better place to discuss implementation detail.&lt;br/&gt;
I heard some other guys are also interested in this issue. It would be helpful fo them to understand what is happening. Besides that, there would be some other PRs on &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; at the same time. We have to make sure there would be no big conflict between these changes.&lt;/p&gt;</comment>
                            <comment id="17166310" author="echauchot" created="Tue, 28 Jul 2020 09:57:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;&#160;sure, I&apos;ll update the google doc to add impl plan.&lt;/p&gt;</comment>
                            <comment id="17166480" author="echauchot" created="Tue, 28 Jul 2020 14:56:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;When &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;&#160;and I discussed in &lt;a href=&quot;https://docs.google.com/document/d/1q0y0aWlJMoUWNW7jjsM8uWfHsy2dM6YmmcmhpQzgLMA/edit?usp=sharing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the deisgn doc&lt;/a&gt;, the idea was to wait until last checkpoint was cleaned before accepting another (that is what we called make cleaning part of checkpoint processing). Thus, checking only existing number of pending checkpoints was enough (no need for a new queue) to foresee an flood of checkpoints to clean.&#160;&lt;/p&gt;

&lt;p&gt;But the solution you propose (managing the queue of the checkpoints to clean and monitor its size) seems even simpler to me: it avoids having to sync normal checkpointing and checkpoint cleaning:&lt;/p&gt;

&lt;p&gt;As you said, when we chose a checkpoint trigger request to execute (&lt;b&gt;CheckpointRequestDecider.chooseRequestToExecute&lt;/b&gt;), we can drop new checkpoint requests when there are too many checkpoints to clean and thus regulate the whole checkpointing system.&#160;Syncing cleaning and checkpointing might not be necessary for this regulation, you&apos;re right.&lt;/p&gt;

&lt;p&gt;If you don&apos;t mind, I&apos;ll go for this implementation proposal in the design doc.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; thanks anyway for the suggestions and please take a look at the design doc where we will have the impl discussions&lt;/p&gt;</comment>
                            <comment id="17166501" author="roman_khachatryan" created="Tue, 28 Jul 2020 15:27:09 +0000"  >&lt;p&gt;Thanks for your analysis &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;.&lt;br/&gt;
Sure, go ahead!&lt;/p&gt;</comment>
                            <comment id="17168891" author="echauchot" created="Fri, 31 Jul 2020 14:15:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;&#160;I just submitted the PR:&#160;&lt;a href=&quot;https://github.com/apache/flink/pull/13040&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/13040&lt;/a&gt;&#160;also please read the design doc&apos;s implementation plan comments for an explanation of the impl choices (responsibilities, interfaces, threshold, resume event ...)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17170015" author="sleepy" created="Mon, 3 Aug 2020 12:54:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;, sorry for the late reply. Thanks for pushing this!&lt;/p&gt;

&lt;p&gt;I&apos;m OK with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&apos;s plan. It&apos;s simpler to implement in some aspects indeed. In my plan, we have to consider how to avoid synchronous cleaning which you mentioned. Because in the near future, &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; would be no big lock anymore. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;...we can drop new checkpoint requests when there are too many checkpoints to clean...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think we should take care of the cleaning for both successful checkpoint and failed checkpoint. &lt;/p&gt;

&lt;p&gt;I have left some comments in the doc.&lt;/p&gt;</comment>
                            <comment id="17170150" author="roman_khachatryan" created="Mon, 3 Aug 2020 16:13:09 +0000"  >&lt;p&gt;Thanks for the PR &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;&#160;,&lt;/p&gt;

&lt;p&gt;I found that it significantly diverges both from &lt;a href=&quot;#comment-17144726&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;your design doc&lt;/a&gt;&#160;and &lt;a href=&quot;#comment-17162168&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;my proposal above&lt;/a&gt;,&lt;br/&gt;
in that it doesn&apos;t have CheckpointCleaner and it doesn&apos;t trigger checkpoint request upon discard completion.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17170643" author="echauchot" created="Tue, 4 Aug 2020 08:09:59 +0000"  >&lt;p&gt;Hi Roman, thanks for your feedback. Yes indeed it diverges in some points because while coding I figured out better responsibilities, coupling etc... The reasons are explained in the comments in the doc. Please take a look at them and tell me what you think.&lt;/p&gt;</comment>
                            <comment id="17170657" author="roman_khachatryan" created="Tue, 4 Aug 2020 08:49:39 +0000"  >&lt;p&gt;Hi Etienne,&#160;&lt;/p&gt;

&lt;p&gt;You&apos;re right,&#160;I missed option 3.b in your design, which I think is implemented in the PR.&lt;/p&gt;

&lt;p&gt;However, I&apos;m not sure that we can use it. I&apos;ve commented in the design doc, please take a look.&lt;/p&gt;</comment>
                            <comment id="17175585" author="echauchot" created="Tue, 11 Aug 2020 13:55:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/ifndef-SleePy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;@ifndef-SleePy&lt;/a&gt;&#160;&lt;a href=&quot;https://github.com/rkhachatryan&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;@rkhachatryan&lt;/a&gt;&#160;I applied all your comments of the design doc to the PR PTAL&lt;/p&gt;</comment>
                            <comment id="17177057" author="echauchot" created="Thu, 13 Aug 2020 14:31:24 +0000"  >&lt;p&gt;Hi all,&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ll be off for 2 weeks starting tonight, so I&apos;ll need to wait until my return to tackle these subjects.&lt;/p&gt;</comment>
                            <comment id="17197538" author="echauchot" created="Thu, 17 Sep 2020 09:09:24 +0000"  >&lt;p&gt;Hi, I addressed all the comments in the PR and added an integration test. Is someone available for finishing review/merging while Roman is on vacation ?&lt;/p&gt;</comment>
                            <comment id="17197547" author="pnowojski" created="Thu, 17 Sep 2020 09:17:05 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=echauchot&quot; class=&quot;user-hover&quot; rel=&quot;echauchot&quot;&gt;echauchot&lt;/a&gt;, &lt;a href=&quot;https://twitter.com/schneems/status/1191844272682786822&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sorry for the delay&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; should be back on Monday, can we postpone the review until then? I think it would be the most efficient to wait for him to finish this off. I can ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; to take a look at it as soon as he is back online.&lt;/p&gt;</comment>
                            <comment id="17197658" author="echauchot" created="Thu, 17 Sep 2020 12:41:27 +0000"  >&lt;p&gt;Ah, sure !&#160; I did not notice, he&apos;ll be back that soon.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="17213953" author="pnowojski" created="Wed, 14 Oct 2020 14:27:58 +0000"  >&lt;p&gt;Merged to master as 81c7fa6f90..318c7b6659&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13352479">FLINK-20992</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13301342">FLINK-17421</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13306403">FLINK-17860</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13299513">FLINK-17248</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dgq8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>