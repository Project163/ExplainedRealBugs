<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:45:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-16581] Support state ttl for Mini-Batch deduplication using StateTtlConfig</title>
                <link>https://issues.apache.org/jira/browse/FLINK-16581</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;This lead to OOM with long running streaming job.&lt;/p&gt;

&lt;p&gt;We should check all unbounded operations, should not lack state TTL&lt;/p&gt;</description>
                <environment></environment>
        <key id="13291489">FLINK-16581</key>
            <summary>Support state ttl for Mini-Batch deduplication using StateTtlConfig</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lsy">dalongliu</assignee>
                                    <reporter username="lzljs3620320">Jingsong Lee</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 13 Mar 2020 05:45:26 +0000</created>
                <updated>Mon, 20 Apr 2020 16:16:28 +0000</updated>
                            <resolved>Fri, 17 Apr 2020 06:27:04 +0000</resolved>
                                    <version>1.9.2</version>
                    <version>1.10.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="17058437" author="lzljs3620320" created="Fri, 13 Mar 2020 05:45:55 +0000"  >&lt;p&gt;CC: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17058446" author="lsy" created="Fri, 13 Mar 2020 06:04:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;&#160;I want to fix this bug&lt;/p&gt;</comment>
                            <comment id="17058448" author="lzljs3620320" created="Fri, 13 Mar 2020 06:08:45 +0000"  >&lt;p&gt;Assigned to you. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lsy&quot; class=&quot;user-hover&quot; rel=&quot;lsy&quot;&gt;lsy&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17064864" author="jark" created="Mon, 23 Mar 2020 15:07:56 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lsy&quot; class=&quot;user-hover&quot; rel=&quot;lsy&quot;&gt;lsy&lt;/a&gt;, thanks for the contribution. I glanced the pull request you submitted. But I would like to discuss the approach here. &lt;/p&gt;

&lt;p&gt;Currently, there are 2 ways to cleanup states. &lt;/p&gt;

&lt;p&gt;1) registering a processing-time timer, and cleanup entries when the timer is callback.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;pros: can cleanup multiple states at the same time (state consistent)&lt;/li&gt;
	&lt;li&gt;cons: timer space depends on the key size, which may lead to OOM (heap timer).&lt;/li&gt;
	&lt;li&gt;used in Group Aggregation, Over Aggregateion, TopN&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;2) using the &lt;tt&gt;StateTtlConfig&lt;/tt&gt; provided by DataStream &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;pros: decouple the logic of state ttl with the record processing, easy to program (take a look at old planner NonWindowJoin which bundles ttl timestamp with records in MapState).&lt;/li&gt;
	&lt;li&gt;cons: can&apos;t cleanup multiple states at the same time.&lt;/li&gt;
	&lt;li&gt;useed in Sream-Stream Joins.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Personally, I perfer using &lt;tt&gt;StateTtlConfig&lt;/tt&gt; which leverage the ability of DataStream and not inventing the same thing. Besides, it can help to improve the readability of codes (reduce bugs). What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lsy&quot; class=&quot;user-hover&quot; rel=&quot;lsy&quot;&gt;lsy&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;: &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-master/dev/stream/state/state.html#state-time-to-live-ttl&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-master/dev/stream/state/state.html#state-time-to-live-ttl&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="17065254" author="lzljs3620320" created="Tue, 24 Mar 2020 02:20:58 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;, although&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Look at &lt;tt&gt;KeyedProcessFunctionWithCleanupState&lt;/tt&gt; , we already have many operators that use&#160;processing-time timer to cleanup state.&lt;/li&gt;
	&lt;li&gt;Now default timer is rocksDb? In&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15637&quot; title=&quot;For RocksDBStateBackend, make RocksDB the default store for timers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15637&quot;&gt;&lt;del&gt;FLINK-15637&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I prefer using&#160;StateTtlConfig too, It should be unified to DataStream. But why we not use it in 1.9?&#160;Can you explain more about &quot;can&apos;t cleanup multiple states at the same time.&quot;?&lt;/p&gt;</comment>
                            <comment id="17065782" author="jark" created="Tue, 24 Mar 2020 13:48:55 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;, that&apos;s true there is a lot of operators using timers. That&apos;s because &lt;tt&gt;StateTtlConfig&lt;/tt&gt; is introduced in recent releases and we don&apos;t have much time to refactor the existing operators. The reason why we use  &lt;tt&gt;StateTtlConfig&lt;/tt&gt; is because it simplify the implementatiion A LOT. &lt;/p&gt;

&lt;p&gt;&amp;gt; can&apos;t cleanup multiple states at the same time&lt;br/&gt;
For example, in COUNT DISTINCT, there are 2 states, the &lt;tt&gt;MapState&lt;/tt&gt; stores all distinct values, the &lt;tt&gt;count&lt;/tt&gt; store the size of the MapState. If we use &lt;tt&gt;StateTtlConfig&lt;/tt&gt;, some entries of MapState may be retired, but &lt;tt&gt;count&lt;/tt&gt; is not. If a retired value comes in, the &lt;tt&gt;count&lt;/tt&gt; value gets larger by mistake. If we use timer, MapState and count will be reset together. &lt;br/&gt;
But I think that&apos;s not a big problem, because the result is anyway not correct once ttl happens. &lt;/p&gt;

&lt;p&gt;in &lt;tt&gt;RetractableTopNFunction&lt;/tt&gt;, there will be multiple states, the &lt;tt&gt;dataState&lt;/tt&gt; which stores all input data, the &lt;tt&gt;treeMap&lt;/tt&gt; stores the TopN element in order. &lt;/p&gt;</comment>
                            <comment id="17066322" author="lzljs3620320" created="Wed, 25 Mar 2020 02:22:48 +0000"  >&lt;p&gt;I got your concern, but I think this is not a big problem too. We can use&#160;StateTtlConfig.&lt;/p&gt;</comment>
                            <comment id="17066429" author="lsy" created="Wed, 25 Mar 2020 06:32:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&#160;I agree with you, use StateTtlConfig can simplify the implementation a lot, thanks for your guidance, I will modify the code.&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;can&apos;t cleanup multiple states at the same time&lt;/p&gt;

&lt;p&gt;For this problem, I think user should discard the expired data in SQL, otherwise, the result will be affected!&lt;/p&gt;</comment>
                            <comment id="17075831" author="jark" created="Sun, 5 Apr 2020 13:05:57 +0000"  >&lt;p&gt;I removed fix versions for 1.9 and 1.10, because it is a new feature and breaks the state compatibility. &lt;/p&gt;</comment>
                            <comment id="17085470" author="jark" created="Fri, 17 Apr 2020 06:27:04 +0000"  >&lt;p&gt;Resolved in master (1.11.0): 3f6080f4e9bdeb564c32a1bbbd5f577b0fbfe873&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="13295867">FLINK-16949</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0chq0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>