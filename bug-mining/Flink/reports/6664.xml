<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:13:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-28975] withIdleness marks all streams from FLIP-27 sources as idle</title>
                <link>https://issues.apache.org/jira/browse/FLINK-28975</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Using withIdleness with a FLIP-27 source leads to all of the streams from the source being marked idle, which in turn leads to incorrect results, e.g., from joins that rely on watermarks.&lt;/p&gt;

&lt;p&gt;Quoting from the user ML thread:&lt;/p&gt;

&lt;p&gt;In&#160;org.apache.flink.streaming.api.operators.SourceOperator, there are separate instances of&#160;WatermarksWithIdleness created for each split output and the main output. There is multiplexing of watermarks between split outputs but no multiplexing between split output and main output.&lt;br/&gt;
&#160;&lt;br/&gt;
For a source such as&#160;org.apache.flink.connector.kafka.source.KafkaSource,&#160;&lt;font color=&quot;#353833&quot;&gt;there is only output from splits and no output from main. Hence the main output will (after an initial timeout) be marked as idle.&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#353833&quot;&gt;&#160;&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#353833&quot;&gt;The implementation of&#160;&lt;/font&gt;WatermarksWithIdleness is such that once an output is idle, it will periodically re-mark the output as idle. Since there is no multiplexing between split outputs and main output, the idle marks coming from main output will repeatedly set the output to idle even though there are events from the splits. Result is that the entire source is repeatedly marked as idle.&lt;/p&gt;


&lt;p&gt;See this ML thread for more details: &lt;a href=&quot;https://lists.apache.org/thread/bbokccohs16tzkdtybqtv1vx76gqkqj4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread/bbokccohs16tzkdtybqtv1vx76gqkqj4&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This probably affects older versions of Flink as well, but that needs to be verified.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13476849">FLINK-28975</key>
            <summary>withIdleness marks all streams from FLIP-27 sources as idle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="renqs">Qingsheng Ren</assignee>
                                    <reporter username="danderson">David Anderson</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 15 Aug 2022 14:35:56 +0000</created>
                <updated>Tue, 1 Apr 2025 06:27:58 +0000</updated>
                            <resolved>Tue, 27 Sep 2022 11:20:26 +0000</resolved>
                                    <version>1.15.1</version>
                                    <fixVersion>1.16.0</fixVersion>
                    <fixVersion>1.15.3</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17580117" author="godfreyhe" created="Tue, 16 Aug 2022 07:47:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt; could you have a look ?&lt;/p&gt;</comment>
                            <comment id="17597833" author="pnowojski" created="Tue, 30 Aug 2022 12:12:11 +0000"  >&lt;p&gt;Why are we re-emitting idleness periodically? &lt;/p&gt;</comment>
                            <comment id="17598286" author="renqs" created="Wed, 31 Aug 2022 09:46:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; There are two outputs in the source: per-split output and main output, and each of them has a copy of &lt;tt&gt;WatermarkGenerator&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/c0f080762e7a1c1763942fed2e34420164a04bf3/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/source/ProgressiveTimestampsAndWatermarks.java#L102-L120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/c0f080762e7a1c1763942fed2e34420164a04bf3/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/source/ProgressiveTimestampsAndWatermarks.java#L102-L120&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;WatermarksWithIdleness&lt;/tt&gt; (which is an impl of &lt;tt&gt;WatermarkGenerator&lt;/tt&gt;) periodically checks if there&apos;s any invocations of &lt;tt&gt;onEvent&lt;/tt&gt;, and mark the watermark output as idle if the &lt;tt&gt;onEvent&lt;/tt&gt; is never called with in the idleness timeout. For the source only uses per-split output instead of main output (like KafkaSource), the &lt;tt&gt;WatermarksWithIdleness&lt;/tt&gt; on the main output is never touched so it keeps marking the watermark output as idle in &lt;tt&gt;onPeriodicEmit&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure adding the main output to the watermark multiplexer in per-split output is a correct way to fix. From the current logic of &lt;tt&gt;ProgressiveTimestampsAndWatermarks&lt;/tt&gt; the watermark from the main output should be directly sent to downstream instead of calculating min with watermarks from per-split output.&lt;/p&gt;

&lt;p&gt;A possible solution in my mind is like we add another layer on WatermarkOutput of source that only mark idle if both main and per-split output are idle. WDYT?&lt;/p&gt;</comment>
                            <comment id="17598346" author="pnowojski" created="Wed, 31 Aug 2022 12:05:33 +0000"  >&lt;p&gt;Thanks for the explanation&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;WatermarksWithIdleness (which is an impl of WatermarkGenerator) periodically checks if there&apos;s any invocations of onEvent, and mark the watermark output as idle if the onEvent is never called with in the idleness timeout.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Wouldn&apos;t it be more correct to not call &lt;tt&gt;output.markIdle();&lt;/tt&gt; if previous &lt;tt&gt;onPeriodicEmit&lt;/tt&gt; call has already called (i.e &lt;tt&gt;idlenessTimer.checkIfIdle()&lt;/tt&gt; returned true in the previous call)?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A possible solution in my mind is like we add another layer on WatermarkOutput of source that only mark idle if both main and per-split output are idle. WDYT?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think that sounds about right.&lt;/p&gt;
</comment>
                            <comment id="17603314" author="renqs" created="Tue, 13 Sep 2022 03:24:28 +0000"  >&lt;p&gt;Fixed on master: d62df6899a1d7bd92ae998d3b610aa8b4de64505&lt;/p&gt;

&lt;p&gt;release-1.16: a5be641a9a95de631dc697f3d2906e46cb126ee5&lt;/p&gt;

&lt;p&gt;release-1.15: 2a99acde6cd9508da702474b69e3812805d17615&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13477801">FLINK-29048</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17rgo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>