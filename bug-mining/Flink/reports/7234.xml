<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:18:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-32953] [State TTL]resolve data correctness problem after ttl was changed </title>
                <link>https://issues.apache.org/jira/browse/FLINK-32953</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Because expired data is cleaned up in background on a best effort basis (hashmap use INCREMENTAL_CLEANUP strategy, rocksdb use ROCKSDB_COMPACTION_FILTER strategy), some expired state is often persisted into snapshots.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In some scenarios, user changes the state ttl of the job and then restore job from the old state.&#160;If the user adjust the state ttl from a short value to a long value (eg, from 12 hours to 24 hours), &#160;some expired data that was not cleaned up will be alive after restore.&#160;Obviously this is unreasonable, and may break data regulatory requirements.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Particularly, rocksdb stateBackend may cause data correctness problems due to level compaction in this case.(eg. One key has two versions at level-1 and level-2&#65292;both of which are ttl expired. Then level-1 version is cleaned up by compaction, &#160;and level-2 version isn&apos;t. &#160;If we adjust state ttl and restart job, the incorrect data of level-2 will become valid after restore)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To solve this problem, I think we can&lt;br/&gt;
1) persist old state ttl into snapshot meta info; (eg. RegisteredKeyValueStateBackendMetaInfo or others)&lt;br/&gt;
2) During state restore, check the size between the current ttl and old ttl;&lt;br/&gt;
3) If current ttl is longer than old ttl, we need to iterate over all data, filter out expired data with old ttl, and wirte valid data into stateBackend.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13548517">FLINK-32953</key>
            <summary>[State TTL]resolve data correctness problem after ttl was changed </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="lijinzhong">Jinzhong Li</assignee>
                                    <reporter username="lijinzhong">Jinzhong Li</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 24 Aug 2023 12:52:40 +0000</created>
                <updated>Wed, 13 Mar 2024 04:39:12 +0000</updated>
                                                                            <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17758820" author="masteryhx" created="Fri, 25 Aug 2023 03:48:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lijinzhong&quot; class=&quot;user-hover&quot; rel=&quot;lijinzhong&quot;&gt;lijinzhong&lt;/a&gt; Thanks for reporting this, this makes sense to me.&lt;/p&gt;

&lt;p&gt;It could work by reusing the logic of state migration.&lt;/p&gt;

&lt;p&gt;BTW, We could go a step further, I think we could also support the compatibility between enabling TTL and disabling TTL using similar logic, this will be useful for users.&lt;/p&gt;</comment>
                            <comment id="17758823" author="lijinzhong" created="Fri, 25 Aug 2023 04:10:19 +0000"  >&lt;p&gt;Thanks for your reply and advice. &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masteryhx&quot; class=&quot;user-hover&quot; rel=&quot;masteryhx&quot;&gt;masteryhx&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I also think it meaningful to support state compatibility between enabling TTL and disabling TTL.&lt;/p&gt;

&lt;p&gt;I will create another ticket to track this work.&lt;/p&gt;</comment>
                            <comment id="17759465" author="masteryhx" created="Mon, 28 Aug 2023 06:21:58 +0000"  >&lt;p&gt;Thanks. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lijinzhong&quot; class=&quot;user-hover&quot; rel=&quot;lijinzhong&quot;&gt;lijinzhong&lt;/a&gt;&#160;&lt;br/&gt;
Would you like to fix this ? I could assign to you if you&apos;d like.&lt;/p&gt;</comment>
                            <comment id="17759485" author="lijinzhong" created="Mon, 28 Aug 2023 07:58:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masteryhx&quot; class=&quot;user-hover&quot; rel=&quot;masteryhx&quot;&gt;masteryhx&lt;/a&gt;&#160; Yes, I want to do this work. Thanks.&lt;/p&gt;</comment>
                            <comment id="17764016" author="lijinzhong" created="Tue, 12 Sep 2023 05:37:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masteryhx&quot; class=&quot;user-hover&quot; rel=&quot;masteryhx&quot;&gt;masteryhx&lt;/a&gt; &#160;Currently, the stateBackend layer (HeapStateBackend/RocksDBStateBackend) doesn&apos;t contain information about state-ttl. &#160;To solve this problem, i think we have to pass a ttl-state restore transformer from TtlStateFactory to StateBackend which is like &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/state/StateSnapshotTransformer.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;StateSnapshotTransformer&lt;/a&gt;.&#160;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And this requires changing the interface KeyedStateFactory#createOrUpdateInternalState (see my &lt;a href=&quot;https://github.com/ljz2051/flink/commit/7a058fd0f9d34a8fb42254a7ca1d6f32419c69e1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;draft commit&lt;/a&gt; )&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think that fixing this corner case but changing the general interface of stateBackend layer may not be worthwhile. But at least&#65292;i think we should alert users to this situation in the documentation.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;WDYT? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masteryhx&quot; class=&quot;user-hover&quot; rel=&quot;masteryhx&quot;&gt;masteryhx&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17764041" author="masteryhx" created="Tue, 12 Sep 2023 07:15:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lijinzhong&quot; class=&quot;user-hover&quot; rel=&quot;lijinzhong&quot;&gt;lijinzhong&lt;/a&gt; Thanks for the effort.&lt;/p&gt;

&lt;p&gt;As disscussed offline, I think it&apos;s fine we resolve this by adding alert infos in the documentation firstly.&lt;/p&gt;

&lt;p&gt;We could continute to dive into this problem when we have more feedback from users or other developers.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17764518" author="lijinzhong" created="Wed, 13 Sep 2023 07:09:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masteryhx&quot; class=&quot;user-hover&quot; rel=&quot;masteryhx&quot;&gt;masteryhx&lt;/a&gt; &#160;I publish a pr which add some notes about this issue in document. Could you please help review the pr?&lt;/p&gt;</comment>
                            <comment id="17765422" author="masteryhx" created="Fri, 15 Sep 2023 02:23:07 +0000"  >&lt;p&gt;merged 9a891f117c3a44a633316b84f9cbf2a541b80d11 into master&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jzls:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>