<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:39:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10455] Potential Kafka producer leak in case of failures</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10455</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;If the Kafka brokers&apos; timeout is too low for our checkpoint interval &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, we may get an &lt;tt&gt;ProducerFencedException&lt;/tt&gt;. Documentation around &lt;tt&gt;ProducerFencedException&lt;/tt&gt; explicitly states that we should close the producer after encountering it.&lt;/p&gt;

&lt;p&gt;By looking at the code, it doesn&apos;t seem like this is actually done in &lt;tt&gt;FlinkKafkaProducer011&lt;/tt&gt;. Also, in case one transaction&apos;s commit in &lt;tt&gt;TwoPhaseCommitSinkFunction#notifyCheckpointComplete&lt;/tt&gt; fails with an exception, we don&apos;t clean up (nor try to commit) any other transaction.&lt;br/&gt;
-&amp;gt; from what I see, &lt;tt&gt;TwoPhaseCommitSinkFunction#notifyCheckpointComplete&lt;/tt&gt; simply iterates over the &lt;tt&gt;pendingCommitTransactions&lt;/tt&gt; which is not touched during &lt;tt&gt;close()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Now if we restart the failing job on the same Flink cluster, any resources from the previous attempt will still linger around.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-release-1.5/dev/connectors/kafka.html#kafka-011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-release-1.5/dev/connectors/kafka.html#kafka-011&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13187957">FLINK-10455</key>
            <summary>Potential Kafka producer leak in case of failures</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="becket_qin">Jiangjie Qin</assignee>
                                    <reporter username="nkruber">Nico Kruber</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 27 Sep 2018 15:51:31 +0000</created>
                <updated>Wed, 12 Jun 2019 09:27:14 +0000</updated>
                            <resolved>Wed, 12 Jun 2019 09:27:14 +0000</resolved>
                                    <version>1.5.2</version>
                                    <fixVersion>1.5.6</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                    <fixVersion>1.7.3</fixVersion>
                    <fixVersion>1.8.1</fixVersion>
                    <fixVersion>1.9.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>12</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="16635519" author="nicok" created="Tue, 2 Oct 2018 13:51:37 +0000"  >&lt;p&gt;The following symptom may actually be a follow-up of this leak:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-10-02 12:17:30,077 ERROR org.apache.kafka.common.utils.KafkaThread                     - Uncaught exception in kafka-producer-network-thread | producer-26: 
java.lang.NoClassDefFoundError: org/apache/kafka/clients/NetworkClient$1
	at org.apache.kafka.clients.NetworkClient.processDisconnection(NetworkClient.java:583)
	at org.apache.kafka.clients.NetworkClient.handleDisconnections(NetworkClient.java:705)
	at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:443)
	at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:224)
	at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:162)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.ClassNotFoundException: org.apache.kafka.clients.NetworkClient$1
	at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:424)
	at org.apache.flink.runtime.execution.librarycache.FlinkUserCodeClassLoaders$ChildFirstClassLoader.loadClass(FlinkUserCodeClassLoaders.java:129)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:357)
	... 6 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;-&amp;gt; This may happen, if we do not properly clean up and something, e.g. a producer, is outliving the task it belongs to. Since we close the &lt;tt&gt;URLClassLoader&lt;/tt&gt; with the task, loading further classes then tails - see &lt;a href=&quot;https://heapanalytics.com/blog/engineering/missing-scala-class-noclassdeffounderror&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://heapanalytics.com/blog/engineering/missing-scala-class-noclassdeffounderror&lt;/a&gt; for more info on this.&lt;/p&gt;</comment>
                            <comment id="16671674" author="githubbot" created="Thu, 1 Nov 2018 14:27:27 +0000"  >&lt;p&gt;azagrebin opened a new pull request #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This PR addresses the problem of potential leak of resources associated with unclosed Kafka transactional producers in case of commitment failure or task shutdown.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;always close producer even if commit fails in TwoPhaseCommitSinkFunction. notifyCheckpointComplete&lt;/li&gt;
	&lt;li&gt;close pending transactions in close method of Kafka Flink function in case of task shutdown&lt;/li&gt;
	&lt;li&gt;continue trying to commit other transactions in TwoPhaseCommitSinkFunction. notifyCheckpointComplete if any of them failed&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   existing tests&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16671675" author="githubbot" created="Thu, 1 Nov 2018 14:27:43 +0000"  >&lt;p&gt;azagrebin commented on issue #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#issuecomment-435057504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#issuecomment-435057504&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   cc @pnowojski @NicoK &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16671688" author="githubbot" created="Thu, 1 Nov 2018 14:47:30 +0000"  >&lt;p&gt;azagrebin commented on issue #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#issuecomment-435063729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#issuecomment-435063729&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @pnowojski &lt;br/&gt;
   Probably unrelated question:&lt;br/&gt;
   In `FlinkKafkaProducer011.recoverAndCommit`, e.g. `ProducerFencedException` is swallowed (could be transaction timeout), basically making failure impossible if `ignoreFailuresAfterTransactionTimeout` is `false` in `TwoPhaseCommitSinkFunction.recoverAndCommitInternal` which calls `FlinkKafkaProducer011.recoverAndCommit`. Is it intended?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672806" author="githubbot" created="Fri, 2 Nov 2018 09:13:15 +0000"  >&lt;p&gt;StefanRRichter commented on issue #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#issuecomment-435316786&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#issuecomment-435316786&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   The travis build shows problems that look related to the PR.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672828" author="githubbot" created="Fri, 2 Nov 2018 09:43:40 +0000"  >&lt;p&gt;azagrebin commented on issue #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#issuecomment-435324449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#issuecomment-435324449&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Yes, could be, I am looking into it.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673172" author="githubbot" created="Fri, 2 Nov 2018 14:36:05 +0000"  >&lt;p&gt;azagrebin edited a comment on issue #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#issuecomment-435324449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#issuecomment-435324449&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Yes, thanks, could be, I am looking into it.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673230" author="githubbot" created="Fri, 2 Nov 2018 15:12:55 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#discussion_r230404337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#discussion_r230404337&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -150,6 +154,13 @@ protected TXN currentTransaction() &lt;/p&gt;
{
 		return currentTransactionHolder == null ? null : currentTransactionHolder.handle;
 	}

&lt;p&gt;+	@Nonnull&lt;br/&gt;
+	protected Map&amp;lt;Long, TXN&amp;gt; pendingTransactions() {&lt;br/&gt;
+		return pendingCommitTransactions.entrySet().stream()&lt;br/&gt;
+			.map(e -&amp;gt; new AbstractMap.SimpleEntry&amp;lt;&amp;gt;(e.getKey(), e.getValue().handle))&lt;br/&gt;
+			.collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   why do you `collect` and not just return a stream?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673231" author="githubbot" created="Fri, 2 Nov 2018 15:12:55 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#discussion_r230404649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#discussion_r230404649&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -257,6 +268,7 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;/p&gt;

&lt;p&gt; 		Iterator&amp;lt;Map.Entry&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt;&amp;gt; pendingTransactionIterator = pendingCommitTransactions.entrySet().iterator();&lt;br/&gt;
 		checkState(pendingTransactionIterator.hasNext(), &quot;checkpoint completed, but no transaction pending&quot;);&lt;br/&gt;
+		Throwable lastError = null;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   change to `firstError`?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673232" author="githubbot" created="Fri, 2 Nov 2018 15:12:55 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#discussion_r230408448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#discussion_r230408448&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -671,6 +672,9 @@ public void close() throws FlinkKafka011Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 		// make sure we propagate pending errors&lt;br/&gt;
 		checkErroneous();&lt;br/&gt;
+		pendingTransactions().values().forEach(transaction -&amp;gt;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   It seems strange why order of those lines matters. It might indicate that our `internal.FlinkKafkaProducer#flushNewPartitions` method is broken, since that&apos;s where our test is deadlocking.&lt;/p&gt;

&lt;p&gt;   I briefly checked `org.apache.kafka.clients.producer.internals.TransactionManager#beginCommit` (which our `flushNewPartitions` is partially mimicking), and maybe the problem is that we are skipping `TransactionManager#maybeFailWithError` call? Could you invoke this method in our `flushNewPartitions` and see whether the deadlock is gone?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673336" author="githubbot" created="Fri, 2 Nov 2018 16:06:25 +0000"  >&lt;p&gt;pnowojski commented on issue #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#issuecomment-435429850&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#issuecomment-435429850&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Regarding your question @azagrebin, I think my bug fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8086&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-8086&lt;/a&gt;  (which added &quot;ignore ProducerFencedException&quot;) indeed might turned the @GJL&apos;s timeouts code:&lt;br/&gt;
   ```&lt;br/&gt;
   		} catch (final Exception e) {&lt;br/&gt;
   			final long elapsedTime = clock.millis() - transactionHolder.transactionStartTime;&lt;br/&gt;
   			if (ignoreFailuresAfterTransactionTimeout &amp;amp;&amp;amp; elapsedTime &amp;gt; transactionTimeout) {&lt;br/&gt;
   				LOG.error(&quot;Error while committing transaction {}. &quot; +&lt;br/&gt;
   						&quot;Transaction has been open for longer than the transaction timeout ({}).&quot; +&lt;br/&gt;
   						&quot;Commit will not be attempted again. Data loss might have occurred.&quot;,&lt;br/&gt;
   					transactionHolder.handle, transactionTimeout, e);&lt;br/&gt;
   			} else &lt;/p&gt;
{
   				throw e;
   			}
&lt;p&gt;   		}&lt;br/&gt;
   ```&lt;br/&gt;
   into a dead code at the moment. But I think my bug fix is more important (from my commit message):&lt;br/&gt;
   &amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8086&quot; title=&quot;FlinkKafkaProducer011 can permanently fail in recovery through ProducerFencedException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8086&quot;&gt;&lt;del&gt;FLINK-8086&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Ignore ProducerFencedException &lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; during recovery  ProducerFencedException can happen if we restore twice from the same checkpoint or if we restore from an old savepoint. In both cases transactional.ids that we want to recoverAndCommit have been already committed and reused. Reusing mean that they will be known by Kafka&apos;s brokers under newer producerId/epochId, which will result in ProducerFencedException if we try to commit again some old (and already committed) transaction.  &lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; Ignoring this exception might hide some bugs/issues, because instead of failing we might have a semi silent (with a warning) data loss.&lt;/p&gt;

&lt;p&gt;   I think the last sentence answers your question.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673441" author="githubbot" created="Fri, 2 Nov 2018 17:17:45 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#discussion_r230447543&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#discussion_r230447543&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -671,6 +672,9 @@ public void close() throws FlinkKafka011Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 		// make sure we propagate pending errors&lt;br/&gt;
 		checkErroneous();&lt;br/&gt;
+		pendingTransactions().values().forEach(transaction -&amp;gt;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   `TransactionManager#maybeFailWithError` contains just a check, it does not help with the deadlock so far&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685084" author="githubbot" created="Tue, 13 Nov 2018 11:52:57 +0000"  >&lt;p&gt;azagrebin commented on issue #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#issuecomment-438239819&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#issuecomment-438239819&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   cc @pnowojski &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16686224" author="githubbot" created="Wed, 14 Nov 2018 09:08:42 +0000"  >&lt;p&gt;pnowojski closed pull request #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java b/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
index c7f84c36b6a..3e7cf2b1aca 100644&lt;br/&gt;
&amp;#8212; a/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
+++ b/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
@@ -45,6 +45,7 @@&lt;br/&gt;
 import org.apache.flink.streaming.util.serialization.KeyedSerializationSchema;&lt;br/&gt;
 import org.apache.flink.streaming.util.serialization.KeyedSerializationSchemaWrapper;&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
+import org.apache.flink.util.IOUtils;&lt;br/&gt;
 import org.apache.flink.util.NetUtils;&lt;/p&gt;

&lt;p&gt; import org.apache.flink.shaded.guava18.com.google.common.collect.Lists;&lt;br/&gt;
@@ -671,6 +672,9 @@ public void close() throws FlinkKafka011Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 		// make sure we propagate pending errors&lt;br/&gt;
 		checkErroneous();&lt;br/&gt;
+		pendingTransactions().forEach(transaction -&amp;gt;&lt;br/&gt;
+			IOUtils.closeQuietly(transaction.getValue().producer)&lt;br/&gt;
+		);&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt; 	// ------------------- Logic for handling checkpoint flushing -------------------------- //&lt;br/&gt;
@@ -713,8 +717,11 @@ protected void preCommit(KafkaTransactionState transaction) throws FlinkKafka011&lt;br/&gt;
 	@Override&lt;br/&gt;
 	protected void commit(KafkaTransactionState transaction) {&lt;br/&gt;
 		if (transaction.isTransactional()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;transaction.producer.commitTransaction();&lt;/li&gt;
	&lt;li&gt;recycleTransactionalProducer(transaction.producer);&lt;br/&gt;
+			try 
{
+				transaction.producer.commitTransaction();
+			} finally {
+				recycleTransactionalProducer(transaction.producer);
+			}&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;br/&gt;
 &lt;br/&gt;
diff --git a/flink-connectors/flink-connector-kafka/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer.java b/flink-connectors/flink-connector-kafka/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer.java&lt;br/&gt;
index df1a4b5727f..10e8ef1713d 100644&lt;br/&gt;
&amp;#8212; a/flink-connectors/flink-connector-kafka/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer.java&lt;br/&gt;
+++ b/flink-connectors/flink-connector-kafka/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer.java&lt;br/&gt;
@@ -45,6 +45,7 @@&lt;br/&gt;
 import org.apache.flink.streaming.util.serialization.KeyedSerializationSchema;&lt;br/&gt;
 import org.apache.flink.streaming.util.serialization.KeyedSerializationSchemaWrapper;&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
+import org.apache.flink.util.IOUtils;&lt;br/&gt;
 import org.apache.flink.util.NetUtils;&lt;br/&gt;
 &lt;br/&gt;
 import org.apache.flink.shaded.guava18.com.google.common.collect.Lists;&lt;br/&gt;
@@ -673,6 +674,9 @@ public void close() throws FlinkKafkaException {&lt;br/&gt;
 		}&lt;br/&gt;
 		// make sure we propagate pending errors&lt;br/&gt;
 		checkErroneous();&lt;br/&gt;
+		pendingTransactions().forEach(transaction -&amp;gt;&lt;br/&gt;
+			IOUtils.closeQuietly(transaction.getValue().producer)&lt;br/&gt;
+		);&lt;br/&gt;
 	}&lt;br/&gt;
 &lt;br/&gt;
 	// ------------------- Logic for handling checkpoint flushing -------------------------- //&lt;br/&gt;
@@ -715,8 +719,11 @@ protected void preCommit(FlinkKafkaProducer.KafkaTransactionState transaction) t&lt;br/&gt;
 	@Override&lt;br/&gt;
 	protected void commit(FlinkKafkaProducer.KafkaTransactionState transaction) {&lt;br/&gt;
 		if (transaction.isTransactional()) {&lt;br/&gt;
-			transaction.producer.commitTransaction();&lt;br/&gt;
-			recycleTransactionalProducer(transaction.producer);&lt;br/&gt;
+			try {+				transaction.producer.commitTransaction();+			}
&lt;p&gt; finally &lt;/p&gt;
{
+				recycleTransactionalProducer(transaction.producer);
+			}
&lt;p&gt; 		}&lt;br/&gt;
 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
index d2735d566ee..e39335479f3 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
@@ -39,20 +39,24 @@&lt;br/&gt;
 import org.apache.flink.runtime.state.FunctionInitializationContext;&lt;br/&gt;
 import org.apache.flink.runtime.state.FunctionSnapshotContext;&lt;br/&gt;
 import org.apache.flink.streaming.api.checkpoint.CheckpointedFunction;&lt;br/&gt;
+import org.apache.flink.util.FlinkRuntimeException;&lt;/p&gt;

&lt;p&gt; import org.slf4j.Logger;&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;+import javax.annotation.Nonnull;&lt;br/&gt;
 import javax.annotation.Nullable;&lt;/p&gt;

&lt;p&gt; import java.io.IOException;&lt;br/&gt;
 import java.time.Clock;&lt;br/&gt;
+import java.util.AbstractMap;&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Iterator;&lt;br/&gt;
 import java.util.LinkedHashMap;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Optional;&lt;br/&gt;
+import java.util.stream.Stream;&lt;/p&gt;

&lt;p&gt; import static java.util.Objects.requireNonNull;&lt;br/&gt;
 import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
@@ -150,6 +154,12 @@ protected TXN currentTransaction() &lt;/p&gt;
{
 		return currentTransactionHolder == null ? null : currentTransactionHolder.handle;
 	}

&lt;p&gt;+	@Nonnull&lt;br/&gt;
+	protected Stream&amp;lt;Map.Entry&amp;lt;Long, TXN&amp;gt;&amp;gt; pendingTransactions() &lt;/p&gt;
{
+		return pendingCommitTransactions.entrySet().stream()
+			.map(e -&amp;gt; new AbstractMap.SimpleEntry&amp;lt;&amp;gt;(e.getKey(), e.getValue().handle));
+	}
&lt;p&gt;+&lt;br/&gt;
 	// ------ methods that should be implemented in child class to support two phase commit algorithm ------&lt;/p&gt;

&lt;p&gt; 	/**&lt;br/&gt;
@@ -257,6 +267,7 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;/p&gt;

&lt;p&gt; 		Iterator&amp;lt;Map.Entry&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt;&amp;gt; pendingTransactionIterator = pendingCommitTransactions.entrySet().iterator();&lt;br/&gt;
 		checkState(pendingTransactionIterator.hasNext(), &quot;checkpoint completed, but no transaction pending&quot;);&lt;br/&gt;
+		Throwable firstError = null;&lt;/p&gt;

&lt;p&gt; 		while (pendingTransactionIterator.hasNext()) {&lt;br/&gt;
 			Map.Entry&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; entry = pendingTransactionIterator.next();&lt;br/&gt;
@@ -270,12 +281,23 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;br/&gt;
 				name(), checkpointId, pendingTransaction, pendingTransactionCheckpointId);&lt;/p&gt;

&lt;p&gt; 			logWarningIfTimeoutAlmostReached(pendingTransaction);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;commit(pendingTransaction.handle);&lt;br/&gt;
+			try 
{
+				commit(pendingTransaction.handle);
+			}
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				if (firstError == null) {
+					firstError = t;
+				}+			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			LOG.debug(&quot;{} - committed checkpoint transaction {}&quot;, name(), pendingTransaction);&lt;/p&gt;

&lt;p&gt; 			pendingTransactionIterator.remove();&lt;br/&gt;
 		}&lt;br/&gt;
+&lt;br/&gt;
+		if (firstError != null) &lt;/p&gt;
{
+			throw new FlinkRuntimeException(&quot;Committing one of transactions failed, logging first encountered failure&quot;,
+				firstError);
+		}
&lt;p&gt; 	}&lt;/p&gt;

&lt;p&gt; 	@Override&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16686227" author="pnowojski" created="Wed, 14 Nov 2018 09:11:07 +0000"  >&lt;p&gt;merged commit 9f1f25d into apache:master&lt;br/&gt;
merged commit b7ba497d0d into apache:release-1.7&lt;/p&gt;</comment>
                            <comment id="16686228" author="githubbot" created="Wed, 14 Nov 2018 09:11:42 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #6989: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6989#discussion_r233363582&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6989#discussion_r233363582&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -671,6 +672,9 @@ public void close() throws FlinkKafka011Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 		// make sure we propagate pending errors&lt;br/&gt;
 		checkErroneous();&lt;br/&gt;
+		pendingTransactions().values().forEach(transaction -&amp;gt;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I created &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10876&quot; title=&quot;Deadlock if closing firstly pending transactions in FlinkKafkaProducer(011).close()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10876&quot;&gt;&lt;del&gt;FLINK-10876&lt;/del&gt;&lt;/a&gt; to look into this deadlock&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16688061" author="githubbot" created="Thu, 15 Nov 2018 13:32:48 +0000"  >&lt;p&gt;azagrebin opened a new pull request #7107: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7107&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   1.5 back port of #6989&lt;br/&gt;
   cc @pnowojski &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16688065" author="githubbot" created="Thu, 15 Nov 2018 13:33:49 +0000"  >&lt;p&gt;azagrebin opened a new pull request #7108: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7108&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   1.6 back port of #6989&lt;br/&gt;
   cc @pnowojski&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16689659" author="githubbot" created="Fri, 16 Nov 2018 16:56:21 +0000"  >&lt;p&gt;pnowojski closed pull request #7107: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7107&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java b/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
index 84973726113..fe383ad6801 100644&lt;br/&gt;
&amp;#8212; a/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
+++ b/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
@@ -45,6 +45,7 @@&lt;br/&gt;
 import org.apache.flink.streaming.util.serialization.KeyedSerializationSchema;&lt;br/&gt;
 import org.apache.flink.streaming.util.serialization.KeyedSerializationSchemaWrapper;&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
+import org.apache.flink.util.IOUtils;&lt;br/&gt;
 import org.apache.flink.util.NetUtils;&lt;/p&gt;

&lt;p&gt; import org.apache.flink.shaded.guava18.com.google.common.collect.Lists;&lt;br/&gt;
@@ -671,6 +672,9 @@ public void close() throws FlinkKafka011Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 		// make sure we propagate pending errors&lt;br/&gt;
 		checkErroneous();&lt;br/&gt;
+		pendingTransactions().forEach(transaction -&amp;gt;&lt;br/&gt;
+			IOUtils.closeQuietly(transaction.getValue().producer)&lt;br/&gt;
+		);&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt; 	// ------------------- Logic for handling checkpoint flushing -------------------------- //&lt;br/&gt;
@@ -714,8 +718,11 @@ protected void preCommit(KafkaTransactionState transaction) throws FlinkKafka011&lt;br/&gt;
 	protected void commit(KafkaTransactionState transaction) {&lt;br/&gt;
 		switch (semantic) {&lt;br/&gt;
 			case EXACTLY_ONCE:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;transaction.producer.commitTransaction();&lt;/li&gt;
	&lt;li&gt;recycleTransactionalProducer(transaction.producer);&lt;br/&gt;
+				try 
{
+					transaction.producer.commitTransaction();
+				}
&lt;p&gt; finally &lt;/p&gt;
{
+					recycleTransactionalProducer(transaction.producer);
+				}
&lt;p&gt; 				break;&lt;br/&gt;
 			case AT_LEAST_ONCE:&lt;br/&gt;
 			case NONE:&lt;br/&gt;
diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
index 2ffb6d5810e..62562623fc4 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
@@ -38,20 +38,24 @@&lt;br/&gt;
 import org.apache.flink.runtime.state.FunctionInitializationContext;&lt;br/&gt;
 import org.apache.flink.runtime.state.FunctionSnapshotContext;&lt;br/&gt;
 import org.apache.flink.streaming.api.checkpoint.CheckpointedFunction;&lt;br/&gt;
+import org.apache.flink.util.FlinkRuntimeException;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import org.slf4j.Logger;&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;+import javax.annotation.Nonnull;&lt;br/&gt;
 import javax.annotation.Nullable;&lt;/p&gt;

&lt;p&gt; import java.io.IOException;&lt;br/&gt;
 import java.time.Clock;&lt;br/&gt;
+import java.util.AbstractMap;&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Iterator;&lt;br/&gt;
 import java.util.LinkedHashMap;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Optional;&lt;br/&gt;
+import java.util.stream.Stream;&lt;/p&gt;

&lt;p&gt; import static java.util.Objects.requireNonNull;&lt;br/&gt;
 import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
@@ -149,6 +153,12 @@ protected TXN currentTransaction() &lt;/p&gt;
{
 		return currentTransactionHolder == null ? null : currentTransactionHolder.handle;
 	}

&lt;p&gt;+	@Nonnull&lt;br/&gt;
+	protected Stream&amp;lt;Map.Entry&amp;lt;Long, TXN&amp;gt;&amp;gt; pendingTransactions() &lt;/p&gt;
{
+		return pendingCommitTransactions.entrySet().stream()
+			.map(e -&amp;gt; new AbstractMap.SimpleEntry&amp;lt;&amp;gt;(e.getKey(), e.getValue().handle));
+	}
&lt;p&gt;+&lt;br/&gt;
 	// ------ methods that should be implemented in child class to support two phase commit algorithm ------&lt;/p&gt;

&lt;p&gt; 	/**&lt;br/&gt;
@@ -256,6 +266,7 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;/p&gt;

&lt;p&gt; 		Iterator&amp;lt;Map.Entry&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt;&amp;gt; pendingTransactionIterator = pendingCommitTransactions.entrySet().iterator();&lt;br/&gt;
 		checkState(pendingTransactionIterator.hasNext(), &quot;checkpoint completed, but no transaction pending&quot;);&lt;br/&gt;
+		Throwable firstError = null;&lt;/p&gt;

&lt;p&gt; 		while (pendingTransactionIterator.hasNext()) {&lt;br/&gt;
 			Map.Entry&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; entry = pendingTransactionIterator.next();&lt;br/&gt;
@@ -269,12 +280,23 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;br/&gt;
 				name(), checkpointId, pendingTransaction, pendingTransactionCheckpointId);&lt;/p&gt;

&lt;p&gt; 			logWarningIfTimeoutAlmostReached(pendingTransaction);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;commit(pendingTransaction.handle);&lt;br/&gt;
+			try 
{
+				commit(pendingTransaction.handle);
+			}
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				if (firstError == null) {
+					firstError = t;
+				}+			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			LOG.debug(&quot;{} - committed checkpoint transaction {}&quot;, name(), pendingTransaction);&lt;/p&gt;

&lt;p&gt; 			pendingTransactionIterator.remove();&lt;br/&gt;
 		}&lt;br/&gt;
+&lt;br/&gt;
+		if (firstError != null) &lt;/p&gt;
{
+			throw new FlinkRuntimeException(&quot;Committing one of transactions failed, logging first encountered failure&quot;,
+				firstError);
+		}
&lt;p&gt; 	}&lt;/p&gt;

&lt;p&gt; 	@Override&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16689662" author="githubbot" created="Fri, 16 Nov 2018 16:57:45 +0000"  >&lt;p&gt;pnowojski closed pull request #7108: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7108&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java b/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
index adecab16d8c..d332cd0ca6a 100644&lt;br/&gt;
&amp;#8212; a/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
+++ b/flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java&lt;br/&gt;
@@ -45,6 +45,7 @@&lt;br/&gt;
 import org.apache.flink.streaming.util.serialization.KeyedSerializationSchema;&lt;br/&gt;
 import org.apache.flink.streaming.util.serialization.KeyedSerializationSchemaWrapper;&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
+import org.apache.flink.util.IOUtils;&lt;br/&gt;
 import org.apache.flink.util.NetUtils;&lt;/p&gt;

&lt;p&gt; import org.apache.flink.shaded.guava18.com.google.common.collect.Lists;&lt;br/&gt;
@@ -671,6 +672,9 @@ public void close() throws FlinkKafka011Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 		// make sure we propagate pending errors&lt;br/&gt;
 		checkErroneous();&lt;br/&gt;
+		pendingTransactions().forEach(transaction -&amp;gt;&lt;br/&gt;
+			IOUtils.closeQuietly(transaction.getValue().producer)&lt;br/&gt;
+		);&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt; 	// ------------------- Logic for handling checkpoint flushing -------------------------- //&lt;br/&gt;
@@ -713,8 +717,11 @@ protected void preCommit(KafkaTransactionState transaction) throws FlinkKafka011&lt;br/&gt;
 	@Override&lt;br/&gt;
 	protected void commit(KafkaTransactionState transaction) {&lt;br/&gt;
 		if (transaction.isTransactional()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;transaction.producer.commitTransaction();&lt;/li&gt;
	&lt;li&gt;recycleTransactionalProducer(transaction.producer);&lt;br/&gt;
+			try 
{
+				transaction.producer.commitTransaction();
+			}
&lt;p&gt; finally &lt;/p&gt;
{
+				recycleTransactionalProducer(transaction.producer);
+			}
&lt;p&gt; 		}&lt;br/&gt;
 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
index 8398aa8cdbf..f2725242b2c 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
@@ -38,20 +38,24 @@&lt;br/&gt;
 import org.apache.flink.runtime.state.FunctionInitializationContext;&lt;br/&gt;
 import org.apache.flink.runtime.state.FunctionSnapshotContext;&lt;br/&gt;
 import org.apache.flink.streaming.api.checkpoint.CheckpointedFunction;&lt;br/&gt;
+import org.apache.flink.util.FlinkRuntimeException;&lt;/p&gt;

&lt;p&gt; import org.slf4j.Logger;&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;+import javax.annotation.Nonnull;&lt;br/&gt;
 import javax.annotation.Nullable;&lt;/p&gt;

&lt;p&gt; import java.io.IOException;&lt;br/&gt;
 import java.time.Clock;&lt;br/&gt;
+import java.util.AbstractMap;&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Iterator;&lt;br/&gt;
 import java.util.LinkedHashMap;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Optional;&lt;br/&gt;
+import java.util.stream.Stream;&lt;/p&gt;

&lt;p&gt; import static java.util.Objects.requireNonNull;&lt;br/&gt;
 import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
@@ -149,6 +153,12 @@ protected TXN currentTransaction() &lt;/p&gt;
{
 		return currentTransactionHolder == null ? null : currentTransactionHolder.handle;
 	}

&lt;p&gt;+	@Nonnull&lt;br/&gt;
+	protected Stream&amp;lt;Map.Entry&amp;lt;Long, TXN&amp;gt;&amp;gt; pendingTransactions() &lt;/p&gt;
{
+		return pendingCommitTransactions.entrySet().stream()
+			.map(e -&amp;gt; new AbstractMap.SimpleEntry&amp;lt;&amp;gt;(e.getKey(), e.getValue().handle));
+	}
&lt;p&gt;+&lt;br/&gt;
 	// ------ methods that should be implemented in child class to support two phase commit algorithm ------&lt;/p&gt;

&lt;p&gt; 	/**&lt;br/&gt;
@@ -256,6 +266,7 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;/p&gt;

&lt;p&gt; 		Iterator&amp;lt;Map.Entry&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt;&amp;gt; pendingTransactionIterator = pendingCommitTransactions.entrySet().iterator();&lt;br/&gt;
 		checkState(pendingTransactionIterator.hasNext(), &quot;checkpoint completed, but no transaction pending&quot;);&lt;br/&gt;
+		Throwable firstError = null;&lt;/p&gt;

&lt;p&gt; 		while (pendingTransactionIterator.hasNext()) {&lt;br/&gt;
 			Map.Entry&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; entry = pendingTransactionIterator.next();&lt;br/&gt;
@@ -269,12 +280,23 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;br/&gt;
 				name(), checkpointId, pendingTransaction, pendingTransactionCheckpointId);&lt;/p&gt;

&lt;p&gt; 			logWarningIfTimeoutAlmostReached(pendingTransaction);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;commit(pendingTransaction.handle);&lt;br/&gt;
+			try 
{
+				commit(pendingTransaction.handle);
+			}
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				if (firstError == null) {
+					firstError = t;
+				}+			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			LOG.debug(&quot;{} - committed checkpoint transaction {}&quot;, name(), pendingTransaction);&lt;/p&gt;

&lt;p&gt; 			pendingTransactionIterator.remove();&lt;br/&gt;
 		}&lt;br/&gt;
+&lt;br/&gt;
+		if (firstError != null) &lt;/p&gt;
{
+			throw new FlinkRuntimeException(&quot;Committing one of transactions failed, logging first encountered failure&quot;,
+				firstError);
+		}
&lt;p&gt; 	}&lt;/p&gt;

&lt;p&gt; 	@Override&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16689663" author="pnowojski" created="Fri, 16 Nov 2018 16:57:54 +0000"  >&lt;p&gt;merged commit e493d83 into apache:release-1.5&lt;br/&gt;
merged commit 489be82 into apache:release-1.6&lt;/p&gt;</comment>
                            <comment id="16689664" author="githubbot" created="Fri, 16 Nov 2018 16:58:19 +0000"  >&lt;p&gt;pnowojski commented on issue #7107: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7107#issuecomment-439457778&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7107#issuecomment-439457778&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks @azagrebin, merged&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16689665" author="githubbot" created="Fri, 16 Nov 2018 16:58:34 +0000"  >&lt;p&gt;pnowojski commented on issue #7108: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10455&quot; title=&quot;Potential Kafka producer leak in case of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10455&quot;&gt;&lt;del&gt;FLINK-10455&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Tx&amp;#93;&lt;/span&gt; Close transactional producers in case of failure and termination&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7108#issuecomment-439457861&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7108#issuecomment-439457861&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks @azagrebin merged&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16835667" author="till.rohrmann" created="Wed, 8 May 2019 15:07:52 +0000"  >&lt;p&gt;A user reported on the ML that he is seeing a &lt;tt&gt;ClassNotFoundException&lt;/tt&gt; similar to what Nico reported: &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Class-loader-premature-closure-NoClassDefFoundError-org-apache-kafka-clients-NetworkClient-td27734.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Class-loader-premature-closure-NoClassDefFoundError-org-apache-kafka-clients-NetworkClient-td27734.html&lt;/a&gt;. I&apos;m suspecting that we still have a Kafka producer leak somewhere.&lt;/p&gt;</comment>
                            <comment id="16835749" author="cslotterback" created="Wed, 8 May 2019 16:49:10 +0000"  >&lt;p&gt;The way I was able to reproduce this was forcing the job into a failed state by timing out writing a checkpoint on the filesystem. We occasionally see latency spikes in our env resulting in these job restarts. Most of the jobs are able to recover fine, but when using exactly once for the kafka producer the job gets stuck in this loop. My assumption is any job failure will reach the client processDisconnect method after the class loader is gone.&lt;/p&gt;</comment>
                            <comment id="16850556" author="sunjincheng121" created="Wed, 29 May 2019 06:55:34 +0000"  >&lt;p&gt;What is the current situation of this JIRA, is there anyone else to follow up? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cslotterback&quot; class=&quot;user-hover&quot; rel=&quot;cslotterback&quot;&gt;cslotterback&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;&#160; Do&#160;you want to continue to solve this problem?&lt;/p&gt;

&lt;p&gt;Since this is a blocker issue for release 1.8.1, we&apos;re expecting a quick response here.&lt;/p&gt;


&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="16850803" author="azagrebin" created="Wed, 29 May 2019 12:20:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunjincheng121&quot; class=&quot;user-hover&quot; rel=&quot;sunjincheng121&quot;&gt;sunjincheng121&lt;/a&gt;&#160;Thanks for asking! Unfortunately, I&#160;do not have time to work on this at the moment so I un-assign myself.&lt;/p&gt;</comment>
                            <comment id="16851414" author="sunjincheng121" created="Thu, 30 May 2019 00:11:49 +0000"  >&lt;p&gt;Thanks for the quick reply &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;! and that make sense to me! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16851427" author="cslotterback" created="Thu, 30 May 2019 00:28:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunjincheng121&quot; class=&quot;user-hover&quot; rel=&quot;sunjincheng121&quot;&gt;sunjincheng121&lt;/a&gt; I think it should be solved, as it blocks exactly once production for any recovery scenarios. I don&apos;t have any flink commit experience or time right now, but I would be able to work with whoever does, or I can revisit in a couple of weeks and take a stab at fixing it myself.&lt;/p&gt;</comment>
                            <comment id="16851754" author="becket_qin" created="Thu, 30 May 2019 11:28:23 +0000"  >&lt;p&gt;It looks that some further investigation is needed here. I can take the ticket if no one else has already started working on this.&lt;/p&gt;</comment>
                            <comment id="16852563" author="sunjincheng121" created="Fri, 31 May 2019 01:45:23 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;, I am very glad that you are willing to help with this issue. I have already assigned this ticket to you &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;, thanks!&lt;/p&gt;</comment>
                            <comment id="16852565" author="sunjincheng121" created="Fri, 31 May 2019 01:53:19 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cslotterback&quot; class=&quot;user-hover&quot; rel=&quot;cslotterback&quot;&gt;cslotterback&lt;/a&gt; thanks for your reply. and do not worry about the experience of flink commit, everyone is from scratch. And &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; as the PMC of Kafka, so he has more&#160;experience about Kafka. I assigned the ticket to him, but I think you can share your thought here, and work with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; and&#160;all contributors who care about this JIRA.&#160;We can grow and progress together, what do you think? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16855241" author="sunjincheng121" created="Tue, 4 Jun 2019 02:28:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; is there any update from your side?&lt;/p&gt;</comment>
                            <comment id="16855384" author="sunjincheng121" created="Tue, 4 Jun 2019 06:28:55 +0000"  >&lt;p&gt;Currently, we have added an exception capture for the `FlinkKafkaProducer011#commit` method to ensure that the `recycleTransactionalProducer` will be executed, so do we also need to add an exception capture for `FlinkKafkaProducer011#abort`?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12970784/12970784_image-2019-06-04-14-30-55-985.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16855489" author="becket_qin" created="Tue, 4 Jun 2019 09:13:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunjincheng121&quot; class=&quot;user-hover&quot; rel=&quot;sunjincheng121&quot;&gt;sunjincheng121&lt;/a&gt;&#160;Thanks for the help. I am still working on this. I&apos;m trying to get to the bottom and come to a complete solution.&lt;/p&gt;</comment>
                            <comment id="16855490" author="sunjincheng121" created="Tue, 4 Jun 2019 09:17:50 +0000"  >&lt;p&gt;Yep, sound good!&#160; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16856486" author="becket_qin" created="Wed, 5 Jun 2019 08:19:54 +0000"  >&lt;p&gt;Some updates. I think the issue here is still producer leak. The reason is that in &lt;tt&gt;FlinkKafkaProducer011.close()&lt;/tt&gt;&#160;will first check the &lt;tt&gt;asyncException&lt;/tt&gt; before it closes all the transactional producers. That may result in producer leak. And later tasks after failover will use the transactional IDs saved in the state, which are the same as the leaked producers. These task will&#160;receive ProducerFencedException and again trigger failover.&lt;/p&gt;

&lt;p&gt;I think as long as we guarantee &lt;tt&gt;FlinkKafkaProducer011.close()&lt;/tt&gt; cleans up everything, the classloader issue will be addressed. I&apos;ll submit a PR soon. We will need to add some test as well.&lt;/p&gt;</comment>
                            <comment id="16856494" author="becket_qin" created="Wed, 5 Jun 2019 08:34:51 +0000"  >&lt;p&gt;Some updates. I think the issue here is still producer leak. The reason is that in &lt;tt&gt;FlinkKafkaProducer011.close()&lt;/tt&gt;&#160;will first check the &lt;tt&gt;asyncException&lt;/tt&gt; before it closes all the transactional producers. That may result in producer leak. And later tasks after failover will use the transactional IDs saved in the state, which are the same as the leaked producers. These task will&#160;receive ProducerFencedException and again trigger failover.&lt;/p&gt;

&lt;p&gt;As long as we guarantee &lt;tt&gt;FlinkKafkaProducer011.close()&lt;/tt&gt; cleans up everything, the classloader issue will be addressed. I&apos;ll submit a PR soon. We will need to add some test as well.&lt;/p&gt;</comment>
                            <comment id="16856536" author="sunjincheng121" created="Wed, 5 Jun 2019 09:27:01 +0000"  >&lt;p&gt;Glad to see your update! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; looking forward the PR.&#160;&lt;/p&gt;</comment>
                            <comment id="16860682" author="pnowojski" created="Tue, 11 Jun 2019 08:48:59 +0000"  >&lt;p&gt;merged commit 8364849 to master branch. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; could you backport this to 1.8 and 1.7 (since they are still supported versions) if there are no bigger conflicts?&lt;/p&gt;</comment>
                            <comment id="16861938" author="pnowojski" created="Wed, 12 Jun 2019 09:26:50 +0000"  >&lt;p&gt;merged commit 765eda1 into apache:release-1.8&lt;br/&gt;
merged commit ff4c143 into apache:release-1.7&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13198269">FLINK-10876</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12970781" name="image-2019-06-04-14-25-16-916.png" size="823469" author="sunjincheng121" created="Tue, 4 Jun 2019 06:25:20 +0000"/>
                            <attachment id="12970784" name="image-2019-06-04-14-30-55-985.png" size="484335" author="sunjincheng121" created="Tue, 4 Jun 2019 06:30:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ykw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>