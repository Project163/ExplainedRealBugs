<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10753] Propagate and log snapshotting exceptions</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10753</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Upon failure, &lt;tt&gt;AbstractStreamOperator.snapshotState&lt;/tt&gt; rethrows a new exception with the message &quot;&lt;tt&gt;Could not complete snapshot {} for operator {}.&lt;/tt&gt;&quot; and the original exception as the cause.&#160;&lt;/p&gt;

&lt;p&gt;While handling the error, &lt;tt&gt;CheckpointCoordinator.discardCheckpoint&lt;/tt&gt; method logs only&#160;this &#160;propagated message and not the original cause of the exception.&lt;/p&gt;

&lt;p&gt;In addition, &lt;tt&gt;pendingCheckpoint.abortDeclined()&lt;/tt&gt;, called from the&#160;&lt;tt&gt;discardCheckpoint&lt;/tt&gt;, reports the failed checkpoint with a misleading message &quot;&lt;tt&gt;Checkpoint was declined (tasks not ready)&lt;/tt&gt;&quot;. This message is what will be displayed in the UI (see attached).&lt;/p&gt;

&lt;p&gt;&#160;Proposition:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Log exception at the Task Manager (.snapshotState)&lt;/li&gt;
	&lt;li&gt;Log cause, instead of cause.getMessage() at the JobsManager (.dicardCheckpoint)&lt;/li&gt;
	&lt;li&gt;Pass root cause to abortDeclined and propagate a more appropriate message to the UI.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13195684">FLINK-10753</key>
            <summary>Propagate and log snapshotting exceptions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="afedulov">Alexander Fedulov</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 1 Nov 2018 15:35:38 +0000</created>
                <updated>Thu, 20 Dec 2018 09:27:36 +0000</updated>
                            <resolved>Mon, 12 Nov 2018 17:39:53 +0000</resolved>
                                    <version>1.6.2</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.5.6</fixVersion>
                    <fixVersion>1.6.3</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16679863" author="githubbot" created="Thu, 8 Nov 2018 14:53:36 +0000"  >&lt;p&gt;StefanRRichter opened a new pull request #7064: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10753&quot; title=&quot;Propagate and log snapshotting exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10753&quot;&gt;&lt;del&gt;FLINK-10753&lt;/del&gt;&lt;/a&gt; Improve propagation and logging of snapshot exceptions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7064&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7064&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This PR aims to improve the propagation and logging of exceptions that happen during state snapshots, as outlined in the JIRA issue. We log the exception already at the task manager and take care that the right cause makes it into the job manager logs.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16682646" author="githubbot" created="Sat, 10 Nov 2018 22:54:16 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7064: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10753&quot; title=&quot;Propagate and log snapshotting exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10753&quot;&gt;&lt;del&gt;FLINK-10753&lt;/del&gt;&lt;/a&gt; Improve propagation and logging of snapshot exceptions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7064#discussion_r232468420&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7064#discussion_r232468420&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1249,11 +1249,14 @@ private void discardCheckpoint(PendingCheckpoint pendingCheckpoint, @Nullable Th&lt;/p&gt;

&lt;p&gt; 		final long checkpointId = pendingCheckpoint.getCheckpointId();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final String reason = (cause != null) ? cause.getMessage() : &quot;&quot;;&lt;br/&gt;
+		LOG.info(&quot;Discarding checkpoint &quot; + checkpointId + &quot; of job &quot; + job + &quot;.&quot;, cause);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Please use placeholders for the variables.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16682647" author="githubbot" created="Sat, 10 Nov 2018 22:54:16 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7064: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10753&quot; title=&quot;Propagate and log snapshotting exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10753&quot;&gt;&lt;del&gt;FLINK-10753&lt;/del&gt;&lt;/a&gt; Improve propagation and logging of snapshot exceptions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7064#discussion_r232468561&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7064#discussion_r232468561&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/AbstractStreamOperator.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -413,8 +413,11 @@ public final OperatorSnapshotFutures snapshotState(long checkpointId, long times&lt;br/&gt;
 				snapshotException.addSuppressed(e);&lt;br/&gt;
 			}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;throw new Exception(&quot;Could not complete snapshot &quot; + checkpointId + &quot; for operator &quot; +&lt;/li&gt;
	&lt;li&gt;getOperatorName() + &apos;.&apos;, snapshotException);&lt;br/&gt;
+			String snapshotFailMessage = &quot;Could not complete snapshot &quot; + checkpointId + &quot; for operator &quot; +&lt;br/&gt;
+				getOperatorName() + &quot;.&quot;;&lt;br/&gt;
+&lt;br/&gt;
+			LOG.info(snapshotFailMessage, snapshotException);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I think it would be better to log the failure in `RpcCheckpointResponder#declineCheckpoint` because it is there where the message leaves the `TaskExecutor` and we no longer have control over it. Moreover, we would cover other failures coming from the other calling paths as well.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16682648" author="githubbot" created="Sat, 10 Nov 2018 22:54:16 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7064: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10753&quot; title=&quot;Propagate and log snapshotting exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10753&quot;&gt;&lt;del&gt;FLINK-10753&lt;/del&gt;&lt;/a&gt; Improve propagation and logging of snapshot exceptions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7064#discussion_r232468462&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7064#discussion_r232468462&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/PendingCheckpoint.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -433,25 +434,26 @@ public void abortSubsumed() {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+&lt;br/&gt;
 	public void abortDeclined() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
-			Exception cause = new Exception(&quot;Checkpoint was declined (tasks not ready)&quot;);
-			onCompletionPromise.completeExceptionally(cause);
-			reportFailedCheckpoint(cause);
-		}
&lt;p&gt; finally &lt;/p&gt;
{
-			dispose(true);
-		}
&lt;p&gt;+		abortWithCause(new Exception(&quot;Checkpoint was declined (tasks not ready)&quot;));&lt;br/&gt;
 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Aborts the pending checkpoint due to an error.&lt;/li&gt;
	&lt;li&gt;@param cause The error&apos;s exception.&lt;br/&gt;
 	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void abortError(Throwable cause) {&lt;br/&gt;
+	public void abortError(@Nullable Throwable cause) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   In which situation can `cause` be `null`?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16683687" author="githubbot" created="Mon, 12 Nov 2018 12:18:14 +0000"  >&lt;p&gt;StefanRRichter commented on issue #7064: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10753&quot; title=&quot;Propagate and log snapshotting exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10753&quot;&gt;&lt;del&gt;FLINK-10753&lt;/del&gt;&lt;/a&gt; Improve propagation and logging of snapshot exceptions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7064#issuecomment-437858640&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7064#issuecomment-437858640&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Comments addressed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16684142" author="githubbot" created="Mon, 12 Nov 2018 17:32:14 +0000"  >&lt;p&gt;StefanRRichter commented on issue #7064: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10753&quot; title=&quot;Propagate and log snapshotting exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10753&quot;&gt;&lt;del&gt;FLINK-10753&lt;/del&gt;&lt;/a&gt; Improve propagation and logging of snapshot exceptions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7064#issuecomment-437965713&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7064#issuecomment-437965713&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks @tillrohrmann! Merging.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16684147" author="githubbot" created="Mon, 12 Nov 2018 17:35:56 +0000"  >&lt;p&gt;asfgit closed pull request #7064: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10753&quot; title=&quot;Propagate and log snapshotting exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10753&quot;&gt;&lt;del&gt;FLINK-10753&lt;/del&gt;&lt;/a&gt; Improve propagation and logging of snapshot exceptions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7064&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7064&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java&lt;br/&gt;
index 57337b6286f..02b6fa4a2bb 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java&lt;br/&gt;
@@ -1249,11 +1249,14 @@ private void discardCheckpoint(PendingCheckpoint pendingCheckpoint, @Nullable Th&lt;/p&gt;

&lt;p&gt; 		final long checkpointId = pendingCheckpoint.getCheckpointId();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final String reason = (cause != null) ? cause.getMessage() : &quot;&quot;;&lt;br/&gt;
+		LOG.info(&quot;Discarding checkpoint {} of job {}.&quot;, checkpointId, job, cause);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;Discarding checkpoint {} of job {} because: {}&quot;, checkpointId, job, reason);&lt;br/&gt;
+		if (cause != null) 
{
+			pendingCheckpoint.abortError(cause);
+		}
&lt;p&gt; else &lt;/p&gt;
{
+			pendingCheckpoint.abortDeclined();
+		}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;pendingCheckpoint.abortDeclined();&lt;br/&gt;
 		rememberRecentCheckpointId(checkpointId);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		// we don&apos;t have to schedule another &quot;dissolving&quot; checkpoint any more because the&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/PendingCheckpoint.java b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/PendingCheckpoint.java&lt;br/&gt;
index 1b51ac4bf8d..1bc6b0e4baa 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/PendingCheckpoint.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/PendingCheckpoint.java&lt;br/&gt;
@@ -34,6 +34,7 @@&lt;br/&gt;
 import org.slf4j.Logger;&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;+import javax.annotation.Nonnull;&lt;br/&gt;
 import javax.annotation.Nullable;&lt;/p&gt;

&lt;p&gt; import java.io.IOException;&lt;br/&gt;
@@ -433,25 +434,23 @@ public void abortSubsumed() {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+&lt;br/&gt;
 	public void abortDeclined() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
-			Exception cause = new Exception(&quot;Checkpoint was declined (tasks not ready)&quot;);
-			onCompletionPromise.completeExceptionally(cause);
-			reportFailedCheckpoint(cause);
-		}
&lt;p&gt; finally &lt;/p&gt;
{
-			dispose(true);
-		}
&lt;p&gt;+		abortWithCause(new Exception(&quot;Checkpoint was declined (tasks not ready)&quot;));&lt;br/&gt;
 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Aborts the pending checkpoint due to an error.&lt;/li&gt;
	&lt;li&gt;@param cause The error&apos;s exception.&lt;br/&gt;
 	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void abortError(Throwable cause) {&lt;br/&gt;
+	public void abortError(@Nonnull Throwable cause) 
{
+		abortWithCause(new Exception(&quot;Checkpoint failed: &quot; + cause.getMessage(), cause));
+	}
&lt;p&gt;+&lt;br/&gt;
+	private void abortWithCause(@Nonnull Exception cause) {&lt;br/&gt;
 		try &lt;/p&gt;
{
-			Exception failure = new Exception(&quot;Checkpoint failed: &quot; + cause.getMessage(), cause);
-			onCompletionPromise.completeExceptionally(failure);
-			reportFailedCheckpoint(failure);
+			onCompletionPromise.completeExceptionally(cause);
+			reportFailedCheckpoint(cause);
 		}
&lt;p&gt; finally &lt;/p&gt;
{
 			dispose(true);
 		}
&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
index aba8bda1918..918fa50483d 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/rpc/RpcCheckpointResponder.java&lt;br/&gt;
@@ -26,8 +26,13 @@&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.CheckpointResponder;&lt;br/&gt;
 import org.apache.flink.util.Preconditions;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+import org.slf4j.Logger;&lt;br/&gt;
+import org.slf4j.LoggerFactory;&lt;br/&gt;
+&lt;br/&gt;
 public class RpcCheckpointResponder implements CheckpointResponder {&lt;/p&gt;

&lt;p&gt;+	private static final Logger LOG = LoggerFactory.getLogger(RpcCheckpointResponder.class);&lt;br/&gt;
+&lt;br/&gt;
 	private final CheckpointCoordinatorGateway checkpointCoordinatorGateway;&lt;/p&gt;

&lt;p&gt; 	public RpcCheckpointResponder(CheckpointCoordinatorGateway checkpointCoordinatorGateway) {&lt;br/&gt;
@@ -57,6 +62,7 @@ public void declineCheckpoint(&lt;br/&gt;
 			long checkpointId, &lt;br/&gt;
 			Throwable cause) {&lt;/p&gt;

&lt;p&gt;+		LOG.info(&quot;Declining checkpoint {} of job {}.&quot;, checkpointId, jobID, cause);&lt;br/&gt;
 		checkpointCoordinatorGateway.declineCheckpoint(jobID, executionAttemptID, checkpointId, cause);&lt;br/&gt;
 	}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/AbstractStreamOperator.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/AbstractStreamOperator.java&lt;br/&gt;
index a63a7971679..4967cb9ead9 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/AbstractStreamOperator.java&lt;br/&gt;
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/AbstractStreamOperator.java&lt;br/&gt;
@@ -413,8 +413,10 @@ public final OperatorSnapshotFutures snapshotState(long checkpointId, long times&lt;br/&gt;
 				snapshotException.addSuppressed(e);&lt;br/&gt;
 			}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;throw new Exception(&quot;Could not complete snapshot &quot; + checkpointId + &quot; for operator &quot; +&lt;/li&gt;
	&lt;li&gt;getOperatorName() + &apos;.&apos;, snapshotException);&lt;br/&gt;
+			String snapshotFailMessage = &quot;Could not complete snapshot &quot; + checkpointId + &quot; for operator &quot; +&lt;br/&gt;
+				getOperatorName() + &quot;.&quot;;&lt;br/&gt;
+&lt;br/&gt;
+			throw new Exception(snapshotFailMessage, snapshotException);&lt;br/&gt;
 		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		return snapshotInProgress;&lt;br/&gt;
diff --git a/flink-tests/src/test/java/org/apache/flink/test/state/operator/restore/AbstractOperatorRestoreTestBase.java b/flink-tests/src/test/java/org/apache/flink/test/state/operator/restore/AbstractOperatorRestoreTestBase.java&lt;br/&gt;
index 3db0f62f829..097616feb96 100644&lt;br/&gt;
&amp;#8212; a/flink-tests/src/test/java/org/apache/flink/test/state/operator/restore/AbstractOperatorRestoreTestBase.java&lt;br/&gt;
+++ b/flink-tests/src/test/java/org/apache/flink/test/state/operator/restore/AbstractOperatorRestoreTestBase.java&lt;br/&gt;
@@ -142,6 +142,7 @@ private String migrateJob(ClassLoader classLoader, ClusterClient&amp;lt;?&amp;gt; clusterClien&lt;br/&gt;
 			} catch (Exception e) {&lt;br/&gt;
 				String exceptionString = ExceptionUtils.stringifyException(e);&lt;br/&gt;
 				if (!(exceptionString.matches(&quot;(.&lt;b&gt;\n)&lt;/b&gt;.&lt;b&gt;savepoint for the job .&lt;/b&gt; failed(.&lt;b&gt;\n)&lt;/b&gt;&quot;) // legacy&lt;br/&gt;
+						|| exceptionString.matches(&quot;(.&lt;b&gt;\n)&lt;/b&gt;.&lt;b&gt;was not running(.&lt;/b&gt;\n)*&quot;)&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; exceptionString.matches(&quot;(.&lt;b&gt;\n)&lt;/b&gt;.&lt;b&gt;Not all required tasks are currently running(.&lt;/b&gt;\n)*&quot;) // new&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; exceptionString.matches(&quot;(.&lt;b&gt;\n)&lt;/b&gt;.&lt;b&gt;Checkpoint was declined &lt;br class=&quot;atl-forced-newline&quot; /&gt;(tasks not ready\\)(.&lt;/b&gt;\n)*&quot;))) { // new&lt;br/&gt;
 					throw e;&lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16684152" author="srichter" created="Mon, 12 Nov 2018 17:39:53 +0000"  >&lt;p&gt;Merged in:&lt;br/&gt;
master: dc8e27f&lt;br/&gt;
release-1.7: 9477b6a&lt;br/&gt;
release-1.6: 6814e5f&lt;br/&gt;
release-1.5: 1725591&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13205088">FLINK-11190</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12946563" name="Screen Shot 2018-11-01 at 16.27.01.png" size="27781" author="afedulov" created="Thu, 1 Nov 2018 15:32:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s0012o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>