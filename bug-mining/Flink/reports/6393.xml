<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:10:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-26738] Default value of StateDescriptor is valid when enable state ttl config</title>
                <link>https://issues.apache.org/jira/browse/FLINK-26738</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Suppose we declare a ValueState like following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ValueStateDescriptor&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt; descriptor =
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ValueStateDescriptor&amp;lt;&amp;gt;(
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;average&quot;&lt;/span&gt;, &lt;span class=&quot;code-comment&quot;&gt;// the state name
&lt;/span&gt;                        TypeInformation.of(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TypeHint&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt;() {}),  
                        Tuple2.of(0L, 0L)); 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and then we add state ttl config to the state:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
descriptor.enableTimeToLive(StateTtlConfigUtil.createTtlConfig(60000));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the default value Tuple2.of(0L, 0L) will be invalid and may cause NPE.&lt;/p&gt;

&lt;p&gt;I don&apos;t know if this is a bug cause I see @Deprecated in the comment of the ValueStateDescriptor constructor with argument defaultValue:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Use {@link #ValueStateDescriptor(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, TypeSerializer)} instead and manually
     *     manage the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; value by checking whether the contents of the state is {@code &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and if we decide not to use the defaultValue field in the class StateDescriptor, should we add @Deprecated annotation to the field defaultValue?&lt;/p&gt;

</description>
                <environment></environment>
        <key id="13434675">FLINK-26738</key>
            <summary>Default value of StateDescriptor is valid when enable state ttl config</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lam167">Jianhui Dong</assignee>
                                    <reporter username="lam167">Jianhui Dong</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sat, 19 Mar 2022 11:12:33 +0000</created>
                <updated>Sat, 2 Apr 2022 08:22:52 +0000</updated>
                            <resolved>Sat, 2 Apr 2022 08:22:52 +0000</resolved>
                                    <version>1.15.0</version>
                                    <fixVersion>1.14.5</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                    <fixVersion>1.16.0</fixVersion>
                                    <component>API / Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17509584" author="yunta" created="Mon, 21 Mar 2022 03:44:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lam167&quot; class=&quot;user-hover&quot; rel=&quot;lam167&quot;&gt;lam167&lt;/a&gt;, what kind of NPE will you meet?&lt;/p&gt;

&lt;p&gt;Once the state descriptor enables TTL, it will always create another internl state descriptor and make the default value as null (you can refer to &lt;a href=&quot;https://github.com/apache/flink/blob/1bf45b25791cc3fad8b7d0d863caa9b0eef9a87b/flink-runtime/src/main/java/org/apache/flink/runtime/state/ttl/TtlStateFactory.java#L140-L148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;) . I&apos;m not sure what kind of error will you meet.&lt;/p&gt;</comment>
                            <comment id="17510267" author="lam167" created="Tue, 22 Mar 2022 07:08:14 +0000"  >&lt;p&gt;&quot;it will always create another internl state descriptor and make the default value as null &quot;, that&apos;s the point, the default value becomes null.&lt;br/&gt;
For example, when I try to execute the following code :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ValueStateDescriptor&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt; descriptor =
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ValueStateDescriptor&amp;lt;&amp;gt;(
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;average&quot;&lt;/span&gt;, &lt;span class=&quot;code-comment&quot;&gt;// the state name
&lt;/span&gt;                        TypeInformation.of(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TypeHint&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt;() {}),  
                        Tuple2.of(0L, 0L)); 
descriptor.enableTimeToLive(StateTtlConfigUtil.createTtlConfig(60000));
sum = getRuntimeContext().getState(descriptor);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the sum will be null but not Tuple2.of(0L, 0L), and when I try to invoke sum.f0, it will cause NPE.&lt;br/&gt;
I tried to copy the default value to the code you referred to, but I saw that the constructor with default value was marked as deprecated. I do not know if flink would deprecate default value field in StateDescriptor or just deprecated the constructor in the subclass of StateDescriptor, like ValueStateDescriptor etc.&lt;/p&gt;</comment>
                            <comment id="17511101" author="yunta" created="Wed, 23 Mar 2022 08:31:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lam167&quot; class=&quot;user-hover&quot; rel=&quot;lam167&quot;&gt;lam167&lt;/a&gt;, first of all, the returned &lt;tt&gt;sum&lt;/tt&gt; is a value state not some internal value from your code. I don&apos;t know why it will cause NPE.&lt;/p&gt;

&lt;p&gt;For TTL state, the semantics would be weird if we have a default value. We treat the data expired and return null and then let the user to decide whether to replace as default value.&lt;/p&gt;</comment>
                            <comment id="17511354" author="lam167" created="Wed, 23 Mar 2022 16:37:38 +0000"  >&lt;p&gt;sorry, I forget to add the ValueState#value() method, &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ValueStateDescriptor&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt; descriptor =
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ValueStateDescriptor&amp;lt;&amp;gt;(
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;average&quot;&lt;/span&gt;, &lt;span class=&quot;code-comment&quot;&gt;// the state name
&lt;/span&gt;                        TypeInformation.of(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TypeHint&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt;() {}),  
                        Tuple2.of(0L, 0L)); 
descriptor.enableTimeToLive(StateTtlConfigUtil.createTtlConfig(60000));
sum = getRuntimeContext().getState(descriptor).value();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;now maybe you can see it would cause NPE.&lt;/p&gt;</comment>
                            <comment id="17511363" author="lam167" created="Wed, 23 Mar 2022 16:48:12 +0000"  >&lt;p&gt;And I think this is an issue worth discussing, from my personal point of view, if the default value is valid for TTL state, there&apos;s no difference between having the user set a default value to the state descriptor and replacing the expired state with a default value in the code manually. Even if a user sets the default value, they can also replace it with a new value, it&apos;s no conflict and would make the concept of default value clearer.&lt;br/&gt;
And one more question, why we add @Deprecated annotation to the ValueDescriptor constructor, would we remove the default value in class StateDescriptor in the future?&lt;/p&gt;</comment>
                            <comment id="17511603" author="yunta" created="Thu, 24 Mar 2022 06:18:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lam167&quot; class=&quot;user-hover&quot; rel=&quot;lam167&quot;&gt;lam167&lt;/a&gt;, the reason why Flink community mark the default value in state descriptor as deprecated is that user cannot judge whether the returned default value is for the real answer or just null.&lt;/p&gt;

&lt;p&gt;This is also true for TTL state with default value, if we get the default value from TTL state, we cannot judge whether the key is expired, not existed or just the value is default value itself, which make the semantics unclear.&lt;br/&gt;
From my point of view, disabling default value for TTL state is reasonable and maybe we need to make the truth more clear in docs and javadocs. WDYT?&lt;/p&gt;</comment>
                            <comment id="17511616" author="lam167" created="Thu, 24 Mar 2022 06:51:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, thanks for your explanation, I think it&apos;s a good idea to make it clearer in docs and javadocs, and should we mark org.apache.flink.api.common.state.StateDescriptor#default(&lt;a href=&quot;https://github.com/apache/flink/blob/7d7a111eba368043f8624e114daa29400a74c096/flink-core/src/main/java/org/apache/flink/api/common/state/StateDescriptor.java#L107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/7d7a111eba368043f8624e114daa29400a74c096/flink-core/src/main/java/org/apache/flink/api/common/state/StateDescriptor.java#L107&lt;/a&gt;) as deprecated too, not only mark org.apache.flink.api.common.state.ValueStateDescriptor constructor(&lt;a href=&quot;https://github.com/apache/flink/blob/7d7a111eba368043f8624e114daa29400a74c096/flink-core/src/main/java/org/apache/flink/api/common/state/ValueStateDescriptor.java#L70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/7d7a111eba368043f8624e114daa29400a74c096/flink-core/src/main/java/org/apache/flink/api/common/state/ValueStateDescriptor.java#L70&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="17511691" author="yunta" created="Thu, 24 Mar 2022 08:34:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lam167&quot; class=&quot;user-hover&quot; rel=&quot;lam167&quot;&gt;lam167&lt;/a&gt; I agree, would you like to take this ticket to make this semantics more clear in the code and docs? I can assign this ticket to you if possible.&lt;/p&gt;</comment>
                            <comment id="17511704" author="lam167" created="Thu, 24 Mar 2022 08:55:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, thanks, I&apos;d like to try it~&lt;/p&gt;</comment>
                            <comment id="17511743" author="yunta" created="Thu, 24 Mar 2022 09:57:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lam167&quot; class=&quot;user-hover&quot; rel=&quot;lam167&quot;&gt;lam167&lt;/a&gt;, already assigned to you and downgrade the priority to major.&lt;/p&gt;</comment>
                            <comment id="17511865" author="lam167" created="Thu, 24 Mar 2022 13:43:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, this is the pr: &lt;a href=&quot;https://github.com/apache/flink/pull/19229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/19229&lt;/a&gt;, thank you for taking the time to review.&lt;/p&gt;</comment>
                            <comment id="17513252" author="lam167" created="Mon, 28 Mar 2022 09:04:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, resolved conflict, please check it agian.&lt;/p&gt;</comment>
                            <comment id="17516250" author="yunta" created="Sat, 2 Apr 2022 08:22:52 +0000"  >&lt;p&gt;merged in master: 5045f1f68687785b472536bfa041b09e9e896816&lt;br/&gt;
release-1.15: b3428b345a230446d7a502ef5e6827a2ab826d4e&lt;br/&gt;
release-1.14: d706b8169faa77dd126d923db326709dc5631a37&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 32 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10mtc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>