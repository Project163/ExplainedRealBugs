<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:41:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14315] NPE with JobMaster.disconnectTaskManager</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14315</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;There was some connection issue with zookeeper that caused the job to restart.  But shutdown failed with this fatal NPE, which seems to cause JVM to exit&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-10-02 16:16:19,134 INFO  org.apache.flink.shaded.zookeeper.org.apache.zookeeper.ClientCnxn  - Unable to read additional data from server sessionid 0x16d83374c4206f8, likely server has clo
sed socket, closing socket connection and attempting reconnect
2019-10-02 16:16:19,234 INFO  org.apache.flink.shaded.curator.org.apache.curator.framework.state.ConnectionStateManager  - State change: SUSPENDED
2019-10-02 16:16:19,235 WARN  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Connection to ZooKeeper suspended. Can no longer retrieve the leader from ZooKeeper.
2019-10-02 16:16:19,235 WARN  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Connection to ZooKeeper suspended. Can no longer retrieve the leader from ZooKeeper.
2019-10-02 16:16:19,235 WARN  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService  - Connection to ZooKeeper suspended. The contender akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@100.122.177.82:42043/u
&lt;/span&gt;ser/dispatcher no longer participates in the leader election.
2019-10-02 16:16:19,237 INFO  org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint    - http:&lt;span class=&quot;code-comment&quot;&gt;//100.122.177.82:8081 lost leadership
&lt;/span&gt;2019-10-02 16:16:19,237 INFO  com.netflix.spaas.runtime.resourcemanager.TitusResourceManager  - ResourceManager akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@100.122.177.82:42043/user/resourcemanager was revoked leadershi
&lt;/span&gt;p. Clearing fencing token.
2019-10-02 16:16:19,237 INFO  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Stopping ZooKeeperLeaderRetrievalService /leader/e4e68f2b3fc40c7008cca624b2a2bab0/job_
manager_lock.
2019-10-02 16:16:19,237 WARN  org.apache.flink.runtime.jobmanager.ZooKeeperSubmittedJobGraphStore  - ZooKeeper connection SUSPENDING. Changes to the submitted job graphs are not monitored (tem
porarily).
2019-10-02 16:16:19,238 INFO  org.apache.flink.runtime.jobmaster.JobManagerRunner           - JobManager &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job ksrouter (e4e68f2b3fc40c7008cca624b2a2bab0) was revoked leadership at akka.tcp:
&lt;span class=&quot;code-comment&quot;&gt;//flink@100.122.177.82:42043/user/jobmanager_0.
&lt;/span&gt;2019-10-02 16:16:19,239 INFO  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Stopping ZooKeeperLeaderRetrievalService /leader/resource_manager_lock.
2019-10-02 16:16:19,239 WARN  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService  - Connection to ZooKeeper suspended. The contender http:&lt;span class=&quot;code-comment&quot;&gt;//100.122.177.82:8081 no longer pa
&lt;/span&gt;rticipates in the leader election.
2019-10-02 16:16:19,239 WARN  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Connection to ZooKeeper suspended. Can no longer retrieve the leader from ZooKeeper.
2019-10-02 16:16:19,239 WARN  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService  - Connection to ZooKeeper suspended. The contender akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@100.122.177.82:42043/u
&lt;/span&gt;ser/jobmanager_0 no longer participates in the leader election.
2019-10-02 16:16:19,239 WARN  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Connection to ZooKeeper suspended. Can no longer retrieve the leader from ZooKeeper.
2019-10-02 16:16:19,239 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph        - Job ksrouter (e4e68f2b3fc40c7008cca624b2a2bab0) switched from state RUNNING to SUSPENDED.
org.apache.flink.util.FlinkException: JobManager is no longer the leader.
        at org.apache.flink.runtime.jobmaster.JobManagerRunner.revokeJobMasterLeadership(JobManagerRunner.java:391)
        at org.apache.flink.runtime.jobmaster.JobManagerRunner.lambda$revokeLeadership$5(JobManagerRunner.java:377)
        at java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:981)
        at java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2124)
        at org.apache.flink.runtime.jobmaster.JobManagerRunner.revokeLeadership(JobManagerRunner.java:374)
        at org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService.notLeader(ZooKeeperLeaderElectionService.java:247)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.recipes.leader.LeaderLatch$8.apply(LeaderLatch.java:640)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.recipes.leader.LeaderLatch$8.apply(LeaderLatch.java:636)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.listen.ListenerContainer$1.run(ListenerContainer.java:93)
        at org.apache.flink.shaded.curator.org.apache.curator.shaded.com.google.common.util.concurrent.MoreExecutors$SameThreadExecutorService.execute(MoreExecutors.java:297)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.listen.ListenerContainer.forEach(ListenerContainer.java:85)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.recipes.leader.LeaderLatch.setLeadership(LeaderLatch.java:635)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.recipes.leader.LeaderLatch.handleStateChange(LeaderLatch.java:623)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.recipes.leader.LeaderLatch.access$000(LeaderLatch.java:64)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.recipes.leader.LeaderLatch$1.stateChanged(LeaderLatch.java:82)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.state.ConnectionStateManager$2.apply(ConnectionStateManager.java:259)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.state.ConnectionStateManager$2.apply(ConnectionStateManager.java:255)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.listen.ListenerContainer$1.run(ListenerContainer.java:93)
        at org.apache.flink.shaded.curator.org.apache.curator.shaded.com.google.common.util.concurrent.MoreExecutors$SameThreadExecutorService.execute(MoreExecutors.java:297)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.listen.ListenerContainer.forEach(ListenerContainer.java:85)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.state.ConnectionStateManager.processEvents(ConnectionStateManager.java:253)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.state.ConnectionStateManager.access$000(ConnectionStateManager.java:43)
        at org.apache.flink.shaded.curator.org.apache.curator.framework.state.ConnectionStateManager$1.call(ConnectionStateManager.java:111)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
2019-10-02 16:16:19,240 WARN  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService  - Connection to ZooKeeper suspended. The contender akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@100.122.177.82:42043/u
&lt;/span&gt;ser/resourcemanager no longer participates in the leader election.
2019-10-02 16:16:19,239 INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher      - Dispatcher akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@100.122.177.82:42043/user/dispatcher was revoked leadership.
&lt;/span&gt;2019-10-02 16:16:19,239 INFO  org.apache.flink.runtime.resourcemanager.slotmanager.SlotManagerImpl  - Suspending the SlotManager.
2019-10-02 16:16:19,240 INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher      - Stopping all currently running jobs of dispatcher akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@100.122.177.82:42043/user/dispa
&lt;/span&gt;tcher.
2019-10-02 16:16:19,258 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator     - Stopping checkpoint coordinator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job e4e68f2b3fc40c7008cca624b2a2bab0.
2019-10-02 16:16:19,258 INFO  org.apache.flink.runtime.checkpoint.ZooKeeperCompletedCheckpointStore  - Suspending
2019-10-02 16:16:20,076 WARN  org.apache.flink.shaded.zookeeper.org.apache.zookeeper.ClientCnxn  - SASL configuration failed: javax.security.auth.login.LoginException: No JAAS configuration se
ction named &lt;span class=&quot;code-quote&quot;&gt;&apos;Client&apos;&lt;/span&gt; was found in specified JAAS configuration file: &lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp/jaas-6650646464026425406.conf&apos;&lt;/span&gt;. Will &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt; connection to Zookeeper server without SASL authentication, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; Zookeepe
r server allows it.
2019-10-02 16:16:20,076 INFO  org.apache.flink.shaded.zookeeper.org.apache.zookeeper.ClientCnxn  - Opening socket connection to server 100.66.21.125/100.66.21.125:2181
2019-10-02 16:16:20,076 ERROR org.apache.flink.shaded.curator.org.apache.curator.ConnectionState  - Authentication failed
2019-10-02 16:16:20,077 INFO  org.apache.flink.shaded.zookeeper.org.apache.zookeeper.ClientCnxn  - Socket connection established to 100.66.21.125/100.66.21.125:2181, initiating session
2019-10-02 16:16:20,080 INFO  org.apache.flink.shaded.zookeeper.org.apache.zookeeper.ClientCnxn  - Session establishment complete on server 100.66.21.125/100.66.21.125:2181, sessionid = 0x16d8
3374c4206f8, negotiated timeout = 40000
2019-10-02 16:16:20,080 INFO  org.apache.flink.shaded.curator.org.apache.curator.framework.state.ConnectionStateManager  - State change: RECONNECTED
2019-10-02 16:16:20,080 INFO  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService  - Connection to ZooKeeper was reconnected. Leader election can be restarted.
2019-10-02 16:16:20,082 INFO  org.apache.flink.runtime.jobmanager.ZooKeeperSubmittedJobGraphStore  - ZooKeeper connection RECONNECTED. Changes to the submitted job graphs are monitored again.
2019-10-02 16:16:20,082 INFO  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService  - Connection to ZooKeeper was reconnected. Leader election can be restarted.
2019-10-02 16:16:20,082 INFO  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Connection to ZooKeeper was reconnected. Leader retrieval can be restarted.
2019-10-02 16:16:20,082 INFO  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService  - Connection to ZooKeeper was reconnected. Leader election can be restarted.
2019-10-02 16:16:20,082 INFO  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService  - Connection to ZooKeeper was reconnected. Leader retrieval can be restarted.
2019-10-02 16:16:20,082 INFO  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService  - Connection to ZooKeeper was reconnected. Leader election can be restarted.
2019-10-02 16:16:20,322 INFO  com.netflix.spaas.runtime.resourcemanager.TitusResourceManager  - ResourceManager akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@100.122.177.82:42043/user/resourcemanager was granted leadershi
&lt;/span&gt;p with fencing token 94628b472f22083fb4e611d108304613
2019-10-02 16:16:20,322 INFO  org.apache.flink.runtime.resourcemanager.slotmanager.SlotManagerImpl  - Starting the SlotManager.
2019-10-02 16:16:20,326 INFO  org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint    - http:&lt;span class=&quot;code-comment&quot;&gt;//100.122.177.82:8081 was granted leadership with leaderSessionID=69531adf-a5eb-46d2-99dc-b85
&lt;/span&gt;0f66e1af1
2019-10-02 16:16:20,393 INFO  org.apache.flink.runtime.jobmaster.JobManagerRunner           - JobManagerRunner already shutdown.
2019-10-02 16:16:20,393 INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher      - Dispatcher akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@100.122.177.82:42043/user/dispatcher was granted leadership with fenci
&lt;/span&gt;ng token abe4ffde-0a18-412b-bffa-28067ccccbeb
2019-10-02 16:16:20,393 INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher      - Recovering all persisted jobs.
2019-10-02 16:16:20,407 INFO  com.facebook.presto.s3fs.PrestoS3FileSystem                   - Opening path: s3:&lt;span class=&quot;code-comment&quot;&gt;//us-east-1.ksrouter.dev/recovery/4fa8-1569989613304/444/submittedJobGraphf4c0027
&lt;/span&gt;a08cf
2019-10-02 16:16:20,407 INFO  com.facebook.presto.s3fs.PrestoS3FileSystem                   - Seek with &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; stream &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; s3:&lt;span class=&quot;code-comment&quot;&gt;//us-east-1.ksrouter.dev/recovery/4fa8-1569989613304/444/submittedJobG
&lt;/span&gt;raphf4c0027a08cf to offset 0
2019-10-02 16:16:20,412 INFO  com.netflix.spaas.runtime.resourcemanager.TitusResourceManager  - Registering TaskManager with ResourceID 015fd9b87fc4ceb7bb1c40318db0d854 (akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@100.1
&lt;/span&gt;22.134.166:43709/user/taskmanager_0) at ResourceManager
2019-10-02 16:16:20,412 INFO  com.netflix.spaas.runtime.resourcemanager.TitusResourceReconciler  - Task manager 100.122.134.166 re-registered.
2019-10-02 16:16:20,416 INFO  org.apache.flink.runtime.checkpoint.ZooKeeperCheckpointIDCounter  - Shutting down.
2019-10-02 16:16:20,416 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph        - Job e4e68f2b3fc40c7008cca624b2a2bab0 has been suspended.
2019-10-02 16:16:20,417 INFO  org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl      - Suspending SlotPool.
2019-10-02 16:16:20,417 INFO  org.apache.flink.runtime.jobmaster.JobMaster                  - Close ResourceManager connection dda8a9f54ec0239b7e2aa53e0a9b6174: JobManager is no longer the lea
der..
2019-10-02 16:16:20,418 INFO  org.apache.flink.runtime.jobmaster.JobMaster                  - Stopping the JobMaster &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job ksrouter(e4e68f2b3fc40c7008cca624b2a2bab0).
2019-10-02 16:16:20,420 INFO  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService  - Stopping ZooKeeperLeaderElectionService ZooKeeperLeaderElectionService{leaderPath=&lt;span class=&quot;code-quote&quot;&gt;&apos;/leader/e4e68f2b3fc40c7008cca624b2a2bab0/job_manager_lock&apos;&lt;/span&gt;}.
2019-10-02 16:16:20,431 INFO  com.netflix.spaas.runtime.resourcemanager.TitusResourceManager  - Registering TaskManager with ResourceID 8d41d9e915b5fe378b3d7cd18042fcff (akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@100.122.50.217:44327/user/taskmanager_0) at ResourceManager
&lt;/span&gt;2019-10-02 16:16:20,431 INFO  com.netflix.spaas.runtime.resourcemanager.TitusResourceReconciler  - Task manager 100.122.50.217 re-registered.
2019-10-02 16:16:20,542 INFO  org.apache.flink.runtime.jobmanager.ZooKeeperSubmittedJobGraphStore  - Recovered SubmittedJobGraph(e4e68f2b3fc40c7008cca624b2a2bab0).
2019-10-02 16:16:20,542 INFO  org.apache.flink.runtime.jobmanager.ZooKeeperSubmittedJobGraphStore  - Recovered SubmittedJobGraph(e4e68f2b3fc40c7008cca624b2a2bab0).
2019-10-02 16:16:20,542 ERROR org.apache.flink.runtime.entrypoint.ClusterEntrypoint         - Fatal error occurred in the cluster entrypoint.
org.apache.flink.runtime.dispatcher.DispatcherException: Failed to take leadership with session id abe4ffde-0a18-412b-bffa-28067ccccbeb.
        at org.apache.flink.runtime.dispatcher.Dispatcher.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$30(Dispatcher.java:915)
        at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:760)
        at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:736)
        at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:474)
        at java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:561)
        at java.util.concurrent.CompletableFuture$UniCompose.tryFire(CompletableFuture.java:929)
        at java.util.concurrent.CompletableFuture$Completion.run(CompletableFuture.java:442)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRunAsync(AkkaRpcActor.java:397)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:190)
        at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleRpcMessage(FencedAkkaRpcActor.java:88)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleMessage(AkkaRpcActor.java:152)
        at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:26)
        at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:21)
        at scala.PartialFunction$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;applyOrElse(PartialFunction.scala:123)
        at akka.japi.pf.UnitCaseStatement.applyOrElse(CaseStatements.scala:21)
        at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:170)
        at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171)
        at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171)
        at akka.actor.Actor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;aroundReceive(Actor.scala:517)
        at akka.actor.AbstractActor.aroundReceive(AbstractActor.scala:225)
        at akka.actor.ActorCell.receiveMessage(ActorCell.scala:592)
        at akka.actor.ActorCell.invoke(ActorCell.scala:561)
        at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:258)
        at akka.dispatch.Mailbox.run(Mailbox.scala:225)
        at akka.dispatch.Mailbox.exec(Mailbox.scala:235)
        at akka.dispatch.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
        at akka.dispatch.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
        at akka.dispatch.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
        at akka.dispatch.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
Caused by: org.apache.flink.runtime.dispatcher.DispatcherException: Termination of previous JobManager &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job e4e68f2b3fc40c7008cca624b2a2bab0 failed. Cannot submit job under the same job id.
        at org.apache.flink.runtime.dispatcher.Dispatcher.lambda$waitForTerminatingJobManager$33(Dispatcher.java:949)
        at java.util.concurrent.CompletableFuture.uniExceptionally(CompletableFuture.java:870)
        at java.util.concurrent.CompletableFuture.uniExceptionallyStage(CompletableFuture.java:884)
        at java.util.concurrent.CompletableFuture.exceptionally(CompletableFuture.java:2196)
        at org.apache.flink.runtime.dispatcher.Dispatcher.waitForTerminatingJobManager(Dispatcher.java:946)
        at org.apache.flink.runtime.dispatcher.Dispatcher.tryAcceptLeadershipAndRunJobs(Dispatcher.java:933)
        at org.apache.flink.runtime.dispatcher.Dispatcher.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$28(Dispatcher.java:892)
        at java.util.concurrent.CompletableFuture.uniCompose(CompletableFuture.java:952)
        at java.util.concurrent.CompletableFuture$UniCompose.tryFire(CompletableFuture.java:926)
        ... 23 more
Caused by: java.util.concurrent.CompletionException: org.apache.flink.util.FlinkException: Could not properly shut down the JobManagerRunner
        at java.util.concurrent.CompletableFuture.encodeRelay(CompletableFuture.java:326)
        at java.util.concurrent.CompletableFuture.completeRelay(CompletableFuture.java:338)
        at java.util.concurrent.CompletableFuture.uniRelay(CompletableFuture.java:911)
        at java.util.concurrent.CompletableFuture$UniRelay.tryFire(CompletableFuture.java:899)
        at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:474)
        at java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:1977)
        at org.apache.flink.runtime.jobmaster.JobManagerRunner.lambda$closeAsync$0(JobManagerRunner.java:207)
        at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:760)
        at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:736)
        at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:474)
        at java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:1977)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.postStop(AkkaRpcActor.java:132)
        at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.postStop(FencedAkkaRpcActor.java:40)
        at akka.actor.Actor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;aroundPostStop(Actor.scala:536)
        at akka.actor.AbstractActor.aroundPostStop(AbstractActor.scala:225)
        at akka.actor.dungeon.FaultHandling$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;akka$actor$dungeon$FaultHandling$$finishTerminate(FaultHandling.scala:210)
        at akka.actor.dungeon.FaultHandling$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;terminate(FaultHandling.scala:172)
        at akka.actor.ActorCell.terminate(ActorCell.scala:429)
        at akka.actor.ActorCell.invokeAll$1(ActorCell.scala:533)
        at akka.actor.ActorCell.systemInvoke(ActorCell.scala:549)
        at akka.dispatch.Mailbox.processAllSystemMessages(Mailbox.scala:283)
        at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:261)
        ... 6 more
Caused by: org.apache.flink.util.FlinkException: Could not properly shut down the JobManagerRunner
        ... 22 more
Caused by: org.apache.flink.runtime.rpc.akka.exceptions.AkkaRpcException: Failure &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; stopping RpcEndpoint jobmanager_0.
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor$StartedState.terminate(AkkaRpcActor.java:513)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleControlMessage(AkkaRpcActor.java:175)
        at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:26)
        at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:21)
        at scala.PartialFunction$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;applyOrElse(PartialFunction.scala:123)
        at akka.japi.pf.UnitCaseStatement.applyOrElse(CaseStatements.scala:21)
        at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:170)
        at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171)
        at akka.actor.Actor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;aroundReceive(Actor.scala:517)
        at akka.actor.AbstractActor.aroundReceive(AbstractActor.scala:225)
        at akka.actor.ActorCell.receiveMessage(ActorCell.scala:592)
        at akka.actor.ActorCell.invoke(ActorCell.scala:561)
        at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:258)
        ... 6 more
Caused by: java.lang.NullPointerException
        at org.apache.flink.runtime.jobmaster.JobMaster.disconnectTaskManager(JobMaster.java:425)
        at org.apache.flink.runtime.jobmaster.JobMaster.onStop(JobMaster.java:343)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor$StartedState.terminate(AkkaRpcActor.java:509)
        ... 18 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13260142">FLINK-14315</key>
            <summary>NPE with JobMaster.disconnectTaskManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="stevenz3wu">Steven Zhen Wu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 2 Oct 2019 16:44:17 +0000</created>
                <updated>Tue, 8 Oct 2019 12:18:18 +0000</updated>
                            <resolved>Tue, 8 Oct 2019 12:18:18 +0000</resolved>
                                    <version>1.8.2</version>
                    <version>1.9.0</version>
                    <version>1.10.0</version>
                                    <fixVersion>1.8.3</fixVersion>
                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16942975" author="tison" created="Wed, 2 Oct 2019 17:06:32 +0000"  >&lt;p&gt;It looks like &lt;tt&gt;JobMaster#suspend&lt;/tt&gt; races with &lt;tt&gt;JobMaster#onStop&lt;/tt&gt; which&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;JobMaster#suspend&lt;/tt&gt; set &lt;tt&gt;taskManagerHeartbeatManager = null&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;while &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;JobMaster#onStop&lt;/tt&gt; calls &lt;tt&gt;JobMaster#disconnectTaskManager&lt;/tt&gt; calls &lt;tt&gt;taskManagerHeartbeatManager.unmonitorTarget(resourceID)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Another perspective is we can properly tolerate zk unstable(connection loss exception) as discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10052&quot; title=&quot;Tolerate temporarily suspended ZooKeeper connections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10052&quot;&gt;&lt;del&gt;FLINK-10052&lt;/del&gt;&lt;/a&gt; (it doesn&apos;t solve the problem here but make it quite more rare)&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16944427" author="till.rohrmann" created="Fri, 4 Oct 2019 11:37:46 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevenz3wu&quot; class=&quot;user-hover&quot; rel=&quot;stevenz3wu&quot;&gt;stevenz3wu&lt;/a&gt;. I think your analysis is correct &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt;. The problem seems to be that we first suspend the &lt;tt&gt;JobMaster&lt;/tt&gt; and then shortly afterwards shut it down. This causes the race condition in which we first &lt;tt&gt;null&lt;/tt&gt; the &lt;tt&gt;taskManagerHeartbeatManager&lt;/tt&gt; field and the call &lt;tt&gt;disconnectTaskManager&lt;/tt&gt; which uses this field.&lt;/p&gt;

&lt;p&gt;This is clearly a bug and should be fixed. I suggest to do a quick fix and introducing a &lt;tt&gt;null&lt;/tt&gt; check.&lt;/p&gt;

&lt;p&gt;The proper fix is in my opinion to not use a &lt;tt&gt;JobMaster&lt;/tt&gt; instance across leader sessions. Removing the mutability should solve these kind of problems. The issue to track this effort is &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11719&quot; title=&quot;Remove JobMaster#start(JobMasterId) and #suspend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11719&quot;&gt;&lt;del&gt;FLINK-11719&lt;/del&gt;&lt;/a&gt; which I will continue once &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11843&quot; title=&quot;Dispatcher fails to recover jobs if leader change happens during JobManagerRunner termination&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11843&quot;&gt;&lt;del&gt;FLINK-11843&lt;/del&gt;&lt;/a&gt; has been completed.&lt;/p&gt;</comment>
                            <comment id="16946788" author="till.rohrmann" created="Tue, 8 Oct 2019 12:18:18 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.10.0: 4064b5b67d6d220e1d5518bca96688f51cbbb891&lt;br/&gt;
1.9.2: 8e0d1b5fac2f10f1b34ef82dcc38df8fd83cd82b&lt;br/&gt;
1.8.3: 766e25027a88a75002d121c8204766ee76b466d3&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z078hs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>