<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:29:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7101] Fix Non-windowed group-aggregate error when using `minIdleStateRetentionTime` config and retract agg</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7101</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When Non-windowed group-aggregate using &lt;tt&gt;minIdleStateRetentionTime&lt;/tt&gt; config and retract AGG, Will emit &quot;NULL&quot; agg value which we do not expect. &lt;br/&gt;
For example: (&lt;tt&gt;IntSumWithRetractAggFunction&lt;/tt&gt;)&lt;br/&gt;
1. Receive: CRow(Row.of(6L: JLong, 5: JInt, &quot;aaa&quot;), true) &lt;br/&gt;
2. Cleanup state&lt;br/&gt;
3. Receive: CRow(Row.of(6L: JLong, 5: JInt, &quot;aaa&quot;), false)  // acc.f1 = -1, getValue= null &lt;/p&gt;

&lt;p&gt;So, we must change the logic of &lt;tt&gt;GroupAggProcessFunction&lt;/tt&gt; as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inputCnt != 0) {
     ...
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
     ...
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;TO&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inputCnt &amp;gt; 0) {
     ...
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != prevRow.row){
     ...
     }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this case, the result will bigger than expected, but i think it&apos;s make sense, because user want cleanup state.(they should know the impact)&lt;br/&gt;
What do you think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hequn8128&quot; class=&quot;user-hover&quot; rel=&quot;hequn8128&quot;&gt;hequn8128&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13084536">FLINK-7101</key>
            <summary>Fix Non-windowed group-aggregate error when using `minIdleStateRetentionTime` config and retract agg</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sunjincheng121">sunjincheng</assignee>
                                    <reporter username="sunjincheng121">sunjincheng</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Jul 2017 12:36:10 +0000</created>
                <updated>Mon, 17 Jul 2017 14:34:36 +0000</updated>
                            <resolved>Mon, 17 Jul 2017 14:34:36 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>1.3.1</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16073795" author="fhueske" created="Tue, 4 Jul 2017 15:06:54 +0000"  >&lt;p&gt;That&apos;s a good find &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunjincheng121&quot; class=&quot;user-hover&quot; rel=&quot;sunjincheng121&quot;&gt;sunjincheng121&lt;/a&gt; and a tricky question.&lt;/p&gt;

&lt;p&gt;I think the best strategy is to completely ignore retraction records if &lt;tt&gt;inputCnt == 0&lt;/tt&gt; or &lt;tt&gt;inputCnt == null&lt;/tt&gt;. &lt;br/&gt;
So I would actually exit the method before we modify the accumulator.&lt;/p&gt;

&lt;p&gt;In the long run, this problem might not occur anymore. &lt;br/&gt;
If all operators implement the state retention interval correctly, all keys without updates within some time should have been cleaned before they can sent a retraction to an operator with cleaned state. A previous operator would not be able to sent retraction after the cleanup interval because it would have to be cleaned before (not 100% sure about this, need to think about this a bit more). &lt;br/&gt;
This would also mean that each operator has to sent out updates even if the result does not change (the &lt;tt&gt;prevRow.row.equals(newRow.row)&lt;/tt&gt; check should be removed because it might cause state to be cleaned up too early).&lt;/p&gt;</comment>
                            <comment id="16074330" author="sunjincheng121" created="Wed, 5 Jul 2017 07:10:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt; I think:&lt;br/&gt;
1. We need the retraction records if &lt;tt&gt;inputCnt == 0&lt;/tt&gt;;&lt;br/&gt;
2. For current tableAPI/SQL, we should ignore retraction records if &lt;tt&gt;inputCnt &amp;lt; 0&lt;/tt&gt; (when cleanup state);&lt;br/&gt;
3. You are right we should change the condition {{ if (prevRow.row.equals(newRow.row)) }} to {{ if (prevRow.row.equals(newRow.row) &amp;amp;&amp;amp; !stateCleaningEnabled)}}&lt;/p&gt;

&lt;p&gt;BTW, if we can set the parallel of operator(in the future), we also need change the current build-in &lt;tt&gt;SumWithRetractAggFunction&lt;/tt&gt; getValue logic:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;override def getValue(acc: SumWithRetractAccumulator[T]): T = {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (acc.f1 &amp;gt; 0) { *====&amp;gt; acc.f1 != 0*
      acc.f0
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.asInstanceOf[T]
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The reason is:&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12875711/12875711_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;What do you think?&lt;br/&gt;
&lt;b&gt;Note: the Sum AGG not using in above example, the Sketch just show we need change the sum AGG logic.&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="16088576" author="githubbot" created="Sat, 15 Jul 2017 12:49:28 +0000"  >&lt;p&gt;GitHub user sunjincheng121 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4348&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7101&quot; title=&quot;Fix Non-windowed group-aggregate error when using `minIdleStateRetentionTime` config and retract agg&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7101&quot;&gt;&lt;del&gt;FLINK-7101&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; add condition of !stateCleaningEnabled is avoided&#8230;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; General&lt;/li&gt;
	&lt;li&gt;The pull request references the related JIRA issue (&quot;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7101&quot; title=&quot;Fix Non-windowed group-aggregate error when using `minIdleStateRetentionTime` config and retract agg&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7101&quot;&gt;&lt;del&gt;FLINK-7101&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; add condition of !stateCleaningEnabled is avoided non-grouped window state to be cleaned up too early&quot;)&lt;/li&gt;
	&lt;li&gt;The pull request addresses only one issue&lt;/li&gt;
	&lt;li&gt;Each commit in the PR has a meaningful commit message (including the JIRA id)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Documentation&lt;/li&gt;
	&lt;li&gt;Documentation has been added for new functionality&lt;/li&gt;
	&lt;li&gt;Old documentation affected by the pull request has been updated&lt;/li&gt;
	&lt;li&gt;JavaDoc for public methods has been added&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Tests &amp;amp; Build&lt;/li&gt;
	&lt;li&gt;Functionality added by the pull request is covered by tests&lt;/li&gt;
	&lt;li&gt;`mvn clean verify` has been executed successfully locally or a Travis build has passed&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/sunjincheng121/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sunjincheng121/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7101&quot; title=&quot;Fix Non-windowed group-aggregate error when using `minIdleStateRetentionTime` config and retract agg&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7101&quot;&gt;&lt;del&gt;FLINK-7101&lt;/del&gt;&lt;/a&gt;-PR&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4348.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4348.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4348&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 1c006299c8b8a169e346ef776cf9c5f5d7af20e0&lt;br/&gt;
Author: sunjincheng121 &amp;lt;sunjincheng121@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-15T11:43:30Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7101&quot; title=&quot;Fix Non-windowed group-aggregate error when using `minIdleStateRetentionTime` config and retract agg&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7101&quot;&gt;&lt;del&gt;FLINK-7101&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; add condition of !stateCleaningEnabled is avoided non-grouped window state to be cleaned up too early&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16089622" author="githubbot" created="Mon, 17 Jul 2017 10:44:51 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4348#discussion_r127677326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4348#discussion_r127677326&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/aggregate/GroupAggProcessFunction.scala &amp;#8212;&lt;br/&gt;
    @@ -131,7 +131,8 @@ class GroupAggProcessFunction(&lt;/p&gt;

&lt;p&gt;           // if this was not the first row and we have to emit retractions&lt;br/&gt;
           if (generateRetraction &amp;amp;&amp;amp; !firstRow) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (prevRow.row.equals(newRow.row)) {&lt;br/&gt;
    +        // the condition of !stateCleaningEnabled is avoided state to be cleaned up too early
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I would move the description into the `if` block and modify it as follows:&lt;br/&gt;
    ```&lt;br/&gt;
    // newRow is the same as before and state cleaning is not enabled. We do not emit retraction and acc message.&lt;br/&gt;
    // If state cleaning is enabled, we have to emit messages to prevent too early state eviction of downstream operators.&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16089625" author="fhueske" created="Mon, 17 Jul 2017 10:46:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunjincheng121&quot; class=&quot;user-hover&quot; rel=&quot;sunjincheng121&quot;&gt;sunjincheng121&lt;/a&gt;, is &lt;a href=&quot;https://github.com/apache/flink/pull/4348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #4348&lt;/a&gt; addressing the original problem of this JIRA, i.e., retraction messages after state cleanup or do we need additional changes to prevent this?&lt;/p&gt;

&lt;p&gt;Thanks, Fabian&lt;/p&gt;</comment>
                            <comment id="16089875" author="githubbot" created="Mon, 17 Jul 2017 14:01:24 +0000"  >&lt;p&gt;Github user sunjincheng121 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4348#discussion_r127715580&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4348#discussion_r127715580&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/aggregate/GroupAggProcessFunction.scala &amp;#8212;&lt;br/&gt;
    @@ -131,7 +131,8 @@ class GroupAggProcessFunction(&lt;/p&gt;

&lt;p&gt;           // if this was not the first row and we have to emit retractions&lt;br/&gt;
           if (generateRetraction &amp;amp;&amp;amp; !firstRow) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (prevRow.row.equals(newRow.row)) {&lt;br/&gt;
    +        // the condition of !stateCleaningEnabled is avoided state to be cleaned up too early
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Make sense to me.&lt;/p&gt;</comment>
                            <comment id="16089877" author="githubbot" created="Mon, 17 Jul 2017 14:02:53 +0000"  >&lt;p&gt;Github user sunjincheng121 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4348&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @fhueske Thanks  for the review. I&apos;ll address the description. and merge this PR.&lt;/p&gt;</comment>
                            <comment id="16089913" author="githubbot" created="Mon, 17 Jul 2017 14:33:00 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4348&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16089917" author="sunjincheng121" created="Mon, 17 Jul 2017 14:34:36 +0000"  >&lt;p&gt;Fixed in 1125122a75d25c3d3aa55d7f51d84ed25ee69c56 .&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12875711" name="screenshot-1.png" size="118403" author="sunjincheng121" created="Wed, 5 Jul 2017 07:09:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 18 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3h2un:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>