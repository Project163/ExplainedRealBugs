<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:07:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-24294] Resources leak in the StreamTask constructor</title>
                <link>https://issues.apache.org/jira/browse/FLINK-24294</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Since we are initializing a lot of resources in the StreamTask constructor like RecordWriter, timerServices, etc. it is possible that some of these resources remain open if the exception happens below the initialization in the same constructor.&lt;br/&gt;
So in my opinion, we have two choices here: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Avoiding allocation of resources in the constructor which allows us to do something like:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;StreamTask task = new StreamTask(); //no leaks if it fails
try { 
  task.init();
  ....
} finally {
  task.cleanUp();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;or we can rewrite a code in such a way that exception in any constructor(ex. StreamTask) guarantee releasing the earlier allocated resources in this constructor. But it is not so easy to implement(see. initialization of recordWriter in StreamTask constructor)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So perhaps it makes sense to separate creating object from initialization(allocation resources)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13401346">FLINK-24294</key>
            <summary>Resources leak in the StreamTask constructor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akalashnikov">Anton Kalashnikov</assignee>
                                    <reporter username="akalashnikov">Anton Kalashnikov</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 15 Sep 2021 09:57:32 +0000</created>
                <updated>Thu, 25 Nov 2021 08:01:31 +0000</updated>
                            <resolved>Thu, 25 Nov 2021 08:01:31 +0000</resolved>
                                    <version>1.14.0</version>
                                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17417991" author="pnowojski" created="Tue, 21 Sep 2021 08:53:02 +0000"  >&lt;p&gt;Aren&apos;t we already doing exactly &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/taskmanager/Task.java#L914:L946&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the first option mentioned by you&lt;/a&gt;? &lt;/p&gt;</comment>
                            <comment id="17429903" author="akalashnikov" created="Mon, 18 Oct 2021 09:17:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;, Not exactly. We had two problems:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Possible resource leak if the exception happens after the StreamTask was created.&lt;/li&gt;
	&lt;li&gt;Possible resource leak if the exception happens inside of the constructor of the StreamTask after some resources were allocated&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The first one is the more possible problem which has been reported a couple of times already and the fix for it was kind of straightforward. It is exactly what I fixed &lt;a href=&quot;#L914:L946].&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The second one is more tricky to resolve. I wanted to fix it at the same PR but after discussion, we decided to split that task into two because this problem requires a more complex solution and it is not so urgent as the first one. So this is ticket exactly about the problem inside of the constructor.&lt;/p&gt;</comment>
                            <comment id="17429931" author="pnowojski" created="Mon, 18 Oct 2021 10:43:26 +0000"  >&lt;p&gt;Ok, thanks for the explanation. Can you also elaborate what do you mean by:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;But it is not so easy to implement(see. initialization of recordWriter in StreamTask constructor)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;about releasing resources if a constructor throws an exception? Why is not to easy to implement?&lt;/p&gt;</comment>
                            <comment id="17432307" author="akalashnikov" created="Thu, 21 Oct 2021 09:22:43 +0000"  >&lt;p&gt;It is not easy because the easiest way to do so is to surround all resources allocation with try-catch block and if something goes wrong just close them before leaving the method. But we don&apos;t really know where exactly we failed so we need to check every resource at least for null and only then close it which lead to a high number of null-check condition and also it is not clear how to guarantee that the newly added resources will be handled at the same way. &lt;br/&gt;
We also can surround every resource with try-catch block but it is even more tricky because for example&#160;&#160;RecordWriters are collected to the list and if something happens when the list isn&apos;t empty we should close all RecordWriters correctly.&lt;/p&gt;

&lt;p&gt;In conclusion, it is not a difficult problem but it is something that we should think about how to do it correctly.&lt;/p&gt;</comment>
                            <comment id="17432327" author="zentol" created="Thu, 21 Oct 2021 09:45:41 +0000"  >&lt;p&gt;Isn&apos;t this something where the guava Closer can help? You can have a single try-catch block, each resource being created is added to the closer, on exception you close the closer which takes care of everything.&lt;/p&gt;</comment>
                            <comment id="17433746" author="pnowojski" created="Mon, 25 Oct 2021 12:59:28 +0000"  >&lt;p&gt;I also had something like guava&apos;s &lt;tt&gt;Closer&lt;/tt&gt; or our internal &lt;tt&gt;org.apache.flink.core.fs.CloseableRegistry&lt;/tt&gt; in mind while asking my previous question.&lt;/p&gt;</comment>
                            <comment id="17448998" author="dawidwys" created="Thu, 25 Nov 2021 08:01:31 +0000"  >&lt;p&gt;Fixed in:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master
	&lt;ul&gt;
		&lt;li&gt;0be100bca749a8bf20dc1690632480aa93e8a5e8..249683b25655e1c8c17f3ac01e7739e558df1f9b&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0uyao:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>