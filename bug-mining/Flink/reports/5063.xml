<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:52:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21132] BoundedOneInput.endInput is called when taking synchronous savepoint</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21132</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elkhand&quot; class=&quot;user-hover&quot; rel=&quot;elkhand&quot;&gt;elkhand&lt;/a&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; reported on project iceberg that &lt;tt&gt;BoundedOneInput.endInput&lt;/tt&gt; was &lt;a href=&quot;https://github.com/apache/iceberg/issues/2033#issuecomment-765864038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;called&lt;/a&gt; when &lt;a href=&quot;https://github.com/apache/iceberg/issues/2033#issuecomment-765557995&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;stopping job with savepoint&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I think it is a bug of Flink and was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14230&quot; title=&quot; Change the endInput call of the downstream operator to after the upstream operator closes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14230&quot;&gt;&lt;del&gt;FLINK-14230&lt;/del&gt;&lt;/a&gt;. The &lt;a href=&quot;https://github.com/apache/flink/pull/9854/files#diff-0c5fe245445b932fa83fdaf5c4802dbe671b73e8d76f39058c6eaaaffd9639faL577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;changes&lt;/a&gt; rely on &lt;tt&gt;StreamTask.afterInvoke&lt;/tt&gt; and &lt;tt&gt;OperatorChain.closeOperators&lt;/tt&gt; will only be invoked after &lt;b&gt;end of input&lt;/b&gt;. But that is not true long before after &lt;a href=&quot;https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=103090212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FLIP-34: Terminate/Suspend Job with Savepoint&lt;/a&gt;. Task could enter state called &lt;a href=&quot;https://github.com/apache/flink/blob/3a8e06cd16480eacbbf0c10f36b8c79a6f741814/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L467&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;b&gt;finished&lt;/b&gt;&lt;/a&gt; after synchronous savepoint, that is an expected job suspension and stopping.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunhaibotb&quot; class=&quot;user-hover&quot; rel=&quot;sunhaibotb&quot;&gt;sunhaibotb&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; Could you help confirm this ?&lt;/p&gt;

&lt;p&gt;For full context, see &lt;a href=&quot;https://github.com/apache/iceberg/issues/2033&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;apache/iceberg#2033&lt;/a&gt;. I have pushed branch &lt;a href=&quot;https://github.com/kezhuw/flink/commits/synchronous-savepoint-conflict-with-bounded-end-input-case&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;synchronous-savepoint-conflict-with-bounded-end-input-case&lt;/a&gt; in my repository. Test case &lt;tt&gt;SavepointITCase.testStopSavepointWithBoundedInput&lt;/tt&gt; failed due to &lt;tt&gt;BoundedOneInput.endInput&lt;/tt&gt; called.&lt;/p&gt;

&lt;p&gt;I am also aware of &lt;a href=&quot;https://cwiki.apache.org/confluence/x/mw-ZCQ&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FLIP-147: Support Checkpoints After Tasks Finished&lt;/a&gt;, maybe the three should align on what &lt;b&gt;finished&lt;/b&gt; means exactly. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkl0u&quot; class=&quot;user-hover&quot; rel=&quot;kkl0u&quot;&gt;kkl0u&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13354468">FLINK-21132</key>
            <summary>BoundedOneInput.endInput is called when taking synchronous savepoint</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="kezhuw">Kezhu Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 25 Jan 2021 15:20:04 +0000</created>
                <updated>Fri, 28 May 2021 08:17:23 +0000</updated>
                            <resolved>Wed, 3 Feb 2021 19:58:05 +0000</resolved>
                                    <version>1.10.2</version>
                    <version>1.10.3</version>
                    <version>1.11.3</version>
                    <version>1.12.1</version>
                                    <fixVersion>1.11.4</fixVersion>
                    <fixVersion>1.12.2</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="17271590" author="pnowojski" created="Mon, 25 Jan 2021 18:19:56 +0000"  >&lt;p&gt;Thanks for reporting and analysing the issue. Yes, I think you are right about describing the behaviour. I took a quick look at the code, and the problem seems to be in the &lt;tt&gt;StreamOperatorWrapper#close&lt;/tt&gt; method. It is called for every clean shutdown of the task, which AFAIK can be either:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;true end of input&lt;/li&gt;
	&lt;li&gt;stop with savepoint&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;And regardless of which of those two triggered the clean shutdown, end of input will be issued to every operator which is not head operator of the chain.&lt;/p&gt;

&lt;p&gt;Now depending how we should look at it, there is one of two bugs.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;If we assume stop with savepoint shouldn&apos;t trigger end of input, in that case non head operators shouldn&apos;t receive end of input.&lt;/li&gt;
	&lt;li&gt;If we assume stop with savepoint should trigger end of input, in that case head operator should receive end of input.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AHeise&quot; class=&quot;user-hover&quot; rel=&quot;AHeise&quot;&gt;AHeise&lt;/a&gt;, what do you think?&lt;/p&gt;</comment>
                            <comment id="17271592" author="pnowojski" created="Mon, 25 Jan 2021 18:22:39 +0000"  >&lt;p&gt;If the correct answer for 1., there seems to be a simple quickfix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; - disable operator chaining for the affected operators. If they are head operators, they wouldn&apos;t receive end of input at the moment. &lt;/p&gt;</comment>
                            <comment id="17271999" author="gaoyunhaii" created="Tue, 26 Jan 2021 09:23:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt;, very thanks for brought up this issue, I have some thoughts from the sink&apos;s perspective: I also think as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; said, there will be two cases, namely the job is indeed bounded and stop with savepoint.&#160;&lt;/p&gt;

&lt;p&gt;First of all, I think there would be some problem fro the current implementation that committed in endOfInput(), considering if the job is bounded (namely the first case). The problem is that if the failover happens right after commit() in the endOfInput, then the job will be restarted and fallback to the last checkpoint, which will cause replay of the data committed in endOfInput.&#160;&lt;a href=&quot;https://cwiki.apache.org/confluence/x/mw-ZCQ&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FLIP-147: Support checkpoint after tasks finished&lt;/a&gt;&#160;is a precedent step to solve the commit problem of the sinks in the first case. It tries to support checkpoints after some tasks finished (e.g., all the tasks before the sink are finished), and the expected behavior of the sink operator is&#160; &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;endOfInput (close all the opening files)&lt;/li&gt;
	&lt;li&gt;wait for a new checkpoint&lt;/li&gt;
	&lt;li&gt;snapshotState&lt;/li&gt;
	&lt;li&gt;notifyCheckpointComplete (here we would do the commit)&lt;/li&gt;
	&lt;li&gt;close().&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For the second case, namely stop with savepoint, the current process would be&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;snapshotState() for the savepoint&lt;/li&gt;
	&lt;li&gt;notifyCheckpointComplete() for the savepoint&lt;/li&gt;
	&lt;li&gt;possibly process some data&lt;/li&gt;
	&lt;li&gt;endOfInput()&lt;/li&gt;
	&lt;li&gt;close()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this case, the sink should still do not need to commit inside endOfInput() because all the state are expected to be committed in the second step, namely notifyCheckpointComplete(). &lt;/p&gt;

&lt;p&gt;The current issue to me might be that we do not solve the first case yet so that we would have to do some workaround, like commit in endOfInput()&lt;/p&gt;</comment>
                            <comment id="17272014" author="gaoyunhaii" created="Tue, 26 Jan 2021 09:57:08 +0000"  >&lt;p&gt;But for the final picture for sinks, there is indeed an issue that compared with the above two cases, whether a sink operator need to wait for another checkpoint is different in the above two cases, but based on the current implementation the operator would not be able to distinguish them.&lt;/p&gt;</comment>
                            <comment id="17272503" author="kezhuw" created="Wed, 27 Jan 2021 01:21:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; For option#2, which is the current option, head operator indeed receives end of input currently except for FLIP-27 source(see &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt;). For legacy source head operator, &lt;tt&gt;StreamSource&lt;/tt&gt; will fire end of input and &lt;tt&gt;Task&lt;/tt&gt; will write &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt; after successful run, this matches my previous description. For no source head operator, after received all &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt; for every subpartitions in input, &lt;tt&gt;StreamTaskNetworkInput&lt;/tt&gt; will report &lt;tt&gt;InputStatus.END_OF_INPUT&lt;/tt&gt; and &lt;tt&gt;StreamOneInputProcessor&lt;/tt&gt; will fire end of input, this matches what &lt;a href=&quot;https://github.com/apache/iceberg/issues/2033&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;apache/iceberg#2033&lt;/a&gt; happens in later discussion. So, basically, &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14228&quot; title=&quot;The runtime support for Bounded[One|Multi]Input#endInput does not properly implement their semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14228&quot;&gt;&lt;del&gt;FLINK-14228&lt;/del&gt;&lt;/a&gt; is well implemented, it just has assumption overrode by/conflict with FLIP-34.&lt;/p&gt;

&lt;p&gt;Personally, I prefer option#1 since save-with-savepoint is just an utility, it does not contribute to streaming data flow. I think maybe it could be implemented in a way that &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt; solved without additional work from source side.&lt;/p&gt;</comment>
                            <comment id="17272921" author="aljoscha" created="Wed, 27 Jan 2021 15:10:45 +0000"  >&lt;p&gt;It seems to me we just need to make sure that&#160;&lt;tt&gt;endOfInput()&lt;/tt&gt;&#160;is not called for the stop-with-savepoint case. That method must only be called when it is&#160;&lt;b&gt;truly&lt;/b&gt;&#160;the end of input, that is when the source and all the predecessor operators have shut down. What do you think? With this, the Jira Issue should be easy enough to fix.&lt;/p&gt;</comment>
                            <comment id="17273052" author="kezhuw" created="Wed, 27 Jan 2021 17:45:26 +0000"  >&lt;p&gt;I did not find an easy/viable way to distinguish truly end of input from stop-with-savepoint style end of input. They are both &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt; in network. Legacy sources could also emit elements between synchronous savepoint and &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt;.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;that is when the source and all the predecessor operators have shut down.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;How this could be viable for, say, a no chained head operator ? AFAIK, no chained operator has only two inputs from outside: rpc call through &lt;tt&gt;TaskExecutorGateway&lt;/tt&gt; and stream elements and events from predecessor operators through input channel. I saw only &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt; related.&lt;/p&gt;

&lt;p&gt;I think stop-with-savepoint has enough room to operate on &lt;b&gt;all tasks&lt;/b&gt; not just &lt;b&gt;source tasks&lt;/b&gt; without interfering with data flow upon &lt;tt&gt;StreamTask.notifyCheckpointComplete&lt;/tt&gt;. I could give an simple(probably not ideal) solution, let &lt;tt&gt;Task&lt;/tt&gt; query &lt;tt&gt;AbstractInvokable&lt;/tt&gt; to know whether it should &lt;b&gt;finish&lt;/b&gt; partition writers after successful run. This way &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt; is solved also.&lt;/p&gt;</comment>
                            <comment id="17274306" author="roman_khachatryan" created="Fri, 29 Jan 2021 10:37:27 +0000"  >&lt;p&gt;I think it would be risky to change the behaviour of endOfInput. Existing operators may rely on it being called even in case of stopWithSavepoint.&lt;/p&gt;

&lt;p&gt;Instead, I&apos;d propose to add a new interface&#160;StopWithSavepointAware { void stoppedWithSavepoint(); } and call this method for operators implementing it and endInput otherwise. Also in case of &quot;true&quot; end of input the old method would be called.&lt;/p&gt;

&lt;p&gt;Then IcebergFilesCommitter should implement it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To distinguish true end-of-input from stop-with-savepoint we can rely purely on checkpoint properties:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Sources receive sync-savepoint RPC and only then call operatorChain.close / endInput&lt;/li&gt;
	&lt;li&gt;Downstreams must receive and confirm the checkpoint before getting EOP from source&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So in both cases it&apos; enough to remember that a sync-savepoint was received.&lt;/p&gt;

&lt;p&gt;Alternative approach is quite invasive as it in addition would change Task, AbstractInvokable, passing and interprting EOP event.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve prepared a prototype here: &lt;a href=&quot;https://github.com/rkhachatryan/flink/tree/f21132&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rkhachatryan/flink/tree/f21132&lt;/a&gt;. It uses &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt;&#160;IT case (thanks for providing it!).&lt;/p&gt;

&lt;p&gt;It doesn&apos;t solve FLIP-27 issue but I think&#160;FLIP-27 should be addressed separately.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="17274380" author="kezhuw" created="Fri, 29 Jan 2021 12:04:00 +0000"  >&lt;p&gt;If we agree that stop-with-savepoint should not pretending it is an &lt;tt&gt;END_OF_INPUT&lt;/tt&gt;, I would suggest a new checkpoint type &lt;tt&gt;END_OF_INPUT_SAVEPOINT&lt;/tt&gt;. This way I think we could mitigate the effect progressive. For existing major version, defaults &lt;tt&gt;flink stop&lt;/tt&gt; to &lt;tt&gt;flink stop --end-of-input&lt;/tt&gt;, for future major version, defaults to &lt;tt&gt;flink stop --no-end-of-input&lt;/tt&gt;. I am kind of against &lt;tt&gt;StopWithSavepointAware&lt;/tt&gt; for solely solving this unless we have concretes usages which probably will not interfering with &lt;tt&gt;END_OF_INPUT&lt;/tt&gt; also.&lt;/p&gt;</comment>
                            <comment id="17274459" author="aljoscha" created="Fri, 29 Jan 2021 14:00:36 +0000"  >&lt;p&gt;I&apos;ll try and expand on what I wrote earlier. The TL;DR is that I still think sending an &lt;tt&gt;endOfInput()&lt;/tt&gt; to operators on a stop-with-savepoint is a bug.&lt;/p&gt;

&lt;p&gt;I differentiate between two different end-of-inputs: 1) &lt;em&gt;physical&lt;/em&gt; end-of-input, and 2) &lt;em&gt;logical/semantical&lt;/em&gt; end-of-input. The former is signalled when, for example, a network connection is being shut down. The latter happens (should happen) when (bounded) sources have no more data to read and this information propagates through the pipeline. The motivation for introducing &lt;tt&gt;endOfInput()&lt;/tt&gt; were things like hash-join in the SQL runner where an operator would read from the build side until getting an end-of-input, at which point it would switch over to reading from the probe side. With these use cases in mind sending an &lt;tt&gt;endOfInput()&lt;/tt&gt; is a bug. The same is true for sinks, which will do some bookkeeping based on knowing that all the input data has been read.&lt;/p&gt;

&lt;p&gt;I don&apos;t see use cases where operators would be interested in being notified of the physical end-of-input right now. I could be wrong, of course. &#128517;&lt;/p&gt;</comment>
                            <comment id="17274517" author="pnowojski" created="Fri, 29 Jan 2021 15:24:55 +0000"  >&lt;p&gt;I agree with &lt;tt&gt;endOfInput&lt;/tt&gt; should NOT be called in case of stop with savepoint. IMO adding another interface &lt;tt&gt;StopWithSavepointAware&lt;/tt&gt; for the sake of backward compatibility would unnecessarily complicate our APIs.&lt;/p&gt;

&lt;p&gt;After offline discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;, probably the easiest way to do, would be to just suppress &lt;tt&gt;endOfInput&lt;/tt&gt; calls somewhere in the &lt;tt&gt;OperatorChain&lt;/tt&gt; or &lt;tt&gt;StreamOperatorWrapper&lt;/tt&gt; if we know we are waiting for the stop with savepoint. It&apos;s not ideal, but adding an extra even to distinguish between &lt;tt&gt;END_OF_INPUT&lt;/tt&gt; and &lt;tt&gt;STOP_WITH_SAVEPOINT&lt;/tt&gt; would be quite invasive change.&lt;/p&gt;</comment>
                            <comment id="17274538" author="roman_khachatryan" created="Fri, 29 Jan 2021 16:09:21 +0000"  >&lt;p&gt;Thanks for your feedback &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt;&#160;. I&apos;ve also discussed it offline with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We agreed that endInpt should NOT be called (no operators should rely on it, if any do they should be fixed).&lt;/p&gt;

&lt;p&gt;(so no StopWithSavepointAware needed)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As for the detection (stop-with-savepoint vs other cases), we agree the proposed solution isn&apos;t ideal.&#160;However, it&apos;s much less invasive and we&apos;d like to provide fix ASAP so we lean toward it.&lt;/p&gt;

&lt;p&gt;I&apos;m adjusting it to all cases of chaining (these are different code paths).&lt;/p&gt;</comment>
                            <comment id="17275234" author="kezhuw" created="Fri, 29 Jan 2021 18:14:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&#160; We all actually are on the same page. So, all above approaches are feasible to me as long as there is no api level bug-specific solution.&lt;/p&gt;

&lt;p&gt;But I am kind of preferring to not sending &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt;, so I would like to present my &lt;a href=&quot;https://github.com/apache/flink/commit/d6c6837cd724913716007265f03a50098bee985e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;local work&lt;/a&gt; for another approach. Here is a summary for the changes:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;StopTaskException&lt;/tt&gt; to throw from &lt;tt&gt;AbstractInvokable.invoke&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Upon receiving savepoint completion, stop task with savepoint. This stop phase is same for mailbox model, so &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt; does not exist anymore.&lt;/li&gt;
	&lt;li&gt;After run out of mailbox loop, check whether it is stopped by a savepoint. If it is, throws &lt;tt&gt;StopTaskException&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;If &lt;tt&gt;StopTaskException&lt;/tt&gt; happens, &lt;tt&gt;Task.doRun&lt;/tt&gt; will not finish result partition(hence no EndOfPartitionEvent), but still transit task to finished state(I am not sure it is conflict with FLIP-147 or not as I saw &quot;Reuse Tasks&apos; FINISH status&quot;).&lt;/li&gt;
	&lt;li&gt;Other works: generalize &lt;tt&gt;SteamTask.finishTask&lt;/tt&gt; to all stream task but not only source tasks; generalize &lt;tt&gt;StreamTask.cancelTask&lt;/tt&gt; to mailbox model.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The benefits of this approach is that:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;It does not sending &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt; anymore. There will be only true end of input.&lt;/li&gt;
	&lt;li&gt;If finished status caused by stop-with-savepoint is conflict with FLIP-147, then it is easy to change to new status.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt; solved with no extra work.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;There is one user-notable breaking change: &lt;tt&gt;SreamOperator.close&lt;/tt&gt; will not be called in case of stop-with-savepoint.&lt;/p&gt;

&lt;p&gt;Last, feel free to choice either approach, it is just my personal preference&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, and I don&apos;t take any compatibility/invasiveness into account.&lt;/p&gt;</comment>
                            <comment id="17276169" author="roman_khachatryan" created="Mon, 1 Feb 2021 09:18:21 +0000"  >&lt;p&gt;Thanks for your proposal &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I took a look at it and I have some concerns:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;EoP is needed to stop the job eventually. I expect that with his fix, job will stuck after stop with chaining disabled. Am I missing something?&lt;/li&gt;
	&lt;li&gt;Using exceptions for flow control is error-prone. We had quite some issues with exactly this logic in the past&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If I remember correctly (the link doesn&apos;t work now), it adds some boolean flags too in addition to chaning error handling. So it doesn&apos;t seem to me &quot;no extra work&quot;.&lt;/p&gt;</comment>
                            <comment id="17276235" author="kezhuw" created="Mon, 1 Feb 2021 10:19:02 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;, thanks for reviewing, let me detail:&lt;br/&gt;
 1. The key change this proposal made is &lt;b&gt;making old &lt;tt&gt;StreamTask.finishTask&lt;/tt&gt;(renaming to &lt;tt&gt;StreamTask.cancelTask&lt;/tt&gt;) works for all tasks but not only source tasks&lt;/b&gt;. So this will works as long as we fire checkpoint-complete on all tasks. Before this change, &lt;tt&gt;StreamTask.finishTask&lt;/tt&gt; is an nop on no source tasks.&lt;br/&gt;
 2. &lt;tt&gt;StopTaskException&lt;/tt&gt; is just like &lt;tt&gt;CancelTaskException&lt;/tt&gt;, but got different treatment in &lt;tt&gt;Task.doRun&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;3. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt; is about FLIP-27 source, which is &lt;tt&gt;SourceOperatorStreamTask&lt;/tt&gt; but not &lt;tt&gt;SourceStreamTask&lt;/tt&gt;. &lt;tt&gt;SourceStreamTask&lt;/tt&gt; get special treatment in old solution also.&lt;/p&gt;

&lt;p&gt;I would like list changes in running order:&lt;br/&gt;
 1. Up receiving &lt;tt&gt;notifyCheckpointComplete&lt;/tt&gt;, it stops current task no matter whether it is a source or not. This operator will cause mailbox loop run out.&lt;br/&gt;
 2. After stopping current task, it set &lt;tt&gt;stopWithSavepointId&lt;/tt&gt; for later usage.&lt;br/&gt;
 3. After mailbox loop run out, if &lt;tt&gt;stopWithSavepointId&lt;/tt&gt; is set, throw &lt;tt&gt;StopTaskException&lt;/tt&gt;.&lt;br/&gt;
 4. &lt;tt&gt;Task.doRun&lt;/tt&gt; will skip result partition finishing(eg. firing EoP) if &lt;tt&gt;StopTaskException&lt;/tt&gt; is captured.&lt;/p&gt;

&lt;p&gt;Another observation, I think current behavior(source EoP) may not work with FLIP-147 which allows no-source heading operator.&lt;/p&gt;</comment>
                            <comment id="17276297" author="roman_khachatryan" created="Mon, 1 Feb 2021 12:51:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; , thanks for the clarification.&lt;/p&gt;

&lt;p&gt;I&apos;m concerned about the order in which tasks would terminate. If we rely on checkpoint completion notifications for that then downstream can terminate before upstream which can fail the job if there are any more data.&lt;/p&gt;

&lt;p&gt;I see that&#160;StopTaskException is similar to&#160;CancelTaskException but adding more logic like&#160;CancelTaskException is what I&apos;d like to avoid &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;Maybe others won&apos;t agree with me though.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also we are discussing an issue of potentially missing endInput if a true end-of-input is encountered after sync-savepoint but before job termination. It looks like the above approach is also subject to it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17276558" author="kezhuw" created="Mon, 1 Feb 2021 18:24:56 +0000"  >&lt;p&gt;Currently, there is no &lt;tt&gt;runSynchronousSavepointMailboxLoop&lt;/tt&gt; in &lt;tt&gt;StreamTask.triggerCheckpoint&lt;/tt&gt;, but let&apos;s assume it has.&lt;/p&gt;

&lt;p&gt;For mailbox tasks, it will not handle any mail until checkpoint confirmation. After checkpoint completion, poison mail will break out mailbox loop. I did not find a hole in between since there is no chance to read/write.&lt;/p&gt;

&lt;p&gt;For legacy source, thing get complicated. I would like to list an example body for &lt;tt&gt;SourceFunction&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run(SourceContext&amp;lt;T&amp;gt; ctx) {
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (isRunning &amp;amp;&amp;amp; condition) {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; block ensures that state checkpointing,
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// internal state updates and emission of elements are an atomic operation
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (ctx.getCheckpointLock()) {
            ctx.collect(count);
            count++;
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ol&gt;
	&lt;li&gt;If checkpoint comes before &lt;tt&gt;synchronized&lt;/tt&gt;, after checkpoint completion, &lt;tt&gt;ctx.collect&lt;/tt&gt; will throw exception, but it is covered by &lt;tt&gt;isStopped()&lt;/tt&gt; in &lt;tt&gt;SourceStreamTask&lt;/tt&gt;, and exception is ignored in this case.&lt;/li&gt;
	&lt;li&gt;If checkpoint comes after &lt;tt&gt;synchronized&lt;/tt&gt; and source function run out, it could finish the thread which cause poison mail. But poison mail actually only break out mailbox loop itself, but not &lt;tt&gt;MailboxExecutor.yield&lt;/tt&gt; loop. So still wait for checkpoint completion, and from now, it is actually same as mailbox tasks as there is no concurrent thread now. The only hole I saw is in &lt;tt&gt;StreamSource&lt;/tt&gt;, where executes endInput after &lt;tt&gt;SourceFunction.run&lt;/tt&gt;. I think we could move it to &lt;tt&gt;SourceStreamTask.afterInvoke&lt;/tt&gt; if we want to keep this theoretical possibility.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think some of above apply to eop-detection approach too, hope it could help.&lt;/p&gt;</comment>
                            <comment id="17277083" author="pnowojski" created="Tue, 2 Feb 2021 12:30:54 +0000"  >&lt;p&gt;I&apos;m sharing the same concern as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; about controlling the flow using the exception, but that could be easily changed in your version &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I think the larger difference is that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&apos;s proposal is doing the clean shutdown, via &lt;tt&gt;StreamTask#afterInvoke&lt;/tt&gt;, but just set&apos;s the flag to not invoke &lt;tt&gt;endOfInput&lt;/tt&gt;. While &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; approach is re-using the cancellation/failure code path of shutting down. Bypassing &lt;tt&gt;afterInvoke&lt;/tt&gt; seems simpler, as it doesn&apos;t require changes in the &lt;tt&gt;OperatorChain&lt;/tt&gt; and &lt;tt&gt;StreamOperatorWrapper&lt;/tt&gt; classes. Maybe the appropriate question would be:&lt;/p&gt;

&lt;p&gt;Do we want to do the proper shutdown procedure for stopping with savepoint? For example quiescing the timer service, potentially processing some records, finally calling &lt;tt&gt;close()&lt;/tt&gt; on the operator, flushing the outputs - all of that while we have already decided to successfully stop with savepoint?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;For mailbox tasks, it will not handle any mail until checkpoint confirmation. After checkpoint completion, poison mail will break out mailbox loop. I did not find a hole in between since there is no chance to read/write.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The question is also how to handle situations when stop with savepoint has been cancelled because savepoint failed (for example it was declined as there was a race condition with some source finishing and sending &lt;tt&gt;END_OF_PARITTION&lt;/tt&gt; event while CheckpointCoordinator was triggering stop with savepoint).&lt;/p&gt;</comment>
                            <comment id="17277160" author="pnowojski" created="Tue, 2 Feb 2021 14:36:21 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I&apos;m concerned about the order in which tasks would terminate. If we rely on checkpoint completion notifications for that then downstream can terminate before upstream which can fail the job if there are any more data.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;ve discussed this concern offline with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;. Probably when downstream terminates before the upstream would not cause job failure, but in your proposal &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; bad things can happen. The root cause of problems is that you are shutting down tasks from &lt;tt&gt;notifyCheckpointCompleted&lt;/tt&gt; call, while both current solution in the master and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; proposal is relaying on clean shutdown after receiving &lt;tt&gt;END_OF_PARTITION&lt;/tt&gt; events. So the shutdown happens from the heads/sources to tails/sinks.&lt;/p&gt;

&lt;p&gt;Keep in mind that while task is spinning inside &lt;tt&gt;runSynchronousSavepointMailboxLoop&lt;/tt&gt;, it&apos;s not processing inputs BUT it can be producing output via mailbox actions (processing time timers firing &lt;tt&gt;WindowOperator&lt;/tt&gt;, or just emitting records from the mailbox action like &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; or &lt;tt&gt;ContinuousFileReaderOperator&lt;/tt&gt; are doing). Rarely this can cause a back-pressure to happen and task might be stuck inside &lt;tt&gt;runSynchronousSavepointMailboxLoop&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Now in your proposal &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; if downstream task receives &lt;tt&gt;notifyCheckpointCompleted&lt;/tt&gt; before the upstream, there will be nobody to relieve the upstream task from the backpressure and upstream task would be deadlocked, not able to process &lt;tt&gt;notifyCheckpointCompleted&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It&apos;s not ideal what we have at the moment, in the future we might decide to shut down earlier, without waiting for &lt;tt&gt;END_OF_PARTITION&lt;/tt&gt; to travel through all of the job graph, but that would have to be a separate story, independent of this bug fix.&lt;/p&gt;</comment>
                            <comment id="17277171" author="kezhuw" created="Tue, 2 Feb 2021 14:52:11 +0000"  >&lt;p&gt;You are right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;, it depends on whether we want do normal/successful/close/endOfInputStyle shutdown or exceptional/dispose shutdown for stop-with-savepoint. As I noted, it is a breaking change comparing to old behavior. It is kind of an api contract whether &lt;tt&gt;StreamOperator.close&lt;/tt&gt; should be invoked in not end of input case.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The question is also how to handle situations when stop with savepoint has been cancelled because savepoint failed&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for mention this, I saw a hole in &lt;tt&gt;notifyCheckpointAbortAsync&lt;/tt&gt; where there is no &lt;tt&gt;resetSynchronousSavepointId&lt;/tt&gt;. I will verify it using test case.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;it was declined as there was a race condition with some source finishing and sending END_OF_PARITTION event while CheckpointCoordinator was triggering stop with savepoint&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;In this case, there will be not savepoint at downstream, right ?&lt;/p&gt;

&lt;p&gt;Besides, I only saw END_OF_PARTITION in &lt;tt&gt;Task.doRun&lt;/tt&gt; after successful &lt;tt&gt;AbstractInvokable.invoke&lt;/tt&gt;. Is there any other paths ?&lt;/p&gt;</comment>
                            <comment id="17277194" author="kezhuw" created="Tue, 2 Feb 2021 15:13:56 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Keep in mind that while task is spinning inside &lt;tt&gt;runSynchronousSavepointMailboxLoop&lt;/tt&gt;, it&apos;s not processing inputs BUT it can be producing output via mailbox actions (processing time timers firing &lt;tt&gt;WindowOperator&lt;/tt&gt;, or just emitting records from the mailbox action like &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; or &lt;tt&gt;ContinuousFileReaderOperator&lt;/tt&gt; are doing). &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;tt&gt;StreamTask.{{runSynchronousSavepointMailboxLoop&lt;/tt&gt;}} uses &lt;tt&gt;TaskMailbox.MAX_PRIORITY&lt;/tt&gt;, I expect that there will be no client firing activities.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Rarely this can cause a back-pressure to happen and task might be stuck inside &lt;tt&gt;runSynchronousSavepointMailboxLoop&lt;/tt&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is this an expected behavior by &lt;tt&gt;CheckpointType.isSynchronous&lt;/tt&gt; ?&lt;/p&gt;

&lt;p&gt;I would consider stop-with-savepoint is a destructive operation, right ? I saw &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21030&quot; title=&quot;Broken job restart for job with disjoint graph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21030&quot;&gt;&lt;del&gt;FLINK-21030&lt;/del&gt;&lt;/a&gt;, the discussion leans global failover if stop-with-savepoint failed.&lt;/p&gt;</comment>
                            <comment id="17277199" author="kezhuw" created="Tue, 2 Feb 2021 15:20:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;It&apos;s not ideal what we have at the moment, in the future we might decide to shut down earlier, without waiting for END_OF_PARTITION to travel through all of the job graph, but that would have to be a separate story, independent of this bug fix.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; I think what we are currently discuss is far beyond this bug, but another possibility, right &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;?&#160; For this bug fix, I also think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&apos;s approach is less invasive.&lt;/p&gt;</comment>
                            <comment id="17277207" author="pnowojski" created="Tue, 2 Feb 2021 15:27:25 +0000"  >&lt;p&gt;Ehhh, small edit from my side. I think I was wrong in our small part:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Keep in mind that while task is spinning inside runSynchronousSavepointMailboxLoop, it&apos;s not processing inputs BUT it can be producing output via mailbox actions&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think this is not true. But I think because we are not blocking sources from producing records while waiting for stop with savepoint, I think the rest of my post might be still valid. Downstream task would need to relieve source&apos;s backpressure?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;For this bug fix, I also think Roman Khachatryan&apos;s approach is less invasive.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Regardless of my above mistake, I agree with this. For bug fix that we will be back-porting to other releases, it would be safer to keep the current behaviour.&lt;/p&gt;</comment>
                            <comment id="17277217" author="kezhuw" created="Tue, 2 Feb 2021 15:53:40 +0000"  >&lt;blockquote&gt;
&lt;p&gt;there will be nobody to relieve the upstream task from the backpressure and upstream task would be deadlocked, not able to process notifyCheckpointCompleted.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think data flow and gateway event are go through different network channel.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I&apos;m concerned about the order in which tasks would terminate. If we rely on checkpoint completion notifications for that then downstream can terminate before upstream which can fail the job if there are any more data.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; I am also kind of worried about this. The stack is kind of big to figure out in days. I am still engaging in Flink. The discussion helps a lot&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. So, thanks!&lt;/p&gt;</comment>
                            <comment id="17277719" author="pnowojski" created="Wed, 3 Feb 2021 06:23:01 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I think data flow and gateway event are go through different network channel.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Data flow and events between TaskManagers are using the same channels. RPCs from JobManager to the TaskManagers are using a different channel, but they won&apos;t be processed if the Task&apos;s thread (mailbox) is blocked. To avoid deadlocks one would have to carefully thought this through.&lt;/p&gt;</comment>
                            <comment id="17278329" author="pnowojski" created="Wed, 3 Feb 2021 19:58:05 +0000"  >&lt;p&gt;Merged to master as &lt;span class=&quot;error&quot;&gt;&amp;#91;1c19ab7dc6f^^^..1c19ab7dc6f&amp;#93;&lt;/span&gt;&lt;br/&gt;
Merged to release-1.12 as &lt;span class=&quot;error&quot;&gt;&amp;#91;62081af01e1^^^..62081af01e1&amp;#93;&lt;/span&gt;&lt;br/&gt;
Merged to release-1.11 as &lt;span class=&quot;error&quot;&gt;&amp;#91;299820a33c1^^^..299820a33c1&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17281563" author="kezhuw" created="Tue, 9 Feb 2021 06:25:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;I saw a hole in notifyCheckpointAbortAsync where there is no resetSynchronousSavepointId. I will verify it using test case. &#8211; from me&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; This does not hold as &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; will fail the job(&lt;tt&gt;CheckpointFailureManager.handleSynchronousSavepointFailure&lt;/tt&gt;) after synchronous-savepoint(eg. stop-with-savepoint) failure. But the causal chain is a bit long, so I suggest to &lt;tt&gt;resetSynchronousSavepointId&lt;/tt&gt; always. &lt;a href=&quot;https://github.com/apache/flink/pull/14815/files#diff-0c5fe245445b932fa83fdaf5c4802dbe671b73e8d76f39058c6eaaaffd9639faR1080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pr#14815&lt;/a&gt; already have this, so there is no more concern from my side.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Data flow and events between TaskManagers are using the same channels. RPCs from JobManager to the TaskManagers are using a different channel, but they won&apos;t be processed if the Task&apos;s thread (mailbox) is blocked.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I probably use wrong words. I use &quot;data flow&quot; to represent &lt;tt&gt;StreamElement&lt;/tt&gt; and &lt;tt&gt;RuntimeEvent&lt;/tt&gt;(including &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt;, &lt;tt&gt;CheckpointBarrier&lt;/tt&gt;, etc.) and &quot;gateway event&quot; to represent &lt;tt&gt;TaskExecutorGateway.triggerCheckpoint/confirmCheckpoint&lt;/tt&gt; which are rpc methods. I think we are aligned on this.&lt;/p&gt;

&lt;p&gt;Checkpoint completion and cancellation are delivered using &lt;tt&gt;TaskMailbox.MAX_PRIORITY&lt;/tt&gt;, so they will be processed along with other control-mails in &lt;tt&gt;runSynchronousSavepointMailboxLoop&lt;/tt&gt;. I don&apos;t think either approach change this part of code, so if there is deadlock after, it probably exists before.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;To avoid deadlocks one would have to carefully thought this through.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Is it worth another dedicated issue to discuss this no end-of-partition style stop-with-savepoint ? I see values of this approach:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;It is applicable to mailbox model. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt; could be fixed without touch FLIP-27 source code. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt; may be relative complicated due to source chaining with multiple input stream. Though, I think this could also be achieved in end-of-partition style by rearranging &lt;tt&gt;StreamTask.finishTask&lt;/tt&gt; to path from &lt;tt&gt;StreamTask.triggerCheckpointAsync&lt;/tt&gt;, but this will need more bookkeeping.&lt;/li&gt;
	&lt;li&gt;Clean code ? We don&apos;t need end-of-input detection during stop-with-savepoint. It could be tangled/confused in evaluation data-flow during stop-with-savepoint in future, eg. why end-of-input and then stripping of them.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17285195" author="pnowojski" created="Tue, 16 Feb 2021 13:30:58 +0000"  >&lt;blockquote&gt;
&lt;p&gt;To avoid deadlocks one would have to carefully thought this through.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;By this I meant a solution where downstream task is closing before processing some kind of end of partition event is dangerous and can lead to deadlocks.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Is it worth another dedicated issue to discuss this no end-of-partition style stop-with-savepoint ? I see values of this approach&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think it would be cleaner in the &lt;tt&gt;StreamTask&lt;/tt&gt;. Currently &lt;tt&gt;StreamTask&lt;/tt&gt; is maintaining &lt;tt&gt;OperatorChain#isStoppingBySyncSavepoint&lt;/tt&gt; based on the currently ongoing savepoint, and is using this to decide whether to mute the &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt; or not. If we had a dedicated event similar to the &lt;tt&gt;EndOfPartitionEvent&lt;/tt&gt;, but one that would convey &quot;this is not end of input, but we are closing&quot;, the &lt;tt&gt;StreamTask&lt;/tt&gt; and &lt;tt&gt;OperatorChain&lt;/tt&gt; would be cleaner. &lt;/p&gt;

&lt;p&gt;However we would add a bit of complexity in the network stack (another event to support). Also currently we are discussing that we might need to introduce &lt;a href=&quot;https://github.com/apache/flink/pull/14831#issuecomment-774642652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;some kind of handshake when closing&lt;/a&gt;. I&apos;m not sure how a combined solution for both problems would look like. &lt;/p&gt;

&lt;p&gt;&lt;b&gt;edit: let&apos;s move this discussion to the &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt;&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="17289943" author="pnowojski" created="Wed, 24 Feb 2021 14:02:21 +0000"  >&lt;p&gt;For any watchers of this issue, we made a mistake to always ignore endOfInput calls when stopping with savepoint. When using &lt;tt&gt;stop-with-savepoint --drain&lt;/tt&gt; the &lt;tt&gt;endOfInput&lt;/tt&gt; should be called, as the intention is to terminate the job and drain all of the buffered records. Bug and fix: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21453&quot; title=&quot;BoundedOneInput.endInput is NOT called when doing stop with savepoint WITH drain&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21453&quot;&gt;&lt;del&gt;FLINK-21453&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13360289">FLINK-21453</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0myso:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>endInput() is not called anymore (on BoundedOneInput and BoundedMultiInput) when the job is stopping with savepoint.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>