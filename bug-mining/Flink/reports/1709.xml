<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6612] ZooKeeperStateHandleStore does not guard against concurrent delete operations</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6612</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;ZooKeeperStateHandleStore&lt;/tt&gt; does not guard against concurrent delete operations which could happen in case of a lost leadership and a new leadership grant. The problem is that checkpoint nodes can get deleted even after they have been recovered by another &lt;tt&gt;ZooKeeperCompletedCheckpointStore&lt;/tt&gt;. This corrupts the recovered checkpoint and thwarts future recoveries.&lt;/p&gt;

&lt;p&gt;I propose to add reference counting to the &lt;tt&gt;ZooKeeperStateHandleStore&lt;/tt&gt;. That way, we can monitor how many concurrent processes have a hold on a given checkpoint node. Only if the reference count reaches &lt;tt&gt;0&lt;/tt&gt;, we are allowed to delete the checkpoint node and dispose the checkpoint data.&lt;/p&gt;

&lt;p&gt;Stephan proposed to use ephemeral child nodes to track the reference count of a checkpoint node. That way we are sure that locks on the a checkpoint node are released in case of &lt;tt&gt;JobManager&lt;/tt&gt; failures.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13072746">FLINK-6612</key>
            <summary>ZooKeeperStateHandleStore does not guard against concurrent delete operations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 May 2017 09:32:09 +0000</created>
                <updated>Fri, 19 May 2017 10:09:42 +0000</updated>
                            <resolved>Fri, 19 May 2017 10:09:42 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16015629" author="githubbot" created="Thu, 18 May 2017 11:46:23 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3939&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6612&quot; title=&quot;ZooKeeperStateHandleStore does not guard against concurrent delete operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6612&quot;&gt;&lt;del&gt;FLINK-6612&lt;/del&gt;&lt;/a&gt; Allow ZooKeeperStateHandleStore to lock created ZNodes&lt;/p&gt;

&lt;p&gt;    In order to guard against deletions of ZooKeeper nodes which are still being used&lt;br/&gt;
    by a different ZooKeeperStateHandleStore, we have to introduce a locking mechanism.&lt;br/&gt;
    Only after all ZooKeeperStateHandleStores have released their lock, the ZNode is&lt;br/&gt;
    allowed to be deleted.&lt;/p&gt;

&lt;p&gt;    THe locking mechanism is implemented via ephemeral child nodes of the respective&lt;br/&gt;
    ZooKeeper node. Whenever a ZooKeeperStateHandleStore wants to lock a ZNode, thus,&lt;br/&gt;
    protecting it from being deleted, it creates an ephemeral child node. The node&apos;s&lt;br/&gt;
    name is unique to the ZooKeeperStateHandleStore instance. The delete operations&lt;br/&gt;
    will then only delete the node if it does not have any children associated.&lt;/p&gt;

&lt;p&gt;    In order to guard against oprhaned lock nodes, they are created as ephemeral nodes.&lt;br/&gt;
    This means that they will be deleted by ZooKeeper once the connection of the&lt;br/&gt;
    ZooKeeper client which created the node timed out.&lt;/p&gt;

&lt;p&gt;    cc @StefanRRichter&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; addZooKeeperRefCounting&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3939.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3939.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3939&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit def077a8d95921645733169d420d548842dde257&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-05-17T12:52:04Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6612&quot; title=&quot;ZooKeeperStateHandleStore does not guard against concurrent delete operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6612&quot;&gt;&lt;del&gt;FLINK-6612&lt;/del&gt;&lt;/a&gt; Allow ZooKeeperStateHandleStore to lock created ZNodes&lt;/p&gt;

&lt;p&gt;    In order to guard against deletions of ZooKeeper nodes which are still being used&lt;br/&gt;
    by a different ZooKeeperStateHandleStore, we have to introduce a locking mechanism.&lt;br/&gt;
    Only after all ZooKeeperStateHandleStores have released their lock, the ZNode is&lt;br/&gt;
    allowed to be deleted.&lt;/p&gt;

&lt;p&gt;    THe locking mechanism is implemented via ephemeral child nodes of the respective&lt;br/&gt;
    ZooKeeper node. Whenever a ZooKeeperStateHandleStore wants to lock a ZNode, thus,&lt;br/&gt;
    protecting it from being deleted, it creates an ephemeral child node. The node&apos;s&lt;br/&gt;
    name is unique to the ZooKeeperStateHandleStore instance. The delete operations&lt;br/&gt;
    will then only delete the node if it does not have any children associated.&lt;/p&gt;

&lt;p&gt;    In order to guard against oprhaned lock nodes, they are created as ephemeral nodes.&lt;br/&gt;
    This means that they will be deleted by ZooKeeper once the connection of the&lt;br/&gt;
    ZooKeeper client which created the node timed out.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16015647" author="githubbot" created="Thu, 18 May 2017 12:08:30 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3940&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3940&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;backport 1.3&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6612&quot; title=&quot;ZooKeeperStateHandleStore does not guard against concurrent delete operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6612&quot;&gt;&lt;del&gt;FLINK-6612&lt;/del&gt;&lt;/a&gt; Allow ZooKeeperStateHandleStore to lock created ZNodes&lt;/p&gt;

&lt;p&gt;    Backport of #3939 onto the `release-1.3` branch.&lt;/p&gt;

&lt;p&gt;    In order to guard against deletions of ZooKeeper nodes which are still being used&lt;br/&gt;
    by a different ZooKeeperStateHandleStore, we have to introduce a locking mechanism.&lt;br/&gt;
    Only after all ZooKeeperStateHandleStores have released their lock, the ZNode is&lt;br/&gt;
    allowed to be deleted.&lt;/p&gt;

&lt;p&gt;    THe locking mechanism is implemented via ephemeral child nodes of the respective&lt;br/&gt;
    ZooKeeper node. Whenever a ZooKeeperStateHandleStore wants to lock a ZNode, thus,&lt;br/&gt;
    protecting it from being deleted, it creates an ephemeral child node. The node&apos;s&lt;br/&gt;
    name is unique to the ZooKeeperStateHandleStore instance. The delete operations&lt;br/&gt;
    will then only delete the node if it does not have any children associated.&lt;/p&gt;

&lt;p&gt;    In order to guard against oprhaned lock nodes, they are created as ephemeral nodes.&lt;br/&gt;
    This means that they will be deleted by ZooKeeper once the connection of the&lt;br/&gt;
    ZooKeeper client which created the node timed out.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; addZooKeeperRefCountingBackport&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3940.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3940.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3940&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ccb3ac8f2b64a357275d2967fcd440947becd272&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-05-17T12:52:04Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6612&quot; title=&quot;ZooKeeperStateHandleStore does not guard against concurrent delete operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6612&quot;&gt;&lt;del&gt;FLINK-6612&lt;/del&gt;&lt;/a&gt; Allow ZooKeeperStateHandleStore to lock created ZNodes&lt;/p&gt;

&lt;p&gt;    In order to guard against deletions of ZooKeeper nodes which are still being used&lt;br/&gt;
    by a different ZooKeeperStateHandleStore, we have to introduce a locking mechanism.&lt;br/&gt;
    Only after all ZooKeeperStateHandleStores have released their lock, the ZNode is&lt;br/&gt;
    allowed to be deleted.&lt;/p&gt;

&lt;p&gt;    THe locking mechanism is implemented via ephemeral child nodes of the respective&lt;br/&gt;
    ZooKeeper node. Whenever a ZooKeeperStateHandleStore wants to lock a ZNode, thus,&lt;br/&gt;
    protecting it from being deleted, it creates an ephemeral child node. The node&apos;s&lt;br/&gt;
    name is unique to the ZooKeeperStateHandleStore instance. The delete operations&lt;br/&gt;
    will then only delete the node if it does not have any children associated.&lt;/p&gt;

&lt;p&gt;    In order to guard against oprhaned lock nodes, they are created as ephemeral nodes.&lt;br/&gt;
    This means that they will be deleted by ZooKeeper once the connection of the&lt;br/&gt;
    ZooKeeper client which created the node timed out.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16015881" author="githubbot" created="Thu, 18 May 2017 14:57:09 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3939&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    LGMT +1. Tested that this is running with incremental checkpoints, however the test did not (yet) cover a &quot;split brain&quot; scenario with to JobManagers running in parallel.&lt;/p&gt;</comment>
                            <comment id="16017093" author="githubbot" created="Fri, 19 May 2017 09:05:18 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3939&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for your work @tillrohrmann ! I merged this manually. Please close this PR and the jira.&lt;/p&gt;</comment>
                            <comment id="16017172" author="githubbot" created="Fri, 19 May 2017 10:08:43 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3939&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merged in 3d119e1155aa8930cc7b18a085d6790cb2c63b70&lt;/p&gt;</comment>
                            <comment id="16017173" author="githubbot" created="Fri, 19 May 2017 10:08:43 +0000"  >&lt;p&gt;Github user tillrohrmann closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3939&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16017174" author="githubbot" created="Fri, 19 May 2017 10:09:04 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3940&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3940&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merged in f58fec70fef12056bd58b6cc2985532ccb07625e&lt;/p&gt;</comment>
                            <comment id="16017175" author="githubbot" created="Fri, 19 May 2017 10:09:05 +0000"  >&lt;p&gt;Github user tillrohrmann closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3940&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3940&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16017176" author="till.rohrmann" created="Fri, 19 May 2017 10:09:42 +0000"  >&lt;p&gt;1.4.0: 3d119e1155aa8930cc7b18a085d6790cb2c63b70&lt;br/&gt;
1.3.0: f58fec70fef12056bd58b6cc2985532ccb07625e&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 26 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3f3sv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>