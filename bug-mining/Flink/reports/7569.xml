<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:20:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-28984] FsCheckpointStateOutputStream is not being released normally</title>
                <link>https://issues.apache.org/jira/browse/FLINK-28984</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;If the checkpoint is aborted, AsyncSnapshotCallable will close the snapshotCloseableRegistry when it is canceled. There may be two situations here:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The FSDataOutputStream has been created and closed while closing FsCheckpointStateOutputStream.&lt;/li&gt;
	&lt;li&gt;The FSDataOutputStream has not been created yet, but closed flag has been set to true. You can see this in log:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-08-16 12:55:44,161 WARN  org.apache.flink.core.fs.SafetyNetCloseableRegistry           - Closing unclosed resource via safety-net: ClosingFSDataOutputStream(org.apache.flink.runtime.fs.hdfs.HadoopDataOutputStream@4ebe8e64) : xxxxx/flink/checkpoint/state/9214a2e302904b14baf2dc1aacbc7933/ae157c5a05a8922a46a179cdb4c86b10/shared/9d8a1e92-2f69-4ab0-8ce9-c1beb149229a &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160; &#160; &#160; &#160; The output stream will be automatically closed by the SafetyNetCloseableRegistry but the file will not be deleted.&lt;/p&gt;

&lt;p&gt;The second case usually occurs when the storage system has high latency in creating files.&lt;/p&gt;

&lt;p&gt;How to reproduce?&lt;/p&gt;

&lt;p&gt;This is not easy to reproduce, but you can try to set a smaller checkpoint timeout and increase the parallelism of the flink job.&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13476950">FLINK-28984</key>
            <summary>FsCheckpointStateOutputStream is not being released normally</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="showuon">Luke Chen</assignee>
                                    <reporter username="ChangjiGuo">ChangjiGuo</reporter>
                        <labels>
                            <label>auto-deprioritized-major</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 16 Aug 2022 05:07:01 +0000</created>
                <updated>Tue, 1 Apr 2025 06:27:22 +0000</updated>
                            <resolved>Wed, 17 Jul 2024 11:29:16 +0000</resolved>
                                    <version>1.11.6</version>
                    <version>1.15.1</version>
                                    <fixVersion>2.0-preview</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17580061" author="yunta" created="Tue, 16 Aug 2022 06:01:27 +0000"  >&lt;p&gt;I think the second analysis looks a bit weird. If the FSDataOutputStream has not been created, it will not call &lt;tt&gt;FsCheckpointStateOutputStream#createStream&lt;/tt&gt; , which means we will not get the generated random path.&lt;/p&gt;

&lt;p&gt;The SafetyNetCloseableRegistry would help close the unreleased closable on JVM GC, it must be we forget to close them in somewhere.&lt;/p&gt;</comment>
                            <comment id="17580099" author="changjiguo" created="Tue, 16 Aug 2022 07:23:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;&#160; I&apos;m sorry, maybe I didn&apos;t express it clearly. There is a prerequisite here that snapshotCloseableRegistry will be closed, and then the registered closabe will call the close method. Both &lt;em&gt;FsCheckpointStateOutputStream#createStream&lt;/em&gt; and &lt;em&gt;FsCheckpointStateOutputStream#close&lt;/em&gt; can be called at the same time. It is possible that the FSDataOutputStream has not been created when the close called(at this time, outStream is null).&lt;/p&gt;

&lt;p&gt;In order to verify this conjecture, I printed the log at both setting closed = true and returning stream, as follows:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13048156/13048156_log.png&quot; height=&quot;304&quot; width=&quot;741&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17581190" author="changjiguo" created="Thu, 18 Aug 2022 06:55:17 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, I have verified on Flink-1.15.1.&lt;/p&gt;

&lt;p&gt;My fix is to check if &lt;em&gt;FsCheckpointStateOutputStream&lt;/em&gt; has been closed after creating the output stream and clean up(include closing stream and deleting file) if closed. It works well and without the above logs.&lt;/p&gt;

&lt;p&gt;Can you take a look if you have time? Thx.&lt;/p&gt;</comment>
                            <comment id="17616886" author="yanfei lei" created="Thu, 13 Oct 2022 08:55:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ChangjiGuo&quot; class=&quot;user-hover&quot; rel=&quot;ChangjiGuo&quot;&gt;ChangjiGuo&lt;/a&gt;, do you mean the &lt;tt&gt;FsCheckpointStateOutputStream#close()&lt;/tt&gt; is called during&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;FsCheckpointStateOutputStream#flushToFile()&lt;/tt&gt;, I think the root cause is that there is no concurrency guarantee for checking &lt;tt&gt;close&lt;/tt&gt; and &lt;tt&gt;FsCheckpointStateOutputStream#createStream&lt;/tt&gt; in &lt;tt&gt;#flushToFile()&lt;/tt&gt;, what do you think?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17616973" author="changjiguo" created="Thu, 13 Oct 2022 11:26:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Yanfei+Lei&quot; class=&quot;user-hover&quot; rel=&quot;Yanfei Lei&quot;&gt;Yanfei Lei&lt;/a&gt;, thanks for your reply! Yes, that&apos;s what I want to express!&#160;&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17753713" author="flink-jira-bot" created="Sun, 13 Aug 2023 10:35:18 +0000"  >&lt;p&gt;I am the &lt;a href=&quot;https://github.com/apache/flink-jira-bot/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Flink Jira Bot&lt;/a&gt; and I help the community manage its development. I see this issues has been marked as Major but is unassigned and neither itself nor its Sub-Tasks have been updated for 60 days. I have gone ahead and added a &quot;stale-major&quot; to the issue&quot;. If this ticket is a Major, please either assign yourself or give an update. Afterwards, please remove the label or in 7 days the issue will be deprioritized.&lt;/p&gt;</comment>
                            <comment id="17758282" author="flink-jira-bot" created="Wed, 23 Aug 2023 22:34:56 +0000"  >&lt;p&gt;This issue was labeled &quot;stale-major&quot; 7 days ago and has not received any updates so it is being deprioritized. If this ticket is actually Major, please raise the priority and ask a committer to assign you the issue or revive the public discussion.&lt;/p&gt;</comment>
                            <comment id="17866731" author="zakelly" created="Wed, 17 Jul 2024 11:28:57 +0000"  >&lt;p&gt;Merged into master via: c3e3a91f0db165751fa832e34c81d4684827f787&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                                                <inwardlinks description="Is contained by">
                                        <issuelink>
            <issuekey id="13476366">FLINK-28927</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13585812">FLINK-35843</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13048156" name="log.png" size="524787" author="ChangjiGuo" created="Tue, 16 Aug 2022 07:22:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 16 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17s34:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>