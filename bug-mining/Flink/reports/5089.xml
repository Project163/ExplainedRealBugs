<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:52:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20580] Missing null value handling for SerializedValue&apos;s getByteArray() </title>
                <link>https://issues.apache.org/jira/browse/FLINK-20580</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;tt&gt;SerializedValue&lt;/tt&gt; allows to wrap &lt;tt&gt;null&lt;/tt&gt; values. Because of this, &lt;tt&gt;SerializedValue.getByteArray()&lt;/tt&gt; might return &lt;tt&gt;null&lt;/tt&gt; which is not properly handled in different locations (it&apos;s probably the best to use the IDEs &quot;Find usages&quot; to identify these locations). The most recent findings (for now) are listed in the comments.&lt;/p&gt;

&lt;p&gt;We should add null handling in these cases and add tests for these cases.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13345516">FLINK-20580</key>
            <summary>Missing null value handling for SerializedValue&apos;s getByteArray() </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kezhuw">Kezhu Wang</assignee>
                                    <reporter username="mapohl">Matthias Pohl</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>starter</label>
                    </labels>
                <created>Fri, 11 Dec 2020 13:08:46 +0000</created>
                <updated>Fri, 26 Feb 2021 23:00:46 +0000</updated>
                            <resolved>Thu, 18 Feb 2021 18:07:21 +0000</resolved>
                                    <version>1.13.0</version>
                                    <fixVersion>1.12.2</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                                    <component>API / Type Serialization System</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17247991" author="till.rohrmann" created="Fri, 11 Dec 2020 15:54:43 +0000"  >&lt;p&gt;The problematic code locations are &lt;tt&gt;BlobWriter&lt;/tt&gt; and &lt;tt&gt;SerializedValueSerializer&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17248007" author="jackwangcs" created="Fri, 11 Dec 2020 16:21:36 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;, I also find the&#160; &lt;tt&gt;SerializedValue.getByteArray()&lt;/tt&gt;&#160;is called in &lt;tt&gt;AkkaRpcActor&lt;/tt&gt;&#160;and &lt;tt&gt;RemoteRpcInvocation&lt;/tt&gt;. And they both has some prolematic code to check the length of serializedData by: &lt;tt&gt;SerializedValue.getByteArray().length&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17248019" author="till.rohrmann" created="Fri, 11 Dec 2020 16:44:42 +0000"  >&lt;p&gt;True, you are right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jackwangcs&quot; class=&quot;user-hover&quot; rel=&quot;jackwangcs&quot;&gt;jackwangcs&lt;/a&gt;. I did not mention the &lt;tt&gt;AkkaRpcActor&lt;/tt&gt; because I am fixing this problem via &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20521&quot; title=&quot;Null result values are being swallowed by RPC system&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20521&quot;&gt;&lt;del&gt;FLINK-20521&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17283134" author="kezhuw" created="Thu, 11 Feb 2021 16:29:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160; May be better to not nullable but empty array ?&lt;/p&gt;</comment>
                            <comment id="17283220" author="till.rohrmann" created="Thu, 11 Feb 2021 17:26:14 +0000"  >&lt;p&gt;I think this is the better solution &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt;. Do you wanna take a stab at this problem?&lt;/p&gt;</comment>
                            <comment id="17283227" author="kezhuw" created="Thu, 11 Feb 2021 17:31:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; Yeh, I could give it a try.&lt;/p&gt;</comment>
                            <comment id="17283659" author="kezhuw" created="Fri, 12 Feb 2021 12:41:58 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, after digging a bit, I think we had third option: not supporting nullable value for &lt;tt&gt;SerializedValue(T value)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Caller should resort to nullable/optional variable of &lt;tt&gt;SerializedValue&lt;/tt&gt; if null-ability is required, just like &lt;tt&gt;JobCheckpointingSettings.defaultStateBackend&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I saw two null-ability dependencies of &lt;tt&gt;SerializedValue(T value)&lt;/tt&gt; so far:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;rpc.akka&lt;/tt&gt;. As an rpc module, I think it would be better to use its own version for self-contained. If there is an rpc returning &lt;tt&gt;SerializedValue&lt;/tt&gt;, it will fail as &lt;tt&gt;AkkaInvocationHandler.deserializeValueIfNeeded&lt;/tt&gt; treats the value as wrapped result. Not sure whether this is a valid case, but there are already cases where &lt;tt&gt;SerializedValue&lt;/tt&gt; used as parameter.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;TaskExecutorOperatorEventHandlingTest.eventHandlingInTaskFailureFailsTask&lt;/tt&gt;. It is easy to fix.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To sum up, the third option should be:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Forbid null value in &lt;tt&gt;SerializedValue(T value)&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Migrate existing null-ability dependent code.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; Which approach do you prefer ?&lt;/p&gt;</comment>
                            <comment id="17283680" author="kezhuw" created="Fri, 12 Feb 2021 13:26:46 +0000"  >&lt;p&gt;I am kind of prefer third option.&lt;/p&gt;

&lt;p&gt;If we allow nullable value in &lt;tt&gt;SerializedValue(T value)&lt;/tt&gt;, then &lt;tt&gt;SerializedValue.deserializeValue&lt;/tt&gt; will be nullabe, while we all know that it is almost always not null. But when that happens, it may be too far from its cause.&lt;/p&gt;</comment>
                            <comment id="17283699" author="till.rohrmann" created="Fri, 12 Feb 2021 13:45:16 +0000"  >&lt;p&gt;Thanks for further looking into the problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt;. I think the answer depends on whether we want to support &lt;tt&gt;null&lt;/tt&gt; values or not in &lt;tt&gt;SerializedValue&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If we want to support &lt;tt&gt;null&lt;/tt&gt; values, then returning an empty &lt;tt&gt;byte[]&lt;/tt&gt; does not work because it would not deserialize to &lt;tt&gt;null&lt;/tt&gt;. This would be somewhat surprising given that &lt;tt&gt;SerializedValue.getByteArray&lt;/tt&gt; should return the bytes of the serialized value.&lt;/p&gt;

&lt;p&gt;Since &lt;tt&gt;null&lt;/tt&gt; values are always a bit problematic I think it would be good to get rid of them as much as possible. Hence, I like your idea of only accepting non-null values for the &lt;tt&gt;SerializedValue&lt;/tt&gt;. So if there are only few places where &lt;tt&gt;SerializedValue&lt;/tt&gt; is used with &lt;tt&gt;null&lt;/tt&gt; values, then this sounds like my preferred solution. &lt;/p&gt;

&lt;p&gt;Moreover, I think you are completely right that the &lt;tt&gt;RpcService&lt;/tt&gt; should use their own abstraction to send serialized data over the wire. That way it would be decoupled from what the user actually returns. With &lt;tt&gt;SerializedValue&lt;/tt&gt; this can lead currently to incorrect results in the case of local communication and a RPC returning a &lt;tt&gt;SerializedValue&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17283726" author="kezhuw" created="Fri, 12 Feb 2021 14:29:55 +0000"  >&lt;blockquote&gt;
&lt;p&gt;If we want to support null values, then returning an empty byte[] does not work because it would not deserialize to null. This would be somewhat surprising given that SerializedValue.getByteArray should return the bytes of the serialized value.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeh, a bit surprising for &lt;tt&gt;SerializedValue.getByteArray&lt;/tt&gt; not deserializable for not null array. I planed to deserialize to null for empty array in &lt;tt&gt;SerializedValue.deserializeValue&lt;/tt&gt;. But if callers resort to deserialize themselves, then it could be really surprising.&lt;/p&gt;

&lt;p&gt;I will go through making value not nullable in &lt;tt&gt;SerializedValue(T value)&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17286644" author="till.rohrmann" created="Thu, 18 Feb 2021 18:07:21 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.13.0:&lt;br/&gt;
bbdd769253b25b4093a1759c835c6ff1d99d390d&lt;br/&gt;
ed981be6601d3600d23b301d70d2bffff8aad3e6&lt;/p&gt;

&lt;p&gt;1.12.3:&lt;br/&gt;
c8c790f6d726fd6942a2569dd97ed7a116092c4e&lt;br/&gt;
1d8a8e3529956f930725777499155d51aeb79045&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0lfe0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>