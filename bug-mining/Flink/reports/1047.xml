<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:24:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-3974] enableObjectReuse fails when an operator chains to multiple downstream operators</title>
                <link>https://issues.apache.org/jira/browse/FLINK-3974</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Given a topology that looks like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DataStream&amp;lt;A&amp;gt; input = ...
input
    .map(MapFunction&amp;lt;A,B&amp;gt;...)
    .addSink(...);

input
    .map(MapFunction&amp;lt;A,C&amp;gt;...)
    &#8203;.addSink(...);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;enableObjectReuse() will cause an exception in the form of &lt;tt&gt;&quot;java.lang.ClassCastException: B cannot be cast to A&quot;&lt;/tt&gt; to be thrown.&lt;/p&gt;

&lt;p&gt;It looks like the input operator calls &lt;tt&gt;Output&amp;lt;StreamRecord&amp;lt;A&amp;gt;&amp;gt;.collect&lt;/tt&gt; which attempts to loop over the downstream operators and process them.&lt;/p&gt;

&lt;p&gt;However, the first map operation will call &lt;tt&gt;StreamRecord&amp;lt;&amp;gt;.replace&lt;/tt&gt; which mutates the value stored in the StreamRecord&amp;lt;&amp;gt;.  &lt;/p&gt;

&lt;p&gt;As a result, when the &lt;tt&gt;Output&amp;lt;StreamRecord&amp;lt;A&amp;gt;&amp;gt;.collect&lt;/tt&gt; call passes the &lt;tt&gt;StreamRecord&amp;lt;A&amp;gt;&lt;/tt&gt; to the second map operation it is actually a &lt;tt&gt;StreamRecord&amp;lt;B&amp;gt;&lt;/tt&gt; and behaves as if the two map operations were serial instead of parallel.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12972766">FLINK-3974</key>
            <summary>enableObjectReuse fails when an operator chains to multiple downstream operators</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aljoscha">Aljoscha Krettek</assignee>
                                    <reporter username="wanderingbort">Bart</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 May 2016 16:27:41 +0000</created>
                <updated>Wed, 1 Nov 2017 11:45:58 +0000</updated>
                            <resolved>Mon, 27 Jun 2016 15:02:45 +0000</resolved>
                                    <version>1.0.3</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15300642" author="wanderingbort" created="Wed, 25 May 2016 18:51:16 +0000"  >&lt;p&gt;After attempting to produce a minimal repro, I realized that there needs to be an operation between the source and the parallel maps:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DataStream&amp;lt;A&amp;gt; input = ...

input = input
    .map(MapFunction&amp;lt;A,A&amp;gt;...);

input
    .map(MapFunction&amp;lt;A,B&amp;gt;...)
    .addSink(...);

input
    .map(MapFunction&amp;lt;A,C&amp;gt;...)
    &#8203;.addSink(...);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;see attached repro case&lt;/p&gt;</comment>
                            <comment id="15301053" author="wanderingbort" created="Wed, 25 May 2016 22:54:43 +0000"  >&lt;p&gt;I was able to fix this for my topology and the test case by making a very small change to &lt;tt&gt;ChainingOutput&amp;lt;T&amp;gt;.collect()&lt;/tt&gt; in OperatorChain.java.&lt;/p&gt;

&lt;p&gt;When object reuse is disabled &lt;tt&gt;CopyingChainingOutput&amp;lt;T&amp;gt;.collect()&lt;/tt&gt; is used to make a full copy of the &lt;tt&gt;StreamRecord&amp;lt;T&amp;gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;StreamRecord&amp;lt;T&amp;gt; copy = record.copy(serializer.copy(record.getValue()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If object reuse is enabled, &lt;tt&gt;ChainingOutput&amp;lt;T&amp;gt;.collect()&lt;/tt&gt; is used instead.  As the internal code will mutate &lt;tt&gt;StreamRecord&amp;lt;&amp;gt;&lt;/tt&gt; downstream, I thought the best &quot;good-faith&quot; effort to support object reuse was to copy the &lt;tt&gt;StreamRecord&amp;lt;&amp;gt;&lt;/tt&gt; without copying the value sending this lighter copy downstream instead of the original &lt;tt&gt;StreamRecord&amp;lt;&amp;gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;StreamRecord&amp;lt;T&amp;gt; shallowCopy = record.copy(record.getValue());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



&lt;p&gt;See attached bwyatt-FLINK3974.1.patch&lt;/p&gt;</comment>
                            <comment id="15302127" author="stephanewen" created="Thu, 26 May 2016 14:15:54 +0000"  >&lt;p&gt;Yes, that is a pretty clear bug.&lt;/p&gt;

&lt;p&gt;I guess the best workaround for now is to disable the object reuse mode. Object reuse does not really work well in the DataStream API streaming right now, it works pretty well in the DataSet API.&lt;/p&gt;

&lt;p&gt;Another quick workaround is to not chain the two different map functions &lt;tt&gt;.disableChaining()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The solution should be quite straightforward, though:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Not chain and &quot;splitting&quot; flows any more. I would actually like that solution. For splitting flows, it seems like a good heuristic to start a new chain/thread by default.&lt;/li&gt;
	&lt;li&gt;Each collector should use its own dedicated stream record. That would circumvent the ClassCast at least, but still be dangerous if the mappers actually alter the events.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15304062" author="wanderingbort" created="Fri, 27 May 2016 13:30:56 +0000"  >&lt;p&gt;In the topologies I&apos;ve been building object reuse has been a pretty significant CPU win.  It would be a shame to lose that capability for topos where care is taken to actually maintain the application level requirements of object reuse: Don&apos;t modify your inputs.&lt;/p&gt;

&lt;p&gt;Disabling chaining is a fine option if this is not a bottleneck in your topology.  If unchained-splits become the default, I&apos;d like to see the ability to chain them remain as an option.  Sometimes splitting into multiple chain/threads is good: cpu heavy operators that benefit from parallelism.  Sometimes maintaining the chain to avoid the de/serialization costs is good (cpu light operators with high throughput).&lt;/p&gt;

&lt;p&gt;The patch attached essentially gives each collector its own dedicated stream record with a reference to the value. You are correct it doesn&apos;t solve the problems of mutable operator inputs but, that has always been the primary concession of object reuse and it doesn&apos;t seem like a bad requirement to put on the application level.  I don&apos;t know that there is a way to avoid the cost of cloning &lt;b&gt;and&lt;/b&gt; protect against operators mutating input in a language like Java.&lt;/p&gt;</comment>
                            <comment id="15329226" author="aljoscha" created="Tue, 14 Jun 2016 10:12:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wanderingbort&quot; class=&quot;user-hover&quot; rel=&quot;wanderingbort&quot;&gt;wanderingbort&lt;/a&gt; do you want to open a PR with your fix or should I create a commit for you with the fix?&lt;/p&gt;</comment>
                            <comment id="15333422" author="githubbot" created="Thu, 16 Jun 2016 09:12:45 +0000"  >&lt;p&gt;GitHub user aljoscha opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3974&quot; title=&quot;enableObjectReuse fails when an operator chains to multiple downstream operators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3974&quot;&gt;&lt;del&gt;FLINK-3974&lt;/del&gt;&lt;/a&gt; Fix object reuse with multi-chaining&lt;/p&gt;

&lt;p&gt;    Before, a job would fail if object reuse was enabled and multiple&lt;br/&gt;
    operators were chained to one upstream operator. Now, we always create a&lt;br/&gt;
    shallow copy of the StreamRecord in OperatorChain.ChainingOutput because&lt;br/&gt;
    downstream operations change/reuse the StreamRecord.&lt;/p&gt;

&lt;p&gt;    This fix was contributed by @wanderingbort (if this is the right github handle) as a patch on the Flink Jira. I can change the commit to attribute it to him but so far he didn&apos;t respond to my question about this on Jira.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/aljoscha/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aljoscha/flink&lt;/a&gt; chaining/fix&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2110&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 092f350cccbda32331f527c4eaf7ad3304fa1811&lt;br/&gt;
Author: Aljoscha Krettek &amp;lt;aljoscha.krettek@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-14T10:18:35Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3974&quot; title=&quot;enableObjectReuse fails when an operator chains to multiple downstream operators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3974&quot;&gt;&lt;del&gt;FLINK-3974&lt;/del&gt;&lt;/a&gt; Fix object reuse with multi-chaining&lt;/p&gt;

&lt;p&gt;    Before, a job would fail if object reuse was enabled and multiple&lt;br/&gt;
    operators were chained to one upstream operator. Now, we always create a&lt;br/&gt;
    shallow copy of the StreamRecord in OperatorChain.ChainingOutput because&lt;br/&gt;
    downstream operations change/reuse the StreamRecord.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15344537" author="githubbot" created="Wed, 22 Jun 2016 15:38:04 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110#discussion_r68076977&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110#discussion_r68076977&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/OperatorChain.java &amp;#8212;&lt;br/&gt;
    @@ -306,8 +306,9 @@ public ChainingOutput(OneInputStreamOperator&amp;lt;T, ?&amp;gt; operator) {&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void collect(StreamRecord&amp;lt;T&amp;gt; record) {&lt;br/&gt;
     			try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;operator.setKeyContextElement1(record);&lt;/li&gt;
	&lt;li&gt;operator.processElement(record);&lt;br/&gt;
    +				StreamRecord&amp;lt;T&amp;gt; shallowCopy = record.copy(record.getValue());&lt;br/&gt;
    +				operator.setKeyContextElement1(shallowCopy);&lt;br/&gt;
    +				operator.processElement(shallowCopy);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Actually I&apos;m wondering whether the `ChainingOutput` is the right place to do this copying. Wouldn&apos;t it make more sense to do it in the `BroadcastingOutputCollector`, because only if we have a branching chained data flow we have to make sure that every down stream operator get his own copy of the record. For simple chaining it should be correct to reuse the stream record.&lt;/p&gt;

&lt;p&gt;    So I would adapt the `collect` method of `BroadcastingOutputCollector` the following way:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    public void collect(StreamRecord&amp;lt;T&amp;gt; record) {&lt;br/&gt;
    	for (int i = 0; i &amp;lt; outputs.length - 1; i++) &lt;/p&gt;
{
    		StreamRecord&amp;lt;T&amp;gt; shallowCopy = record.copy(record.getValue());
    		outputs[i].collect(shallowCopy);
    	}

&lt;p&gt;    	outputs&lt;span class=&quot;error&quot;&gt;&amp;#91;outputs.length - 1&amp;#93;&lt;/span&gt;.collect(record);&lt;br/&gt;
    }&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="15344541" author="githubbot" created="Wed, 22 Jun 2016 15:40:23 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110#discussion_r68077418&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110#discussion_r68077418&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/ChainingITCase.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,70 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.streaming.runtime.operators;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.functions.MapFunction;&lt;br/&gt;
    +import org.apache.flink.streaming.api.datastream.DataStream;&lt;br/&gt;
    +import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.util.StreamingMultipleProgramsTestBase;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for stream operator chaining behaviour.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ChainingITCase extends StreamingMultipleProgramsTestBase {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Do we have to instantiate an expensive IT test case to test the correct chaining behaviour? Maybe we could save some cycles if we don&apos;t start a complete Flink cluster for that and test directly the chained task.&lt;/p&gt;</comment>
                            <comment id="15344550" author="githubbot" created="Wed, 22 Jun 2016 15:43:49 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the contribution @wanderingbort and @aljoscha. I might be wrong, but maybe there is a slightly better place for the copying operation. Furthermore, I think that it would be beneficial if we could test the correct behaviour without instantiating an expensive IT case.&lt;/p&gt;</comment>
                            <comment id="15346141" author="githubbot" created="Thu, 23 Jun 2016 09:19:42 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the thorough review, @tillrohrmann!&lt;/p&gt;

&lt;p&gt;    Your points are valid, maybe I&apos;ll have to change this PR but let me first explain my reasoning.&lt;/p&gt;

&lt;p&gt;    The shallow copy is performed in the one place that all code paths have to go through because it is the point right before control is passed to the operator. Putting it in different place would mean placing it in `BroadcastingOutputCollector`, as you mentioned, as well as in &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/collector/selector/DirectedOutput.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/collector/selector/DirectedOutput.java&lt;/a&gt;, which is used when the user does a split()/select() operation (`DataStream.split()`). The number of places where we have to put this might evolve in the future.&lt;/p&gt;

&lt;p&gt;    Also, putting it in `BroadcastingOutputCollector` and `DirectedOutput` would mean that we always do two copies per record for the common case of having object-copying enabled (which is the default).&lt;/p&gt;

&lt;p&gt;    About the ITCase. I also don&apos;t like having that in there because we are approaching the 2h mark on Travis but I think in this case it&apos;s valid. This test really verifies that the whole system works correctly when the user uses a certain feature (I would also add a test for split()/select() now that I thought about it). &lt;/p&gt;</comment>
                            <comment id="15346162" author="githubbot" created="Thu, 23 Jun 2016 09:29:52 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;ll try and come up with something, I&apos;ll probably remove the `isInputCopyDisabled` from operator and only allow a global setting for object reuse. This should simplify things.&lt;/p&gt;</comment>
                            <comment id="15346340" author="githubbot" created="Thu, 23 Jun 2016 12:32:00 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tillrohrmann I pushed a commit that removes the per-operator object-reuse setting, refactors broadcasting and direct outputs and changes the ITCase to a test case. Happy reviewing. &#128515; &lt;/p&gt;</comment>
                            <comment id="15346476" author="githubbot" created="Thu, 23 Jun 2016 14:04:07 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110#discussion_r68239970&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110#discussion_r68239970&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/collector/selector/CopyingDirectedOutput.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,51 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.collector.selector;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.java.tuple.Tuple2;&lt;br/&gt;
    +import org.apache.flink.streaming.api.graph.StreamEdge;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.Output;&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.streamrecord.StreamRecord;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Special version of &lt;/p&gt;
{@link DirectedOutput}
&lt;p&gt; that performs a shallow copy of the&lt;br/&gt;
    + * &lt;/p&gt;
{@link StreamRecord}
&lt;p&gt; to ensure that multi-chaining works correctly.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class CopyingDirectedOutput&amp;lt;OUT&amp;gt; extends DirectedOutput&amp;lt;OUT&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +	@SuppressWarnings(&lt;/p&gt;
{&quot;unchecked&quot;, &quot;rawtypes&quot;}
&lt;p&gt;)&lt;br/&gt;
    +	public CopyingDirectedOutput(&lt;br/&gt;
    +			List&amp;lt;OutputSelector&amp;lt;OUT&amp;gt;&amp;gt; outputSelectors,&lt;br/&gt;
    +			List&amp;lt;Tuple2&amp;lt;Output&amp;lt;StreamRecord&amp;lt;OUT&amp;gt;&amp;gt;, StreamEdge&amp;gt;&amp;gt; outputs) &lt;/p&gt;
{
    +		super(outputSelectors, outputs);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public void collect(StreamRecord&amp;lt;OUT&amp;gt; record) {&lt;br/&gt;
    +		Set&amp;lt;Output&amp;lt;StreamRecord&amp;lt;OUT&amp;gt;&amp;gt;&amp;gt; selectedOutputs = selectOutputs(record);&lt;br/&gt;
    +&lt;br/&gt;
    +		for (Output&amp;lt;StreamRecord&amp;lt;OUT&amp;gt;&amp;gt; out : selectedOutputs) &lt;/p&gt;
{
    +			StreamRecord&amp;lt;OUT&amp;gt; shallowCopy = record.copy(record.getValue());
    +			out.collect(shallowCopy);
    +		}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Can&apos;t we save one copy operation by giving `record` to the last selected output?&lt;/p&gt;</comment>
                            <comment id="15346484" author="githubbot" created="Thu, 23 Jun 2016 14:05:50 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110#discussion_r68240257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110#discussion_r68240257&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/OperatorChain.java &amp;#8212;&lt;br/&gt;
    @@ -386,4 +402,23 @@ public void close() {&lt;br/&gt;
     			}&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Special version of &lt;/p&gt;
{@link BroadcastingOutputCollector}
&lt;p&gt; that performs a shallow copy of the&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link StreamRecord}
&lt;p&gt; to ensure that multi-chaining works correctly.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private static final class CopyingBroadcastingOutputCollector&amp;lt;T&amp;gt; extends BroadcastingOutputCollector&amp;lt;T&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		public CopyingBroadcastingOutputCollector(Output&amp;lt;StreamRecord&amp;lt;T&amp;gt;&amp;gt;[] outputs) &lt;/p&gt;
{
    +			super(outputs);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(StreamRecord&amp;lt;T&amp;gt; record) {&lt;br/&gt;
    +			for (Output&amp;lt;StreamRecord&amp;lt;T&amp;gt;&amp;gt; output : outputs) &lt;/p&gt;
{
    +				StreamRecord&amp;lt;T&amp;gt; shallowCopy = record.copy(record.getValue());
    +				output.collect(shallowCopy);
    +			}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Here, the same. I think we could save one copying operation by giving the original `record` to the last output.&lt;/p&gt;</comment>
                            <comment id="15346486" author="githubbot" created="Thu, 23 Jun 2016 14:10:19 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110#discussion_r68241018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110#discussion_r68241018&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/ChainingITCase.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,354 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.streaming.runtime.operators;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.functions.MapFunction;&lt;br/&gt;
    +import org.apache.flink.api.common.typeutils.TypeSerializer;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.runtime.accumulators.AccumulatorRegistry;&lt;br/&gt;
    +import org.apache.flink.runtime.execution.Environment;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobVertex;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockInputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.state.AbstractStateBackend;&lt;br/&gt;
    +import org.apache.flink.runtime.state.memory.MemoryStateBackend;&lt;br/&gt;
    +import org.apache.flink.streaming.api.collector.selector.OutputSelector;&lt;br/&gt;
    +import org.apache.flink.streaming.api.datastream.DataStream;&lt;br/&gt;
    +import org.apache.flink.streaming.api.datastream.SplitStream;&lt;br/&gt;
    +import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.functions.sink.SinkFunction;&lt;br/&gt;
    +import org.apache.flink.streaming.api.graph.StreamConfig;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamMap;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.streamrecord.StreamRecord;&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.tasks.OperatorChain;&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.tasks.StreamTask;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +import org.mockito.invocation.InvocationOnMock;&lt;br/&gt;
    +import org.mockito.stubbing.Answer;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.hamcrest.Matchers.contains;&lt;br/&gt;
    +import static org.mockito.Matchers.any;&lt;br/&gt;
    +import static org.mockito.Mockito.doAnswer;&lt;br/&gt;
    +import static org.mockito.Mockito.mock;&lt;br/&gt;
    +import static org.mockito.Mockito.when;&lt;br/&gt;
    +import static org.hamcrest.MatcherAssert.assertThat;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for stream operator chaining behaviour.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ChainingITCase {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think that this test case no longer needs to be an IT case.&lt;/p&gt;</comment>
                            <comment id="15346488" author="githubbot" created="Thu, 23 Jun 2016 14:11:40 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Excellent work @aljoscha. Great fix for the problem and it&apos;s also really nice that we could get rid of the IT case &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; +1 for merging after addressing my minor comments.&lt;/p&gt;</comment>
                            <comment id="15350557" author="githubbot" created="Mon, 27 Jun 2016 08:06:11 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Aw man, I already hat &quot;rename to Test&quot; in my commit but forgot to add that ... &#128517; &lt;/p&gt;

&lt;p&gt;    Thanks again, @tillrohrmann, I&apos;ll make the changes and merge.&lt;/p&gt;</comment>
                            <comment id="15351196" author="githubbot" created="Mon, 27 Jun 2016 15:00:21 +0000"  >&lt;p&gt;Github user aljoscha closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15351200" author="aljoscha" created="Mon, 27 Jun 2016 15:02:45 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/flink/commit/cb2b76dc4c999398133c392c9fa4a8ef82e90fd5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/cb2b76dc4c999398133c392c9fa4a8ef82e90fd5&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16233964" author="githubbot" created="Wed, 1 Nov 2017 11:45:58 +0000"  >&lt;p&gt;Github user XuPingyong commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2110&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I do not agree with this pr as it always copy  StreamRecord to downstream operator.&lt;/p&gt;

&lt;p&gt;    StreamMap change the input StreamRecord, so this pr works well. But many operators do not change/reuse the input StreamRecord, like StreamFlatMap.&lt;/p&gt;

&lt;p&gt;    The following code no not need the extra copy.&lt;br/&gt;
    `DataStream&amp;lt;A&amp;gt; input = ...&lt;br/&gt;
    input&lt;br/&gt;
        .flatmap(FlatMapFunction&amp;lt;A,B&amp;gt;...)&lt;br/&gt;
        .addSink(...);&lt;/p&gt;

&lt;p&gt;    input&lt;br/&gt;
        .flatmap(FlatMapFunction&amp;lt;A,C&amp;gt;...)&lt;br/&gt;
        &#8203;.addSink(...);`&lt;/p&gt;

&lt;p&gt;        So I think we can change StreamMap to not reuse the input StreamRecord. And directly send the StreamRecord if objectReuse is set true.  &lt;br/&gt;
        What do you think?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12806186" name="ReproFLINK3974.java" size="1134" author="wanderingbort" created="Wed, 25 May 2016 18:51:55 +0000"/>
                            <attachment id="12806250" name="bwyatt-FLINK3974.1.patch" size="893" author="wanderingbort" created="Wed, 25 May 2016 22:54:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yhm7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>