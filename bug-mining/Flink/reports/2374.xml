<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8402] HadoopS3FileSystemITCase.testDirectoryListing fails on Travis</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8402</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The test &lt;tt&gt;HadoopS3FileSystemITCase.testDirectoryListing&lt;/tt&gt; fails on Travis.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/tillrohrmann/flink/jobs/327021175&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/tillrohrmann/flink/jobs/327021175&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13129818">FLINK-8402</key>
            <summary>HadoopS3FileSystemITCase.testDirectoryListing fails on Travis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkruber">Nico Kruber</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>test-stability</label>
                    </labels>
                <created>Wed, 10 Jan 2018 11:09:30 +0000</created>
                <updated>Mon, 23 Apr 2018 04:56:42 +0000</updated>
                            <resolved>Mon, 23 Apr 2018 04:56:35 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>FileSystems</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16383800" author="nicok" created="Fri, 2 Mar 2018 16:47:43 +0000"  >&lt;p&gt;We obviously need to take more care of &lt;a href=&quot;https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;S3&apos;s consistency model&lt;/a&gt; here as well.&lt;/p&gt;</comment>
                            <comment id="16383822" author="githubbot" created="Fri, 2 Mar 2018 17:09:41 +0000"  >&lt;p&gt;GitHub user NicoK opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8402&quot; title=&quot;HadoopS3FileSystemITCase.testDirectoryListing fails on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8402&quot;&gt;&lt;del&gt;FLINK-8402&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;s3&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; fix hadoop/presto S3 IT cases for eventually-consistent operations&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    `HadoopS3FileSystemITCase` and `PrestoS3FileSystemITCase` rely on consistent read-after-write and delete operations which S3 does not offer and which the `FileSystem` wrappers not always circumvent. Also see&lt;br/&gt;
    &lt;a href=&quot;https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Please merge into `master` and `release-1.5` after accepting.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;harden `HadoopS3FileSystemITCase` with respect to eventual-consistent operations by adding retries of existence checks with an overall deadline of 30s&lt;/li&gt;
	&lt;li&gt;harden `PrestoS3FileSystemITCase` with respect to eventual-consistent operations by adding retries of existence checks with an overall deadline of 30s&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change is already covered by existing tests, such as `HadoopS3FileSystemITCase` and `PrestoS3FileSystemITCase` which occasionally failed.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The serializers: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: *&lt;b&gt;yes&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? *&lt;b&gt;not applicable&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/NicoK/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/NicoK/flink&lt;/a&gt; flink-8402&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5624&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f916ca6d445b5c47903d03440fdb2dabcf504090&lt;br/&gt;
Author: Nico Kruber &amp;lt;nico@...&amp;gt;&lt;br/&gt;
Date:   2018-03-02T16:26:48Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8402&quot; title=&quot;HadoopS3FileSystemITCase.testDirectoryListing fails on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8402&quot;&gt;&lt;del&gt;FLINK-8402&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;s3&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; fix hadoop/presto S3 IT cases for eventually-consistent operations&lt;/p&gt;

&lt;p&gt;    Also see&lt;br/&gt;
    &lt;a href=&quot;https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16387702" author="githubbot" created="Tue, 6 Mar 2018 12:47:20 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The code and the tests should not rely on eventually consistent operations at all, but only on strongly consistent operations, like &quot;read after create&quot;.&lt;/p&gt;

&lt;p&gt;    That should also eliminate any need for retries.&lt;/p&gt;

&lt;p&gt;    Minor comment: `System.currentTimeMillis()` should not be used for interval measurements. It is not a stable clock. All intervals should be measured in `System.nanoTime()`.&lt;/p&gt;</comment>
                            <comment id="16402247" author="githubbot" created="Fri, 16 Mar 2018 17:44:47 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Unfortunately, this is not entirely under our control, since we rely on the underlying `FileSystem` implementation. I can probably reduce some parts of the tests that may lead to eventual consistent operations, but looking through &lt;span class=&quot;error&quot;&gt;&amp;#91;S3&amp;#39;s data consistency model&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel&lt;/a&gt;), I figure we still (at least) have to deal with these scenarios:&lt;/p&gt;

&lt;p&gt;    &amp;gt; - A process writes a new object to Amazon S3 and immediately lists keys within its bucket. Until the change is fully propagated, the object might not appear in the list. &lt;br/&gt;
    &amp;gt; - A process deletes an existing object and immediately lists keys within its bucket. Until the deletion is fully propagated, Amazon S3 might list the deleted object.&lt;/p&gt;

&lt;p&gt;    This could, however, be handled on a case-to-case basis and I could try to improve the tests in this regard.&lt;/p&gt;</comment>
                            <comment id="16406348" author="githubbot" created="Tue, 20 Mar 2018 13:51:11 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624#discussion_r175770944&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624#discussion_r175770944&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-presto/src/test/java/org/apache/flink/fs/s3presto/PrestoS3FileSystemITCase.java &amp;#8212;&lt;br/&gt;
    @@ -143,7 +157,20 @@ public void testDirectoryListing() throws Exception &lt;/p&gt;
{
     			fs.delete(directory, true);
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// now directory must be gone&lt;/li&gt;
	&lt;li&gt;assertFalse(fs.exists(directory));&lt;br/&gt;
    +		// now directory must be gone (this is eventually-consistent, though!)&lt;br/&gt;
    +		checkPathExists(fs, directory, false, deadline);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	private static void checkPathExists(
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Can we deduplicate this function?&lt;/p&gt;</comment>
                            <comment id="16406975" author="githubbot" created="Tue, 20 Mar 2018 20:33:57 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Don&apos;t we control the calls on `FileSystem` that we make as part of the YARN upload? Can&apos;t we simply avoid all operations that are not strongly consistent? For example if we strictly only use `create()` and `open()` we should be consistent.&lt;/p&gt;</comment>
                            <comment id="16409866" author="githubbot" created="Thu, 22 Mar 2018 16:48:23 +0000"  >&lt;p&gt;Github user NicoK commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624#discussion_r176492623&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624#discussion_r176492623&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-filesystems/flink-s3-fs-presto/src/test/java/org/apache/flink/fs/s3presto/PrestoS3FileSystemITCase.java &amp;#8212;&lt;br/&gt;
    @@ -143,7 +157,20 @@ public void testDirectoryListing() throws Exception &lt;/p&gt;
{
     			fs.delete(directory, true);
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// now directory must be gone&lt;/li&gt;
	&lt;li&gt;assertFalse(fs.exists(directory));&lt;br/&gt;
    +		// now directory must be gone (this is eventually-consistent, though!)&lt;br/&gt;
    +		checkPathExists(fs, directory, false, deadline);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	private static void checkPathExists(
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    makes sense - I created `org.apache.flink.core.fs.FileSystemTestUtils` for this helper method&lt;/p&gt;</comment>
                            <comment id="16409887" author="githubbot" created="Thu, 22 Mar 2018 16:55:59 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen unfortunately not, for example:&lt;br/&gt;
    `org.apache.flink.runtime.fs.hdfs.HadoopFileSystem#create()` -&amp;gt; `org.apache.hadoop.fs.FileSystem#create()` -&amp;gt; `org.apache.hadoop.fs.s3a.S3AFileSystem#create()` and this (depending on the Hadoop version, of course) may call this:&lt;br/&gt;
    ```&lt;br/&gt;
          // get the status or throw an FNFE&lt;br/&gt;
          status = getFileStatus(f);&lt;/p&gt;

&lt;p&gt;          // if the thread reaches here, there is something at the path&lt;br/&gt;
          if (status.isDirectory()) {&lt;br/&gt;
    ...&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16413653" author="githubbot" created="Mon, 26 Mar 2018 10:23:08 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @NicoK Is that actually a source of problems here? Or only a check to for graceful &quot;file already exists&quot; message, but nothing that would get in the way when creating a new file?&lt;/p&gt;</comment>
                            <comment id="16413793" author="githubbot" created="Mon, 26 Mar 2018 12:52:06 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    That&apos;s actually the check for whether or not to overwrite the file - let me drop the whole code of this example to give some more context:&lt;br/&gt;
    ```&lt;br/&gt;
      public FSDataOutputStream create(Path f, FsPermission permission,&lt;br/&gt;
          boolean overwrite, int bufferSize, short replication, long blockSize,&lt;br/&gt;
          Progressable progress) throws IOException {&lt;br/&gt;
        String key = pathToKey(f);&lt;br/&gt;
        S3AFileStatus status = null;&lt;br/&gt;
        try {&lt;br/&gt;
          // get the status or throw an FNFE&lt;br/&gt;
          status = getFileStatus(f);&lt;/p&gt;

&lt;p&gt;          // if the thread reaches here, there is something at the path&lt;br/&gt;
          if (status.isDirectory()) &lt;/p&gt;
{
            // path references a directory: automatic error
            throw new FileAlreadyExistsException(f + &quot; is a directory&quot;);
          }
&lt;p&gt;          if (!overwrite) &lt;/p&gt;
{
            // path references a file and overwrite is disabled
            throw new FileAlreadyExistsException(f + &quot; already exists&quot;);
          }
&lt;p&gt;          LOG.debug(&quot;Overwriting file {}&quot;, f);&lt;br/&gt;
        } catch (FileNotFoundException e) &lt;/p&gt;
{
          // this means the file is not found
    
        }
&lt;p&gt;        instrumentation.fileCreated();&lt;br/&gt;
        FSDataOutputStream output;&lt;br/&gt;
        if (blockUploadEnabled) &lt;/p&gt;
{
          output = new FSDataOutputStream(
              new S3ABlockOutputStream(this,
                  key,
                  new SemaphoredDelegatingExecutor(boundedThreadPool,
                      blockOutputActiveBlocks, true),
                  progress,
                  partSize,
                  blockFactory,
                  instrumentation.newOutputStreamStatistics(statistics),
                  new WriteOperationHelper(key)
              ),
              null);
        }
&lt;p&gt; else &lt;/p&gt;
{
    
          // We pass null to FSDataOutputStream so it won&apos;t count writes that
          // are being buffered to a file
          output = new FSDataOutputStream(
              new S3AOutputStream(getConf(),
                  this,
                  key,
                  progress
              ),
              null);
        }
&lt;p&gt;        return output;&lt;br/&gt;
      }&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    At this point, however, there is the read-before-write which is causing the problem.&lt;br/&gt;
    (of course some other concurrent job could create the file in the meantime and this check is not guarding too much but we cannot do too much about it)&lt;/p&gt;</comment>
                            <comment id="16415361" author="githubbot" created="Tue, 27 Mar 2018 09:59:32 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Okay, the solution is actually in the description of another pull request:&lt;/p&gt;

&lt;p&gt;    &amp;gt; Amazon S3 provides read-after-write consistency for PUTS of new objects in your&lt;br/&gt;
    S3 bucket in all regions with one caveat. **The caveat is that if you make a HEAD&lt;br/&gt;
    or GET request to the key name (to find if the object exists) before creating&lt;br/&gt;
    the object, Amazon S3 provides eventual consistency for read-after-write.&quot;**&lt;br/&gt;
    &lt;a href=&quot;https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    That means that through the `flink-s3-fs-hadoop` connector, we can never assume any form of strongly consistent operation, not even the basic read-after-write for exact keys. That&apos;s a bummer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;    On the upside, the `flink-s3-fs-presto` does not seem to do that, so we might be able to rely on strong consistency for read-after-write.&lt;/p&gt;

&lt;p&gt;    My original suggestion boiled down to changing the test code as follows, which should work if GET is consistent after PUT:&lt;br/&gt;
    ```java&lt;br/&gt;
    public static boolean pathExists(&lt;br/&gt;
    		FileSystem fs,&lt;br/&gt;
    		Path path,&lt;br/&gt;
    		boolean expectedExists,&lt;br/&gt;
    		long deadline) throws IOException {&lt;/p&gt;

&lt;p&gt;    	try (FsDataOutputStream ignored = fs.open(path)) &lt;/p&gt;
{
    		// object exists
    		return true;
    	}
&lt;p&gt;    	catch (FileNotFoundException e) &lt;/p&gt;
{
    		// object does not exist
    		return false;
    	}
&lt;p&gt;    }&lt;br/&gt;
    ```&lt;br/&gt;
    instead of the current code.&lt;br/&gt;
    ```java&lt;br/&gt;
    public static void checkPathExistsEventually(&lt;br/&gt;
    		FileSystem fs,&lt;br/&gt;
    		Path path,&lt;br/&gt;
    		boolean expectedExists,&lt;br/&gt;
    		long deadline) throws IOException, InterruptedException {&lt;br/&gt;
    	boolean dirExists;&lt;br/&gt;
    	while ((dirExists = fs.exists(path)) != expectedExists &amp;amp;&amp;amp;&lt;br/&gt;
    			System.nanoTime() &amp;lt; deadline) &lt;/p&gt;
{
    		Thread.sleep(10);
    	}
&lt;p&gt;    	assertEquals(expectedExists, dirExists);&lt;br/&gt;
    }&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    What do you think? Should we use the &quot;strongly consistent&quot; variant for the Presto-S3-based connector?&lt;/p&gt;</comment>
                            <comment id="16418879" author="githubbot" created="Thu, 29 Mar 2018 12:17:02 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Indeed, Presto-S3 does better in `com.facebook.presto.hive.PrestoS3FileSystem#create()`:&lt;br/&gt;
    ```&lt;br/&gt;
    if ((!overwrite) &amp;amp;&amp;amp; exists(path)) &lt;/p&gt;
{
        throw new IOException(&quot;File already exists:&quot; + path);
    }
&lt;p&gt;    // file creation&lt;br/&gt;
    ```&lt;br/&gt;
    But if `overwrite = false`, it will also check for existence first. Also, contrary to my initial analysis, the retries when retrieving the file status during the existence check do not cover non-existence. I can adapt the tests to only use `overwrite = true`, but actual code outside the tests makes use of both variants.&lt;/p&gt;

&lt;p&gt;    It&apos;s therefore a good idea to make the distinction between `flink-s3-fs-hadoop` and `flink-s3-fs-presto` but only for the existence check, not for checking that a file/directory was deleted since&lt;br/&gt;
    &amp;gt; Amazon S3 offers eventual consistency for overwrite PUTS and DELETES in all regions.&lt;/p&gt;

&lt;p&gt;    I adapted the code accordingly which effectively boiled down to removing some of the new eventual consistent existence checks in `PrestoS3FileSystemITCase`.&lt;/p&gt;

&lt;p&gt;    Regarding the two implementations you provided: for doing the existence check, there should not be a difference between a single `fs.exists()` call vs. `fs.open()` in terms of consistency.&lt;/p&gt;</comment>
                            <comment id="16418903" author="till.rohrmann" created="Thu, 29 Mar 2018 12:32:43 +0000"  >&lt;p&gt;Unblocked 1.5.0, because this is a test instability caused by the underlying filesystem consistencies.&lt;/p&gt;</comment>
                            <comment id="16447229" author="githubbot" created="Sun, 22 Apr 2018 13:11:17 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging this for now, because it stabilizes the tests...&lt;/p&gt;</comment>
                            <comment id="16447361" author="githubbot" created="Sun, 22 Apr 2018 20:43:08 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5624&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16447571" author="stephanewen" created="Mon, 23 Apr 2018 04:56:35 +0000"  >&lt;p&gt;Fixed in&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1.5.0 via d36498f3915c303ec2b1ecd83401b074aceef73b&lt;/li&gt;
	&lt;li&gt;1.6.0 via 6581914749c3d7d06b18bfb1454937048ce4dad8&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13127927">FLINK-8336</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 30 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3oqgf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>