<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:19:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2004] Memory leak in presence of failed checkpoints in KafkaSource</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2004</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Checkpoints that fail never send a commit message to the tasks.&lt;/p&gt;

&lt;p&gt;Maintaining a map of all pending checkpoints introduces a memory leak, as entries for failed checkpoints will never be removed.&lt;/p&gt;

&lt;p&gt;Approaches to fix this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The source cleans up entries from older checkpoints once a checkpoint is committed (simple implementation in a linked hash map)&lt;/li&gt;
	&lt;li&gt;The commit message could include the optional state handle (source needs not maintain the map)&lt;/li&gt;
	&lt;li&gt;The checkpoint coordinator could send messages for failed checkpoints?&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment></environment>
        <key id="12829310">FLINK-2004</key>
            <summary>Memory leak in presence of failed checkpoints in KafkaSource</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rmetzger">Robert Metzger</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 May 2015 19:56:29 +0000</created>
                <updated>Thu, 28 Feb 2019 11:15:33 +0000</updated>
                            <resolved>Mon, 1 Jun 2015 15:58:33 +0000</resolved>
                                    <version>0.9</version>
                                    <fixVersion>0.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14543782" author="githubbot" created="Thu, 14 May 2015 15:14:11 +0000"  >&lt;p&gt;GitHub user rmetzger opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2004&quot; title=&quot;Memory leak in presence of failed checkpoints in KafkaSource&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2004&quot;&gt;&lt;del&gt;FLINK-2004&lt;/del&gt;&lt;/a&gt; Fix memory leak in presense of failed checkpoints for Kafka Source&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rmetzger/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rmetzger/flink&lt;/a&gt; flink2004&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #674&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 27f11822b7db2716f3484def8ad350eb7e0b0893&lt;br/&gt;
Author: Robert Metzger &amp;lt;rmetzger@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-05-14T09:45:30Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2004&quot; title=&quot;Memory leak in presence of failed checkpoints in KafkaSource&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2004&quot;&gt;&lt;del&gt;FLINK-2004&lt;/del&gt;&lt;/a&gt; Fix memory leak in presense of failed checkpoints in Kafka source&lt;/p&gt;

&lt;p&gt;commit 36cb4758c200713a97858989ac73f117186ed9dc&lt;br/&gt;
Author: Robert Metzger &amp;lt;rmetzger@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-05-14T13:57:18Z&lt;/p&gt;

&lt;p&gt;    unused imports&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14553987" author="githubbot" created="Thu, 21 May 2015 09:45:42 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674#discussion_r30787124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674#discussion_r30787124&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-connectors/src/main/java/org/apache/flink/streaming/connectors/kafka/api/persistent/PersistentKafkaSource.java &amp;#8212;&lt;br/&gt;
    @@ -236,13 +246,22 @@ public void restoreState(long[] state) {&lt;br/&gt;
     	@Override&lt;br/&gt;
     	public void commitCheckpoint(long checkpointId) {&lt;br/&gt;
     		LOG.info(&quot;Commit checkpoint {}&quot;, checkpointId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;long[] checkpointOffsets = pendingCheckpoints.remove(checkpointId);&lt;/li&gt;
	&lt;li&gt;if(checkpointOffsets == null) {&lt;br/&gt;
    +		final int posInMap = pendingCheckpoints.indexOf(checkpointId);&lt;br/&gt;
    +		if(posInMap == -1) {&lt;br/&gt;
     			LOG.warn(&quot;Unable to find pending checkpoint for id {}&quot;, checkpointId);&lt;br/&gt;
     			return;&lt;br/&gt;
     		}&lt;br/&gt;
    +&lt;br/&gt;
    +		long[] checkpointOffsets = (long[]) pendingCheckpoints.remove(posInMap);&lt;br/&gt;
     		LOG.info(&quot;Got corresponding offsets {}&quot;, Arrays.toString(checkpointOffsets));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think this log message can be improved. To something like &quot;Committing offsets {} to Kafka.&quot;&lt;/p&gt;</comment>
                            <comment id="14553992" author="githubbot" created="Thu, 21 May 2015 09:47:36 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674#issuecomment-104206104&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674#issuecomment-104206104&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks good. Some of the tests look like unit-style tests that are sort of lightweight.&lt;/p&gt;

&lt;p&gt;    May be good to pull those out in to a `PersistentKafkaSourceTest`-&lt;/p&gt;

&lt;p&gt;    Otherwise, +1 to merge&lt;/p&gt;</comment>
                            <comment id="14553993" author="githubbot" created="Thu, 21 May 2015 09:48:23 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674#discussion_r30787289&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674#discussion_r30787289&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-connectors/src/main/java/org/apache/flink/streaming/connectors/kafka/api/persistent/PersistentKafkaSource.java &amp;#8212;&lt;br/&gt;
    @@ -225,7 +226,16 @@ public void close() {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void restoreState(long[] state) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// we maintain the offsets in Kafka, so nothing to do.&lt;br/&gt;
    +		if(lastOffsets == null) {&lt;br/&gt;
    +			LOG.warn(&quot;Restore state called before open() has been called&quot;);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Actually, restore state is always called before `open()`, as far as I know.&lt;/p&gt;</comment>
                            <comment id="14553994" author="githubbot" created="Thu, 21 May 2015 09:48:59 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674#discussion_r30787324&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674#discussion_r30787324&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-connectors/src/main/java/org/apache/flink/streaming/connectors/kafka/api/persistent/PersistentKafkaSource.java &amp;#8212;&lt;br/&gt;
    @@ -225,7 +226,16 @@ public void close() {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void restoreState(long[] state) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// we maintain the offsets in Kafka, so nothing to do.&lt;br/&gt;
    +		if(lastOffsets == null) 
{
    +			LOG.warn(&quot;Restore state called before open() has been called&quot;);
    +			return;
    +		}
&lt;p&gt;    +		LOG.info(&quot;Restoring state to {}&quot;, Arrays.toString(state));&lt;br/&gt;
    +		if(lastOffsets.length != state.length) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    How about sanity checking before logging that things are going to happen? Usually gives better logging insights...&lt;/p&gt;</comment>
                            <comment id="14560713" author="githubbot" created="Wed, 27 May 2015 09:54:38 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674#issuecomment-105846281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674#issuecomment-105846281&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    What is the status of this pull request? Any pending changes, or is it blocked by anything?&lt;/p&gt;</comment>
                            <comment id="14561037" author="githubbot" created="Wed, 27 May 2015 14:11:05 +0000"  >&lt;p&gt;Github user rmetzger commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674#issuecomment-105926083&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674#issuecomment-105926083&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Sorry for not reacting. I was busy with other stuff but I&apos;ll now address your comments.&lt;/p&gt;</comment>
                            <comment id="14561122" author="githubbot" created="Wed, 27 May 2015 15:14:11 +0000"  >&lt;p&gt;Github user rmetzger commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674#issuecomment-105951860&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674#issuecomment-105951860&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I have those unit test style tests all in the KafkaITCase because they depend on the testing clusters started for the test.&lt;br/&gt;
    They all need at least a running Zookeeper instance.&lt;br/&gt;
    I can of course put them into a different class, but this will further slow down our tests because we spend more time starting and stopping zookeeper.&lt;/p&gt;

&lt;p&gt;    I&apos;ve reworked the restore to reflect the open() / restoreState() order.&lt;br/&gt;
    The PR has been updated.&lt;/p&gt;</comment>
                            <comment id="14567144" author="githubbot" created="Mon, 1 Jun 2015 10:37:04 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674#issuecomment-107392647&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674#issuecomment-107392647&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks good!&lt;/p&gt;

&lt;p&gt;    Will merge this..&lt;/p&gt;</comment>
                            <comment id="14567475" author="githubbot" created="Mon, 1 Jun 2015 15:58:33 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/674&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/674&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14567476" author="stephanewen" created="Mon, 1 Jun 2015 15:58:33 +0000"  >&lt;p&gt;Fixed via 7d294735eb3a77debbe2215c44dea4f97bcf7165&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 25 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2en1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>