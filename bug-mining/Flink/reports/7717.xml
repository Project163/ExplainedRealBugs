<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:21:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-36227] NullPointerException when starting flink with logback logger</title>
                <link>https://issues.apache.org/jira/browse/FLINK-36227</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I think that there is a bug in flink code in class MdcUtils.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When I run job on standalone flink or unit test with MiniCluster I get &#160;&#160;&#160; below error. This error rise only when logback &#160;is used, as logging adapter. I use logback version 1.2.13 because in flink documentation &lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/advanced/logging/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/advanced/logging/&lt;/a&gt; is written &#8220;Logback 1.3+ requires SLF4J 2, which is currently not supported.&#8221;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;14:33:41.111 &lt;span class=&quot;error&quot;&gt;&amp;#91;flink-pekko.actor.default-dispatcher-5&amp;#93;&lt;/span&gt; INFO org.apache.flink.runtime.rpc.pekko.PekkoRpcActor - The RpcEndpoint taskmanager_0 failed.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;java.lang.NullPointerException: null&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;em&gt;at java.base/java.util.HashMap.putMapEntries(HashMap.java:497)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;em&gt;at java.base/java.util.HashMap.putAll(HashMap.java:781)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;em&gt;at java.base/java.util.Collections$SynchronizedMap.putAll(Collections.java:2604)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;em&gt;at ch.qos.logback.classic.util.LogbackMDCAdapter.setContextMap(LogbackMDCAdapter.java:197)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160; &#160;&#160;&#160;&#160;&lt;em&gt;at org.slf4j.MDC.setContextMap(MDC.java:264)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;em&gt;at org.apache.flink.util.MdcUtils.lambda$withContext$0(MdcUtils.java:48)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I checked flink code and in my opinion there should be additional check in class MdcUtils in method&lt;/p&gt;

&lt;p&gt;&lt;em&gt;public static MdcCloseable withContext(Map&amp;lt;String, String&amp;gt; context) {&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160; &lt;em&gt;final Map&amp;lt;String, String&amp;gt; orig = MDC.getCopyOfContextMap();&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160; &lt;em&gt;MDC.setContextMap(context);&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160; &lt;em&gt;return () -&amp;gt; MDC.setContextMap(orig);&lt;/em&gt;&lt;br/&gt;
&lt;em&gt;}&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;this method use MDC.getCopyOfContextMap();. Description of this method says that returned value may be null. So when &#160;variable orig is null and is passed to &#8220;MDC.setContextMap&#8221;. At the end this null is passed to class LogbackMDCAdapter to method setContextMap where this null Is passed to &#160;newMap.putAll(contextMap), and then NullPointerException rise. I checked this for logback 1.2.13 where setContextMap is&lt;/p&gt;

&lt;p&gt;&lt;em&gt;public void setContextMap(Map&amp;lt;String, String&amp;gt; contextMap) {&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160; &lt;em&gt;lastOperation.set(WRITE_OPERATION);&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160; &lt;em&gt;Map&amp;lt;String, String&amp;gt; newMap = Collections.synchronizedMap(new HashMap&amp;lt;String, String&amp;gt;());&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160; &lt;em&gt;newMap.putAll(contextMap);&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160; &lt;em&gt;// the newMap replaces the old one for serialisation&apos;s sake&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160; &lt;em&gt;copyOnThreadLocal.set(newMap);&lt;/em&gt;&lt;br/&gt;
&lt;em&gt;}&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This error should not appear when logback version is 1.3.3 or higher&lt;/p&gt;

&lt;p&gt;&lt;em&gt;@SuppressWarnings(&quot;unchecked&quot;)&lt;/em&gt;&lt;br/&gt;
&lt;em&gt;public void setContextMap(Map contextMap) {&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160; &lt;em&gt;if (contextMap != null) {&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;em&gt;readWriteThreadLocalMap.set(new HashMap&amp;lt;String, String&amp;gt;(contextMap));&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160; &lt;em&gt;} else {&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;em&gt;readWriteThreadLocalMap.set(null);&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160; &lt;em&gt;}&lt;/em&gt;&lt;br/&gt;
&#160;&#160;&#160; &lt;em&gt;nullifyReadOnlyThreadLocalMap();&lt;/em&gt;&lt;br/&gt;
&lt;em&gt;}&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;The error rise when flink is staring with&#160; logback as logger&lt;/p&gt;</environment>
        <key id="13591132">FLINK-36227</key>
            <summary>NullPointerException when starting flink with logback logger</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="szymonszcz">Szymon</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 5 Sep 2024 08:48:15 +0000</created>
                <updated>Fri, 10 Jan 2025 19:00:11 +0000</updated>
                            <resolved>Fri, 10 Jan 2025 19:00:11 +0000</resolved>
                                    <version>1.20.0</version>
                                    <fixVersion>1.20.1</fixVersion>
                    <fixVersion>2.0-preview</fixVersion>
                                    <component>API / Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17912086" author="afedulov" created="Fri, 10 Jan 2025 18:59:58 +0000"  >&lt;p&gt;Merged:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master (2.0): &lt;a href=&quot;https://github.com/apache/flink/commit/34924affa9c09722759baadb245e5231a9840b4a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/34924affa9c09722759baadb245e5231a9840b4a&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;release-1.20: &lt;a href=&quot;https://github.com/apache/flink/commit/74fe51517793bf20d3077b64a890e4cbcc4d9f53&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/74fe51517793bf20d3077b64a890e4cbcc4d9f53&lt;/a&gt;&#160;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            43 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1r93k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>