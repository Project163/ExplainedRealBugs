<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:32:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9047] SlotPool can fail to release slots</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9047</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;SlotPool&lt;/tt&gt; releases idling slots. If the release operation fails (e.g. timeout), then it simply continues using the slot. This is problematic if the owning &lt;tt&gt;TaskExecutor&lt;/tt&gt; failed before and was unregistered in the meantime from the &lt;tt&gt;SlotPool&lt;/tt&gt;. As a result, the &lt;tt&gt;SlotPool&lt;/tt&gt; will reuse the slot and whenever it tries to return because it is idling it will fail again. This, effectively, renders the scheduling of a job impossible.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13146902">FLINK-9047</key>
            <summary>SlotPool can fail to release slots</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>flip-6</label>
                    </labels>
                <created>Wed, 21 Mar 2018 16:42:56 +0000</created>
                <updated>Fri, 23 Mar 2018 11:42:50 +0000</updated>
                            <resolved>Fri, 23 Mar 2018 11:42:50 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16408249" author="sihuazhou" created="Wed, 21 Mar 2018 17:07:47 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; have you already work on this? Or I&apos;d like to take this ticket.&lt;/p&gt;</comment>
                            <comment id="16408322" author="githubbot" created="Wed, 21 Mar 2018 17:48:23 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9047&quot; title=&quot;SlotPool can fail to release slots&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9047&quot;&gt;&lt;del&gt;FLINK-9047&lt;/del&gt;&lt;/a&gt; Fix slot recycling in case of failed release&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    In case that a slot cannot be released it will only recycled/reused if the owning&lt;br/&gt;
    TaskExecutor is still registered at the SlotPool. If this is not the case then we&lt;br/&gt;
    drop the slot from the SlotPool.&lt;/p&gt;

&lt;p&gt;    cc @GJL &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Only recycle slots which could not be released if owner is still registered&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added `SlotPoolTest#testReleasingIdleSlotFailed`.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; moreLogging&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5739&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit fbaa3c1c94af6d7ba26ec6e554e35d9d9b400054&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-03-21T14:09:46Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Improve Flip-6 component logging&lt;/p&gt;

&lt;p&gt;commit 46cda67300fd153828769af8b4139b64b60e34d4&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-03-21T15:48:52Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9047&quot; title=&quot;SlotPool can fail to release slots&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9047&quot;&gt;&lt;del&gt;FLINK-9047&lt;/del&gt;&lt;/a&gt; Fix slot recycling in case of failed release&lt;/p&gt;

&lt;p&gt;    In case that a slot cannot be released it will only recycled/reused if the owning&lt;br/&gt;
    TaskExecutor is still registered at the SlotPool. If this is not the case then we&lt;br/&gt;
    drop the slot from the SlotPool.&lt;/p&gt;

&lt;p&gt;commit c9f3e037021dc8c37eceaaac181eb19c141f0bb7&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-03-21T17:44:25Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Remove unused method from SlotPool&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16409235" author="till.rohrmann" created="Thu, 22 Mar 2018 08:51:34 +0000"  >&lt;p&gt;Sorry &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sihuazhou&quot; class=&quot;user-hover&quot; rel=&quot;sihuazhou&quot;&gt;sihuazhou&lt;/a&gt;, I saw your comment too late. But maybe you could review my PR.&lt;/p&gt;</comment>
                            <comment id="16409257" author="githubbot" created="Thu, 22 Mar 2018 09:09:23 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739#discussion_r176347600&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739#discussion_r176347600&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/resources/log4j-test.properties &amp;#8212;&lt;br/&gt;
    @@ -16,7 +16,7 @@&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;limitations under the License.&lt;br/&gt;
     ################################################################################&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    -log4j.rootLogger=OFF, console&lt;br/&gt;
    +log4j.rootLogger=DEBUG, console&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think this should be reverted.&lt;/p&gt;</comment>
                            <comment id="16409455" author="githubbot" created="Thu, 22 Mar 2018 12:38:39 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739#discussion_r176400741&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739#discussion_r176400741&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolTest.java &amp;#8212;&lt;br/&gt;
    @@ -634,6 +653,99 @@ public void testCheckIdleSlot() throws Exception {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that idle slots which cannot be released are only recycled if the owning &lt;/p&gt;
{@link TaskExecutor}
&lt;p&gt;    +	 * is still registered at the &lt;/p&gt;
{@link SlotPool}
&lt;p&gt;. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9047&quot; title=&quot;SlotPool can fail to release slots&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9047&quot;&gt;&lt;del&gt;FLINK-9047&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testReleasingIdleSlotFailed() throws Exception {&lt;br/&gt;
    +		final ManualClock clock = new ManualClock();&lt;br/&gt;
    +		final SlotPool slotPool = new SlotPool(&lt;br/&gt;
    +			rpcService,&lt;br/&gt;
    +			jobId,&lt;br/&gt;
    +			clock,&lt;br/&gt;
    +			TestingUtils.infiniteTime(),&lt;br/&gt;
    +			timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final SlotPoolGateway slotPoolGateway = setupSlotPool(slotPool, resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +			final AllocationID expiredAllocationId = new AllocationID();&lt;br/&gt;
    +			final SlotOffer slotToExpire = new SlotOffer(expiredAllocationId, 0, ResourceProfile.UNKNOWN);&lt;br/&gt;
    +&lt;br/&gt;
    +			final ArrayDeque&amp;lt;CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; responseQueue = new ArrayDeque&amp;lt;&amp;gt;(2);&lt;br/&gt;
    +			taskManagerGateway.setFreeSlotFunction((AllocationID allocationId, Throwable cause) -&amp;gt; {&lt;br/&gt;
    +				if (responseQueue.isEmpty()) &lt;/p&gt;
{
    +					return CompletableFuture.completedFuture(Acknowledge.get());
    +				}
&lt;p&gt; else &lt;/p&gt;
{
    +					return responseQueue.pop();
    +				}
&lt;p&gt;    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +			responseQueue.add(FutureUtils.completedExceptionally(new FlinkException(&quot;Test failure&quot;)));&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Acknowledge&amp;gt; responseFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			responseQueue.add(responseFuture);&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(&lt;br/&gt;
    +				slotPoolGateway.registerTaskManager(taskManagerLocation.getResourceID()).get(),&lt;br/&gt;
    +				Matchers.is(Acknowledge.get()));&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(&lt;br/&gt;
    +				slotPoolGateway.offerSlot(taskManagerLocation, taskManagerGateway, slotToExpire).get(),&lt;br/&gt;
    +				Matchers.is(true));&lt;br/&gt;
    +&lt;br/&gt;
    +			clock.advanceTime(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +			slotPool.triggerCheckIdleSlot();&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture&amp;lt;LogicalSlot&amp;gt; allocatedSlotFuture = slotPoolGateway.allocateSlot(&lt;br/&gt;
    +				new SlotRequestId(),&lt;br/&gt;
    +				new DummyScheduledUnit(),&lt;br/&gt;
    +				SlotProfile.noRequirements(),&lt;br/&gt;
    +				true,&lt;br/&gt;
    +				timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			// wait until the slot has been fulfilled with the previously idling slot&lt;br/&gt;
    +			final LogicalSlot logicalSlot = allocatedSlotFuture.get();&lt;br/&gt;
    +			assertThat(logicalSlot.getAllocationId(), Matchers.is(expiredAllocationId));&lt;br/&gt;
    +&lt;br/&gt;
    +			// return the slot&lt;br/&gt;
    +			slotPool.getSlotOwner().returnAllocatedSlot(logicalSlot).get();&lt;br/&gt;
    +&lt;br/&gt;
    +			// advance the time so that the returned slot is now idling&lt;br/&gt;
    +			clock.advanceTime(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +			slotPool.triggerCheckIdleSlot();&lt;br/&gt;
    +&lt;br/&gt;
    +			// request a new slot after the idling slot has been released&lt;br/&gt;
    +			allocatedSlotFuture = slotPoolGateway.allocateSlot(&lt;br/&gt;
    +				new SlotRequestId(),&lt;br/&gt;
    +				new DummyScheduledUnit(),&lt;br/&gt;
    +				SlotProfile.noRequirements(),&lt;br/&gt;
    +				true,&lt;br/&gt;
    +				timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			// release the TaskExecutor before we get a response from the slot releasing&lt;br/&gt;
    +			slotPoolGateway.releaseTaskManager(taskManagerLocation.getResourceID()).get();&lt;br/&gt;
    +&lt;br/&gt;
    +			// let the slot releasing fail --&amp;gt; since there the owning TaskExecutor is no longer registered&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: &lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; since there the owning &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="16409456" author="githubbot" created="Thu, 22 Mar 2018 12:38:39 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739#discussion_r176401066&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739#discussion_r176401066&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolTest.java &amp;#8212;&lt;br/&gt;
    @@ -634,6 +653,99 @@ public void testCheckIdleSlot() throws Exception {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that idle slots which cannot be released are only recycled if the owning &lt;/p&gt;
{@link TaskExecutor}
&lt;p&gt;    +	 * is still registered at the &lt;/p&gt;
{@link SlotPool}
&lt;p&gt;. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9047&quot; title=&quot;SlotPool can fail to release slots&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9047&quot;&gt;&lt;del&gt;FLINK-9047&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testReleasingIdleSlotFailed() throws Exception {&lt;br/&gt;
    +		final ManualClock clock = new ManualClock();&lt;br/&gt;
    +		final SlotPool slotPool = new SlotPool(&lt;br/&gt;
    +			rpcService,&lt;br/&gt;
    +			jobId,&lt;br/&gt;
    +			clock,&lt;br/&gt;
    +			TestingUtils.infiniteTime(),&lt;br/&gt;
    +			timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final SlotPoolGateway slotPoolGateway = setupSlotPool(slotPool, resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +			final AllocationID expiredAllocationId = new AllocationID();&lt;br/&gt;
    +			final SlotOffer slotToExpire = new SlotOffer(expiredAllocationId, 0, ResourceProfile.UNKNOWN);&lt;br/&gt;
    +&lt;br/&gt;
    +			final ArrayDeque&amp;lt;CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; responseQueue = new ArrayDeque&amp;lt;&amp;gt;(2);&lt;br/&gt;
    +			taskManagerGateway.setFreeSlotFunction((AllocationID allocationId, Throwable cause) -&amp;gt; {&lt;br/&gt;
    +				if (responseQueue.isEmpty()) &lt;/p&gt;
{
    +					return CompletableFuture.completedFuture(Acknowledge.get());
    +				}
&lt;p&gt; else &lt;/p&gt;
{
    +					return responseQueue.pop();
    +				}
&lt;p&gt;    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +			responseQueue.add(FutureUtils.completedExceptionally(new FlinkException(&quot;Test failure&quot;)));&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Acknowledge&amp;gt; responseFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			responseQueue.add(responseFuture);&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(&lt;br/&gt;
    +				slotPoolGateway.registerTaskManager(taskManagerLocation.getResourceID()).get(),&lt;br/&gt;
    +				Matchers.is(Acknowledge.get()));&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(&lt;br/&gt;
    +				slotPoolGateway.offerSlot(taskManagerLocation, taskManagerGateway, slotToExpire).get(),&lt;br/&gt;
    +				Matchers.is(true));&lt;br/&gt;
    +&lt;br/&gt;
    +			clock.advanceTime(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +			slotPool.triggerCheckIdleSlot();&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture&amp;lt;LogicalSlot&amp;gt; allocatedSlotFuture = slotPoolGateway.allocateSlot(&lt;br/&gt;
    +				new SlotRequestId(),&lt;br/&gt;
    +				new DummyScheduledUnit(),&lt;br/&gt;
    +				SlotProfile.noRequirements(),&lt;br/&gt;
    +				true,&lt;br/&gt;
    +				timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			// wait until the slot has been fulfilled with the previously idling slot&lt;br/&gt;
    +			final LogicalSlot logicalSlot = allocatedSlotFuture.get();&lt;br/&gt;
    +			assertThat(logicalSlot.getAllocationId(), Matchers.is(expiredAllocationId));&lt;br/&gt;
    +&lt;br/&gt;
    +			// return the slot&lt;br/&gt;
    +			slotPool.getSlotOwner().returnAllocatedSlot(logicalSlot).get();&lt;br/&gt;
    +&lt;br/&gt;
    +			// advance the time so that the returned slot is now idling&lt;br/&gt;
    +			clock.advanceTime(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +			slotPool.triggerCheckIdleSlot();&lt;br/&gt;
    +&lt;br/&gt;
    +			// request a new slot after the idling slot has been released&lt;br/&gt;
    +			allocatedSlotFuture = slotPoolGateway.allocateSlot(&lt;br/&gt;
    +				new SlotRequestId(),&lt;br/&gt;
    +				new DummyScheduledUnit(),&lt;br/&gt;
    +				SlotProfile.noRequirements(),&lt;br/&gt;
    +				true,&lt;br/&gt;
    +				timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			// release the TaskExecutor before we get a response from the slot releasing&lt;br/&gt;
    +			slotPoolGateway.releaseTaskManager(taskManagerLocation.getResourceID()).get();&lt;br/&gt;
    +&lt;br/&gt;
    +			// let the slot releasing fail --&amp;gt; since there the owning TaskExecutor is no longer registered&lt;br/&gt;
    +			// the slot should be discarded&lt;br/&gt;
    +			responseFuture.completeExceptionally(new FlinkException(&quot;Second test exception&quot;));&lt;br/&gt;
    +&lt;br/&gt;
    +			try {&lt;br/&gt;
    +				// since the slot msut have been discarded, we cannot fulfill the slot request&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: &lt;b&gt;msut&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="16409457" author="githubbot" created="Thu, 22 Mar 2018 12:38:39 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739#discussion_r176404156&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739#discussion_r176404156&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/clusterframework/types/TaskManagerSlot.java &amp;#8212;&lt;br/&gt;
    @@ -139,6 +139,16 @@ public boolean isMatchingRequirement(ResourceProfile required) &lt;/p&gt;
{
     		return resourceProfile.isMatching(required);
     	}

&lt;p&gt;    +	@Override&lt;br/&gt;
    +	public String toString() {&lt;br/&gt;
    +		return &quot;TaskManagerSlot{&quot; +&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `resourceProfile` and `taskManagerConnection` are deliberately not included?&lt;/p&gt;</comment>
                            <comment id="16411019" author="githubbot" created="Fri, 23 Mar 2018 08:45:09 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739#discussion_r176668534&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739#discussion_r176668534&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/resources/log4j-test.properties &amp;#8212;&lt;br/&gt;
    @@ -16,7 +16,7 @@&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;limitations under the License.&lt;br/&gt;
     ################################################################################&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    -log4j.rootLogger=OFF, console&lt;br/&gt;
    +log4j.rootLogger=DEBUG, console&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Good catch. Will fix it.&lt;/p&gt;</comment>
                            <comment id="16411020" author="githubbot" created="Fri, 23 Mar 2018 08:45:18 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739#discussion_r176668568&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739#discussion_r176668568&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolTest.java &amp;#8212;&lt;br/&gt;
    @@ -634,6 +653,99 @@ public void testCheckIdleSlot() throws Exception {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that idle slots which cannot be released are only recycled if the owning &lt;/p&gt;
{@link TaskExecutor}
&lt;p&gt;    +	 * is still registered at the &lt;/p&gt;
{@link SlotPool}
&lt;p&gt;. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9047&quot; title=&quot;SlotPool can fail to release slots&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9047&quot;&gt;&lt;del&gt;FLINK-9047&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testReleasingIdleSlotFailed() throws Exception {&lt;br/&gt;
    +		final ManualClock clock = new ManualClock();&lt;br/&gt;
    +		final SlotPool slotPool = new SlotPool(&lt;br/&gt;
    +			rpcService,&lt;br/&gt;
    +			jobId,&lt;br/&gt;
    +			clock,&lt;br/&gt;
    +			TestingUtils.infiniteTime(),&lt;br/&gt;
    +			timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final SlotPoolGateway slotPoolGateway = setupSlotPool(slotPool, resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +			final AllocationID expiredAllocationId = new AllocationID();&lt;br/&gt;
    +			final SlotOffer slotToExpire = new SlotOffer(expiredAllocationId, 0, ResourceProfile.UNKNOWN);&lt;br/&gt;
    +&lt;br/&gt;
    +			final ArrayDeque&amp;lt;CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; responseQueue = new ArrayDeque&amp;lt;&amp;gt;(2);&lt;br/&gt;
    +			taskManagerGateway.setFreeSlotFunction((AllocationID allocationId, Throwable cause) -&amp;gt; {&lt;br/&gt;
    +				if (responseQueue.isEmpty()) &lt;/p&gt;
{
    +					return CompletableFuture.completedFuture(Acknowledge.get());
    +				}
&lt;p&gt; else &lt;/p&gt;
{
    +					return responseQueue.pop();
    +				}
&lt;p&gt;    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +			responseQueue.add(FutureUtils.completedExceptionally(new FlinkException(&quot;Test failure&quot;)));&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Acknowledge&amp;gt; responseFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			responseQueue.add(responseFuture);&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(&lt;br/&gt;
    +				slotPoolGateway.registerTaskManager(taskManagerLocation.getResourceID()).get(),&lt;br/&gt;
    +				Matchers.is(Acknowledge.get()));&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(&lt;br/&gt;
    +				slotPoolGateway.offerSlot(taskManagerLocation, taskManagerGateway, slotToExpire).get(),&lt;br/&gt;
    +				Matchers.is(true));&lt;br/&gt;
    +&lt;br/&gt;
    +			clock.advanceTime(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +			slotPool.triggerCheckIdleSlot();&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture&amp;lt;LogicalSlot&amp;gt; allocatedSlotFuture = slotPoolGateway.allocateSlot(&lt;br/&gt;
    +				new SlotRequestId(),&lt;br/&gt;
    +				new DummyScheduledUnit(),&lt;br/&gt;
    +				SlotProfile.noRequirements(),&lt;br/&gt;
    +				true,&lt;br/&gt;
    +				timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			// wait until the slot has been fulfilled with the previously idling slot&lt;br/&gt;
    +			final LogicalSlot logicalSlot = allocatedSlotFuture.get();&lt;br/&gt;
    +			assertThat(logicalSlot.getAllocationId(), Matchers.is(expiredAllocationId));&lt;br/&gt;
    +&lt;br/&gt;
    +			// return the slot&lt;br/&gt;
    +			slotPool.getSlotOwner().returnAllocatedSlot(logicalSlot).get();&lt;br/&gt;
    +&lt;br/&gt;
    +			// advance the time so that the returned slot is now idling&lt;br/&gt;
    +			clock.advanceTime(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +			slotPool.triggerCheckIdleSlot();&lt;br/&gt;
    +&lt;br/&gt;
    +			// request a new slot after the idling slot has been released&lt;br/&gt;
    +			allocatedSlotFuture = slotPoolGateway.allocateSlot(&lt;br/&gt;
    +				new SlotRequestId(),&lt;br/&gt;
    +				new DummyScheduledUnit(),&lt;br/&gt;
    +				SlotProfile.noRequirements(),&lt;br/&gt;
    +				true,&lt;br/&gt;
    +				timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			// release the TaskExecutor before we get a response from the slot releasing&lt;br/&gt;
    +			slotPoolGateway.releaseTaskManager(taskManagerLocation.getResourceID()).get();&lt;br/&gt;
    +&lt;br/&gt;
    +			// let the slot releasing fail --&amp;gt; since there the owning TaskExecutor is no longer registered&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Will fix it.&lt;/p&gt;</comment>
                            <comment id="16411024" author="githubbot" created="Fri, 23 Mar 2018 08:46:44 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739#discussion_r176668855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739#discussion_r176668855&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolTest.java &amp;#8212;&lt;br/&gt;
    @@ -634,6 +653,99 @@ public void testCheckIdleSlot() throws Exception {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that idle slots which cannot be released are only recycled if the owning &lt;/p&gt;
{@link TaskExecutor}
&lt;p&gt;    +	 * is still registered at the &lt;/p&gt;
{@link SlotPool}
&lt;p&gt;. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9047&quot; title=&quot;SlotPool can fail to release slots&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9047&quot;&gt;&lt;del&gt;FLINK-9047&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testReleasingIdleSlotFailed() throws Exception {&lt;br/&gt;
    +		final ManualClock clock = new ManualClock();&lt;br/&gt;
    +		final SlotPool slotPool = new SlotPool(&lt;br/&gt;
    +			rpcService,&lt;br/&gt;
    +			jobId,&lt;br/&gt;
    +			clock,&lt;br/&gt;
    +			TestingUtils.infiniteTime(),&lt;br/&gt;
    +			timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final SlotPoolGateway slotPoolGateway = setupSlotPool(slotPool, resourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +			final AllocationID expiredAllocationId = new AllocationID();&lt;br/&gt;
    +			final SlotOffer slotToExpire = new SlotOffer(expiredAllocationId, 0, ResourceProfile.UNKNOWN);&lt;br/&gt;
    +&lt;br/&gt;
    +			final ArrayDeque&amp;lt;CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; responseQueue = new ArrayDeque&amp;lt;&amp;gt;(2);&lt;br/&gt;
    +			taskManagerGateway.setFreeSlotFunction((AllocationID allocationId, Throwable cause) -&amp;gt; {&lt;br/&gt;
    +				if (responseQueue.isEmpty()) &lt;/p&gt;
{
    +					return CompletableFuture.completedFuture(Acknowledge.get());
    +				}
&lt;p&gt; else &lt;/p&gt;
{
    +					return responseQueue.pop();
    +				}
&lt;p&gt;    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +			responseQueue.add(FutureUtils.completedExceptionally(new FlinkException(&quot;Test failure&quot;)));&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Acknowledge&amp;gt; responseFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			responseQueue.add(responseFuture);&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(&lt;br/&gt;
    +				slotPoolGateway.registerTaskManager(taskManagerLocation.getResourceID()).get(),&lt;br/&gt;
    +				Matchers.is(Acknowledge.get()));&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(&lt;br/&gt;
    +				slotPoolGateway.offerSlot(taskManagerLocation, taskManagerGateway, slotToExpire).get(),&lt;br/&gt;
    +				Matchers.is(true));&lt;br/&gt;
    +&lt;br/&gt;
    +			clock.advanceTime(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +			slotPool.triggerCheckIdleSlot();&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture&amp;lt;LogicalSlot&amp;gt; allocatedSlotFuture = slotPoolGateway.allocateSlot(&lt;br/&gt;
    +				new SlotRequestId(),&lt;br/&gt;
    +				new DummyScheduledUnit(),&lt;br/&gt;
    +				SlotProfile.noRequirements(),&lt;br/&gt;
    +				true,&lt;br/&gt;
    +				timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			// wait until the slot has been fulfilled with the previously idling slot&lt;br/&gt;
    +			final LogicalSlot logicalSlot = allocatedSlotFuture.get();&lt;br/&gt;
    +			assertThat(logicalSlot.getAllocationId(), Matchers.is(expiredAllocationId));&lt;br/&gt;
    +&lt;br/&gt;
    +			// return the slot&lt;br/&gt;
    +			slotPool.getSlotOwner().returnAllocatedSlot(logicalSlot).get();&lt;br/&gt;
    +&lt;br/&gt;
    +			// advance the time so that the returned slot is now idling&lt;br/&gt;
    +			clock.advanceTime(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +			slotPool.triggerCheckIdleSlot();&lt;br/&gt;
    +&lt;br/&gt;
    +			// request a new slot after the idling slot has been released&lt;br/&gt;
    +			allocatedSlotFuture = slotPoolGateway.allocateSlot(&lt;br/&gt;
    +				new SlotRequestId(),&lt;br/&gt;
    +				new DummyScheduledUnit(),&lt;br/&gt;
    +				SlotProfile.noRequirements(),&lt;br/&gt;
    +				true,&lt;br/&gt;
    +				timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			// release the TaskExecutor before we get a response from the slot releasing&lt;br/&gt;
    +			slotPoolGateway.releaseTaskManager(taskManagerLocation.getResourceID()).get();&lt;br/&gt;
    +&lt;br/&gt;
    +			// let the slot releasing fail --&amp;gt; since there the owning TaskExecutor is no longer registered&lt;br/&gt;
    +			// the slot should be discarded&lt;br/&gt;
    +			responseFuture.completeExceptionally(new FlinkException(&quot;Second test exception&quot;));&lt;br/&gt;
    +&lt;br/&gt;
    +			try {&lt;br/&gt;
    +				// since the slot msut have been discarded, we cannot fulfill the slot request&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Good catch&lt;/p&gt;</comment>
                            <comment id="16411025" author="githubbot" created="Fri, 23 Mar 2018 08:47:02 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739#discussion_r176668913&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739#discussion_r176668913&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/clusterframework/types/TaskManagerSlot.java &amp;#8212;&lt;br/&gt;
    @@ -139,6 +139,16 @@ public boolean isMatchingRequirement(ResourceProfile required) &lt;/p&gt;
{
     		return resourceProfile.isMatching(required);
     	}

&lt;p&gt;    +	@Override&lt;br/&gt;
    +	public String toString() {&lt;br/&gt;
    +		return &quot;TaskManagerSlot{&quot; +&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Will add them.&lt;/p&gt;</comment>
                            <comment id="16411039" author="githubbot" created="Fri, 23 Mar 2018 09:06:05 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @GJL. Merging this PR.&lt;/p&gt;</comment>
                            <comment id="16411261" author="githubbot" created="Fri, 23 Mar 2018 11:40:15 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5739&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5739&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16411269" author="till.rohrmann" created="Fri, 23 Mar 2018 11:42:50 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
master: 6c70b7bd8e15684358fddc802f2eb9e62c9a16ac&lt;br/&gt;
1.5.0: c28828591073399ef1585f16a3a76fbf327e7be4&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 34 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3rlun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>