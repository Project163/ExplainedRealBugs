<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:22:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-38415] IndexOutOfBoundsException occasionally occurs after rocksdb.use-ingest-db-restore-mode is enabled</title>
                <link>https://issues.apache.org/jira/browse/FLINK-38415</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;h1&gt;&lt;a name=&quot;1.Exception%3A&quot;&gt;&lt;/a&gt;1. Exception:&lt;/h1&gt;

&lt;p&gt;Following is the exception stack:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IndexOutOfBoundsException: Index -1 out of bounds &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; length 0
	at java.base/jdk.internal.util.Preconditions.outOfBounds(Preconditions.java:64)
	at java.base/jdk.internal.util.Preconditions.outOfBoundsCheckIndex(Preconditions.java:70)
	at java.base/jdk.internal.util.Preconditions.checkIndex(Preconditions.java:248)
	at java.base/java.util.Objects.checkIndex(Objects.java:374)
	at java.base/java.util.ArrayList.remove(ArrayList.java:536)
	at org.apache.flink.contrib.streaming.state.restore.RocksDBIncrementalRestoreOperation.mergeStateHandlesWithCopyFromTemporaryInstance(RocksDBIncrementalRestoreOperation.java:691)
	at org.apache.flink.contrib.streaming.state.restore.RocksDBIncrementalRestoreOperation.mergeStateHandlesWithClipAndIngest(RocksDBIncrementalRestoreOperation.java:531)
	at org.apache.flink.contrib.streaming.state.restore.RocksDBIncrementalRestoreOperation.restoreFromMultipleStateHandles(RocksDBIncrementalRestoreOperation.java:477)
	at org.apache.flink.contrib.streaming.state.restore.RocksDBIncrementalRestoreOperation.restoreFromLocalState(RocksDBIncrementalRestoreOperation.java:358)
	at org.apache.flink.contrib.streaming.state.restore.RocksDBIncrementalRestoreOperation.lambda$restore$1(RocksDBIncrementalRestoreOperation.java:270)
	at org.apache.flink.contrib.streaming.state.restore.RocksDBIncrementalRestoreOperation.runAndReportDuration(RocksDBIncrementalRestoreOperation.java:1058)
	at org.apache.flink.contrib.streaming.state.restore.RocksDBIncrementalRestoreOperation.restore(RocksDBIncrementalRestoreOperation.java:269)
	at org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackendBuilder.build(RocksDBKeyedStateBackendBuilder.java:396)
	at org.apache.flink.contrib.streaming.state.EmbeddedRocksDBStateBackend.createKeyedStateBackend(EmbeddedRocksDBStateBackend.java:550)
	at org.apache.flink.contrib.streaming.state.EmbeddedRocksDBStateBackend.createKeyedStateBackend(EmbeddedRocksDBStateBackend.java:98)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.lambda$keyedStatedBackend$3(StreamTaskStateInitializerImpl.java:397)
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.attemptCreateAndRestore(BackendRestorerProcedure.java:173)
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:137)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.keyedStatedBackend(StreamTaskStateInitializerImpl.java:403)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:181)
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:292)
	at org.apache.flink.streaming.runtime.tasks.RegularOperatorChain.initializeStateAndOpenOperators(RegularOperatorChain.java:114)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.restoreStateAndGates(StreamTask.java:829)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$restoreInternal$3(StreamTask.java:781)
	at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.call(StreamTaskActionExecutor.java:55)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.restoreInternal(StreamTask.java:781)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.restore(StreamTask.java:734)
	at org.apache.flink.runtime.taskmanager.Task.runWithSystemExitMonitoring(Task.java:1057)
	at org.apache.flink.runtime.taskmanager.Task.restoreAndInvoke(Task.java:1016)
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:840)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:654)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;2.DirectRootCause%3AmergeStateHandlesWithClipAndIngestLogicFailure&quot;&gt;&lt;/a&gt;2. Direct Root Cause: mergeStateHandlesWithClipAndIngest Logic Failure&lt;/h1&gt;

&lt;p&gt;The `mergeStateHandlesWithClipAndIngest` method distributes state handles into two lists:&lt;/p&gt;

&lt;p&gt;1.&#160; exportedColumnFamilyMetaData: Contains SST files that can be directly imported&lt;br/&gt;
2. notImportableHandles: Contains state handles that need to be copied via temporary DB&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Critical Assumption&lt;/b&gt;: If `localKeyedStateHandles` is not empty, then at least one of the two resulting lists should contain data.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;3.WhyBothListsBecomeEmpty%28AbnormalCase%29&quot;&gt;&lt;/a&gt;3. Why Both Lists Become Empty (Abnormal Case)&lt;/h1&gt;

&lt;p&gt;Under normal circumstances, both lists should never be empty because:&lt;/p&gt;

&lt;p&gt;1. notImportableHandles gets populated when:&lt;br/&gt;
&#160; &#160;- State handle data exceeds the proclaimed key-group range&lt;br/&gt;
&#160; &#160;- Range check fails for any reason&lt;br/&gt;
&#160; &#160;- Export process encounters errors&lt;/p&gt;

&lt;p&gt;2.&#160; exportedColumnFamilyMetaData gets populated when:&lt;br/&gt;
&#160; &#160;- State handle data is within the expected range&lt;br/&gt;
&#160; &#160;- Export process successfully creates SST files&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Why both lists become empty in the bug scenario?&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Auto-compaction during restore: When RocksDB opens temporary instances for each state handle, auto-compaction is triggered&lt;/li&gt;
	&lt;li&gt;Compaction removes SST files: If all records in SST files are expired or marked for deletion, compaction removes the files entirely&lt;/li&gt;
	&lt;li&gt;Export process finds no files: `RocksDBIncrementalCheckpointUtils.exportColumnFamilies()` attempts to export but finds no SST files&lt;/li&gt;
	&lt;li&gt;Both lists remain empty: Neither `exportedColumnFamilyMetaData` nor `notImportableHandles` gets populated&lt;/li&gt;
&lt;/ol&gt;


&lt;h1&gt;&lt;a name=&quot;&quot;&gt;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;4. How to 100% Trigger the Bug&lt;/p&gt;

&lt;p&gt;The bug requires these specific conditions:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Enable ingest-db-restore-mode: `state.backend.rocksdb.use-ingest-db-restore-mode=true`&lt;/li&gt;
	&lt;li&gt;All records are deleted or expired by TTL&lt;/li&gt;
	&lt;li&gt;Scale operation: Triggers restore with multiple state handles&lt;/li&gt;
	&lt;li&gt;Auto-compaction during restore**: Removes expired/deleted SST files&lt;/li&gt;
	&lt;li&gt;4th checkpoint: Creates 4 SST files in level0 to trigger compaction during restore&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Note: adding a slight sleep(such as 500ms) between open rocksdb db and export sst files during recovery is helpful for reproduce bug.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;TriggerSequence%3A&quot;&gt;&lt;/a&gt;Trigger Sequence:&lt;/h2&gt;
&lt;ol&gt;
	&lt;li&gt;Checkpoint 1-4: Create SST files in L0&lt;/li&gt;
	&lt;li&gt;Scale operation: Triggers restore with `mergeStateHandlesWithClipAndIngest`&lt;/li&gt;
	&lt;li&gt;Auto-compaction: Removes SST files during temporary DB restore&lt;/li&gt;
	&lt;li&gt;Empty lists: Both `exportedColumnFamilyMetaData` and `notImportableHandles` are empty&lt;/li&gt;
	&lt;li&gt;Fallback:`mergeStateHandlesWithCopyFromTemporaryInstance(notImportableHandles, ...)` called with empty list&lt;/li&gt;
	&lt;li&gt;IndexOutOfBoundsException: `findTheBestStateHandleForInitial` returns -1 for empty list&lt;/li&gt;
&lt;/ol&gt;


&lt;h1&gt;&lt;a name=&quot;5.ApproachAnalysis&quot;&gt;&lt;/a&gt;5. Approach Analysis&lt;/h1&gt;

&lt;p&gt;Proposed approach: Disable Auto-compaction&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Advantagesofthisapproach%3A&quot;&gt;&lt;/a&gt;Advantages of this approach:&lt;/h2&gt;
&lt;ul&gt;
	&lt;li&gt;Preserves SST file structure during restore&lt;/li&gt;
	&lt;li&gt;Prevents unexpected data removal during critical operations&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;&lt;a name=&quot;AlternativeSolution%3AHandleEmptyLists&quot;&gt;&lt;/a&gt;Alternative Solution: Handle Empty Lists&lt;/h2&gt;

&lt;p&gt;Another approach would be to modify `mergeStateHandlesWithClipAndIngest` to handle the case where both lists are empty:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exportedColumnFamilyMetaData.isEmpty() &amp;amp;&amp;amp; notImportableHandles.isEmpty()) {
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Both lists empty - create empty DB or handle appropriately
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// or create empty base DB
&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exportedColumnFamilyMetaData.isEmpty()) {
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Fall back to copy method
&lt;/span&gt;&#160; &#160; mergeStateHandlesWithCopyFromTemporaryInstance(
&#160; &#160; &#160; &#160; notImportableHandles, startKeyGroupPrefixBytes, stopKeyGroupPrefixBytes);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Why this alternative was not chosen:&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*&lt;b&gt;Potential risks&lt;/b&gt;*: Could mask underlying data corruption issues&lt;/li&gt;
	&lt;li&gt;*&lt;b&gt;Data integrity concerns&lt;/b&gt;*: Empty lists might indicate genuine restore problems&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The chosen solution (disabling auto-compaction) is safer because it addresses the root cause while maintaining the existing validation logic and error detection mechanisms.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13629698">FLINK-38415</key>
            <summary>IndexOutOfBoundsException occasionally occurs after rocksdb.use-ingest-db-restore-mode is enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fanrui">Rui Fan</assignee>
                                    <reporter username="fanrui">Rui Fan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 23 Sep 2025 11:54:00 +0000</created>
                <updated>Sun, 12 Oct 2025 17:28:30 +0000</updated>
                            <resolved>Sun, 12 Oct 2025 17:28:30 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>2.1.0</version>
                    <version>1.20.3</version>
                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="18024263" author="fanrui" created="Thu, 2 Oct 2025 11:59:51 +0000"  >&lt;p&gt;Merged to master(2.2.0) via : 724d3df8927fe7134f5262da02adceab7ef9c4e0 and b4eaf3ce6fcc008420d89d3454cd02851206a27b&lt;/p&gt;

&lt;p&gt;2.1.1 via: 96b382546323523aae02cb646bbb1adee29f5930 and 1c3b53d5311382bda03771104ea0d790f6b87dd5&lt;/p&gt;

&lt;p&gt;2.0.1 via: fac89ba7dcceab782dec211bcdc47982b54081c9 and 4bb815a753a04767b72d9161e182db6d39b6a30c&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xtt4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>