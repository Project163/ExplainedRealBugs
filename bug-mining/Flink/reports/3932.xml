<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:45:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-16576] State inconsistency on restore with memory state backends</title>
                <link>https://issues.apache.org/jira/browse/FLINK-16576</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I occasionally see a few state inconsistencies with the &lt;tt&gt;TopSpeedWindowing&lt;/tt&gt; example in Flink. Restore would fail with either of these causes, but only for the memory state backends and only with some combinations of parallelism I took the savepoint with and parallelism I restore the job with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalArgumentException: KeyGroupRange{startKeyGroup=64, endKeyGroup=95} does not contain key group 97 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;or&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readKeyGroupStateData(HeapRestoreOperation.java:280) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;or&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.io.IOException: Corrupt stream, found tag: 8
	at org.apache.flink.streaming.runtime.streamrecord.StreamElementSerializer.deserialize(StreamElementSerializer.java:217) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I managed to make it reproducible in a test that I quickly hacked together in&#160;&lt;a href=&quot;https://github.com/NicoK/flink/blob/state.corruption.debug/flink-examples/flink-examples-streaming/src/test/java/org/apache/flink/streaming/test/examples/windowing/TopSpeedWindowingSavepointRestoreITCase.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/NicoK/flink/blob/state.corruption.debug/flink-examples/flink-examples-streaming/src/test/java/org/apache/flink/streaming/test/examples/windowing/TopSpeedWindowingSavepointRestoreITCase.java&lt;/a&gt; (please checkout the whole repository since I had to change some dependencies).&lt;/p&gt;

&lt;p&gt;In a bit more detail, this is what I discovered before, also with a manual savepoint on S3:&lt;/p&gt;

&lt;p&gt;Savepoint that was taken with parallelism 2 (p=2) and shows the restore failure in three different ways (all running in Flink 1.10.0; but I also see it in Flink 1.9):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;first of all, if I try to restore with p=2, everything is fine&lt;/li&gt;
	&lt;li&gt;if I restore with p=4 I get an exception like the one mentioned above:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-03-11 15:53:35,149 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph        - Window(GlobalWindows(), DeltaTrigger, TimeEvictor, ComparableAggregator, PassThroughWindowFunction) -&amp;gt; Sink: Print to Std. Out (3/4) (2ecdb03905cc8a376d43b086925452a6) switched from RUNNING to FAILED.
java.lang.Exception: Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; creating StreamOperatorStateContext.
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:191)
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:255)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.initializeStateAndOpen(StreamTask.java:1006)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$beforeInvoke$0(StreamTask.java:454)
	at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$SynchronizedStreamTaskActionExecutor.runThrowing(StreamTaskActionExecutor.java:94)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.beforeInvoke(StreamTask.java:449)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:461)
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:707)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:532)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: org.apache.flink.util.FlinkException: Could not restore keyed state backend &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; EvictingWindowOperator_90bea66de1c231edf33913ecd54406c1_(3/4) from any of the 1 provided restore options.
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:135)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.keyedStatedBackend(StreamTaskStateInitializerImpl.java:304)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:131)
	... 9 more
Caused by: org.apache.flink.runtime.state.BackendBuildingException: Failed when trying to restore heap backend
	at org.apache.flink.runtime.state.heap.HeapKeyedStateBackendBuilder.build(HeapKeyedStateBackendBuilder.java:116)
	at org.apache.flink.runtime.state.filesystem.FsStateBackend.createKeyedStateBackend(FsStateBackend.java:529)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.lambda$keyedStatedBackend$1(StreamTaskStateInitializerImpl.java:288)
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.attemptCreateAndRestore(BackendRestorerProcedure.java:142)
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:121)
	... 11 more
Caused by: java.lang.IllegalArgumentException: KeyGroupRange{startKeyGroup=64, endKeyGroup=95} does not contain key group 97
	at org.apache.flink.util.Preconditions.checkArgument(Preconditions.java:161)
	at org.apache.flink.runtime.state.heap.HeapPriorityQueueSet.globalKeyGroupToLocalIndex(HeapPriorityQueueSet.java:158)
	at org.apache.flink.runtime.state.heap.HeapPriorityQueueSet.getDedupMapForKeyGroup(HeapPriorityQueueSet.java:147)
	at org.apache.flink.runtime.state.heap.HeapPriorityQueueSet.getDedupMapForElement(HeapPriorityQueueSet.java:154)
	at org.apache.flink.runtime.state.heap.HeapPriorityQueueSet.add(HeapPriorityQueueSet.java:121)
	at org.apache.flink.runtime.state.heap.HeapPriorityQueueSnapshotRestoreWrapper.lambda$keyGroupReader$0(HeapPriorityQueueSnapshotRestoreWrapper.java:85)
	at org.apache.flink.runtime.state.KeyGroupPartitioner$PartitioningResultKeyGroupReader.readMappingsInKeyGroup(KeyGroupPartitioner.java:298)
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readKeyGroupStateData(HeapRestoreOperation.java:293)
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readStateHandleStateData(HeapRestoreOperation.java:254)
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.restore(HeapRestoreOperation.java:153)
	at org.apache.flink.runtime.state.heap.HeapKeyedStateBackendBuilder.build(HeapKeyedStateBackendBuilder.java:114)
	... 15 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;if I restore with p=3, I get the following exception instead:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-03-11 21:40:28,390 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph        - Window(GlobalWindows(), DeltaTrigger, TimeEvictor, ComparableAggregator, PassThroughWindowFunction) -&amp;gt; Sink: Print to Std. Out (3/3) (2fb8acde321f6cbfec56c300153d6dea) switched from RUNNING to FAILED.
java.lang.Exception: Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; creating StreamOperatorStateContext.
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:191)
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:255)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.initializeStateAndOpen(StreamTask.java:1006)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$beforeInvoke$0(StreamTask.java:454)
	at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$SynchronizedStreamTaskActionExecutor.runThrowing(StreamTaskActionExecutor.java:94)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.beforeInvoke(StreamTask.java:449)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:461)
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:707)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:532)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: org.apache.flink.util.FlinkException: Could not restore keyed state backend &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; EvictingWindowOperator_90bea66de1c231edf33913ecd54406c1_(3/3) from any of the 1 provided restore options.
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:135)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.keyedStatedBackend(StreamTaskStateInitializerImpl.java:304)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:131)
	... 9 more
Caused by: org.apache.flink.runtime.state.BackendBuildingException: Failed when trying to restore heap backend
	at org.apache.flink.runtime.state.heap.HeapKeyedStateBackendBuilder.build(HeapKeyedStateBackendBuilder.java:116)
	at org.apache.flink.runtime.state.filesystem.FsStateBackend.createKeyedStateBackend(FsStateBackend.java:529)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.lambda$keyedStatedBackend$1(StreamTaskStateInitializerImpl.java:288)
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.attemptCreateAndRestore(BackendRestorerProcedure.java:142)
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:121)
	... 11 more
Caused by: java.lang.NullPointerException
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readKeyGroupStateData(HeapRestoreOperation.java:280)
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readStateHandleStateData(HeapRestoreOperation.java:254)
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.restore(HeapRestoreOperation.java:153)
	at org.apache.flink.runtime.state.heap.HeapKeyedStateBackendBuilder.build(HeapKeyedStateBackendBuilder.java:114)
	... 15 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;While the latter error somewhat indicates that the savepoint may be corrupt (or that the reader/deserializer messed up), it remains a mystery to me why I can successfully restore with p=2.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;occasionally, for p=4, I also see this exception instead:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
10:23:12,046 WARN  org.apache.flink.streaming.api.operators.BackendRestorerProcedure  - Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; restoring keyed state backend &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; EvictingWindowOperator_90bea66de1c231edf33913ecd54406c1_(3/4) from alternative (1/1), will retry &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; more alternatives are available.
org.apache.flink.runtime.state.BackendBuildingException: Failed when trying to restore heap backend
	at org.apache.flink.runtime.state.heap.HeapKeyedStateBackendBuilder.build(HeapKeyedStateBackendBuilder.java:116)
	at org.apache.flink.runtime.state.filesystem.FsStateBackend.createKeyedStateBackend(FsStateBackend.java:529)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.lambda$keyedStatedBackend$1(StreamTaskStateInitializerImpl.java:288)
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.attemptCreateAndRestore(BackendRestorerProcedure.java:142)
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:121)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.keyedStatedBackend(StreamTaskStateInitializerImpl.java:304)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:131)
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:255)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.initializeStateAndOpen(StreamTask.java:1006)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$beforeInvoke$0(StreamTask.java:454)
	at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$SynchronizedStreamTaskActionExecutor.runThrowing(StreamTaskActionExecutor.java:94)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.beforeInvoke(StreamTask.java:449)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:461)
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:707)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:532)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.io.IOException: Corrupt stream, found tag: 8
	at org.apache.flink.streaming.runtime.streamrecord.StreamElementSerializer.deserialize(StreamElementSerializer.java:217)
	at org.apache.flink.streaming.runtime.streamrecord.StreamElementSerializer.deserialize(StreamElementSerializer.java:46)
	at org.apache.flink.api.common.typeutils.base.ListSerializer.deserialize(ListSerializer.java:133)
	at org.apache.flink.api.common.typeutils.base.ListSerializer.deserialize(ListSerializer.java:42)
	at org.apache.flink.runtime.state.heap.StateTableByKeyGroupReaders.lambda$createV2PlusReader$0(StateTableByKeyGroupReaders.java:77)
	at org.apache.flink.runtime.state.KeyGroupPartitioner$PartitioningResultKeyGroupReader.readMappingsInKeyGroup(KeyGroupPartitioner.java:297)
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readKeyGroupStateData(HeapRestoreOperation.java:295)
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readStateHandleStateData(HeapRestoreOperation.java:256)
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.restore(HeapRestoreOperation.java:155)
	at org.apache.flink.runtime.state.heap.HeapKeyedStateBackendBuilder.build(HeapKeyedStateBackendBuilder.java:114)
	... 15 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I narrowed the cause down to the state access inside &lt;tt&gt;DeltaTrigger&lt;/tt&gt;: Removing the cleanup in &lt;tt&gt;org.apache.flink.streaming.api.windowing.triggers.DeltaTrigger#clear()&lt;/tt&gt; did not change anything but removing state access in its &lt;tt&gt;onElement&lt;/tt&gt; (pictured below) seems to resolve the bug:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TriggerResult onElement(T element, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timestamp, W window, TriggerContext ctx) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
   ValueState&amp;lt;T&amp;gt; lastElementState = ctx.getPartitionedState(stateDesc);
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastElementState.value() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      lastElementState.update(element);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; TriggerResult.CONTINUE;
   }
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (deltaFunction.getDelta(lastElementState.value(), element) &amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.threshold) {
      lastElementState.update(element);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; TriggerResult.FIRE;
   }
   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; TriggerResult.CONTINUE;
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13291427">FLINK-16576</key>
            <summary>State inconsistency on restore with memory state backends</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="klion26">Congxian Qiu</assignee>
                                    <reporter username="nkruber">Nico Kruber</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 12 Mar 2020 21:39:22 +0000</created>
                <updated>Thu, 16 Apr 2020 07:46:29 +0000</updated>
                            <resolved>Thu, 16 Apr 2020 07:46:29 +0000</resolved>
                                    <version>1.9.2</version>
                    <version>1.10.0</version>
                                    <fixVersion>1.9.3</fixVersion>
                    <fixVersion>1.10.1</fixVersion>
                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17058562" author="aljoscha" created="Fri, 13 Mar 2020 09:40:14 +0000"  >&lt;p&gt;You are talking about heap-based state backends that do backup to a DFS? Not the actual &lt;tt&gt;MemoryStateBackend&lt;/tt&gt;, right?&lt;/p&gt;</comment>
                            <comment id="17058566" author="nicok" created="Fri, 13 Mar 2020 09:43:22 +0000"  >&lt;p&gt;Both actually: &lt;tt&gt;MemoryStateBackend&lt;/tt&gt; as well as &lt;tt&gt;FsStateBackend&lt;/tt&gt; as you can see in my test.&lt;/p&gt;

&lt;p&gt;So far, I did not see this for &lt;tt&gt;RocksDBStateBackend&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17069428" author="klion26" created="Sat, 28 Mar 2020 12:44:07 +0000"  >&lt;p&gt;The reason why the restore failed here because of that &lt;tt&gt;the &lt;b&gt;mapping of stateId and metaInfo is wrong&lt;/b&gt;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The mapping is wrong because we registered some metaInfos that do not belong to current subtask.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// HeapRestoreOperation#restore
&lt;/span&gt;createOrCheckStateForMetaInfo(restoredMetaInfos, kvStatesById); &lt;span class=&quot;code-comment&quot;&gt;// will register the metainfo
&lt;/span&gt;
readStateHandleStateData(
   fsDataInputStream,
   inView,
   keyGroupsStateHandle.getGroupRangeOffsets(),
   kvStatesById, restoredMetaInfos.size(),
   serializationProxy.getReadVersion(),
   serializationProxy.isUsingKeyGroupCompression());


&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void createOrCheckStateForMetaInfo(
   List&amp;lt;StateMetaInfoSnapshot&amp;gt; restoredMetaInfo,
   Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, StateMetaInfoSnapshot&amp;gt; kvStatesById) {

   &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (StateMetaInfoSnapshot metaInfoSnapshot : restoredMetaInfo) {
      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StateSnapshotRestore registeredState;

      ......

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (registeredState == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
         kvStatesById.put(kvStatesById.size(), metaInfoSnapshot); &lt;span class=&quot;code-comment&quot;&gt;// constructing the mapping between stateId and metaInfo, even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the current statehandle does not belong to the current subtask
&lt;/span&gt;      }
   }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;from the code above we can see, we&apos;ll always register the metainfo even if the current state handle does not belong to ourselves(the KeyGroupStateHandle will contain metaInfo, EMPTY_KEYGROUP, empty offsets and the stateHandle data). after the registered the wrong metainfo, then the &lt;b&gt;&lt;tt&gt;mapping of stateId and metaInfo becomes wrong(when constructing the mapping, we assume that all the handles belong to the current subtask).&lt;/tt&gt;&lt;/b&gt;&#160;&lt;tt&gt;(RocksDBStateBackend does not construct such mapping, so would not encounter such error).&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;For the solution here, I want to filter out the stateHandles out when assigning state to subtask in }}{{StateAssignmentOperation&lt;/tt&gt;.&lt;tt&gt;&#160;&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17070280" author="carp84" created="Sun, 29 Mar 2020 10:58:51 +0000"  >&lt;p&gt;Thanks for the analysis &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=klion26&quot; class=&quot;user-hover&quot; rel=&quot;klion26&quot;&gt;klion26&lt;/a&gt;. Checking the commit history, this seems to be a long existing problem.&lt;/p&gt;

&lt;p&gt;Since the root cause is incorrect mapping of &lt;tt&gt;stateId&lt;/tt&gt; and &lt;tt&gt;metaInfo&lt;/tt&gt;, I suggest we add some checking in &lt;tt&gt;HeapRestoreOperation&lt;/tt&gt; to reinforce the logic. Meantime, I think adding the filter in &lt;tt&gt;KeyGroupsStateHandle#getIntersection&lt;/tt&gt; also makes sense - to improve at both the dispatcher and the receiver side.&lt;/p&gt;</comment>
                            <comment id="17084041" author="carp84" created="Wed, 15 Apr 2020 12:28:45 +0000"  >&lt;p&gt;Fixed in master via:&lt;br/&gt;
0a4870d9ae5f71a243eb351816562cb706af3e9c&lt;br/&gt;
792dbf0b72ca8a7ac2cb00d4da3f84c7bfe1b59d&lt;/p&gt;

&lt;p&gt;Now working on release-1.10 and release-1.9&lt;/p&gt;</comment>
                            <comment id="17084633" author="carp84" created="Thu, 16 Apr 2020 07:43:18 +0000"  >&lt;p&gt;Merged in release-1.10 via:&lt;br/&gt;
1e9d72dbb353988a426f9da7e0f6efca06c44e62&lt;br/&gt;
ac2be600330ba1316e766d7da816b8078d7294bf&lt;/p&gt;

&lt;p&gt;Merged in release-1.9 via&lt;br/&gt;
bb6de2ddb37287da0def0f9d81dbc4792512e97a&lt;br/&gt;
e95eae275f21796f9983c4d8b0bc4be1a0483e94&lt;/p&gt;</comment>
                            <comment id="17084635" author="carp84" created="Thu, 16 Apr 2020 07:46:29 +0000"  >&lt;p&gt;Closing since issue fixed in all related branches.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0chc8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>