<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:52:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21138] KvStateServerHandler is not invoked with user code classloader</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21138</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When using e.g. custom Kryo serializers user code classloader has to be set as context classloader during invocation of methods such as TypeSerializer.duplicat()&lt;/p&gt;

&lt;p&gt;KvStateServerHandler does not do this, which leads to exceptions like ClassNotFound etc.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13354526">FLINK-21138</key>
            <summary>KvStateServerHandler is not invoked with user code classloader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mproch">Maciej Prochniak</assignee>
                                    <reporter username="mproch">Maciej Prochniak</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 25 Jan 2021 20:43:53 +0000</created>
                <updated>Thu, 11 Feb 2021 18:35:15 +0000</updated>
                            <resolved>Thu, 11 Feb 2021 17:50:53 +0000</resolved>
                                    <version>1.11.2</version>
                                    <fixVersion>1.11.4</fixVersion>
                    <fixVersion>1.12.2</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / Queryable State</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17272095" author="till.rohrmann" created="Tue, 26 Jan 2021 13:09:20 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mproch&quot; class=&quot;user-hover&quot; rel=&quot;mproch&quot;&gt;mproch&lt;/a&gt;. Could you give a short example illustrating the problem? I do not fully understand the problem yet. Maybe you have the problematic job already in some repository.&lt;/p&gt;</comment>
                            <comment id="17272393" author="mproch" created="Tue, 26 Jan 2021 20:23:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, thanks for quick response.&#160;&lt;br/&gt;
I attach smallest case I could come up with, and stack trace that is thrown.&lt;/p&gt;

&lt;p&gt;I think the problem is relatively straightforward and user classloader just needs to be passed down to&#160;KvStateEntry. I think I can prepare a PR, but I&apos;m not quite sure what kind of test would be suitable - as the problem involves custom classloaders etc.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17273026" author="till.rohrmann" created="Wed, 27 Jan 2021 17:24:55 +0000"  >&lt;p&gt;Thanks for posting this example. I am wondering whether the problem isn&apos;t that we are using the &lt;tt&gt;Thread.currentThread().getContextClassLoader()&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/kryo/KryoSerializer.java#L626&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; instead of &lt;tt&gt;original.getClass().getClassLoader()&lt;/tt&gt;. I think this should fix the problem.&lt;/p&gt;

&lt;p&gt;Test-wise you could take a look at the &lt;tt&gt;PojoSerializerUpgradeTest.testPojoSerializerUpgrade&lt;/tt&gt; which creates a new class and instantiates an &lt;tt&gt;URLClassLoader&lt;/tt&gt; to load it. If you then use the test thread, it should not know about this new class.&lt;/p&gt;</comment>
                            <comment id="17273371" author="mproch" created="Thu, 28 Jan 2021 06:55:04 +0000"  >&lt;p&gt;I think using original.getClass().getClassLoader() won&apos;t work here - &quot;original&quot; is&#160;SerializableSerializer wrapper, which is probably loaded by framework classloader. I think with such custom serializers the part loaded by user classloader can hidden via quite a few wrappers/decorators and using contextClassloader is safer, it&apos;s done like that also here:&#160;&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/state/JavaSerializer.java#L59&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll try to come up with PR with test&lt;/p&gt;</comment>
                            <comment id="17273766" author="till.rohrmann" created="Thu, 28 Jan 2021 14:37:55 +0000"  >&lt;p&gt;I think you are right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mproch&quot; class=&quot;user-hover&quot; rel=&quot;mproch&quot;&gt;mproch&lt;/a&gt;. The problem with context classloader is that it is not very explicit and can easily break (e.g. if a method further downstream sets a different context classloader). The clean solution would probably be to pass in an explicit classloader. But this would be super involved. Hence, I am ok with your proposal. I&apos;ve assigned you to the ticket.&lt;/p&gt;</comment>
                            <comment id="17281200" author="mproch" created="Mon, 8 Feb 2021 16:59:58 +0000"  >&lt;p&gt;I only had time this weekend to look at this: &lt;a href=&quot;https://github.com/apache/flink/pull/14902&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/14902&lt;/a&gt;&#160;- here is the change, I added integration test to verify the fix works&lt;/p&gt;</comment>
                            <comment id="17283252" author="till.rohrmann" created="Thu, 11 Feb 2021 17:50:53 +0000"  >&lt;p&gt;Fixed via &lt;/p&gt;

&lt;p&gt;1.13.0:&lt;/p&gt;

&lt;p&gt;8d9ffcdb2d05f1d9931a4ed4bb7fd9de6e770551&lt;br/&gt;
1e6d1d24ed03eb6c7a5fb1d67fea47cf69552e6c&lt;br/&gt;
9c04e64be9eb12d07bc4c97572c658fc6ddca97d&lt;br/&gt;
aeeb6171adcd7e305e8c0c64a13ade64170fa799&lt;/p&gt;

&lt;p&gt;1.12.2: &lt;/p&gt;

&lt;p&gt;86bdfff24112fcf2793edb82f27ea5a5c248cc5a&lt;br/&gt;
98da61b8e6dbd54b09da864e9f7af33eba9e0c40&lt;br/&gt;
dad7f57e61d53c076ea9b69a61a71d9ac6edf094&lt;br/&gt;
6cc60de8cd5415ff40d3eae6467c756a54506973&lt;/p&gt;

&lt;p&gt;1.11.4:&lt;/p&gt;

&lt;p&gt;d69d134590f46fea74ac1f7c664435393625533f&lt;br/&gt;
5f6a804d11bcdf930a6a44ea48dd7e8f663954a3&lt;br/&gt;
95281a7313d107e60a8103db3104a19cda5f9ece&lt;br/&gt;
30351d6a3d3f1a9949bf5f01e63293bf4a657424 &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13019440" name="TestJob.java" size="3363" author="mproch" created="Tue, 26 Jan 2021 20:16:02 +0000"/>
                            <attachment id="13019441" name="stacktrace" size="6763" author="mproch" created="Tue, 26 Jan 2021 20:21:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 39 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0mz5k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>