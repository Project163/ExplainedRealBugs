<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:08:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-25261] Changelog not truncated on materialization</title>
                <link>https://issues.apache.org/jira/browse/FLINK-25261</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/dcc4d43e413b20f70036e73c61d52e2e1c5afee7/flink-state-backends/flink-statebackend-changelog/src/main/java/org/apache/flink/state/changelog/ChangelogKeyedStateBackend.java#L640&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/dcc4d43e413b20f70036e73c61d52e2e1c5afee7/flink-state-backends/flink-statebackend-changelog/src/main/java/org/apache/flink/state/changelog/ChangelogKeyedStateBackend.java#L640&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13416846">FLINK-25261</key>
            <summary>Changelog not truncated on materialization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="roman">Roman Khachatryan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sat, 11 Dec 2021 22:06:10 +0000</created>
                <updated>Tue, 4 Jan 2022 13:52:34 +0000</updated>
                            <resolved>Tue, 4 Jan 2022 13:52:34 +0000</resolved>
                                    <version>1.15.0</version>
                                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17463599" author="ym" created="Wed, 22 Dec 2021 06:35:30 +0000"  >&lt;p&gt;Shouldn&apos;t truncation happen when a checkpoint is subsumed?  &lt;/p&gt;

&lt;p&gt;I do not think it is a safe/right place to do truncation when materialization completes.&lt;/p&gt;</comment>
                            <comment id="17463647" author="roman_khachatryan" created="Wed, 22 Dec 2021 08:40:24 +0000"  >&lt;p&gt;On checkpoint subsumption, actual state is deleted on DFS.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;On materialization, in-memory data SHOULD be cleaned up in writer. This is what is currently missing. It is safe to do by definition of materialization: backend will no longer use these changes once materialized.&lt;/p&gt;</comment>
                            <comment id="17463664" author="ym" created="Wed, 22 Dec 2021 09:05:16 +0000"  >&lt;p&gt;1. What does &quot;truncation&quot; mean? It means from seq # x, data is safe to delete.&lt;br/&gt;
2. Materialization up to seq # y means &lt;b&gt;new&lt;/b&gt; checkpoints will not depend on log changes before seq # y. But it does not necessarily mean all data before y can be deleted (&lt;b&gt;old&lt;/b&gt; checkpoints may also depend on some parts before y).&lt;br/&gt;
3. what exactly are the `in-memory` data here? Those are not flushed to DFS? Then what about those already flushed to DFS, but not within any checkpoint yet (not within any state)?&lt;br/&gt;
4. Also, since materialization is independent of checkpointing; an ongoing checkpoint may depend on in-memory data not flushed to DFS yet.&lt;/p&gt;


&lt;p&gt;New CP&lt;br/&gt;
-&lt;del&gt;|&lt;/del&gt;-------&lt;del&gt;|&lt;/del&gt;---------&amp;gt; (In Mem Log)&lt;br/&gt;
            Materialization upto (but not complete yet)&lt;/p&gt;
</comment>
                            <comment id="17463808" author="roman_khachatryan" created="Wed, 22 Dec 2021 13:37:45 +0000"  >&lt;ol&gt;
	&lt;li&gt;Correct (as I wrote above in context of this ticket I mean in-memory data only)&lt;/li&gt;
	&lt;li&gt;As I wrote above in context of this ticket I mean in-memory data only&lt;/li&gt;
	&lt;li&gt;In-memory means any in-memory object not needed for checkpointing anymore, depending on DSTL implementation (reference to file or an in-memory byte array to-be -flushed); To discard already flushed but not included into any checkpoint changes, we have three options: a) shared/private state ownership and TM-side registry (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23139&quot; title=&quot;State ownership: track and discard private state (registry+changelog)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23139&quot;&gt;&lt;del&gt;FLINK-23139&lt;/del&gt;&lt;/a&gt;); b) TM-side registry only for changelog; c) rely on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24852&quot; title=&quot;Cleanup of Orphaned Incremental State Artifacts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24852&quot;&gt;FLINK-24852&lt;/a&gt; (which will likely be needed by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25395&quot; title=&quot;FileNotFoundException during recovery caused by Incremental shared state being discarded by TM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25395&quot;&gt;&lt;del&gt;FLINK-25395&lt;/del&gt;&lt;/a&gt;). I propose to postpone this decision until we decide on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25395&quot; title=&quot;FileNotFoundException during recovery caused by Incremental shared state being discarded by TM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25395&quot;&gt;&lt;del&gt;FLINK-25395&lt;/del&gt;&lt;/a&gt; and state ownership. Note that this only happens if pre-emptive upload is enabled (otherwise, state changes are always associated with some checkpoint)&lt;/li&gt;
	&lt;li&gt;Materialization is independent, but handling its result is &quot;synchronized&quot; with checkpointing by using Task mailbox; so it&apos;s only the writer.truncate() method that should take ongoing checkpoints into account; and this is the with the current FS writer.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17464286" author="ym" created="Thu, 23 Dec 2021 04:51:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;1. Correct (as I wrote above in the context of this ticket I mean in-memory data only)&lt;br/&gt;
2. As I wrote above in the context of this ticket I mean in-memory data only&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If truncating only means truncating the in-memory part, would this API be general enough for other implementations as well? (Like in-memory implementation, Kafka based implementation)&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;3. In-memory means any in-memory object not needed for checkpointing anymore, depending on DSTL implementation (reference to file or an in-memory byte array to-be -flushed); To discard already flushed but not included into any checkpoint changes, we have three options: a) shared/private state ownership and TM-side registry (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23139&quot; title=&quot;State ownership: track and discard private state (registry+changelog)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23139&quot;&gt;&lt;del&gt;FLINK-23139&lt;/del&gt;&lt;/a&gt;); b) TM-side registry only for changelog; c) rely on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24852&quot; title=&quot;Cleanup of Orphaned Incremental State Artifacts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24852&quot;&gt;FLINK-24852&lt;/a&gt; (which will likely be needed by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25395&quot; title=&quot;FileNotFoundException during recovery caused by Incremental shared state being discarded by TM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25395&quot;&gt;&lt;del&gt;FLINK-25395&lt;/del&gt;&lt;/a&gt;). I propose to postpone this decision until we decide on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25395&quot; title=&quot;FileNotFoundException during recovery caused by Incremental shared state being discarded by TM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25395&quot;&gt;&lt;del&gt;FLINK-25395&lt;/del&gt;&lt;/a&gt; and state ownership. Note that this only happens if pre-emptive upload is enabled (otherwise, state changes are always associated with some checkpoint)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I am fine to postpone this decision.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;4. Materialization is independent, but handling its result is &quot;synchronized&quot; with checkpointing by using Task mailbox; so it&apos;s only the writer.truncate() method that should take ongoing checkpoints into account; and this is the with the current FS writer.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Let&apos;s consider this:&lt;/p&gt;

&lt;p&gt;New CP&lt;br/&gt;
&lt;del&gt;{&lt;/del&gt;}|{&lt;del&gt;}&lt;/del&gt;-&lt;del&gt;{&lt;/del&gt;}{&lt;del&gt;}{&lt;/del&gt;}|{&lt;del&gt;}{&lt;/del&gt;}{&lt;del&gt;}&lt;/del&gt;------&amp;gt; (In Mem Log)&lt;br/&gt;
Materialization up to (but not complete yet)&lt;/p&gt;

&lt;p&gt;1). Materialization triggered&lt;/p&gt;

&lt;p&gt;2). CP triggered (the uploading part is not in the task thread)&lt;/p&gt;

&lt;p&gt;3). Materialization finished and put truncating action into the mailbox&lt;/p&gt;

&lt;p&gt;4). task thread truncate the log&lt;/p&gt;

&lt;p&gt;5). checkpoint complete&lt;/p&gt;

&lt;p&gt;=====================&lt;/p&gt;

&lt;p&gt;Also, if I am understanding correctly, now we put clean-up into three different places:&lt;/p&gt;

&lt;p&gt;1). State Cleanup upon checkpoint subsumption&lt;/p&gt;

&lt;p&gt;2). In-memory part clean-up upon materialization completes&lt;/p&gt;

&lt;p&gt;3). DFS files cleanup (not included in any state) TBD.&lt;/p&gt;

&lt;p&gt;Again, would this abstraction general enough to support using other implmentation? It is fragile to me.&lt;/p&gt;</comment>
                            <comment id="17468413" author="ym" created="Tue, 4 Jan 2022 07:53:09 +0000"  >&lt;p&gt;Upon offline discussion, there are two more questions/problems related. I will extract them and open a separate ticket, and discuss whether/how to handle them before 1.15.&lt;/p&gt;

&lt;p&gt;For truncation upon materialization, it is wrapped in the mailbox, so it should work fine regarding the race condition mentioned above. It does not block checkpoint snapshots as well, because what to upload/not upload is decided in the task thread fairly fast; while the real uploading is done asycnously.&lt;/p&gt;</comment>
                            <comment id="17468637" author="roman_khachatryan" created="Tue, 4 Jan 2022 13:52:34 +0000"  >&lt;p&gt;Merged as 70a3f661c467e670b0769abd1d0a03d77a45b910 into master.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13357973">FLINK-21352</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13415026">FLINK-25144</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 45 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0xl8o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>