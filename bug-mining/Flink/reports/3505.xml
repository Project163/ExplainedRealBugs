<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:42:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14952] Yarn containers can exceed physical memory limits when using BoundedBlockingSubpartition.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14952</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;As &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/CoGroup-SortMerger-performance-degradation-from-1-6-4-1-9-1-td31082.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reported by a user on the user mailing list&lt;/a&gt;, combination of using &lt;tt&gt;BoundedBlockingSubpartition&lt;/tt&gt; with yarn containers can cause yarn container to exceed memory limits.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;2019-11-19 12:49:23,068 INFO org.apache.flink.yarn.YarnResourceManager - Closing TaskExecutor connection container_e42_1574076744505_9444_01_000004 because: Container &lt;span class=&quot;error&quot;&gt;&amp;#91;pid=42774,containerID=container_e42_1574076744505_9444_01_000004&amp;#93;&lt;/span&gt; is running beyond physical memory limits. Current usage: 12.0 GB of 12 GB physical memory used; 13.9 GB of 25.2 GB virtual memory used. Killing container.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is probably happening because memory usage of mmap is not capped and not accounted by configured memory limits, however yarn is tracking this memory usage and once Flink exceeds some threshold, container is being killed.&lt;/p&gt;

&lt;p&gt;Workaround is to overrule default value and force Flink to not user mmap, by setting a secret (&#129323;) config option:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;taskmanager.network.bounded-blocking-subpartition-type: file
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13270721">FLINK-14952</key>
            <summary>Yarn containers can exceed physical memory limits when using BoundedBlockingSubpartition.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zjwang">Zhijiang</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 26 Nov 2019 13:40:34 +0000</created>
                <updated>Fri, 13 Dec 2019 04:07:29 +0000</updated>
                            <resolved>Fri, 13 Dec 2019 04:07:02 +0000</resolved>
                                    <version>1.9.1</version>
                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Deployment / YARN</component>
                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="16982590" author="zentol" created="Tue, 26 Nov 2019 15:21:17 +0000"  >&lt;p&gt;would it be sufficient to document the config option? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; will the new memory management handle this in a better way?&lt;/p&gt;</comment>
                            <comment id="16982614" author="azagrebin" created="Tue, 26 Nov 2019 15:39:35 +0000"  >&lt;p&gt;At the moment, we do not explicitly account for this memory usage in our new memory model for the Flink process, except that&#160; in general this kind of things can be accounted for in a config option for the framework off-heap abs memory (&lt;a href=&quot;https://jira.apache.org/jira/browse/FLINK-14637&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jira.apache.org/jira/browse/FLINK-14637&lt;/a&gt;).&lt;br/&gt;
it would be nice to understand how to manage this memory usage by mmap firstly to account for it in some better way.&lt;/p&gt;</comment>
                            <comment id="16983106" author="fly_in_gis" created="Wed, 27 Nov 2019 02:36:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;FYI, all the memory used by Flink TaskManager should be&#160;counted and allocate from Yarn ResourceManager. Otherwise, it may be killed by Yarn NodeManager. The NodeManager tracks the memory usage of the TaskManager process tree. It is usually rss mem, read the value from `/proc/{pid}/stat&apos;. Yarn NodeManager does not use cgroup to set the memory limit, it starts a `ContainersMonitor` thread to monitor the memory usage of each container. If it overused, the container will be killed by NodeManager and get the log &quot;is running beyond physical memory limits&quot;.&lt;/p&gt;</comment>
                            <comment id="16983233" author="pnowojski" created="Wed, 27 Nov 2019 07:23:45 +0000"  >&lt;p&gt;What options do we have? I think there is no way without cgroups to control the memory usage of the mmap, &lt;b&gt;or is there&lt;/b&gt;? If not, we have only the following options:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Disallow mmap for yarn&lt;/li&gt;
	&lt;li&gt;Disable mmap memory accounting/container killing in yarn&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think there are some options to achieve the 2., but probably require user to change yarn configuration? So maybe the default should be to not use mmap for yarn, but document how to enable it? &lt;/p&gt;</comment>
                            <comment id="16983397" author="kevin.cyj" created="Wed, 27 Nov 2019 11:01:26 +0000"  >&lt;p&gt;Can we manage the memory mapped region and restrict its size? For example, we can implement a rolling map and release the previous region before mapping next region and restrict the total size of mmapped memory can be used by a single TM.&lt;/p&gt;</comment>
                            <comment id="16983442" author="fly_in_gis" created="Wed, 27 Nov 2019 11:36:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;I think it is not easy to disable mmap memory accounting in yarn. Even we set the `yarn.nodemanager.container-monitor.procfs-tree.smaps-based-rss.enabled=true`, the NodeManager calculates mmaped pages as consumed. So there is no way to disable mmap memory accounting. If users want to disable container killing, `yarn.nodemanager.pmem-check-enabled=false` could be used.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;&#160;If we can control the memory used by mmap, i think it is better solution. The memory for mmap should be allocated from Yarn to avoid killing.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16983521" author="pnowojski" created="Wed, 27 Nov 2019 13:51:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;For example, we can implement a rolling map and release the previous region before mapping next region and restrict the total size of mmapped memory can be used by a single TM.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; doesn&apos;t this defeat the purpose of using mmap in the first place? For it to be beneficial two different readers of the mmap&apos;ed region would have to closely follow one another, right?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If users want to disable container killing, `yarn.nodemanager.pmem-check-enabled=false` could be used. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Assuming that cluster is properly configured I guess this is a valid option.&lt;/p&gt;</comment>
                            <comment id="16984103" author="kevin.cyj" created="Thu, 28 Nov 2019 03:02:57 +0000"  >&lt;p&gt;&amp;gt; Doesn&apos;t this defeat the purpose of using mmap in the first place? For it to be beneficial two different readers of the mmap&apos;ed region would have to closely follow one another, right?&lt;/p&gt;

&lt;p&gt;You are right, if we decide to manage the mmapped region, we need to consider when and which region to recycle. Implementing a memory management algorithm is possible but can be complicated, currently, OS does it for us.&lt;/p&gt;

&lt;p&gt;Maybe there&apos;s another choice we can consider - using the FILE-FILE mode in the first place. The FILE-FILE mode can also leverage the capability of OS page cache and the only problem is that it uses some unpooled heap memory for reading, which has a potential of OOM. If we can manage those memory in the future, there should be no problem with FILE-FILE mode.&lt;/p&gt;</comment>
                            <comment id="16987954" author="pnowojski" created="Wed, 4 Dec 2019 15:42:37 +0000"  >&lt;p&gt;It would be nice to try to keep &lt;tt&gt;MMAP&lt;/tt&gt; as default for non yarn deployments, but if that&apos;s non trivial +1 for setting &lt;tt&gt;FILE&lt;/tt&gt; as the default.&lt;/p&gt;</comment>
                            <comment id="16988013" author="gjy" created="Wed, 4 Dec 2019 17:23:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe there&apos;s another choice we can consider - using the FILE-FILE mode in the first place. The FILE-FILE mode can also leverage the capability of OS page cache and the only problem is that it uses some unpooled heap memory for reading, which has a potential of OOM. If we can manage those memory in the future, there should be no problem with FILE-FILE mode.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; Can you explain what FILE-FILE mode means?&lt;/p&gt;</comment>
                            <comment id="16988046" author="pnowojski" created="Wed, 4 Dec 2019 17:50:28 +0000"  >&lt;p&gt;Initially the &lt;tt&gt;BlockingBoundedPartition&lt;/tt&gt; was supposed to be working purely using mmap:&lt;br/&gt;
1. Results are produced and written to a mmap&apos;ed file, from which they are being read&lt;br/&gt;
This had some blocking issues and was replaced by:&lt;br/&gt;
2. Results are written to a file directly, but read using mmap (improves performance when reading the same partition multiple times). This is what we are calling &quot;mmap&quot;/&quot;MMAP&quot; mode in this ticket.&lt;br/&gt;
3. Results are written to a file and read from a file, without using mmap at all. &quot;file&quot; or &quot;FILE-FILE&quot; mode&lt;/p&gt;</comment>
                            <comment id="16989448" author="kevin.cyj" created="Fri, 6 Dec 2019 06:50:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;&#160;By&#160;&quot;FILE-FILE&quot; mode, I mean using BoundedBlockingSubpartitionType.FILE. As explained by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;, results are written to a file and read from a file using read/write API of FileChannel. When reading from files, two buffers are needed by each subpartition to store the read data. For MMAP read mode, the extra read buffers are not needed.&lt;/p&gt;</comment>
                            <comment id="16993168" author="zjwang" created="Wed, 11 Dec 2019 03:47:50 +0000"  >&lt;p&gt;Generally speaking, we want to provide a better performance setting as a default config.&#160;&lt;/p&gt;

&lt;p&gt;But considering the mmap way might bring unstable concern in resource framework cluster, then I also prefer to adjust the default config option &quot;&lt;b&gt;taskmanager.network.bounded-blocking-subpartition-type&lt;/b&gt;&quot; from `auto` to `file` mode.&lt;/p&gt;

&lt;p&gt;Furthermore we can also supplement some descriptions of limitation/concerns for `mmap` way in options. Then when users want to enable `mmap` way for better performance, they are aware of the respective risks and the scenarios.&lt;/p&gt;</comment>
                            <comment id="16993207" author="zjwang" created="Wed, 11 Dec 2019 05:37:37 +0000"  >&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;&#160;mentioned above, the current blocking partition with file type has some potential concern for memory overhead. I created a separate ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15187&quot; title=&quot;Reuse LocalBufferPool for FileBufferReader in blocking partition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15187&quot;&gt;&lt;del&gt;FLINK-15187&lt;/del&gt;&lt;/a&gt;&#160;for tracking this issue and I do not tag it as a blocker for release-1.10 ATM.&lt;/p&gt;</comment>
                            <comment id="16995341" author="zjwang" created="Fri, 13 Dec 2019 04:07:02 +0000"  >&lt;p&gt;Fixed in master:&#160;7600e8b9d4cb8fee928c9edc9d2483787dc10a3c&lt;/p&gt;

&lt;p&gt;Fixed in release-1.10:&#160;b52efff51f6494c442e32181a5d6896feec4e990&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13224866">FLINK-12070</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z090wo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>This changes the option key and default value for the type of BoundedBlockingSubpartition in batch jobs. &lt;br/&gt;
&lt;br/&gt;
The previous key `taskmanager.network.bounded-blocking-subpartition-type` was changed to `taskmanager.network.blocking-shuffle.type` now. &lt;br/&gt;
&lt;br/&gt;
And the respective option default value was also changed from `auto` to `file` for avoiding yarn killing task manager container when memory usage of mmap exceeds some threshold.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>