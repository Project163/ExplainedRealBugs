<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7974] AbstractServerBase#shutdown does not wait for shutdown completion</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7974</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;AbstractServerBase&lt;/tt&gt; does not wait for the completion of its shutdown when calling &lt;tt&gt;AbstractServerBase#shutdown&lt;/tt&gt;. This is problematic since it leads to resource leaks and instable tests such as the &lt;tt&gt;AbstractServerTest&lt;/tt&gt;. I propose to let the &lt;tt&gt;AbstractServerBase#shutdown&lt;/tt&gt; return a termination future which is completed upon shutdown completion.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13115967">FLINK-7974</key>
            <summary>AbstractServerBase#shutdown does not wait for shutdown completion</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkl0u">Kostas Kloudas</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Nov 2017 15:58:04 +0000</created>
                <updated>Wed, 6 Dec 2017 15:47:12 +0000</updated>
                            <resolved>Wed, 6 Dec 2017 15:45:08 +0000</resolved>
                                    <version>1.4.0</version>
                                                    <component>Runtime / Queryable State</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16247362" author="githubbot" created="Fri, 10 Nov 2017 11:19:25 +0000"  >&lt;p&gt;GitHub user kl0u opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7974&quot; title=&quot;AbstractServerBase#shutdown does not wait for shutdown completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7974&quot;&gt;&lt;del&gt;FLINK-7974&lt;/del&gt;&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7975&quot; title=&quot;Queryable state client does not wait for shutdown completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7975&quot;&gt;&lt;del&gt;FLINK-7975&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Wait for shutdown in QS client and servers.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Previously we were freeing the resources held by the QS client and servers on `shutdown()`, but we were not waiting for this to complete. Now we are waiting for everything to be freed.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    The `Client` and the `AbstractServerBase` contain the biggest changes. The actual implementations (`KvStateClientProxyImpl`, `KvStateServerImpl`, and `QueryableStateClient`) build on that.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Some tests were also adjusted but mainly the changes are tested in `AbstractServerTest`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): NO&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: NO&lt;/li&gt;
	&lt;li&gt;The serializers: NO&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): NO&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: NO&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: NO&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? NO&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? not applicable&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    R @aljoscha or @tillrohrmann &lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/kl0u/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kl0u/flink&lt;/a&gt; qs-shutdown-fin&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4993&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 46bced58030a76d65163369b58f9c02c814a4e08&lt;br/&gt;
Author: kkloudas &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-09T18:21:43Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7975&quot; title=&quot;Queryable state client does not wait for shutdown completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7975&quot;&gt;&lt;del&gt;FLINK-7975&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Wait for QS client to shutdown.&lt;/p&gt;

&lt;p&gt;commit 62f80529f5657223d792576686ddad6832d13506&lt;br/&gt;
Author: kkloudas &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-09T18:30:29Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7974&quot; title=&quot;AbstractServerBase#shutdown does not wait for shutdown completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7974&quot;&gt;&lt;del&gt;FLINK-7974&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Wait for QS abstract server to shutdown.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16247451" author="githubbot" created="Fri, 10 Nov 2017 13:14:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150221485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150221485&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/client/QueryableStateClient.java &amp;#8212;&lt;br/&gt;
    @@ -108,9 +110,35 @@ public QueryableStateClient(final InetAddress remoteAddress, final int remotePor&lt;br/&gt;
     				new DisabledKvStateRequestStats());&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** Shuts down the client. */&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Shuts down the client and waits for 10 seconds&lt;br/&gt;
    +	 * for the shutdown to be completed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;If this expires, or an exception is thrown for&lt;br/&gt;
    +	 * any reason, then a warning is printed containing the&lt;br/&gt;
    +	 * exception.&lt;br/&gt;
    +	 */&lt;br/&gt;
     	public void shutdown() {&lt;/li&gt;
	&lt;li&gt;client.shutdown();&lt;br/&gt;
    +		try 
{
    +			client.shutdown().get(10L, TimeUnit.SECONDS);
    +			LOG.info(&quot;The Queryable State Client was shutdown successfully.&quot;);
    +		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +			LOG.warn(&quot;The Queryable State Client shutdown failed: &quot;, e);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Shuts down the client and waits until shutdown is completed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;If an exception is thrown for any reason, then this exception&lt;br/&gt;
    +	 * is further propagated upwards.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public void shutdownAndWait() throws Throwable {&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			client.shutdown().join();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    `get()` is better here&lt;/p&gt;</comment>
                            <comment id="16247452" author="githubbot" created="Fri, 10 Nov 2017 13:14:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150222505&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150222505&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -250,8 +252,8 @@ private boolean attemptToBind(final int port) throws Throwable &lt;/p&gt;
{
     
     			throw future.cause();
     		}
&lt;p&gt; catch (BindException e) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.debug(&quot;Failed to start server {} on port {}: {}.&quot;, serverName, port, e.getMessage());&lt;/li&gt;
	&lt;li&gt;shutdown();&lt;br/&gt;
    +			log.debug(&quot;Failed to start {} on port {}: {}.&quot;, serverName, port, e.getMessage());&lt;br/&gt;
    +			shutdownServer(Time.seconds(10L)).join();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I would use `get()` because it makes the thrown exceptions explicit.&lt;/p&gt;</comment>
                            <comment id="16247453" author="githubbot" created="Fri, 10 Nov 2017 13:14:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150221458&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150221458&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/client/QueryableStateClient.java &amp;#8212;&lt;br/&gt;
    @@ -108,9 +110,35 @@ public QueryableStateClient(final InetAddress remoteAddress, final int remotePor&lt;br/&gt;
     				new DisabledKvStateRequestStats());&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** Shuts down the client. */&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Shuts down the client and waits for 10 seconds&lt;br/&gt;
    +	 * for the shutdown to be completed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;If this expires, or an exception is thrown for&lt;br/&gt;
    +	 * any reason, then a warning is printed containing the&lt;br/&gt;
    +	 * exception.&lt;br/&gt;
    +	 */&lt;br/&gt;
     	public void shutdown() {&lt;/li&gt;
	&lt;li&gt;client.shutdown();&lt;br/&gt;
    +		try 
{
    +			client.shutdown().get(10L, TimeUnit.SECONDS);
    +			LOG.info(&quot;The Queryable State Client was shutdown successfully.&quot;);
    +		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +			LOG.warn(&quot;The Queryable State Client shutdown failed: &quot;, e);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Shuts down the client and waits until shutdown is completed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;If an exception is thrown for any reason, then this exception&lt;br/&gt;
    +	 * is further propagated upwards.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public void shutdownAndWait() throws Throwable {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We should not throw `Throwable`.&lt;/p&gt;</comment>
                            <comment id="16247454" author="githubbot" created="Fri, 10 Nov 2017 13:14:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150221248&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150221248&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/client/QueryableStateClient.java &amp;#8212;&lt;br/&gt;
    @@ -108,9 +110,35 @@ public QueryableStateClient(final InetAddress remoteAddress, final int remotePor&lt;br/&gt;
     				new DisabledKvStateRequestStats());&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** Shuts down the client. */&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Shuts down the client and waits for 10 seconds&lt;br/&gt;
    +	 * for the shutdown to be completed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;If this expires, or an exception is thrown for&lt;br/&gt;
    +	 * any reason, then a warning is printed containing the&lt;br/&gt;
    +	 * exception.&lt;br/&gt;
    +	 */&lt;br/&gt;
     	public void shutdown() {&lt;/li&gt;
	&lt;li&gt;client.shutdown();&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			client.shutdown().get(10L, TimeUnit.SECONDS);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Not sure whether we should hard code the timeout here.&lt;/p&gt;</comment>
                            <comment id="16247455" author="githubbot" created="Fri, 10 Nov 2017 13:14:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150221573&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150221573&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/client/QueryableStateClient.java &amp;#8212;&lt;br/&gt;
    @@ -108,9 +110,35 @@ public QueryableStateClient(final InetAddress remoteAddress, final int remotePor&lt;br/&gt;
     				new DisabledKvStateRequestStats());&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** Shuts down the client. */&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Shuts down the client and waits for 10 seconds&lt;br/&gt;
    +	 * for the shutdown to be completed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;If this expires, or an exception is thrown for&lt;br/&gt;
    +	 * any reason, then a warning is printed containing the&lt;br/&gt;
    +	 * exception.&lt;br/&gt;
    +	 */&lt;br/&gt;
     	public void shutdown() {&lt;/li&gt;
	&lt;li&gt;client.shutdown();&lt;br/&gt;
    +		try 
{
    +			client.shutdown().get(10L, TimeUnit.SECONDS);
    +			LOG.info(&quot;The Queryable State Client was shutdown successfully.&quot;);
    +		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +			LOG.warn(&quot;The Queryable State Client shutdown failed: &quot;, e);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Shuts down the client and waits until shutdown is completed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;If an exception is thrown for any reason, then this exception&lt;br/&gt;
    +	 * is further propagated upwards.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public void shutdownAndWait() throws Throwable {&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			client.shutdown().join();
    +		}
&lt;p&gt; catch (CompletionException e) {&lt;br/&gt;
    +			throw e.getCause();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    What if `getCause` is `null`? There is `ExceptionUtils.stripFromCompletionException`.&lt;/p&gt;</comment>
                            <comment id="16247456" author="githubbot" created="Fri, 10 Nov 2017 13:14:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150223049&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150223049&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; queryExecShutdownFuture = CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
    +				try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (queryExecutor != null &amp;amp;&amp;amp; !queryExecutor.isShutdown()) {
    +						queryExecutor.shutdown();
    +						queryExecutor.awaitTermination(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +						return true;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (InterruptedException e) {&lt;br/&gt;
    +					log.warn(&quot;Failed to shutdown {}: &quot;, serverName, e);&lt;br/&gt;
    +					return false;&lt;br/&gt;
    +				}&lt;br/&gt;
    +				return false;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Better to use `Executors.gracefulShutdown` for this.&lt;/p&gt;</comment>
                            <comment id="16247457" author="githubbot" created="Fri, 10 Nov 2017 13:14:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150223999&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150223999&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; queryExecShutdownFuture = CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
    +				try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (queryExecutor != null &amp;amp;&amp;amp; !queryExecutor.isShutdown()) {
    +						queryExecutor.shutdown();
    +						queryExecutor.awaitTermination(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +						return true;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (InterruptedException e) {&lt;br/&gt;
    +					log.warn(&quot;Failed to shutdown {}: &quot;, serverName, e);&lt;br/&gt;
    +					return false;&lt;br/&gt;
    +				}&lt;br/&gt;
    +				return false;&lt;br/&gt;
    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		queryExecShutdownFuture.thenRun(() -&amp;gt; {&lt;br/&gt;
    +			if (bootstrap != null) {&lt;br/&gt;
    +				EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +				if (group != null) {&lt;br/&gt;
    +					group.shutdownGracefully(0L, timeout.toMilliseconds(), TimeUnit.MILLISECONDS)&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    why not setting the timeout here to `0`?&lt;/p&gt;</comment>
                            <comment id="16247458" author="githubbot" created="Fri, 10 Nov 2017 13:14:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150224310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150224310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    JavaDocs should be updated.&lt;/p&gt;</comment>
                            <comment id="16247459" author="githubbot" created="Fri, 10 Nov 2017 13:14:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150223433&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150223433&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; queryExecShutdownFuture = CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
    +				try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (queryExecutor != null &amp;amp;&amp;amp; !queryExecutor.isShutdown()) {
    +						queryExecutor.shutdown();
    +						queryExecutor.awaitTermination(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +						return true;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (InterruptedException e) {&lt;br/&gt;
    +					log.warn(&quot;Failed to shutdown {}: &quot;, serverName, e);&lt;br/&gt;
    +					return false;&lt;br/&gt;
    +				}&lt;br/&gt;
    +				return false;&lt;br/&gt;
    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		queryExecShutdownFuture.thenRun(() -&amp;gt; {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Is is strictly necessary to first shut down the query executor before shutting down the netty server?&lt;/p&gt;</comment>
                            <comment id="16247460" author="githubbot" created="Fri, 10 Nov 2017 13:14:28 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150225136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150225136&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; queryExecShutdownFuture = CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
    +				try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (queryExecutor != null &amp;amp;&amp;amp; !queryExecutor.isShutdown()) {
    +						queryExecutor.shutdown();
    +						queryExecutor.awaitTermination(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +						return true;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (InterruptedException e) {&lt;br/&gt;
    +					log.warn(&quot;Failed to shutdown {}: &quot;, serverName, e);&lt;br/&gt;
    +					return false;&lt;br/&gt;
    +				}&lt;br/&gt;
    +				return false;&lt;br/&gt;
    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		queryExecShutdownFuture.thenRun(() -&amp;gt; {&lt;br/&gt;
    +			if (bootstrap != null) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				EventLoopGroup group = bootstrap.group();    +				if (group != null) {
    +					group.shutdownGracefully(0L, timeout.toMilliseconds(), TimeUnit.MILLISECONDS)
    +							.addListener(finished -&amp;gt; groupShutdownFuture.complete(null));
    +				} else {
    +					groupShutdownFuture.complete(null);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			if (handler != null) {&lt;br/&gt;
    +				handler.shutdown().thenRun(() -&amp;gt; {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    same here, what if an exception happened while shutting `handler` down? Shouldn&apos;t we complete the `handlerShutdownFuture` with it?&lt;/p&gt;</comment>
                            <comment id="16247461" author="githubbot" created="Fri, 10 Nov 2017 13:14:28 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150224362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150224362&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; queryExecShutdownFuture = CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
    +				try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (queryExecutor != null &amp;amp;&amp;amp; !queryExecutor.isShutdown()) {
    +						queryExecutor.shutdown();
    +						queryExecutor.awaitTermination(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +						return true;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (InterruptedException e) {&lt;br/&gt;
    +					log.warn(&quot;Failed to shutdown {}: &quot;, serverName, e);&lt;br/&gt;
    +					return false;&lt;br/&gt;
    +				}&lt;br/&gt;
    +				return false;&lt;br/&gt;
    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		queryExecShutdownFuture.thenRun(() -&amp;gt; {&lt;br/&gt;
    +			if (bootstrap != null) {&lt;br/&gt;
    +				EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +				if (group != null) {&lt;br/&gt;
    +					group.shutdownGracefully(0L, timeout.toMilliseconds(), TimeUnit.MILLISECONDS)&lt;br/&gt;
    +							.addListener(finished -&amp;gt; groupShutdownFuture.complete(null));&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    why do we complete a `boolean` future with `null`?&lt;/p&gt;</comment>
                            <comment id="16247462" author="githubbot" created="Fri, 10 Nov 2017 13:14:28 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150225343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150225343&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerHandler.java &amp;#8212;&lt;br/&gt;
    @@ -185,7 +185,7 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws E&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down any handler specific resources, e.g. thread pools etc.&lt;br/&gt;
     	 */
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    JavaDocs missing&lt;/p&gt;</comment>
                            <comment id="16247463" author="githubbot" created="Fri, 10 Nov 2017 13:14:28 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150224448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150224448&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; queryExecShutdownFuture = CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
    +				try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (queryExecutor != null &amp;amp;&amp;amp; !queryExecutor.isShutdown()) {
    +						queryExecutor.shutdown();
    +						queryExecutor.awaitTermination(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +						return true;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (InterruptedException e) {&lt;br/&gt;
    +					log.warn(&quot;Failed to shutdown {}: &quot;, serverName, e);&lt;br/&gt;
    +					return false;&lt;br/&gt;
    +				}&lt;br/&gt;
    +				return false;&lt;br/&gt;
    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		queryExecShutdownFuture.thenRun(() -&amp;gt; {&lt;br/&gt;
    +			if (bootstrap != null) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				EventLoopGroup group = bootstrap.group();    +				if (group != null) {
    +					group.shutdownGracefully(0L, timeout.toMilliseconds(), TimeUnit.MILLISECONDS)
    +							.addListener(finished -&amp;gt; groupShutdownFuture.complete(null));
    +				} else {
    +					groupShutdownFuture.complete(null);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			if (handler != null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				handler.shutdown().thenRun(() -&amp;gt; {
    +					handler = null;
    +					handlerShutdownFuture.complete(null);
    +				});    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else &lt;/p&gt;
{
    +				handlerShutdownFuture.complete(null);
     			}
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why do we execute the handler shutdown in the callback of the `queryExecShutdownFuture`?&lt;/p&gt;</comment>
                            <comment id="16247464" author="githubbot" created="Fri, 10 Nov 2017 13:14:28 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150225411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150225411&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,27 +168,39 @@ public String getClientName() {&lt;br/&gt;
     	 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Boolean&amp;gt; shutdown() {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    What does the boolean future value tell us about the `shutdown`?&lt;/p&gt;</comment>
                            <comment id="16247465" author="githubbot" created="Fri, 10 Nov 2017 13:14:28 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150224857&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150224857&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; queryExecShutdownFuture = CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
    +				try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (queryExecutor != null &amp;amp;&amp;amp; !queryExecutor.isShutdown()) {
    +						queryExecutor.shutdown();
    +						queryExecutor.awaitTermination(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +						return true;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (InterruptedException e) {&lt;br/&gt;
    +					log.warn(&quot;Failed to shutdown {}: &quot;, serverName, e);&lt;br/&gt;
    +					return false;&lt;br/&gt;
    +				}&lt;br/&gt;
    +				return false;&lt;br/&gt;
    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		queryExecShutdownFuture.thenRun(() -&amp;gt; {&lt;br/&gt;
    +			if (bootstrap != null) {&lt;br/&gt;
    +				EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +				if (group != null) {&lt;br/&gt;
    +					group.shutdownGracefully(0L, timeout.toMilliseconds(), TimeUnit.MILLISECONDS)&lt;br/&gt;
    +							.addListener(finished -&amp;gt; groupShutdownFuture.complete(null));&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Shouldn&apos;t we take the `finished` value to complete the `groupShutdownFuture`? There might have been an exception been thrown. We should forward this then as well.&lt;/p&gt;</comment>
                            <comment id="16247466" author="githubbot" created="Fri, 10 Nov 2017 13:14:28 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150225368&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150225368&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,27 +168,39 @@ public String getClientName() {&lt;br/&gt;
     	 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
     	 */
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    JavaDocs need to be adapted&lt;/p&gt;</comment>
                            <comment id="16247467" author="githubbot" created="Fri, 10 Nov 2017 13:14:29 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150226886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150226886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,27 +168,39 @@ public String getClientName() {&lt;br/&gt;
     	 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Boolean&amp;gt; shutdown() {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
     		if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +			final List&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; connectionFutures = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, EstablishedConnection&amp;gt; conn : establishedConnections.entrySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {     				if (establishedConnections.remove(conn.getKey(), conn.getValue())) {
    -					conn.getValue().close();
    +					connectionFutures.add(conn.getValue().close());
     				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, PendingConnection&amp;gt; conn : pendingConnections.entrySet()) {&lt;br/&gt;
     				if (pendingConnections.remove(conn.getKey()) != null) {    -					conn.getValue().close();    +					connectionFutures.add(conn.getValue().close());     				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) 
{
    -					group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);
    -				}&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
    +			CompletableFuture.allOf(connectionFutures.toArray(new CompletableFuture&amp;lt;?&amp;gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;connectionFutures.size()&amp;#93;&lt;/span&gt;)).thenRun(
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Also here we shouldn&apos;t ignore the result of the `allOf` future because it might contain an exception.&lt;/p&gt;</comment>
                            <comment id="16247468" author="githubbot" created="Fri, 10 Nov 2017 13:14:29 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150228589&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150228589&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -419,20 +440,27 @@ void close() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param cause The cause to close the channel with.&lt;/li&gt;
	&lt;li&gt;@return Channel close future&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private boolean close(Throwable cause) {&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Boolean&amp;gt; close(Throwable cause) {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Boolean&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
     			if (failureCause.compareAndSet(null, cause)) {&lt;/li&gt;
	&lt;li&gt;channel.close();&lt;/li&gt;
	&lt;li&gt;stats.reportInactiveConnection();&lt;br/&gt;
    +				final CompletableFuture&amp;lt;?&amp;gt; tmp = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +				channel.close().addListener(finished -&amp;gt; tmp.complete(null));&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (long requestId : pendingRequests.keySet()) {&lt;/li&gt;
	&lt;li&gt;TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/li&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.completeExceptionally(cause)) {&lt;/li&gt;
	&lt;li&gt;stats.reportFailedRequest();&lt;br/&gt;
    +				tmp.thenRun(() -&amp;gt; {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Instead of creating the additional indirection with `shutdownFuture`, couldn&apos;t we simply return the result here as teh shutdown future?&lt;/p&gt;</comment>
                            <comment id="16247469" author="githubbot" created="Fri, 10 Nov 2017 13:14:29 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150226027&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150226027&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,27 +168,39 @@ public String getClientName() {&lt;br/&gt;
     	 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Boolean&amp;gt; shutdown() {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
     		if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +			final List&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; connectionFutures = new ArrayList&amp;lt;&amp;gt;();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    could be initialized with the number of established + pending connections.&lt;/p&gt;</comment>
                            <comment id="16247470" author="githubbot" created="Fri, 10 Nov 2017 13:14:29 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150226636&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150226636&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,27 +168,39 @@ public String getClientName() {&lt;br/&gt;
     	 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Boolean&amp;gt; shutdown() {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
     		if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +			final List&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; connectionFutures = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, EstablishedConnection&amp;gt; conn : establishedConnections.entrySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {     				if (establishedConnections.remove(conn.getKey(), conn.getValue())) {
    -					conn.getValue().close();
    +					connectionFutures.add(conn.getValue().close());
     				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, PendingConnection&amp;gt; conn : pendingConnections.entrySet()) {&lt;br/&gt;
     				if (pendingConnections.remove(conn.getKey()) != null) {    -					conn.getValue().close();    +					connectionFutures.add(conn.getValue().close());     				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) 
{
    -					group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);
    -				}&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
    +			CompletableFuture.allOf(connectionFutures.toArray(new CompletableFuture&amp;lt;?&amp;gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;connectionFutures.size()&amp;#93;&lt;/span&gt;)).thenRun(&lt;br/&gt;
    +					() -&amp;gt; {&lt;br/&gt;
    +						if (bootstrap != null) {&lt;br/&gt;
    +							EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +							if (group != null) {&lt;br/&gt;
    +								group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS)&lt;br/&gt;
    +										.addListener(finished -&amp;gt; shutdownFuture.complete(true));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    result should be considered.&lt;/p&gt;</comment>
                            <comment id="16247471" author="githubbot" created="Fri, 10 Nov 2017 13:14:29 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150225215&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150225215&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; queryExecShutdownFuture = CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
    +				try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (queryExecutor != null &amp;amp;&amp;amp; !queryExecutor.isShutdown()) {
    +						queryExecutor.shutdown();
    +						queryExecutor.awaitTermination(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +						return true;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (InterruptedException e) {&lt;br/&gt;
    +					log.warn(&quot;Failed to shutdown {}: &quot;, serverName, e);&lt;br/&gt;
    +					return false;&lt;br/&gt;
    +				}&lt;br/&gt;
    +				return false;&lt;br/&gt;
    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +		queryExecShutdownFuture.thenRun(() -&amp;gt; {&lt;br/&gt;
    +			if (bootstrap != null) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				EventLoopGroup group = bootstrap.group();    +				if (group != null) {
    +					group.shutdownGracefully(0L, timeout.toMilliseconds(), TimeUnit.MILLISECONDS)
    +							.addListener(finished -&amp;gt; groupShutdownFuture.complete(null));
    +				} else {
    +					groupShutdownFuture.complete(null);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			if (handler != null) {&lt;br/&gt;
    +				handler.shutdown().thenRun(() -&amp;gt; {&lt;br/&gt;
    +					handler = null;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I would actually refrain from state changes from an aysnchronous callback thread.&lt;/p&gt;</comment>
                            <comment id="16247472" author="githubbot" created="Fri, 10 Nov 2017 13:14:29 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150228244&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150228244&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -419,20 +440,27 @@ void close() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param cause The cause to close the channel with.&lt;/li&gt;
	&lt;li&gt;@return Channel close future&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private boolean close(Throwable cause) {&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Boolean&amp;gt; close(Throwable cause) {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Boolean&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
     			if (failureCause.compareAndSet(null, cause)) {&lt;/li&gt;
	&lt;li&gt;channel.close();&lt;/li&gt;
	&lt;li&gt;stats.reportInactiveConnection();&lt;br/&gt;
    +				final CompletableFuture&amp;lt;?&amp;gt; tmp = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +				channel.close().addListener(finished -&amp;gt; tmp.complete(null));&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (long requestId : pendingRequests.keySet()) {&lt;/li&gt;
	&lt;li&gt;TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/li&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.completeExceptionally(cause)) {&lt;/li&gt;
	&lt;li&gt;stats.reportFailedRequest();&lt;br/&gt;
    +				tmp.thenRun(() -&amp;gt; {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    here as well.&lt;/p&gt;</comment>
                            <comment id="16247473" author="githubbot" created="Fri, 10 Nov 2017 13:14:30 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150228196&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150228196&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -419,20 +440,27 @@ void close() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param cause The cause to close the channel with.&lt;/li&gt;
	&lt;li&gt;@return Channel close future&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private boolean close(Throwable cause) {&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Boolean&amp;gt; close(Throwable cause) {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Boolean&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
     			if (failureCause.compareAndSet(null, cause)) {&lt;/li&gt;
	&lt;li&gt;channel.close();&lt;/li&gt;
	&lt;li&gt;stats.reportInactiveConnection();&lt;br/&gt;
    +				final CompletableFuture&amp;lt;?&amp;gt; tmp = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +				channel.close().addListener(finished -&amp;gt; tmp.complete(null));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    result of channel future is ignored.&lt;/p&gt;</comment>
                            <comment id="16247474" author="githubbot" created="Fri, 10 Nov 2017 13:14:30 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150226661&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150226661&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,27 +168,39 @@ public String getClientName() {&lt;br/&gt;
     	 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Boolean&amp;gt; shutdown() {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
     		if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +			final List&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; connectionFutures = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, EstablishedConnection&amp;gt; conn : establishedConnections.entrySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {     				if (establishedConnections.remove(conn.getKey(), conn.getValue())) {
    -					conn.getValue().close();
    +					connectionFutures.add(conn.getValue().close());
     				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, PendingConnection&amp;gt; conn : pendingConnections.entrySet()) {&lt;br/&gt;
     				if (pendingConnections.remove(conn.getKey()) != null) {    -					conn.getValue().close();    +					connectionFutures.add(conn.getValue().close());     				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) 
{
    -					group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);
    -				}&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
    +			CompletableFuture.allOf(connectionFutures.toArray(new CompletableFuture&amp;lt;?&amp;gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;connectionFutures.size()&amp;#93;&lt;/span&gt;)).thenRun(&lt;br/&gt;
    +					() -&amp;gt; {&lt;br/&gt;
    +						if (bootstrap != null) {&lt;br/&gt;
    +							EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +							if (group != null) {&lt;br/&gt;
    +								group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    why not setting the timeout to `0`?&lt;/p&gt;</comment>
                            <comment id="16247475" author="githubbot" created="Fri, 10 Nov 2017 13:14:30 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150229482&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150229482&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -483,27 +511,31 @@ private boolean close(Throwable cause) {&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void onRequestResult(long requestId, RESP response) {&lt;br/&gt;
     			TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.complete(response)) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (pending != null &amp;amp;&amp;amp; !pending.isDone()) {
     				long durationMillis = (System.nanoTime() - pending.getTimestamp()) / 1_000_000L;
     				stats.reportSuccessfulRequest(durationMillis);
    +				pending.complete(response);
     			}     		}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		@Override&lt;br/&gt;
     		public void onRequestFailure(long requestId, Throwable cause) {&lt;br/&gt;
     			TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.completeExceptionally(cause)) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (pending != null &amp;amp;&amp;amp; !pending.isDone()) {
     				stats.reportFailedRequest();
    +				pending.completeExceptionally(cause);
     			}     		}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		@Override&lt;br/&gt;
     		public void onFailure(Throwable cause) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (close(cause)) 
{
    -				// Remove from established channels, otherwise future
    -				// requests will be handled by this failed channel.
    -				establishedConnections.remove(serverAddress, this);
    -			}
&lt;p&gt;    +			close(cause).thenAccept(cancelled -&amp;gt; {&lt;br/&gt;
    +				if (cancelled) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why do we only remove `this` from `establischedConnections` if `cancelled` is true?&lt;/p&gt;</comment>
                            <comment id="16247476" author="githubbot" created="Fri, 10 Nov 2017 13:14:30 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150228000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150228000&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -309,31 +323,38 @@ private void handInChannel(Channel channel) {&lt;br/&gt;
     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with a ClosedChannelException.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close() {&lt;/li&gt;
	&lt;li&gt;close(new ClosedChannelException());&lt;br/&gt;
    +		private CompletableFuture&amp;lt;?&amp;gt; close() 
{
    +			return close(new ClosedChannelException());
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with an Exception (can be 
{@code null}
&lt;p&gt;)&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;or forward to the established channel.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close(Throwable cause) {&lt;br/&gt;
    +		private CompletableFuture&amp;lt;?&amp;gt; close(Throwable cause) {&lt;br/&gt;
     			synchronized (connectLock) {&lt;/li&gt;
	&lt;li&gt;if (!closed) {&lt;br/&gt;
    +				final CompletableFuture&amp;lt;?&amp;gt; shutdownFuture;&lt;br/&gt;
    +				if (closed) 
{
    +					shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();
    +					shutdownFuture.complete(null);
    +				}
&lt;p&gt; else {&lt;br/&gt;
     					if (failureCause == null) &lt;/p&gt;
{
     						failureCause = cause;
     					}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     					if (established != null) &lt;/p&gt;
{
    -						established.close();
    +						shutdownFuture = established.close();
     					}
&lt;p&gt; else {&lt;br/&gt;
     						PendingRequest pending;&lt;br/&gt;
     						while ((pending = queuedRequests.poll()) != null) &lt;/p&gt;
{
     							pending.completeExceptionally(cause);
     						}
&lt;p&gt;    +						shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +						shutdownFuture.complete(null);&lt;br/&gt;
     					}&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;closed = true;&lt;br/&gt;
    +					shutdownFuture.thenRun(() -&amp;gt; closed = true);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why do we set `closed` to true` only after the shutdown completed? Shouldn&apos;t `close` directly set it to true such that all preceding operations won&apos;t be executed anymore?&lt;/p&gt;</comment>
                            <comment id="16247477" author="githubbot" created="Fri, 10 Nov 2017 13:14:30 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150230125&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150230125&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -419,20 +440,27 @@ void close() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param cause The cause to close the channel with.&lt;/li&gt;
	&lt;li&gt;@return Channel close future&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private boolean close(Throwable cause) {&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Boolean&amp;gt; close(Throwable cause) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think this method can give you wrong results when being called twice. The second call will give you a completed future even though the first call could still be running.&lt;/p&gt;</comment>
                            <comment id="16247478" author="githubbot" created="Fri, 10 Nov 2017 13:14:30 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150230379&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150230379&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -309,31 +323,38 @@ private void handInChannel(Channel channel) {&lt;br/&gt;
     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with a ClosedChannelException.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close() {&lt;/li&gt;
	&lt;li&gt;close(new ClosedChannelException());&lt;br/&gt;
    +		private CompletableFuture&amp;lt;?&amp;gt; close() 
{
    +			return close(new ClosedChannelException());
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with an Exception (can be 
{@code null}
&lt;p&gt;)&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;or forward to the established channel.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close(Throwable cause) {&lt;br/&gt;
    +		private CompletableFuture&amp;lt;?&amp;gt; close(Throwable cause) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This method is blocking even though it shouldn&apos;t be. Imagine that two close calls happen concurrently. One of them should trigger the closing operation and the other should immediately return with the termination future.&lt;/p&gt;</comment>
                            <comment id="16247479" author="githubbot" created="Fri, 10 Nov 2017 13:14:30 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150228810&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150228810&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -483,27 +511,31 @@ private boolean close(Throwable cause) {&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void onRequestResult(long requestId, RESP response) {&lt;br/&gt;
     			TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.complete(response)) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (pending != null &amp;amp;&amp;amp; !pending.isDone()) {
     				long durationMillis = (System.nanoTime() - pending.getTimestamp()) / 1_000_000L;
     				stats.reportSuccessfulRequest(durationMillis);
    +				pending.complete(response);
     			}     		}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		@Override&lt;br/&gt;
     		public void onRequestFailure(long requestId, Throwable cause) {&lt;br/&gt;
     			TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.completeExceptionally(cause)) {&lt;br/&gt;
    +			if (pending != null &amp;amp;&amp;amp; !pending.isDone()) {&lt;br/&gt;
     				stats.reportFailedRequest();&lt;br/&gt;
    +				pending.completeExceptionally(cause);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Same here?&lt;/p&gt;</comment>
                            <comment id="16247480" author="githubbot" created="Fri, 10 Nov 2017 13:14:30 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150230620&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150230620&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,27 +168,39 @@ public String getClientName() {&lt;br/&gt;
     	 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Boolean&amp;gt; shutdown() {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This method when being called twice will give you a wrong result. The second call will immediately return you a completed future.&lt;/p&gt;</comment>
                            <comment id="16247481" author="githubbot" created="Fri, 10 Nov 2017 13:14:31 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150227018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150227018&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -309,31 +323,38 @@ private void handInChannel(Channel channel) {&lt;br/&gt;
     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with a ClosedChannelException.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close() {&lt;/li&gt;
	&lt;li&gt;close(new ClosedChannelException());&lt;br/&gt;
    +		private CompletableFuture&amp;lt;?&amp;gt; close() 
{
    +			return close(new ClosedChannelException());
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with an Exception (can be 
{@code null}
&lt;p&gt;)&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;or forward to the established channel.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close(Throwable cause) {&lt;br/&gt;
    +		private CompletableFuture&amp;lt;?&amp;gt; close(Throwable cause) {&lt;br/&gt;
     			synchronized (connectLock) {&lt;/li&gt;
	&lt;li&gt;if (!closed) {&lt;br/&gt;
    +				final CompletableFuture&amp;lt;?&amp;gt; shutdownFuture;&lt;br/&gt;
    +				if (closed) {&lt;br/&gt;
    +					shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    shorter: `CompletableFuture.completedFuture(null)`&lt;/p&gt;</comment>
                            <comment id="16247482" author="githubbot" created="Fri, 10 Nov 2017 13:14:31 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150228785&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150228785&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -483,27 +511,31 @@ private boolean close(Throwable cause) {&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void onRequestResult(long requestId, RESP response) {&lt;br/&gt;
     			TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.complete(response)) {&lt;br/&gt;
    +			if (pending != null &amp;amp;&amp;amp; !pending.isDone()) {&lt;br/&gt;
     				long durationMillis = (System.nanoTime() - pending.getTimestamp()) / 1_000_000L;&lt;br/&gt;
     				stats.reportSuccessfulRequest(durationMillis);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Shouldn&apos;t we only increase the `stats.reportSuccessfulRequest` if we could complete `pending`?&lt;/p&gt;</comment>
                            <comment id="16247484" author="githubbot" created="Fri, 10 Nov 2017 13:16:44 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150231729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150231729&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; queryExecShutdownFuture = CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
    +				try {&lt;br/&gt;
    +					if (queryExecutor != null &amp;amp;&amp;amp; !queryExecutor.isShutdown()) {&lt;br/&gt;
    +						queryExecutor.shutdown();&lt;br/&gt;
    +						queryExecutor.awaitTermination(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    What if `awaitTermination` returns `false`? Then we should call `queryExecutor.shutdownNow`&lt;/p&gt;</comment>
                            <comment id="16247487" author="githubbot" created="Fri, 10 Nov 2017 13:18:09 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150232000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150232000&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Ideally we would get rid of the `timeout` parameter because that is something the user specifies when calling `get()` on the returned termination future.&lt;/p&gt;</comment>
                            <comment id="16247539" author="githubbot" created="Fri, 10 Nov 2017 14:09:20 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150243346&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150243346&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Boolean&amp;gt; queryExecShutdownFuture = CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
    +				try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (queryExecutor != null &amp;amp;&amp;amp; !queryExecutor.isShutdown()) {
    +						queryExecutor.shutdown();
    +						queryExecutor.awaitTermination(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +						return true;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (InterruptedException e) {&lt;br/&gt;
    +					log.warn(&quot;Failed to shutdown {}: &quot;, serverName, e);&lt;br/&gt;
    +					return false;&lt;br/&gt;
    +				}&lt;br/&gt;
    +				return false;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We want to avoid pulling in the dependency of `runtime` here. Does it make sense to move the `Executors` to another module, e.g. `core`.&lt;/p&gt;</comment>
                            <comment id="16251497" author="githubbot" created="Tue, 14 Nov 2017 15:00:18 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150856825&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150856825&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -483,27 +511,31 @@ private boolean close(Throwable cause) {&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void onRequestResult(long requestId, RESP response) {&lt;br/&gt;
     			TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.complete(response)) {&lt;br/&gt;
    +			if (pending != null &amp;amp;&amp;amp; !pending.isDone()) {&lt;br/&gt;
     				long durationMillis = (System.nanoTime() - pending.getTimestamp()) / 1_000_000L;&lt;br/&gt;
     				stats.reportSuccessfulRequest(durationMillis);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This was creating test instabilities in the `AbstractServerTest.testPortRangeSuccess()`. This is why I decided to complete the future after increasing the counter. Given that we check if the `pending.isDone()`, we do not leave much room for false increases. &lt;/p&gt;</comment>
                            <comment id="16251521" author="githubbot" created="Tue, 14 Nov 2017 15:14:52 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the comments @tillrohrmann . I addressed them.&lt;/p&gt;</comment>
                            <comment id="16251613" author="githubbot" created="Tue, 14 Nov 2017 16:05:13 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150878782&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150878782&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,25 +262,47 @@ private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;LOG.info(&quot;Shutting down server {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I agree, but we need the `timeout` in order to shut down the `executors`.&lt;/p&gt;</comment>
                            <comment id="16251749" author="githubbot" created="Tue, 14 Nov 2017 17:09:52 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150890435&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150890435&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -208,9 +239,15 @@ public void shutdown() {&lt;br/&gt;
     		/** The established connection after the connect succeeds. */&lt;br/&gt;
     		private EstablishedConnection established;&lt;/p&gt;

&lt;p&gt;    +		/** Atomic shut down future. */&lt;br/&gt;
    +		private final AtomicReference&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; connectionShutdownFuture = new AtomicReference&amp;lt;&amp;gt;(null);&lt;br/&gt;
    +&lt;br/&gt;
     		/** Closed flag. */&lt;br/&gt;
     		private boolean closed;&lt;/p&gt;

&lt;p&gt;    +//		/** Shut down future. */&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    ?&lt;/p&gt;</comment>
                            <comment id="16251750" author="githubbot" created="Tue, 14 Nov 2017 17:09:52 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150899000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150899000&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -419,20 +472,31 @@ void close() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param cause The cause to close the channel with.&lt;/li&gt;
	&lt;li&gt;@return Channel close future&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private boolean close(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;if (failureCause.compareAndSet(null, cause)) {&lt;/li&gt;
	&lt;li&gt;channel.close();&lt;/li&gt;
	&lt;li&gt;stats.reportInactiveConnection();&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Boolean&amp;gt; close(Throwable cause) {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Boolean&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (long requestId : pendingRequests.keySet()) {&lt;/li&gt;
	&lt;li&gt;TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/li&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.completeExceptionally(cause)) {&lt;/li&gt;
	&lt;li&gt;stats.reportFailedRequest();&lt;br/&gt;
    +			if (connectionShutdownFuture.compareAndSet(null, shutdownFuture) &amp;amp;&amp;amp;&lt;br/&gt;
    +					failureCause.compareAndSet(null, cause)) {&lt;br/&gt;
    +&lt;br/&gt;
    +				channel.close().addListener(finished -&amp;gt; {&lt;br/&gt;
    +					stats.reportInactiveConnection();&lt;br/&gt;
    +					for (long requestId : pendingRequests.keySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +						TimestampedCompletableFuture pending = pendingRequests.remove(requestId);    +						if (pending != null &amp;amp;&amp;amp; pending.completeExceptionally(cause)) {
    +							stats.reportFailedRequest();
    +						}     					}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;return true;&lt;br/&gt;
    +&lt;br/&gt;
    +					if (finished.isSuccess()) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This seems weird at first sight but I&apos;m guessing it&apos;s correct. I.e. we never finish the returned Future with the `cause` that was handed in. We only fail it exceptionally if anything in closing the channel went wrong, right? &lt;/p&gt;</comment>
                            <comment id="16251751" author="githubbot" created="Tue, 14 Nov 2017 17:09:52 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993#discussion_r150893389&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993#discussion_r150893389&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/main/java/org/apache/flink/queryablestate/server/KvStateServerImpl.java &amp;#8212;&lt;br/&gt;
    @@ -106,6 +108,12 @@ public InetSocketAddress getServerAddress() {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void shutdown() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;super.shutdown();&lt;br/&gt;
    +		try {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why is this not also returning a future?&lt;/p&gt;</comment>
                            <comment id="16280336" author="githubbot" created="Wed, 6 Dec 2017 15:46:11 +0000"  >&lt;p&gt;Github user kl0u closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16280339" author="githubbot" created="Wed, 6 Dec 2017 15:47:12 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    It was merged as part of &lt;a href=&quot;https://github.com/apache/flink/pull/5062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mdcn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Merged on master (74d052bb045031363652116ab8226d8ac00e0cd0) and 1.4.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>