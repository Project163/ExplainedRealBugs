<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:48:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18663] RestServerEndpoint may prevent server shutdown</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18663</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;AbstractHandler throw NPE cause by FlinkHttpObjectAggregator is null&lt;/p&gt;

&lt;p&gt;when rest&#160;throw exception, it will do this code&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; CompletableFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; handleException(Throwable throwable, ChannelHandlerContext ctx, HttpRequest httpRequest) {
	FlinkHttpObjectAggregator flinkHttpObjectAggregator = ctx.pipeline().get(FlinkHttpObjectAggregator.class);
	&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxLength = flinkHttpObjectAggregator.maxContentLength() - OTHER_RESP_PAYLOAD_OVERHEAD;
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RestHandlerException) {
		RestHandlerException rhe = (RestHandlerException) throwable;
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; stackTrace = ExceptionUtils.stringifyException(rhe);
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; truncatedStackTrace = Ascii.truncate(stackTrace, maxLength, &lt;span class=&quot;code-quote&quot;&gt;&quot;...&quot;&lt;/span&gt;);
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (log.isDebugEnabled()) {
			log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception occurred in REST handler.&quot;&lt;/span&gt;, rhe);
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception occurred in REST handler: {}&quot;&lt;/span&gt;, rhe.getMessage());
		}
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; HandlerUtils.sendErrorResponse(
			ctx,
			httpRequest,
			&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ErrorResponseBody(truncatedStackTrace),
			rhe.getHttpResponseStatus(),
			responseHeaders);
	} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
		log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unhandled exception.&quot;&lt;/span&gt;, throwable);
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; stackTrace = &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;Exception on server side:%n%s%nEnd of exception on server side&amp;gt;&quot;&lt;/span&gt;,
			ExceptionUtils.stringifyException(throwable));
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; truncatedStackTrace = Ascii.truncate(stackTrace, maxLength, &lt;span class=&quot;code-quote&quot;&gt;&quot;...&quot;&lt;/span&gt;);
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; HandlerUtils.sendErrorResponse(
			ctx,
			httpRequest,
			&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ErrorResponseBody(Arrays.asList(&lt;span class=&quot;code-quote&quot;&gt;&quot;Internal server error.&quot;&lt;/span&gt;, truncatedStackTrace)),
			HttpResponseStatus.INTERNAL_SERVER_ERROR,
			responseHeaders);
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but&#160;flinkHttpObjectAggregator some case is null,so this will throw NPE,but this method called by&#160; AbstractHandler#respondAsLeader&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
requestProcessingFuture
	.whenComplete((&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; ignored, Throwable throwable) -&amp;gt; {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			handleException(ExceptionUtils.stripCompletionException(throwable), ctx, httpRequest)
				.whenComplete((&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; ignored2, Throwable throwable2) -&amp;gt; finalizeRequestProcessing(finalUploadedFiles));
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			finalizeRequestProcessing(finalUploadedFiles);
		}
	});
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;the result is InFlightRequestTracker&#160;Cannot be cleared.&lt;/p&gt;

&lt;p&gt;so the CompletableFuture does&#8216;t complete that handler&apos;s&#160;closeAsync returned&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13008077/13008077_C49A7310-F932-451B-A203-6D17F3140C0D.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13008078/13008078_e18e00dd6664485c2ff55284fe969474.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13318476">FLINK-18663</key>
            <summary>RestServerEndpoint may prevent server shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tartarus">tartarus</assignee>
                                    <reporter username="tartarus">tartarus</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 21 Jul 2020 11:11:48 +0000</created>
                <updated>Wed, 12 Aug 2020 13:00:25 +0000</updated>
                            <resolved>Mon, 3 Aug 2020 20:22:54 +0000</resolved>
                                    <version>1.10.0</version>
                    <version>1.10.1</version>
                    <version>1.11.0</version>
                                    <fixVersion>1.10.2</fixVersion>
                    <fixVersion>1.11.2</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / REST</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17161958" author="zentol" created="Tue, 21 Jul 2020 11:35:49 +0000"  >&lt;p&gt;It would be good to understand why the &lt;tt&gt;FlinkHttpObjectAggregator&lt;/tt&gt; was null. My understanding is that this should only happen if netty is being shut down, but that on the other hand should only happen after all handlers have shut down.&lt;/p&gt;

&lt;p&gt;Have you made any modifications to Flink? Can you tell us more about the exact circumstances under which this occurred?&lt;/p&gt;</comment>
                            <comment id="17162028" author="tartarus" created="Tue, 21 Jul 2020 13:16:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&#160;thanks for your reply.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This problem does not occur frequently, but&#160;when the JM load is too high, such as GC&#65292;call /jobs/overview maybe happen exception&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-07-21 12:39:21,458 WARN  org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.job.JobsOverviewHandler[flink-scheduler-1]  - ##### requestProcessingFuture url = /jobs/overview, throwable
java.util.concurrent.CompletionException: akka.pattern.AskTimeoutException: Ask timed out on [Actor[akka:&lt;span class=&quot;code-comment&quot;&gt;//flink/user/dispatcher#-919763123]] after [10000 ms]. Message of type [org.apache.flink.runtime.rpc.messages.LocalFencedMessage]. A typical reason &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; `AskTimeoutException` is that
&lt;/span&gt; the recipient actor didn&apos;t send a reply.
        at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:292)
        at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:308)
        at java.util.concurrent.CompletableFuture.uniApply(CompletableFuture.java:593)
        at java.util.concurrent.CompletableFuture$UniApply.tryFire(CompletableFuture.java:577)
        at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:474)
        at java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:1977)
        at org.apache.flink.runtime.concurrent.FutureUtils$1.onComplete(FutureUtils.java:878)
        at akka.dispatch.OnComplete.internal(Future.scala:263)
        at akka.dispatch.OnComplete.internal(Future.scala:261)
        at akka.dispatch.japi$CallbackBridge.apply(Future.scala:191)
        at akka.dispatch.japi$CallbackBridge.apply(Future.scala:188)
        at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:36)
        at org.apache.flink.runtime.concurrent.Executors$DirectExecutionContext.execute(Executors.java:74)
        at scala.concurrent.impl.CallbackRunnable.executeWithValue(Promise.scala:44)
        at scala.concurrent.impl.Promise$DefaultPromise.tryComplete(Promise.scala:252)
        at akka.pattern.PromiseActorRef$$anonfun$1.apply$mcV$sp(AskSupport.scala:644)
        at akka.actor.Scheduler$$anon$4.run(Scheduler.scala:205)
        at scala.concurrent.Future$InternalCallbackExecutor$.unbatchedExecute(Future.scala:601)
        at scala.concurrent.BatchingExecutor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;execute(BatchingExecutor.scala:109)
        at scala.concurrent.Future$InternalCallbackExecutor$.execute(Future.scala:599)
        at akka.actor.LightArrayRevolverScheduler$TaskHolder.executeTask(LightArrayRevolverScheduler.scala:328)
        at akka.actor.LightArrayRevolverScheduler$$anon$4.executeBucket$1(LightArrayRevolverScheduler.scala:279)
        at akka.actor.LightArrayRevolverScheduler$$anon$4.nextTick(LightArrayRevolverScheduler.scala:283)
        at akka.actor.LightArrayRevolverScheduler$$anon$4.run(LightArrayRevolverScheduler.scala:235)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: akka.pattern.AskTimeoutException: Ask timed out on [Actor[akka:&lt;span class=&quot;code-comment&quot;&gt;//flink/user/dispatcher#-919763123]] after [10000 ms]. Message of type [org.apache.flink.runtime.rpc.messages.LocalFencedMessage]. A typical reason &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; `AskTimeoutException` is that the recipient actor didn&apos;t sen
&lt;/span&gt;d a reply.
        at akka.pattern.PromiseActorRef$$anonfun$2.apply(AskSupport.scala:635)
        at akka.pattern.PromiseActorRef$$anonfun$2.apply(AskSupport.scala:635)
        at akka.pattern.PromiseActorRef$$anonfun$1.apply$mcV$sp(AskSupport.scala:648)
        ... 9 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;there seem to be few changes to netty, but &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16626&quot; title=&quot;Prevent REST handler from being closed more than once&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-16626&quot;&gt;&lt;del&gt;FLINK-16626&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We found that the problem was indeed when canceling the flink job.&lt;/p&gt;

&lt;p&gt;there are some debug info,&#160;&#160;Handling exceptions under normal circumstances &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13008092/13008092_110.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;When abnormal&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13008093/13008093_111.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17162518" author="tartarus" created="Wed, 22 Jul 2020 06:20:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&#160;Here, &lt;tt&gt;FlinkHttpObjectAggregator&lt;/tt&gt;&#160;is only used to obtain maxContentLength, so why not pass &lt;tt&gt;RestHandlerConfiguration&lt;/tt&gt;&#160;or &lt;tt&gt;RestServerEndpointConfiguration&lt;/tt&gt;&#160;as construction parameters to AbstractHandler&lt;/p&gt;</comment>
                            <comment id="17162555" author="tartarus" created="Wed, 22 Jul 2020 07:23:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; There is a separate monitoring service that requests /jobs/overview every 5 seconds&lt;/p&gt;</comment>
                            <comment id="17163172" author="tartarus" created="Thu, 23 Jul 2020 02:16:03 +0000"  >&lt;p&gt;The request received by akka seems to be single-threaded. Since flink has 20000 tasks, it is suspected that the timeout exception has a certain relationship with this request&lt;/p&gt;</comment>
                            <comment id="17164218" author="till.rohrmann" created="Fri, 24 Jul 2020 07:30:16 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tartarus&quot; class=&quot;user-hover&quot; rel=&quot;tartarus&quot;&gt;tartarus&lt;/a&gt;. I agree with Chesnay that it would great to better understand why this can happen. Apparently, you can reproduce the problem. Would it be possible for you to add a logging statement in the first line of &lt;tt&gt;AbstractHandler.handleException&lt;/tt&gt; which logs the handled exception. Moreover, it would be great if you could share the debug logs of such a run in order to better understand what is happening. To better understand what&apos;s happening in the shut down, it would be helpful if you could add &lt;tt&gt;log.info(&quot;Shutting RestServerEndpoint down internally&quot;)&lt;/tt&gt; as the first line of &lt;tt&gt;RestServerEndpoint.shutDownInternal()&lt;/tt&gt;. Thanks a lot for you help!&lt;/p&gt;</comment>
                            <comment id="17164219" author="till.rohrmann" created="Fri, 24 Jul 2020 07:31:03 +0000"  >&lt;p&gt;I might actually also be helpful if you could set the logger to the &lt;tt&gt;TRACE&lt;/tt&gt; level.&lt;/p&gt;</comment>
                            <comment id="17164229" author="till.rohrmann" created="Fri, 24 Jul 2020 07:38:38 +0000"  >&lt;p&gt;One suspicion I have is the following: When calling &lt;tt&gt;AbstractHandler.respondAsLeader&lt;/tt&gt; we don&apos;t check whether the handler has been terminated or not. Hence the following might happen:&lt;/p&gt;

&lt;p&gt;1. We receive a REST request and we call into &lt;tt&gt;AbstractHandler.channelRead0&lt;/tt&gt; (inherited from &lt;tt&gt;LeaderRetrievalHandler&lt;/tt&gt;)&lt;br/&gt;
2. The &lt;tt&gt;RestServerEndpoint&lt;/tt&gt; is being shut down which closes all handlers&lt;br/&gt;
3. Since no requests are registered in &lt;tt&gt;AbstractHandler.inFlightRequestTracker&lt;/tt&gt;, we immediately close the handlers&lt;br/&gt;
4. After having obtained the leader gateway, we call into &lt;tt&gt;AbstractHandler.respondAsLeader&lt;/tt&gt; which registers the request in the &lt;tt&gt;inFlightRequestTracker&lt;/tt&gt; but does not check whether the handler has been shut down.&lt;/p&gt;

&lt;p&gt;If this should indeed be the problem, then I would suggest that we check under the &lt;tt&gt;lock&lt;/tt&gt; whether &lt;tt&gt;terminationFuture&lt;/tt&gt; has been set and also add the request to the &lt;tt&gt;inFlightRequestTracker&lt;/tt&gt; under the &lt;tt&gt;lock&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17165150" author="tartarus" created="Sun, 26 Jul 2020 02:56:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;thanks for your reply.&lt;/p&gt;

&lt;p&gt;I think your&#160;suspicion is right. I will add the log and&#160;reproduce it,&#160; and then upload the log.&lt;/p&gt;</comment>
                            <comment id="17165176" author="tartarus" created="Sun, 26 Jul 2020 07:48:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; hello, you said the &lt;tt&gt;terminationFuture&lt;/tt&gt; is &lt;tt&gt;AbstractHandler.terminationFuture&lt;/tt&gt; ?&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;AbstractHandler.terminationFuture&lt;/tt&gt; wait for &lt;tt&gt;AbstractHandler.inFlightRequestTracker&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17165504" author="till.rohrmann" created="Mon, 27 Jul 2020 07:38:22 +0000"  >&lt;p&gt;Yes I mean the &lt;tt&gt;AbstractHandler.terminationFuture&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17166125" author="tartarus" created="Tue, 28 Jul 2020 03:34:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160; the JobManager&apos;s log is too large&#65292;so I remove some yarn and container&#8217;s log.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;AbstractHandler.terminationFuture&lt;/tt&gt; has not complete, because&#160;AbstractHandler.inFlightRequestTracker&#160;Cannot be cleared.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13008529/13008529_jobmanager.log.noyarn.tar.gz&quot; title=&quot;jobmanager.log.noyarn.tar.gz attached to FLINK-18663&quot;&gt;jobmanager.log.noyarn.tar.gz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I add the log you tell me , you can filter &apos;#####&apos; ,&#160; the &lt;tt&gt;log.info(&quot;Shutting RestServerEndpoint down internally&quot;)&lt;/tt&gt; dosen&apos;t happen ,because &lt;tt&gt;org.apache.flink.runtime.rest.handler.job.JobsOverviewHandler&lt;/tt&gt; not close yet.&lt;/p&gt;

&lt;p&gt;and &lt;tt&gt;org.apache.flink.runtime.rest.handler.job.JobsOverviewHandler&lt;/tt&gt; not close because &lt;tt&gt;AbstractHandler.inFlightRequestTracker&lt;/tt&gt; not cleared, because the exception on job from&#160;SCHEDULED to DEPLOYING&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-07-27 21:57:26,685 ERROR org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.job.JobsOverviewHandler[flink-scheduler-1]  - ##### handle exception &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; url /jobs/overview
2020-07-27 21:57:26,685 ERROR org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.job.JobsOverviewHandler[flink-scheduler-1]  - ##### handle exception &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; url /jobs/overview
akka.pattern.AskTimeoutException: Ask timed out on [Actor[akka:&lt;span class=&quot;code-comment&quot;&gt;//flink/user/dispatcher#-88418157]] after [10000 ms]. Message of type [org.apache.flink.runtime.rpc.messages.LocalFencedMessage]. A typical reason &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; `AskTimeoutException` is that the recipient actor didn&apos;t send a reply. 
&lt;/span&gt;  at akka.pattern.PromiseActorRef$$anonfun$2.apply(AskSupport.scala:635) 
  at akka.pattern.PromiseActorRef$$anonfun$2.apply(AskSupport.scala:635) 
  at akka.pattern.PromiseActorRef$$anonfun$1.apply$mcV$sp(AskSupport.scala:648) 
  at akka.actor.Scheduler$$anon$4.run(Scheduler.scala:205) 
  at scala.concurrent.Future$InternalCallbackExecutor$.unbatchedExecute(Future.scala:601) 
  at scala.concurrent.BatchingExecutor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;execute(BatchingExecutor.scala:109) 
  at scala.concurrent.Future$InternalCallbackExecutor$.execute(Future.scala:599)
  at akka.actor.LightArrayRevolverScheduler$TaskHolder.executeTask(LightArrayRevolverScheduler.scala:328) 
  at akka.actor.LightArrayRevolverScheduler$$anon$4.executeBucket$1(LightArrayRevolverScheduler.scala:279)
  at akka.actor.LightArrayRevolverScheduler$$anon$4.nextTick(LightArrayRevolverScheduler.scala:283) 
  at akka.actor.LightArrayRevolverScheduler$$anon$4.run(LightArrayRevolverScheduler.scala:235) 
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
2020-07-27 21:57:26,686 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph      [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-48]  - 1-1.1_Sink: Unnamed (533/1500) (1b0945713f48026b5c677a2d1559f78f) switched from SCHEDULED to DEPLOYING.
2020-07-27 21:57:26,686 ERROR org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.job.JobsOverviewHandler[flink-scheduler-1]  - ##### handleException happened exception
java.lang.NullPointerException 
  at org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.AbstractHandler.handleException(AbstractHandler.java:204) 
  at org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.AbstractHandler.lambda$respondAsLeader$1(AbstractHandler.java:182) 
  at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:760) 
  at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:736) 
  at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:474) 
  at java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:1977) 
  at org.apache.flink.runtime.concurrent.FutureUtils$1.onComplete(FutureUtils.java:872) 
  at akka.dispatch.OnComplete.internal(Future.scala:263) 
  at akka.dispatch.OnComplete.internal(Future.scala:261) 
  at akka.dispatch.japi$CallbackBridge.apply(Future.scala:191) 
  at akka.dispatch.japi$CallbackBridge.apply(Future.scala:188) 
  at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:36) 
  at org.apache.flink.runtime.concurrent.Executors$DirectExecutionContext.execute(Executors.java:74) 
  at scala.concurrent.impl.CallbackRunnable.executeWithValue(Promise.scala:44) 
  at scala.concurrent.impl.Promise$DefaultPromise.tryComplete(Promise.scala:252) 
  at akka.pattern.PromiseActorRef$$anonfun$1.apply$mcV$sp(AskSupport.scala:644) 
  at akka.actor.Scheduler$$anon$4.run(Scheduler.scala:205) 
  at scala.concurrent.Future$InternalCallbackExecutor$.unbatchedExecute(Future.scala:601) 
  at scala.concurrent.BatchingExecutor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;execute(BatchingExecutor.scala:109) 
  at scala.concurrent.Future$InternalCallbackExecutor$.execute(Future.scala:599) 
  at akka.actor.LightArrayRevolverScheduler$TaskHolder.executeTask(LightArrayRevolverScheduler.scala:328)
  at akka.actor.LightArrayRevolverScheduler$$anon$4.executeBucket$1(LightArrayRevolverScheduler.scala:279) 
  at akka.actor.LightArrayRevolverScheduler$$anon$4.nextTick(LightArrayRevolverScheduler.scala:283) 
  at akka.actor.LightArrayRevolverScheduler$$anon$4.run(LightArrayRevolverScheduler.scala:235) at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I am not very clear why &lt;tt&gt;FlinkHttpObjectAggregator&lt;/tt&gt;&#160;was null&#65292;but,&#160;&#160;&lt;tt&gt;FlinkHttpObjectAggregator here&lt;/tt&gt;&#160;is only used to obtain maxContentLength, so why not pass&#160;&lt;tt&gt;RestHandlerConfiguration&lt;/tt&gt;&#160;or&#160;&lt;tt&gt;RestServerEndpointConfiguration&lt;/tt&gt;&#160;as construction parameters to AbstractHandler, then we can&#160;obtain some other config too,&#160;I feel more flexible like this.&lt;/p&gt;

&lt;p&gt;But this is very redundant, after all, most of the parameters are not used.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17166276" author="till.rohrmann" created="Tue, 28 Jul 2020 08:57:06 +0000"  >&lt;p&gt;Thanks for providing the logs &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tartarus&quot; class=&quot;user-hover&quot; rel=&quot;tartarus&quot;&gt;tartarus&lt;/a&gt;. There is some part missing which shows under which address the &lt;tt&gt;Dispatcher&lt;/tt&gt; is being registered. Would it be possible to also post this part. The reason I&apos;m asking is because I want to understand whether there was a failover happening and whether &lt;tt&gt;Actor[akka://flink/user/dispatcher#-88418157&lt;/tt&gt; is the running &lt;tt&gt;Dispatcher&lt;/tt&gt;. It is a bit odd that all the requests time out with an &lt;tt&gt;AskTimeoutException&lt;/tt&gt; if it is the running &lt;tt&gt;Dispatcher&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It is true that we can get rid of the symptoms of the problem by passing in the &lt;tt&gt;maxContentLength&lt;/tt&gt; but I would also like to understand the underlying problem. Have you tried what I proposed to add above? Concretely checking under &lt;tt&gt;lock&lt;/tt&gt; whether &lt;tt&gt;terminationFuture&lt;/tt&gt; has been set at the beginning of &lt;tt&gt;respondAsLeader&lt;/tt&gt;? If it has been set, then this means that the handler is shutting down and we should ignore this request. Moreover, the &lt;tt&gt;inFlightRequestTracker.registerRequest();&lt;/tt&gt; should also happen under &lt;tt&gt;lock&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17166295" author="zentol" created="Tue, 28 Jul 2020 09:28:40 +0000"  >&lt;p&gt;The job seems to consist of several thousand tasks, and we can see that the deployment alone takes upwards of 30 seconds. This should explain the TimeoutException leading to the NPE.&lt;br/&gt;
The TimeoutExceptions in the beginning of the log can probably be attributed to the initialization of the job.&lt;/p&gt;
</comment>
                            <comment id="17166433" author="tartarus" created="Tue, 28 Jul 2020 13:49:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;I may not understand you too much before, but I&apos;m sure&#160;&lt;tt&gt;AbstractHandler.terminationFuture&lt;/tt&gt;&#160;has not complete, because I has dump a jvm.&lt;/p&gt;

&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&#160;is right , this job has 15000 tasks, and GC&#160;frequently, so the&#160;TimeoutException&#160;is possible.&lt;/p&gt;

&lt;p&gt;I am not very clear why&#160;&lt;tt&gt;FlinkHttpObjectAggregator&lt;/tt&gt;&#160;was null.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&#160; Do you have any suggestions on this issue?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17166467" author="zentol" created="Tue, 28 Jul 2020 14:33:32 +0000"  >&lt;p&gt;So far the only explanation that I could find for a pipeline returning null is that the channel was already closed.&lt;/p&gt;

&lt;p&gt;Our current assumption was that this happened because the RestServerEndpoint is shutting down. From the logs you gave us it appears that the shutdown is initiated 2 minutes after the NPE; this doesn&apos;t seem to match our assumption.&lt;/p&gt;

&lt;p&gt;I&apos;m wondering what would happen if the netty connection were to be closed by the client. We know that the request processing is delayed by 10 seconds; if the client aborts the connection in between maybe netty starts cleaning up the pipeline.&lt;/p&gt;</comment>
                            <comment id="17166483" author="till.rohrmann" created="Tue, 28 Jul 2020 15:00:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tartarus&quot; class=&quot;user-hover&quot; rel=&quot;tartarus&quot;&gt;tartarus&lt;/a&gt; what I meant is to check whether &lt;tt&gt;AbstractHandler.terminationFuture&lt;/tt&gt; is not &lt;tt&gt;null&lt;/tt&gt;. If this is the case, then the handler is being shut down.&lt;/p&gt;

&lt;p&gt;I agree with Chesnay that we might have to look into other explanations for the described problem.&lt;/p&gt;</comment>
                            <comment id="17166485" author="tartarus" created="Tue, 28 Jul 2020 15:01:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&#160;&#160;There is a separate monitoring service that requests /jobs/overview every 5 seconds and timeout is 5 seconds too.&lt;/p&gt;

&lt;p&gt;Then will close the client.&#160;&lt;/p&gt;</comment>
                            <comment id="17166717" author="zentol" created="Tue, 28 Jul 2020 22:05:27 +0000"  >&lt;p&gt;Well there we go then, I was able to reproduce the issue. It is indeed due to the client closing the connection.&lt;/p&gt;</comment>
                            <comment id="17166755" author="yungthuis@hotmail.com" created="Tue, 28 Jul 2020 23:48:00 +0000"  >&lt;p&gt;&#21457;&#33258;&#25105;&#30340;&#21326;&#20026;&#25163;&#26426;&lt;/p&gt;

&lt;p&gt;-------- &#21407;&#22987;&#37038;&#20214; --------&lt;br/&gt;
&#21457;&#20214;&#20154;&#65306; &quot;Chesnay Schepler (Jira)&quot; &amp;lt;jira@apache.org&amp;gt;&lt;br/&gt;
&#26085;&#26399;&#65306; 2020&#24180;7&#26376;29&#26085;&#21608;&#19977; &#28165;&#26216;6:06&lt;br/&gt;
&#25910;&#20214;&#20154;&#65306; issues@flink.apache.org&lt;br/&gt;
&#20027; &#39064;&#65306; &lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Commented&amp;#93;&lt;/span&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18663&quot; title=&quot;RestServerEndpoint may prevent server shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18663&quot;&gt;&lt;del&gt;FLINK-18663&lt;/del&gt;&lt;/a&gt;) Fix Flink On YARN AM not exit&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160; [ &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18663?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel&amp;amp;focusedCommentId=17166717#comment-17166717&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-18663?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel&amp;amp;focusedCommentId=17166717#comment-17166717&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Chesnay Schepler commented on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18663&quot; title=&quot;RestServerEndpoint may prevent server shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18663&quot;&gt;&lt;del&gt;FLINK-18663&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
------------------------------------------&lt;/p&gt;

&lt;p&gt;Well there we go then, I was able to reproduce the issue. It is indeed due to the client closing the connection.&lt;/p&gt;




&lt;p&gt;&amp;#8211;&lt;br/&gt;
This message was sent by Atlassian Jira&lt;br/&gt;
(v8.3.4#803005)&lt;/p&gt;</comment>
                            <comment id="17166813" author="tartarus" created="Wed, 29 Jul 2020 02:19:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;Then we discuss how to fix this problem?&lt;/p&gt;

&lt;p&gt;what do you think about&#160;pass&#160;&#160;&lt;tt&gt;maxContentLength&lt;/tt&gt;&#160;as construction parameters to AbstractHandler?&lt;/p&gt;

&lt;p&gt;Then modify all Handlers.&#160;Do you have any good suggestions? thanks&lt;/p&gt;</comment>
                            <comment id="17167061" author="zentol" created="Wed, 29 Jul 2020 08:42:22 +0000"  >&lt;p&gt;It is rather annoying to pass the &lt;tt&gt;maxContentLength&lt;/tt&gt; to all handlers (yet another case why I&apos;d prefer composition for our handlers at this point); I&apos;m tempted to just catch the &lt;tt&gt;NullPointerException&lt;/tt&gt; and log an error &quot;Connection was unexpectedly closed by the client.&quot;; we wouldn&apos;t be able to send a response anyway.&lt;/p&gt;

&lt;p&gt;We should also slightly change how the request is finalized, to ensure this happens in all cases, regardless of whether &lt;tt&gt;handleExceptions&lt;/tt&gt; throws an exception:.&lt;br/&gt;
So I&apos;d suggest to change it to this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
requestProcessingFuture
	.handle((ignored, throwable) -&amp;gt; {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; handleException(ExceptionUtils.stripCompletionException(throwable), ctx, httpRequest);
		}
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; CompletableFuture.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;completedFuture(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
	})
	.thenCompose(Function.identity())
	.whenComplete((&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; ignored, Throwable throwable) -&amp;gt; finalizeRequestProcessing(finalUploadedFiles));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Furthermore, even if our original theory did not hold, I do think that it is still possible for it to occur, so we should also fix that as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; suggested.&lt;/p&gt;</comment>
                            <comment id="17167078" author="till.rohrmann" created="Wed, 29 Jul 2020 09:16:54 +0000"  >&lt;p&gt;Can we check the call sites where we try to access the handlers of the pipeline? A null check and a more meaningful exception than &lt;tt&gt;NullPointerException&lt;/tt&gt; could be helpful for users/devs to understand the problem.&lt;/p&gt;

&lt;p&gt;I agree with Chesnay that we should always run &lt;tt&gt;finalizeRequestProcessing&lt;/tt&gt; independent of what happened in between. We should also log in the last &lt;tt&gt;whenComplete&lt;/tt&gt; call the &lt;tt&gt;throwable&lt;/tt&gt; if it is not null.&lt;/p&gt;</comment>
                            <comment id="17167093" author="tartarus" created="Wed, 29 Jul 2020 09:44:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&#160; I think we should add a log to indicate that an exception occurred in handleException.&lt;br/&gt;
 The positioning problem took a lot of time this time because NPE did not print it out.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;I agree with you.&lt;/p&gt;

&lt;p&gt;how about this&#65306;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
requestProcessingFuture
	.handle((&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; ignored, Throwable throwable) -&amp;gt; {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; handleException(ExceptionUtils.stripCompletionException(throwable), ctx, httpRequest);
		}
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; CompletableFuture.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;completedFuture(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
	}).thenCompose(Function.identity())
	.whenComplete((&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; ignored, Throwable throwable) -&amp;gt; {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;ignored the exception when execute the handleException method&quot;&lt;/span&gt;, throwable);
		}
		finalizeRequestProcessing(finalUploadedFiles);
	});
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17167101" author="zentol" created="Wed, 29 Jul 2020 10:05:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tartarus&quot; class=&quot;user-hover&quot; rel=&quot;tartarus&quot;&gt;tartarus&lt;/a&gt; The log message should be &lt;tt&gt;&quot;An exception occurred while handling another exception.&quot;&lt;/tt&gt;.&lt;br/&gt;
And yes, the NPE should be catched within &lt;tt&gt;handleException&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17167135" author="tartarus" created="Wed, 29 Jul 2020 11:08:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&#160;ok&#65292;I has submit a PR&#160;&lt;a href=&quot;https://github.com/apache/flink/pull/13020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/13020&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17167159" author="tartarus" created="Wed, 29 Jul 2020 11:48:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160; about&#160;the checking for the termination future under the lock to ensure we don&apos;t start processing requests during a shutdown&#65292;how about this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
HttpRequest httpRequest = routedRequest.getRequest();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (log.isTraceEnabled()) {
	log.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Received request &quot;&lt;/span&gt; + httpRequest.uri() + &lt;span class=&quot;code-quote&quot;&gt;&apos;.&apos;&lt;/span&gt;);
}

&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (terminationFuture != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; errorMsg = &lt;span class=&quot;code-quote&quot;&gt;&quot;The handler instance &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &quot;&lt;/span&gt; + untypedResponseMessageHeaders.getTargetRestEndpointURL()
			+ &lt;span class=&quot;code-quote&quot;&gt;&quot; had already been closed&quot;&lt;/span&gt;;
		log.warn(errorMsg);
		HandlerUtils.sendErrorResponse(
			ctx,
			httpRequest,
			&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ErrorResponseBody(errorMsg),
			HttpResponseStatus.BAD_REQUEST,
			responseHeaders);
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;at the start of &lt;tt&gt;AbstractHandler#respondAsLeader&lt;/tt&gt; ?&lt;/p&gt;</comment>
                            <comment id="17170410" author="zentol" created="Mon, 3 Aug 2020 20:22:54 +0000"  >&lt;p&gt;master: &lt;br/&gt;
ee4b27f96e8156c6a1c4b825484d238055cecf5f&lt;br/&gt;
7619db019181347a16fd37f0e4e04c420f75eee9&lt;br/&gt;
1.11:&lt;br/&gt;
4c2f7c44fc7085edfd3f910135fbf7f54d5eadf1&lt;br/&gt;
862ac0f6921a7cf0a1f7fabfd3cff11292817fb0 &lt;br/&gt;
1.10:&lt;br/&gt;
bda138361e55437c84ea000fe38a6bce69cf7520&lt;br/&gt;
52a77e695ea9dea79f67f6b6a7281ceb1079f65e &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13322262">FLINK-18902</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13008092" name="110.png" size="1665683" author="tartarus" created="Tue, 21 Jul 2020 13:15:46 +0000"/>
                            <attachment id="13008093" name="111.png" size="616292" author="tartarus" created="Tue, 21 Jul 2020 13:16:30 +0000"/>
                            <attachment id="13008077" name="C49A7310-F932-451B-A203-6D17F3140C0D.png" size="315598" author="tartarus" created="Tue, 21 Jul 2020 11:15:16 +0000"/>
                            <attachment id="13008078" name="e18e00dd6664485c2ff55284fe969474.png" size="1476015" author="tartarus" created="Tue, 21 Jul 2020 11:15:25 +0000"/>
                            <attachment id="13008529" name="jobmanager.log.noyarn.tar.gz" size="2147150" author="tartarus" created="Tue, 28 Jul 2020 03:12:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0h1sg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>