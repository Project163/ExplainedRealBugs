<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:43:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-15577] WindowAggregate RelNodes missing Window specs in digest</title>
                <link>https://issues.apache.org/jira/browse/FLINK-15577</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The RelNode&apos;s digest (AbstractRelNode.getDigest()), along with its RowType, is used by the Calcite HepPlanner to avoid adding duplicate Vertices to the graph. If an equivalent vertex is already present in the graph, then that vertex is used in place of the newly generated one: &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/calcite/blob/branch-1.21/core/src/main/java/org/apache/calcite/plan/hep/HepPlanner.java#L828&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/calcite/blob/branch-1.21/core/src/main/java/org/apache/calcite/plan/hep/HepPlanner.java#L828&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This means that &lt;b&gt;the digest needs to contain all the information necessary to identify a vertex and distinguish it from similar - but not equivalent - vertices&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;In the case of `LogicalWindowAggregation` and `FlinkLogicalWindowAggregation`, the window specs are currently not in the digest, meaning that two aggregations with the same signatures and expressions but different windows are considered equivalent by the planner, which is not correct and will lead to an invalid Physical Plan.&lt;/p&gt;

&lt;p&gt;For instance, the following query would give an invalid plan:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WITH window_1h AS (
    SELECT HOP_ROWTIME(`timestamp`, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; HOUR, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; HOUR) as `timestamp`
    FROM my_table
    GROUP BY HOP(`timestamp`, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; HOUR, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; HOUR)
),
window_2h AS (
    SELECT HOP_ROWTIME(`timestamp`, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; HOUR, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; HOUR) as `timestamp`
    FROM my_table
    GROUP BY HOP(`timestamp`, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; HOUR, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; HOUR)
)
(SELECT * FROM window_1h)
UNION ALL
(SELECT * FROM window_2h)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The invalid plan generated by the planner is the following (&lt;b&gt;Please note the windows in the two DataStreamGroupWindowAggregates nodes being the same when they should be different&lt;/b&gt;):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
DataStreamUnion(all=[&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;], union all=[timestamp]): rowcount = 200.0, cumulative cost = {800.0 rows, 802.0 cpu, 0.0 io}, id = 176
  DataStreamCalc(select=[w$rowtime AS timestamp]): rowcount = 100.0, cumulative cost = {300.0 rows, 301.0 cpu, 0.0 io}, id = 173
    DataStreamGroupWindowAggregate(window=[SlidingGroupWindow(&lt;span class=&quot;code-quote&quot;&gt;&apos;w$, &apos;&lt;/span&gt;timestamp, 7200000.millis, 3600000.millis)], select=[start(&lt;span class=&quot;code-quote&quot;&gt;&apos;w$) AS w$start, end(&apos;&lt;/span&gt;w$) AS w$end, rowtime(&lt;span class=&quot;code-quote&quot;&gt;&apos;w$) AS w$rowtime, proctime(&apos;&lt;/span&gt;w$) AS w$proctime]): rowcount = 100.0, cumulative cost = {200.0 rows, 201.0 cpu, 0.0 io}, id = 172
      DataStreamScan(id=[1], fields=[timestamp]): rowcount = 100.0, cumulative cost = {100.0 rows, 101.0 cpu, 0.0 io}, id = 171
  DataStreamCalc(select=[w$rowtime AS timestamp]): rowcount = 100.0, cumulative cost = {300.0 rows, 301.0 cpu, 0.0 io}, id = 175
    DataStreamGroupWindowAggregate(window=[SlidingGroupWindow(&lt;span class=&quot;code-quote&quot;&gt;&apos;w$, &apos;&lt;/span&gt;timestamp, 7200000.millis, 3600000.millis)], select=[start(&lt;span class=&quot;code-quote&quot;&gt;&apos;w$) AS w$start, end(&apos;&lt;/span&gt;w$) AS w$end, rowtime(&lt;span class=&quot;code-quote&quot;&gt;&apos;w$) AS w$rowtime, proctime(&apos;&lt;/span&gt;w$) AS w$proctime]): rowcount = 100.0, cumulative cost = {200.0 rows, 201.0 cpu, 0.0 io}, id = 174
      DataStreamScan(id=[1], fields=[timestamp]): rowcount = 100.0, cumulative cost = {100.0 rows, 101.0 cpu, 0.0 io}, id = 171
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13279186">FLINK-15577</key>
            <summary>WindowAggregate RelNodes missing Window specs in digest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="b.hanotte">Benoit Hanotte</assignee>
                                    <reporter username="b.hanotte">Benoit Hanotte</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 13 Jan 2020 22:24:57 +0000</created>
                <updated>Mon, 20 Jan 2020 07:21:29 +0000</updated>
                            <resolved>Mon, 20 Jan 2020 07:21:29 +0000</resolved>
                                    <version>1.9.1</version>
                                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Table SQL / Legacy Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17014779" author="ykt836" created="Tue, 14 Jan 2020 01:33:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=b.hanotte&quot; class=&quot;user-hover&quot; rel=&quot;b.hanotte&quot;&gt;b.hanotte&lt;/a&gt;&#160; Thanks for the nice investigation, would you also like to fix this?&lt;/p&gt;</comment>
                            <comment id="17014856" author="b.hanotte" created="Tue, 14 Jan 2020 04:33:04 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ykt836&quot; class=&quot;user-hover&quot; rel=&quot;ykt836&quot;&gt;ykt836&lt;/a&gt;, yes, I&apos;ll push a PR today&lt;/p&gt;</comment>
                            <comment id="17014876" author="ykt836" created="Tue, 14 Jan 2020 06:07:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=b.hanotte&quot; class=&quot;user-hover&quot; rel=&quot;b.hanotte&quot;&gt;b.hanotte&lt;/a&gt;&#160;Thanks for the fix, looks like blink planner also has this issue, could you fix both?&lt;/p&gt;</comment>
                            <comment id="17014902" author="b.hanotte" created="Tue, 14 Jan 2020 07:25:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ykt836&quot; class=&quot;user-hover&quot; rel=&quot;ykt836&quot;&gt;ykt836&lt;/a&gt; yes, I&apos;ll have a look at both&lt;/p&gt;</comment>
                            <comment id="17015098" author="b.hanotte" created="Tue, 14 Jan 2020 13:53:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ykt836&quot; class=&quot;user-hover&quot; rel=&quot;ykt836&quot;&gt;ykt836&lt;/a&gt; I pushed the PR atr &lt;a href=&quot;https://github.com/apache/flink/pull/10854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/10854&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Only the legacy planner is concerned by this issue as Blink was already correctly setting the window specs in the nodes digests. I added the tests to both planners to make sure that case is covered and no such regression can be introduced in the future.&lt;/p&gt;</comment>
                            <comment id="17019270" author="ykt836" created="Mon, 20 Jan 2020 07:21:29 +0000"  >&lt;p&gt;1.9.2:&#160;578a70901230e83351287ffa6b73b27f5a16d8ad&lt;/p&gt;

&lt;p&gt;1.10.0:&#160;98d209eab2f6e6cad0bc678876a36090c774082b&lt;/p&gt;

&lt;p&gt;master:&#160;244718553742c086eefc95f927d7b26af597d40a&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 43 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0agt4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>