<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:48:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18440] ROW_NUMBER function: ROW/RANGE not allowed with RANK, DENSE_RANK or ROW_NUMBER functions</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18440</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When I run flink sql ,the flink sql like this:&lt;/p&gt;

&lt;p&gt;create view test as select  name, eat ,sum(age) as cnt from test_source group by  name,eat;&lt;/p&gt;

&lt;p&gt;create view resultsssss as select *, ROW_NUMBER() OVER (PARTITION BY name ORDER BY cnt DESC) as row_num from test;&lt;/p&gt;

&lt;p&gt;create table sink (&lt;br/&gt;
name varchar,&lt;br/&gt;
eat varchar,&lt;br/&gt;
cnt bigint&lt;br/&gt;
)&lt;br/&gt;
with(&lt;br/&gt;
&apos;connector&apos; = &apos;print&apos;&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;insert into sink select name,eat , cnt from resultsssss where  row_num &amp;lt;= 3 ;&lt;/p&gt;



&lt;p&gt;The same sql code I could run success in flink 1.10, now I change the flink version into flink 1.11, it throw the exception.&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;main&quot; org.apache.flink.table.api.ValidationException: SQL validation failed. From line 1, column 124 to line 1, column 127: ROW/RANGE not allowed with RANK, DENSE_RANK or ROW_NUMBER functions&lt;br/&gt;
	at org.apache.flink.table.planner.calcite.FlinkPlannerImpl.org$apache$flink$table$planner$calcite$FlinkPlannerImpl$$validate(FlinkPlannerImpl.scala:146)&lt;br/&gt;
	at org.apache.flink.table.planner.calcite.FlinkPlannerImpl$ToRelContextImpl.expandView(FlinkPlannerImpl.scala:204)&lt;br/&gt;
	at org.apache.calcite.plan.ViewExpanders$1.expandView(ViewExpanders.java:52)&lt;br/&gt;
	at org.apache.flink.table.planner.catalog.SqlCatalogViewTable.convertToRel(SqlCatalogViewTable.java:58)&lt;br/&gt;
	at org.apache.flink.table.planner.plan.schema.ExpandingPreparingTable.expand(ExpandingPreparingTable.java:59)&lt;br/&gt;
	at org.apache.flink.table.planner.plan.schema.ExpandingPreparingTable.toRel(ExpandingPreparingTable.java:55)&lt;br/&gt;
	at org.apache.calcite.sql2rel.SqlToRelConverter.toRel(SqlToRelConverter.java:3492)&lt;br/&gt;
	at org.apache.calcite.sql2rel.SqlToRelConverter.convertIdentifier(SqlToRelConverter.java:2415)&lt;br/&gt;
	at org.apache.calcite.sql2rel.SqlToRelConverter.convertFrom(SqlToRelConverter.java:2102)&lt;br/&gt;
	at org.apache.calcite.sql2rel.SqlToRelConverter.convertFrom(SqlToRelConverter.java:2051)&lt;br/&gt;
	at org.apache.calcite.sql2rel.SqlToRelConverter.convertSelectImpl(SqlToRelConverter.java:661)&lt;br/&gt;
	at org.apache.calcite.sql2rel.SqlToRelConverter.convertSelect(SqlToRelConverter.java:642)&lt;br/&gt;
	at org.apache.calcite.sql2rel.SqlToRelConverter.convertQueryRecursive(SqlToRelConverter.java:3345)&lt;br/&gt;
	at org.apache.calcite.sql2rel.SqlToRelConverter.convertQuery(SqlToRelConverter.java:568)&lt;br/&gt;
	at org.apache.flink.table.planner.calcite.FlinkPlannerImpl.org$apache$flink$table$planner$calcite$FlinkPlannerImpl$$rel(FlinkPlannerImpl.scala:164)&lt;br/&gt;
	at org.apache.flink.table.planner.calcite.FlinkPlannerImpl.rel(FlinkPlannerImpl.scala:151)&lt;br/&gt;
	at org.apache.flink.table.planner.operations.SqlToOperationConverter.toQueryOperation(SqlToOperationConverter.java:773)&lt;br/&gt;
	at org.apache.flink.table.planner.operations.SqlToOperationConverter.convertSqlQuery(SqlToOperationConverter.java:745)&lt;br/&gt;
	at org.apache.flink.table.planner.operations.SqlToOperationConverter.convert(SqlToOperationConverter.java:238)&lt;br/&gt;
	at org.apache.flink.table.planner.operations.SqlToOperationConverter.convertSqlInsert(SqlToOperationConverter.java:527)&lt;/p&gt;

</description>
                <environment></environment>
        <key id="13313814">FLINK-18440</key>
            <summary>ROW_NUMBER function: ROW/RANGE not allowed with RANK, DENSE_RANK or ROW_NUMBER functions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="danny0405">Danny Chen</assignee>
                                    <reporter username="shenlang">LakeShen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 28 Jun 2020 04:03:26 +0000</created>
                <updated>Tue, 14 Jul 2020 02:14:29 +0000</updated>
                            <resolved>Tue, 14 Jul 2020 02:14:29 +0000</resolved>
                                    <version>1.11.0</version>
                                    <fixVersion>1.11.1</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due>Thu, 30 Jul 2020 00:00:00 +0000</due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17147217" author="lsy" created="Sun, 28 Jun 2020 05:32:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shenlang&quot; class=&quot;user-hover&quot; rel=&quot;shenlang&quot;&gt;shenlang&lt;/a&gt;&#65292;I also encountered this problem when create view use row_number function, I have study calcite source code, it &apos;SqlWindow#validate&apos; method throw this error, so I guess calcite don&apos;t support create view use row_ number over partition by order by&#160; desc grammar, because there&apos;s no explicit lower bound and upper bound. if you use following sql:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create view order_source as select sum(amount) over (partition by order_id, order_goods_id order by proctime ROWS BETWEEN unbounded PRECEDING AND CURRENT ROW) from dm_trd_order_goods
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;it will not throw exception, I think this is calcite&apos;s problem.&lt;/p&gt;

&lt;p&gt;CC&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;, what do you think about it?&lt;/p&gt;</comment>
                            <comment id="17147219" author="shenlang" created="Sun, 28 Jun 2020 05:41:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lsy&quot; class=&quot;user-hover&quot; rel=&quot;lsy&quot;&gt;lsy&lt;/a&gt;,&lt;br/&gt;
I find that in the end my sql would translate into like this :&lt;br/&gt;
SELECT `test`.`name`, `test`.`eat`, `test`.`cnt`, ROW_NUMBER() OVER (PARTITION BY `test`.`name` ORDER BY `test`.`cnt` DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `row_num`&lt;br/&gt;
FROM `default_catalog`.`default_database`.`test` AS `test`.&lt;/p&gt;

&lt;p&gt;And at the same time , I add the ROWS BETWEEN unbounded PRECEDING AND CURRENT ROW into my sql , It aslo throw the exception like this :&lt;br/&gt;
Caused by: org.apache.calcite.sql.validate.SqlValidatorException: ROW/RANGE not allowed with RANK, DENSE_RANK or ROW_NUMBER functions&lt;/p&gt;</comment>
                            <comment id="17147222" author="jark" created="Sun, 28 Jun 2020 06:01:58 +0000"  >&lt;p&gt;I reproduced this problem with adding the following test in &lt;tt&gt;org.apache.flink.table.planner.plan.stream.sql.TableScanTest&lt;/tt&gt;&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
 @Test
  &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; test(): Unit = {
    util.addTable(
      &quot;&quot;&quot;
        |CREATE TABLE test_source (
        |  name STRING,
        |  eat STRING,
        |  age BIGINT
        |) WITH (
        |  &apos;connector&apos; = &apos;values&apos;
        |)
      &quot;&quot;&quot;.stripMargin)
    util.tableEnv.executeSql(&lt;span class=&quot;code-quote&quot;&gt;&quot;create view test as select name, eat ,sum(age) as cnt from test_source group by name,eat&quot;&lt;/span&gt;)
    util.tableEnv.executeSql(&lt;span class=&quot;code-quote&quot;&gt;&quot;create view resultsssss as select *, ROW_NUMBER() OVER (PARTITION BY name ORDER BY cnt DESC) as row_num from test&quot;&lt;/span&gt;)
    util.addTable(
      s&quot;&quot;&quot;
         |create table sink (
         |name varchar,
         |eat varchar,
         |cnt bigint
         |)
         |&lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt;(
         |&apos;connector&apos; = &apos;print&apos;
         |)
         |&quot;&quot;&quot;.stripMargin
    )
    util.verifyPlanInsert(&lt;span class=&quot;code-quote&quot;&gt;&quot;insert into sink select name,eat , cnt from resultsssss where row_num &amp;lt;= 3&quot;&lt;/span&gt;)
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I guess this might be a problem related to Calcite. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt;, could you help to have a look at this?&lt;/p&gt;</comment>
                            <comment id="17147311" author="jinxintang" created="Sun, 28 Jun 2020 10:55:50 +0000"  >&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13006619/13006619_image-2020-06-28-18-55-43-692.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Hope this could help &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17150917" author="jinxintang" created="Fri, 3 Jul 2020 10:20:34 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&#160;Thank you for your test code and suggestion, I have just open a PR for this, could you please help me review &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17155333" author="danny0405" created="Fri, 10 Jul 2020 10:52:39 +0000"  >&lt;p&gt;After some code research, i found that the SqlWindow bounds state was mutated during sql-to-rel conversion in Calcite release-1.22, this has been fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CALCITE-3877&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CALCITE-3877&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;See this logic in SqlValidatorImpl#resolveWindow of 1.22 Calcite:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (populateBounds) {
      window.populateBounds();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The flag from SqlToRelConverter is always true.&lt;/p&gt;

&lt;p&gt;I can figure out 2 ways to fix this problem:&lt;br/&gt;
1. We can resolve this problem when upgrade to Calcite 1.23 or 1.24.&lt;br/&gt;
2. In SqlToOperationConverter#convertCreateView, keep the validated sql string before it is converted.&lt;/p&gt;

&lt;p&gt;I would fire a fix for 2 soon ~&lt;/p&gt;</comment>
                            <comment id="17155338" author="danny0405" created="Fri, 10 Jul 2020 11:07:28 +0000"  >&lt;p&gt;I have fired a fix in &lt;a href=&quot;https://github.com/apache/flink/pull/12868&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/12868&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17157076" author="jark" created="Tue, 14 Jul 2020 02:14:29 +0000"  >&lt;p&gt;Fixed in &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;master (1.12.0): 9723cb2090cff1c68e878282600fcd06c4f34125&lt;/li&gt;
	&lt;li&gt;1.11.1: 677021cc1ca872dd81fed8cd5e5aea834a3b5236&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="13006619" name="image-2020-06-28-18-55-43-692.png" size="90740" author="JinxinTang" created="Sun, 28 Jun 2020 10:55:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0g980:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>