<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:21:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2800] kryo serialization problem</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2800</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Performing a cross of two dataset of POJOs I have got the exception below. The first time I run the process, there was no problem. When I run it the second time, I have got the exception. My guess is that it could be a race condition related to the reuse of the Kryo serializer object. However, it could also be &quot;a bug where type registrations are not properly forwarded to all Serializers&quot;, as suggested by Stephan.&lt;/p&gt;

&lt;p&gt;------------------------------------------------------------------------&lt;br/&gt;
2015-10-01 18:18:21 INFO  JobClient:161 - 10/01/2015 18:18:21	Cross(Cross at main(FlinkMongoHadoop2LinkPOI2CDA.java:160))(3/4) switched to FAILED &lt;br/&gt;
com.esotericsoftware.kryo.KryoException: Encountered unregistered class ID: 114&lt;br/&gt;
	at com.esotericsoftware.kryo.util.DefaultClassResolver.readClass(DefaultClassResolver.java:119)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.readClass(Kryo.java:641)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.readClassAndObject(Kryo.java:752)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.kryo.KryoSerializer.deserialize(KryoSerializer.java:210)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.deserialize(TupleSerializer.java:127)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.deserialize(TupleSerializer.java:30)&lt;br/&gt;
	at org.apache.flink.runtime.operators.resettable.AbstractBlockResettableIterator.getNextRecord(AbstractBlockResettableIterator.java:180)&lt;br/&gt;
	at org.apache.flink.runtime.operators.resettable.BlockResettableMutableObjectIterator.next(BlockResettableMutableObjectIterator.java:111)&lt;br/&gt;
	at org.apache.flink.runtime.operators.CrossDriver.runBlockedOuterSecond(CrossDriver.java:309)&lt;br/&gt;
	at org.apache.flink.runtime.operators.CrossDriver.run(CrossDriver.java:162)&lt;br/&gt;
	at org.apache.flink.runtime.operators.RegularPactTask.run(RegularPactTask.java:489)&lt;br/&gt;
	at org.apache.flink.runtime.operators.RegularPactTask.invoke(RegularPactTask.java:354)&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:581)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;</description>
                <environment>&lt;p&gt;linux ubuntu 12.04 LTS, Java 7&lt;/p&gt;</environment>
        <key id="12902064">FLINK-2800</key>
            <summary>kryo serialization problem</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="stefano.bortoli">Stefano Bortoli</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Oct 2015 07:45:39 +0000</created>
                <updated>Thu, 29 Oct 2015 13:04:54 +0000</updated>
                            <resolved>Thu, 29 Oct 2015 13:04:53 +0000</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>0.9.2</fixVersion>
                    <fixVersion>0.10.0</fixVersion>
                    <fixVersion>1.0.0</fixVersion>
                                    <component>API / Type Serialization System</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14940984" author="stefano.bortoli" created="Fri, 2 Oct 2015 10:06:04 +0000"  >&lt;p&gt;I don&apos;t know whether it is the same issue, but after switching from my POJOs to BSONObject I have got a race condition with kryo serialization:&lt;/p&gt;

&lt;p&gt;2015-10-02 11:55:26 INFO  JobClient:161 - 10/02/2015 11:55:26    Cross(Cross at main(FlinkMongoHadoop2LinkPOI2CDA.java:138))(4/4) switched to FAILED&lt;br/&gt;
java.lang.IndexOutOfBoundsException: Index: 112, Size: 0&lt;br/&gt;
    at java.util.ArrayList.rangeCheck(ArrayList.java:635)&lt;br/&gt;
    at java.util.ArrayList.get(ArrayList.java:411)&lt;br/&gt;
    at com.esotericsoftware.kryo.util.MapReferenceResolver.getReadObject(MapReferenceResolver.java:42)&lt;br/&gt;
    at com.esotericsoftware.kryo.Kryo.readReferenceOrNull(Kryo.java:805)&lt;br/&gt;
    at com.esotericsoftware.kryo.Kryo.readClassAndObject(Kryo.java:759)&lt;br/&gt;
    at org.apache.flink.api.java.typeutils.runtime.kryo.KryoSerializer.deserialize(KryoSerializer.java:210)&lt;br/&gt;
    at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.deserialize(TupleSerializer.java:127)&lt;br/&gt;
    at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.deserialize(TupleSerializer.java:30)&lt;br/&gt;
    at org.apache.flink.runtime.operators.resettable.AbstractBlockResettableIterator.getNextRecord(AbstractBlockResettableIterator.java:180)&lt;br/&gt;
    at org.apache.flink.runtime.operators.resettable.BlockResettableMutableObjectIterator.next(BlockResettableMutableObjectIterator.java:111)&lt;br/&gt;
    at org.apache.flink.runtime.operators.CrossDriver.runBlockedOuterSecond(CrossDriver.java:309)&lt;br/&gt;
    at org.apache.flink.runtime.operators.CrossDriver.run(CrossDriver.java:162)&lt;br/&gt;
    at org.apache.flink.runtime.operators.RegularPactTask.run(RegularPactTask.java:489)&lt;br/&gt;
    at org.apache.flink.runtime.operators.RegularPactTask.invoke(RegularPactTask.java:354)&lt;br/&gt;
    at org.apache.flink.runtime.taskmanager.Task.run(Task.java:581)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;</comment>
                            <comment id="14944631" author="till.rohrmann" created="Tue, 6 Oct 2015 07:38:38 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefano.bortoli&quot; class=&quot;user-hover&quot; rel=&quot;stefano.bortoli&quot;&gt;stefano.bortoli&lt;/a&gt;, do you have small code example to reproduce the problem? Or does it happen with any cross operation?&lt;/p&gt;</comment>
                            <comment id="14944646" author="stefano.bortoli" created="Tue, 6 Oct 2015 07:55:10 +0000"  >&lt;p&gt;I had the problem using both my POJO and BSONObject in the Tuple2 crossing data read from mongodb. However, the code is quite simple.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;InputFormat&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, BSONObject&amp;gt; mapreduceInputFormat = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyMongoInputFormat&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, BSONObject&amp;gt;();
		HadoopInputFormat&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, BSONObject&amp;gt; hdIf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HadoopInputFormat&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, BSONObject&amp;gt;(
				mapreduceInputFormat, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.class, BSONObject.class, job);

&lt;span class=&quot;code-comment&quot;&gt;// specify connection parameters
&lt;/span&gt;hdIf.getConfiguration().set(MongoUtil.MONGO_INPUT_URI_PROPERTY,collectionsUri);

DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, BSONObject&amp;gt;&amp;gt; input = env.createInput(hdIf);
DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, BSONObject&amp;gt;&amp;gt; pois = input.flatMap(	&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GetEntitonForClass(CulturalSitePointOfInterest.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getSimpleName()));
DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, BSONObject&amp;gt;&amp;gt; cdas = input.flatMap(GetEntitonForClass(CulturalDigitalArtefact.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getSimpleName()));

DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; out = pois.cross(cdas)
				.combineGroup(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; POI2CDACombineGroupFunction()).distinct().setParallelism(parallelism);

DataSet&amp;lt;Tuple3&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, BSONObject&amp;gt;&amp;gt; union = out.join(pois).where(0).equalTo(0).projectFirst(0, 1).projectSecond(1);

DataSet&amp;lt;Tuple2&amp;lt;BSONWritable, MongoUpdateWritable&amp;gt;&amp;gt; writable = union.groupBy(0)	.reduceGroup(
						&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AddProxy2POIReduceGroupFunction()).setParallelism(parallelism);

MongoConfigUtil.setOutputURI(job.getConfiguration(), collectionsUri);
&lt;span class=&quot;code-comment&quot;&gt;// emit result (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; works only locally)
&lt;/span&gt;writable.output(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MongoHadoop2OutputFormat&amp;lt;BSONWritable, MongoUpdateWritable&amp;gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MongoOutputFormat&amp;lt;BSONWritable, MongoUpdateWritable&amp;gt;(),
				job));
&lt;span class=&quot;code-comment&quot;&gt;// execute program
&lt;/span&gt;env.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;Mongodb POI to CDA linker&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14944659" author="till.rohrmann" created="Tue, 6 Oct 2015 08:04:06 +0000"  >&lt;p&gt;If I&apos;m not mistaken, then this code example is not complete. Would be great if you could fill in the gaps like &lt;tt&gt;POI2CDACombineGroupFunction&lt;/tt&gt;, &lt;tt&gt;AddProxy2POIReduceGroupFunction&lt;/tt&gt; and &lt;tt&gt;GetEntitonForClass&lt;/tt&gt; or if you could distill the whole example down to something like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, BSONObject&amp;gt;&amp;gt; input1 = env.createFromElements(....)
DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, BSONObject&amp;gt;&amp;gt; input2 = env.createFromElements(....)

input1.cross(input2).print()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;if this reproduces the problem for you. Thanks for your help.&lt;/p&gt;</comment>
                            <comment id="14944959" author="stefano.bortoli" created="Tue, 6 Oct 2015 12:38:36 +0000"  >&lt;p&gt;I don&apos;t think the functions are relevant. The &quot;GetEntitonForClass&quot; implements a filter as a flatmap. The combineGroup &quot;POI2CDACombineGroupFunction&quot; takes the results of the cross and applies a join logic to the tuples. &quot;AddProxy2POIReduceGroupFunction&quot; takes the POJO, and appends the results of the join to the target element. The error happens in the serialization of the POJO along the cross operation. The process ends without any problem if I use byte[] in place of BSONObject and I deserialize the object with a new Kryo() instance inside the combineGroup function. &lt;/p&gt;</comment>
                            <comment id="14944985" author="till.rohrmann" created="Tue, 6 Oct 2015 12:54:26 +0000"  >&lt;p&gt;I agree with you. But it speeds issue tracking tremendously up, if you have a small example which you can copy-paste to start debugging and for which you know that it produced the error on the reporter&apos;s machine.&lt;/p&gt;</comment>
                            <comment id="14944991" author="fhueske" created="Tue, 6 Oct 2015 12:59:24 +0000"  >&lt;p&gt;I tried to reproduce the issue by crossing two small data sets with generic types (serialized using Kryo) but that worked without problems.&lt;br/&gt;
Do you register any Kryo types in the ExecutionConfig?&lt;/p&gt;</comment>
                            <comment id="14945008" author="stefano.bortoli" created="Tue, 6 Oct 2015 13:17:36 +0000"  >&lt;p&gt;I have added a couple of them, but it did not change anything. So, I removed them. I think it is a race condition, which is in general hard to reproduce. We had a similar problem when increasing load on a server using non-blocking calls. Kryo is not thread-safe, and we solved using a pool. The Kryo serializer of flink uses the twitter library, but in the end what is used is simply the constructor, without the pool. Perhaps using the pool would solve these problems.&lt;/p&gt;</comment>
                            <comment id="14945067" author="fhueske" created="Tue, 6 Oct 2015 14:05:53 +0000"  >&lt;p&gt;Each &lt;tt&gt;KryoSerializer&lt;/tt&gt; has its own &lt;tt&gt;Kryo&lt;/tt&gt; instance, so &lt;tt&gt;Kryo&lt;/tt&gt; instances are not shared unless the &lt;tt&gt;KryoSerializer&lt;/tt&gt; is shared. &lt;br/&gt;
Serializers are deeply copied before sharing them. I had a look into &lt;tt&gt;CrossDriver.runBlockedOuterSecond()&lt;/tt&gt; and didn&apos;t spot any problem with sharing of serializers.&lt;/p&gt;

&lt;p&gt;If I understood you correctly, the issue does also occur when you do not register any types with Kryo, right?&lt;/p&gt;</comment>
                            <comment id="14945078" author="stefano.bortoli" created="Tue, 6 Oct 2015 14:10:09 +0000"  >&lt;p&gt;Nope, it comes when I use the BSONObject or directly my POJO and not the byte[] as part of the crossed tuples. If I pass through the byte[] then I deserialize the object in the method, and everything works. Trying to implement what Till suggested, but the cross exceeds the java heap memory, and I keep on having exceptions. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
	at java.util.Arrays.copyOf(Arrays.java:2271)&lt;br/&gt;
	at java.io.ByteArrayOutputStream.grow(ByteArrayOutputStream.java:118)&lt;br/&gt;
	at java.io.ByteArrayOutputStream.ensureCapacity(ByteArrayOutputStream.java:93)&lt;br/&gt;
	at java.io.ByteArrayOutputStream.write(ByteArrayOutputStream.java:153)&lt;br/&gt;
	at java.io.DataOutputStream.write(DataOutputStream.java:107)&lt;br/&gt;
	at org.apache.flink.core.memory.OutputViewDataOutputStreamWrapper.write(OutputViewDataOutputStreamWrapper.java:70)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.DataOutputViewStream.write(DataOutputViewStream.java:39)&lt;br/&gt;
	at com.esotericsoftware.kryo.io.Output.flush(Output.java:163)&lt;br/&gt;
	at com.esotericsoftware.kryo.io.Output.require(Output.java:142)&lt;br/&gt;
	at com.esotericsoftware.kryo.io.Output.writeBytes(Output.java:228)&lt;br/&gt;
	at com.esotericsoftware.kryo.io.Output.writeBytes(Output.java:214)&lt;br/&gt;
	at com.esotericsoftware.kryo.serializers.DefaultArraySerializers$ByteArraySerializer.write(DefaultArraySerializers.java:36)&lt;br/&gt;
	at com.esotericsoftware.kryo.serializers.DefaultArraySerializers$ByteArraySerializer.write(DefaultArraySerializers.java:25)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.writeClassAndObject(Kryo.java:599)&lt;br/&gt;
	at com.esotericsoftware.kryo.serializers.MapSerializer.write(MapSerializer.java:95)&lt;br/&gt;
	at com.esotericsoftware.kryo.serializers.MapSerializer.write(MapSerializer.java:21)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.writeClassAndObject(Kryo.java:599)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.kryo.KryoSerializer.serialize(KryoSerializer.java:186)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.serialize(TupleSerializer.java:116)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.serialize(TupleSerializer.java:30)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.serialize(TupleSerializer.java:116)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.serialize(TupleSerializer.java:30)&lt;br/&gt;
	at org.apache.flink.api.common.accumulators.SerializedListAccumulator.add(SerializedListAccumulator.java:59)&lt;br/&gt;
	at org.apache.flink.api.java.Utils$CollectHelper.flatMap(Utils.java:127)&lt;br/&gt;
	at org.apache.flink.runtime.operators.chaining.ChainedFlatMapDriver.collect(ChainedFlatMapDriver.java:79)&lt;br/&gt;
	at org.apache.flink.runtime.operators.CrossDriver.runBlockedOuterFirst(CrossDriver.java:247)&lt;br/&gt;
	at org.apache.flink.runtime.operators.CrossDriver.run(CrossDriver.java:160)&lt;br/&gt;
	at org.apache.flink.runtime.operators.RegularPactTask.run(RegularPactTask.java:489)&lt;br/&gt;
	at org.apache.flink.runtime.operators.RegularPactTask.invoke(RegularPactTask.java:354)&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:579)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14945094" author="stefano.bortoli" created="Tue, 6 Oct 2015 14:22:14 +0000"  >&lt;p&gt;Within the combine function I use anyway a Kryo serializer as part of the BSON object is a byte[] containing a serialized object. Do you think it can cause a problem?&lt;/p&gt;</comment>
                            <comment id="14945146" author="stefano.bortoli" created="Tue, 6 Oct 2015 15:01:51 +0000"  >&lt;p&gt;Ok, I have some hints. Executing the cross alone did not create any problem, but adding the following join cause the race condition. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, BSONObject&amp;gt;&amp;gt; input1 = env.createFromElements(....)
DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, BSONObject&amp;gt;&amp;gt; input2 = env.createFromElements(....)
DataSet&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; out = input1.cross(input2).combineGroup(....);
DataSet&amp;lt;Tuple3&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, BSONObject&amp;gt;&amp;gt; union = out.join(input1).where(0).equalTo(0).projectFirst(0, 1).projectSecond(1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;is causing the race condition with the Kryo serialize, as shown by the exception below. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;2015-10-06 16:54:34 ERROR RegularPactTask:1179 - Error in task code:  Cross(Cross at main(FlinkMongoHadoop2Cross.java:147)) (1/4)&lt;br/&gt;
java.lang.IndexOutOfBoundsException: Index: 98, Size: 73&lt;br/&gt;
	at java.util.ArrayList.rangeCheck(ArrayList.java:635)&lt;br/&gt;
	at java.util.ArrayList.get(ArrayList.java:411)&lt;br/&gt;
	at com.esotericsoftware.kryo.util.MapReferenceResolver.getReadObject(MapReferenceResolver.java:42)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.readReferenceOrNull(Kryo.java:805)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.readClassAndObject(Kryo.java:759)&lt;br/&gt;
	at com.esotericsoftware.kryo.serializers.MapSerializer.read(MapSerializer.java:135)&lt;br/&gt;
	at com.esotericsoftware.kryo.serializers.MapSerializer.read(MapSerializer.java:21)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.readClassAndObject(Kryo.java:761)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.kryo.KryoSerializer.deserialize(KryoSerializer.java:211)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.deserialize(TupleSerializer.java:127)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.deserialize(TupleSerializer.java:30)&lt;br/&gt;
	at org.apache.flink.runtime.operators.resettable.AbstractBlockResettableIterator.getNextRecord(AbstractBlockResettableIterator.java:180)&lt;br/&gt;
	at org.apache.flink.runtime.operators.resettable.BlockResettableMutableObjectIterator.next(BlockResettableMutableObjectIterator.java:111)&lt;br/&gt;
	at org.apache.flink.runtime.operators.CrossDriver.runBlockedOuterSecond(CrossDriver.java:309)&lt;br/&gt;
	at org.apache.flink.runtime.operators.CrossDriver.run(CrossDriver.java:162)&lt;br/&gt;
	at org.apache.flink.runtime.operators.RegularPactTask.run(RegularPactTask.java:489)&lt;br/&gt;
	at org.apache.flink.runtime.operators.RegularPactTask.invoke(RegularPactTask.java:354)&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:579)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14958995" author="stefano.bortoli" created="Thu, 15 Oct 2015 14:38:44 +0000"  >&lt;p&gt;Hi guys. I have played around the KryoSerialization class. I have upgraded to Kryo 3.0.2 which offers a very convenient KryoPool with customizable KryoFactory, and then I moved in the method the instantiation of all the fields that were shared by serialization and deserialization method. I have also registered the classes (sometimes Kryo does not serialize the classes in the same order if you don&apos;t register them, and can cause problems). I still have to evaluate whether all of these changes are necessary, but with the kryoPool, registering the classes, and moving the Input and Output fields in the methods solved the exceptions above. I will keep on investigating.&lt;/p&gt;

&lt;p&gt;Anyway, this shows that it was actually a race condition, perhaps because the KryoSerializer that is not cloned as expected along the execution chain.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;EDIT&amp;#93;&lt;/span&gt; I have also set the default instantiator strategy to support serialization of objects that do not have constructor with no arguments&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Kryo kryo = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ScalaKryoInstantiator().newKryo();
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; DefaultInstantiatorStrategy instantiatorStrategy = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultInstantiatorStrategy();
instantiatorStrategy.setFallbackInstantiatorStrategy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StdInstantiatorStrategy());
kryo.setInstantiatorStrategy(instantiatorStrategy);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14959143" author="stefano.bortoli" created="Thu, 15 Oct 2015 16:13:51 +0000"  >&lt;p&gt;Ok, I have run a couple of tests more, and the process was completed without the KryoPool. However, when I reverted back to the global variable for Input and Output, I could reproduce the error. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;10/15/2015 18:05:59	Job execution switched to status FAILED.&lt;br/&gt;
2015-10-15 18:05:59 INFO  JobManager:137 - Status of job 1b05e39a7ea019d0a57702eb2a06d64a (Flink Java Job at Thu Oct 15 18:03:33 CEST 2015) changed to FAILED.&lt;br/&gt;
com.esotericsoftware.kryo.KryoException: Encountered unregistered class ID: 115&lt;br/&gt;
	at com.esotericsoftware.kryo.util.DefaultClassResolver.readClass(DefaultClassResolver.java:137)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.readClass(Kryo.java:667)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.readClassAndObject(Kryo.java:778)&lt;br/&gt;
	at com.esotericsoftware.kryo.serializers.MapSerializer.read(MapSerializer.java:153)&lt;br/&gt;
	at com.esotericsoftware.kryo.serializers.MapSerializer.read(MapSerializer.java:39)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.readClassAndObject(Kryo.java:787)&lt;br/&gt;
	at com.esotericsoftware.kryo.serializers.MapSerializer.read(MapSerializer.java:161)&lt;br/&gt;
	at com.esotericsoftware.kryo.serializers.MapSerializer.read(MapSerializer.java:39)&lt;br/&gt;
	at com.esotericsoftware.kryo.Kryo.readClassAndObject(Kryo.java:787)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.kryo.KryoSerializer.deserialize(KryoSerializer.java:251)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.deserialize(TupleSerializer.java:127)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.deserialize(TupleSerializer.java:1)&lt;br/&gt;
	at org.apache.flink.runtime.operators.resettable.AbstractBlockResettableIterator.getNextRecord(AbstractBlockResettableIterator.java:180)&lt;br/&gt;
	at org.apache.flink.runtime.operators.resettable.BlockResettableMutableObjectIterator.next(BlockResettableMutableObjectIterator.java:111)&lt;br/&gt;
	at org.apache.flink.runtime.operators.CrossDriver.runBlockedOuterSecond(CrossDriver.java:309)&lt;br/&gt;
	at org.apache.flink.runtime.operators.CrossDriver.run(CrossDriver.java:162)&lt;br/&gt;
	at org.apache.flink.runtime.operators.BatchTask.run(BatchTask.java:489)&lt;br/&gt;
	at org.apache.flink.runtime.operators.BatchTask.invoke(BatchTask.java:354)&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:584)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
2015-10-15 18:05:59 INFO  JobClient:200 - Job execution failed&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This version of the method does not work:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unchecked&quot;&lt;/span&gt;)
	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T deserialize(DataInputView source) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (source != previousIn) {
			previousIn = source;
			DataInputViewStream inputStream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataInputViewStream(source);
			input = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoFetchingInput(inputStream);
		}
&lt;span class=&quot;code-comment&quot;&gt;//		DataInputViewStream inputStream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataInputViewStream(source);
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//		Input input = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoFetchingInput(inputStream);
&lt;/span&gt;		checkKryoPoolInitialization();
&lt;span class=&quot;code-comment&quot;&gt;//		Kryo kryo = kryoPool.borrow();
&lt;/span&gt;		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (T) kryo.readClassAndObject(input);
		} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KryoException ke) {
			Throwable cause = ke.getCause();

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; EOFException) {
				&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; (EOFException) cause;
			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
				&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; ke;
			}
		} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;//			kryoPool.release(kryo);
&lt;/span&gt;		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;whereas this one worked:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unchecked&quot;&lt;/span&gt;)
	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T deserialize(DataInputView source) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (source != previousIn) {
			previousIn = source;
&lt;span class=&quot;code-comment&quot;&gt;//			DataInputViewStream inputStream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataInputViewStream(source);
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//			input = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoFetchingInput(inputStream);
&lt;/span&gt;		}
		DataInputViewStream inputStream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataInputViewStream(source);
		Input input = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoFetchingInput(inputStream);
		checkKryoPoolInitialization();
&lt;span class=&quot;code-comment&quot;&gt;//		Kryo kryo = kryoPool.borrow();
&lt;/span&gt;		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (T) kryo.readClassAndObject(input);
		} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KryoException ke) {
			Throwable cause = ke.getCause();

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; EOFException) {
				&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; (EOFException) cause;
			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
				&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; ke;
			}
		} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;//			kryoPool.release(kryo);
&lt;/span&gt;		}
	}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;I hope this helps either solving the problem, or finding the cause of the problem. &lt;/p&gt;</comment>
                            <comment id="14978888" author="githubbot" created="Wed, 28 Oct 2015 17:53:43 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1308&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1308&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2800&quot; title=&quot;kryo serialization problem&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2800&quot;&gt;&lt;del&gt;FLINK-2800&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kryo&amp;#93;&lt;/span&gt; Fix Kryo serialization to clear buffered data&lt;/p&gt;

&lt;p&gt;    The Kryo serializer uses Kryo&apos;s Output class to buffer individual write operations before&lt;br/&gt;
    it is written to the underlying output stream. This Output class is flushed by Flink&apos;s&lt;br/&gt;
    KryoSerializer upon finishing its serialize call. However, in case of an exception when&lt;br/&gt;
    flushing the Output, the buffered data is kept in the buffer. Since Flink uses EOFExceptions&lt;br/&gt;
    to mark that an underlying buffer is full and has to be spilled, for example, it can happen&lt;br/&gt;
    that the record triggering the spilling is written twice after it is rewritten. The reason&lt;br/&gt;
    is that Kryo&apos;s Output buffer still contains the serialization data of the failed attempt which&lt;br/&gt;
    is also flushed to the emptied output stream.&lt;/p&gt;

&lt;p&gt;    This duplication of records can lead to corrupted data which eventually let&apos;s the Flink program&lt;br/&gt;
    crash. The problem is solved by clearing Kryo&apos;s Output when the flush operation was not successful.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; fixKryoSerialization&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1308.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1308.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1308&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 5618cf7ff65c972dc33c77ba953966224e8c2a1e&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-10-28T17:40:41Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2800&quot; title=&quot;kryo serialization problem&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2800&quot;&gt;&lt;del&gt;FLINK-2800&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kryo&amp;#93;&lt;/span&gt; Fix Kryo serialization to clear buffered data&lt;/p&gt;

&lt;p&gt;    The Kryo serializer uses Kryo&apos;s Output class to buffer individual write operations before&lt;br/&gt;
    it is written to the underlying output stream. This Output class is flushed by Flink&apos;s&lt;br/&gt;
    KryoSerializer upon finishing its serialize call. However, in case of an exception when&lt;br/&gt;
    flushing the Output, the buffered data is kept in the buffer. Since Flink uses EOFExceptions&lt;br/&gt;
    to mark that an underlying buffer is full and has to be spilled, for example, it can happen&lt;br/&gt;
    that the record triggering the spilling is written twice after it is rewritten. The reason&lt;br/&gt;
    is that Kryo&apos;s Output buffer still contains the serialization data of the failed attempt which&lt;br/&gt;
    is also flushed to the emptied output stream.&lt;/p&gt;

&lt;p&gt;    This duplication of records can lead to corrupted data which eventually let&apos;s the Flink program&lt;br/&gt;
    crash. The problem is solved by clearing Kryo&apos;s Output when the flush operation was not successful.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14979183" author="githubbot" created="Wed, 28 Oct 2015 20:36:34 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1308#issuecomment-151983062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1308#issuecomment-151983062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Very important fix!&lt;br/&gt;
    +1 to merge&lt;/p&gt;</comment>
                            <comment id="14980091" author="githubbot" created="Thu, 29 Oct 2015 09:13:17 +0000"  >&lt;p&gt;Github user fhueske commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1308#issuecomment-152122533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1308#issuecomment-152122533&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I will merge this PR.&lt;/p&gt;</comment>
                            <comment id="14980331" author="githubbot" created="Thu, 29 Oct 2015 12:22:59 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1308&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1308&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14980386" author="fhueske" created="Thu, 29 Oct 2015 13:04:54 +0000"  >&lt;p&gt;Fixed in 0.9.2 with 19abef4568986eb15f53b0f81a9ddad1a70774c1&lt;br/&gt;
Fixed in 0.10 with 44b03f20a3cc96a447051e9ab0f2cf04f9829966&lt;br/&gt;
Fixed in 1.0 with b654e989b60c6607f5f5bf757130c86bd0facd8c&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mj3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>