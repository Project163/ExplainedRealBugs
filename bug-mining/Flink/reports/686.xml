<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:21:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2967] TM address detection might not always detect the right interface on slow networks / overloaded JMs</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2967</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I&apos;m talking to a user which is facing the following issue:&lt;br/&gt;
Some of the TaskManagers select the wrong IP address out of the available network interfaces.&lt;/p&gt;

&lt;p&gt;The first address we try to connect to is the one returned by &lt;tt&gt;InetAddress.getLocalHost()&lt;/tt&gt;. This address is the right IP address to use, but the JobManager is not able to respond within the timeout (50ms) to that connection request.&lt;br/&gt;
So the TM tries the next address, which is not publicly reachable. However, the TM can connect to the JM from there. Netty will later fail to connect to the TM from the other TMs.&lt;/p&gt;

&lt;p&gt;There are two solutions for this issue:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Allow users to configure a higher timeout for the first address detection strategy. In most cases, the address returned by &lt;tt&gt;InetAddress.getLocalHost()&lt;/tt&gt; is correct. By setting a high timeout, users with slow networks / overloaded JMs can make sure the TM picks this address&lt;/li&gt;
	&lt;li&gt;add an Akka message which we send from the TM to the JM, and the JM tries to connect to the TM. If that succeeds, we know that the TM is reachable from the outside.&lt;br/&gt;
The problem is that we have to start a separate actor system on the TaskManager first. We have to do this because might use a wrong ip address for the TM (so we might end up starting actor systems until we found an externally reachable ip)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m first going to implement the first approach. If that solution works well for my user, I&apos;ll contribute this to 0.10 / 1.0.&lt;br/&gt;
If not, I&apos;ll implement the second approach.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12910342">FLINK-2967</key>
            <summary>TM address detection might not always detect the right interface on slow networks / overloaded JMs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rmetzger">Robert Metzger</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Nov 2015 13:20:56 +0000</created>
                <updated>Tue, 17 Nov 2015 20:55:32 +0000</updated>
                            <resolved>Tue, 17 Nov 2015 15:16:15 +0000</resolved>
                                    <version>0.9</version>
                    <version>0.10.0</version>
                    <version>1.0.0</version>
                                    <fixVersion>0.10.1</fixVersion>
                    <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14991612" author="stephanewen" created="Thu, 5 Nov 2015 12:44:38 +0000"  >&lt;p&gt;Is the problem caused by the too short initial timeout (50 ms) or by the fact that initially, the JobManager actor system was not online yet and was not able to respond. Having more flags yet to set should be the last choice, IMHO.&lt;/p&gt;

&lt;p&gt;Would this help?&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Trying the &lt;tt&gt;InetAddress.getLocalHost()&lt;/tt&gt; for a longer timeout (2000 ms) initially, and only then falling back to the other trying the other addresses.&lt;/li&gt;
	&lt;li&gt;After the address has been found with the strategy that circles the network devices (we know then that the JM must be online and able to respond), try the &lt;tt&gt;InetAddress.getLocalHost()&lt;/tt&gt; for a last time.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14991668" author="mxm" created="Thu, 5 Nov 2015 13:42:14 +0000"  >&lt;p&gt;I think the issue is that a task manager runs on the same host as the job manager and uses its local address to connect with the job manager. The actor system is then bound to the local device and remote connections with other task managers fail.&lt;/p&gt;

&lt;p&gt;I like the idea of trying &lt;tt&gt;InetAddress.getLocalHost()&lt;/tt&gt; again after the fallback mechanism has completed. This also may instantiate two actor systems. I don&apos;t think that is a big deal during startup phase if we clean up afterwards.&lt;/p&gt;</comment>
                            <comment id="14991682" author="rmetzger" created="Thu, 5 Nov 2015 14:00:51 +0000"  >&lt;p&gt;The problem is caused by a too short initial timeout.&lt;br/&gt;
The TaskManager tried to connect to the JobManager 5 seconds after the JM started, so there was enough time (in the case the user reported). The YARN AM starts requesting containers after the actor system on the JM has been started, so we can assume the JM to run.&lt;/p&gt;

&lt;p&gt;I&apos;ve created a fix for the affected user with the timeout set to 5 seconds (because I know that InetAddress.getLocalHost() returns the right address). Once the user confirmed the fix, we can increase the timeout in our code.&lt;/p&gt;
</comment>
                            <comment id="14991699" author="mxm" created="Thu, 5 Nov 2015 14:10:52 +0000"  >&lt;p&gt;Yes, increasing the timeout will solve most of the situations. Still, trying the other interfaces and then trying &lt;tt&gt;InetAddress.getLocalHost()&lt;/tt&gt; again will also solve the situations where the timeout is too short.&lt;/p&gt;</comment>
                            <comment id="15007263" author="githubbot" created="Mon, 16 Nov 2015 20:30:20 +0000"  >&lt;p&gt;GitHub user rmetzger opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1361&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1361&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2967&quot; title=&quot;TM address detection might not always detect the right interface on slow networks / overloaded JMs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2967&quot;&gt;&lt;del&gt;FLINK-2967&lt;/del&gt;&lt;/a&gt; Enhance TaskManager network detection&lt;/p&gt;

&lt;p&gt;    JIRA: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2967&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-2967&lt;/a&gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Increase timeout for `LOCAL_HOST` address detection strategy&lt;/li&gt;
	&lt;li&gt;give the local host address a higher priority&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rmetzger/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rmetzger/flink&lt;/a&gt; flink2967-2&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1361.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1361.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1361&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 859a19fdf7c6360765cba8706d356f0d00959128&lt;br/&gt;
Author: Robert Metzger &amp;lt;rmetzger@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-11-16T20:26:57Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2967&quot; title=&quot;TM address detection might not always detect the right interface on slow networks / overloaded JMs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2967&quot;&gt;&lt;del&gt;FLINK-2967&lt;/del&gt;&lt;/a&gt; Increase timeout for LOCAL_HOST address detection strategy, give the local host address a higher priority&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15008344" author="githubbot" created="Tue, 17 Nov 2015 09:21:18 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1361#issuecomment-157316807&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1361#issuecomment-157316807&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 Like previously discussed this seems to be a good strategy.&lt;/p&gt;</comment>
                            <comment id="15008535" author="githubbot" created="Tue, 17 Nov 2015 11:50:11 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1361#issuecomment-157347414&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1361#issuecomment-157347414&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Trying this out...&lt;/p&gt;</comment>
                            <comment id="15008556" author="githubbot" created="Tue, 17 Nov 2015 12:09:28 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1361#discussion_r45052205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1361#discussion_r45052205&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/net/ConnectionUtils.java &amp;#8212;&lt;br/&gt;
    @@ -180,7 +180,41 @@ public static InetAddress findConnectingAddress(InetSocketAddress targetAddress,&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * This utility method tries to connect to the JobManager using the InetAddress returned by&lt;br/&gt;
    +	 * InetAddress.getLocalHost(). The purpose of the utility is to have a final try connecting to&lt;br/&gt;
    +	 * the target address using the LocalHost before using the address returned.&lt;br/&gt;
    +	 * We do a second try because the JM might have been unavailable during the first check.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param preliminaryResult The address detected by the heuristic&lt;br/&gt;
    +	 * @return either the preliminaryResult or the address returned by InetAddress.getLocalHost() (if&lt;br/&gt;
    +	 * 			we are able to connect to targetAddress from there)&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private static InetAddress tryLocalHostBeforeReturning(InetAddress preliminaryResult, SocketAddress targetAddress, boolean logging) throws IOException {&lt;br/&gt;
    +		InetAddress localhostName = InetAddress.getLocalHost();&lt;br/&gt;
    +		if(tryToConnect(localhostName, targetAddress, AddressDetectionState.LOCAL_HOST.getTimeout(), logging)) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think we can use a bit higher timeout here. 200ms is probably mostly enough, but why make it so short here? If it succeeds fast, it does not add delay, and it it does not succeed we went through the other interfaces already anyways and better spend another second to make sure we get it right.&lt;/p&gt;</comment>
                            <comment id="15008557" author="githubbot" created="Tue, 17 Nov 2015 12:09:46 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1361#discussion_r45052228&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1361#discussion_r45052228&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/net/ConnectionUtils.java &amp;#8212;&lt;br/&gt;
    @@ -180,7 +180,41 @@ public static InetAddress findConnectingAddress(InetSocketAddress targetAddress,&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * This utility method tries to connect to the JobManager using the InetAddress returned by&lt;br/&gt;
    +	 * InetAddress.getLocalHost(). The purpose of the utility is to have a final try connecting to&lt;br/&gt;
    +	 * the target address using the LocalHost before using the address returned.&lt;br/&gt;
    +	 * We do a second try because the JM might have been unavailable during the first check.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param preliminaryResult The address detected by the heuristic&lt;br/&gt;
    +	 * @return either the preliminaryResult or the address returned by InetAddress.getLocalHost() (if&lt;br/&gt;
    +	 * 			we are able to connect to targetAddress from there)&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private static InetAddress tryLocalHostBeforeReturning(InetAddress preliminaryResult, SocketAddress targetAddress, boolean logging) throws IOException {&lt;br/&gt;
    +		InetAddress localhostName = InetAddress.getLocalHost();&lt;br/&gt;
    +		if(tryToConnect(localhostName, targetAddress, AddressDetectionState.LOCAL_HOST.getTimeout(), logging)) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Also: code style, space&lt;/p&gt;</comment>
                            <comment id="15008691" author="githubbot" created="Tue, 17 Nov 2015 14:07:33 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1361#issuecomment-157378877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1361#issuecomment-157378877&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Will merge and address the comments...&lt;/p&gt;</comment>
                            <comment id="15008810" author="stephanewen" created="Tue, 17 Nov 2015 15:16:15 +0000"  >&lt;p&gt;Fixed in &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;0.10 via cda00accd76d56eaea2ef679d5c9b3c0465059ca&lt;/li&gt;
	&lt;li&gt;1.0 via a45212d2b18cc12e3c314ed43e8d19943693deed&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15009481" author="githubbot" created="Tue, 17 Nov 2015 20:55:32 +0000"  >&lt;p&gt;Github user rmetzger commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1361#issuecomment-157503990&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1361#issuecomment-157503990&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This has been merged, @StephanEwen probably forgot to close the PR, so I&apos;m closing it manually.&lt;/p&gt;</comment>
                            <comment id="15009482" author="githubbot" created="Tue, 17 Nov 2015 20:55:32 +0000"  >&lt;p&gt;Github user rmetzger closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1361&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1361&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nxtb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>