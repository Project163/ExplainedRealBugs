<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20648] Unable to restore job from savepoint when using Kubernetes based HA services</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20648</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When restoring job from savepoint, we always end up with following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: org.apache.flink.runtime.client.JobInitializationException: Could not instantiate JobManager.
	at org.apache.flink.runtime.dispatcher.Dispatcher.lambda$createJobManagerRunner$5(Dispatcher.java:463) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1764) ~[?:?]
	... 3 more
Caused by: java.util.concurrent.ExecutionException: org.apache.flink.runtime.concurrent.FutureUtils$RetryException: Stopped retrying the operation because the error is not retryable.
	at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395) ~[?:?]
	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:2063) ~[?:?]
	at org.apache.flink.kubernetes.highavailability.KubernetesStateHandleStore.addAndLock(KubernetesStateHandleStore.java:150) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore.addCheckpoint(DefaultCompletedCheckpointStore.java:211) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.restoreSavepoint(CheckpointCoordinator.java:1479) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.scheduler.SchedulerBase.tryRestoreExecutionGraphFromSavepoint(SchedulerBase.java:325) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.scheduler.SchedulerBase.createAndRestoreExecutionGraph(SchedulerBase.java:266) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.scheduler.SchedulerBase.&amp;lt;init&amp;gt;(SchedulerBase.java:238) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.scheduler.DefaultScheduler.&amp;lt;init&amp;gt;(DefaultScheduler.java:134) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.scheduler.DefaultSchedulerFactory.createInstance(DefaultSchedulerFactory.java:108) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.jobmaster.JobMaster.createScheduler(JobMaster.java:323) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.jobmaster.JobMaster.&amp;lt;init&amp;gt;(JobMaster.java:310) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.jobmaster.factories.DefaultJobMasterServiceFactory.createJobMasterService(DefaultJobMasterServiceFactory.java:96) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.jobmaster.factories.DefaultJobMasterServiceFactory.createJobMasterService(DefaultJobMasterServiceFactory.java:41) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.jobmaster.JobManagerRunnerImpl.&amp;lt;init&amp;gt;(JobManagerRunnerImpl.java:141) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.dispatcher.DefaultJobManagerRunnerFactory.createJobManagerRunner(DefaultJobManagerRunnerFactory.java:80) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at org.apache.flink.runtime.dispatcher.Dispatcher.lambda$createJobManagerRunner$5(Dispatcher.java:450) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1764) ~[?:?]
	... 3 more
Caused by: org.apache.flink.runtime.concurrent.FutureUtils$RetryException: Stopped retrying the operation because the error is not retryable.
	at org.apache.flink.runtime.concurrent.FutureUtils.lambda$retryOperation$1(FutureUtils.java:166) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]
	at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837) ~[?:?]
	at java.util.concurrent.CompletableFuture$Completion.run(CompletableFuture.java:478) ~[?:?]
	... 3 more
Caused by: java.util.concurrent.CompletionException: org.apache.flink.kubernetes.kubeclient.resources.KubernetesException: Cannot retry checkAndUpdateConfigMap with configMap pipelines-runner-fulltext-6e99e672-4af29f0768624632839835717898b08d-jobmanager-leader because it does not exist.
	at org.apache.flink.kubernetes.kubeclient.Fabric8FlinkKubeClient.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$6(Fabric8FlinkKubeClient.java:289) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at java.util.Optional.orElseThrow(Optional.java:401) ~[?:?]
	at org.apache.flink.kubernetes.kubeclient.Fabric8FlinkKubeClient.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$7(Fabric8FlinkKubeClient.java:289) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1764) ~[?:?]
	... 3 more
Caused by: org.apache.flink.kubernetes.kubeclient.resources.KubernetesException: Cannot retry checkAndUpdateConfigMap with configMap pipelines-runner-fulltext-6e99e672-4af29f0768624632839835717898b08d-jobmanager-leader because it does not exist.
	at org.apache.flink.kubernetes.kubeclient.Fabric8FlinkKubeClient.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$6(Fabric8FlinkKubeClient.java:289) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at java.util.Optional.orElseThrow(Optional.java:401) ~[?:?]
	at org.apache.flink.kubernetes.kubeclient.Fabric8FlinkKubeClient.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$7(Fabric8FlinkKubeClient.java:289) ~[flink-dist_2.11-1.12.0.jar:1.12.0]
	at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1764) ~[?:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Cause of the issue is following:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We construct `jobMasterServices` prior starting `leaderElectionService` (in `JobManagerRunnerImpl`)&lt;/li&gt;
	&lt;li&gt;During `jobMasterServices` initialization `tryRestoreExecutionGraphFromSavepoint` gets called. This calls `KubernetesStateHandleStore.addAndLock` interally.&lt;/li&gt;
	&lt;li&gt;`KubernetesStateHandleStore.addAndLock` expects configmap for JM leadership to be already present, which is wrong, because `leaderElectionService` which is responsible for its creation has not started yet&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Possible fixes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Start `leaderElectionService` before `jobMasterServices`&lt;/li&gt;
	&lt;li&gt;Fix `KubernetesStateHandleStore`, so it can handle the case, when leader hasn&apos;t been elected&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13346541">FLINK-20648</key>
            <summary>Unable to restore job from savepoint when using Kubernetes based HA services</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wangyang0918">Yang Wang</assignee>
                                    <reporter username="dmvk">David Mor&#225;vek</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 17 Dec 2020 09:33:26 +0000</created>
                <updated>Fri, 28 May 2021 06:57:35 +0000</updated>
                            <resolved>Fri, 25 Dec 2020 01:31:43 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.12.1</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                                    <component>Deployment / Kubernetes</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17250945" author="davidmoravek" created="Thu, 17 Dec 2020 09:37:09 +0000"  >&lt;p&gt;Possible solution is outlined here: &lt;a href=&quot;https://github.com/dmvk/flink/commit/ae8133016df76594af008fac8d91fc98efe5297d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dmvk/flink/commit/ae8133016df76594af008fac8d91fc98efe5297d&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t feel confident enough with these internals to form this into proper PR.&lt;/p&gt;</comment>
                            <comment id="17251444" author="xintongsong" created="Fri, 18 Dec 2020 02:04:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;, could you help look into this?&lt;/p&gt;</comment>
                            <comment id="17251523" author="fly_in_gis" created="Fri, 18 Dec 2020 05:32:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmvk&quot; class=&quot;user-hover&quot; rel=&quot;dmvk&quot;&gt;dmvk&lt;/a&gt;&#160;Thanks for creating this issue and debugging the root cause. I think you are right. Currently, when recovering from savepoint, Flink will add a new checkpoint to the HA storage. So it needs to update the ConfigMap. However, the ConfigMap has not be created since the leader election service is not started.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the Kubernetes HA implementation, we have a very important&#160;assumption, only the active leader could update the HA ConfigMap. I do not tend to let &lt;tt&gt;KubernetesStateHandleStore&lt;/tt&gt; could support adding checkpoints before leader is granted. It will cause some issues when we have multiple JobManagers. But I am also not sure whether we could start the leader election service before jobmaster service. I will dig more and hope to find a more reasonable solution.&lt;/p&gt;</comment>
                            <comment id="17251620" author="till.rohrmann" created="Fri, 18 Dec 2020 09:22:31 +0000"  >&lt;p&gt;I am currently working on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11719&quot; title=&quot;Remove JobMaster#start(JobMasterId) and #suspend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11719&quot;&gt;&lt;del&gt;FLINK-11719&lt;/del&gt;&lt;/a&gt; which would resolve the problem because we only start the &lt;tt&gt;JobMaster&lt;/tt&gt; once we have obtained the leadership.&lt;/p&gt;

&lt;p&gt;As a short term fix, we could try to do the &lt;tt&gt;JobManagerRunnerImpl&lt;/tt&gt; initialization under the &lt;tt&gt;lock&lt;/tt&gt; and then already start the leader election before we create the &lt;tt&gt;JobMasterService&lt;/tt&gt;. At the moment, we always call &lt;tt&gt;JobManagerRunnerImpl.start()&lt;/tt&gt; directly after the &lt;tt&gt;JobManagerRunnerImpl&lt;/tt&gt; has been created anyways.&lt;/p&gt;</comment>
                            <comment id="17251634" author="fly_in_gis" created="Fri, 18 Dec 2020 09:49:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;Thanks for your comments. I am afraid we could not simply start the leader election before creating &lt;tt&gt;JobMasterService&lt;/tt&gt;. Because we could not get the leader address and&#160;then&#160;&lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt; could not write it to the ConfigMap.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11719&quot; title=&quot;Remove JobMaster#start(JobMasterId) and #suspend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11719&quot;&gt;&lt;del&gt;FLINK-11719&lt;/del&gt;&lt;/a&gt;&#160;is the cleanest way. But I assume it may not be resolved very soon.&lt;/p&gt;</comment>
                            <comment id="17251821" author="till.rohrmann" created="Fri, 18 Dec 2020 15:22:39 +0000"  >&lt;p&gt;The address of the contender does not need to be known when starting the leader election service. Only when confirming the leader session one needs to specify the leader address.&lt;/p&gt;</comment>
                            <comment id="17251850" author="fly_in_gis" created="Fri, 18 Dec 2020 16:30:20 +0000"  >&lt;p&gt;Yes. We are justing using the &lt;tt&gt;leaderContenderDescription&lt;/tt&gt;(aka leader address) for logging in &lt;tt&gt;ZooKeeperLeaderElectionDriver&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17252736" author="till.rohrmann" created="Mon, 21 Dec 2020 09:50:00 +0000"  >&lt;p&gt;As a quick update, I don&apos;t intend to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11719&quot; title=&quot;Remove JobMaster#start(JobMasterId) and #suspend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11719&quot;&gt;&lt;del&gt;FLINK-11719&lt;/del&gt;&lt;/a&gt; for Flink &lt;tt&gt;1.12.1&lt;/tt&gt;. Hence, we need at least a quick fix for this problem in the &lt;tt&gt;1.12.x&lt;/tt&gt; release branch.&lt;/p&gt;</comment>
                            <comment id="17252749" author="fly_in_gis" created="Mon, 21 Dec 2020 10:18:56 +0000"  >&lt;p&gt;Thanks for your information. But it seems that we could not have a quick fix via starting leader election service before &lt;tt&gt;jobMasterFactory.createJobMasterService&lt;/tt&gt; in the constructor. Because we could not guarantee that the ConfigMap has been created even though the leader election service is started successfully.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Currently, I am working to delay starting JobManager until leadership is granted.&lt;/p&gt;</comment>
                            <comment id="17252879" author="till.rohrmann" created="Mon, 21 Dec 2020 14:00:10 +0000"  >&lt;p&gt;If it turns out to be the same as what I did for &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11719&quot; title=&quot;Remove JobMaster#start(JobMasterId) and #suspend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11719&quot;&gt;&lt;del&gt;FLINK-11719&lt;/del&gt;&lt;/a&gt;, then it might be easier to try to backport it. Currently, I am bit hesitant doing it because I want to avoid introducing behavioural changes with a bug fix release.&lt;/p&gt;</comment>
                            <comment id="17252880" author="till.rohrmann" created="Mon, 21 Dec 2020 14:02:01 +0000"  >&lt;p&gt;Is it because the ConfigMap gets created lazily when the leader election service is started &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17253266" author="fly_in_gis" created="Tue, 22 Dec 2020 04:14:52 +0000"  >&lt;p&gt;Yes, the &lt;tt&gt;KubernetesLeaderElector#run&lt;/tt&gt; is started in a separate thread. Once started, it tries to create the ConfigMap immediately. Since we have http IO operation here, we could not guarantee that the ConfigMap is created in given time. In most cases, it could be done in one round of loop(5 seconds).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I quickly gone though the PR of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11719&quot; title=&quot;Remove JobMaster#start(JobMasterId) and #suspend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11719&quot;&gt;&lt;del&gt;FLINK-11719&lt;/del&gt;&lt;/a&gt;. And actually we have the similar implementation&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. I verified it could works and recover from the savepoint successfully. But just as you said, we introduce some behavior changes, and it seems that we need to fix some more tests.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&#160;&lt;a href=&quot;https://github.com/wangyang0918/flink/commit/3be9df9063280693526c1b4446ec499a024a9059&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/wangyang0918/flink/commit/3be9df9063280693526c1b4446ec499a024a9059&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17253302" author="xintongsong" created="Tue, 22 Dec 2020 06:39:05 +0000"  >&lt;p&gt;Just to add my two cents.&lt;/p&gt;

&lt;p&gt;IIUC, the reason we convert a savepoint into a checkpoint, is to reuse the checkpoint recovery logics for restoring jobs from savepoints. For that purpose, it is not necessary to write this savepoint-converted checkpoint to the external HA service, because if this checkpoint gets lost the job can simply recover from the original savepoint. If we don&apos;t need to write this checkpoint to the external HA service, there&apos;s no need to wait for the leadership.&lt;/p&gt;

&lt;p&gt;Therefore, we might consider to extend &lt;tt&gt;CompletedCheckpointStore&lt;/tt&gt; with &lt;tt&gt;addCheckpointLocally&lt;/tt&gt; and &lt;tt&gt;StatehandleStore&lt;/tt&gt; with&#160;&lt;tt&gt;addLocally&lt;/tt&gt; for the savepoint-converted checkpoint. We can keep the local checkpoints in memory for &lt;tt&gt;KubernetesStateHandleStore&lt;/tt&gt;, while keep the original implementation for &lt;tt&gt;ZooKeeperStateHandleStore&lt;/tt&gt;. For recovery, we would need to compare the local checkpoints (if any) with the remote ones retrieved from external HA service, and recover from the most recent one.&lt;/p&gt;

&lt;p&gt;Ideally, this should bring no behavior changes to the ZooKeeper HA service, while allow restoring jobs from savepoints with K8s HA service. It might complicate the HA service interfaces a bit, but should be less invasive/risky compared to changing job master start up logics.&lt;/p&gt;

&lt;p&gt;I&apos;m proposing this as a potential quick fix for the 1.12 branch. I agree that &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11719&quot; title=&quot;Remove JobMaster#start(JobMasterId) and #suspend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11719&quot;&gt;&lt;del&gt;FLINK-11719&lt;/del&gt;&lt;/a&gt; is our first choice for resolving the problem on the master branch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;&#160;WDYT?&lt;/p&gt;</comment>
                            <comment id="17253385" author="fly_in_gis" created="Tue, 22 Dec 2020 10:04:36 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xintongsong&quot; class=&quot;user-hover&quot; rel=&quot;xintongsong&quot;&gt;xintongsong&lt;/a&gt;&#160;for suggestion. Maybe we do not need to store the initial savepoint to HA storage at all. We just need to check whether it is initial savepoint and then add to a local list cache &lt;tt&gt;initialSavepoints&lt;/tt&gt;. When recovering, we merge the &lt;tt&gt;initialSavepoints&lt;/tt&gt; and &lt;tt&gt;completedCheckpoints&lt;/tt&gt;. This&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; is a simple PoC of the thoughts and I am verifying whether it could work.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&#160;&lt;a href=&quot;https://github.com/wangyang0918/flink/commit/ee75083487741b508579717644eca291632f98db&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/wangyang0918/flink/commit/ee75083487741b508579717644eca291632f98db&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17253397" author="till.rohrmann" created="Tue, 22 Dec 2020 10:30:35 +0000"  >&lt;p&gt;How would we handle resetting the checkpoint counter to the checkpoint id = savepoint id + 1? For this operation, we would also need the leader ConfigMap being present if I am not mistaken. Not resetting the checkpoint id could violate the monotonicity of checkpoint ids.&lt;/p&gt;

&lt;p&gt;Another idea could be block the constructor of &lt;tt&gt;KubernetesLeaderElectionDriver&lt;/tt&gt; until a &lt;tt&gt;leaderElector&lt;/tt&gt; has created the leader &lt;tt&gt;ConfigMap&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17253417" author="fly_in_gis" created="Tue, 22 Dec 2020 11:23:18 +0000"  >&lt;p&gt;I think we could have the similar logics in&#160;&lt;tt&gt;CheckpointCoordinator&lt;/tt&gt;&#160;. When restoring from savepoint, we do not need to update the ConfigMap/ZooKeeper. Instead, we use a private long variable for the storage, and compare it with&#160;&lt;tt&gt;checkpointIdCounter.getAndIncrement()&lt;/tt&gt;&#160;in the&#160;&lt;tt&gt;initializeCheckpoint&lt;/tt&gt;&#160;. Does it make sense? Or you prefer blocking the constructor of&#160;&lt;tt&gt;KubernetesLeaderElectionDriver&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;IIUC, the checkpoint and counter from initial savepoint do not need to be stored in the HA storage. And they should not be stored in the HA storage since the leader has not been elected.&lt;/p&gt;</comment>
                            <comment id="17253508" author="till.rohrmann" created="Tue, 22 Dec 2020 13:49:53 +0000"  >&lt;p&gt;My concern is that introducing special case logic into the &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; is usually more difficult than blocking until the &lt;tt&gt;ConfigMap&lt;/tt&gt; has been created by the &lt;tt&gt;KubernetesLeaderElectionDriver&lt;/tt&gt;. Independent of this, I think that changing how initial savepoints are treated can work as well.&lt;/p&gt;</comment>
                            <comment id="17254392" author="fly_in_gis" created="Thu, 24 Dec 2020 04:02:49 +0000"  >&lt;p&gt;I have attached a PR to fix this issue via starting leader election before creating &lt;tt&gt;JobManagerService&lt;/tt&gt; and making constructor of &lt;tt&gt;KubernetesLeaderElectionDriver&lt;/tt&gt; blocking until ConfigMap exists.&lt;/p&gt;</comment>
                            <comment id="17254701" author="xintongsong" created="Fri, 25 Dec 2020 01:31:43 +0000"  >&lt;p&gt;Fixed on release-1.12 via:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;368b204d82ea274be9a47d7f1b9d24c7365c3b2d&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Fixed on master (1.13) by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11719&quot; title=&quot;Remove JobMaster#start(JobMasterId) and #suspend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11719&quot;&gt;&lt;del&gt;FLINK-11719&lt;/del&gt;&lt;/a&gt;, added it case via:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;2c92ea9a06fc13d8adedd4cd5737ab89cd0a7334&#160;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17254741" author="fly_in_gis" created="Fri, 25 Dec 2020 06:10:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmvk&quot; class=&quot;user-hover&quot; rel=&quot;dmvk&quot;&gt;dmvk&lt;/a&gt;&#160;Could you help to verify that this issue is fixed in your situation?&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                                                <inwardlinks description="is fixed by">
                                        <issuelink>
            <issuekey id="13217243">FLINK-11719</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 46 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0llps:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>