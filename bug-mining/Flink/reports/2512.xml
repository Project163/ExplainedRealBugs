<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9603] Incorrect indexing of part files, when part suffix is specified (FileAlreadyExistsException)</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9603</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Hi mates, since 1.5 release, BucketingSink has ability to configure suffix of the part file. It&#8217;s very useful, when it&#8217;s necessary to set specific extension of the file.&lt;br/&gt;
 &#160;&lt;br/&gt;
 During the usage, I&#8217;ve found the issue - when new part file is created, it has the same part index, as index of just closed file.&#160;&lt;br/&gt;
 So, when Flink tries to move it into final state, we have a FileAlreadyExistsException.&lt;br/&gt;
 &#160;&lt;br/&gt;
 This problem is related with the following code:&lt;br/&gt;
 &lt;b&gt;&lt;font color=&quot;#e32400&quot;&gt;Here we are trying to find the max index of part file, that doesn&#8217;t exist in bucket directory, the problem is, that the partSuffix is not involved into path assembly. This means, that path always doesn&#8217;t exist&lt;/font&gt;&lt;/b&gt;&lt;br/&gt;
 &lt;b&gt;&lt;font color=&quot;#e32400&quot;&gt;and partCounter wouldn&#8217;t be ever incremented.&lt;/font&gt;&lt;/b&gt;&lt;br/&gt;
 &#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Path partPath = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(bucketPath, partPrefix + &lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt; + subtaskIndex + &lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt; + bucketState.partCounter);
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (fs.exists(partPath) ||
      fs.exists(getPendingPathFor(partPath)) ||
      fs.exists(getInProgressPathFor(partPath))) {
   bucketState.partCounter++;
   partPath = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(bucketPath, partPrefix + &lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt; + subtaskIndex + &lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt; + bucketState.partCounter);
}

bucketState.creationTime = processingTimeService.getCurrentProcessingTime();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;&lt;font color=&quot;#e32400&quot;&gt;Before creating of writer, we appending the partSuffix here, but it should be already appended, before index checks&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (partSuffix != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
   partPath = partPath.suffix(partSuffix);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13166542">FLINK-9603</key>
            <summary>Incorrect indexing of part files, when part suffix is specified (FileAlreadyExistsException)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkl0u">Kostas Kloudas</assignee>
                                    <reporter username="kent2171">Rinat Sharipov</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sat, 16 Jun 2018 14:28:24 +0000</created>
                <updated>Thu, 12 Jul 2018 11:50:26 +0000</updated>
                            <resolved>Thu, 12 Jul 2018 11:50:26 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.5.1</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>Connectors / FileSystem</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16515072" author="kent2171" created="Sun, 17 Jun 2018 13:01:37 +0000"  >&lt;p&gt;Hi mates, I got the following proposal about fix of this issue:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;build path&#160;using the same method (or some kind of Builder), instead of using the same logic multiple times across the code (DRY)&lt;/li&gt;
	&lt;li&gt;test, that part index is properly incremented, when part suffix is specified
	&lt;ul&gt;
		&lt;li&gt;in-progress file exists&lt;/li&gt;
		&lt;li&gt;pending file exists&lt;/li&gt;
		&lt;li&gt;file in final state exists&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;and test the same cases when part suffix is not specified&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16515083" author="githubbot" created="Sun, 17 Jun 2018 13:41:14 +0000"  >&lt;p&gt;GitHub user kent2171 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9603&quot; title=&quot;Incorrect indexing of part files, when part suffix is specified (FileAlreadyExistsException)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9603&quot;&gt;&lt;del&gt;FLINK-9603&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;connector-filesystem&amp;#93;&lt;/span&gt; fix part indexing, when part suffix is specified&lt;/p&gt;

&lt;p&gt;    This pull-request fixes problem of incorrect part file index lookup, when part suffix is specified.&lt;br/&gt;
    Part file path should be assembled with part suffix, before check on existance&lt;/p&gt;

&lt;p&gt;    The following tests, that verify part file indexing, have been added:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;testThatPartIndexIsIncrementedWhenPartSuffixIsSpecifiedAndPreviousPartFileInProgressState&lt;/li&gt;
	&lt;li&gt;testThatPartIndexIsIncrementedWhenPartSuffixIsSpecifiedAndPreviousPartFileInPendingState&lt;/li&gt;
	&lt;li&gt;testThatPartIndexIsIncrementedWhenPartSuffixIsSpecifiedAndPreviousPartFileInFinalState&lt;/li&gt;
	&lt;li&gt;testThatPartIndexIsIncrementedWhenPartSuffixIsNotSpecifiedAndPreviousPartFileInProgressState&lt;/li&gt;
	&lt;li&gt;testThatPartIndexIsIncrementedWhenPartSuffixIsNotSpecifiedAndPreviousPartFileInPendingState&lt;/li&gt;
	&lt;li&gt;testThatPartIndexIsIncrementedWhenPartSuffixIsNotSpecifiedAndPreviousPartFileInFinalState&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/kent2171/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kent2171/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9603&quot; title=&quot;Incorrect indexing of part files, when part suffix is specified (FileAlreadyExistsException)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9603&quot;&gt;&lt;del&gt;FLINK-9603&lt;/del&gt;&lt;/a&gt;_fix_part_idx_inc&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6176.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6176.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6176&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c08b81044bf80d5633a9936afb73fadf021cef47&lt;br/&gt;
Author: Rinat Sharipov &amp;lt;r.sharipov@...&amp;gt;&lt;br/&gt;
Date:   2018-06-17T13:03:54Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9603&quot; title=&quot;Incorrect indexing of part files, when part suffix is specified (FileAlreadyExistsException)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9603&quot;&gt;&lt;del&gt;FLINK-9603&lt;/del&gt;&lt;/a&gt; 1. all logic, that is responsible for path assembly moved into method; 2. test logic of part file indexing, when in-progress/ pending/ final part files already exists in bucket; 3. test the same logic, when part file has suffix&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16515084" author="kent2171" created="Sun, 17 Jun 2018 13:42:11 +0000"  >&lt;p&gt;I&apos;ve created a PR, that fixes this problem, please, have a look &lt;a href=&quot;https://github.com/apache/flink/pull/6176/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6176/files&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16536646" author="githubbot" created="Mon, 9 Jul 2018 08:03:27 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the work @kent2171 ! I will merge this as soon as Travis gives the green light!&lt;/p&gt;</comment>
                            <comment id="16536705" author="githubbot" created="Mon, 9 Jul 2018 08:53:37 +0000"  >&lt;p&gt;Github user kent2171 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    nice to hear, thx you @kl0u &lt;/p&gt;</comment>
                            <comment id="16536776" author="githubbot" created="Mon, 9 Jul 2018 10:47:21 +0000"  >&lt;p&gt;Github user kent2171 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @kl0u Kostas, build failed, and said  `src/test/java/org/apache/flink/streaming/connectors/fs/bucketing/BucketingSinkTest.java:&lt;span class=&quot;error&quot;&gt;&amp;#91;965&amp;#93;&lt;/span&gt; (regexp) RegexpSinglelineJava: Line has leading space characters; indentation should be performed with tabs only.`&lt;/p&gt;

&lt;p&gt;    starts not from tab, I&apos;ve checked in mine and yours repository, this line starts from 3 tabs, should I fix something ? &lt;/p&gt;</comment>
                            <comment id="16536783" author="githubbot" created="Mon, 9 Jul 2018 10:59:08 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @kent2171 ! Do not worry, I can fix it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Thanks for having a look!&lt;/p&gt;
</comment>
                            <comment id="16536787" author="githubbot" created="Mon, 9 Jul 2018 11:03:56 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6176&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16536788" author="githubbot" created="Mon, 9 Jul 2018 11:05:37 +0000"  >&lt;p&gt;Github user kent2171 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    cool, thx @kl0u &lt;/p&gt;</comment>
                            <comment id="16536828" author="kkl0u" created="Mon, 9 Jul 2018 11:59:27 +0000"  >&lt;p&gt;Merged on master with&#160;b12acea2afcd75a9183aca549fea426e86bfc5de&lt;/p&gt;

&lt;p&gt;and on release-1.5&#160;2c47ef3577dfbc957a17ebdf6a0f7895215073a9&lt;/p&gt;</comment>
                            <comment id="16541512" author="aljoscha" created="Thu, 12 Jul 2018 11:50:04 +0000"  >&lt;p&gt;reopen to add fixVersion&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3uy13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>