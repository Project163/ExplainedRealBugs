<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:55:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21839] SinkFunction snapshotState don&apos;t snapshot all data when trigger a stop-with-drain savepoint</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21839</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;This problem was discovered when I was developing the flink code. In my flink code, my custom sink don&apos;t send all data that be produced by event_time window when trigger stop-with-drain savepoint .&lt;/p&gt;

&lt;p&gt;TestSink.java is a example that SinkFunction invoke() continues to run after&#160;snapshotState() executed when&#160;trigger a stop-with-drain savepoint by rest api.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//TaskSink.java log
&lt;/span&gt;sink open
invoke: 0
invoke: 1
invoke: 2
invoke: 3
invoke: 4
invoke: 5
invoke: 6
invoke: 7
invoke: 8
invoke: 9
...
invoke: 425
invoke: 426
invoke: 427
snapshotState
invoke: 428 &lt;span class=&quot;code-comment&quot;&gt;// It should be executed before snapshotState.
&lt;/span&gt;sink close&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13365706">FLINK-21839</key>
            <summary>SinkFunction snapshotState don&apos;t snapshot all data when trigger a stop-with-drain savepoint</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="ym">Yuan Mei</assignee>
                                    <reporter username="lintingbin">Darcy Lin</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Mar 2021 05:18:10 +0000</created>
                <updated>Wed, 14 Apr 2021 09:46:22 +0000</updated>
                            <resolved>Wed, 14 Apr 2021 09:46:22 +0000</resolved>
                                    <version>1.12.2</version>
                                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17319463" author="pnowojski" created="Mon, 12 Apr 2021 13:52:00 +0000"  >&lt;p&gt;This issue might be &quot;fixed&quot; by FLIP-147&lt;/p&gt;</comment>
                            <comment id="17319985" author="ym" created="Tue, 13 Apr 2021 07:28:15 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lintingbin&quot; class=&quot;user-hover&quot; rel=&quot;lintingbin&quot;&gt;lintingbin&lt;/a&gt;, with the info provided in the ticket, I can not tell it is a but or not. &lt;/p&gt;

&lt;p&gt;I think that&apos;s the expected behavior (not saying it is the right behavior, but expected). Before diving into the detail, would you mind sharing a bit more info with your pipeline? Is it using the old source or a new source (FLIP 27), what does your application look like? Is there any suspicious log?&lt;/p&gt;


&lt;p&gt;The reason why `TaskSink` invokes after snapshot:&lt;/p&gt;

&lt;p&gt;`stop-with-drain` procedure contains two stages:&lt;br/&gt;
1. insert max_watermark and create the savepoint&lt;br/&gt;
2. stop the source to trigger `END_OF_PARTITION` event to stop the job.&lt;/p&gt;

&lt;p&gt;In the gap between &quot;draining window state and create savepoint&quot; and &quot;handling END_OF_PARTITION&quot;, there is still data flow in from the source. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;SourceStreamTask#finishTask&lt;br/&gt;
        /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Currently stop with savepoint relies on the EndOfPartitionEvents propagation and&lt;/li&gt;
	&lt;li&gt;performs clean shutdown after the stop with savepoint (which can produce some&lt;/li&gt;
	&lt;li&gt;records to process after the savepoint while stopping). If we interrupt source thread,&lt;/li&gt;
	&lt;li&gt;we might leave the network stack in an inconsistent state. So, if we want to relay on&lt;/li&gt;
	&lt;li&gt;the clean shutdown, we can not interrupt the source thread.&lt;br/&gt;
         */&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;You can refer to &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt;&quot;and FLIP-147 for a bit more detail.&lt;/p&gt;</comment>
                            <comment id="17320003" author="lintingbin" created="Tue, 13 Apr 2021 07:53:32 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ym&quot; class=&quot;user-hover&quot; rel=&quot;ym&quot;&gt;ym&lt;/a&gt;, I think this problem has nothing to do with source.&#160;My test script &quot;TestSink.java&quot; can reproduce this problem.&#160;I think there may be records inserted between the&#160;max_watermark and END_OF_PARTITION.&lt;/p&gt;</comment>
                            <comment id="17320007" author="ym" created="Tue, 13 Apr 2021 07:58:58 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lintingbin&quot; class=&quot;user-hover&quot; rel=&quot;lintingbin&quot;&gt;lintingbin&lt;/a&gt;, that&apos;s exactly what I explained above, source can still produce data between max_watermark and END_OF_PARTITION (its stopped)&lt;/p&gt;</comment>
                            <comment id="17320077" author="ym" created="Tue, 13 Apr 2021 10:56:39 +0000"  >&lt;p&gt;Document stop-with-savepoint behavior more explicitly&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/pull/15594&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/15594&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17320858" author="dawidwys" created="Wed, 14 Apr 2021 09:44:18 +0000"  >&lt;p&gt;I merged the minor clarification to docs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master
	&lt;ul&gt;
		&lt;li&gt;81118c0d6c24b6b9883f3e1285964458030a24fc&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;1.12.3
	&lt;ul&gt;
		&lt;li&gt;682b255ed7a0acbf91877b9b37889bf1e757da19&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17320859" author="dawidwys" created="Wed, 14 Apr 2021 09:46:13 +0000"  >&lt;p&gt;I am closing the ticket as it is the expected behaviour in the current state. The effort of making it more intuitive is tracked already by the issues mentioned above (such as e.g. FLIP-147 or &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21133&quot; title=&quot;FLIP-27 Source does not work with synchronous savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21133&quot;&gt;&lt;del&gt;FLINK-21133&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12852528">FLINK-2491</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13022443" name="TestSink.java" size="2055" author="lintingbin" created="Wed, 17 Mar 2021 04:51:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ovc8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>