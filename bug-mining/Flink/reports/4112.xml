<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:46:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-17771] &quot;PyFlink end-to-end test&quot; fails with &quot;The output result: [] is not as expected: [2, 3, 4]!&quot; on Java11</title>
                <link>https://issues.apache.org/jira/browse/FLINK-17771</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Java 11 nightly profile: &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=1579&amp;amp;view=logs&amp;amp;j=6caf31d6-847a-526e-9624-468e053467d6&amp;amp;t=679407b1-ea2c-5965-2c8d-1467777fff88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=1579&amp;amp;view=logs&amp;amp;j=6caf31d6-847a-526e-9624-468e053467d6&amp;amp;t=679407b1-ea2c-5965-2c8d-1467777fff88&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Job has been submitted with JobID ef78030becb3bfd6415d3de2e06420b4
java.lang.AssertionError: The output result: [] is not as expected: [2, 3, 4]!
	at org.apache.flink.python.tests.FlinkStreamPythonUdfSqlJob.main(FlinkStreamPythonUdfSqlJob.java:55)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:566)
	at org.apache.flink.client.program.PackagedProgram.callMainMethod(PackagedProgram.java:288)
	at org.apache.flink.client.program.PackagedProgram.invokeInteractiveModeForExecution(PackagedProgram.java:198)
	at org.apache.flink.client.ClientUtils.executeProgram(ClientUtils.java:148)
	at org.apache.flink.client.cli.CliFrontend.executeProgram(CliFrontend.java:689)
	at org.apache.flink.client.cli.CliFrontend.run(CliFrontend.java:227)
	at org.apache.flink.client.cli.CliFrontend.parseParameters(CliFrontend.java:906)
	at org.apache.flink.client.cli.CliFrontend.lambda$main$10(CliFrontend.java:982)
	at org.apache.flink.runtime.security.contexts.NoOpSecurityContext.runSecured(NoOpSecurityContext.java:30)
	at org.apache.flink.client.cli.CliFrontend.main(CliFrontend.java:982)
Stopping taskexecutor daemon (pid: 2705) on host fv-az670.

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13305461">FLINK-17771</key>
            <summary>&quot;PyFlink end-to-end test&quot; fails with &quot;The output result: [] is not as expected: [2, 3, 4]!&quot; on Java11</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zhongwei">Wei Zhong</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Sun, 17 May 2020 08:58:26 +0000</created>
                <updated>Fri, 16 Oct 2020 10:53:54 +0000</updated>
                            <resolved>Fri, 22 May 2020 02:59:52 +0000</resolved>
                                    <version>1.11.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>API / Python</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17109490" author="dian.fu" created="Sun, 17 May 2020 14:06:26 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhongwei&quot; class=&quot;user-hover&quot; rel=&quot;zhongwei&quot;&gt;zhongwei&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17109491" author="dian.fu" created="Sun, 17 May 2020 14:09:50 +0000"  >&lt;p&gt;When I tried to reproduce this problem locally with JDK 11, it will throw exceptions as following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;grpc-&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-executor-0&quot;&lt;/span&gt; java.lang.OutOfMemoryError: Direct buffer memory
	at java.base/java.nio.Bits.reserveMemory(Bits.java:175)
	at java.base/java.nio.DirectByteBuffer.&amp;lt;init&amp;gt;(DirectByteBuffer.java:118)
	at java.base/java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:317)
	at org.apache.beam.vendor.grpc.v1p21p0.io.netty.buffer.PoolArena$DirectArena.allocateDirect(PoolArena.java:777)
	at org.apache.beam.vendor.grpc.v1p21p0.io.netty.buffer.PoolArena$DirectArena.newChunk(PoolArena.java:753)
	at org.apache.beam.vendor.grpc.v1p21p0.io.netty.buffer.PoolArena.allocateNormal(PoolArena.java:250)
	at org.apache.beam.vendor.grpc.v1p21p0.io.netty.buffer.PoolArena.allocate(PoolArena.java:220)
	at org.apache.beam.vendor.grpc.v1p21p0.io.netty.buffer.PoolArena.allocate(PoolArena.java:152)
	at org.apache.beam.vendor.grpc.v1p21p0.io.netty.buffer.PooledByteBufAllocator.newDirectBuffer(PooledByteBufAllocator.java:332)
	at org.apache.beam.vendor.grpc.v1p21p0.io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:187)
	at org.apache.beam.vendor.grpc.v1p21p0.io.netty.buffer.AbstractByteBufAllocator.buffer(AbstractByteBufAllocator.java:123)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.netty.NettyWritableBufferAllocator.allocate(NettyWritableBufferAllocator.java:51)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.MessageFramer.writeKnownLengthUncompressed(MessageFramer.java:226)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.MessageFramer.writeUncompressed(MessageFramer.java:167)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.MessageFramer.writePayload(MessageFramer.java:140)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.AbstractStream.writeMessage(AbstractStream.java:53)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.ServerCallImpl.sendMessageInternal(ServerCallImpl.java:163)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.ServerCallImpl.sendMessage(ServerCallImpl.java:145)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.stub.ServerCalls$ServerCallStreamObserverImpl.onNext(ServerCalls.java:349)
	at org.apache.beam.runners.fnexecution.provisioning.StaticGrpcProvisionService.getProvisionInfo(StaticGrpcProvisionService.java:48)
	at org.apache.beam.model.fnexecution.v1.ProvisionServiceGrpc$MethodHandlers.invoke(ProvisionServiceGrpc.java:246)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.stub.ServerCalls$UnaryServerCallHandler$UnaryServerCallListener.onHalfClose(ServerCalls.java:171)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.PartialForwardingServerCallListener.onHalfClose(PartialForwardingServerCallListener.java:35)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.ForwardingServerCallListener.onHalfClose(ForwardingServerCallListener.java:23)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.ForwardingServerCallListener$SimpleForwardingServerCallListener.onHalfClose(ForwardingServerCallListener.java:40)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.Contexts$ContextualizedServerCallListener.onHalfClose(Contexts.java:86)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.ServerCallImpl$ServerStreamListenerImpl.halfClosed(ServerCallImpl.java:322)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener$1HalfClosed.runInContext(ServerImpl.java:762)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I guess this is the reason why the result is empty as it encounters OutOfMemoryError during running. (It could succeed when switching to JDK 8.)&lt;/p&gt;</comment>
                            <comment id="17113135" author="zhongwei" created="Thu, 21 May 2020 12:18:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dian.fu&quot; class=&quot;user-hover&quot; rel=&quot;dian.fu&quot;&gt;dian.fu&lt;/a&gt;&#160;I have investigated the issue for several days. The empty result is&#160;indeed caused by the OOM. But the root cause is the memory leaking of the ChildFirstClassLoader of the PyFlink Task. Currently I have found 5 places which caused the memory leaking via the heapdump file:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The context class loader of the thread pools named &quot;flink-file-cache-xxx&quot;.&lt;/li&gt;
	&lt;li&gt;The soft reference from the field &quot;reflectors&quot; and &quot;localDescs&quot; of the class &quot;ObjectStreamClass$Caches&quot;. The OOM is cause by the DirectMemory which would not trigger the GC of the soft reference, so we need to consider the soft references here.&lt;/li&gt;
	&lt;li&gt;The context class loader of the process reaper thread.&lt;/li&gt;
	&lt;li&gt;The &quot;classLoader&quot; field of the &quot;org.codehaus.janino.ClassLoaderIClassLoader&quot; objects.&lt;/li&gt;
	&lt;li&gt;The soft reference of the object &quot;org.apache.flink.table.runtime.generated.COMPILED_CACHE&quot;.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This is the screenshot:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13003644/13003644_image-2020-05-21-20-11-07-626.png&quot; height=&quot;151&quot; width=&quot;754&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13003645/13003645_image-2020-05-21-20-11-29-389.png&quot; height=&quot;74&quot; width=&quot;754&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13003646/13003646_image-2020-05-21-20-11-48-220.png&quot; height=&quot;157&quot; width=&quot;744&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13003647/13003647_image-2020-05-21-20-12-16-889.png&quot; height=&quot;274&quot; width=&quot;743&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Note that the issue also exists on jDK8. When running in JDK8, the shaded Netty in Beam uses the method &quot;Unsafe.allocateMemory()&quot; to allocate the Direct Memory instead of the method &quot;ByteBuffer.allocateDirect()&quot;, which won&apos;t be limited by the param &quot;MaxDirectMemorySize&quot;. So the OOM won&apos;t happen in JDK8 but the process memory is still increasing.&lt;/p&gt;</comment>
                            <comment id="17113143" author="zhongwei" created="Thu, 21 May 2020 12:26:38 +0000"  >&lt;p&gt;To solve the memory leak issue of the ChildFirstClassLoader completely needs further effort and discussion. Before that we can fix the test case temporarily via adjusting the&#160;limit of the off-heap memory. What do you think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dian.fu&quot; class=&quot;user-hover&quot; rel=&quot;dian.fu&quot;&gt;dian.fu&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17113707" author="dian.fu" created="Fri, 22 May 2020 02:59:39 +0000"  >&lt;p&gt;Merged via :&lt;br/&gt;
master: 8b14cd807d165052da46df2fc0d9536eadc97fe7&lt;br/&gt;
release-1.11: c7243c001ba632f412add975a26fe3ae1caff7b2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13003644" name="image-2020-05-21-20-11-07-626.png" size="684226" author="zhongwei" created="Thu, 21 May 2020 12:09:45 +0000"/>
                            <attachment id="13003645" name="image-2020-05-21-20-11-29-389.png" size="376912" author="zhongwei" created="Thu, 21 May 2020 12:10:06 +0000"/>
                            <attachment id="13003646" name="image-2020-05-21-20-11-48-220.png" size="596816" author="zhongwei" created="Thu, 21 May 2020 12:10:26 +0000"/>
                            <attachment id="13003647" name="image-2020-05-21-20-12-16-889.png" size="1857070" author="zhongwei" created="Thu, 21 May 2020 12:10:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0etts:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>