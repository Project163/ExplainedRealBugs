<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:40:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-13384] The back pressure monitoring does not work for StreamSources</title>
                <link>https://issues.apache.org/jira/browse/FLINK-13384</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I think it is caused by: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12483&quot; title=&quot;Support (legacy) SourceFunctions with mailbox&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12483&quot;&gt;&lt;del&gt;FLINK-12483&lt;/del&gt;&lt;/a&gt;. The reason is that the &lt;tt&gt;BackPressureStatsTrackerImpl&lt;/tt&gt; samples only the main thread. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12483&quot; title=&quot;Support (legacy) SourceFunctions with mailbox&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12483&quot;&gt;&lt;del&gt;FLINK-12483&lt;/del&gt;&lt;/a&gt; introduced a separate thread for executing the sources in the mailbox model. It is similar to other old bug that concerned only Kafka source: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3456&quot; title=&quot;Backpressure Monitoring does not work for Kafka Sources&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3456&quot;&gt;&lt;del&gt;FLINK-3456&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13246555">FLINK-13384</key>
            <summary>The back pressure monitoring does not work for StreamSources</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gjy">Gary Yao</assignee>
                                    <reporter username="dwysakowicz">Dawid Wysakowicz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 23 Jul 2019 12:27:51 +0000</created>
                <updated>Fri, 16 Aug 2019 14:03:27 +0000</updated>
                            <resolved>Mon, 5 Aug 2019 10:06:28 +0000</resolved>
                                    <version>1.9.0</version>
                                    <fixVersion>1.9.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16890965" author="dawidwys" created="Tue, 23 Jul 2019 12:49:56 +0000"  >&lt;p&gt;I&apos;m still investigating the issue. It&apos;s not a problem of the WebUI, but of the backpressure tracker. &lt;/p&gt;

&lt;p&gt;The backpressure metrics are displayed correctly for a map operator(not a source) if I increase the BackPressureStatsTrackerImpl#MAX_STACK_TRACE_DEPTH to 10.&lt;/p&gt;</comment>
                            <comment id="16891049" author="dawidwys" created="Tue, 23 Jul 2019 14:06:48 +0000"  >&lt;p&gt;After further investigation I found out that it does not work only for &lt;tt&gt;StreamSource&lt;/tt&gt; s. I think it is caused by: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12483&quot; title=&quot;Support (legacy) SourceFunctions with mailbox&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12483&quot;&gt;&lt;del&gt;FLINK-12483&lt;/del&gt;&lt;/a&gt;. The reason is that the &lt;tt&gt;BackPressureStatsTrackerImpl&lt;/tt&gt; samples only the main thread. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12483&quot; title=&quot;Support (legacy) SourceFunctions with mailbox&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12483&quot;&gt;&lt;del&gt;FLINK-12483&lt;/del&gt;&lt;/a&gt; introduced a separate thread for executing the sources in the mailbox model. It is similar to other old bug that concerned only Kafka source: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3456&quot; title=&quot;Backpressure Monitoring does not work for Kafka Sources&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3456&quot;&gt;&lt;del&gt;FLINK-3456&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=1u0&quot; class=&quot;user-hover&quot; rel=&quot;1u0&quot;&gt;1u0&lt;/a&gt; Could you verify if this is the case?&lt;/p&gt;</comment>
                            <comment id="16891059" author="till.rohrmann" created="Tue, 23 Jul 2019 14:15:33 +0000"  >&lt;p&gt;Would it work to fix the issue by increasing the sampling size and leave the proper fix for the sources for later if this is a bigger endeavor? I think this issue might resolve itself once we have the new source interface.&lt;/p&gt;</comment>
                            <comment id="16891065" author="dawidwys" created="Tue, 23 Jul 2019 14:20:45 +0000"  >&lt;p&gt;This would not solve it. The problem is that we sample wrong thread.&lt;/p&gt;</comment>
                            <comment id="16891700" author="1u0" created="Wed, 24 Jul 2019 08:49:00 +0000"  >&lt;p&gt;&amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12483&quot; title=&quot;Support (legacy) SourceFunctions with mailbox&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12483&quot;&gt;&lt;del&gt;FLINK-12483&lt;/del&gt;&lt;/a&gt; introduced a separate thread for executing the sources in the mailbox model.&lt;/p&gt;

&lt;p&gt;I confirm, for the streaming source tasks, the source function (and other chained operators) is now running in a separate thread.&lt;br/&gt;
For such tasks, the main task thread now mostly waiting for termination of that thread and does task shutdown/cleanup.&lt;/p&gt;

&lt;p&gt;I&apos;m not aware of any explicit changes/adjustments related to backpressure tracking.&lt;/p&gt;

&lt;p&gt;Quick look into &lt;tt&gt;BackPressureStatsTrackerImpl&lt;/tt&gt; source code, points to tracking &lt;tt&gt;LocalBufferPool.requestBufferBlocking&lt;/tt&gt; method calls in stack traces. It&apos;s possible that this method is not used anymore in the production (due to some other changes to make inputs non-blocking).&lt;/p&gt;</comment>
                            <comment id="16893897" author="gjy" created="Fri, 26 Jul 2019 15:26:40 +0000"  >&lt;p&gt;Currently, we sample the stacktrace in &lt;a href=&quot;https://github.com/apache/flink/blob/bb82aacf46565968359f5ee6d2503c3293d71d6e/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskStackTraceSampleableTaskAdapter.java#L50&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TaskStackTraceSampleableTaskAdapter&lt;/a&gt;. As a quick fix, I see the following options:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We could somehow expose the &lt;tt&gt;LegacySourceFunctionThread&lt;/tt&gt; instance from &lt;tt&gt;Task&lt;/tt&gt; so that we sample the correct thread in &lt;tt&gt;TaskStackTraceSampleableTaskAdapter&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Using &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/lang/ThreadGroup.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ThreadGroup&lt;/a&gt;, we could enumerate (all) threads in the JVM and find the correct thread to sample from.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; can chime in here.&lt;/p&gt;</comment>
                            <comment id="16895878" author="pnowojski" created="Tue, 30 Jul 2019 07:54:27 +0000"  >&lt;p&gt;From your two proposals, as a hotfix I think the first one (exposing &lt;tt&gt;LegacySourceFunctionThread&lt;/tt&gt; via some &lt;tt&gt;Task.getMainExecutionThread()&lt;/tt&gt; or sth like that) sounds better to me.&lt;/p&gt;

&lt;p&gt;However this is not the first time that backpressure monitor has been broken. Also I think it&apos;s inherently broken with the current threading model, since it only detects if the task is backpressured when a record was produced from the main thread. That&apos;s not always true: processing time timers, &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt;, &lt;tt&gt;ContinousFileReaderOperator&lt;/tt&gt;, custom sources that emit records from independent threads are all braking this assumption. Sometime ago I was proposing a more general fix for that: use output buffer usage metrics. If at least one output buffer is full, we assume there is a backpressure. However that would have been probably a bigger change.&lt;/p&gt;</comment>
                            <comment id="16899966" author="gjy" created="Mon, 5 Aug 2019 10:06:28 +0000"  >&lt;p&gt;1.9:&lt;br/&gt;
e2eb6d41a0abcc206966249d83ceb0f450b2cf6b &lt;br/&gt;
62448ec70575176905b177cac0976959a4bd2d05&lt;/p&gt;

&lt;p&gt;1.10:&lt;br/&gt;
331d40ff7cc669b614c668b9f0d8160d15685626&lt;br/&gt;
fffe9db6b591d2316a4a2aa6ae717063133425a2&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13232616">FLINK-12483</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12940652">FLINK-3456</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi0g1t:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>