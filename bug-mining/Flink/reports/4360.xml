<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:48:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18348] RemoteInputChannel should checkError before checking partitionRequestClient</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18348</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The error will be set and &lt;tt&gt;partitionRequestClient&lt;/tt&gt; will be a null value if a remote channel fails to request the partition at the beginning. And the task will fail &lt;a href=&quot;https://github.com/apache/flink/blob/2150533ac0b2a6cc00238041853bbb6ebf22cee9/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java#L172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; when&#160;the task thread trying to fetch data from channels.&lt;/p&gt;

&lt;p&gt;And then we get error:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException: Queried &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a buffer before requesting a queue.
        at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195) ~[flink-dist_2.11-1.11-SNAPSHOT.jar:1.11-SNAPSHOT]
        at org.apache.flink.runtime.io.network.partition.consumer.RemoteInputChannel.getNextBuffer(RemoteInputChannel.java:172) ~[flink-dist_2.11-1.11-SNAPSHOT.jar:1.11-SNAPSHOT]
        at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.waitAndGetNextData(SingleInputGate.java:637) ~[flink-dist_2.11-1.11-SNAPSHOT.jar:1.11-SNAPSHOT]
        at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.getNextBufferOrEvent(SingleInputGate.java:615) ~[flink-dist_2.11-1.11-SNAPSHOT.jar:1.11-SNAPSHOT]
        at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.getNext(SingleInputGate.java:598) ~[flink-dist_2.11-1.11-SNAPSHOT.jar:1.11-SNAPSHOT]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But the root cause is the &lt;tt&gt;PartitionConnectionException&lt;/tt&gt; we set when requesting the partition.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13311957">FLINK-18348</key>
            <summary>RemoteInputChannel should checkError before checking partitionRequestClient</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wind_ljy">Jiayi Liao</assignee>
                                    <reporter username="wind_ljy">Jiayi Liao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 17 Jun 2020 12:33:45 +0000</created>
                <updated>Tue, 23 Jun 2020 15:57:28 +0000</updated>
                            <resolved>Tue, 23 Jun 2020 15:56:48 +0000</resolved>
                                    <version>1.11.0</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17138402" author="wind_ljy" created="Wed, 17 Jun 2020 12:39:09 +0000"  >&lt;p&gt;After visiting the codes, I think we can safely remove the &lt;tt&gt;checkState(partitionRequestClient != null)&lt;/tt&gt; in &lt;tt&gt;getNextBuffer()&lt;/tt&gt; because it can only be null value when the task fails to request partitions, which is already covered in &lt;tt&gt;checkError()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Update: it seems that this check in other functions like &lt;tt&gt;resumeConsumption()&lt;/tt&gt; can also be removed safely.&lt;/p&gt;</comment>
                            <comment id="17138683" author="pnowojski" created="Wed, 17 Jun 2020 17:46:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt; is this another instance of the same problem?&lt;br/&gt;
&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=3722&amp;amp;view=logs&amp;amp;j=c88eea3b-64a0-564d-0031-9fdcd7b8abee&amp;amp;t=1e2bbe5b-4657-50be-1f07-d84bfce5b1f5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=3722&amp;amp;view=logs&amp;amp;j=c88eea3b-64a0-564d-0031-9fdcd7b8abee&amp;amp;t=1e2bbe5b-4657-50be-1f07-d84bfce5b1f5&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[FAIL] &apos;Streaming File Sink s3 end-to-end test&apos; failed after 15 minutes and 18 seconds! Test exited with exit code 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IllegalStateException: Queried for a buffer before requesting a queue.
	at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.RemoteInputChannel.getNextBuffer(RemoteInputChannel.java:172) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.waitAndGetNextData(SingleInputGate.java:637) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.getNextBufferOrEvent(SingleInputGate.java:615) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.pollNext(SingleInputGate.java:603) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.taskmanager.InputGateWithMetrics.pollNext(InputGateWithMetrics.java:105) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.io.CheckpointedInputGate.pollNext(CheckpointedInputGate.java:79) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.io.StreamTaskNetworkInput.emitNext(StreamTaskNetworkInput.java:158) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:67) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:345) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxStep(MailboxProcessor.java:191) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:181) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:558) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:530) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:721) [flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:546) [flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at java.lang.Thread.run(Thread.java:748) [?:1.8.0_252]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17138691" author="pnowojski" created="Wed, 17 Jun 2020 17:55:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt; are you sure you have noticed this problem on Flink 1.10.1? I think this change was caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16536&quot; title=&quot;Implement InputChannel state recovery for unaligned checkpoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-16536&quot;&gt;&lt;del&gt;FLINK-16536&lt;/del&gt;&lt;/a&gt; via adding this method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void internalRequestPartitions() {
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (InputChannel inputChannel : inputChannels.values()) {
			&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
				inputChannel.requestSubpartition(consumedSubpartitionIndex);
			} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
				inputChannel.setError(t);
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
			}
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;del&gt;Upgrading to blocker&lt;/del&gt;. Upgrading to critical. I think this is not a blocker, as this is just hiding some connection issue with this &lt;tt&gt;IllegalStateException&lt;/tt&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;, what do you think?&lt;/p&gt;</comment>
                            <comment id="17138999" author="zjwang" created="Thu, 18 Jun 2020 03:37:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16536&quot; title=&quot;Implement InputChannel state recovery for unaligned checkpoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-16536&quot;&gt;&lt;del&gt;FLINK-16536&lt;/del&gt;&lt;/a&gt; might cause this issue, but there was also another place to cause it in &lt;a href=&quot;https://github.com/apache/flink/blob/2150533ac0b2a6cc00238041853bbb6ebf22cee9/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/NettyPartitionRequestClient.java#L121&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;link&lt;/a&gt;. So this issue is not a new one brought by release-1.11, not blocker issue as well.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt; Regarding the solution, I think the conservative way is to reverse the calls between `checkError` and `checkState`. `checkState` might be still reasonable to guard the logics in some cases. E.g. if we have some logic bugs to miss `requestPartition` in advance, then the `checkState` can help locate such issue.&lt;/p&gt;</comment>
                            <comment id="17139017" author="wind_ljy" created="Thu, 18 Jun 2020 03:59:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Sorry for choosing wrong affected version &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  I actually met this problem on release-1.11 branch when testing some features on my own.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; I&apos;m not sure that &lt;tt&gt;RemoteInputChannel.onError(Throwable)&lt;/tt&gt; will cause this problem because client is already not null when requesting a new partition. I agree that we can keep this to prevent some unexpected changes. Should I submit a PR to reverse the calls now?&lt;/p&gt;</comment>
                            <comment id="17139211" author="pnowojski" created="Thu, 18 Jun 2020 08:23:57 +0000"  >&lt;p&gt;I think I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt; that the place you pointed out &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; is not affecting this bug/illegal state exception. So this is on a verge of being release blocker.&lt;/p&gt;

&lt;p&gt;If you can work on this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt; that would be great. Just please note that we would need a fix for this very shortly. Could you also provide a unit test for this exact scenario? For example via injecting &lt;tt&gt;ConnectionManager&lt;/tt&gt; that would throw an &lt;tt&gt;ExpectedTestException&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="17139244" author="wind_ljy" created="Thu, 18 Jun 2020 09:06:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Okay. I&apos;ll submit a PR today.&lt;/p&gt;</comment>
                            <comment id="17139278" author="wind_ljy" created="Thu, 18 Jun 2020 10:03:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; I&apos;ve submitted a PR, please take a look. Thanks! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17139308" author="zjwang" created="Thu, 18 Jun 2020 10:53:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt; You are right, my previous mentioned usages will not cause this issue and it is indeed brought by FLIINK-16536 only.&lt;/p&gt;</comment>
                            <comment id="17143065" author="pnowojski" created="Tue, 23 Jun 2020 15:56:48 +0000"  >&lt;p&gt;merged to master as a32c99d2f1 release-1.11 as 52fa6abdb7&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fxsg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>