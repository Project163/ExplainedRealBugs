<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4563] [metrics] scope caching not adjusted for multiple reporters</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4563</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Every metric group contains a scope string, representing what entities (job/task/etc.) a given metric belongs to, which is calculated on demand. &lt;/p&gt;

&lt;p&gt;Before this string is cached a CharacterFilter is applied to it, which is provided by the callee, usually a reporter. This was done since different reporters have different requirements in regards to valid characters. The filtered string is cached so that we don&apos;t have to refilter the string every time.&lt;/p&gt;

&lt;p&gt;This all works fine with a single reporter; with multiple however it is completely broken as only the first filter is ever applied.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13002296">FLINK-4563</key>
            <summary>[metrics] scope caching not adjusted for multiple reporters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="anmu">Anton Mushin</assignee>
                                    <reporter username="chesnay">Chesnay Schepler</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Sep 2016 09:09:29 +0000</created>
                <updated>Thu, 8 Dec 2016 12:56:12 +0000</updated>
                            <resolved>Thu, 8 Dec 2016 12:55:56 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15506191" author="githubbot" created="Tue, 20 Sep 2016 09:43:57 +0000"  >&lt;p&gt;GitHub user ex00 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2516&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2516&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4563&quot; title=&quot;[metrics] scope caching not adjusted for multiple reporters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4563&quot;&gt;&lt;del&gt;FLINK-4563&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Delimiter should be configured per reporter&lt;/p&gt;

&lt;p&gt;    Hi&lt;br/&gt;
    It is my fix &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4563&quot; title=&quot;[metrics] scope caching not adjusted for multiple reporters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4563&quot;&gt;&lt;del&gt;FLINK-4563&lt;/del&gt;&lt;/a&gt;. I want fix this issue, please send me your comments about this implementation.&lt;br/&gt;
    I could assign to me &lt;span class=&quot;error&quot;&gt;&amp;#91;issue&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4564&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-4564&lt;/a&gt;) in jira?&lt;br/&gt;
    Thanks.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ex00/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ex00/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4564&quot; title=&quot;[metrics] Delimiter should be configured per reporter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4564&quot;&gt;&lt;del&gt;FLINK-4564&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2516.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2516.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2516&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 381026fbacd1616007c8ddb298853b64b98734df&lt;br/&gt;
Author: Anton Mushin &amp;lt;anton_mushin@epam.com&amp;gt;&lt;br/&gt;
Date:   2016-09-20T09:29:31Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4563&quot; title=&quot;[metrics] scope caching not adjusted for multiple reporters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4563&quot;&gt;&lt;del&gt;FLINK-4563&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Delimiter should be configured per reporter&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15525713" author="anmu" created="Tue, 27 Sep 2016 10:30:03 +0000"  >&lt;p&gt;Hello.&lt;br/&gt;
Do I correct undestand this issue, what next tests will be passed&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Test
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void filteringForMultipleReporters() {
		Configuration config = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration();
		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &lt;span class=&quot;code-quote&quot;&gt;&quot;A.B.C.D&quot;&lt;/span&gt;);
		config.setString(ConfigConstants.METRICS_REPORTERS_LIST, &lt;span class=&quot;code-quote&quot;&gt;&quot;test1,test2&quot;&lt;/span&gt;);
		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &lt;span class=&quot;code-quote&quot;&gt;&quot;test1.&quot;&lt;/span&gt; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter1.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName());
		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &lt;span class=&quot;code-quote&quot;&gt;&quot;test2.&quot;&lt;/span&gt; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter2.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName());

		MetricRegistry registry = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MetricRegistry(config);
		TaskManagerMetricGroup tmGroup = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaskManagerMetricGroup(registry, &lt;span class=&quot;code-quote&quot;&gt;&quot;host&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;);
		tmGroup.counter(1);

		registry.shutdown();
	}

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestReporter1 &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TestReporter {
		@Override
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; filterCharacters(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; input) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; input.replace(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;);
		}

		@Override
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void notifyOfAddedMetric(Metric metric, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; metricName, MetricGroup group) {
			assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;a.B.C.D.1&quot;&lt;/span&gt;, group.getMetricIdentifier(metricName, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;));
		}
	}

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestReporter2 &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TestReporter {
		@Override
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; filterCharacters(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; input) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; input.replace(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;);
		}
		@Override
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void notifyOfAddedMetric(Metric metric, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; metricName, MetricGroup group) {
			assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;A.b.C.D.1&quot;&lt;/span&gt;, group.getMetricIdentifier(metricName,&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;));
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and need save caching of scopeString in AbstractMetricGroup for each reporters ?&lt;/p&gt;</comment>
                            <comment id="15529170" author="zentol" created="Wed, 28 Sep 2016 10:11:34 +0000"  >&lt;p&gt;yes, those tests should pass. additionally though i would say that different filters for a single reporter should be noticed as well:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestReporter1 &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TestReporter {
		@Override
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; filterCharacters(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; input) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; input.replace(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;);
		}

		@Override
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void notifyOfAddedMetric(Metric metric, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; metricName, MetricGroup group) {
			assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;a.B.C.D.1&quot;&lt;/span&gt;, group.getMetricIdentifier(metricName, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;));
			assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;A.b.C.D.1&quot;&lt;/span&gt;, group.getMetricIdentifier(metricName, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CharacterFiler(...) {
						&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; input.replace(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;);}));
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that this test would never fail, as the exception in assertEquals should be catched and never propagated outwards. Second, you should be able to leverage the code in &lt;a href=&quot;https://github.com/apache/flink/pull/2517&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2517&lt;/a&gt; to differentiate between reporters.&lt;/p&gt;</comment>
                            <comment id="15529746" author="anmu" created="Wed, 28 Sep 2016 14:10:54 +0000"  >&lt;p&gt;I am understand. &lt;br/&gt;
I planning to fix this issue after merge &lt;a href=&quot;https://github.com/apache/flink/pull/2517&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2517&lt;/a&gt; or when PR will be accept.&lt;/p&gt;

&lt;p&gt;Now in AbstractMetricGroup#getMetricIdentifier() and for all calls getMetricIdentifier method scopeString once initialized.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getMetricIdentifier(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; metricName, CharacterFilter filter) {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (scopeString == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filter != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				scopeString = ScopeFormat.concat(filter, registry.getDelimiter(), scopeComponents);
			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
				scopeString = ScopeFormat.concat(registry.getDelimiter(), scopeComponents);
			}
		}

		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filter != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; scopeString + registry.getDelimiter() + filter.filterCharacters(metricName);
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; scopeString + registry.getDelimiter() + metricName;
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Do I need save this &quot;caching&quot; of scopeString for different filters? &lt;br/&gt;
It is variable using in 3 places class: &lt;br/&gt;
1 - in getMetricIdentifier() method&lt;br/&gt;
2 - in addGroup() method&lt;br/&gt;
3 - in addMetric() method&lt;br/&gt;
For 2 and 3 cases &apos;scopeString&apos; using for logging&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Example&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Name collision: Adding a metric with the same name as a metric subgroup: &apos;&quot;&lt;/span&gt; +
								name + &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-quote&quot;&gt;&apos;. Metric might not get properly reported. (&quot;&lt;/span&gt; + scopeString + &apos;&lt;/span&gt;)&apos;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As solution this issue I think what I can remove this variable from global scope and initialize it every time when call getMetric Identifier. But it is simple and most likely untrue solution.&lt;/p&gt;</comment>
                            <comment id="15529812" author="zentol" created="Wed, 28 Sep 2016 14:28:35 +0000"  >&lt;p&gt;I wouldn&apos;t store it for different filters for each reporter as it would require a Map&amp;lt;CharacterFilter, String&amp;gt; to be maintained and accessed on every call to getMetricIdentifier(). I would only store a version for the first filter that was used; if a second filter is used (which is unlikely anyway) we will re-create the identifier from scratch. I assume that, if getMetricIdentifier() was called with different filters, the calls are always made in succession, meaning that with this scheme we at least cache 50%.&lt;/p&gt;

&lt;p&gt;addMetric() and addGroup() should rely on the scopeComponents field for logging purposes, as it contains the scope in a generalized form.&lt;/p&gt;</comment>
                            <comment id="15529899" author="anmu" created="Wed, 28 Sep 2016 14:55:42 +0000"  >&lt;p&gt;Do you propose to caching last CharacterFilter which was called with method getMetricIdentifier() last time?&lt;/p&gt;</comment>
                            <comment id="15530310" author="zentol" created="Wed, 28 Sep 2016 17:30:48 +0000"  >&lt;p&gt;no, the exact opposite.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CharacterFIlter f1 = ...
CharacterFIlter f2 = ...

group.getMetricIdentifier(name, f1) -&amp;gt; cache
group.getMetricIndetifier(name, f2) -&amp;gt; not cached
group.getMetricIdentifier(name, f1) -&amp;gt; use cached string
group.getMetricIndetifier(name, f2) -&amp;gt; not cached
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15532305" author="anmu" created="Thu, 29 Sep 2016 09:37:39 +0000"  >&lt;p&gt;Ok this case if we get f1 in method we must return cached scopeString else for other filters we are create and return new scopeString.&lt;br/&gt;
code is for example, is it correct idea?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; scopeString;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; CharacterFilter firstFilter;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getMetricIdentifier(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; metricName, CharacterFilter filter) {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (firstFilter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; filter != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			firstFilter = filter;
			scopeString = ScopeFormat.concat(firstFilter, registry.getDelimiter(), scopeComponents);
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; scopeString + registry.getDelimiter() + filter.filterCharacters(metricName);
		}
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filter != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (firstFilter.equals(filter)) {
				 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; scopeString + registry.getDelimiter() + filter.filterCharacters(metricName);
			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
				&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; newScopeString = ScopeFormat.concat(filter, registry.getDelimiter(), scopeComponents);
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; newScopeString + registry.getDelimiter() + filter.filterCharacters(metricName);
			}
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; newScopeString = ScopeFormat.concat(registry.getDelimiter(), scopeComponents);
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; newScopeString + registry.getDelimiter() + metricName;
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15532338" author="zentol" created="Thu, 29 Sep 2016 09:53:01 +0000"  >&lt;p&gt;that looks about right.&lt;/p&gt;</comment>
                            <comment id="15532355" author="anmu" created="Thu, 29 Sep 2016 10:00:17 +0000"  >&lt;p&gt;Thanks. &lt;br/&gt;
Then I will wait resolution of PR &lt;a href=&quot;https://github.com/apache/flink/pull/2517&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2517&lt;/a&gt; and I will send PR for this issue after.&lt;/p&gt;</comment>
                            <comment id="15582287" author="githubbot" created="Mon, 17 Oct 2016 13:36:50 +0000"  >&lt;p&gt;GitHub user ex00 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4563&quot; title=&quot;[metrics] scope caching not adjusted for multiple reporters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4563&quot;&gt;&lt;del&gt;FLINK-4563&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; scope caching not adjusted for multiple reporters&lt;/p&gt;

&lt;p&gt;    Hello. &lt;br/&gt;
    It is implementation &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4563&quot; title=&quot;[metrics] scope caching not adjusted for multiple reporters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4563&quot;&gt;&lt;del&gt;FLINK-4563&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    In ``AbstractMetricGroup.java`` added characterFilter and firstReporterIndex for cached scopeString&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ex00/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ex00/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4563&quot; title=&quot;[metrics] scope caching not adjusted for multiple reporters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4563&quot;&gt;&lt;del&gt;FLINK-4563&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2650&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ad3034b4d9764426dd5f969b20c12aa3145cbf84&lt;br/&gt;
Author: Anton Mushin &amp;lt;anton_mushin@epam.com&amp;gt;&lt;br/&gt;
Date:   2016-10-17T13:23:01Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4563&quot; title=&quot;[metrics] scope caching not adjusted for multiple reporters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4563&quot;&gt;&lt;del&gt;FLINK-4563&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; scope caching not adjusted for multiple reporters&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15594730" author="githubbot" created="Fri, 21 Oct 2016 10:24:13 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    oh, I&apos;m afraid i misunderstood the code you posted in the JIRA; i assumed it was to showcase the behavior from the perspective of a single reporter. Instead of storing a single scopeString we should store N strings, where N is the number of reporters. In addition, N filters should be stored as well for comparison.&lt;/p&gt;</comment>
                            <comment id="15594760" author="githubbot" created="Fri, 21 Oct 2016 10:40:55 +0000"  >&lt;p&gt;Github user ex00 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for you review, zentol!&lt;br/&gt;
    &amp;gt;oh, I&apos;m afraid i misunderstood the code you posted in the JIRA; i assumed it was to showcase the behavior from the perspective of a single reporter. Instead of storing a single scopeString we should store N strings, where N is the number of reporters. In addition, N filters should be stored as well for comparison.&lt;/p&gt;

&lt;p&gt;    Do you propose replace ``CharacterFilter firstFilter`` to ``List&amp;lt;CharacterFilter&amp;gt; filters`` and  ``String scopeString`` to ``List &amp;lt;String&amp;gt; scopeString`` ? and we get scopeString and filter for reportes via reporterIndex&lt;/p&gt;
</comment>
                            <comment id="15595056" author="githubbot" created="Fri, 21 Oct 2016 13:23:44 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    correct; we could also use a `String[]` and `CharacterFilter[]`.&lt;/p&gt;</comment>
                            <comment id="15601894" author="githubbot" created="Mon, 24 Oct 2016 12:49:06 +0000"  >&lt;p&gt;Github user ex00 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hello. I pushed new changes.&lt;/p&gt;</comment>
                            <comment id="15608842" author="githubbot" created="Wed, 26 Oct 2016 15:54:39 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I would suggest to not cache the filters and try to catch the &quot;reporter uses changing filters&quot; case:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It sounds like pre-mature optimization. Since one can use multiple reporters, why use different formats?&lt;/li&gt;
	&lt;li&gt;If one really ever needs multiple formats, one can simply use multiple instances of the same reporter that accept different subsets of metrics&lt;/li&gt;
	&lt;li&gt;Most importantly, this actually disables the scope caching for a very common case, when the reporter simple provides a `new MyFilter()` to each scope building call. I bet that most users do not overwrite `equals()` on their character filters.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15615475" author="githubbot" created="Fri, 28 Oct 2016 13:54:52 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r85533847&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r85533847&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroup.java &amp;#8212;&lt;br/&gt;
    @@ -101,6 +105,8 @@ public AbstractMetricGroup(MetricRegistry registry, String[] scope, A parent) {&lt;br/&gt;
     		this.registry = checkNotNull(registry);&lt;br/&gt;
     		this.scopeComponents = checkNotNull(scope);&lt;br/&gt;
     		this.parent = parent;&lt;br/&gt;
    +		scopeStrings = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;registry.getReporters().size()&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    for consistency it would be neat to prefix these with `this.`.&lt;/p&gt;</comment>
                            <comment id="15615476" author="githubbot" created="Fri, 28 Oct 2016 13:54:52 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r85533501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r85533501&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroup.java &amp;#8212;&lt;br/&gt;
    @@ -169,19 +176,7 @@ public String getMetricIdentifier(String metricName) {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@return fully qualified metric name&lt;br/&gt;
     	 */&lt;br/&gt;
     	public String getMetricIdentifier(String metricName, CharacterFilter filter) {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (scopeString == null) {&lt;/li&gt;
	&lt;li&gt;if (filter != null) 
{
    -				scopeString = ScopeFormat.concat(filter, registry.getDelimiter(), scopeComponents);
    -			}
&lt;p&gt; else &lt;/p&gt;
{
    -				scopeString = ScopeFormat.concat(registry.getDelimiter(), scopeComponents);
    -			}&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (filter != null) 
{
    -			return scopeString + registry.getDelimiter() + filter.filterCharacters(metricName);
    -		}
&lt;p&gt; else &lt;/p&gt;
{
    -			return scopeString + registry.getDelimiter() + metricName;
    -		}
&lt;p&gt;    +		return getMetricIdentifier(metricName, filter, -1);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    If you call `getMetricIdentifier(...)` the reporter index will be passed to `MetricRegistry#getDelimiter()`. For a negative index this function logs a warning, assuming that some error has occurred that caused the index to be negative. Since you pass `-1` as the reporter index you will thus always trigger a warning.&lt;/p&gt;</comment>
                            <comment id="15615477" author="githubbot" created="Fri, 28 Oct 2016 13:54:52 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r85533745&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r85533745&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroup.java &amp;#8212;&lt;br/&gt;
    @@ -85,9 +86,12 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;For example &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;host-7&amp;quot;, &amp;quot;taskmanager-2&amp;quot;, &amp;quot;window_word_count&amp;quot;, &amp;quot;my-mapper&amp;quot; &amp;#93;&lt;/span&gt;. */&lt;br/&gt;
     	private final String[] scopeComponents;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** The metrics scope represented by this group, as a concatenated string, lazily computed.&lt;br/&gt;
    +	/** Array the metrics scope represented by this group, as a concatenated string, lazily computed.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    &quot;Array containing the metrics scope represented by this group for each reporter, ...&quot;&lt;/p&gt;</comment>
                            <comment id="15615479" author="githubbot" created="Fri, 28 Oct 2016 13:55:29 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    In hindsight I agree with @StephanEwen that caching the filter may be a bit overkill.&lt;/p&gt;</comment>
                            <comment id="15615536" author="githubbot" created="Fri, 28 Oct 2016 14:16:32 +0000"  >&lt;p&gt;Github user ex00 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen, @zentol thanks for your comments!&lt;br/&gt;
    Do need caching only first filter or don&apos;t cache any filter?&lt;/p&gt;</comment>
                            <comment id="15615598" author="githubbot" created="Fri, 28 Oct 2016 14:41:44 +0000"  >&lt;p&gt;Github user ex00 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r85543811&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r85543811&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroup.java &amp;#8212;&lt;br/&gt;
    @@ -169,19 +176,7 @@ public String getMetricIdentifier(String metricName) {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@return fully qualified metric name&lt;br/&gt;
     	 */&lt;br/&gt;
     	public String getMetricIdentifier(String metricName, CharacterFilter filter) {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (scopeString == null) {&lt;/li&gt;
	&lt;li&gt;if (filter != null) 
{
    -				scopeString = ScopeFormat.concat(filter, registry.getDelimiter(), scopeComponents);
    -			}
&lt;p&gt; else &lt;/p&gt;
{
    -				scopeString = ScopeFormat.concat(registry.getDelimiter(), scopeComponents);
    -			}&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (filter != null) 
{
    -			return scopeString + registry.getDelimiter() + filter.filterCharacters(metricName);
    -		}
&lt;p&gt; else &lt;/p&gt;
{
    -			return scopeString + registry.getDelimiter() + metricName;
    -		}
&lt;p&gt;    +		return getMetricIdentifier(metricName, filter, -1);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    if reporter index not &lt;span class=&quot;error&quot;&gt;&amp;#91;correct for array&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/flink/pull/2650/files#diff-3cbfc4ef461f4bac5ddd197c77fe19b1R191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650/files#diff-3cbfc4ef461f4bac5ddd197c77fe19b1R191&lt;/a&gt;) then in this block not use ``reporterIndex`` and call `MetricRegistry#getDelimiter()`&lt;br/&gt;
    I will change to&lt;br/&gt;
    ``` java&lt;br/&gt;
    if (scopeStrings.length == 0 || (reporterIndex &amp;lt; 0 || reporterIndex &amp;gt;= scopeStrings.length)) {&lt;br/&gt;
    			if (filter != null) &lt;/p&gt;
{
    				String newScopeString = ScopeFormat.concat(filter, registry.getDelimiter(), scopeComponents);
    				return newScopeString + registry.getDelimiter() + filter.filterCharacters(metricName);
    			}
&lt;p&gt; else &lt;/p&gt;
{
    				String newScopeString = ScopeFormat.concat(registry.getDelimiter(), scopeComponents);
    				return newScopeString + registry.getDelimiter() + metricName;
    			}
&lt;p&gt;    		}&lt;br/&gt;
    ```&lt;br/&gt;
    and warning message will not show&lt;/p&gt;
</comment>
                            <comment id="15615606" author="githubbot" created="Fri, 28 Oct 2016 14:45:07 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    don&apos;t cache any filter; we will assume that a single reporter will only pass identical filters.&lt;/p&gt;</comment>
                            <comment id="15650103" author="githubbot" created="Wed, 9 Nov 2016 07:48:46 +0000"  >&lt;p&gt;Github user ex00 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi&lt;br/&gt;
    Is last changes correct?&lt;/p&gt;</comment>
                            <comment id="15650174" author="githubbot" created="Wed, 9 Nov 2016 08:27:22 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    functionally it looks correct, I&apos;m just thinking abit how we may make the test a bit nicer; as using static fields across tests is prone to errors etc.&lt;/p&gt;</comment>
                            <comment id="15650348" author="githubbot" created="Wed, 9 Nov 2016 08:42:39 +0000"  >&lt;p&gt;Github user ex00 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I can remove ``staticCharacterFilter`` from global test class, and initialize filter in ``MetricRegistryTest`` how not static.  This is static filter doesn&apos;t apply in ``TestReporter*`` classes in all cases.&lt;br/&gt;
    What do you think about it?&lt;/p&gt;</comment>
                            <comment id="15663497" author="githubbot" created="Mon, 14 Nov 2016 11:13:03 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I don&apos;t mean the CharacterFilter, it&apos;s good that that one is static. I&apos;ll add a few more comments to point to problematic areas. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15663517" author="githubbot" created="Mon, 14 Nov 2016 11:20:50 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r86765901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r86765901&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroupTest.java &amp;#8212;&lt;br/&gt;
    @@ -44,4 +52,132 @@ protected QueryScopeInfo createQueryServiceMetricInfo(CharacterFilter filter) &lt;/p&gt;
{
     		
     		registry.shutdown();
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	// for test case: one filter for different reporters with different of scope delimiter&lt;br/&gt;
    +	protected static CharacterFilter staticCharacterFilter = new CharacterFilter() {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;C&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForMultipleReporters() {&lt;br/&gt;
    +		TestReporter1.countSuccessChecks = 0;&lt;br/&gt;
    +		Configuration config = new Configuration();&lt;br/&gt;
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);&lt;br/&gt;
    +		config.setString(ConfigConstants.METRICS_REPORTERS_LIST, &quot;test1,test2&quot;);&lt;br/&gt;
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter1.class.getName());&lt;br/&gt;
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter2.class.getName());&lt;br/&gt;
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;-&quot;);&lt;br/&gt;
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;!&quot;);&lt;br/&gt;
    +&lt;br/&gt;
    +&lt;br/&gt;
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));&lt;br/&gt;
    +		TaskManagerMetricGroup tmGroup = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);&lt;br/&gt;
    +		tmGroup.counter(1);&lt;br/&gt;
    +		testRegistry.shutdown();&lt;br/&gt;
    +		assert TestReporter1.countSuccessChecks == 4;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    for consistency purposes this should be replaced with `assertEquals(4, TestReporter1.countSuccessChecks)`.&lt;/p&gt;</comment>
                            <comment id="15663516" author="githubbot" created="Mon, 14 Nov 2016 11:20:50 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r86991226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r86991226&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroupTest.java &amp;#8212;&lt;br/&gt;
    @@ -44,4 +52,132 @@ protected QueryScopeInfo createQueryServiceMetricInfo(CharacterFilter filter) &lt;/p&gt;
{
     		
     		registry.shutdown();
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	// for test case: one filter for different reporters with different of scope delimiter&lt;br/&gt;
    +	protected static CharacterFilter staticCharacterFilter = new CharacterFilter() {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;C&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForMultipleReporters() &lt;/p&gt;
{
    +		TestReporter1.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTERS_LIST, &quot;test1,test2&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter1.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter2.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;-&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;!&quot;);
    +
    +
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroup = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		tmGroup.counter(1);
    +		testRegistry.shutdown();
    +		assert TestReporter1.countSuccessChecks == 4;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForNullReporters() {&lt;br/&gt;
    +		MetricRegistryTest.countSuccessChecks = 0;&lt;br/&gt;
    +		Configuration config = new Configuration();&lt;br/&gt;
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);&lt;br/&gt;
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));&lt;br/&gt;
    +		TaskManagerMetricGroup tmGroupForTestRegistry = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);&lt;br/&gt;
    +		assert testRegistry.getReporters().size() == 0;&lt;br/&gt;
    +		tmGroupForTestRegistry.counter(1);&lt;br/&gt;
    +		testRegistry.shutdown();&lt;br/&gt;
    +		assert MetricRegistryTest.countSuccessChecks == 1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    same as above&lt;/p&gt;</comment>
                            <comment id="15663518" author="githubbot" created="Mon, 14 Nov 2016 11:20:50 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r87780439&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r87780439&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroupTest.java &amp;#8212;&lt;br/&gt;
    @@ -44,4 +52,132 @@ protected QueryScopeInfo createQueryServiceMetricInfo(CharacterFilter filter) &lt;/p&gt;
{
     		
     		registry.shutdown();
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	// for test case: one filter for different reporters with different of scope delimiter&lt;br/&gt;
    +	protected static CharacterFilter staticCharacterFilter = new CharacterFilter() {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;C&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForMultipleReporters() &lt;/p&gt;
{
    +		TestReporter1.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTERS_LIST, &quot;test1,test2&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter1.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter2.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;-&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;!&quot;);
    +
    +
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroup = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		tmGroup.counter(1);
    +		testRegistry.shutdown();
    +		assert TestReporter1.countSuccessChecks == 4;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForNullReporters() &lt;/p&gt;
{
    +		MetricRegistryTest.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroupForTestRegistry = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		assert testRegistry.getReporters().size() == 0;
    +		tmGroupForTestRegistry.counter(1);
    +		testRegistry.shutdown();
    +		assert MetricRegistryTest.countSuccessChecks == 1;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static class TestReporter1 extends TestReporter {&lt;br/&gt;
    +		protected static int countSuccessChecks = 0;&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;A&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +		@Override&lt;br/&gt;
    +		public void notifyOfAddedMetric(Metric metric, String metricName, MetricGroup group) {&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName));&lt;br/&gt;
    +			// ignore all next filters for scope -  because scopeString cached with only first filter&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName, staticCharacterFilter));&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName, this));&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-4&quot;, group.getMetricIdentifier(metricName, new CharacterFilter() {&lt;br/&gt;
    +				@Override&lt;br/&gt;
    +				public String filterCharacters(String input) &lt;/p&gt;
{
    +					return input.replace(&quot;B&quot;, &quot;RR&quot;).replace(&quot;1&quot;, &quot;4&quot;);
    +				}
&lt;p&gt;    +			}));&lt;br/&gt;
    +			countSuccessChecks++;&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +	public static class TestReporter2 extends TestReporter1 {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;B&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +		@Override&lt;br/&gt;
    +		public void notifyOfAddedMetric(Metric metric, String metricName, MetricGroup group) {&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName, this));&lt;br/&gt;
    +			// ignore all next filters -  because scopeString cached with only first filter&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName));&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName, staticCharacterFilter));&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!3&quot;, group.getMetricIdentifier(metricName, new CharacterFilter() {&lt;br/&gt;
    +				@Override&lt;br/&gt;
    +				public String filterCharacters(String input) &lt;/p&gt;
{
    +					return input.replace(&quot;A&quot;, &quot;RR&quot;).replace(&quot;1&quot;, &quot;3&quot;);
    +				}
&lt;p&gt;    +			}));&lt;br/&gt;
    +			countSuccessChecks++;&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +	static class MetricRegistryTest extends MetricRegistry {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    for clarity this class should be named `TestMetricRegistry`.&lt;/p&gt;</comment>
                            <comment id="15663519" author="githubbot" created="Mon, 14 Nov 2016 11:20:50 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r87781446&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r87781446&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroupTest.java &amp;#8212;&lt;br/&gt;
    @@ -44,4 +52,132 @@ protected QueryScopeInfo createQueryServiceMetricInfo(CharacterFilter filter) &lt;/p&gt;
{
     		
     		registry.shutdown();
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	// for test case: one filter for different reporters with different of scope delimiter&lt;br/&gt;
    +	protected static CharacterFilter staticCharacterFilter = new CharacterFilter() {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;C&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForMultipleReporters() &lt;/p&gt;
{
    +		TestReporter1.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTERS_LIST, &quot;test1,test2&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter1.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter2.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;-&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;!&quot;);
    +
    +
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroup = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		tmGroup.counter(1);
    +		testRegistry.shutdown();
    +		assert TestReporter1.countSuccessChecks == 4;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForNullReporters() &lt;/p&gt;
{
    +		MetricRegistryTest.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroupForTestRegistry = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		assert testRegistry.getReporters().size() == 0;
    +		tmGroupForTestRegistry.counter(1);
    +		testRegistry.shutdown();
    +		assert MetricRegistryTest.countSuccessChecks == 1;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static class TestReporter1 extends TestReporter {&lt;br/&gt;
    +		protected static int countSuccessChecks = 0;&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;A&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +		@Override&lt;br/&gt;
    +		public void notifyOfAddedMetric(Metric metric, String metricName, MetricGroup group) {&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName));&lt;br/&gt;
    +			// ignore all next filters for scope -  because scopeString cached with only first filter&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName, staticCharacterFilter));&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName, this));&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-4&quot;, group.getMetricIdentifier(metricName, new CharacterFilter() {&lt;br/&gt;
    +				@Override&lt;br/&gt;
    +				public String filterCharacters(String input) &lt;/p&gt;
{
    +					return input.replace(&quot;B&quot;, &quot;RR&quot;).replace(&quot;1&quot;, &quot;4&quot;);
    +				}
&lt;p&gt;    +			}));&lt;br/&gt;
    +			countSuccessChecks++;&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +	public static class TestReporter2 extends TestReporter1 {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This is a weird inheritance chain. It would make more sense to create a common ScopeCheckingTestReporter class that encapsulates the counting, with an abstract method `checkScopes(Metric metric, String metricName, MetricGroup group)`.&lt;br/&gt;
    The specific checks are then done in subclasses of that class.&lt;/p&gt;</comment>
                            <comment id="15663520" author="githubbot" created="Mon, 14 Nov 2016 11:20:50 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r87780651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r87780651&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroupTest.java &amp;#8212;&lt;br/&gt;
    @@ -44,4 +52,132 @@ protected QueryScopeInfo createQueryServiceMetricInfo(CharacterFilter filter) &lt;/p&gt;
{
     		
     		registry.shutdown();
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	// for test case: one filter for different reporters with different of scope delimiter&lt;br/&gt;
    +	protected static CharacterFilter staticCharacterFilter = new CharacterFilter() {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;C&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForMultipleReporters() &lt;/p&gt;
{
    +		TestReporter1.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTERS_LIST, &quot;test1,test2&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter1.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter2.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;-&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;!&quot;);
    +
    +
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroup = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		tmGroup.counter(1);
    +		testRegistry.shutdown();
    +		assert TestReporter1.countSuccessChecks == 4;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForNullReporters() &lt;/p&gt;
{
    +		MetricRegistryTest.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroupForTestRegistry = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		assert testRegistry.getReporters().size() == 0;
    +		tmGroupForTestRegistry.counter(1);
    +		testRegistry.shutdown();
    +		assert MetricRegistryTest.countSuccessChecks == 1;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static class TestReporter1 extends TestReporter {&lt;br/&gt;
    +		protected static int countSuccessChecks = 0;&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;A&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +		@Override&lt;br/&gt;
    +		public void notifyOfAddedMetric(Metric metric, String metricName, MetricGroup group) {&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName));&lt;br/&gt;
    +			// ignore all next filters for scope -  because scopeString cached with only first filter&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName, staticCharacterFilter));&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName, this));&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-4&quot;, group.getMetricIdentifier(metricName, new CharacterFilter() {&lt;br/&gt;
    +				@Override&lt;br/&gt;
    +				public String filterCharacters(String input) &lt;/p&gt;
{
    +					return input.replace(&quot;B&quot;, &quot;RR&quot;).replace(&quot;1&quot;, &quot;4&quot;);
    +				}
&lt;p&gt;    +			}));&lt;br/&gt;
    +			countSuccessChecks++;&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +	public static class TestReporter2 extends TestReporter1 {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;B&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +		@Override&lt;br/&gt;
    +		public void notifyOfAddedMetric(Metric metric, String metricName, MetricGroup group) {&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName, this));&lt;br/&gt;
    +			// ignore all next filters -  because scopeString cached with only first filter&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName));&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName, staticCharacterFilter));&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!3&quot;, group.getMetricIdentifier(metricName, new CharacterFilter() {&lt;br/&gt;
    +				@Override&lt;br/&gt;
    +				public String filterCharacters(String input) &lt;/p&gt;
{
    +					return input.replace(&quot;A&quot;, &quot;RR&quot;).replace(&quot;1&quot;, &quot;3&quot;);
    +				}
&lt;p&gt;    +			}));&lt;br/&gt;
    +			countSuccessChecks++;&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +	static class MetricRegistryTest extends MetricRegistry {&lt;br/&gt;
    +		protected static int countSuccessChecks = 0;&lt;br/&gt;
    +		public MetricRegistryTest(MetricRegistryConfiguration config) &lt;/p&gt;
{
    +			super(config);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		void checkMethod(Metric metric, String metricName, AbstractMetricGroup group) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    this method can be private and must have a more descriptive name. it should also be located below the register method.&lt;/p&gt;</comment>
                            <comment id="15663521" author="githubbot" created="Mon, 14 Nov 2016 11:20:50 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r87781042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r87781042&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroupTest.java &amp;#8212;&lt;br/&gt;
    @@ -44,4 +52,132 @@ protected QueryScopeInfo createQueryServiceMetricInfo(CharacterFilter filter) &lt;/p&gt;
{
     		
     		registry.shutdown();
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	// for test case: one filter for different reporters with different of scope delimiter&lt;br/&gt;
    +	protected static CharacterFilter staticCharacterFilter = new CharacterFilter() {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;C&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForMultipleReporters() &lt;/p&gt;
{
    +		TestReporter1.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTERS_LIST, &quot;test1,test2&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter1.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter2.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;-&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;!&quot;);
    +
    +
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroup = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		tmGroup.counter(1);
    +		testRegistry.shutdown();
    +		assert TestReporter1.countSuccessChecks == 4;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForNullReporters() &lt;/p&gt;
{
    +		MetricRegistryTest.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroupForTestRegistry = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		assert testRegistry.getReporters().size() == 0;
    +		tmGroupForTestRegistry.counter(1);
    +		testRegistry.shutdown();
    +		assert MetricRegistryTest.countSuccessChecks == 1;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static class TestReporter1 extends TestReporter {&lt;br/&gt;
    +		protected static int countSuccessChecks = 0;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    we can store these in a field instead. We can retrieve all reporters from the registry and cast them to the required type, and use a new getter to retrieve the count.&lt;/p&gt;</comment>
                            <comment id="15663522" author="githubbot" created="Mon, 14 Nov 2016 11:20:50 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r87780687&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r87780687&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroupTest.java &amp;#8212;&lt;br/&gt;
    @@ -44,4 +52,132 @@ protected QueryScopeInfo createQueryServiceMetricInfo(CharacterFilter filter) &lt;/p&gt;
{
     		
     		registry.shutdown();
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	// for test case: one filter for different reporters with different of scope delimiter&lt;br/&gt;
    +	protected static CharacterFilter staticCharacterFilter = new CharacterFilter() {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;C&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForMultipleReporters() &lt;/p&gt;
{
    +		TestReporter1.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTERS_LIST, &quot;test1,test2&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter1.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter2.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;-&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;!&quot;);
    +
    +
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroup = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		tmGroup.counter(1);
    +		testRegistry.shutdown();
    +		assert TestReporter1.countSuccessChecks == 4;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForNullReporters() &lt;/p&gt;
{
    +		MetricRegistryTest.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroupForTestRegistry = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		assert testRegistry.getReporters().size() == 0;
    +		tmGroupForTestRegistry.counter(1);
    +		testRegistry.shutdown();
    +		assert MetricRegistryTest.countSuccessChecks == 1;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static class TestReporter1 extends TestReporter {&lt;br/&gt;
    +		protected static int countSuccessChecks = 0;&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;A&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +		@Override&lt;br/&gt;
    +		public void notifyOfAddedMetric(Metric metric, String metricName, MetricGroup group) {&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName));&lt;br/&gt;
    +			// ignore all next filters for scope -  because scopeString cached with only first filter&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName, staticCharacterFilter));&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName, this));&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-4&quot;, group.getMetricIdentifier(metricName, new CharacterFilter() {&lt;br/&gt;
    +				@Override&lt;br/&gt;
    +				public String filterCharacters(String input) &lt;/p&gt;
{
    +					return input.replace(&quot;B&quot;, &quot;RR&quot;).replace(&quot;1&quot;, &quot;4&quot;);
    +				}
&lt;p&gt;    +			}));&lt;br/&gt;
    +			countSuccessChecks++;&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +	public static class TestReporter2 extends TestReporter1 {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;B&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +		@Override&lt;br/&gt;
    +		public void notifyOfAddedMetric(Metric metric, String metricName, MetricGroup group) {&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName, this));&lt;br/&gt;
    +			// ignore all next filters -  because scopeString cached with only first filter&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName));&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName, staticCharacterFilter));&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!3&quot;, group.getMetricIdentifier(metricName, new CharacterFilter() {&lt;br/&gt;
    +				@Override&lt;br/&gt;
    +				public String filterCharacters(String input) &lt;/p&gt;
{
    +					return input.replace(&quot;A&quot;, &quot;RR&quot;).replace(&quot;1&quot;, &quot;3&quot;);
    +				}
&lt;p&gt;    +			}));&lt;br/&gt;
    +			countSuccessChecks++;&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +	static class MetricRegistryTest extends MetricRegistry {&lt;br/&gt;
    +		protected static int countSuccessChecks = 0;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Since we have access to the MetricRegistryTest object we can use a non-static field instead.&lt;/p&gt;</comment>
                            <comment id="15667036" author="githubbot" created="Tue, 15 Nov 2016 12:40:50 +0000"  >&lt;p&gt;Github user ex00 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650#discussion_r88007685&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650#discussion_r88007685&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroupTest.java &amp;#8212;&lt;br/&gt;
    @@ -44,4 +52,132 @@ protected QueryScopeInfo createQueryServiceMetricInfo(CharacterFilter filter) &lt;/p&gt;
{
     		
     		registry.shutdown();
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	// for test case: one filter for different reporters with different of scope delimiter&lt;br/&gt;
    +	protected static CharacterFilter staticCharacterFilter = new CharacterFilter() {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;C&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForMultipleReporters() &lt;/p&gt;
{
    +		TestReporter1.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTERS_LIST, &quot;test1,test2&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter1.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX, TestReporter2.class.getName());
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test1.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;-&quot;);
    +		config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + &quot;test2.&quot; + ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, &quot;!&quot;);
    +
    +
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroup = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		tmGroup.counter(1);
    +		testRegistry.shutdown();
    +		assert TestReporter1.countSuccessChecks == 4;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void filteringForNullReporters() &lt;/p&gt;
{
    +		MetricRegistryTest.countSuccessChecks = 0;
    +		Configuration config = new Configuration();
    +		config.setString(ConfigConstants.METRICS_SCOPE_NAMING_TM, &quot;A.B.C.D&quot;);
    +		MetricRegistry testRegistry = new MetricRegistryTest(MetricRegistryConfiguration.fromConfiguration(config));
    +		TaskManagerMetricGroup tmGroupForTestRegistry = new TaskManagerMetricGroup(testRegistry, &quot;host&quot;, &quot;id&quot;);
    +		assert testRegistry.getReporters().size() == 0;
    +		tmGroupForTestRegistry.counter(1);
    +		testRegistry.shutdown();
    +		assert MetricRegistryTest.countSuccessChecks == 1;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static class TestReporter1 extends TestReporter {&lt;br/&gt;
    +		protected static int countSuccessChecks = 0;&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;A&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +		@Override&lt;br/&gt;
    +		public void notifyOfAddedMetric(Metric metric, String metricName, MetricGroup group) {&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName));&lt;br/&gt;
    +			// ignore all next filters for scope -  because scopeString cached with only first filter&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName, staticCharacterFilter));&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-1&quot;, group.getMetricIdentifier(metricName, this));&lt;br/&gt;
    +			assertEquals(&quot;A-B-C-D-4&quot;, group.getMetricIdentifier(metricName, new CharacterFilter() {&lt;br/&gt;
    +				@Override&lt;br/&gt;
    +				public String filterCharacters(String input) &lt;/p&gt;
{
    +					return input.replace(&quot;B&quot;, &quot;RR&quot;).replace(&quot;1&quot;, &quot;4&quot;);
    +				}
&lt;p&gt;    +			}));&lt;br/&gt;
    +			countSuccessChecks++;&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +	public static class TestReporter2 extends TestReporter1 {&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String filterCharacters(String input) &lt;/p&gt;
{
    +			return input.replace(&quot;B&quot;, &quot;RR&quot;);
    +		}
&lt;p&gt;    +		@Override&lt;br/&gt;
    +		public void notifyOfAddedMetric(Metric metric, String metricName, MetricGroup group) {&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName, this));&lt;br/&gt;
    +			// ignore all next filters -  because scopeString cached with only first filter&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName));&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!1&quot;, group.getMetricIdentifier(metricName, staticCharacterFilter));&lt;br/&gt;
    +			assertEquals(&quot;A!RR!C!D!3&quot;, group.getMetricIdentifier(metricName, new CharacterFilter() {&lt;br/&gt;
    +				@Override&lt;br/&gt;
    +				public String filterCharacters(String input) &lt;/p&gt;
{
    +					return input.replace(&quot;A&quot;, &quot;RR&quot;).replace(&quot;1&quot;, &quot;3&quot;);
    +				}
&lt;p&gt;    +			}));&lt;br/&gt;
    +			countSuccessChecks++;&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +	static class MetricRegistryTest extends MetricRegistry {&lt;br/&gt;
    +		protected static int countSuccessChecks = 0;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Any error in ``checkMethod``  is calling fail test. We can&apos;t get some errors from the ``super.register`` because all errors is logging in it. &lt;br/&gt;
    That&apos;s why I think that this field is not necessary.&lt;/p&gt;</comment>
                            <comment id="15667153" author="githubbot" created="Tue, 15 Nov 2016 13:36:16 +0000"  >&lt;p&gt;Github user ex00 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @zentol, thanks for your review and comments!&lt;br/&gt;
    I updated tests.&lt;/p&gt;
</comment>
                            <comment id="15683437" author="githubbot" created="Mon, 21 Nov 2016 12:17:22 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think this looks good now, starting to merge it.&lt;/p&gt;</comment>
                            <comment id="15732135" author="zentol" created="Thu, 8 Dec 2016 12:55:57 +0000"  >&lt;p&gt;Implemented in 86f784a3613ccd5d78197d94198a64b6f1333578&lt;/p&gt;</comment>
                            <comment id="15732138" author="githubbot" created="Thu, 8 Dec 2016 12:56:12 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2650&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i336c7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>