<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7784] Don&apos;t fail TwoPhaseCommitSinkFunction when failing to commit</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7784</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently, &lt;tt&gt;TwoPhaseCommitSinkFunction&lt;/tt&gt; will fail if committing fails (either when doing it via the completed checkpoint notification or when trying to commit after restoring after failure). This means that the job will go into an infinite recovery loop because we will always keep failing.&lt;/p&gt;

&lt;p&gt;In some cases it might be better to ignore those failures and keep on processing and this should be the default. We can provide an option that allows failing the sink on failing commits.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13107993">FLINK-7784</key>
            <summary>Don&apos;t fail TwoPhaseCommitSinkFunction when failing to commit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gjy">Gary Yao</assignee>
                                    <reporter username="aljoscha">Aljoscha Krettek</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 9 Oct 2017 14:40:39 +0000</created>
                <updated>Fri, 15 Jul 2022 14:33:49 +0000</updated>
                            <resolved>Thu, 2 Nov 2017 15:04:22 +0000</resolved>
                                    <version>1.4.0</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16215088" author="pnowojski" created="Mon, 23 Oct 2017 12:54:28 +0000"  >&lt;p&gt;Are we sure that we want to ignore such failures by default? The same issue that&apos;s described here for &lt;tt&gt;TwoPhaseCommitSinkFunction&lt;/tt&gt; applies also to &lt;tt&gt;BucketingSink&lt;/tt&gt; and in both places, if we ignore those failures in case of intermittent errors, there will be a data loss &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16215173" author="aljoscha" created="Mon, 23 Oct 2017 14:01:03 +0000"  >&lt;p&gt;Not by default, but with a configuration setting.&lt;/p&gt;</comment>
                            <comment id="16220957" author="githubbot" created="Thu, 26 Oct 2017 18:24:29 +0000"  >&lt;p&gt;GitHub user GJL opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7784&quot; title=&quot;Don&amp;#39;t fail TwoPhaseCommitSinkFunction when failing to commit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7784&quot;&gt;&lt;del&gt;FLINK-7784&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-producer&amp;#93;&lt;/span&gt; Don&apos;t fail TwoPhaseCommitSinkFunction when failing to commit during job recovery&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;br/&gt;
    This makes it possible to configure the TwoPhaseCommitSinkFunction&apos;s behaviour w.r.t. transaction timeouts.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Introduce transaction timeouts to TwoPhaseCommitSinkFunction.&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Timeout can be used to generate warnings if the transaction&apos;s age approaches the timeout.&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;If an exception is thrown during job recovery, the sink can be configured not to propagate the exception and instead log it on ERROR level.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;br/&gt;
    This change added tests and can be verified as follows:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Extended unit tests for TwoPhaseCommitSinkFunction to test added functionality&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Manually verified the change by running a job with a FlinkKafka011Producer with checkpoint interval 27000 and transaction.timeout.ms = 30000. Warnings were generated correctly.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (*&lt;b&gt;yes&lt;/b&gt;* / no)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (*&lt;b&gt;yes&lt;/b&gt;* / no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable / docs / *&lt;b&gt;JavaDocs&lt;/b&gt;* / not documented)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/GJL/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/GJL/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7784&quot; title=&quot;Don&amp;#39;t fail TwoPhaseCommitSinkFunction when failing to commit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7784&quot;&gt;&lt;del&gt;FLINK-7784&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4910&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 23ae221eb854ce12572988aed5c018aac8919af7&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-10-26T17:17:55Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7784&quot; title=&quot;Don&amp;#39;t fail TwoPhaseCommitSinkFunction when failing to commit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7784&quot;&gt;&lt;del&gt;FLINK-7784&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka011-producer&amp;#93;&lt;/span&gt; Make TwoPhaseCommitSinkFunction aware of transaction timeouts.&lt;/p&gt;

&lt;p&gt;    TwoPhaseCommitSinkFunction allows to configure a transaction timeout. The&lt;br/&gt;
    timeout can be used to log warnings if the transaction&apos;s age is appraoching&lt;br/&gt;
    the timeout, and it can be used to swallow exceptions that are likely&lt;br/&gt;
    irrecoverable. This commit also integrates these changes to the&lt;br/&gt;
    FlinkKafkaProducer011.&lt;/p&gt;

&lt;p&gt;commit 43103c1fb61a6bc1aec6b19c0253fcca281cfba5&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-10-26T17:25:35Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-tests&amp;#93;&lt;/span&gt; Clean up FlinkKafkaProducer011Tests&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16220959" author="githubbot" created="Thu, 26 Oct 2017 18:24:39 +0000"  >&lt;p&gt;Github user GJL commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @aljoscha &lt;/p&gt;</comment>
                            <comment id="16224573" author="githubbot" created="Mon, 30 Oct 2017 09:52:56 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The changes look very good! @pnowojski could you please also have a look at this?&lt;/p&gt;</comment>
                            <comment id="16224666" author="githubbot" created="Mon, 30 Oct 2017 11:03:01 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147656635&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147656635&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Specifies the maximum time a transaction should remain open.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private long transactionTimeout = Long.MAX_VALUE;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If true, any exception thrown in &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; will be caught instead of&lt;br/&gt;
    +	 * propagated.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private boolean failureOnCommitAfterTransactionTimeoutDisabled;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    rename to `propagateTransactionTimeouts` or `ignoreTransactionTimeouts`&lt;/p&gt;</comment>
                            <comment id="16224667" author="githubbot" created="Mon, 30 Oct 2017 11:03:01 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147653427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147653427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java &amp;#8212;&lt;br/&gt;
    @@ -442,13 +445,31 @@ public FlinkKafkaProducer011(&lt;br/&gt;
     			throw new IllegalArgumentException(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG + &quot; must be supplied in the producer config properties.&quot;);&lt;br/&gt;
     		}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!producerConfig.contains(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG)) {&lt;br/&gt;
    +		if (!producerConfig.containsKey(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG)) 
{
     			long timeout = DEFAULT_KAFKA_TRANSACTION_TIMEOUT.toMilliseconds();
     			checkState(timeout &amp;lt; Integer.MAX_VALUE &amp;amp;&amp;amp; timeout &amp;gt; 0, &quot;timeout does not fit into 32 bit integer&quot;);
     			this.producerConfig.put(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG, (int) timeout);
     			LOG.warn(&quot;Property [%s] not specified. Setting it to %s&quot;, ProducerConfig.TRANSACTION_TIMEOUT_CONFIG, DEFAULT_KAFKA_TRANSACTION_TIMEOUT);
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +		// Enable transactionTimeoutWarnings to avoid silent data loss&lt;br/&gt;
    +		// See &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6119&quot; title=&quot;Silent Data Loss in Kafka011 Transactional Producer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6119&quot;&gt;&lt;del&gt;KAFKA-6119&lt;/del&gt;&lt;/a&gt; (affects versions 0.11.0.0 and 0.11.0.1):&lt;br/&gt;
    +		// The KafkaProducer may not throw an exception if the transaction failed to commit&lt;br/&gt;
    +		if (semantic == Semantic.EXACTLY_ONCE) {&lt;br/&gt;
    +			final Object object = this.producerConfig.get(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: Don&apos;t we have somewhere implemented similar/same parsing/reading numeric logic?&lt;/p&gt;</comment>
                            <comment id="16224668" author="githubbot" created="Mon, 30 Oct 2017 11:03:01 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147655000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147655000&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java &amp;#8212;&lt;br/&gt;
    @@ -922,6 +945,22 @@ private void readObject(java.io.ObjectInputStream in) throws IOException, ClassN&lt;br/&gt;
     		producersPool = new ProducersPool();&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Disables the propagation of exceptions thrown when committing presumably timed out Kafka&lt;br/&gt;
    +	 * transactions during recovery of the job. If a Kafka transaction is timed out, a commit will&lt;br/&gt;
    +	 * never be successful. Hence, use this feature to avoid recovery loops of the Job. Exceptions&lt;br/&gt;
    +	 * will still be logged to inform the user that data loss might have occurred.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;Note that we use &lt;/p&gt;
{@link System#currentTimeMillis()}
&lt;p&gt; to track the age of a transaction.&lt;br/&gt;
    +	 * Moreover, only exceptions thrown during the recovery are caught, i.e., the producer will&lt;br/&gt;
    +	 * attempt at least one commit of the transaction before giving up.&amp;lt;/p&amp;gt;&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public FlinkKafkaProducer011&amp;lt;IN&amp;gt; disableFailurePropagationAfterTransactionTimeout() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: Please move this method to the top, somewhere around `setLogFailuresOnly`&lt;/p&gt;</comment>
                            <comment id="16224669" author="githubbot" created="Mon, 30 Oct 2017 11:03:01 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147662205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147662205&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -362,4 +483,39 @@ public void setContext(Optional&amp;lt;CONTEXT&amp;gt; context) &lt;/p&gt;
{
     			this.context = context;
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Adds metadata (currently only the start time of the transaction) to the transaction object.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	static class TransactionHolder&amp;lt;TXN&amp;gt; {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `TransactionWrapper`? &lt;/p&gt;</comment>
                            <comment id="16224670" author="githubbot" created="Mon, 30 Oct 2017 11:03:01 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147659966&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147659966&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    please rename this field, it&apos;s clashing with `currentTransaction()` method, which is confusing, especially that they have different types.&lt;/p&gt;</comment>
                            <comment id="16224671" author="githubbot" created="Mon, 30 Oct 2017 11:03:01 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147661454&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147661454&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -293,26 +330,110 @@ public void initializeState(FunctionInitializationContext context) throws Except&lt;br/&gt;
     		}&lt;br/&gt;
     		// if in restore we didn&apos;t get any userContext or we are initializing from scratch&lt;br/&gt;
     		if (userContext == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;{} - no state to restore&quot;, name());&lt;br/&gt;
    +			log.info(&quot;{} - no state to restore&quot;, name());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			userContext = initializeUserContext();&lt;br/&gt;
     		}&lt;br/&gt;
     		this.pendingCommitTransactions.clear();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;currentTransaction = beginTransaction();&lt;/li&gt;
	&lt;li&gt;LOG.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +		currentTransaction = beginTransaction0();&lt;br/&gt;
    +		log.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This method must be the only place to call 
{@link #beginTransaction()}
&lt;p&gt; to ensure that the&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link TransactionHolder}
&lt;p&gt; is created at the same time.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; beginTransaction0() throws Exception &lt;/p&gt;
{
    +		return new TransactionHolder&amp;lt;&amp;gt;(beginTransaction(), clock.millis());
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This method must be the only place to call &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; to ensure that&lt;br/&gt;
    +	 * the configuration parameters &lt;/p&gt;
{@link #transactionTimeout}
&lt;p&gt; and&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link #failureOnCommitAfterTransactionTimeoutDisabled}
&lt;p&gt; are respected.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private void recoverAndCommit(TransactionHolder&amp;lt;TXN&amp;gt; transactionHolder) {&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			logWarningIfTimeoutAlmostReached(transactionHolder);
    +			recoverAndCommit(transactionHolder.handle);
    +		}
&lt;p&gt; catch (final Exception e) {&lt;br/&gt;
    +			final long elapsedTime = clock.millis() - transactionHolder.transactionStartTime;&lt;br/&gt;
    +			if (failureOnCommitAfterTransactionTimeoutDisabled &amp;amp;&amp;amp; elapsedTime &amp;gt; transactionTimeout) {&lt;br/&gt;
    +				log.error(&quot;Error while committing transaction {}. &quot; +&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    `&quot;Error while committing transaction {}. Data loss might occurred&quot;` &lt;/p&gt;</comment>
                            <comment id="16224672" author="githubbot" created="Mon, 30 Oct 2017 11:03:01 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147661097&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147661097&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -293,26 +330,110 @@ public void initializeState(FunctionInitializationContext context) throws Except&lt;br/&gt;
     		}&lt;br/&gt;
     		// if in restore we didn&apos;t get any userContext or we are initializing from scratch&lt;br/&gt;
     		if (userContext == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;{} - no state to restore&quot;, name());&lt;br/&gt;
    +			log.info(&quot;{} - no state to restore&quot;, name());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			userContext = initializeUserContext();&lt;br/&gt;
     		}&lt;br/&gt;
     		this.pendingCommitTransactions.clear();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;currentTransaction = beginTransaction();&lt;/li&gt;
	&lt;li&gt;LOG.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +		currentTransaction = beginTransaction0();&lt;br/&gt;
    +		log.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This method must be the only place to call 
{@link #beginTransaction()}
&lt;p&gt; to ensure that the&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link TransactionHolder}
&lt;p&gt; is created at the same time.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; beginTransaction0() throws Exception &lt;/p&gt;
{
    +		return new TransactionHolder&amp;lt;&amp;gt;(beginTransaction(), clock.millis());
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This method must be the only place to call &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; to ensure that&lt;br/&gt;
    +	 * the configuration parameters &lt;/p&gt;
{@link #transactionTimeout}
&lt;p&gt; and&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link #failureOnCommitAfterTransactionTimeoutDisabled}
&lt;p&gt; are respected.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private void recoverAndCommit(TransactionHolder&amp;lt;TXN&amp;gt; transactionHolder) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    ditto: overloading adds confusion, because it suggests that both methods (`recoverAndCommit(TXN)` and `recoverAndCommit(TransactionHolder)`) are equally valid and could be used interchangeably. &lt;/p&gt;

&lt;p&gt;    As above, rename to `recoverAndCommitHolder`, `recoverAndCommitWrapper`, `recoverAndCommitInternal`, `recoverCommitAndHandleTimeout`&lt;/p&gt;</comment>
                            <comment id="16224673" author="githubbot" created="Mon, 30 Oct 2017 11:03:01 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147670239&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147670239&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -35,60 +42,101 @@&lt;br/&gt;
     import java.io.IOException;&lt;br/&gt;
     import java.nio.charset.Charset;&lt;br/&gt;
     import java.nio.file.Files;&lt;br/&gt;
    +import java.time.Clock;&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.Arrays;&lt;br/&gt;
     import java.util.Collections;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
     import java.util.UUID;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicBoolean;&lt;/p&gt;

&lt;p&gt;     import static java.nio.file.StandardCopyOption.ATOMIC_MOVE;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.containsString;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.hasItem;&lt;br/&gt;
     import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +import static org.junit.Assert.assertThat;&lt;br/&gt;
     import static org.junit.Assert.assertTrue;&lt;br/&gt;
     import static org.junit.Assert.fail;&lt;br/&gt;
    +import static org.mockito.Mockito.verify;&lt;br/&gt;
    +import static org.mockito.Mockito.when;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests for 
{@link TwoPhaseCommitSinkFunction}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TwoPhaseCommitSinkFunctionTest {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestContext context;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Rule&lt;br/&gt;
    +	public TemporaryFolder folder = new TemporaryFolder();&lt;br/&gt;
    +&lt;br/&gt;
    +	private FileBasedSinkFunction sinkFunction;&lt;br/&gt;
    +&lt;br/&gt;
    +	private OneInputStreamOperatorTestHarness&amp;lt;String, Object&amp;gt; harness;&lt;br/&gt;
    +&lt;br/&gt;
    +	private AtomicBoolean throwException = new AtomicBoolean();&lt;br/&gt;
    +&lt;br/&gt;
    +	private File targetDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	private File tmpDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Clock mockClock;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Logger mockLogger;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    As above. Will all of those `mockLogger` tests fail, if you replace:&lt;br/&gt;
    ```&lt;br/&gt;
    			log.warn(&quot;Transaction {} has been open for {} ms. &quot; +&lt;br/&gt;
    					&quot;This is close to or even exceeding the transaction timeout of {} ms.&quot;,&lt;br/&gt;
    				transactionHolder.handle,&lt;br/&gt;
    				elapsedTime,&lt;br/&gt;
    				transactionTimeout);&lt;br/&gt;
    ```&lt;br/&gt;
    with &lt;br/&gt;
    ```&lt;br/&gt;
    			log.warn(&quot;Transaction {} has been open for too long. &quot; +&lt;br/&gt;
    					&quot;This is close to or even exceeding the transaction timeout of {} ms.&quot;,&lt;br/&gt;
    				transactionHolder.handle,&lt;br/&gt;
    				transactionTimeout);&lt;br/&gt;
    ```&lt;br/&gt;
    or&lt;br/&gt;
    ```&lt;br/&gt;
    			log.warn(String.format(&quot;Transaction {} has been open for {} ms. &quot; +&lt;br/&gt;
    					&quot;This is close to or even exceeding the transaction timeout of {} ms.&quot;,&lt;br/&gt;
    				transactionHolder.handle,&lt;br/&gt;
    				elapsedTime,&lt;br/&gt;
    				transactionTimeout));&lt;br/&gt;
    ```&lt;br/&gt;
    ?&lt;br/&gt;
    If so, then this is a perfect example my I consider mockito to be the definition of evil. Using mockito in tests in 99% cases is duplicating/copying productional code into tests, basically repeating the implementation, which is super fragile and brakes on even the tiniest refactors. While good tests instead should check/assert the actual effects - not whether specific method calls were called and how many times they were called.&lt;/p&gt;</comment>
                            <comment id="16224674" author="githubbot" created="Mon, 30 Oct 2017 11:03:01 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147659714&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147659714&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -293,26 +330,110 @@ public void initializeState(FunctionInitializationContext context) throws Except&lt;br/&gt;
     		}&lt;br/&gt;
     		// if in restore we didn&apos;t get any userContext or we are initializing from scratch&lt;br/&gt;
     		if (userContext == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;{} - no state to restore&quot;, name());&lt;br/&gt;
    +			log.info(&quot;{} - no state to restore&quot;, name());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			userContext = initializeUserContext();&lt;br/&gt;
     		}&lt;br/&gt;
     		this.pendingCommitTransactions.clear();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;currentTransaction = beginTransaction();&lt;/li&gt;
	&lt;li&gt;LOG.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +		currentTransaction = beginTransaction0();&lt;br/&gt;
    +		log.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This method must be the only place to call 
{@link #beginTransaction()}
&lt;p&gt; to ensure that the&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link TransactionHolder}
&lt;p&gt; is created at the same time.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; beginTransaction0() throws Exception {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    this `0` in method&apos;s name doesn&apos;t help in anything. Please rename it to either `beginTransactionHolder`, `beginTransactionWrapper`, `beginTransactionInternal`, `beginTransactionAndStartTimeoutTimer` or `beginTransactionAndMarkTime`&lt;/p&gt;</comment>
                            <comment id="16224675" author="githubbot" created="Mon, 30 Oct 2017 11:03:01 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147663332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147663332&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -194,29 +348,4 @@ public String toString() &lt;/p&gt;
{
     			return String.format(&quot;FileTransaction[%s]&quot;, tmpFile.getName());
     		}
&lt;p&gt;     	}&lt;br/&gt;
    -&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static class TestContext implements AutoCloseable {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why did you remove this encapsulation?&lt;/p&gt;</comment>
                            <comment id="16224676" author="githubbot" created="Mon, 30 Oct 2017 11:03:02 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147658988&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147658988&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Specifies the maximum time a transaction should remain open.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private long transactionTimeout = Long.MAX_VALUE;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If true, any exception thrown in &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; will be caught instead of&lt;br/&gt;
    +	 * propagated.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private boolean failureOnCommitAfterTransactionTimeoutDisabled;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If a transaction&apos;s elapsed time reaches this percentage of the transactionTimeout, a warning&lt;br/&gt;
    +	 * message will be logged. Value must be in range &lt;span class=&quot;error&quot;&gt;&amp;#91;0,1&amp;#93;&lt;/span&gt;. Negative value disables warnings.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private double transactionTimeoutWarningRatio = -1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I would prefer to implement this sanity check in `FlinkKafkaProducer011`, since it&apos;s a walk around Kafka&apos;s bug and unlikely to be useful in general case. And after Kafka `0.11.0.2` or `1.0.0` release we won&apos;t need this code anymore.&lt;/p&gt;</comment>
                            <comment id="16224682" author="githubbot" created="Mon, 30 Oct 2017 11:07:11 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147672407&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147672407&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -35,60 +42,101 @@&lt;br/&gt;
     import java.io.IOException;&lt;br/&gt;
     import java.nio.charset.Charset;&lt;br/&gt;
     import java.nio.file.Files;&lt;br/&gt;
    +import java.time.Clock;&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.Arrays;&lt;br/&gt;
     import java.util.Collections;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
     import java.util.UUID;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicBoolean;&lt;/p&gt;

&lt;p&gt;     import static java.nio.file.StandardCopyOption.ATOMIC_MOVE;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.containsString;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.hasItem;&lt;br/&gt;
     import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +import static org.junit.Assert.assertThat;&lt;br/&gt;
     import static org.junit.Assert.assertTrue;&lt;br/&gt;
     import static org.junit.Assert.fail;&lt;br/&gt;
    +import static org.mockito.Mockito.verify;&lt;br/&gt;
    +import static org.mockito.Mockito.when;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests for 
{@link TwoPhaseCommitSinkFunction}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TwoPhaseCommitSinkFunctionTest {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestContext context;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Rule&lt;br/&gt;
    +	public TemporaryFolder folder = new TemporaryFolder();&lt;br/&gt;
    +&lt;br/&gt;
    +	private FileBasedSinkFunction sinkFunction;&lt;br/&gt;
    +&lt;br/&gt;
    +	private OneInputStreamOperatorTestHarness&amp;lt;String, Object&amp;gt; harness;&lt;br/&gt;
    +&lt;br/&gt;
    +	private AtomicBoolean throwException = new AtomicBoolean();&lt;br/&gt;
    +&lt;br/&gt;
    +	private File targetDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	private File tmpDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Clock mockClock;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    please do not use mockito for classes that are so easy to implement and mock in old fashion way (creating `SettableClock` seems to be super easy).&lt;/p&gt;</comment>
                            <comment id="16224744" author="githubbot" created="Mon, 30 Oct 2017 11:29:24 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147677068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147677068&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -35,60 +42,101 @@&lt;br/&gt;
     import java.io.IOException;&lt;br/&gt;
     import java.nio.charset.Charset;&lt;br/&gt;
     import java.nio.file.Files;&lt;br/&gt;
    +import java.time.Clock;&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.Arrays;&lt;br/&gt;
     import java.util.Collections;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
     import java.util.UUID;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicBoolean;&lt;/p&gt;

&lt;p&gt;     import static java.nio.file.StandardCopyOption.ATOMIC_MOVE;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.containsString;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.hasItem;&lt;br/&gt;
     import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +import static org.junit.Assert.assertThat;&lt;br/&gt;
     import static org.junit.Assert.assertTrue;&lt;br/&gt;
     import static org.junit.Assert.fail;&lt;br/&gt;
    +import static org.mockito.Mockito.verify;&lt;br/&gt;
    +import static org.mockito.Mockito.when;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests for 
{@link TwoPhaseCommitSinkFunction}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TwoPhaseCommitSinkFunctionTest {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestContext context;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Rule&lt;br/&gt;
    +	public TemporaryFolder folder = new TemporaryFolder();&lt;br/&gt;
    +&lt;br/&gt;
    +	private FileBasedSinkFunction sinkFunction;&lt;br/&gt;
    +&lt;br/&gt;
    +	private OneInputStreamOperatorTestHarness&amp;lt;String, Object&amp;gt; harness;&lt;br/&gt;
    +&lt;br/&gt;
    +	private AtomicBoolean throwException = new AtomicBoolean();&lt;br/&gt;
    +&lt;br/&gt;
    +	private File targetDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	private File tmpDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Clock mockClock;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Logger mockLogger;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The test is asserting on the presence of the substring `This is close to or even exceeding the transaction timeout` in the log message. All your changes to the code would still pass the test except for the 2nd case because there is an assert on the elapsed time. Mockito is used here so that the argument passed to `.warn` can be captured. Imo this is not evil as no behavior is mocked, and actual effects are tested. &lt;/p&gt;
</comment>
                            <comment id="16224752" author="githubbot" created="Mon, 30 Oct 2017 11:36:54 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147678610&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147678610&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -194,29 +348,4 @@ public String toString() &lt;/p&gt;
{
     			return String.format(&quot;FileTransaction[%s]&quot;, tmpFile.getName());
     		}
&lt;p&gt;     	}&lt;br/&gt;
    -&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static class TestContext implements AutoCloseable {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I am using &lt;br/&gt;
    ```&lt;br/&gt;
    	@Rule&lt;br/&gt;
    	public TemporaryFolder folder = new TemporaryFolder();&lt;br/&gt;
    ```&lt;br/&gt;
    to create test folders are files which are cleaned up automatically. Since the rule must be a public field in the test, it would have required more work to keep the `TestContext`. &lt;/p&gt;</comment>
                            <comment id="16224753" author="githubbot" created="Mon, 30 Oct 2017 11:38:16 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147678943&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147678943&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java &amp;#8212;&lt;br/&gt;
    @@ -442,13 +445,31 @@ public FlinkKafkaProducer011(&lt;br/&gt;
     			throw new IllegalArgumentException(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG + &quot; must be supplied in the producer config properties.&quot;);&lt;br/&gt;
     		}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!producerConfig.contains(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG)) {&lt;br/&gt;
    +		if (!producerConfig.containsKey(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG)) 
{
     			long timeout = DEFAULT_KAFKA_TRANSACTION_TIMEOUT.toMilliseconds();
     			checkState(timeout &amp;lt; Integer.MAX_VALUE &amp;amp;&amp;amp; timeout &amp;gt; 0, &quot;timeout does not fit into 32 bit integer&quot;);
     			this.producerConfig.put(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG, (int) timeout);
     			LOG.warn(&quot;Property [%s] not specified. Setting it to %s&quot;, ProducerConfig.TRANSACTION_TIMEOUT_CONFIG, DEFAULT_KAFKA_TRANSACTION_TIMEOUT);
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +		// Enable transactionTimeoutWarnings to avoid silent data loss&lt;br/&gt;
    +		// See &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6119&quot; title=&quot;Silent Data Loss in Kafka011 Transactional Producer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6119&quot;&gt;&lt;del&gt;KAFKA-6119&lt;/del&gt;&lt;/a&gt; (affects versions 0.11.0.0 and 0.11.0.1):&lt;br/&gt;
    +		// The KafkaProducer may not throw an exception if the transaction failed to commit&lt;br/&gt;
    +		if (semantic == Semantic.EXACTLY_ONCE) {&lt;br/&gt;
    +			final Object object = this.producerConfig.get(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Couldn&apos;t find any.&lt;/p&gt;</comment>
                            <comment id="16224756" author="githubbot" created="Mon, 30 Oct 2017 11:39:17 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147679162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147679162&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Ok will do.&lt;/p&gt;</comment>
                            <comment id="16224759" author="githubbot" created="Mon, 30 Oct 2017 11:40:40 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147679516&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147679516&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Specifies the maximum time a transaction should remain open.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private long transactionTimeout = Long.MAX_VALUE;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If true, any exception thrown in &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; will be caught instead of&lt;br/&gt;
    +	 * propagated.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private boolean failureOnCommitAfterTransactionTimeoutDisabled;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Ok, will do.&lt;/p&gt;</comment>
                            <comment id="16224760" author="githubbot" created="Mon, 30 Oct 2017 11:41:03 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147679597&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147679597&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -293,26 +330,110 @@ public void initializeState(FunctionInitializationContext context) throws Except&lt;br/&gt;
     		}&lt;br/&gt;
     		// if in restore we didn&apos;t get any userContext or we are initializing from scratch&lt;br/&gt;
     		if (userContext == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;{} - no state to restore&quot;, name());&lt;br/&gt;
    +			log.info(&quot;{} - no state to restore&quot;, name());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			userContext = initializeUserContext();&lt;br/&gt;
     		}&lt;br/&gt;
     		this.pendingCommitTransactions.clear();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;currentTransaction = beginTransaction();&lt;/li&gt;
	&lt;li&gt;LOG.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +		currentTransaction = beginTransaction0();&lt;br/&gt;
    +		log.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This method must be the only place to call 
{@link #beginTransaction()}
&lt;p&gt; to ensure that the&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link TransactionHolder}
&lt;p&gt; is created at the same time.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; beginTransaction0() throws Exception &lt;/p&gt;
{
    +		return new TransactionHolder&amp;lt;&amp;gt;(beginTransaction(), clock.millis());
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This method must be the only place to call &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; to ensure that&lt;br/&gt;
    +	 * the configuration parameters &lt;/p&gt;
{@link #transactionTimeout}
&lt;p&gt; and&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link #failureOnCommitAfterTransactionTimeoutDisabled}
&lt;p&gt; are respected.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private void recoverAndCommit(TransactionHolder&amp;lt;TXN&amp;gt; transactionHolder) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Will rename.&lt;/p&gt;</comment>
                            <comment id="16224763" author="githubbot" created="Mon, 30 Oct 2017 11:42:42 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147679890&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147679890&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -293,26 +330,110 @@ public void initializeState(FunctionInitializationContext context) throws Except&lt;br/&gt;
     		}&lt;br/&gt;
     		// if in restore we didn&apos;t get any userContext or we are initializing from scratch&lt;br/&gt;
     		if (userContext == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;{} - no state to restore&quot;, name());&lt;br/&gt;
    +			log.info(&quot;{} - no state to restore&quot;, name());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			userContext = initializeUserContext();&lt;br/&gt;
     		}&lt;br/&gt;
     		this.pendingCommitTransactions.clear();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;currentTransaction = beginTransaction();&lt;/li&gt;
	&lt;li&gt;LOG.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +		currentTransaction = beginTransaction0();&lt;br/&gt;
    +		log.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This method must be the only place to call 
{@link #beginTransaction()}
&lt;p&gt; to ensure that the&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link TransactionHolder}
&lt;p&gt; is created at the same time.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; beginTransaction0() throws Exception &lt;/p&gt;
{
    +		return new TransactionHolder&amp;lt;&amp;gt;(beginTransaction(), clock.millis());
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This method must be the only place to call &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; to ensure that&lt;br/&gt;
    +	 * the configuration parameters &lt;/p&gt;
{@link #transactionTimeout}
&lt;p&gt; and&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link #failureOnCommitAfterTransactionTimeoutDisabled}
&lt;p&gt; are respected.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private void recoverAndCommit(TransactionHolder&amp;lt;TXN&amp;gt; transactionHolder) {&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			logWarningIfTimeoutAlmostReached(transactionHolder);
    +			recoverAndCommit(transactionHolder.handle);
    +		}
&lt;p&gt; catch (final Exception e) {&lt;br/&gt;
    +			final long elapsedTime = clock.millis() - transactionHolder.transactionStartTime;&lt;br/&gt;
    +			if (failureOnCommitAfterTransactionTimeoutDisabled &amp;amp;&amp;amp; elapsedTime &amp;gt; transactionTimeout) {&lt;br/&gt;
    +				log.error(&quot;Error while committing transaction {}. &quot; +&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Good. Will add a statement to the log message.&lt;/p&gt;</comment>
                            <comment id="16224771" author="githubbot" created="Mon, 30 Oct 2017 11:48:12 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147680902&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147680902&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -293,26 +330,110 @@ public void initializeState(FunctionInitializationContext context) throws Except&lt;br/&gt;
     		}&lt;br/&gt;
     		// if in restore we didn&apos;t get any userContext or we are initializing from scratch&lt;br/&gt;
     		if (userContext == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;{} - no state to restore&quot;, name());&lt;br/&gt;
    +			log.info(&quot;{} - no state to restore&quot;, name());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			userContext = initializeUserContext();&lt;br/&gt;
     		}&lt;br/&gt;
     		this.pendingCommitTransactions.clear();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;currentTransaction = beginTransaction();&lt;/li&gt;
	&lt;li&gt;LOG.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +		currentTransaction = beginTransaction0();&lt;br/&gt;
    +		log.debug(&quot;{} - started new transaction &apos;{}&apos;&quot;, name(), currentTransaction);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This method must be the only place to call 
{@link #beginTransaction()}
&lt;p&gt; to ensure that the&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link TransactionHolder}
&lt;p&gt; is created at the same time.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; beginTransaction0() throws Exception {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Will rename.&lt;/p&gt;</comment>
                            <comment id="16224778" author="githubbot" created="Mon, 30 Oct 2017 11:51:26 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147681520&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147681520&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Specifies the maximum time a transaction should remain open.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private long transactionTimeout = Long.MAX_VALUE;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If true, any exception thrown in &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; will be caught instead of&lt;br/&gt;
    +	 * propagated.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private boolean failureOnCommitAfterTransactionTimeoutDisabled;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Renamed to `failurePropagationAfterTransactionTimeoutDisabled` as this is closer to the method that controls this field.&lt;/p&gt;</comment>
                            <comment id="16224785" author="githubbot" created="Mon, 30 Oct 2017 11:53:57 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147681959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147681959&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Specifies the maximum time a transaction should remain open.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private long transactionTimeout = Long.MAX_VALUE;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If true, any exception thrown in &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; will be caught instead of&lt;br/&gt;
    +	 * propagated.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private boolean failureOnCommitAfterTransactionTimeoutDisabled;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If a transaction&apos;s elapsed time reaches this percentage of the transactionTimeout, a warning&lt;br/&gt;
    +	 * message will be logged. Value must be in range &lt;span class=&quot;error&quot;&gt;&amp;#91;0,1&amp;#93;&lt;/span&gt;. Negative value disables warnings.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private double transactionTimeoutWarningRatio = -1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    If exceeding the `transactionTimeout` can result in data loss, I prefer a flag here (i.e., `TwoPhaseCommitSinkFunction`). You may want to be warned before something bad happens so that parameters can be tuned.&lt;/p&gt;</comment>
                            <comment id="16224805" author="githubbot" created="Mon, 30 Oct 2017 12:19:04 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147686546&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147686546&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -35,60 +42,101 @@&lt;br/&gt;
     import java.io.IOException;&lt;br/&gt;
     import java.nio.charset.Charset;&lt;br/&gt;
     import java.nio.file.Files;&lt;br/&gt;
    +import java.time.Clock;&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.Arrays;&lt;br/&gt;
     import java.util.Collections;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
     import java.util.UUID;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicBoolean;&lt;/p&gt;

&lt;p&gt;     import static java.nio.file.StandardCopyOption.ATOMIC_MOVE;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.containsString;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.hasItem;&lt;br/&gt;
     import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +import static org.junit.Assert.assertThat;&lt;br/&gt;
     import static org.junit.Assert.assertTrue;&lt;br/&gt;
     import static org.junit.Assert.fail;&lt;br/&gt;
    +import static org.mockito.Mockito.verify;&lt;br/&gt;
    +import static org.mockito.Mockito.when;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests for 
{@link TwoPhaseCommitSinkFunction}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TwoPhaseCommitSinkFunctionTest {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestContext context;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Rule&lt;br/&gt;
    +	public TemporaryFolder folder = new TemporaryFolder();&lt;br/&gt;
    +&lt;br/&gt;
    +	private FileBasedSinkFunction sinkFunction;&lt;br/&gt;
    +&lt;br/&gt;
    +	private OneInputStreamOperatorTestHarness&amp;lt;String, Object&amp;gt; harness;&lt;br/&gt;
    +&lt;br/&gt;
    +	private AtomicBoolean throwException = new AtomicBoolean();&lt;br/&gt;
    +&lt;br/&gt;
    +	private File targetDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	private File tmpDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Clock mockClock;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I agree with you that overusing mocks is an anti-pattern. Changed it to a real implementation. Please have a look. I am not sure if this is better now because after all, the only mocked function on Clock was `.millis()`.&lt;/p&gt;</comment>
                            <comment id="16224814" author="githubbot" created="Mon, 30 Oct 2017 12:23:21 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147687302&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147687302&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java &amp;#8212;&lt;br/&gt;
    @@ -922,6 +945,22 @@ private void readObject(java.io.ObjectInputStream in) throws IOException, ClassN&lt;br/&gt;
     		producersPool = new ProducersPool();&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Disables the propagation of exceptions thrown when committing presumably timed out Kafka&lt;br/&gt;
    +	 * transactions during recovery of the job. If a Kafka transaction is timed out, a commit will&lt;br/&gt;
    +	 * never be successful. Hence, use this feature to avoid recovery loops of the Job. Exceptions&lt;br/&gt;
    +	 * will still be logged to inform the user that data loss might have occurred.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;Note that we use &lt;/p&gt;
{@link System#currentTimeMillis()}
&lt;p&gt; to track the age of a transaction.&lt;br/&gt;
    +	 * Moreover, only exceptions thrown during the recovery are caught, i.e., the producer will&lt;br/&gt;
    +	 * attempt at least one commit of the transaction before giving up.&amp;lt;/p&amp;gt;&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public FlinkKafkaProducer011&amp;lt;IN&amp;gt; disableFailurePropagationAfterTransactionTimeout() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Thanks. Moved it.&lt;/p&gt;</comment>
                            <comment id="16224816" author="githubbot" created="Mon, 30 Oct 2017 12:24:32 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147687514&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147687514&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -362,4 +483,39 @@ public void setContext(Optional&amp;lt;CONTEXT&amp;gt; context) &lt;/p&gt;
{
     			this.context = context;
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Adds metadata (currently only the start time of the transaction) to the transaction object.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	static class TransactionHolder&amp;lt;TXN&amp;gt; {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I will leave it as is. It&apos;s an internal class and it is clear what it does.&lt;/p&gt;</comment>
                            <comment id="16224866" author="githubbot" created="Mon, 30 Oct 2017 12:50:50 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147692599&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147692599&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Specifies the maximum time a transaction should remain open.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private long transactionTimeout = Long.MAX_VALUE;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If true, any exception thrown in &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; will be caught instead of&lt;br/&gt;
    +	 * propagated.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private boolean failureOnCommitAfterTransactionTimeoutDisabled;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Part of my concern was that the name is quite long (same applies for the methods). Maybe `ignoreFailuresAfterTimeout`? Or `ignoreFailuresAfterTransactionTimeout`?&lt;/p&gt;
</comment>
                            <comment id="16224867" author="githubbot" created="Mon, 30 Oct 2017 12:53:29 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147693238&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147693238&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -35,60 +42,101 @@&lt;br/&gt;
     import java.io.IOException;&lt;br/&gt;
     import java.nio.charset.Charset;&lt;br/&gt;
     import java.nio.file.Files;&lt;br/&gt;
    +import java.time.Clock;&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.Arrays;&lt;br/&gt;
     import java.util.Collections;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
     import java.util.UUID;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicBoolean;&lt;/p&gt;

&lt;p&gt;     import static java.nio.file.StandardCopyOption.ATOMIC_MOVE;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.containsString;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.hasItem;&lt;br/&gt;
     import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +import static org.junit.Assert.assertThat;&lt;br/&gt;
     import static org.junit.Assert.assertTrue;&lt;br/&gt;
     import static org.junit.Assert.fail;&lt;br/&gt;
    +import static org.mockito.Mockito.verify;&lt;br/&gt;
    +import static org.mockito.Mockito.when;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests for 
{@link TwoPhaseCommitSinkFunction}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TwoPhaseCommitSinkFunctionTest {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestContext context;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Rule&lt;br/&gt;
    +	public TemporaryFolder folder = new TemporaryFolder();&lt;br/&gt;
    +&lt;br/&gt;
    +	private FileBasedSinkFunction sinkFunction;&lt;br/&gt;
    +&lt;br/&gt;
    +	private OneInputStreamOperatorTestHarness&amp;lt;String, Object&amp;gt; harness;&lt;br/&gt;
    +&lt;br/&gt;
    +	private AtomicBoolean throwException = new AtomicBoolean();&lt;br/&gt;
    +&lt;br/&gt;
    +	private File targetDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	private File tmpDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Clock mockClock;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Logger mockLogger;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Are you sure? `Logger.warn(String, Object...)`, `Logger.warn(String, Object)`, `Logger.warn(String, Object, Object)` and `Logger.warn(String)` are different methods.&lt;/p&gt;

&lt;p&gt;    This shows, that you are not testing for the effects (warning message being logged somewhere), but you test whether one particular method was called or not.&lt;/p&gt;</comment>
                            <comment id="16224868" author="githubbot" created="Mon, 30 Oct 2017 12:53:50 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147693317&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147693317&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Specifies the maximum time a transaction should remain open.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private long transactionTimeout = Long.MAX_VALUE;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If true, any exception thrown in &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; will be caught instead of&lt;br/&gt;
    +	 * propagated.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private boolean failureOnCommitAfterTransactionTimeoutDisabled;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If a transaction&apos;s elapsed time reaches this percentage of the transactionTimeout, a warning&lt;br/&gt;
    +	 * message will be logged. Value must be in range &lt;span class=&quot;error&quot;&gt;&amp;#91;0,1&amp;#93;&lt;/span&gt;. Negative value disables warnings.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private double transactionTimeoutWarningRatio = -1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I&apos;m not convinced, since this will make our public api larger and more difficult to maintain. However if @aljoscha is ok with that I will yield &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16225030" author="githubbot" created="Mon, 30 Oct 2017 14:27:13 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147717560&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147717560&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -35,60 +42,101 @@&lt;br/&gt;
     import java.io.IOException;&lt;br/&gt;
     import java.nio.charset.Charset;&lt;br/&gt;
     import java.nio.file.Files;&lt;br/&gt;
    +import java.time.Clock;&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.Arrays;&lt;br/&gt;
     import java.util.Collections;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
     import java.util.UUID;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicBoolean;&lt;/p&gt;

&lt;p&gt;     import static java.nio.file.StandardCopyOption.ATOMIC_MOVE;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.containsString;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.hasItem;&lt;br/&gt;
     import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +import static org.junit.Assert.assertThat;&lt;br/&gt;
     import static org.junit.Assert.assertTrue;&lt;br/&gt;
     import static org.junit.Assert.fail;&lt;br/&gt;
    +import static org.mockito.Mockito.verify;&lt;br/&gt;
    +import static org.mockito.Mockito.when;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests for 
{@link TwoPhaseCommitSinkFunction}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TwoPhaseCommitSinkFunctionTest {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestContext context;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Rule&lt;br/&gt;
    +	public TemporaryFolder folder = new TemporaryFolder();&lt;br/&gt;
    +&lt;br/&gt;
    +	private FileBasedSinkFunction sinkFunction;&lt;br/&gt;
    +&lt;br/&gt;
    +	private OneInputStreamOperatorTestHarness&amp;lt;String, Object&amp;gt; harness;&lt;br/&gt;
    +&lt;br/&gt;
    +	private AtomicBoolean throwException = new AtomicBoolean();&lt;br/&gt;
    +&lt;br/&gt;
    +	private File targetDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	private File tmpDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Clock mockClock;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Logger mockLogger;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    True, you are right. One would need to implement the `org.slf4j.Logger` interface.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;http://projects.lidalia.org.uk/slf4j-test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://projects.lidalia.org.uk/slf4j-test/&lt;/a&gt; provides a `org.slf4j.Logger` implementation for unit testing but this approach comes with other problems (e.g. &lt;a href=&quot;https://github.com/Mahoney/slf4j-test/issues/15&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Mahoney/slf4j-test/issues/15&lt;/a&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;NOP if log level is  disabled&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/Mahoney/slf4j-test/blob/master/src/main/java/uk/org/lidalia/slf4jtest/TestLogger.java#L449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Mahoney/slf4j-test/blob/master/src/main/java/uk/org/lidalia/slf4jtest/TestLogger.java#L449&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Right now I don&apos;t see a way to do it properly. Any help is welcome.&lt;/p&gt;</comment>
                            <comment id="16225064" author="githubbot" created="Mon, 30 Oct 2017 14:53:13 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147654876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147654876&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-0.11/src/test/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011Tests.java &amp;#8212;&lt;br/&gt;
    @@ -83,49 +79,6 @@ public void before() &lt;/p&gt;
{
     		extraProperties.put(&quot;isolation.level&quot;, &quot;read_committed&quot;);
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Test(timeout = 30000L)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why are these removed? Did they never actually test anything?&lt;/p&gt;</comment>
                            <comment id="16225068" author="githubbot" created="Mon, 30 Oct 2017 14:54:10 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147727170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147727170&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Specifies the maximum time a transaction should remain open.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private long transactionTimeout = Long.MAX_VALUE;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If true, any exception thrown in &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; will be caught instead of&lt;br/&gt;
    +	 * propagated.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private boolean failureOnCommitAfterTransactionTimeoutDisabled;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If a transaction&apos;s elapsed time reaches this percentage of the transactionTimeout, a warning&lt;br/&gt;
    +	 * message will be logged. Value must be in range &lt;span class=&quot;error&quot;&gt;&amp;#91;0,1&amp;#93;&lt;/span&gt;. Negative value disables warnings.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private double transactionTimeoutWarningRatio = -1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I tend to agree with @pnowojski about the API surface but I think in this case this is a valid safety net for possible future transaction sinks.&lt;/p&gt;</comment>
                            <comment id="16225114" author="githubbot" created="Mon, 30 Oct 2017 15:19:57 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147735664&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147735664&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-0.11/src/test/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011Tests.java &amp;#8212;&lt;br/&gt;
    @@ -83,49 +79,6 @@ public void before() &lt;/p&gt;
{
     		extraProperties.put(&quot;isolation.level&quot;, &quot;read_committed&quot;);
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Test(timeout = 30000L)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The tests that I removed were already in `FlinkKafkaProducerTests`. Probably some copy paste error.&lt;/p&gt;</comment>
                            <comment id="16225119" author="githubbot" created="Mon, 30 Oct 2017 15:23:34 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147736898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147736898&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Specifies the maximum time a transaction should remain open.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private long transactionTimeout = Long.MAX_VALUE;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If true, any exception thrown in &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; will be caught instead of&lt;br/&gt;
    +	 * propagated.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private boolean failureOnCommitAfterTransactionTimeoutDisabled;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Ok, I like `ignoreFailuresAfterTransactionTimeout`&lt;/p&gt;</comment>
                            <comment id="16225146" author="githubbot" created="Mon, 30 Oct 2017 15:32:15 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147739898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147739898&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java &amp;#8212;&lt;br/&gt;
    @@ -58,18 +61,37 @@&lt;br/&gt;
     		extends RichSinkFunction&amp;lt;IN&amp;gt;&lt;br/&gt;
     		implements CheckpointedFunction, CheckpointListener {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(TwoPhaseCommitSinkFunction.class);&lt;br/&gt;
    +	private final Logger log;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +	private final Clock clock;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected final LinkedHashMap&amp;lt;Long, TXN&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	protected final LinkedHashMap&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; pendingCommitTransactions = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Nullable&lt;/li&gt;
	&lt;li&gt;protected TXN currentTransaction;&lt;br/&gt;
     	protected Optional&amp;lt;CONTEXT&amp;gt; userContext;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	protected ListState&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; state;&lt;/p&gt;

&lt;p&gt;    +	private final ListStateDescriptor&amp;lt;State&amp;lt;TXN, CONTEXT&amp;gt;&amp;gt; stateDescriptor;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TransactionHolder&amp;lt;TXN&amp;gt; currentTransaction;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Specifies the maximum time a transaction should remain open.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private long transactionTimeout = Long.MAX_VALUE;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * If true, any exception thrown in &lt;/p&gt;
{@link #recoverAndCommit(Object)}
&lt;p&gt; will be caught instead of&lt;br/&gt;
    +	 * propagated.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private boolean failureOnCommitAfterTransactionTimeoutDisabled;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Ok, I like `ignoreFailuresAfterTransactionTimeout`. The method name is now the same, though.&lt;/p&gt;</comment>
                            <comment id="16225160" author="githubbot" created="Mon, 30 Oct 2017 15:35:42 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147741136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147741136&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -35,60 +42,101 @@&lt;br/&gt;
     import java.io.IOException;&lt;br/&gt;
     import java.nio.charset.Charset;&lt;br/&gt;
     import java.nio.file.Files;&lt;br/&gt;
    +import java.time.Clock;&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.Arrays;&lt;br/&gt;
     import java.util.Collections;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
     import java.util.UUID;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicBoolean;&lt;/p&gt;

&lt;p&gt;     import static java.nio.file.StandardCopyOption.ATOMIC_MOVE;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.containsString;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
    +import static org.hamcrest.CoreMatchers.hasItem;&lt;br/&gt;
     import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +import static org.junit.Assert.assertThat;&lt;br/&gt;
     import static org.junit.Assert.assertTrue;&lt;br/&gt;
     import static org.junit.Assert.fail;&lt;br/&gt;
    +import static org.mockito.Mockito.verify;&lt;br/&gt;
    +import static org.mockito.Mockito.when;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests for 
{@link TwoPhaseCommitSinkFunction}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TwoPhaseCommitSinkFunctionTest {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestContext context;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Rule&lt;br/&gt;
    +	public TemporaryFolder folder = new TemporaryFolder();&lt;br/&gt;
    +&lt;br/&gt;
    +	private FileBasedSinkFunction sinkFunction;&lt;br/&gt;
    +&lt;br/&gt;
    +	private OneInputStreamOperatorTestHarness&amp;lt;String, Object&amp;gt; harness;&lt;br/&gt;
    +&lt;br/&gt;
    +	private AtomicBoolean throwException = new AtomicBoolean();&lt;br/&gt;
    +&lt;br/&gt;
    +	private File targetDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	private File tmpDirectory;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Clock mockClock;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Mock&lt;br/&gt;
    +	private Logger mockLogger;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The test does not rely on any mocks anymore. I am not 100% happy with it because we use log4j `1.x` which is not maintained anymore and in log4j `2.x`, the APIs have changed a lot: &lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/customconfig.html#AddingToCurrent&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/2.x/manual/customconfig.html#AddingToCurrent&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16226537" author="githubbot" created="Tue, 31 Oct 2017 09:57:37 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910#discussion_r147939418&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910#discussion_r147939418&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-0.11/src/test/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011Tests.java &amp;#8212;&lt;br/&gt;
    @@ -83,49 +79,6 @@ public void before() &lt;/p&gt;
{
     		extraProperties.put(&quot;isolation.level&quot;, &quot;read_committed&quot;);
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Test(timeout = 30000L)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes that&apos;s right. Code of this test is also in `FlinkKafkaProducerTest`.&lt;/p&gt;</comment>
                            <comment id="16235151" author="githubbot" created="Thu, 2 Nov 2017 04:20:33 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    LGTM, thanks for the work @GJL. Merging this ..&lt;/p&gt;</comment>
                            <comment id="16235479" author="githubbot" created="Thu, 2 Nov 2017 10:01:40 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4910&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16235875" author="aljoscha" created="Thu, 2 Nov 2017 15:04:22 +0000"  >&lt;p&gt;Fixed in 8cdf2ff7e5817acc0c239ce31c098daf33d326b7&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3l167:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>