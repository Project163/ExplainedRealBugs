<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:43:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-15338] TM Metaspace memory leak when submitting PyFlink UDF jobs multiple times</title>
                <link>https://issues.apache.org/jira/browse/FLINK-15338</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Start a standalone cluster and after submit PyFlink UDF jobs multiple times, the TM will fail with the following exception:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.OutOfMemoryError: Metaspace
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.defineClass1(Native Method)
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.defineClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:788)
  at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142)
  at java.net.URLClassLoader.defineClass(URLClassLoader.java:467)
  at java.net.URLClassLoader.access$100(URLClassLoader.java:73)
  at java.net.URLClassLoader$1.run(URLClassLoader.java:368)
  at java.net.URLClassLoader$1.run(URLClassLoader.java:362)
  at java.security.AccessController.doPrivileged(Native Method)
  at java.net.URLClassLoader.findClass(URLClassLoader.java:361)
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:448)
  at org.apache.flink.util.ChildFirstClassLoader.loadClass(ChildFirstClassLoader.java:60)
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:380)
  at org.apache.flink.api.python.shaded.com.fasterxml.jackson.databind.ObjectMapper.&amp;lt;init&amp;gt;(ObjectMapper.java:628)
  at org.apache.flink.api.python.shaded.com.fasterxml.jackson.databind.ObjectMapper.&amp;lt;init&amp;gt;(ObjectMapper.java:531)
  at org.apache.beam.sdk.options.PipelineOptionsFactory.&amp;lt;clinit&amp;gt;(PipelineOptionsFactory.java:469)
  at org.apache.flink.python.AbstractPythonFunctionRunner.open(AbstractPythonFunctionRunner.java:173)
  at org.apache.flink.table.runtime.operators.python.AbstractPythonScalarFunctionOperator$ProjectUdfInputPythonScalarFunctionRunner.open(AbstractPythonScalarFunctionOperator.java:193)
  at org.apache.flink.streaming.api.operators.python.AbstractPythonFunctionOperator.open(AbstractPythonFunctionOperator.java:139)
  at org.apache.flink.table.runtime.operators.python.AbstractPythonScalarFunctionOperator.open(AbstractPythonScalarFunctionOperator.java:143)
  at org.apache.flink.table.runtime.operators.python.BaseRowPythonScalarFunctionOperator.open(BaseRowPythonScalarFunctionOperator.java:86)
  at org.apache.flink.streaming.runtime.tasks.StreamTask.initializeStateAndOpen(StreamTask.java:1018)
  at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$beforeInvoke$0(StreamTask.java:454)
  at org.apache.flink.streaming.runtime.tasks.StreamTask$$Lambda$125/800044563.run(Unknown Source)
  at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$SynchronizedStreamTaskActionExecutor.runThrowing(StreamTaskActionExecutor.java:94)
  at org.apache.flink.streaming.runtime.tasks.StreamTask.beforeInvoke(StreamTask.java:449)
  at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:461)
  at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:702)
  at org.apache.flink.runtime.taskmanager.Task.run(Task.java:527)
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13275642">FLINK-15338</key>
            <summary>TM Metaspace memory leak when submitting PyFlink UDF jobs multiple times</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="weizhong">Wei Zhong</assignee>
                                    <reporter username="sunjincheng121">sunjincheng</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 20 Dec 2019 03:13:59 +0000</created>
                <updated>Thu, 9 Jan 2020 06:01:54 +0000</updated>
                            <resolved>Thu, 9 Jan 2020 06:01:54 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.0</fixVersion>
                                    <component>API / Python</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17000577" author="sunjincheng121" created="Fri, 20 Dec 2019 03:17:07 +0000"  >&lt;p&gt;We dumped the heap and found that there are two places which caused the meta space memory leak:&lt;/p&gt;

&lt;p&gt;1) The class `ProcessManager` from Beam creates a &lt;a href=&quot;https://github.com/apache/beam/blob/06454044b699f6b1bbc5becee5c9b752923beb3b/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/environment/ProcessManager.java#L52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;shutdown hook&lt;/a&gt; which will not be removed before JVM exits. The shutdown hook holds a reference to the user class loader and it means that the user class loader could not be GC even after job finished.&lt;/p&gt;

&lt;p&gt;2) The class `ThreadPoolCache` from Netty (dependent on by Beam) defines a finalize method which will create an object InternalThreadLocalMap. The object InternalThreadLocalMap will be added to the ThreadLocal map of the Finalizer thread. As InternalThreadLocalMap holds a reference to the user class loader and this means that the user class loader could not be GC even after job finished. This issue has been fixed in &lt;a href=&quot;https://github.com/netty/netty/pull/8955&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;NETTY#8955&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;So, there are two options to fix this issues:&lt;br/&gt;
 1) Fix the above two problems case by case&lt;br/&gt;
 2) Move the jar of flink-python to lib (this means that the classes of flink-python will loaded with system classloader)&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="17000579" author="xintongsong" created="Fri, 20 Dec 2019 03:18:18 +0000"  >&lt;p&gt;Is this the same issue as &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15239&quot; title=&quot;CompileUtils::COMPILED_CACHE leaks class loaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15239&quot;&gt;&lt;del&gt;FLINK-15239&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17000584" author="sunjincheng121" created="Fri, 20 Dec 2019 03:25:44 +0000"  >&lt;p&gt;The causes are similar, i.e. the user classloader could not be garbage collected after job finished. However, the reasons to the problems are different and so we have to fix them case by case.&lt;/p&gt;</comment>
                            <comment id="17003509" author="sunjincheng121" created="Thu, 26 Dec 2019 08:00:00 +0000"  >&lt;p&gt;The PR to solve `ProcessManager` issue is opened, mode detail can be found in&#160;&lt;a href=&quot;https://github.com/apache/beam/pull/10462&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/10462&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17003517" author="sunjincheng121" created="Thu, 26 Dec 2019 08:12:09 +0000"  >&lt;p&gt;The detail of discussion and the PR for NETTY issue can be found in &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://lists.apache.org/thread.html/ef5b24766d94d3d389bee9c03e59003b9cf417c81cde50ede5856ad7%40%3Cdev.beam.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/ef5b24766d94d3d389bee9c03e59003b9cf417c81cde50ede5856ad7%40%3Cdev.beam.apache.org%3E&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/beam/pull/10463&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/10463&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17008497" author="zhongwei" created="Mon, 6 Jan 2020 02:43:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunjincheng121&quot; class=&quot;user-hover&quot; rel=&quot;sunjincheng121&quot;&gt;sunjincheng121&lt;/a&gt;&#160;It seems the PR to solve `ProcessManager` issue is merged in Beam. I think we can cp the fixes from Beam and Netty now. I&apos;m willing to create the PR if you can assign this Jira to me. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17008554" author="sunjincheng121" created="Mon, 6 Jan 2020 05:58:51 +0000"  >&lt;p&gt;Thanks for the reminder &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhongwei&quot; class=&quot;user-hover&quot; rel=&quot;zhongwei&quot;&gt;zhongwei&lt;/a&gt;! and it&apos;s would be great that you can help fix this issue &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17011445" author="hequn8128" created="Thu, 9 Jan 2020 06:01:41 +0000"  >&lt;p&gt;Fixed&lt;br/&gt;
in 1.11.0 via f30dd982f7c54c76ef67c6be9ffd5c9c27d900f9..74dc89514c4de01b9419bcaf584c51ccc8a40962&lt;br/&gt;
in 1.10.0 via&lt;br/&gt;
dfd66a4296e9237ef287c4539977a70ccb963bc3..a084e37e7df241ac858f359e7dae7ec4d76d806a&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13275644">BEAM-9006</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 44 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09va0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>