<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:25:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4603] KeyedStateBackend cannot restore user code classes</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4603</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;A user reported that he cannot restore keyed state which contains user code classes. I suspect that we don&apos;t use the user code class loader to deserialize the state.&lt;/p&gt;

&lt;p&gt;The solution seems to be to forward the user code class loader to the &lt;tt&gt;KeyedStateBackends&lt;/tt&gt; when restoring state.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13003815">FLINK-4603</key>
            <summary>KeyedStateBackend cannot restore user code classes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Sep 2016 10:04:02 +0000</created>
                <updated>Thu, 22 Sep 2016 13:54:00 +0000</updated>
                            <resolved>Thu, 22 Sep 2016 13:53:52 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15476881" author="aljoscha" created="Fri, 9 Sep 2016 11:50:38 +0000"  >&lt;p&gt;Yep, the user code &lt;tt&gt;ClassLoder&lt;/tt&gt; can be retrieved from the &lt;tt&gt;Environment&lt;/tt&gt; passed to &lt;tt&gt;AbstractStateBackend.restoreKeyedStateBackend()&lt;/tt&gt;. A nicer solution would be to completely get rid of Java Serialization in the state serialization.&lt;/p&gt;</comment>
                            <comment id="15476941" author="till.rohrmann" created="Fri, 9 Sep 2016 12:21:08 +0000"  >&lt;p&gt;Wouldn&apos;t we even then need the user code class loader to load user code classes?&lt;/p&gt;</comment>
                            <comment id="15477093" author="aljoscha" created="Fri, 9 Sep 2016 13:46:36 +0000"  >&lt;p&gt;We wouldn&apos;t if we always keep everything in serialized form, as is the case for the RocksDB backend. In that case, the user code is only necessary when a state access comes in and when that happens we&apos;re already &quot;in&quot; the user code class loader.&lt;/p&gt;</comment>
                            <comment id="15483601" author="till.rohrmann" created="Mon, 12 Sep 2016 09:22:05 +0000"  >&lt;p&gt;That makes sense. &lt;/p&gt;</comment>
                            <comment id="15512540" author="githubbot" created="Thu, 22 Sep 2016 08:02:48 +0000"  >&lt;p&gt;GitHub user StefanRRichter opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2533&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4603&quot; title=&quot;KeyedStateBackend cannot restore user code classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4603&quot;&gt;&lt;del&gt;FLINK-4603&lt;/del&gt;&lt;/a&gt; Fixes: KeyedStateBackend cannot restore user code classes&lt;/p&gt;

&lt;p&gt;    This PR fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4603&quot; title=&quot;KeyedStateBackend cannot restore user code classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4603&quot;&gt;&lt;del&gt;FLINK-4603&lt;/del&gt;&lt;/a&gt; and introduces a test to protect better against future regression.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StefanRRichter/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StefanRRichter/flink&lt;/a&gt; backend-classloader-fix&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2533.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2533.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2533&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d6b8b0112c6a4cf3f2cbf5eb758599e15d796aab&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2016-09-21T12:55:58Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4603&quot; title=&quot;KeyedStateBackend cannot restore user code classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4603&quot;&gt;&lt;del&gt;FLINK-4603&lt;/del&gt;&lt;/a&gt; KeyedStateBackend can restore user code classes&lt;/p&gt;

&lt;p&gt;commit 78b2a4f048bd62e55471a384169304ca46bbbf60&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2016-09-21T15:56:08Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4603&quot; title=&quot;KeyedStateBackend cannot restore user code classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4603&quot;&gt;&lt;del&gt;FLINK-4603&lt;/del&gt;&lt;/a&gt; Test case&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15512541" author="githubbot" created="Thu, 22 Sep 2016 08:03:30 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2533&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Please review @tillrohrmann or @aljoscha &lt;/p&gt;</comment>
                            <comment id="15512553" author="srichter" created="Thu, 22 Sep 2016 08:08:07 +0000"  >&lt;p&gt;Currently, we should still keep the UserCodeClassLoader around in the RocksDB backend because we still need to serialize the StateDescriptor, which contains the TypeSerializer, so that users can not accidentally create StateDescriptors with a wrong TypeSerializer. However, we should consider that TypeSerializer can be exchanged (ensuring their compatibility), e.g. to allow different serialization versions.&lt;/p&gt;</comment>
                            <comment id="15512702" author="githubbot" created="Thu, 22 Sep 2016 09:11:22 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2533&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fix looks good.&lt;br/&gt;
    Better would probably be to not even have the user code in the checkpoint at all.&lt;br/&gt;
    Can we do that?&lt;/p&gt;</comment>
                            <comment id="15512765" author="githubbot" created="Thu, 22 Sep 2016 09:36:41 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2533&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen we can do that but then we won&apos;t have any sanity checks for the `TypeSerializer` any more. Right now, even the RocksDB backed will serializer the `TypeSerializer`/`StateDescriptor` with the checkpoint to verify that the user only accesses it with the correct `TypeSerializer`/`StateDescriptor`.&lt;/p&gt;

&lt;p&gt;    I would be in favor of completely getting rid of user code there, even if it means losing those checks. Also, for this to work with the Heap backend we need to either always keep state on the heap in serialized form or deserialize lazily from restored serialized values using the `TypeSerializer` that we get from the user when they access state for the first time. &lt;/p&gt;</comment>
                            <comment id="15512773" author="githubbot" created="Thu, 22 Sep 2016 09:39:54 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2533#discussion_r80005604&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2533#discussion_r80005604&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -266,18 +265,20 @@ public void restorePartitionedState(List&amp;lt;KeyGroupsStateHandle&amp;gt; state) throws Exc&lt;br/&gt;
     			for (int i = 0; i &amp;lt; numKvStates; ++i) &lt;/p&gt;
{
     				String stateName = inView.readUTF();
     
    -				ObjectInputStream ois = new ObjectInputStream(inView);
    +				TypeSerializer namespaceSerializer =
    +						InstantiationUtil.deserializeObject(fsDataInputStream, userCodeClassLoader);
    +				TypeSerializer stateSerializer =
    +						InstantiationUtil.deserializeObject(fsDataInputStream, userCodeClassLoader);
     
    -				TypeSerializer namespaceSerializer = (TypeSerializer) ois.readObject();
    -				TypeSerializer stateSerializer = (TypeSerializer) ois.readObject();
    -				StateTable&amp;lt;K, ?, ?&amp;gt; stateTable = new StateTable(stateSerializer,
    +				StateTable&amp;lt;K, ?, ?&amp;gt; stateTable = new StateTable(
    +						stateSerializer,
     						namespaceSerializer,
     						keyGroupRange);
     				stateTables.put(stateName, stateTable);
     				kvStatesById.put(i, stateName);
     			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int keyGroupIndex = keyGroupRange.getStartKeyGroup(); keyGroupIndex &amp;lt;= keyGroupRange.getEndKeyGroup(); keyGroupIndex++) {&lt;br/&gt;
    +			for (int keyGroupIndex = keyGroupRange.getStartKeyGroup();  keyGroupIndex &amp;lt;= keyGroupRange.getEndKeyGroup(); ++keyGroupIndex) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Was this wrong before?&lt;/p&gt;</comment>
                            <comment id="15512838" author="githubbot" created="Thu, 22 Sep 2016 10:06:53 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2533#discussion_r80010321&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2533#discussion_r80010321&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -266,18 +265,20 @@ public void restorePartitionedState(List&amp;lt;KeyGroupsStateHandle&amp;gt; state) throws Exc&lt;br/&gt;
     			for (int i = 0; i &amp;lt; numKvStates; ++i) &lt;/p&gt;
{
     				String stateName = inView.readUTF();
     
    -				ObjectInputStream ois = new ObjectInputStream(inView);
    +				TypeSerializer namespaceSerializer =
    +						InstantiationUtil.deserializeObject(fsDataInputStream, userCodeClassLoader);
    +				TypeSerializer stateSerializer =
    +						InstantiationUtil.deserializeObject(fsDataInputStream, userCodeClassLoader);
     
    -				TypeSerializer namespaceSerializer = (TypeSerializer) ois.readObject();
    -				TypeSerializer stateSerializer = (TypeSerializer) ois.readObject();
    -				StateTable&amp;lt;K, ?, ?&amp;gt; stateTable = new StateTable(stateSerializer,
    +				StateTable&amp;lt;K, ?, ?&amp;gt; stateTable = new StateTable(
    +						stateSerializer,
     						namespaceSerializer,
     						keyGroupRange);
     				stateTables.put(stateName, stateTable);
     				kvStatesById.put(i, stateName);
     			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int keyGroupIndex = keyGroupRange.getStartKeyGroup(); keyGroupIndex &amp;lt;= keyGroupRange.getEndKeyGroup(); keyGroupIndex++) {&lt;br/&gt;
    +			for (int keyGroupIndex = keyGroupRange.getStartKeyGroup();  keyGroupIndex &amp;lt;= keyGroupRange.getEndKeyGroup(); ++keyGroupIndex) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think i wanted to break this because it exceeds the line limit but then decided against it because IntelliJ messed up the formatting for loops. Nothing wrong there at all.&lt;/p&gt;</comment>
                            <comment id="15512855" author="githubbot" created="Thu, 22 Sep 2016 10:12:07 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2533&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen at least in the RocksDB backend we could remove user code completely. Right now, the only thing that needs to be serialized is the TypeSerializer from the ValueDescriptor. It is used in a check that users can not provide a descriptor with a different TypeSerializer than the one that was used initially. We might think about removing this to support versioning of TypeSerializers, but how can we somehow enforce compatibility between them?&lt;/p&gt;</comment>
                            <comment id="15512918" author="githubbot" created="Thu, 22 Sep 2016 10:40:15 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2533&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I see, keeping the serializers for now makes probably sense.&lt;br/&gt;
    It just seems that there are also user functions in there (like fold, etc) - those should probably be removed. May mean that we have to inject them back into the state descriptor later.&lt;/p&gt;

&lt;p&gt;    Orthogonal issue, so +1 for this change.&lt;/p&gt;

&lt;p&gt;    Merging this...&lt;/p&gt;</comment>
                            <comment id="15513199" author="githubbot" created="Thu, 22 Sep 2016 12:44:13 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2533&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15513357" author="stephanewen" created="Thu, 22 Sep 2016 13:53:52 +0000"  >&lt;p&gt;Fixed via 3b8fe95ec728d59e3ffba2901450c56d7cca2b24&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 8 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33fpb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>