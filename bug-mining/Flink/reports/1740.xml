<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6646] YARN session doesn&apos;t work with HA</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6646</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;While testing Flink 1.3.0 RC1, I ran into the following issue on the JobManager.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2017-05-19 14:41:38,030 INFO  org.apache.flink.runtime.webmonitor.JobManagerRetriever       - New leader reachable under akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@permanent-qa-cluster-i7c9.c.astral-sorter-757.internal:36528/user/jobmanager:6539dc04-d7fe-4f85-a0b6-09bfb0de8a58.
&lt;/span&gt;2017-05-19 14:41:38,033 INFO  org.apache.flink.yarn.YarnFlinkResourceManager                - Resource Manager associating with leading JobManager Actor[akka:&lt;span class=&quot;code-comment&quot;&gt;//flink/user/jobmanager#1602741108] - leader session 6539dc04-d7fe-4f85-a0b6-09bfb0de8a58
&lt;/span&gt;2017-05-19 14:41:38,033 INFO  org.apache.flink.yarn.YarnFlinkResourceManager                - Requesting &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaskManager container with 1024 megabytes memory. Pending requests: 1
2017-05-19 14:41:38,781 INFO  org.apache.flink.yarn.YarnFlinkResourceManager                - Received &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; container: container_1494870922226_0061_02_000002 - Remaining pending container requests: 0
2017-05-19 14:41:38,782 INFO  org.apache.flink.yarn.YarnFlinkResourceManager                - Launching TaskManager in container ContainerInLaunch @ 1495204898782: Container: [ContainerId: container_1494870922226_0061_02_000002, NodeId: permanent-qa-cluster-d3iz.c.astral-sorter-757.internal:8041, NodeHttpAddress: permanent-qa-cluster-d3iz.c.astral-sorter-757.internal:8042, Resource: &amp;lt;memory:1024, vCores:1&amp;gt;, Priority: 0, Token: Token { kind: ContainerToken, service: 10.240.0.32:8041 }, ] on host permanent-qa-cluster-d3iz.c.astral-sorter-757.internal
2017-05-19 14:41:38,788 INFO  org.apache.hadoop.yarn.client.api.impl.ContainerManagementProtocolProxy  - Opening proxy : permanent-qa-cluster-d3iz.c.astral-sorter-757.internal:8041
2017-05-19 14:41:44,284 INFO  org.apache.flink.yarn.YarnFlinkResourceManager                - Container container_1494870922226_0061_02_000002 failed, with a TaskManager in launch or registration. Exit status: -1000
2017-05-19 14:41:44,284 INFO  org.apache.flink.yarn.YarnFlinkResourceManager                - Diagnostics &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; container container_1494870922226_0061_02_000002 in state COMPLETE : exitStatus=-1000 diagnostics=File does not exist: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//nameservice1/user/robert/.flink/application_1494870922226_0061/cf9287fe-ac75-4066-a648-91787d946890-taskmanager-conf.yaml
&lt;/span&gt;java.io.FileNotFoundException: File does not exist: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//nameservice1/user/robert/.flink/application_1494870922226_0061/cf9287fe-ac75-4066-a648-91787d946890-taskmanager-conf.yaml
&lt;/span&gt;	at org.apache.hadoop.hdfs.DistributedFileSystem$19.doCall(DistributedFileSystem.java:1219)
	at org.apache.hadoop.hdfs.DistributedFileSystem$19.doCall(DistributedFileSystem.java:1211)
	at org.apache.hadoop.fs.FileSystemLinkResolver.resolve(FileSystemLinkResolver.java:81)
	at org.apache.hadoop.hdfs.DistributedFileSystem.getFileStatus(DistributedFileSystem.java:1211)
	at org.apache.hadoop.yarn.util.FSDownload.copy(FSDownload.java:251)
	at org.apache.hadoop.yarn.util.FSDownload.access$000(FSDownload.java:61)
	at org.apache.hadoop.yarn.util.FSDownload$2.run(FSDownload.java:359)
	at org.apache.hadoop.yarn.util.FSDownload$2.run(FSDownload.java:357)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:415)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1698)
	at org.apache.hadoop.yarn.util.FSDownload.call(FSDownload.java:356)
	at org.apache.hadoop.yarn.util.FSDownload.call(FSDownload.java:60)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is the following:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;JobManager1 starts from a yarn-session.sh&lt;/li&gt;
	&lt;li&gt;Job1 gets submitted to JobManager1&lt;/li&gt;
	&lt;li&gt;JobManager1 dies&lt;/li&gt;
	&lt;li&gt;YARN starts a new JM: JobManager2&lt;/li&gt;
	&lt;li&gt;in the meantime, errors on the yarn-session.sh appear, shutting down the session. This includes deleting the yarn staging directory in HDFS.&lt;/li&gt;
	&lt;li&gt;JobManager2 is unable to start a new Taskmanager because files in staging got deleted by the client.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13073480">FLINK-6646</key>
            <summary>YARN session doesn&apos;t work with HA</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 May 2017 16:08:53 +0000</created>
                <updated>Fri, 26 May 2017 08:46:13 +0000</updated>
                            <resolved>Fri, 26 May 2017 08:45:59 +0000</resolved>
                                    <version>1.2.0</version>
                    <version>1.3.0</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Deployment / YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16019372" author="aljoscha" created="Mon, 22 May 2017 09:34:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt; shouldn&apos;t this be a blocker?&lt;/p&gt;</comment>
                            <comment id="16022581" author="till.rohrmann" created="Wed, 24 May 2017 09:13:24 +0000"  >&lt;p&gt;This issue was already present in &lt;tt&gt;1.2&lt;/tt&gt;. Thus, strictly spoken this is not a regression. I try to fix it asap. Maybe it still makes it into the release.&lt;/p&gt;</comment>
                            <comment id="16022879" author="till.rohrmann" created="Wed, 24 May 2017 13:19:38 +0000"  >&lt;p&gt;This is actually not limited to the yarn-session but also applies to the yarn-cluster mode. The only reason why it didn&apos;t surface so far is that in the yarn-cluster mode we use a higher connection timeout &lt;tt&gt;60 s&lt;/tt&gt; compared to &lt;tt&gt;10 s&lt;/tt&gt; in the session mode.&lt;/p&gt;

&lt;p&gt;The underlying problem is, however, the wrong resource lifecycle management of the application files. In the current version, the &lt;tt&gt;ClusterClient&lt;/tt&gt; decides when to delete the Flink cluster files even though this should be the responsibility of the &lt;tt&gt;YarnApplicationMaster&lt;/tt&gt;. The &lt;tt&gt;YarnApplicationMaster&lt;/tt&gt; should decide when the Yarn application has terminated and when the files can be deleted. This wrong separation of concerns also causes why the uploaded application files are never deleted in case of a detached execution.&lt;/p&gt;

&lt;p&gt;The correction of the resource lifecycle management is actually a bigger task and should be properly implemented with the upcoming Flip-6 work. Therefore, I propose to mitigate the current problem by increasing the connection timeout also for the yarn session similar to the yarn-cluster mode.&lt;/p&gt;</comment>
                            <comment id="16023123" author="till.rohrmann" created="Wed, 24 May 2017 15:51:03 +0000"  >&lt;p&gt;Actually, I have to correct myself wrt to the severity of the problem. Given that the &lt;tt&gt;ClusterClient&lt;/tt&gt; deletes crucial files which are needed to recover an &lt;tt&gt;ApplicationMaster&lt;/tt&gt; failure which effectively thwarts Flink&apos;s HA capabilities, I would make this issue a blocker.&lt;/p&gt;</comment>
                            <comment id="16023151" author="githubbot" created="Wed, 24 May 2017 16:13:40 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3981&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6646&quot; title=&quot;YARN session doesn&amp;#39;t work with HA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6646&quot;&gt;&lt;del&gt;FLINK-6646&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Let YarnJobManager delete Yarn application files&lt;/p&gt;

&lt;p&gt;    Before the YarnClusterClient decided when to delete the Yarn application files.&lt;br/&gt;
    This is problematic because the client does not know whether a Yarn application&lt;br/&gt;
    is being restarted or terminated. Due to this the files where always deleted. This&lt;br/&gt;
    prevents Yarn from restarting a failed ApplicationMaster, effectively thwarting&lt;br/&gt;
    Flink&apos;s HA capabilities.&lt;/p&gt;

&lt;p&gt;    The PR changes the behaviour such that the YarnJobManager deletes the Yarn files&lt;br/&gt;
    if it receives a StopCluster message. That way, we can be sure that the yarn files&lt;br/&gt;
    are deleted only iff the cluster is intended to be shut down.&lt;/p&gt;

&lt;p&gt;    cc @rmetzger &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; fixYarnSession&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3981.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3981.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3981&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 72ce39a1752cc19669f003b70cc2708852a06ac5&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-05-24T15:59:51Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6646&quot; title=&quot;YARN session doesn&amp;#39;t work with HA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6646&quot;&gt;&lt;del&gt;FLINK-6646&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Let YarnJobManager delete Yarn application files&lt;/p&gt;

&lt;p&gt;    Before the YarnClusterClient decided when to delete the Yarn application files.&lt;br/&gt;
    This is problematic because the client does not know whether a Yarn application&lt;br/&gt;
    is being restarted or terminated. Due to this the files where always deleted. This&lt;br/&gt;
    prevents Yarn from restarting a failed ApplicationMaster, effectively thwarting&lt;br/&gt;
    Flink&apos;s HA capabilities.&lt;/p&gt;

&lt;p&gt;    The PR changes the behaviour such that the YarnJobManager deletes the Yarn files&lt;br/&gt;
    if it receives a StopCluster message. That way, we can be sure that the yarn files&lt;br/&gt;
    are deleted only iff the cluster is intended to be shut down.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16023200" author="githubbot" created="Wed, 24 May 2017 16:43:09 +0000"  >&lt;p&gt;Github user tedyu commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3981#discussion_r118304278&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3981#discussion_r118304278&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/scala/org/apache/flink/yarn/YarnJobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -89,5 +92,37 @@ class YarnJobManager(&lt;br/&gt;
           flinkConfiguration.getInteger(ConfigConstants.YARN_HEARTBEAT_DELAY_SECONDS, 5),&lt;br/&gt;
           TimeUnit.SECONDS)&lt;/p&gt;

&lt;p&gt;    +  val yarnFilesPath: Option&lt;span class=&quot;error&quot;&gt;&amp;#91;String&amp;#93;&lt;/span&gt; = Option(System.getenv().get(YarnConfigKeys.FLINK_YARN_FILES))&lt;br/&gt;
    +&lt;br/&gt;
       override val jobPollingInterval = YARN_HEARTBEAT_DELAY&lt;br/&gt;
    +&lt;br/&gt;
    +  override def handleMessage: Receive = &lt;/p&gt;
{
    +    handleYarnShutdown orElse super.handleMessage
    +  }
&lt;p&gt;    +&lt;br/&gt;
    +  def handleYarnShutdown: Receive = {&lt;br/&gt;
    +    case msg:StopCluster =&amp;gt;&lt;br/&gt;
    +      super.handleMessage(msg)&lt;br/&gt;
    +&lt;br/&gt;
    +      // do global cleanup if the yarn files path has been set&lt;br/&gt;
    +      yarnFilesPath match {&lt;br/&gt;
    +        case Some(filePath) =&amp;gt;&lt;br/&gt;
    +          log.info(s&quot;Deleting yarn application files under $filePath.&quot;)&lt;br/&gt;
    +&lt;br/&gt;
    +          val path = new Path(filePath)&lt;br/&gt;
    +&lt;br/&gt;
    +          try {&lt;br/&gt;
    +            val fs = path.getFileSystem&lt;br/&gt;
    +            fs.delete(path, true)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Please check the return value from delete() call&lt;/p&gt;</comment>
                            <comment id="16025750" author="githubbot" created="Fri, 26 May 2017 03:27:57 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3981&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging this. My reviews on this change is covered in #3981.&lt;br/&gt;
    @tedyu I&apos;ll address your comments while merging, thanks!&lt;/p&gt;</comment>
                            <comment id="16025982" author="githubbot" created="Fri, 26 May 2017 08:28:58 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3981&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16026008" author="tzulitai" created="Fri, 26 May 2017 08:45:59 +0000"  >&lt;p&gt;Fixed for master via fd9146295b7af6ce1a2976a52a71add1c5a37f99.&lt;br/&gt;
Fixed for 1.3 via 2e138f1009b30c91aa73a704cc175f9e61ca52ea.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3f8br:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>