<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19816] Flink restored from a wrong checkpoint (a very old one and not the last completed one)</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19816</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Summary&quot;&gt;&lt;/a&gt;Summary&lt;/h2&gt;

&lt;p&gt;Upon failure, it seems that Flink didn&apos;t restore from the last completed checkpoint. Instead, it restored from a very old checkpoint. As a result, Kafka offsets are invalid and caused the job to replay from the beginning as Kafka consumer &quot;auto.offset.reset&quot; was set to &quot;EARLIEST&quot;.&lt;/p&gt;

&lt;p&gt;This is an embarrassingly parallel stateless job. Parallelism is over 1,000. I have the full log file from jobmanager at INFO level available upon request.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Sequenceofeventsfromthelogs&quot;&gt;&lt;/a&gt;Sequence of events from the logs&lt;/h2&gt;

&lt;p&gt;Just before the failure, checkpoint&#160;&lt;b&gt;210768&lt;/b&gt; completed.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-10-25 02:35:05,970 INFO org.apache.flink.runtime.checkpoint.CheckpointCoordinator [jobmanager-&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;-thread-5] - Completed checkpoint 210768 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 233b4938179c06974e4535ac8a868675 (4623776 bytes in 120402 ms).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;During restart, somehow it decided to restore from a very old checkpoint &lt;b&gt;203531&lt;/b&gt;.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-10-25 02:36:03,301 INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [cluster-io-thread-3]  - Start SessionDispatcherLeaderProcess.
2020-10-25 02:36:03,302 INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [cluster-io-thread-5]  - Recover all persisted job graphs.
2020-10-25 02:36:03,304 INFO  com.netflix.bdp.s3fs.BdpS3FileSystem                         [cluster-io-thread-25]  - Deleting path: s3:&lt;span class=&quot;code-comment&quot;&gt;//&amp;lt;bucket&amp;gt;/checkpoints/XM3B/clapp_avro-clapp_avro_nontvui/1593/233b4938179c06974e4535ac8a868675/chk-210758/c31aec1e-07a7-4193-aa00-3fbe83f9e2e6
&lt;/span&gt;2020-10-25 02:36:03,307 INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [cluster-io-thread-5]  - Trying to recover job with job id 233b4938179c06974e4535ac8a868675.

2020-10-25 02:36:03,381 INFO  com.netflix.bdp.s3fs.BdpS3FileSystem                         [cluster-io-thread-25]  - Deleting path: s3:&lt;span class=&quot;code-comment&quot;&gt;//&amp;lt;bucket&amp;gt;/checkpoints/Hh86/clapp_avro-clapp_avro_nontvui/1593/233b4938179c06974e4535ac8a868675/chk-210758/4ab92f70-dfcd-4212-9b7f-bdbecb9257fd
&lt;/span&gt;...
2020-10-25 02:36:03,427 INFO  org.apache.flink.runtime.checkpoint.ZooKeeperCompletedCheckpointStore [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-82003]  - Recovering checkpoints from ZooKeeper.
2020-10-25 02:36:03,432 INFO  org.apache.flink.runtime.checkpoint.ZooKeeperCompletedCheckpointStore [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-82003]  - Found 0 checkpoints in ZooKeeper.
2020-10-25 02:36:03,432 INFO  org.apache.flink.runtime.checkpoint.ZooKeeperCompletedCheckpointStore [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-82003]  - Trying to fetch 0 checkpoints from storage.
2020-10-25 02:36:03,432 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-82003]  - Starting job 233b4938179c06974e4535ac8a868675 from savepoint s3:&lt;span class=&quot;code-comment&quot;&gt;//&amp;lt;bucket&amp;gt;/checkpoints/metadata/clapp_avro-clapp_avro_nontvui/1113/47e2a25a8d0b696c7d0d423722bb6f54/chk-203531/_metadata ()&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13337309">FLINK-19816</key>
            <summary>Flink restored from a wrong checkpoint (a very old one and not the last completed one)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="stevenz3wu">Steven Zhen Wu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 27 Oct 2020 01:14:34 +0000</created>
                <updated>Thu, 2 Sep 2021 12:57:25 +0000</updated>
                            <resolved>Wed, 18 Nov 2020 08:00:51 +0000</resolved>
                                    <version>1.11.0</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.11.3</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="17226460" author="stevenz3wu" created="Thu, 5 Nov 2020 02:25:30 +0000"  >&lt;p&gt;This happened again for the same job in production. I noticed both failures started with zookeeper failure. Here are some observations on the sequence of events. My hypothesis is that the race condition / interactions between recovering from zk failure and failure-rate restart-strategy caused this problem of restoring a wrong and very old checkpoint. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; any comment?&lt;/p&gt;

&lt;p&gt;1. initially, there were some problems with zookeeper that caused the job to fail&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-10-25 02:35:59,266 WARN  org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn [main-SendThread(ip-100-81-150-64.us-west-2.compute.internal:2181)]  - Client session timed out, have not heard from server in 26676
ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sessionid 0x363850d0d034d9d
2020-10-25 02:35:59,268 INFO  org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn [main-SendThread(ip-100-81-150-64.us-west-2.compute.internal:2181)]  - Client session timed out, have not heard from server in 26676
ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sessionid 0x363850d0d034d9d, closing socket connection and attempting reconnect
2020-10-25 02:35:59,282 INFO  com.netflix.bdp.s3fs.BdpS3FileSystem                         [cluster-io-thread-25]  - Deleting path: s3:&lt;span class=&quot;code-comment&quot;&gt;//us-west-2.spaas.prod/checkpoints/r7E1/clapp_avro-clapp_avro_nontvui/1593/233b4938179c06974e4
&lt;/span&gt;535ac8a868675/chk-210758/16d4e138-4199-4fd2-a014-4b394189f72b
2020-10-25 02:35:59,369 INFO  org.apache.flink.shaded.curator4.org.apache.curator.framework.state.ConnectionStateManager [main-EventThread]  - State change: SUSPENDED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;2. This job is configured with `restart-strategy=failure-rate`. and there are enough task restarts to trigger the terminal condition canRestart() to return false. This should eventually lead the Flink job to halt/terminal state.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-10-25 02:35:59,641 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-81991]  - Job clapp-avro-nontvui (233b4938179c06974e4535ac8a868675) switched from state FAILING to FA
ILED.
org.apache.flink.runtime.JobException: Recovery is suppressed by FailureRateRestartBackoffTimeStrategy(FailureRateRestartBackoffTimeStrategy(failuresIntervalMS=1800000,backoffTimeMS=30000,maxFailuresPerInterval=20)
        at org.apache.flink.runtime.executiongraph.failover.flip1.ExecutionFailureHandler.handleFailure(ExecutionFailureHandler.java:116)
        at org.apache.flink.runtime.executiongraph.failover.flip1.ExecutionFailureHandler.getFailureHandlingResult(ExecutionFailureHandler.java:78)
        at org.apache.flink.runtime.scheduler.DefaultScheduler.handleTaskFailure(DefaultScheduler.java:203)
        at org.apache.flink.runtime.scheduler.DefaultScheduler.maybeHandleTaskFailure(DefaultScheduler.java:185)
        at org.apache.flink.runtime.scheduler.DefaultScheduler.updateTaskExecutionStateInternal(DefaultScheduler.java:179)
        at org.apache.flink.runtime.scheduler.SchedulerBase.updateTaskExecutionState(SchedulerBase.java:508)
        at org.apache.flink.runtime.scheduler.UpdateSchedulerNgOnInternalFailuresListener.notifyTaskFailure(UpdateSchedulerNgOnInternalFailuresListener.java:49)
        at org.apache.flink.runtime.executiongraph.ExecutionGraph.notifySchedulerNgAboutInternalTaskFailure(ExecutionGraph.java:1725)
        at org.apache.flink.runtime.executiongraph.Execution.processFail(Execution.java:1287)
        at org.apache.flink.runtime.executiongraph.Execution.processFail(Execution.java:1255)
        at org.apache.flink.runtime.executiongraph.Execution.fail(Execution.java:954)
        at org.apache.flink.runtime.jobmaster.slotpool.SingleLogicalSlot.signalPayloadRelease(SingleLogicalSlot.java:173)
        at org.apache.flink.runtime.jobmaster.slotpool.SingleLogicalSlot.release(SingleLogicalSlot.java:165)
        at org.apache.flink.runtime.jobmaster.slotpool.SlotSharingManager$SingleTaskSlot.release(SlotSharingManager.java:732)
        at org.apache.flink.runtime.jobmaster.slotpool.SlotSharingManager$MultiTaskSlot.release(SlotSharingManager.java:537)
        at org.apache.flink.runtime.jobmaster.slotpool.AllocatedSlot.releasePayload(AllocatedSlot.java:149)
        at org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl.releaseTaskManagerInternal(SlotPoolImpl.java:818)
        at org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl.releaseTaskManager(SlotPoolImpl.java:777)
        at org.apache.flink.runtime.jobmaster.JobMaster.disconnectTaskManager(JobMaster.java:435)
        at org.apache.flink.runtime.jobmaster.JobMaster.onStop(JobMaster.java:352)
        at org.apache.flink.runtime.rpc.RpcEndpoint.internalCallOnStop(RpcEndpoint.java:216)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor$StartedState.terminate(AkkaRpcActor.java:514)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleControlMessage(AkkaRpcActor.java:176)
        at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:26)
        at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:21)
        at scala.PartialFunction.applyOrElse(PartialFunction.scala:123)
        at scala.PartialFunction.applyOrElse$(PartialFunction.scala:122)
        at akka.japi.pf.UnitCaseStatement.applyOrElse(CaseStatements.scala:21)
        at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171)
        at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:172)
        at akka.actor.Actor.aroundReceive(Actor.scala:517)
        at akka.actor.Actor.aroundReceive$(Actor.scala:515)
        at akka.actor.AbstractActor.aroundReceive(AbstractActor.scala:225)
        at akka.actor.ActorCell.receiveMessage(ActorCell.scala:592)
        at akka.actor.ActorCell.invoke(ActorCell.scala:561)
        at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:258)
        at akka.dispatch.Mailbox.run(Mailbox.scala:225)
        at akka.dispatch.Mailbox.exec(Mailbox.scala:235)
        at akka.dispatch.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
        at akka.dispatch.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
        at akka.dispatch.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
        at akka.dispatch.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
Caused by: org.apache.flink.util.FlinkException: Stopping JobMaster &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job clapp-avro-nontvui(233b4938179c06974e4535ac8a868675).
        at org.apache.flink.runtime.jobmaster.JobMaster.onStop(JobMaster.java:349)
        ... 22 more
2020-10-25 02:35:59,641 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-81991]  - Stopping checkpoint coordinator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 233b4938179c06974e4535ac8a868675.
2020-10-25 02:35:59,641 INFO  org.apache.flink.runtime.checkpoint.ZooKeeperCompletedCheckpointStore [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-81991]  - Shutting down
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. Flink then removes the checkpoint-counter from zk, as it tries to fail/halt the job&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-10-25 02:36:03,262 INFO  org.apache.flink.runtime.zookeeper.ZooKeeperStateHandleStore [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-81991]  - Removing /spaas/clapp_avro-clapp_avro_nontvui/1593/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/checkpoints/233b4938179c06974e45
35ac8a868675 from ZooKeeper
2020-10-25 02:36:03,269 INFO  org.apache.flink.runtime.checkpoint.ZooKeeperCheckpointIDCounter [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-81991]  - Shutting down.
2020-10-25 02:36:03,269 INFO  org.apache.flink.runtime.checkpoint.ZooKeeperCheckpointIDCounter [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-81991]  - Removing /checkpoint-counter/233b4938179c06974e4535ac8a868675 from ZooKeeper
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4. but somehow Flink tries to start the job again even though failure-rate restart-strategy reached terminal state for canRestart(). maybe it is because the zookeeper reconnect caused another path of job recovery? because the proper checkpoint info in zookeeper is already cleaned in previous step, now Flink recovered a wrong checkpoint.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-10-25 02:36:03,301 INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [cluster-io-thread-3]  - Start SessionDispatcherLeaderProcess.
2020-10-25 02:36:03,302 INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [cluster-io-thread-5]  - Recover all persisted job graphs.
2020-10-25 02:36:03,307 INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [cluster-io-thread-5]  - Trying to recover job with job id 233b4938179c06974e4535ac8a868675.
...
2020-10-25 02:36:03,427 INFO  org.apache.flink.runtime.checkpoint.ZooKeeperCompletedCheckpointStore [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-82003]  - Recovering checkpoints from ZooKeeper.
2020-10-25 02:36:03,432 INFO  org.apache.flink.runtime.checkpoint.ZooKeeperCompletedCheckpointStore [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-82003]  - Found 0 checkpoints in ZooKeeper.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17226595" author="till.rohrmann" created="Thu, 5 Nov 2020 09:17:55 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevenz3wu&quot; class=&quot;user-hover&quot; rel=&quot;stevenz3wu&quot;&gt;stevenz3wu&lt;/a&gt;, thanks a lot for this analysis. Have you gotten hold of the complete logs? I will go through the code to see whether I see a problem and the logs might speed this process up a bit. In any case, this sounds like a bug in Flink to me.&lt;/p&gt;</comment>
                            <comment id="17226609" author="till.rohrmann" created="Thu, 5 Nov 2020 09:51:09 +0000"  >&lt;p&gt;Looking at the code, I believe that the scenario you are describing can actually happen. If the job is about to complete successfully, it will notify the &lt;tt&gt;Dispatcher&lt;/tt&gt; and then remove all checkpoints from the &lt;tt&gt;CompletedCheckpointStore&lt;/tt&gt;. If at the same time, the Dispatcher loses the leadership, it will stop all running jobs but w/o cleaning up the persisted jobs. Depending on which action is executed first (losing the leadership and stopping jobs w/o cleaning up the persisted JobGraph or completing successfully and cleaning up the persisted JobGraph) one can end up with a cluster where one has deleted all checkpoint data but not the &lt;tt&gt;JobGraph&lt;/tt&gt; itself.&lt;/p&gt;

&lt;p&gt;I think the problem is that we don&apos;t look at the final job status when deciding whether to clean up the persisted &lt;tt&gt;JobGraph&lt;/tt&gt; or not but we decide on &lt;tt&gt;cleanupHA&lt;/tt&gt; when the &lt;tt&gt;Dispatcher&lt;/tt&gt; is being stopped or when the job reaches a globally terminal state. In the former case, this can lead to ignoring a successful termination of the job.&lt;/p&gt;</comment>
                            <comment id="17226740" author="stevenz3wu" created="Thu, 5 Nov 2020 14:40:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; thanks a lot for taking a look. forwarded the logs to you. but it seems that we may not need them&lt;/p&gt;</comment>
                            <comment id="17227266" author="xintongsong" created="Fri, 6 Nov 2020 09:20:51 +0000"  >&lt;p&gt;Thanks for the discussion, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevenz3wu&quot; class=&quot;user-hover&quot; rel=&quot;stevenz3wu&quot;&gt;stevenz3wu&lt;/a&gt;&#160;&amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, is this a new problem introduced after 1.11.0? If not, maybe we can downgrade it to a critical issue, given that the problem only affects under zookeeper failures.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="17227412" author="till.rohrmann" created="Fri, 6 Nov 2020 13:54:31 +0000"  >&lt;p&gt;This problem is not new. However, it affects all HA setups and can effectively cause data duplication in exactly once sinks because we might simply run a job twice because of this bug. Hence, I believe that it is a true blocker which we must fix before releasing.&lt;/p&gt;</comment>
                            <comment id="17227425" author="xintongsong" created="Fri, 6 Nov 2020 14:12:21 +0000"  >&lt;p&gt;Alright, thanks for the explanation.&lt;/p&gt;</comment>
                            <comment id="17227446" author="till.rohrmann" created="Fri, 6 Nov 2020 15:18:36 +0000"  >&lt;p&gt;It turns out that we actually have two problems:&lt;/p&gt;

&lt;p&gt;1) What we have already described: A job reaching a globally terminal state while being suspended and the resulting race condition is a problem.&lt;/p&gt;

&lt;p&gt;2) Stopping the JobMaster causing the job to fail and thereby to exceed the maximum allowed number of restarts causing it to go to &lt;tt&gt;FAILED&lt;/tt&gt;. That&apos;s also what happened in your case &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevenz3wu&quot; class=&quot;user-hover&quot; rel=&quot;stevenz3wu&quot;&gt;stevenz3wu&lt;/a&gt;. This problem has been unintentionally fixed via &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19237&quot; title=&quot;LeaderChangeClusterComponentsTest.testReelectionOfJobMaster failed with &amp;quot;NoResourceAvailableException: Could not allocate the required slot within slot request timeout&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19237&quot;&gt;&lt;del&gt;FLINK-19237&lt;/del&gt;&lt;/a&gt; for &lt;tt&gt;1.12&lt;/tt&gt;. I will create a new ticket to also fix it for &lt;tt&gt;1.10&lt;/tt&gt; and &lt;tt&gt;1.11&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17227458" author="till.rohrmann" created="Fri, 6 Nov 2020 15:33:32 +0000"  >&lt;p&gt;The new ticket for tracking the second problem is &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20033&quot; title=&quot;Job fails when stopping JobMaster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20033&quot;&gt;&lt;del&gt;FLINK-20033&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17228601" author="till.rohrmann" created="Mon, 9 Nov 2020 13:56:37 +0000"  >&lt;p&gt;After fixing &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20033&quot; title=&quot;Job fails when stopping JobMaster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20033&quot;&gt;&lt;del&gt;FLINK-20033&lt;/del&gt;&lt;/a&gt;, I&apos;ve downgraded this issue to critical because the problem should now be very unlikely to happen. Still we should fix this problem asap.&lt;/p&gt;</comment>
                            <comment id="17234344" author="till.rohrmann" created="Wed, 18 Nov 2020 08:00:51 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.12.0: cb850fdda2b40866f3b0782e038ae4bce35c9eb0&lt;br/&gt;
1.11.3: a2925a0d2e894bf28aaced2993ec453589d143de&lt;/p&gt;</comment>
                            <comment id="17408693" author="paul lin" created="Thu, 2 Sep 2021 08:51:44 +0000"  >&lt;p&gt;Still getting this error with Flink 1.12.3. The jobmanager logs are attached, please take a look. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13032889/13032889_jm.log&quot; title=&quot;jm.log attached to FLINK-19816&quot;&gt;jm.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17408801" author="till.rohrmann" created="Thu, 2 Sep 2021 12:56:39 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Paul+Lin&quot; class=&quot;user-hover&quot; rel=&quot;Paul Lin&quot;&gt;Paul Lin&lt;/a&gt;, I think you are not running into the concrete issue that is fixed with this ticket. Instead I believe that you are running into &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11813&quot; title=&quot;Standby per job mode Dispatchers don&amp;#39;t know job&amp;#39;s JobSchedulingStatus&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11813&quot;&gt;&lt;del&gt;FLINK-11813&lt;/del&gt;&lt;/a&gt; that will be fixed with the next release. &lt;/p&gt;

&lt;p&gt;I think the following is happening: The job reaches a globally terminal state (FAILED). Then it tells the &lt;tt&gt;Dispatcher&lt;/tt&gt; that triggers the clean up of HA information. After the cleanup has happened, the &lt;tt&gt;Dispatcher&lt;/tt&gt; process loses the leadership and is restarted. Since you seem to use the application mode/per job mode, Flink will be started with the same job but with no checkpoint information since it has been cleaned up. This will ultimately result in a restart.&lt;/p&gt;

&lt;p&gt;Part of the problem has been solved via &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21979&quot; title=&quot;Job can be restarted from the beginning after it reached a terminal state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21979&quot;&gt;&lt;del&gt;FLINK-21979&lt;/del&gt;&lt;/a&gt; but the last remaining piece is &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11813&quot; title=&quot;Standby per job mode Dispatchers don&amp;#39;t know job&amp;#39;s JobSchedulingStatus&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11813&quot;&gt;&lt;del&gt;FLINK-11813&lt;/del&gt;&lt;/a&gt; that will most likely introduce a &lt;tt&gt;JobResultStore&lt;/tt&gt; that can outlive Flink. Only by persisting information about the job status that can survive a cluster failure, we are able to properly resolve the situation. As a consequence, there will be some bookkeeping information that needs to be taken care of by the user/operator of Flink.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13336863">FLINK-19778</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13339202">FLINK-20033</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13367670">FLINK-21979</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13219310">FLINK-11813</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13032889" name="jm.log" size="86699" author="Paul Lin" created="Thu, 2 Sep 2021 08:51:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k0tc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>