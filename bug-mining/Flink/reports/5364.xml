<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:56:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19449] LEAD/LAG cannot work correctly in streaming mode</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19449</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description></description>
                <environment></environment>
        <key id="13329893">FLINK-19449</key>
            <summary>LEAD/LAG cannot work correctly in streaming mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lzljs3620320">Jingsong Lee</assignee>
                                    <reporter username="libenchao">Benchao Li</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>stale-major</label>
                    </labels>
                <created>Tue, 29 Sep 2020 09:03:48 +0000</created>
                <updated>Fri, 28 May 2021 11:05:42 +0000</updated>
                            <resolved>Wed, 28 Apr 2021 09:24:24 +0000</resolved>
                                    <version>1.10.2</version>
                    <version>1.11.2</version>
                                    <fixVersion>1.14.0</fixVersion>
                    <fixVersion>1.13.1</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="17292701" author="laiyijie" created="Mon, 1 Mar 2021 08:00:11 +0000"  >&lt;p&gt;&#22312;&#27969;&#24335;&#22788;&#29702;&#20013;&#36935;&#21040;&#21516;&#26679;&#30340;&#38382;&#39064;&lt;/p&gt;

&lt;p&gt;sql&#35821;&#21477;&#20026;&lt;/p&gt;

&lt;p&gt;select *, lead(`at`) over ( partition by bond_id order by t_start ) as `lag_at`&lt;/p&gt;

&lt;p&gt;lag_at &#30340;&#20540;&#20250;&#21644;&#24403;&#21069;&#34892;&#30340;&#20540;&#19968;&#33268;&#65292;lead&#26041;&#27861;&#20063;&#21516;&#26679;&#26377;&#38382;&#39064;&lt;/p&gt;</comment>
                            <comment id="17294063" author="libenchao" created="Wed, 3 Mar 2021 00:12:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=laiyijie&quot; class=&quot;user-hover&quot; rel=&quot;laiyijie&quot;&gt;laiyijie&lt;/a&gt;&#160;Thanks for your comment, please use English in Jira issues.&lt;/p&gt;

&lt;p&gt;And for your comment, yes, your observation is correct. For now, lead/lag is only correctly implemented in Batch SQL, and they are special from other aggregate functions. In Streaming SQL, I think we can support LAG firstly, and throw Exception for LEAD.&lt;/p&gt;</comment>
                            <comment id="17296775" author="laiyijie" created="Sun, 7 Mar 2021 07:00:35 +0000"  >&lt;p&gt;Support LAG firstly is a good idea. I think LAG is a basic function. It&apos;s important to fixed thi bug. we can store the list of value . The size of the list is the lag&apos;s offset param. remove the first element when retract . return the first value when get value.&#160;&lt;/p&gt;</comment>
                            <comment id="17297009" author="libenchao" created="Sun, 7 Mar 2021 23:39:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=laiyijie&quot; class=&quot;user-hover&quot; rel=&quot;laiyijie&quot;&gt;laiyijie&lt;/a&gt;&#160;IMO, a full-fledged LAG function implementation with `merge`, `retract` is complex. We cannot assume the records are retracted in the order of appending, hence just remove the first element when retract maybe not correct.&lt;/p&gt;

&lt;p&gt;In our internal branch, I see a lot of usage of LAG without index. And I just implement a simplest one which does not support `retract`, `merge`, and the index either. What do you think?&lt;/p&gt;</comment>
                            <comment id="17297055" author="laiyijie" created="Mon, 8 Mar 2021 03:49:13 +0000"  >&lt;p&gt;LI, Implementation&#160; without the index may not be so good, but is a temporary solution. The `retract` and `merge` function is not so importand for LAG. I suggest to implement a LAG function with index. In the streaming mode , it could cover more situation than that without index .&lt;/p&gt;

&lt;p&gt;I have tried to implement a UDF function for lag without `retract` and `merge` , but the UDF function has a restriction which cannot support different type of data in single one function name `LAG`.&#160;&lt;/p&gt;

&lt;p&gt;I test&#160; the UDF in the streaming mode, and the result is correct.&#160; And I think the `accumulate` function is called by order in streaming mode in over window with orderby.&lt;/p&gt;

&lt;p&gt;finnaly what I wanna to resolve was the problem of cannot using lag in streaming mode.&#160; Of course with index.&lt;/p&gt;

&lt;p&gt;THX for your reading, I really wanna to fix this problem&#160; and make flink better in basic functions.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here is my UDF of `LAG` with index.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;public class LagAggFunction&amp;lt;T&amp;gt; extends AggregateFunction&amp;lt;T, LagAggFunction.Acc&amp;lt;T&amp;gt;&amp;gt; {&lt;br/&gt;
 protected Integer offset = 1;&lt;/p&gt;

&lt;p&gt; public static class Acc&amp;lt;T&amp;gt; &lt;/p&gt;
{
 LinkedList&amp;lt;T&amp;gt; window = new LinkedList&amp;lt;&amp;gt;();
 }

&lt;p&gt; @Override&lt;br/&gt;
 public Acc&amp;lt;T&amp;gt; createAccumulator() &lt;/p&gt;
{
 return new Acc&amp;lt;T&amp;gt;();
 }

&lt;p&gt; @Override&lt;br/&gt;
 public T getValue(Acc&amp;lt;T&amp;gt; acc) {&lt;br/&gt;
 if (acc.window.size() - 1 &amp;lt; this.offset)&lt;/p&gt;
{
 return null;
 }
&lt;p&gt; return acc.window.getFirst();&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt; public void accumulate(Acc&amp;lt;T&amp;gt; acc, T iValue, Integer offset) {&lt;br/&gt;
 this.offset = offset;&lt;br/&gt;
 if (this.offset == null) &lt;/p&gt;
{
 this.offset = 1;
 }
&lt;p&gt; acc.window.add(iValue);&lt;br/&gt;
 if (acc.window.size() - 1 &amp;gt; this.offset) &lt;/p&gt;
{
 acc.window.removeFirst();
 }
&lt;p&gt; }&lt;/p&gt;

&lt;p&gt; public void resetAccumulator(Acc&amp;lt;T&amp;gt; acc) &lt;/p&gt;
{
 acc.window = new LinkedList&amp;lt;T&amp;gt;();
 }

&lt;p&gt; public static class FloatLag extends LagAggFunction&amp;lt;Float&amp;gt; {}&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17327625" author="flink-jira-bot" created="Thu, 22 Apr 2021 11:06:35 +0000"  >&lt;p&gt;This major issue is unassigned and itself and all of its Sub-Tasks have not been updated for 30 days. So, it has been labeled &quot;stale-major&quot;. If this ticket is indeed &quot;major&quot;, please either assign yourself or give an update. Afterwards, please remove the label. In 7 days the issue will be deprioritized.&lt;/p&gt;</comment>
                            <comment id="17329970" author="lzljs3620320" created="Fri, 23 Apr 2021 04:36:17 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=laiyijie&quot; class=&quot;user-hover&quot; rel=&quot;laiyijie&quot;&gt;laiyijie&lt;/a&gt;, do you want to fix this?&lt;/p&gt;</comment>
                            <comment id="17331363" author="lzljs3620320" created="Sun, 25 Apr 2021 02:55:38 +0000"  >&lt;p&gt;I&apos;ll take this JIRA.&lt;/p&gt;</comment>
                            <comment id="17331713" author="lzljs3620320" created="Mon, 26 Apr 2021 03:29:49 +0000"  >&lt;p&gt;Fixed via:&lt;/p&gt;

&lt;p&gt;master:&lt;/p&gt;

&lt;p&gt;362f4aea1eec38472d94fc8527d8e1275110b03c&lt;/p&gt;

&lt;p&gt;9b9d4f08227570d670051e7249a10d4af19be3bc&lt;/p&gt;

&lt;p&gt;bf8f998fbd6cacd14e24f71727aaf86d89c90643&lt;/p&gt;

&lt;p&gt;075b0b22996e642e32bf581f8bff43eb69f5c5d4&lt;/p&gt;</comment>
                            <comment id="17334507" author="lzljs3620320" created="Wed, 28 Apr 2021 06:52:35 +0000"  >&lt;p&gt;re-open for 1.13&lt;/p&gt;</comment>
                            <comment id="17334610" author="lzljs3620320" created="Wed, 28 Apr 2021 09:24:12 +0000"  >&lt;p&gt;Fixed via:&lt;/p&gt;

&lt;p&gt;release-1.13:&#160;c623db4dcf7549fed263ab6f92aac49a94a25897&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13340126">FLINK-20100</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13343022">FLINK-20405</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0j01k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>