<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9932] Timed-out TaskExecutor slot-offers to JobMaster leak the slot</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9932</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When task executor offer slot to job master, it will first mark the slot as active.&lt;/p&gt;

&lt;p&gt;If the offer slot call timeout, the task executor will try to call offerSlotsToJobManager again,&lt;/p&gt;

&lt;p&gt;but it will only offer the slot in ALLOCATED state. As the slot has already be mark ACTIVE, it will never be offered and this will cause slot leak.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13174019">FLINK-9932</key>
            <summary>Timed-out TaskExecutor slot-offers to JobMaster leak the slot</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tiemsn">shuai.xu</assignee>
                                    <reporter username="tiemsn">shuai.xu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 24 Jul 2018 07:14:40 +0000</created>
                <updated>Thu, 28 Feb 2019 14:12:34 +0000</updated>
                            <resolved>Mon, 15 Oct 2018 20:10:48 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.5</fixVersion>
                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16633307" author="githubbot" created="Sun, 30 Sep 2018 08:42:10 +0000"  >&lt;p&gt;shuai-xu opened a new pull request #6780: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9932&quot; title=&quot;Timed-out TaskExecutor slot-offers to JobMaster leak the slot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9932&quot;&gt;&lt;del&gt;FLINK-9932&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; fix slot leak when task executor offer slot to job master timeout&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6780&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6780&lt;/a&gt;&lt;/p&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   &lt;b&gt;(For example: This pull request fix that the slots in task executor will leak if task executor fail to offer it to job master due to rpc timeout.)&lt;/b&gt;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Add a test in TaskExecutorTest&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no )&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16638946" author="githubbot" created="Thu, 4 Oct 2018 22:06:59 +0000"  >&lt;p&gt;isunjin commented on a change in pull request #6780: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9932&quot; title=&quot;Timed-out TaskExecutor slot-offers to JobMaster leak the slot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9932&quot;&gt;&lt;del&gt;FLINK-9932&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; fix slot leak when task executor offer slot to job master timeout&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6780#discussion_r222842321&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6780#discussion_r222842321&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1076,6 +1076,19 @@ private void offerSlotsToJobManager(final JobID jobId) {&lt;br/&gt;
 							if (throwable instanceof TimeoutException) {&lt;br/&gt;
 								log.info(&quot;Slot offering to JobManager did not finish in time. Retrying the slot offering.&quot;);&lt;br/&gt;
 								// We ran into a timeout. Try again.&lt;br/&gt;
+								for (SlotOffer offer : reservedSlots) {&lt;br/&gt;
+									try {&lt;br/&gt;
+										if (!taskSlotTable.markSlotInactive(offer.getAllocationId(), taskManagerConfiguration.getTimeout())) {&lt;br/&gt;
+											// the slot is either free or releasing at the moment&lt;br/&gt;
+											final String message = &quot;Could not mark slot &quot; + jobId + &quot; active.&quot;;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   merge the log to a single line.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16638954" author="githubbot" created="Thu, 4 Oct 2018 22:11:10 +0000"  >&lt;p&gt;isunjin commented on a change in pull request #6780: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9932&quot; title=&quot;Timed-out TaskExecutor slot-offers to JobMaster leak the slot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9932&quot;&gt;&lt;del&gt;FLINK-9932&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; fix slot leak when task executor offer slot to job master timeout&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6780#discussion_r222842321&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6780#discussion_r222842321&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1076,6 +1076,19 @@ private void offerSlotsToJobManager(final JobID jobId) {&lt;br/&gt;
 							if (throwable instanceof TimeoutException) {&lt;br/&gt;
 								log.info(&quot;Slot offering to JobManager did not finish in time. Retrying the slot offering.&quot;);&lt;br/&gt;
 								// We ran into a timeout. Try again.&lt;br/&gt;
+								for (SlotOffer offer : reservedSlots) {&lt;br/&gt;
+									try {&lt;br/&gt;
+										if (!taskSlotTable.markSlotInactive(offer.getAllocationId(), taskManagerConfiguration.getTimeout())) {&lt;br/&gt;
+											// the slot is either free or releasing at the moment&lt;br/&gt;
+											final String message = &quot;Could not mark slot &quot; + jobId + &quot; active.&quot;;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   merge the log to a single line.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16644783" author="githubbot" created="Wed, 10 Oct 2018 10:22:26 +0000"  >&lt;p&gt;shuai-xu commented on issue #6780: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9932&quot; title=&quot;Timed-out TaskExecutor slot-offers to JobMaster leak the slot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9932&quot;&gt;&lt;del&gt;FLINK-9932&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; fix slot leak when task executor offer slot to job master timeout&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6780#issuecomment-428519342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6780#issuecomment-428519342&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @tillrohrmann, thank for the reviewing. So your suggestion is:&lt;br/&gt;
   1. Move the marking active back to the callback.&lt;br/&gt;
   2. Mark the slot active if in allocated when submit task.&lt;br/&gt;
   3. If already active when call back, check the allocation and ignore if the same.&lt;br/&gt;
   It seems good idea.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16645235" author="githubbot" created="Wed, 10 Oct 2018 16:41:18 +0000"  >&lt;p&gt;tillrohrmann commented on issue #6780: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9932&quot; title=&quot;Timed-out TaskExecutor slot-offers to JobMaster leak the slot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9932&quot;&gt;&lt;del&gt;FLINK-9932&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; fix slot leak when task executor offer slot to job master timeout&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6780#issuecomment-428644060&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6780#issuecomment-428644060&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Yes exactly, this would have been the idea. Do you want to update this PR accordingly?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16650716" author="githubbot" created="Mon, 15 Oct 2018 20:09:22 +0000"  >&lt;p&gt;asfgit closed pull request #6780: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9932&quot; title=&quot;Timed-out TaskExecutor slot-offers to JobMaster leak the slot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9932&quot;&gt;&lt;del&gt;FLINK-9932&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; fix slot leak when task executor offer slot to job master timeout&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6780&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6780&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java&lt;br/&gt;
index ae69e561bc7..599bee99da4 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java&lt;br/&gt;
@@ -444,11 +444,16 @@ public void start() throws Exception &lt;/p&gt;
{
 				throw new TaskSubmissionException(message);
 			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!taskSlotTable.existsActiveSlot(jobId, tdd.getAllocationId())) {&lt;/li&gt;
	&lt;li&gt;final String message = &quot;No task slot allocated for job ID &quot; + jobId +&lt;/li&gt;
	&lt;li&gt;&quot; and allocation ID &quot; + tdd.getAllocationId() + &apos;.&apos;;&lt;/li&gt;
	&lt;li&gt;log.debug(message);&lt;/li&gt;
	&lt;li&gt;throw new TaskSubmissionException(message);&lt;br/&gt;
+			try 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				if (!taskSlotTable.markSlotActive(tdd.getAllocationId()) &amp;amp;&amp;amp;+						!taskSlotTable.isActive(tdd.getTargetSlotNumber(), tdd.getJobId(), tdd.getAllocationId())) {
+					final String message = &quot;No task slot allocated for job ID &quot; + jobId +
+							&quot; and allocation ID &quot; + tdd.getAllocationId() + &apos;.&apos;;
+					log.debug(message);
+					throw new TaskSubmissionException(message);
+				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (SlotNotFoundException e) &lt;/p&gt;
{
+				throw new TaskSubmissionException(e);
 			}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			// re-integrate offloaded data:&lt;br/&gt;
@@ -1050,18 +1055,6 @@ private void offerSlotsToJobManager(final JobID jobId) {&lt;/p&gt;

&lt;p&gt; 				while (reservedSlotsIterator.hasNext()) {&lt;br/&gt;
 					SlotOffer offer = reservedSlotsIterator.next().generateSlotOffer();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;if (!taskSlotTable.markSlotActive(offer.getAllocationId())) 
{
-							// the slot is either free or releasing at the moment
-							final String message = &quot;Could not mark slot &quot; + jobId + &quot; active.&quot;;
-							log.debug(message);
-							jobMasterGateway.failSlot(getResourceID(), offer.getAllocationId(), new Exception(message));
-						}&lt;/li&gt;
	&lt;li&gt;} catch (SlotNotFoundException e) 
{
-						final String message = &quot;Could not mark slot &quot; + jobId + &quot; active.&quot;;
-						jobMasterGateway.failSlot(getResourceID(), offer.getAllocationId(), new Exception(message));
-						continue;
-					}
&lt;p&gt; 					reservedSlots.add(offer);&lt;br/&gt;
 				}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -1091,7 +1084,20 @@ private void offerSlotsToJobManager(final JobID jobId) {&lt;br/&gt;
 							if (isJobManagerConnectionValid(jobId, jobMasterId)) {&lt;br/&gt;
 								// mark accepted slots active&lt;br/&gt;
 								for (SlotOffer acceptedSlot : acceptedSlots) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;reservedSlots.remove(acceptedSlot);&lt;br/&gt;
+									try 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+										if (!taskSlotTable.markSlotActive(acceptedSlot.getAllocationId()) &amp;amp;&amp;amp;+												!taskSlotTable.isActive(acceptedSlot.getSlotIndex(), jobId, acceptedSlot.getAllocationId())) {
+											// the slot is either free or releasing at the moment
+											final String message = &quot;Could not mark slot &quot; + jobId + &quot; active.&quot;;
+											log.debug(message);
+											jobMasterGateway.failSlot(getResourceID(), acceptedSlot.getAllocationId(), new Exception(message));
+										} else {
+											reservedSlots.remove(acceptedSlot);
+										}+									}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (SlotNotFoundException e) &lt;/p&gt;
{
+										final String message = &quot;Not find slot &quot; + acceptedSlot.getAllocationId() + &quot; in task executor.&quot;;
+										jobMasterGateway.failSlot(getResourceID(), acceptedSlot.getAllocationId(), new Exception(message));
+									}
&lt;p&gt; 								}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 								final Exception e = new Exception(&quot;The slot was rejected by the JobManager.&quot;);&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/slot/TaskSlotTable.java b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/slot/TaskSlotTable.java&lt;br/&gt;
index c94e278fa96..480e22066ba 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/slot/TaskSlotTable.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/slot/TaskSlotTable.java&lt;br/&gt;
@@ -378,6 +378,20 @@ public boolean isAllocated(int index, JobID jobId, AllocationID allocationId) &lt;/p&gt;
{
 		return taskSlot.isAllocated(jobId, allocationId);
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Check whether the slot for the given index is active for the given job and allocation id.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param index of the task slot&lt;br/&gt;
+	 * @param jobId for which the task slot should be allocated&lt;br/&gt;
+	 * @param allocationId which should match the task slot&apos;s allocation id&lt;br/&gt;
+	 * @return True if the given task slot is active for the given job and allocation id&lt;br/&gt;
+	 */&lt;br/&gt;
+	public boolean isActive(int index, JobID jobId, AllocationID allocationId) &lt;/p&gt;
{
+		TaskSlot taskSlot = taskSlots.get(index);
+
+		return taskSlot.isActive(jobId, allocationId);
+	}
&lt;p&gt;+&lt;br/&gt;
 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Check whether there exists an active slot for the given job and allocation id.&lt;br/&gt;
 	 *&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/taskexecutor/TaskExecutorTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/taskexecutor/TaskExecutorTest.java&lt;br/&gt;
index 168b251da26..cfa9039f4aa 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/taskexecutor/TaskExecutorTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/taskexecutor/TaskExecutorTest.java&lt;br/&gt;
@@ -78,6 +78,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.ResourceManagerId;&lt;br/&gt;
 import org.apache.flink.runtime.resourcemanager.utils.TestingResourceManagerGateway;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcService;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.RpcTimeout;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcUtils;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.TestingRpcService;&lt;br/&gt;
 import org.apache.flink.runtime.state.TaskExecutorLocalStateStoresManager;&lt;br/&gt;
@@ -127,6 +128,7 @@&lt;br/&gt;
 import java.util.concurrent.ExecutionException;&lt;br/&gt;
 import java.util.concurrent.Executor;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;br/&gt;
+import java.util.concurrent.TimeoutException;&lt;br/&gt;
 import java.util.function.Function;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import static org.hamcrest.Matchers.contains;&lt;br/&gt;
@@ -742,7 +744,7 @@ public void testTaskSubmission() throws Exception {&lt;br/&gt;
 		jobManagerTable.put(jobId, jobManagerConnection);&lt;/p&gt;

&lt;p&gt; 		final TaskSlotTable taskSlotTable = mock(TaskSlotTable.class);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;when(taskSlotTable.existsActiveSlot(eq(jobId), eq(allocationId))).thenReturn(true);&lt;br/&gt;
+		when(taskSlotTable.markSlotActive(eq(allocationId))).thenReturn(true);&lt;br/&gt;
 		when(taskSlotTable.addTask(any(Task.class))).thenReturn(true);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		TaskEventDispatcher taskEventDispatcher = new TaskEventDispatcher();&lt;br/&gt;
@@ -960,7 +962,7 @@ public void testSlotAcceptance() throws Exception {&lt;/p&gt;

&lt;p&gt; 		when(jobMasterGateway.offerSlots(&lt;br/&gt;
 				any(ResourceID.class), any(Collection.class), any(Time.class)))&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.thenReturn(CompletableFuture.completedFuture((Collection&amp;lt;SlotOffer&amp;gt;)Collections.singleton(offer1)));&lt;br/&gt;
+			.thenReturn(CompletableFuture.completedFuture((Collection&amp;lt;SlotOffer&amp;gt;) Collections.singleton(offer1)));&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		rpc.registerGateway(resourceManagerAddress, resourceManagerGateway);&lt;br/&gt;
 		rpc.registerGateway(jobManagerAddress, jobMasterGateway);&lt;br/&gt;
@@ -1677,6 +1679,87 @@ public void testInitialSlotReportFailure() throws Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Tests that offers slots to job master timeout and retry.&lt;br/&gt;
+	 */&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testOfferSlotToJobMasterTimeout() throws Exception {&lt;br/&gt;
+		final TaskSlotTable taskSlotTable = new TaskSlotTable(&lt;br/&gt;
+				Arrays.asList(ResourceProfile.UNKNOWN, ResourceProfile.UNKNOWN),&lt;br/&gt;
+				timerService);&lt;br/&gt;
+		final TaskManagerLocation taskManagerLocation = new LocalTaskManagerLocation();&lt;br/&gt;
+		final TaskManagerServices taskManagerServices = new TaskManagerServicesBuilder()&lt;br/&gt;
+				.setTaskSlotTable(taskSlotTable)&lt;br/&gt;
+				.setTaskManagerLocation(taskManagerLocation)&lt;br/&gt;
+				.build();&lt;br/&gt;
+		final TaskExecutor taskExecutor = new TaskExecutor(&lt;br/&gt;
+				rpc,&lt;br/&gt;
+				taskManagerConfiguration,&lt;br/&gt;
+				haServices,&lt;br/&gt;
+				taskManagerServices,&lt;br/&gt;
+				new HeartbeatServices(10000, 60000),&lt;br/&gt;
+				UnregisteredMetricGroups.createUnregisteredTaskManagerMetricGroup(),&lt;br/&gt;
+				dummyBlobCacheService,&lt;br/&gt;
+				testingFatalErrorHandler);&lt;br/&gt;
+&lt;br/&gt;
+		final UUID resourceManagerLeaderId = UUID.randomUUID();&lt;br/&gt;
+&lt;br/&gt;
+		final String jobManagerAddress = &quot;jm&quot;;&lt;br/&gt;
+		final UUID jobManagerLeaderId = UUID.randomUUID();&lt;br/&gt;
+&lt;br/&gt;
+		final AllocationID allocationId = new AllocationID();&lt;br/&gt;
+		final SlotOffer offer = new SlotOffer(allocationId, 0, ResourceProfile.UNKNOWN);&lt;br/&gt;
+&lt;br/&gt;
+		final CompletableFuture&amp;lt;ResourceID&amp;gt; initailSlotReportFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+		final TestingResourceManagerGateway testingResourceManagerGateway = new TestingResourceManagerGateway();&lt;br/&gt;
+		testingResourceManagerGateway.setSendSlotReportFunction(resourceIDInstanceIDSlotReportTuple3 -&amp;gt; &lt;/p&gt;
{
+			initailSlotReportFuture.complete(null);
+			return CompletableFuture.completedFuture(Acknowledge.get());
+
+		}
&lt;p&gt;);&lt;br/&gt;
+		rpc.registerGateway(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway);&lt;br/&gt;
+		resourceManagerLeaderRetriever.notifyListener(testingResourceManagerGateway.getAddress(), resourceManagerLeaderId);&lt;br/&gt;
+&lt;br/&gt;
+		final ControlledJobMasterGateway jobMasterGateway =&lt;br/&gt;
+				new ControlledJobMasterGateway(jobManagerAddress, jobManagerLeaderId, offer);&lt;br/&gt;
+		rpc.registerGateway(jobManagerAddress, jobMasterGateway);&lt;br/&gt;
+		jobManagerLeaderRetriever.notifyListener(jobManagerAddress, jobManagerLeaderId);&lt;br/&gt;
+&lt;br/&gt;
+		taskExecutor.start();&lt;br/&gt;
+&lt;br/&gt;
+		try {&lt;br/&gt;
+&lt;br/&gt;
+			// wait for the connection to the ResourceManager&lt;br/&gt;
+			initailSlotReportFuture.get();&lt;br/&gt;
+&lt;br/&gt;
+			taskExecutor.requestSlot(&lt;br/&gt;
+					new SlotID(new ResourceID(&quot;tm&quot;), 0),&lt;br/&gt;
+					jobId,&lt;br/&gt;
+					allocationId,&lt;br/&gt;
+					jobManagerAddress,&lt;br/&gt;
+					ResourceManagerId.fromUuid(resourceManagerLeaderId),&lt;br/&gt;
+					timeout).get();&lt;br/&gt;
+&lt;br/&gt;
+			long startTime = System.currentTimeMillis();&lt;br/&gt;
+			while (2 &amp;gt; jobMasterGateway.getOfferCount()) {&lt;br/&gt;
+				Thread.sleep(100);&lt;br/&gt;
+				if (System.currentTimeMillis() - startTime &amp;gt; 2000) &lt;/p&gt;
{
+					fail(&quot;Didn&apos;t Offer slot to job master as expected&quot;);
+				}
&lt;p&gt;+			}&lt;br/&gt;
+&lt;br/&gt;
+			assertTrue(taskSlotTable.existsActiveSlot(jobId, allocationId));&lt;br/&gt;
+			assertTrue(taskSlotTable.isSlotFree(1));&lt;br/&gt;
+			assertEquals(2, jobMasterGateway.getOfferCount());&lt;br/&gt;
+&lt;br/&gt;
+			// check if a concurrent error occurred&lt;br/&gt;
+			testingFatalErrorHandler.rethrowError();&lt;br/&gt;
+		} finally &lt;/p&gt;
{
+			RpcUtils.terminateRpcEndpoint(taskExecutor, timeout);
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
 	@Nonnull&lt;br/&gt;
 	private TaskExecutor createTaskExecutor(TaskManagerServices taskManagerServices) &lt;/p&gt;
{
 		return new TaskExecutor(
@@ -1786,4 +1869,57 @@ public void monitorTarget(ResourceID resourceID, HeartbeatTarget&amp;lt;O&amp;gt; heartbeatTar
 			monitoredTargets.offer(resourceID);
 		}
&lt;p&gt; 	}&lt;br/&gt;
+&lt;br/&gt;
+	class ControlledJobMasterGateway extends TestingJobMasterGateway {&lt;br/&gt;
+&lt;br/&gt;
+		private int index = 0;&lt;br/&gt;
+&lt;br/&gt;
+		private final String jobManagerAddress;&lt;br/&gt;
+&lt;br/&gt;
+		private final UUID jobManagerLeaderId;&lt;br/&gt;
+&lt;br/&gt;
+		private SlotOffer offer;&lt;br/&gt;
+&lt;br/&gt;
+		ControlledJobMasterGateway(String jobManagerAddress, UUID jobManagerLeaderId, SlotOffer slotOffer) &lt;/p&gt;
{
+			this.jobManagerAddress = jobManagerAddress;
+			this.jobManagerLeaderId = jobManagerLeaderId;
+			this.offer = slotOffer;
+		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registerTaskManager(&lt;br/&gt;
+				final String taskManagerRpcAddress,&lt;br/&gt;
+				final TaskManagerLocation taskManagerLocation,&lt;br/&gt;
+				@RpcTimeout final Time timeout) &lt;/p&gt;
{
+			return CompletableFuture.completedFuture(new JMTMRegistrationSuccess(ResourceID.generate()));
+		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public String getHostname() &lt;/p&gt;
{
+			return jobManagerAddress;
+		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public CompletableFuture&amp;lt;Collection&amp;lt;SlotOffer&amp;gt;&amp;gt; offerSlots(ResourceID taskManagerId, Collection&amp;lt;SlotOffer&amp;gt; slots, Time timeout) {&lt;br/&gt;
+			if (index++ == 0) &lt;/p&gt;
{
+				return FutureUtils.completedExceptionally(new TimeoutException());
+			}
&lt;p&gt; else &lt;/p&gt;
{
+				return CompletableFuture.completedFuture(Collections.singleton(offer));
+			}
&lt;p&gt;+		}&lt;br/&gt;
+&lt;br/&gt;
+		public int getOfferCount() &lt;/p&gt;
{
+			return index;
+		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public CompletableFuture&amp;lt;Acknowledge&amp;gt; disconnectTaskManager(ResourceID resourceID, Exception cause) &lt;/p&gt;
{
+			return CompletableFuture.completedFuture(Acknowledge.get());
+		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public JobMasterId getFencingToken() &lt;/p&gt;
{
+			return new JobMasterId(jobManagerLeaderId);
+		}
&lt;p&gt;+	}&lt;br/&gt;
 }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16650721" author="till.rohrmann" created="Mon, 15 Oct 2018 20:10:48 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
1.7.0:&lt;br/&gt;
438f650b180d1b47a4fa79c9c8314787b3d164e3&lt;br/&gt;
d7740bd00c8752303beef120ab55652cc7ed7ab5&lt;/p&gt;

&lt;p&gt;1.6.2:&lt;br/&gt;
b64cbd6dfe4445aa45f9f8982de1ec83cea9c040&lt;br/&gt;
c60fdc4e0d1885a25145995fdc51b3a4acce7500&lt;/p&gt;

&lt;p&gt;1.5.5:&lt;br/&gt;
9892717a856c3ef30de922f6e452e943cab66d34&lt;br/&gt;
28bf20c49f5323b57c23c2b27249ff2c84b69d59&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w7l3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>