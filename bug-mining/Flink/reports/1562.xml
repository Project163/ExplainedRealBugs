<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:27:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6061] NPE on TypeSerializer.serialize with a RocksDBStateBackend calling entries() on a keyed state in the open() function</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6061</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;With a default state (heap), the call to state.entries() &quot;nicely fails&quot; with a IllegalStateException :&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.IllegalStateException: No key set.
	at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195)
	at org.apache.flink.runtime.state.heap.HeapMapState.entries(HeapMapState.java:188)
	at org.apache.flink.runtime.state.UserFacingMapState.entries(UserFacingMapState.java:77)
	at org.apache.flink.Reproducer$FailingMapWithState.open(Reproducer.java:78)
	at org.apache.flink.api.common.functions.util.FunctionUtils.openFunction(FunctionUtils.java:36)
	at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.open(AbstractUdfStreamOperator.java:112)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.openAllOperators(StreamTask.java:376)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:252)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:670)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With a RocksDBStateBackend, it fails with a NPE :&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.NullPointerException
	at org.apache.flink.api.common.typeutils.base.ShortSerializer.serialize(ShortSerializer.java:64)
	at org.apache.flink.api.common.typeutils.base.ShortSerializer.serialize(ShortSerializer.java:27)
	at org.apache.flink.contrib.streaming.state.AbstractRocksDBState.writeKey(AbstractRocksDBState.java:181)
	at org.apache.flink.contrib.streaming.state.AbstractRocksDBState.writeKeyWithGroupAndNamespace(AbstractRocksDBState.java:163)
	at org.apache.flink.contrib.streaming.state.AbstractRocksDBState.writeCurrentKeyWithGroupAndNamespace(AbstractRocksDBState.java:148)
	at org.apache.flink.contrib.streaming.state.RocksDBMapState.serializeCurrentKeyAndNamespace(RocksDBMapState.java:263)
	at org.apache.flink.contrib.streaming.state.RocksDBMapState.iterator(RocksDBMapState.java:196)
	at org.apache.flink.contrib.streaming.state.RocksDBMapState.entries(RocksDBMapState.java:143)
	at org.apache.flink.runtime.state.UserFacingMapState.entries(UserFacingMapState.java:77)
	at org.apache.flink.Reproducer$FailingMapWithState.open(Reproducer.java:78)
	at org.apache.flink.api.common.functions.util.FunctionUtils.openFunction(FunctionUtils.java:36)
	at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.open(AbstractUdfStreamOperator.java:112)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.openAllOperators(StreamTask.java:376)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:252)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:670)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The reason is that the record is null, because backend.getCurrentKey() is null (not yet set) in AbstractRocksDBState.&lt;br/&gt;
This may also be the case for other RockDBState implementations.&lt;/p&gt;

&lt;p&gt;You can find the reproducer here based on 1.3-SNAPSHOT (needed for the MapState) :&lt;br/&gt;
&lt;a href=&quot;https://github.com/vpernin/flink-rocksdbstate-npe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/vpernin/flink-rocksdbstate-npe&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The reproducer is a non sense application. There is no MapState with TTL or expiration yet, so the goal is to try to shrink or expire the state at some interval.&lt;br/&gt;
This could be done by iterating over the entries of the state and removing some of them.&lt;/p&gt;

&lt;p&gt;This could probably not be done in the open() method of a rich function.&lt;br/&gt;
I also tried to implement CheckpointListener and to access the state content in notifyCheckpointComplete() method, but it fails to, I guess due to the asynchronous nature of the checkpoint.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13056248">FLINK-6061</key>
            <summary>NPE on TypeSerializer.serialize with a RocksDBStateBackend calling entries() on a keyed state in the open() function</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="vpernin">Vladislav Pernin</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Mar 2017 10:44:00 +0000</created>
                <updated>Thu, 28 Feb 2019 10:45:51 +0000</updated>
                            <resolved>Wed, 15 Mar 2017 14:31:33 +0000</resolved>
                                    <version>1.3.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                                    <component>API / DataStream</component>
                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15925929" author="srichter" created="Wed, 15 Mar 2017 11:17:21 +0000"  >&lt;p&gt;Thanks for reporting this. I agree that the information from the `IllegalStateException` is helpful to the user. I will add this to the RocksDB states. However, the behaviour is correct: there is no key context during this initialization, only when processing an element, the key that is extracted from that element determines the key context of the backend.&lt;/p&gt;</comment>
                            <comment id="15925941" author="githubbot" created="Wed, 15 Mar 2017 11:25:08 +0000"  >&lt;p&gt;GitHub user StefanRRichter opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3545&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3545&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6061&quot; title=&quot;NPE on TypeSerializer.serialize with a RocksDBStateBackend calling entries() on a keyed state in the open() function&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6061&quot;&gt;&lt;del&gt;FLINK-6061&lt;/del&gt;&lt;/a&gt; Introduced IllegalStateException when operating RocksDB &#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;keyed state with no key set&lt;/p&gt;

&lt;p&gt;    This PR fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6061&quot; title=&quot;NPE on TypeSerializer.serialize with a RocksDBStateBackend calling entries() on a keyed state in the open() function&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6061&quot;&gt;&lt;del&gt;FLINK-6061&lt;/del&gt;&lt;/a&gt;. I throws an `IllegalStateException` when keyed state is accessed and no key is set in the backend.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StefanRRichter/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StefanRRichter/flink&lt;/a&gt; FLINK-&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6061&quot; title=&quot;NPE on TypeSerializer.serialize with a RocksDBStateBackend calling entries() on a keyed state in the open() function&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6061&quot;&gt;&lt;del&gt;FLINK-6061&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3545.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3545.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3545&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 0bb7b30351ab48669332a5023f419bf651277e75&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-03-15T11:23:12Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6061&quot; title=&quot;NPE on TypeSerializer.serialize with a RocksDBStateBackend calling entries() on a keyed state in the open() function&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6061&quot;&gt;&lt;del&gt;FLINK-6061&lt;/del&gt;&lt;/a&gt; Introduced IllegalStateException when operating RocksDB keyed state with no key set&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15926054" author="githubbot" created="Wed, 15 Mar 2017 12:30:32 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3545&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3545&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Good fix, +1 to merge&lt;/p&gt;</comment>
                            <comment id="15926177" author="vpernin" created="Wed, 15 Mar 2017 13:30:56 +0000"  >&lt;p&gt;Impressed by the reactivity guys.&lt;/p&gt;

&lt;p&gt;Any idea to implement properly enough an expiring mechanism on a keyed state at some regular interval ?&lt;/p&gt;</comment>
                            <comment id="15926192" author="srichter" created="Wed, 15 Mar 2017 13:46:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vpernin&quot; class=&quot;user-hover&quot; rel=&quot;vpernin&quot;&gt;vpernin&lt;/a&gt; afaik, there is not yet a native support for TTL state. However, I think there is a better approach to emulate this on a user level than what you are currently trying. You could take a look at the `ProcessingFunction`documentation. Pretty sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; could provide you with some more details and hints.&lt;/p&gt;

&lt;p&gt;Best,&lt;br/&gt;
Stefan&lt;/p&gt;</comment>
                            <comment id="15926228" author="aljoscha" created="Wed, 15 Mar 2017 14:08:57 +0000"  >&lt;p&gt;What &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt; seems to be suggesting is to use a &lt;tt&gt;ProcessFunction&lt;/tt&gt; to use timers to implement state TTL. That is, you would set a timer for &lt;tt&gt;current time + timeout&lt;/tt&gt; and when the timer fires you would call &lt;tt&gt;clear()&lt;/tt&gt; on the state. This works because timers are scoped to a key. That is, when you set a timer a key is active and when that timer fires the same key will be active again, i.e. you will have access to the same state.&lt;/p&gt;</comment>
                            <comment id="15926252" author="githubbot" created="Wed, 15 Mar 2017 14:24:56 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3545&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3545&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank @StephanEwen ! Merging this.&lt;/p&gt;</comment>
                            <comment id="15926254" author="vpernin" created="Wed, 15 Mar 2017 14:25:39 +0000"  >&lt;p&gt;Thanks for the hint. I&apos;ll try this.&lt;/p&gt;</comment>
                            <comment id="15926261" author="githubbot" created="Wed, 15 Mar 2017 14:30:13 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3545&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3545&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fixed in 0bdc8bf (master)&lt;/p&gt;</comment>
                            <comment id="15926262" author="githubbot" created="Wed, 15 Mar 2017 14:30:13 +0000"  >&lt;p&gt;Github user StefanRRichter closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3545&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3545&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15926266" author="srichter" created="Wed, 15 Mar 2017 14:31:33 +0000"  >&lt;p&gt;Fixed in 0bdc8bf (master)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3caon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>