<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6886] Fix Timestamp field can not be selected in event time case when  toDataStream[T], `T` not a `Row` Type.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6886</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently for event-time window(group/over), When contain `Timestamp` type field in `SELECT Clause`, And toDataStream&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;, `T` not a `Row` Type, Such `PojoType`, will throw a exception. In this JIRA. will fix this bug. For example:&lt;br/&gt;
Group Window on SQL:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT name, max(num) as myMax, TUMBLE_START(rowtime, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;5&apos;&lt;/span&gt; SECOND) as winStart,TUMBLE_END(rowtime, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;5&apos;&lt;/span&gt; SECOND) as winEnd FROM T1 GROUP BY name, TUMBLE(rowtime, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;5&apos;&lt;/span&gt; SECOND)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Throw Exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.flink.table.api.TableException: The field types of physical and logical row types &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match.This is a bug and should not happen. Please file an issue.

	at org.apache.flink.table.api.TableException$.apply(exceptions.scala:53)
	at org.apache.flink.table.api.TableEnvironment.generateRowConverterFunction(TableEnvironment.scala:721)
	at org.apache.flink.table.api.StreamTableEnvironment.getConversionMapper(StreamTableEnvironment.scala:247)
	at org.apache.flink.table.api.StreamTableEnvironment.translate(StreamTableEnvironment.scala:647)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In fact, when we solve this exception,subsequent other exceptions will be thrown. The real reason is &lt;tt&gt;TableEnvironment#generateRowConverterFunction&lt;/tt&gt; method bug. So in this JIRA. will fix it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13078929">FLINK-6886</key>
            <summary>Fix Timestamp field can not be selected in event time case when  toDataStream[T], `T` not a `Row` Type.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sunjincheng121">sunjincheng</assignee>
                                    <reporter username="sunjincheng121">sunjincheng</reporter>
                        <labels>
                    </labels>
                <created>Sun, 11 Jun 2017 08:21:14 +0000</created>
                <updated>Mon, 19 Jun 2017 22:21:28 +0000</updated>
                            <resolved>Mon, 19 Jun 2017 22:21:28 +0000</resolved>
                                    <version>1.4.0</version>
                                    <fixVersion>1.3.1</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16045963" author="githubbot" created="Sun, 11 Jun 2017 13:30:42 +0000"  >&lt;p&gt;Github user sunjincheng121 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4101&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16045969" author="githubbot" created="Sun, 11 Jun 2017 13:31:45 +0000"  >&lt;p&gt;GitHub user sunjincheng121 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6886&quot; title=&quot;Fix Timestamp field can not be selected in event time case when  toDataStream[T], `T` not a `Row` Type.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6886&quot;&gt;&lt;del&gt;FLINK-6886&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt;Fix Timestamp field can not be selected in event t&#8230;&lt;/p&gt;

&lt;p&gt;    In this JIRA. will fix the exception when we run the folllows SQL:&lt;br/&gt;
    `SELECT name, max(num) as myMax, TUMBLE_START(rowtime, INTERVAL &apos;5&apos; SECOND) as winStart,TUMBLE_END(rowtime, INTERVAL &apos;5&apos; SECOND) as winEnd FROM T1 GROUP BY name, TUMBLE(rowtime, INTERVAL &apos;5&apos; SECOND)`&lt;br/&gt;
    Exception Info:&lt;br/&gt;
    ```&lt;br/&gt;
    org.apache.flink.table.api.TableException: The field types of physical and logical row types do not match.This is a bug and should not happen. Please file an issue.&lt;/p&gt;

&lt;p&gt;    	at org.apache.flink.table.api.TableException$.apply(exceptions.scala:53)&lt;br/&gt;
    	at org.apache.flink.table.api.TableEnvironment.generateRowConverterFunction(TableEnvironment.scala:721)&lt;br/&gt;
    	at org.apache.flink.table.api.StreamTableEnvironment.getConversionMapper(StreamTableEnvironment.scala:247)&lt;br/&gt;
    	at org.apache.flink.table.api.StreamTableEnvironment.translate(StreamTableEnvironment.scala:647)&lt;br/&gt;
    ```&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; General&lt;/li&gt;
	&lt;li&gt;The pull request references the related JIRA issue (&quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;FLINK-XXX&amp;#93;&lt;/span&gt; Jira title text&quot;)&lt;/li&gt;
	&lt;li&gt;The pull request addresses only one issue&lt;/li&gt;
	&lt;li&gt;Each commit in the PR has a meaningful commit message (including the JIRA id)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Documentation&lt;/li&gt;
	&lt;li&gt;Documentation has been added for new functionality&lt;/li&gt;
	&lt;li&gt;Old documentation affected by the pull request has been updated&lt;/li&gt;
	&lt;li&gt;JavaDoc for public methods has been added&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; Tests &amp;amp; Build&lt;/li&gt;
	&lt;li&gt;Functionality added by the pull request is covered by tests&lt;/li&gt;
	&lt;li&gt;`mvn clean verify` has been executed successfully locally or a Travis build has passed&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/sunjincheng121/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sunjincheng121/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6886&quot; title=&quot;Fix Timestamp field can not be selected in event time case when  toDataStream[T], `T` not a `Row` Type.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6886&quot;&gt;&lt;del&gt;FLINK-6886&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4102.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4102.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4102&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 3c89d1c8576ec44245ecb381be2ef35f5479c149&lt;br/&gt;
Author: sunjincheng121 &amp;lt;sunjincheng121@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-06-11T05:53:15Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6886&quot; title=&quot;Fix Timestamp field can not be selected in event time case when  toDataStream[T], `T` not a `Row` Type.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6886&quot;&gt;&lt;del&gt;FLINK-6886&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt;Fix Timestamp field can not be selected in event time case when toDataStream&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;, `T` not a `Row` Type.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16047962" author="githubbot" created="Tue, 13 Jun 2017 14:26:31 +0000"  >&lt;p&gt;Github user wuchong commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4102#discussion_r121694007&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4102#discussion_r121694007&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/TableEnvironment.scala &amp;#8212;&lt;br/&gt;
    @@ -715,15 +715,8 @@ abstract class TableEnvironment(val config: TableConfig) {&lt;br/&gt;
           functionName: String):&lt;br/&gt;
         GeneratedFunction[MapFunction&lt;span class=&quot;error&quot;&gt;&amp;#91;Row, OUT&amp;#93;&lt;/span&gt;, OUT] = {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// validate that at least the field types of physical and logical type match&lt;/li&gt;
	&lt;li&gt;// we do that here to make sure that plan translation was correct&lt;/li&gt;
	&lt;li&gt;if (schema.physicalTypeInfo != inputTypeInfo) 
{
    -      throw TableException(&quot;The field types of physical and logical row types do not match.&quot; +
    -        &quot;This is a bug and should not happen. Please file an issue.&quot;)
    -    }
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;val fieldTypes = schema.physicalFieldTypeInfo&lt;/li&gt;
	&lt;li&gt;val fieldNames = schema.physicalFieldNames&lt;br/&gt;
    +    val fieldTypes = schema.logicalFieldTypeInfo&lt;br/&gt;
    +    val fieldNames = schema.logicalFieldNames
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I&apos;m not sure about this change. The physical and logical type check is to make sure all the time indicators are translated. &lt;/p&gt;
</comment>
                            <comment id="16047963" author="githubbot" created="Tue, 13 Jun 2017 14:27:45 +0000"  >&lt;p&gt;Github user wuchong commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think the root cause is that TUMBLE_START inherits the wrong type (`TimeIndicatorRelDataType`) from rowtime column.  So maybe a better solution is to re-create a `RelDataType` from `optimizedPlan`&apos;s  rowType and `orignalPlan`&apos;s rowType and pass into the `getConversionMapper` method. I create a simple commit for this: &lt;a href=&quot;https://github.com/wuchong/flink/commit/82c17ab45699f5f9beb925b156e760ebdeff79fb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/wuchong/flink/commit/82c17ab45699f5f9beb925b156e760ebdeff79fb&lt;/a&gt;   What do you think? @sunjincheng121  @fhueske &lt;/p&gt;

&lt;p&gt;    BTW, do we really need so many IT cases for this ? &lt;/p&gt;</comment>
                            <comment id="16048784" author="githubbot" created="Wed, 14 Jun 2017 07:22:25 +0000"  >&lt;p&gt;Github user sunjincheng121 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @wuchong Thanks very much for your reviewing. According to your suggestions and our discussion, I made the following two changes:&lt;/p&gt;

&lt;p&gt;    1. Reduce ITCase, remove all the ITCase which added in `TableSoruceITCase`.&lt;br/&gt;
    2. Replace `schema: RowSchema` param to `fieldNames: Seq&lt;span class=&quot;error&quot;&gt;&amp;#91;String&amp;#93;&lt;/span&gt;`. &lt;/p&gt;

&lt;p&gt;    @twalthr I appreciated if you can take look at the change #2.&lt;br/&gt;
    Best,&lt;br/&gt;
    SunJincheng&lt;/p&gt;</comment>
                            <comment id="16050535" author="fhueske" created="Thu, 15 Jun 2017 14:09:31 +0000"  >&lt;p&gt;Maybe there&apos;s another way to fix this problem. I played a bit around and found the following:&lt;/p&gt;

&lt;p&gt;The following Table API query is executed correctly:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val table = stream.toTable(tEnv, &lt;span class=&quot;code-quote&quot;&gt;&apos;l, &apos;&lt;/span&gt;i, &lt;span class=&quot;code-quote&quot;&gt;&apos;n, &apos;&lt;/span&gt;proctime.proctime)

    val windowedTable = table
      .window(Tumble over 2.seconds on &lt;span class=&quot;code-quote&quot;&gt;&apos;proctime as &apos;&lt;/span&gt;w)
      .groupBy(&lt;span class=&quot;code-quote&quot;&gt;&apos;w, &apos;&lt;/span&gt;n)
      .select(&lt;span class=&quot;code-quote&quot;&gt;&apos;n, &apos;&lt;/span&gt;i.count as &lt;span class=&quot;code-quote&quot;&gt;&apos;cnt, &apos;&lt;/span&gt;w.start as &lt;span class=&quot;code-quote&quot;&gt;&apos;s, &apos;&lt;/span&gt;w.end as &apos;e)
val results = windowedTable.toAppendStream[MP](queryConfig)

&lt;span class=&quot;code-comment&quot;&gt;// POJO
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MP(&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; s: Timestamp, &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; e: Timestamp, &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; cnt: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; n: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) {
  def &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;() { &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, 0, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) }
  override def toString: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = s&lt;span class=&quot;code-quote&quot;&gt;&quot;$n,${s.toString},${e.toString},$cnt&quot;&lt;/span&gt;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;whereas the equivalent SQL query fails with the reported exception (&quot;The field types of physical and logical row types do not match&quot;)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val sqlTable = tEnv.sql(
      s&quot;&quot;&quot;SELECT TUMBLE_START(proctime, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; SECOND) AS s,
        |  TUMBLE_END(proctime, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; SECOND) AS e,
        |  n,
        |  COUNT(i) as cnt
        |FROM $table
        |GROUP BY n, TUMBLE(proctime, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; SECOND)
        |
      &quot;&quot;&quot;.stripMargin)

val results = sqlTable.toAppendStream[MP](queryConfig)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The plans of both queries look similar, but the SQL plan seems to lack the correct final projection:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// Table API plan
&lt;/span&gt;== Abstract Syntax Tree ==
LogicalProject(n=[$0], cnt=[AS($1, &lt;span class=&quot;code-quote&quot;&gt;&apos;cnt&apos;&lt;/span&gt;)], s=[AS($2, &lt;span class=&quot;code-quote&quot;&gt;&apos;s&apos;&lt;/span&gt;)], e=[AS($3, &lt;span class=&quot;code-quote&quot;&gt;&apos;e&apos;&lt;/span&gt;)])
  LogicalWindowAggregate(group=[{0}], TMP_0=[COUNT($1)])
    LogicalProject(n=[$2], i=[$1], proctime=[$3])
      LogicalTableScan(table=[[_DataStreamTable_0]])

== Optimized Logical Plan ==
DataStreamCalc(select=[n, TMP_0 AS cnt, TMP_1 AS s, TMP_2 AS e])
  DataStreamGroupWindowAggregate(groupBy=[n], window=[TumblingGroupWindow(&lt;span class=&quot;code-quote&quot;&gt;&apos;w, &apos;&lt;/span&gt;proctime, 2000.millis)], select=[n, COUNT(i) AS TMP_0, start(&lt;span class=&quot;code-quote&quot;&gt;&apos;w) AS TMP_1, end(&apos;&lt;/span&gt;w) AS TMP_2])
    DataStreamCalc(select=[n, i, proctime])
      DataStreamScan(table=[[_DataStreamTable_0]])

&lt;span class=&quot;code-comment&quot;&gt;// SQL plans
&lt;/span&gt;== Abstract Syntax Tree ==
LogicalProject(s=[TUMBLE_START($1)], e=[TUMBLE_END($1)], n=[$0], cnt=[$2])
  LogicalAggregate(group=[{0, 1}], cnt=[COUNT($2)])
    LogicalProject(n=[$2], $f1=[TUMBLE($3, 2000)], i=[$1])
      LogicalTableScan(table=[[UnnamedTable$3]])

== Optimized Logical Plan ==
DataStreamCalc(select=[w$start, w$end, n, cnt])
  DataStreamGroupWindowAggregate(groupBy=[n], window=[TumblingGroupWindow(&lt;span class=&quot;code-quote&quot;&gt;&apos;w$, &apos;&lt;/span&gt;proctime, 2000.millis)], select=[n, COUNT(i) AS cnt, start(&lt;span class=&quot;code-quote&quot;&gt;&apos;w$) AS w$start, end(&apos;&lt;/span&gt;w$) AS w$end])
    DataStreamCalc(select=[n, proctime, i])
      DataStreamScan(table=[[_DataStreamTable_0]])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So this doesn&apos;t seem to be a principled issue with the time attributes or window properties but rather an issue of the SQL optimization.&lt;/p&gt;

&lt;p&gt;What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunjincheng121&quot; class=&quot;user-hover&quot; rel=&quot;sunjincheng121&quot;&gt;sunjincheng121&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16051425" author="sunjincheng121" created="Fri, 16 Jun 2017 05:59:58 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt; Thanks for check this issue. Calcite can not recognize &lt;tt&gt;TimeIndicatorRelDataType&lt;/tt&gt;, So, In SQL case &lt;tt&gt;FlinkPlannerImpl#rel&lt;/tt&gt; will keep the &lt;tt&gt;TimeIndicatorRelDataType&lt;/tt&gt;.I think we can not touch the calcite, so,we only have a chance to do optimization when generating &lt;tt&gt;LogicalRelNode&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="16051451" author="sunjincheng121" created="Fri, 16 Jun 2017 06:26:27 +0000"  >&lt;p&gt;But, I think not the optimization issue, because, &lt;tt&gt;FlinkPlannerImpl#rel&lt;/tt&gt; will do the &lt;tt&gt;StreamTableEnvironment#translate&lt;/tt&gt;, In this method we will do the &lt;tt&gt;optimize&lt;/tt&gt;, After &lt;tt&gt;optimize&lt;/tt&gt; we really translate &lt;tt&gt;TimeIndicatorRelDataType&lt;/tt&gt; to &lt;tt&gt;TIMESTAMP&lt;/tt&gt;. That&apos;s correct. The core problem is occur in {{ translate(dataStreamPlan, relNode.getRowType, queryConfig, withChangeFlag) }}, we can see the second param {{ relNode.getRowType}} is the non-optimized node which contains &lt;tt&gt;TimeIndicatorRelDataType&lt;/tt&gt;.  all of the follows operations are based on the type of non-optimal node, so there will be such a problem.&lt;/p&gt;</comment>
                            <comment id="16051466" author="sunjincheng121" created="Fri, 16 Jun 2017 06:41:38 +0000"  >&lt;p&gt;So, We have two chances to deal with the problem&#65292;one is the PR. did. one is copy &lt;tt&gt;relNode&lt;/tt&gt; when generating &lt;tt&gt;LogicalRelNode&lt;/tt&gt;.&lt;br/&gt;
IMO. I&apos;m not sure copy is best way.  What do you think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16052154" author="fhueske" created="Fri, 16 Jun 2017 17:20:21 +0000"  >&lt;p&gt;You are right. The problem is in &lt;tt&gt;translate(dataStreamPlan, relNode.getRowType, queryConfig, withChangeFlag)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;We use the RowType of the original input plan because the field names might change (Calcite prunes pure renaming projections as noops). However, the &lt;tt&gt;RelTimeIndicatorConverter&lt;/tt&gt; (correctly!) changes the types of time indicators. So, types of the optimized plan are not identical to the original plan. This difference causes the exception.&lt;/p&gt;

&lt;p&gt;A simple solution would be to just merge the field names of the original plan with the field types of the optimized plan and construct a new &lt;tt&gt;RelDataType&lt;/tt&gt;. I change the &lt;tt&gt;StreamTableEnvironment.translate()&lt;/tt&gt; method to this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; def translate[A](
      table: Table,
      queryConfig: StreamQueryConfig,
      updatesAsRetraction: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;,
      withChangeFlag: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;)(implicit tpe: TypeInformation[A]): DataStream[A] = {
    val relNode = table.getRelNode
    val dataStreamPlan = optimize(relNode, updatesAsRetraction)
&lt;span class=&quot;code-comment&quot;&gt;// zip original field names with optimized field types
&lt;/span&gt;    val x = relNode.getRowType.getFieldList.asScala.zip(dataStreamPlan.getRowType.getFieldList.asScala)
      &lt;span class=&quot;code-comment&quot;&gt;// get name of original plan and type of optimized plan
&lt;/span&gt;      .map(x =&amp;gt; (x._1.getName, x._2.getType))
      &lt;span class=&quot;code-comment&quot;&gt;// add index
&lt;/span&gt;      .zipWithIndex
      &lt;span class=&quot;code-comment&quot;&gt;// build &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; field types
&lt;/span&gt;      .map(x =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RelDataTypeFieldImpl(x._1._1, x._2, x._1._2))
    &lt;span class=&quot;code-comment&quot;&gt;// build a record type from list of field types
&lt;/span&gt;    val rowType = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RelRecordType(x.toList.asJava.asInstanceOf[_root_.java.util.List[RelDataTypeField]])

    translate(dataStreamPlan, rowType, queryConfig, withChangeFlag)
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and got it (and all tests) working.&lt;/p&gt;

&lt;p&gt;The field merging can be done a lot nicer.&lt;/p&gt;</comment>
                            <comment id="16052246" author="sunjincheng121" created="Fri, 16 Jun 2017 18:41:36 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt; your code is nicer. I&apos;ll update the PR. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16052304" author="githubbot" created="Fri, 16 Jun 2017 19:28:55 +0000"  >&lt;p&gt;Github user sunjincheng121 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @fhueske I have update the PR. according your suggestion. Please have a look at the changes.&lt;/p&gt;

&lt;p&gt;    Best,&lt;br/&gt;
    SunJincheng&lt;/p&gt;</comment>
                            <comment id="16053933" author="githubbot" created="Mon, 19 Jun 2017 12:55:14 +0000"  >&lt;p&gt;Github user rmetzger commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Please see my message in the 1.3.1 thread on the dev@ list &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16054705" author="githubbot" created="Mon, 19 Jun 2017 20:42:58 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4102&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16054854" author="fhueske" created="Mon, 19 Jun 2017 22:21:28 +0000"  >&lt;p&gt;Fixed for 1.3.1 with 8b91df2b3cd0c0ef733902ad742045b318bac0fd&lt;br/&gt;
Fixed for 1.4.0 with d78eeca37554ac75faf1aa451d0b4107ebd96fb9&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3g567:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>