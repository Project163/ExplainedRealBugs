<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20404] ZooKeeper quorum fails to start due to missing log4j library</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20404</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Upon starting a zookeeper quorum using flink&apos;s bootstrapped zookeeper, it throws the following exception.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-11-27 13:13:38,371 ERROR org.apache.flink.runtime.zookeeper.FlinkZooKeeperQuorumPeer  [] - Error running ZooKeeper quorum peer: org/apache/log4j/jmx/HierarchyDynamicMBean
java.lang.NoClassDefFoundError: org/apache/log4j/jmx/HierarchyDynamicMBean
        at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.jmx.ManagedUtil.registerLog4jMBeans(ManagedUtil.java:51) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-11.0]
        at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:125) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-11.0]
        at org.apache.flink.runtime.zookeeper.FlinkZooKeeperQuorumPeer.runFlinkZkQuorumPeer(FlinkZooKeeperQuorumPeer.java:123) ~[flink-dist_2.11-1.11.2.jar:1.11.2]
        at org.apache.flink.runtime.zookeeper.FlinkZooKeeperQuorumPeer.main(FlinkZooKeeperQuorumPeer.java:79) [flink-dist_2.11-1.11.2.jar:1.11.2]
Caused by: java.lang.ClassNotFoundException: org.apache.log4j.jmx.HierarchyDynamicMBean
        at java.net.URLClassLoader.findClass(URLClassLoader.java:382) ~[?:1.8.0_262]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:418) ~[?:1.8.0_262]
        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:352) ~[?:1.8.0_262]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:351) ~[?:1.8.0_262]
        ... 4 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This happens because the new flink version is missing a log4j library. This can be solved by adding log4j-1.2.17.jar to the classpath, nonetheless the bootstrapped zookeepeer version should be compatible with the log4j2 libraries that come with flink&apos;s default installation.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Steps to reproduce:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Fresh install of flink version 1.11.2&#160;&lt;/li&gt;
	&lt;li&gt;Change the zookeeper config to start as a quorum
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
server.1=&amp;lt;hostname&amp;gt;:2888:3888
server.2=&amp;lt;hostname&amp;gt;:2888:3888&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;Start zookeeper&lt;/li&gt;
	&lt;li&gt;&amp;lt;installation_path&amp;gt;/bin/zookeeper.sh start-foreground 1&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13343015">FLINK-20404</key>
            <summary>ZooKeeper quorum fails to start due to missing log4j library</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="PedroMrChaves">Pedro Miguel Rainho Chaves</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 27 Nov 2020 15:14:51 +0000</created>
                <updated>Mon, 7 Dec 2020 20:15:43 +0000</updated>
                            <resolved>Mon, 7 Dec 2020 20:15:43 +0000</resolved>
                                    <version>1.11.2</version>
                                    <fixVersion>1.11.3</fixVersion>
                    <fixVersion>1.12.1</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                                    <component>Build System</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17240403" author="zentol" created="Mon, 30 Nov 2020 00:20:15 +0000"  >&lt;p&gt;This is due to ZK 3.4 having a hard dependency on log4j 1, which we cannot fix. You can try using ZK 3.5 (presumably ZK was decoupled from log4j1 in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1371&quot; title=&quot;Remove dependency on log4j in the source code.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1371&quot;&gt;&lt;del&gt;ZOOKEEPER-1371&lt;/del&gt;&lt;/a&gt;), or use Flink with log4j1 as described in the &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-release-1.11/monitoring/logging.html#configuring-log4j1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17243185" author="stephanewen" created="Thu, 3 Dec 2020 13:42:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; Looks like Flink ships by default ZK 3.4, so the built-in ZK scripts are no effectively not usable with the default build?&lt;/p&gt;</comment>
                            <comment id="17243187" author="stephanewen" created="Thu, 3 Dec 2020 13:44:06 +0000"  >&lt;p&gt;Does that mean we should either&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;remove the utility scripts to start the ZK quorum (not great for the starting experience)&lt;/li&gt;
	&lt;li&gt;Upgrade Flink to use ZK 3.5 by default?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17243193" author="zentol" created="Thu, 3 Dec 2020 13:56:56 +0000"  >&lt;p&gt;They do work, just not if you use certain log4j features, in this case I suppose some zookeeper JMX integration.&lt;br/&gt;
We have e2e tests that ensure Flink and the bundled ZK work.&lt;/p&gt;</comment>
                            <comment id="17243195" author="zentol" created="Thu, 3 Dec 2020 13:59:19 +0000"  >&lt;p&gt;oh, let me clarify. As described in the issue description, if you configure more than 1 quorum peer then it does not work.&lt;br/&gt;
If you have only 1 peer, then it does work.&lt;/p&gt;</comment>
                            <comment id="17243206" author="zentol" created="Thu, 3 Dec 2020 14:15:19 +0000"  >&lt;p&gt;We could disable the log4j jmx integration by passing &lt;tt&gt;-Dzookeeper.jmx.log4j.disable=true&lt;/tt&gt; to the JVM.&lt;/p&gt;</comment>
                            <comment id="17243218" author="stephanewen" created="Thu, 3 Dec 2020 14:34:48 +0000"  >&lt;p&gt;Thanks for clarifying. &lt;/p&gt;

&lt;p&gt;I guess updating to ZK 3.5 is not yet an option, to be able to keep compatibility with ZK 3.4 ensembles?&lt;/p&gt;

&lt;p&gt;The suggestion about excluding the log4j jmx integration sounds like a nice fix.&lt;/p&gt;</comment>
                            <comment id="17243225" author="zentol" created="Thu, 3 Dec 2020 14:39:11 +0000"  >&lt;p&gt;I will prepare a PR with the fix. I wouldn&apos;t want to switch the default ZK version so soon before a release.&lt;/p&gt;</comment>
                            <comment id="17245302" author="zentol" created="Mon, 7 Dec 2020 15:50:38 +0000"  >&lt;p&gt;FYI, due to the zoo.cfg only having a single clientPort setting it isn&apos;t easily possible to start multiple peers anyway, as they all try to bind to the same port.&lt;/p&gt;</comment>
                            <comment id="17245503" author="zentol" created="Mon, 7 Dec 2020 20:15:43 +0000"  >&lt;p&gt;master: 09988136f994e48c16e75cc71bd7779e39fe50fe&lt;br/&gt;
1.12: a1b48aecee6b937005d53da5afec6475ea6586e4 &lt;br/&gt;
1.11: 741b8e2b9536c0160b43b10b922d11e2af7f588c &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kzzc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>The Zookeeper scripts in the Flink distribution have been modified to disable the Log4j JMX integration due to an incompatibility between Zookeeper 3.4 and Log4j 2.&lt;br/&gt;
To re-enable this feature, remove the line in the &amp;quot;zookeeper.sh&amp;quot; file that sets &amp;quot;zookeeper.jmx.log4j.disable&amp;quot;.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>