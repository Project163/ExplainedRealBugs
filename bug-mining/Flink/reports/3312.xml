<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:41:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-12399] FilterableTableSource does not use filters on job run</title>
                <link>https://issues.apache.org/jira/browse/FLINK-12399</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;As discussed &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Filter-push-down-not-working-for-a-custom-BatchTableSource-tp27654.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;on the mailing list&lt;/a&gt;, there appears to be a bug where a job that uses a custom FilterableTableSource does not keep the filters that were pushed down into the table source. More specifically, the table source does receive filters via applyPredicates, and a new table source with those filters is returned, but the final job graph appears to use the original table source, which does not contain any filters.&lt;/p&gt;

&lt;p&gt;I attached a minimal example program to this ticket. The custom table source is as follows: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CustomTableSource &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; BatchTableSource&amp;lt;Model&amp;gt;, FilterableTableSource&amp;lt;Model&amp;gt; {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Logger LOG = LoggerFactory.getLogger(CustomTableSource.class);

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Filter[] filters;

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; FilterConverter converter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FilterConverter();

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; CustomTableSource() {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; CustomTableSource(Filter[] filters) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.filters = filters;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DataSet&amp;lt;Model&amp;gt; getDataSet(ExecutionEnvironment execEnv) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filters == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
           LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;==== No filters defined ====&quot;&lt;/span&gt;);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;==== Found filters ====&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Filter filter : filters) {
                LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;FILTER: {}&quot;&lt;/span&gt;, filter);
            }
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; execEnv.fromCollection(allModels());
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TableSource&amp;lt;Model&amp;gt; applyPredicate(List&amp;lt;Expression&amp;gt; predicates) {
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Applying predicates&quot;&lt;/span&gt;);

        List&amp;lt;Filter&amp;gt; acceptedFilters = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Expression predicate : predicates) {
            converter.convert(predicate).ifPresent(acceptedFilters::add);
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CustomTableSource(acceptedFilters.toArray(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Filter[0]));
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isFilterPushedDown() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; filters != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TypeInformation&amp;lt;Model&amp;gt; getReturnType() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; TypeInformation.of(Model.class);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TableSchema getTableSchema() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; TableSchema.fromTypeInfo(getReturnType());
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; List&amp;lt;Model&amp;gt; allModels() {
        List&amp;lt;Model&amp;gt; models = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();

        models.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Model(1, 2, 3, 4));
        models.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Model(10, 11, 12, 13));
        models.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Model(20, 21, 22, 23));

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; models;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When run, it logs&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;15:24:54,888 INFO  com.klaviyo.filterbug.CustomTableSource                       - Applying predicates
15:24:54,901 INFO  com.klaviyo.filterbug.CustomTableSource                       - Applying predicates
15:24:54,910 INFO  com.klaviyo.filterbug.CustomTableSource                       - Applying predicates
15:24:54,977 INFO  com.klaviyo.filterbug.CustomTableSource                       - ==== No filters defined ====&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which appears to indicate that although filters are getting pushed down, the final job does not use them.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13231514">FLINK-12399</key>
            <summary>FilterableTableSource does not use filters on job run</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rongr">Rong Rong</assignee>
                                    <reporter username="josh.bradt">Josh Bradt</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 3 May 2019 19:43:50 +0000</created>
                <updated>Mon, 30 Mar 2020 07:54:49 +0000</updated>
                            <resolved>Thu, 17 Oct 2019 16:25:20 +0000</resolved>
                                    <version>1.8.0</version>
                                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="16833107" author="rongr" created="Sat, 4 May 2019 16:54:40 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=josh.bradt&quot; class=&quot;user-hover&quot; rel=&quot;josh.bradt&quot;&gt;josh.bradt&lt;/a&gt;. I think I found the root cause of this issue.&lt;/p&gt;

&lt;p&gt;Apparently you have to override the method&#160;&lt;tt&gt;explainSource&lt;/tt&gt; in order to let calcite know that the new created TableSource with filter pushedDown is different from the original created CustomeTableSource (where you have not applyPredicates).&lt;br/&gt;
I think this might be related to the #4 changelog point &lt;a href=&quot;https://github.com/apache/flink/pull/8324&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/8324&lt;/a&gt; when I try upgrading to CALCITE 1.19.0 I also encounter some weird issues where calcite tries to find the correct tablesource from the digest strings. &lt;/p&gt;

&lt;p&gt;I will assigned to myself and start looking into this issue. Please let me know if adding the override resolves your issue at this moment.&lt;/p&gt;</comment>
                            <comment id="16834072" author="josh.bradt" created="Mon, 6 May 2019 18:01:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=walterddr&quot; class=&quot;user-hover&quot; rel=&quot;walterddr&quot;&gt;walterddr&lt;/a&gt;: Thanks, that workaround does solve my problem for now!&lt;/p&gt;</comment>
                            <comment id="16835059" author="fhueske" created="Tue, 7 May 2019 19:55:42 +0000"  >&lt;p&gt;Thanks for looking into this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=walterddr&quot; class=&quot;user-hover&quot; rel=&quot;walterddr&quot;&gt;walterddr&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="16921546" author="rongr" created="Tue, 3 Sep 2019 16:35:38 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt;. would you please kindly take a look at the approach to address this issue? The problem has been created some problems for us and also some multiple threads in the mailing list.&lt;br/&gt;
It would be nice to address this before the next release. Much appreciated. &lt;/p&gt;</comment>
                            <comment id="16921808" author="ykt836" created="Wed, 4 Sep 2019 01:36:38 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=walterddr&quot; class=&quot;user-hover&quot; rel=&quot;walterddr&quot;&gt;walterddr&lt;/a&gt;, sorry for the delay, I will take a look at your solution.&#160;&lt;/p&gt;</comment>
                            <comment id="16953888" author="ykt836" created="Thu, 17 Oct 2019 16:25:20 +0000"  >&lt;p&gt;merged to 1.10:&#160;cbf7b76923feec5ce8c9cb45a3082339be5ff17e&lt;/p&gt;</comment>
                            <comment id="16955236" author="rongr" created="Sat, 19 Oct 2019 18:05:06 +0000"  >&lt;p&gt;merged to 1.9: c1019105c22455c554ab91b9fc2ef8512873bee8&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13294920">FLINK-16860</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12967804" name="flink-filter-bug.tar.gz" size="3500" author="josh.bradt" created="Fri, 3 May 2019 19:42:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 4 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02dns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>