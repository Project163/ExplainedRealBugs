<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:38:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10848] Flink&apos;s Yarn ResourceManager can allocate too many excess containers</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10848</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently, both the YarnFlinkResourceManager and YarnResourceManager do not call removeContainerRequest() on container allocation success. Because the YARN AM-RM protocol is not a delta protocol (please see &lt;a href=&quot;https://issues.apache.org/jira/browse/YARN-1902&quot; title=&quot;Allocation of too many containers when a second request is done with the same resource capability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;YARN-1902&quot;&gt;YARN-1902&lt;/a&gt;), AMRMClient will keep all ContainerRequests that are added and send them to RM.&lt;/p&gt;

&lt;p&gt;In production, we observe the following that verifies the theory: 16 containers are allocated and used upon cluster startup; when a TM is killed, 17 containers are allocated, 1 container is used, and 16 excess containers are returned; when another TM is killed, 18 containers are allocated, 1 container is used, and 17 excess containers are returned.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13197625">FLINK-10848</key>
            <summary>Flink&apos;s Yarn ResourceManager can allocate too many excess containers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="suez1224">Shuyi Chen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 11 Nov 2018 07:35:27 +0000</created>
                <updated>Fri, 29 Mar 2019 11:42:08 +0000</updated>
                            <resolved>Fri, 11 Jan 2019 15:18:39 +0000</resolved>
                                    <version>1.3.3</version>
                    <version>1.4.2</version>
                    <version>1.5.5</version>
                    <version>1.6.2</version>
                                    <fixVersion>1.6.4</fixVersion>
                    <fixVersion>1.7.2</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>Deployment / YARN</component>
                        <due></due>
                            <votes>4</votes>
                                    <watches>15</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16682768" author="githubbot" created="Sun, 11 Nov 2018 07:43:55 +0000"  >&lt;p&gt;suez1224 opened a new pull request #7078: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10848&quot; title=&quot;Flink&amp;#39;s Yarn ResourceManager can allocate too many excess containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10848&quot;&gt;&lt;del&gt;FLINK-10848&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;YARN&amp;#93;&lt;/span&gt; properly remove YARN ContainerRequest upon container allocation success&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7078&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Properly remove YARN ContainerRequest upon container allocation success.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add call to removeContainerRequest in YarnFlinkResourceManager&lt;/li&gt;
	&lt;li&gt;add call to removeContainerRequest in YarnResourceManager&lt;/li&gt;
	&lt;li&gt;change unittests to verify,&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change is already covered by existing tests.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): ( no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: ( no)&lt;/li&gt;
	&lt;li&gt;The serializers: ( no )&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): ( no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: ( no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: ( no )&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? ( no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable )&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16682789" author="githubbot" created="Sun, 11 Nov 2018 08:23:46 +0000"  >&lt;p&gt;suez1224 closed pull request #7078: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10848&quot; title=&quot;Flink&amp;#39;s Yarn ResourceManager can allocate too many excess containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10848&quot;&gt;&lt;del&gt;FLINK-10848&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;YARN&amp;#93;&lt;/span&gt; properly remove YARN ContainerRequest upon container allocation success&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7078&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java&lt;br/&gt;
index 8e686bbbe34..3327505e32d 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java&lt;br/&gt;
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java&lt;br/&gt;
@@ -438,6 +438,8 @@ private void containersAllocated(List&amp;lt;Container&amp;gt; containers) {&lt;br/&gt;
 			numPendingContainerRequests = Math.max(0, numPendingContainerRequests - 1);&lt;br/&gt;
 			LOG.info(&quot;Received new container: {} - Remaining pending container requests: {}&quot;,&lt;br/&gt;
 				container.getId(), numPendingContainerRequests);&lt;br/&gt;
+			resourceManagerClient.removeContainerRequest(new AMRMClient.ContainerRequest(&lt;br/&gt;
+					container.getResource(), null, null, container.getPriority()));&lt;/p&gt;

&lt;p&gt; 			// decide whether to return the container, or whether to start a TaskManager&lt;br/&gt;
 			if (numRegistered + containersInLaunch.size() &amp;lt; numRequired) {&lt;br/&gt;
diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
index 6ff5cd66487..6669f16fa40 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
@@ -361,7 +361,8 @@ public void onContainersAllocated(List&amp;lt;Container&amp;gt; containers) {&lt;br/&gt;
 					&quot;Received new container: {} - Remaining pending container requests: {}&quot;,&lt;br/&gt;
 					container.getId(),&lt;br/&gt;
 					numPendingContainerRequests);&lt;br/&gt;
-&lt;br/&gt;
+				resourceManagerClient.removeContainerRequest(new AMRMClient.ContainerRequest(&lt;br/&gt;
+						container.getResource(), null, null, container.getPriority()));&lt;br/&gt;
 				if (numPendingContainerRequests &amp;gt; 0) {&lt;br/&gt;
 					numPendingContainerRequests--;&lt;/p&gt;

&lt;p&gt;diff --git a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java&lt;br/&gt;
index 10b2ce97d6f..20de155c000 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java&lt;br/&gt;
+++ b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java&lt;br/&gt;
@@ -43,6 +43,8 @@&lt;br/&gt;
 import org.apache.hadoop.yarn.api.records.ContainerId;&lt;br/&gt;
 import org.apache.hadoop.yarn.api.records.ContainerLaunchContext;&lt;br/&gt;
 import org.apache.hadoop.yarn.api.records.NodeId;&lt;br/&gt;
+import org.apache.hadoop.yarn.api.records.Priority;&lt;br/&gt;
+import org.apache.hadoop.yarn.api.records.Resource;&lt;br/&gt;
 import org.apache.hadoop.yarn.client.api.AMRMClient;&lt;br/&gt;
 import org.apache.hadoop.yarn.client.api.NMClient;&lt;br/&gt;
 import org.apache.hadoop.yarn.client.api.async.AMRMClientAsync;&lt;br/&gt;
@@ -69,9 +71,7 @@&lt;br/&gt;
 import scala.concurrent.duration.FiniteDuration;&lt;/p&gt;

&lt;p&gt; import static org.junit.Assert.assertEquals;&lt;br/&gt;
-import static org.mockito.Mockito.doAnswer;&lt;br/&gt;
-import static org.mockito.Mockito.mock;&lt;br/&gt;
-import static org.mockito.Mockito.when;&lt;br/&gt;
+import static org.mockito.Mockito.*;&lt;/p&gt;

&lt;p&gt; /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests for 
{@link YarnFlinkResourceManager}
&lt;p&gt;.&lt;br/&gt;
@@ -125,6 +125,8 @@ public void testYarnFlinkResourceManagerJobManagerLostLeadership() throws Except&lt;br/&gt;
 							1),&lt;br/&gt;
 						i));&lt;br/&gt;
 				when(mockContainer.getNodeId()).thenReturn(NodeId.newInstance(&quot;container&quot;, 1234));&lt;br/&gt;
+				when(mockContainer.getResource()).thenReturn(Resource.newInstance(200, 1));&lt;br/&gt;
+				when(mockContainer.getPriority()).thenReturn(Priority.UNDEFINED);&lt;br/&gt;
 				containerList.add(mockContainer);&lt;br/&gt;
 			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -233,6 +235,8 @@ public Object answer(InvocationOnMock invocation) throws Throwable &lt;/p&gt;
{
 
 				int numberOfRegisteredResources = (Integer) Await.result(numberOfRegisteredResourcesFuture, deadline.timeLeft());
 
+				verify(resourceManagerClient, times(numInitialTaskManagers)).removeContainerRequest(
+						any(AMRMClient.ContainerRequest.class));
 				assertEquals(numInitialTaskManagers, numberOfRegisteredResources);
 			}
&lt;p&gt; finally {&lt;br/&gt;
 				if (resourceManager != null) {&lt;br/&gt;
diff --git a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java&lt;br/&gt;
index d41d42d7a05..04bb1683aab 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java&lt;br/&gt;
+++ b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java&lt;br/&gt;
@@ -401,6 +401,8 @@ public void testStopWorker() throws Exception {&lt;/p&gt;

&lt;p&gt; 				resourceManager.onContainersAllocated(ImmutableList.of(testingContainer));&lt;br/&gt;
 				verify(mockResourceManagerClient).addContainerRequest(any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
+				verify(mockResourceManagerClient).removeContainerRequest(&lt;br/&gt;
+						any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
 				verify(mockNMClient).startContainer(eq(testingContainer), any(ContainerLaunchContext.class));&lt;/p&gt;

&lt;p&gt; 				// Remote task executor registers with YarnResourceManager.&lt;br/&gt;
@@ -496,6 +498,8 @@ public void testOnContainerCompleted() throws Exception {&lt;/p&gt;

&lt;p&gt; 				resourceManager.onContainersAllocated(ImmutableList.of(testingContainer));&lt;br/&gt;
 				verify(mockResourceManagerClient).addContainerRequest(any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
+				verify(mockResourceManagerClient).removeContainerRequest(&lt;br/&gt;
+						any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
 				verify(mockNMClient).startContainer(eq(testingContainer), any(ContainerLaunchContext.class));&lt;/p&gt;

&lt;p&gt; 				// Callback from YARN when container is Completed, pending request can not be fulfilled by pending&lt;br/&gt;
@@ -512,4 +516,6 @@ public void testOnContainerCompleted() throws Exception {&lt;br/&gt;
 			});&lt;br/&gt;
 		}};&lt;br/&gt;
 	}&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
 }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16682790" author="githubbot" created="Sun, 11 Nov 2018 08:23:50 +0000"  >&lt;p&gt;suez1224 opened a new pull request #7078: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10848&quot; title=&quot;Flink&amp;#39;s Yarn ResourceManager can allocate too many excess containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10848&quot;&gt;&lt;del&gt;FLINK-10848&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;YARN&amp;#93;&lt;/span&gt; properly remove YARN ContainerRequest upon container allocation success&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7078&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Properly remove YARN ContainerRequest upon container allocation success.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add call to removeContainerRequest in YarnFlinkResourceManager&lt;/li&gt;
	&lt;li&gt;add call to removeContainerRequest in YarnResourceManager&lt;/li&gt;
	&lt;li&gt;change unittests to verify,&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change is already covered by existing tests.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): ( no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: ( no)&lt;/li&gt;
	&lt;li&gt;The serializers: ( no )&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): ( no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: ( no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: ( no )&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? ( no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable )&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16684859" author="githubbot" created="Tue, 13 Nov 2018 08:19:30 +0000"  >&lt;p&gt;suez1224 closed pull request #7078: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10848&quot; title=&quot;Flink&amp;#39;s Yarn ResourceManager can allocate too many excess containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10848&quot;&gt;&lt;del&gt;FLINK-10848&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;YARN&amp;#93;&lt;/span&gt; properly remove YARN ContainerRequest upon container allocation success&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7078&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YarnTestBase.java b/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YarnTestBase.java&lt;br/&gt;
index 3763f6592af..f1e6a3a767c 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YarnTestBase.java&lt;br/&gt;
+++ b/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YarnTestBase.java&lt;br/&gt;
@@ -165,6 +165,8 @@&lt;br/&gt;
 		YARN_CONFIGURATION.setInt(YarnConfiguration.DEBUG_NM_DELETE_DELAY_SEC, 3600);&lt;br/&gt;
 		YARN_CONFIGURATION.setBoolean(YarnConfiguration.LOG_AGGREGATION_ENABLED, false);&lt;br/&gt;
 		YARN_CONFIGURATION.setInt(YarnConfiguration.NM_VCORES, 666); // memory is overwritten in the MiniYARNCluster.&lt;br/&gt;
+		YARN_CONFIGURATION.set(&quot;yarn.scheduler.capacity.resource-calculator&quot;,&lt;br/&gt;
+				&quot;org.apache.hadoop.yarn.util.resource.DominantResourceCalculator&quot;);&lt;br/&gt;
 		// so we have to change the number of cores for testing.&lt;br/&gt;
 		YARN_CONFIGURATION.setInt(YarnConfiguration.RM_AM_EXPIRY_INTERVAL_MS, 20000); // 20 seconds expiry (to ensure we properly heartbeat with YARN).&lt;br/&gt;
 	}&lt;br/&gt;
diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java&lt;br/&gt;
index 8e686bbbe34..3327505e32d 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java&lt;br/&gt;
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java&lt;br/&gt;
@@ -438,6 +438,8 @@ private void containersAllocated(List&amp;lt;Container&amp;gt; containers) {&lt;br/&gt;
 			numPendingContainerRequests = Math.max(0, numPendingContainerRequests - 1);&lt;br/&gt;
 			LOG.info(&quot;Received new container: {} - Remaining pending container requests: {}&quot;,&lt;br/&gt;
 				container.getId(), numPendingContainerRequests);&lt;br/&gt;
+			resourceManagerClient.removeContainerRequest(new AMRMClient.ContainerRequest(&lt;br/&gt;
+					container.getResource(), null, null, container.getPriority()));&lt;/p&gt;

&lt;p&gt; 			// decide whether to return the container, or whether to start a TaskManager&lt;br/&gt;
 			if (numRegistered + containersInLaunch.size() &amp;lt; numRequired) {&lt;br/&gt;
diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
index 6ff5cd66487..6669f16fa40 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
@@ -361,7 +361,8 @@ public void onContainersAllocated(List&amp;lt;Container&amp;gt; containers) {&lt;br/&gt;
 					&quot;Received new container: {} - Remaining pending container requests: {}&quot;,&lt;br/&gt;
 					container.getId(),&lt;br/&gt;
 					numPendingContainerRequests);&lt;br/&gt;
-&lt;br/&gt;
+				resourceManagerClient.removeContainerRequest(new AMRMClient.ContainerRequest(&lt;br/&gt;
+						container.getResource(), null, null, container.getPriority()));&lt;br/&gt;
 				if (numPendingContainerRequests &amp;gt; 0) &lt;/p&gt;
{
 					numPendingContainerRequests--;
 
diff --git a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java
index 10b2ce97d6f..d665df6bc7c 100644
--- a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java
+++ b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java
@@ -43,6 +43,8 @@
 import org.apache.hadoop.yarn.api.records.ContainerId;
 import org.apache.hadoop.yarn.api.records.ContainerLaunchContext;
 import org.apache.hadoop.yarn.api.records.NodeId;
+import org.apache.hadoop.yarn.api.records.Priority;
+import org.apache.hadoop.yarn.api.records.Resource;
 import org.apache.hadoop.yarn.client.api.AMRMClient;
 import org.apache.hadoop.yarn.client.api.NMClient;
 import org.apache.hadoop.yarn.client.api.async.AMRMClientAsync;
@@ -69,8 +71,11 @@
 import scala.concurrent.duration.FiniteDuration;
 
 import static org.junit.Assert.assertEquals;
+import static org.mockito.Mockito.any;
 import static org.mockito.Mockito.doAnswer;
 import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.times;
+import static org.mockito.Mockito.verify;
 import static org.mockito.Mockito.when;
 
 /**
@@ -125,6 +130,8 @@ public void testYarnFlinkResourceManagerJobManagerLostLeadership() throws Except
 							1),
 						i));
 				when(mockContainer.getNodeId()).thenReturn(NodeId.newInstance(&quot;container&quot;, 1234));
+				when(mockContainer.getResource()).thenReturn(Resource.newInstance(200, 1));
+				when(mockContainer.getPriority()).thenReturn(Priority.UNDEFINED);
 				containerList.add(mockContainer);
 			}

&lt;p&gt;@@ -233,6 +240,8 @@ public Object answer(InvocationOnMock invocation) throws Throwable &lt;/p&gt;
{
 
 				int numberOfRegisteredResources = (Integer) Await.result(numberOfRegisteredResourcesFuture, deadline.timeLeft());
 
+				verify(resourceManagerClient, times(numInitialTaskManagers)).removeContainerRequest(
+						any(AMRMClient.ContainerRequest.class));
 				assertEquals(numInitialTaskManagers, numberOfRegisteredResources);
 			}
&lt;p&gt; finally {&lt;br/&gt;
 				if (resourceManager != null) {&lt;br/&gt;
diff --git a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java&lt;br/&gt;
index d41d42d7a05..ee325dad0f7 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java&lt;br/&gt;
+++ b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java&lt;br/&gt;
@@ -401,6 +401,8 @@ public void testStopWorker() throws Exception {&lt;/p&gt;

&lt;p&gt; 				resourceManager.onContainersAllocated(ImmutableList.of(testingContainer));&lt;br/&gt;
 				verify(mockResourceManagerClient).addContainerRequest(any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
+				verify(mockResourceManagerClient).removeContainerRequest(&lt;br/&gt;
+						any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
 				verify(mockNMClient).startContainer(eq(testingContainer), any(ContainerLaunchContext.class));&lt;/p&gt;

&lt;p&gt; 				// Remote task executor registers with YarnResourceManager.&lt;br/&gt;
@@ -496,6 +498,8 @@ public void testOnContainerCompleted() throws Exception {&lt;/p&gt;

&lt;p&gt; 				resourceManager.onContainersAllocated(ImmutableList.of(testingContainer));&lt;br/&gt;
 				verify(mockResourceManagerClient).addContainerRequest(any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
+				verify(mockResourceManagerClient).removeContainerRequest(&lt;br/&gt;
+						any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
 				verify(mockNMClient).startContainer(eq(testingContainer), any(ContainerLaunchContext.class));&lt;/p&gt;

&lt;p&gt; 				// Callback from YARN when container is Completed, pending request can not be fulfilled by pending&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16684860" author="githubbot" created="Tue, 13 Nov 2018 08:19:34 +0000"  >&lt;p&gt;suez1224 opened a new pull request #7078: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10848&quot; title=&quot;Flink&amp;#39;s Yarn ResourceManager can allocate too many excess containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10848&quot;&gt;&lt;del&gt;FLINK-10848&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;YARN&amp;#93;&lt;/span&gt; properly remove YARN ContainerRequest upon container allocation success&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7078&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Properly remove YARN ContainerRequest upon container allocation success.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add call to removeContainerRequest in YarnFlinkResourceManager&lt;/li&gt;
	&lt;li&gt;add call to removeContainerRequest in YarnResourceManager&lt;/li&gt;
	&lt;li&gt;change unittests to verify,&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change is already covered by existing tests.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): ( no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: ( no)&lt;/li&gt;
	&lt;li&gt;The serializers: ( no )&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): ( no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: ( no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: ( no )&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? ( no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable )&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685391" author="githubbot" created="Tue, 13 Nov 2018 15:43:46 +0000"  >&lt;p&gt;suez1224 closed pull request #7078: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10848&quot; title=&quot;Flink&amp;#39;s Yarn ResourceManager can allocate too many excess containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10848&quot;&gt;&lt;del&gt;FLINK-10848&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;YARN&amp;#93;&lt;/span&gt; properly remove YARN ContainerRequest upon container allocation success&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7078&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YarnTestBase.java b/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YarnTestBase.java&lt;br/&gt;
index 3763f6592af..f1e6a3a767c 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YarnTestBase.java&lt;br/&gt;
+++ b/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YarnTestBase.java&lt;br/&gt;
@@ -165,6 +165,8 @@&lt;br/&gt;
 		YARN_CONFIGURATION.setInt(YarnConfiguration.DEBUG_NM_DELETE_DELAY_SEC, 3600);&lt;br/&gt;
 		YARN_CONFIGURATION.setBoolean(YarnConfiguration.LOG_AGGREGATION_ENABLED, false);&lt;br/&gt;
 		YARN_CONFIGURATION.setInt(YarnConfiguration.NM_VCORES, 666); // memory is overwritten in the MiniYARNCluster.&lt;br/&gt;
+		YARN_CONFIGURATION.set(&quot;yarn.scheduler.capacity.resource-calculator&quot;,&lt;br/&gt;
+				&quot;org.apache.hadoop.yarn.util.resource.DominantResourceCalculator&quot;);&lt;br/&gt;
 		// so we have to change the number of cores for testing.&lt;br/&gt;
 		YARN_CONFIGURATION.setInt(YarnConfiguration.RM_AM_EXPIRY_INTERVAL_MS, 20000); // 20 seconds expiry (to ensure we properly heartbeat with YARN).&lt;br/&gt;
 	}&lt;br/&gt;
diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java&lt;br/&gt;
index 8e686bbbe34..3327505e32d 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java&lt;br/&gt;
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java&lt;br/&gt;
@@ -438,6 +438,8 @@ private void containersAllocated(List&amp;lt;Container&amp;gt; containers) {&lt;br/&gt;
 			numPendingContainerRequests = Math.max(0, numPendingContainerRequests - 1);&lt;br/&gt;
 			LOG.info(&quot;Received new container: {} - Remaining pending container requests: {}&quot;,&lt;br/&gt;
 				container.getId(), numPendingContainerRequests);&lt;br/&gt;
+			resourceManagerClient.removeContainerRequest(new AMRMClient.ContainerRequest(&lt;br/&gt;
+					container.getResource(), null, null, container.getPriority()));&lt;/p&gt;

&lt;p&gt; 			// decide whether to return the container, or whether to start a TaskManager&lt;br/&gt;
 			if (numRegistered + containersInLaunch.size() &amp;lt; numRequired) {&lt;br/&gt;
diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
index 6ff5cd66487..6669f16fa40 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
@@ -361,7 +361,8 @@ public void onContainersAllocated(List&amp;lt;Container&amp;gt; containers) {&lt;br/&gt;
 					&quot;Received new container: {} - Remaining pending container requests: {}&quot;,&lt;br/&gt;
 					container.getId(),&lt;br/&gt;
 					numPendingContainerRequests);&lt;br/&gt;
-&lt;br/&gt;
+				resourceManagerClient.removeContainerRequest(new AMRMClient.ContainerRequest(&lt;br/&gt;
+						container.getResource(), null, null, container.getPriority()));&lt;br/&gt;
 				if (numPendingContainerRequests &amp;gt; 0) &lt;/p&gt;
{
 					numPendingContainerRequests--;
 
diff --git a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java
index 10b2ce97d6f..d665df6bc7c 100644
--- a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java
+++ b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnFlinkResourceManagerTest.java
@@ -43,6 +43,8 @@
 import org.apache.hadoop.yarn.api.records.ContainerId;
 import org.apache.hadoop.yarn.api.records.ContainerLaunchContext;
 import org.apache.hadoop.yarn.api.records.NodeId;
+import org.apache.hadoop.yarn.api.records.Priority;
+import org.apache.hadoop.yarn.api.records.Resource;
 import org.apache.hadoop.yarn.client.api.AMRMClient;
 import org.apache.hadoop.yarn.client.api.NMClient;
 import org.apache.hadoop.yarn.client.api.async.AMRMClientAsync;
@@ -69,8 +71,11 @@
 import scala.concurrent.duration.FiniteDuration;
 
 import static org.junit.Assert.assertEquals;
+import static org.mockito.Mockito.any;
 import static org.mockito.Mockito.doAnswer;
 import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.times;
+import static org.mockito.Mockito.verify;
 import static org.mockito.Mockito.when;
 
 /**
@@ -125,6 +130,8 @@ public void testYarnFlinkResourceManagerJobManagerLostLeadership() throws Except
 							1),
 						i));
 				when(mockContainer.getNodeId()).thenReturn(NodeId.newInstance(&quot;container&quot;, 1234));
+				when(mockContainer.getResource()).thenReturn(Resource.newInstance(200, 1));
+				when(mockContainer.getPriority()).thenReturn(Priority.UNDEFINED);
 				containerList.add(mockContainer);
 			}

&lt;p&gt;@@ -233,6 +240,8 @@ public Object answer(InvocationOnMock invocation) throws Throwable &lt;/p&gt;
{
 
 				int numberOfRegisteredResources = (Integer) Await.result(numberOfRegisteredResourcesFuture, deadline.timeLeft());
 
+				verify(resourceManagerClient, times(numInitialTaskManagers)).removeContainerRequest(
+						any(AMRMClient.ContainerRequest.class));
 				assertEquals(numInitialTaskManagers, numberOfRegisteredResources);
 			}
&lt;p&gt; finally {&lt;br/&gt;
 				if (resourceManager != null) {&lt;br/&gt;
diff --git a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java&lt;br/&gt;
index d41d42d7a05..ee325dad0f7 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java&lt;br/&gt;
+++ b/flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java&lt;br/&gt;
@@ -401,6 +401,8 @@ public void testStopWorker() throws Exception {&lt;/p&gt;

&lt;p&gt; 				resourceManager.onContainersAllocated(ImmutableList.of(testingContainer));&lt;br/&gt;
 				verify(mockResourceManagerClient).addContainerRequest(any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
+				verify(mockResourceManagerClient).removeContainerRequest(&lt;br/&gt;
+						any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
 				verify(mockNMClient).startContainer(eq(testingContainer), any(ContainerLaunchContext.class));&lt;/p&gt;

&lt;p&gt; 				// Remote task executor registers with YarnResourceManager.&lt;br/&gt;
@@ -496,6 +498,8 @@ public void testOnContainerCompleted() throws Exception {&lt;/p&gt;

&lt;p&gt; 				resourceManager.onContainersAllocated(ImmutableList.of(testingContainer));&lt;br/&gt;
 				verify(mockResourceManagerClient).addContainerRequest(any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
+				verify(mockResourceManagerClient).removeContainerRequest(&lt;br/&gt;
+						any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
 				verify(mockNMClient).startContainer(eq(testingContainer), any(ContainerLaunchContext.class));&lt;/p&gt;

&lt;p&gt; 				// Callback from YARN when container is Completed, pending request can not be fulfilled by pending&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685392" author="githubbot" created="Tue, 13 Nov 2018 15:43:47 +0000"  >&lt;p&gt;suez1224 opened a new pull request #7078: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10848&quot; title=&quot;Flink&amp;#39;s Yarn ResourceManager can allocate too many excess containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10848&quot;&gt;&lt;del&gt;FLINK-10848&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;YARN&amp;#93;&lt;/span&gt; properly remove YARN ContainerRequest upon container allocation success&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7078&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Properly remove YARN ContainerRequest upon container allocation success.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add call to removeContainerRequest in YarnFlinkResourceManager&lt;/li&gt;
	&lt;li&gt;add call to removeContainerRequest in YarnResourceManager&lt;/li&gt;
	&lt;li&gt;change unittests to verify,&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change is already covered by existing tests.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): ( no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: ( no)&lt;/li&gt;
	&lt;li&gt;The serializers: ( no )&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): ( no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: ( no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: ( no )&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? ( no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable )&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16693835" author="suez1224" created="Tue, 20 Nov 2018 22:04:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;, can you help take a look at this PR? Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="16720880" author="xinpu" created="Fri, 14 Dec 2018 03:25:06 +0000"  >&lt;p&gt;Shuyi, is there a posibility that the ContainerRequest be removed just after it has been sent to RM? The workaround provided in PR removes the ContainerRequest when get the container from RM, but if container-completed happens between requesting containers and allocated containers, then a new request also contains unproper ContainerRequest.&lt;/p&gt;</comment>
                            <comment id="16726502" author="suez1224" created="Fri, 21 Dec 2018 07:31:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xinpu&quot; class=&quot;user-hover&quot; rel=&quot;xinpu&quot;&gt;xinpu&lt;/a&gt;, the ContainerRequests are sent during the heartbeat with the RM, I am not aware of a callback that allow clients to remove sent ContainerRequest right after the heartbeat. &lt;/p&gt;

&lt;p&gt;Also, can you explain a bit on how container-completed can happens between container requests and container allocations on the same container?&lt;/p&gt;</comment>
                            <comment id="16731900" author="xinpu" created="Wed, 2 Jan 2019 09:56:18 +0000"  >&lt;p&gt;Yes,there is no perfect chance to remove the ContainerRequest just after it was received by RM.&lt;/p&gt;

&lt;p&gt;The scenario is below:&lt;br/&gt;
1.On time T, flink requests for n containers.&lt;br/&gt;
2.On time T+1, another container fails, flink requests for n+1 containers.&lt;br/&gt;
3.On time T+k(k&amp;gt;1), flink receives allocated containers, and remove the according ContainerRequest.&lt;br/&gt;
4.On time T+(k+1), another container fails,flink requests for 1 containers.&lt;/p&gt;

&lt;p&gt;What I mean is the step 4 is perfect, but the step 2 would request excess containers.&lt;/p&gt;

&lt;p&gt;Anyway, as mentioned above, there is no chance to remove ContainerRequest as soon as possible. The workaround provided in this PR is an acceptable solution.&lt;/p&gt;</comment>
                            <comment id="16733245" author="suez1224" created="Thu, 3 Jan 2019 17:17:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xinpu&quot; class=&quot;user-hover&quot; rel=&quot;xinpu&quot;&gt;xinpu&lt;/a&gt;, thanks for sharing your thoughts. You are right, ideally, we should prevent step 2. However, in AMRMClientAsync.CallbackHandler, AFAIK, we can only know that the previous n container requests has been sent to RM through the onContainersAllocated callback, so step 2 might be difficult to prevent. &lt;/p&gt;</comment>
                            <comment id="16734322" author="suez1224" created="Fri, 4 Jan 2019 16:42:57 +0000"  >&lt;p&gt;Fixed in master: e26d90fc86b266978b4bac84fe02ca34b62983fe.&lt;/p&gt;

&lt;p&gt;I&apos;ll patch the change to 1.6 and 1.7 later.&lt;/p&gt;</comment>
                            <comment id="16734963" author="suez1224" created="Sat, 5 Jan 2019 18:14:35 +0000"  >&lt;p&gt;Fixed in 1.6: 7cc4c6f3e5e84efc067f2f2179648e31e5defa27&lt;br/&gt;
Fixed in 1.7: 2576076f36e75fa81896a7cc275315bd8cd848da&lt;/p&gt;</comment>
                            <comment id="16734998" author="gjy" created="Sat, 5 Jan 2019 20:32:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=suez1224&quot; class=&quot;user-hover&quot; rel=&quot;suez1224&quot;&gt;suez1224&lt;/a&gt; What was the hadoop version that you tested with? I am seeing this stacktrace when testing against master (Hadoop 2.8.3)&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException
        at org.apache.hadoop.yarn.client.api.impl.AMRMClientImpl.decResourceRequest(AMRMClientImpl.java:845)
        at org.apache.hadoop.yarn.client.api.impl.AMRMClientImpl.removeContainerRequest(AMRMClientImpl.java:572)
        at org.apache.hadoop.yarn.client.api.async.impl.AMRMClientAsyncImpl.removeContainerRequest(AMRMClientAsyncImpl.java:207)
        at org.apache.flink.yarn.YarnResourceManager.lambda$onContainersAllocated$1(YarnResourceManager.java:364)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRunAsync(AkkaRpcActor.java:332)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:158)
        at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleRpcMessage(FencedAkkaRpcActor.java:70)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.onReceive(AkkaRpcActor.java:142)
        at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.onReceive(FencedAkkaRpcActor.java:40)
        at akka.actor.UntypedActor$$anonfun$receive$1.applyOrElse(UntypedActor.scala:165)
        at akka.actor.Actor$class.aroundReceive(Actor.scala:502)
        at akka.actor.UntypedActor.aroundReceive(UntypedActor.scala:95)
        at akka.actor.ActorCell.receiveMessage(ActorCell.scala:526)
        at akka.actor.ActorCell.invoke(ActorCell.scala:495)
        at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:257)
        at akka.dispatch.Mailbox.run(Mailbox.scala:224)
        at akka.dispatch.Mailbox.exec(Mailbox.scala:234)
        at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
        at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
        at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
        at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16735050" author="suez1224" created="Sat, 5 Jan 2019 23:58:45 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;, we are running on 2.7.2. Can you share the steps to reproduce the problem? Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="16735880" author="till.rohrmann" created="Mon, 7 Jan 2019 14:26:50 +0000"  >&lt;p&gt;My guess would be that we get a different &lt;tt&gt;Resource&lt;/tt&gt; back in &lt;tt&gt;onContainersAllocated&lt;/tt&gt; than we initially requested.&lt;/p&gt;</comment>
                            <comment id="16735965" author="till.rohrmann" created="Mon, 7 Jan 2019 15:30:31 +0000"  >&lt;p&gt;Update, so far I was not able to reproduce the problem found with the Jepsen tests. I&apos;ve executed the Yarn IT cases locally and also run Flink manually on a Hadoop 2.8.5 cluster. I&apos;m now running the Jepsen tests with slightly extended debugging logs to see whether my assumption is correct.&lt;/p&gt;</comment>
                            <comment id="16736636" author="kien_truong" created="Tue, 8 Jan 2019 02:15:38 +0000"  >&lt;p&gt;Yarn can return more containers than the number of requests, calling `removeContainerRequest` for each returned container without comparing it to the number of initial requests might be problematic.&lt;/p&gt;</comment>
                            <comment id="16736924" author="till.rohrmann" created="Tue, 8 Jan 2019 09:33:34 +0000"  >&lt;p&gt;I could confirm my suspicion. Apparently, there is a Yarn configuration where you request a container with &lt;tt&gt;mem&lt;/tt&gt; memory and &lt;tt&gt;cores&lt;/tt&gt; vcores and you receive a container with fewer vcores:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-01-07 15:53:04,840 INFO  org.apache.flink.yarn.YarnResourceManager - Requesting &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaskExecutor container with resources &amp;lt;memory:2048, vCores:3&amp;gt;. &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; pending requests 10.
2019-01-07 15:53:05,627 INFO  org.apache.flink.yarn.YarnResourceManager - Received &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; container: container_1546876305579_0001_02_000002 with capacity &amp;lt;memory:2048, vCores:1&amp;gt; - Remaining pending container requests: 10
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16736940" author="till.rohrmann" created="Tue, 8 Jan 2019 09:50:51 +0000"  >&lt;p&gt;Some more information: It seems that the problem is connected to Yarn&apos;s capacity scheduler. When using the &lt;tt&gt;DefaultResourceCalculator&lt;/tt&gt;, it will ignore the requested vCores and simply return a container with a single vCore. See &lt;a href=&quot;https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/CapacityScheduler.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/YARN-2413&quot; title=&quot;capacity scheduler will overallocate vcores&quot; class=&quot;issue-link&quot; data-issue-key=&quot;YARN-2413&quot;&gt;&lt;del&gt;YARN-2413&lt;/del&gt;&lt;/a&gt; for more information. &lt;/p&gt;

&lt;p&gt;When requesting a container with &lt;tt&gt;&amp;lt;memory: X, vCores: Y&amp;gt;&lt;/tt&gt; capacity it will be registered internally. If we now `removeContainerRequest` with a different capacity &lt;tt&gt;&amp;lt;memory: X, vCores: 1&amp;gt;&lt;/tt&gt;, then we will run into a &lt;tt&gt;NullPointerException&lt;/tt&gt; since there is no entry with vCores equal to 1. It is possible to reproduce this problem locally by removing &lt;tt&gt;YarnTestBase.java:168-169&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Since this change breaks existing Flink setups, I have to revert the commits and reopen this issue.&lt;/p&gt;</comment>
                            <comment id="16737110" author="till.rohrmann" created="Tue, 8 Jan 2019 13:20:26 +0000"  >&lt;p&gt;Reverted via&lt;br/&gt;
master: d77151c3907895abc586e0fc651a49f148a302be&lt;br/&gt;
1.7: fb0f811e4b4d395e182a124cecac7cdf845a8023&lt;br/&gt;
1.6: 8affc904d5d3f98fd464b783c30533d0fa516287&lt;/p&gt;</comment>
                            <comment id="16740475" author="till.rohrmann" created="Fri, 11 Jan 2019 15:18:39 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
1.8.0: 3903b817cb20524aec2c0fbee763e6bf73f5f989&lt;br/&gt;
1.7.2: eb7db3aed4e9651ed8624aa7797c5d9f656b2059&lt;br/&gt;
1.6.4: 4022836148a9e7cf39859389e644875dcd2a05e4&lt;/p&gt;</comment>
                            <comment id="16740796" author="suez1224" created="Fri, 11 Jan 2019 21:12:15 +0000"  >&lt;p&gt;Thanks a lot for fixing the issue, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;. One concern I have is that, in case of mismatch between container request and allocation containers (we ask for 2 vcores and YARN return container of 1 vcore), should we at least print out WARNING in the log to let the user know we are using containers of 1 vcore, and ask them not to use DefaultResourceCalculator if they need fine-grained cpu allocation? &lt;/p&gt;</comment>
                            <comment id="16740797" author="suez1224" created="Fri, 11 Jan 2019 21:15:05 +0000"  >&lt;p&gt;Also, can you please also help me take a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10868&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;FLINK-10868&lt;/a&gt;? It&apos;s causing Flink job on YARN to keep retrying container allocation but not fail. Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="16741942" author="till.rohrmann" created="Mon, 14 Jan 2019 11:06:16 +0000"  >&lt;p&gt;We could add such a warning but I would like to only print it once &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=suez1224&quot; class=&quot;user-hover&quot; rel=&quot;suez1224&quot;&gt;suez1224&lt;/a&gt; if possible.  Otherwise it might simply clutter the log. We should do this as a separate issue, though.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13195360">FLINK-10735</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13204200">FLINK-11149</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 44 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00d14:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>