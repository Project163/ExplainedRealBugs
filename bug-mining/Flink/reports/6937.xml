<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:16:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-31114] Batch job fails with IllegalStateException when using adaptive batch scheduler</title>
                <link>https://issues.apache.org/jira/browse/FLINK-31114</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;This is caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-30942&quot; title=&quot;Fix the bug that the decided parallelism by adaptive batch scheduler may be larger than the max parallelism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-30942&quot;&gt;&lt;del&gt;FLINK-30942&lt;/del&gt;&lt;/a&gt;. Currently, if two job vertices have the same input and the same parallelism(even the parallelism is -1), they will share partitions. However after &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-30942&quot; title=&quot;Fix the bug that the decided parallelism by adaptive batch scheduler may be larger than the max parallelism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-30942&quot;&gt;&lt;del&gt;FLINK-30942&lt;/del&gt;&lt;/a&gt;, the scheduler may change the job vertices&apos; parallelism before scheduling, resulting in two job vertices having the same parallelism in  compilation phase (in which case will share partitions), but different parallelism in the scheduling phase, and then cause the following exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.util.concurrent.CompletionException: java.lang.IllegalStateException: Consumers must have the same max parallelism.
        at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)
        at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)
        at java.util.concurrent.CompletableFuture.uniCompose(CompletableFuture.java:975)
        at java.util.concurrent.CompletableFuture$UniCompose.tryFire(CompletableFuture.java:940)
        ... 37 more
Caused by: java.lang.IllegalStateException: Consumers must have the same max parallelism.
        at org.apache.flink.util.Preconditions.checkState(Preconditions.java:193)
        at org.apache.flink.runtime.executiongraph.IntermediateResult.getConsumersMaxParallelism(IntermediateResult.java:219)
        at org.apache.flink.runtime.executiongraph.Execution.getPartitionMaxParallelism(Execution.java:501)
        at org.apache.flink.runtime.executiongraph.Execution.registerProducedPartitions(Execution.java:472)
        at org.apache.flink.runtime.executiongraph.Execution.registerProducedPartitions(Execution.java:431)
        at org.apache.flink.runtime.scheduler.DefaultExecutionDeployer.lambda$registerProducedPartitions$5(DefaultExecutionDeployer.java:277)
        at java.util.concurrent.CompletableFuture.uniCompose(CompletableFuture.java:966)
        ... 38 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Putting the following test into &lt;tt&gt;AdaptiveBatchSchedulerITCase&lt;/tt&gt; can reproduce the problem&#65306;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    void testDifferentConsumerParallelism() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Configuration configuration = createConfiguration();
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamExecutionEnvironment env =
                StreamExecutionEnvironment.createLocalEnvironment(configuration);
        env.setRuntimeMode(RuntimeExecutionMode.BATCH);
        env.setParallelism(8);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; DataStream&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; source1 =
                env.fromSequence(0, NUMBERS_TO_PRODUCE - 1)
                        .setParallelism(8)
                        .name(&lt;span class=&quot;code-quote&quot;&gt;&quot;source1&quot;&lt;/span&gt;)
                        .slotSharingGroup(&lt;span class=&quot;code-quote&quot;&gt;&quot;group1&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; DataStream&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; source2 =
                env.fromSequence(0, NUMBERS_TO_PRODUCE - 1)
                        .setParallelism(8)
                        .name(&lt;span class=&quot;code-quote&quot;&gt;&quot;source2&quot;&lt;/span&gt;)
                        .slotSharingGroup(&lt;span class=&quot;code-quote&quot;&gt;&quot;group2&quot;&lt;/span&gt;);

        source1.forward()
                .union(source2)
                .map(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NumberCounter())
                .name(&lt;span class=&quot;code-quote&quot;&gt;&quot;map1&quot;&lt;/span&gt;)
                .slotSharingGroup(&lt;span class=&quot;code-quote&quot;&gt;&quot;group3&quot;&lt;/span&gt;);

        source2.map(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NumberCounter()).name(&lt;span class=&quot;code-quote&quot;&gt;&quot;map2&quot;&lt;/span&gt;).slotSharingGroup(&lt;span class=&quot;code-quote&quot;&gt;&quot;group4&quot;&lt;/span&gt;);

        env.execute();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13525139">FLINK-31114</key>
            <summary>Batch job fails with IllegalStateException when using adaptive batch scheduler</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wanglijie">Lijie Wang</assignee>
                                    <reporter username="wanglijie">Lijie Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 17 Feb 2023 05:44:09 +0000</created>
                <updated>Wed, 10 May 2023 02:25:08 +0000</updated>
                            <resolved>Fri, 24 Feb 2023 11:39:08 +0000</resolved>
                                                    <fixVersion>1.17.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17693162" author="wanglijie95" created="Fri, 24 Feb 2023 11:36:56 +0000"  >&lt;p&gt;Fixed via&#160;&lt;/p&gt;

&lt;p&gt;master: b987ae18d0bc353c631bc54871b0c16be39dbad2&lt;/p&gt;

&lt;p&gt;release-1.17: c66ef2540c3cb53f4cf3218ff07f5b440511ad84&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13523499">FLINK-30942</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 37 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1g088:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>