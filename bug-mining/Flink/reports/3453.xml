<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:42:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-15047] YarnDistributedCacheITCase is unstable</title>
                <link>https://issues.apache.org/jira/browse/FLINK-15047</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;See also &lt;a href=&quot;https://api.travis-ci.com/v3/job/262854881/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.com/v3/job/262854881/log.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ZhenqiuHuang&quot; class=&quot;user-hover&quot; rel=&quot;ZhenqiuHuang&quot;&gt;ZhenqiuHuang&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13272120">FLINK-15047</key>
            <summary>YarnDistributedCacheITCase is unstable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xtsong">Xintong Song</assignee>
                                    <reporter username="tison">Zili Chen</reporter>
                        <labels>
                            <label>test-stability</label>
                    </labels>
                <created>Wed, 4 Dec 2019 05:52:36 +0000</created>
                <updated>Fri, 6 Dec 2019 09:32:30 +0000</updated>
                            <resolved>Wed, 4 Dec 2019 15:34:41 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16987684" author="gjy" created="Wed, 4 Dec 2019 09:34:53 +0000"  >&lt;p&gt;&lt;del&gt;Running this test locally failed 10 out of 10 times. I am promoting the priority to Blocker.&lt;/del&gt; &lt;/p&gt;

&lt;p&gt;Edit: I forgot to recompile Flink so I am not sure if it fails 10/10 times.&lt;/p&gt;</comment>
                            <comment id="16987859" author="xintongsong" created="Wed, 4 Dec 2019 13:20:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hpeter&quot; class=&quot;user-hover&quot; rel=&quot;hpeter&quot;&gt;hpeter&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;&lt;br/&gt;
I&apos;ve also looked into this failure case, and have already find the cause.&lt;br/&gt;
A solution is already included in the linked PR, and the explanation of the cause is as follows.&lt;/p&gt;

&lt;p&gt;The problem is caused together by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13983&quot; title=&quot;Launch task executor with new memory calculation logics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13983&quot;&gt;&lt;del&gt;FLINK-13983&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13184&quot; title=&quot;Starting a TaskExecutor blocks the YarnResourceManager&amp;#39;s main thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13184&quot;&gt;&lt;del&gt;FLINK-13184&lt;/del&gt;&lt;/a&gt;. The test case &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hpeter&quot; class=&quot;user-hover&quot; rel=&quot;hpeter&quot;&gt;hpeter&lt;/a&gt; introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14033&quot; title=&quot;Distributed caches are not registered in Yarn Per Job Cluster Mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14033&quot;&gt;&lt;del&gt;FLINK-14033&lt;/del&gt;&lt;/a&gt; just triggers the PR. It seems that &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14033&quot; title=&quot;Distributed caches are not registered in Yarn Per Job Cluster Mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14033&quot;&gt;&lt;del&gt;FLINK-14033&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13984&quot; title=&quot;Separate on-heap and off-heap managed memory pools&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13984&quot;&gt;&lt;del&gt;FLINK-13984&lt;/del&gt;&lt;/a&gt; passed travis and get merged separately, but when both changes are merged into the master branch, the test failure is triggered.&lt;/p&gt;

&lt;p&gt;When I try to debug this case, I find that this case does not output &apos;jobmanager.log&apos; and &apos;taskmanager.log&apos;, because it does not specify &lt;tt&gt;YarnConfigOptionsInternal#APPLICATION_LOG_CONFIG_FILE&lt;/tt&gt;. So I specified this configuration in the case, and surprisingly find that the case is fixed.&lt;/p&gt;

&lt;p&gt;After a few tries, I find that the test case fails when &lt;tt&gt;configuration&lt;/tt&gt; contains less than 2 key-value pairs, and success when there&apos;s more than 2. (This is later proved not always true, but it helped at this time.) So I removed &lt;tt&gt;AkkaOptions.ASK_TIMEOUT&lt;/tt&gt; from the &lt;tt&gt;configuration&lt;/tt&gt;, keeps only the one for log4j config file. In this way I finally get log files of a failure case.&lt;/p&gt;

&lt;p&gt;Looking into the log files, I find an exception in &apos;taskmanager.log&apos; saying &apos;jobmanager.rpc.address&apos; is null, which caused the task executor fail. Currently, we are passing task executor specific configurations through dynamic properties in the starting command (see &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13184&quot; title=&quot;Starting a TaskExecutor blocks the YarnResourceManager&amp;#39;s main thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13184&quot;&gt;&lt;del&gt;FLINK-13184&lt;/del&gt;&lt;/a&gt;). So I looked in to the starting command of the task executors.&lt;/p&gt;

&lt;p&gt;This is the starting command in a failure case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/bin/bash -c /Library/Java/JavaVirtualMachines/jdk1.8.0_171.jdk/Contents/Home/bin/java -Xmx268435450 -Xms268435450 -XX:MaxDirectMemorySize=214748366 -XX:MaxMetaspaceSize=134217728 -Dlog.file=/Users/xintongsong/workspace/xintongsong-flink/flink-yarn-tests/target/flink-yarn-tests-with-distributed-cache/flink-yarn-tests-with-distributed-cache-logDir-nm-1_0/application_1575456859645_0001/container_1575456859645_0001_01_000002/taskmanager.log -Dlog4j.configuration=file:./log4j.properties org.apache.flink.yarn.YarnTaskExecutorRunner -D taskmanager.memory.shuffle.max=80530638b -D taskmanager.memory.framework.off-heap.size=134217728b -D taskmanager.memory.framework.heap.size=134217728b -D taskmanager.memory.managed.size=322122552b -D taskmanager.memory.task.heap.size=134217722b -D taskmanager.memory.task.off-heap.size=0b -D taskmanager.memory.managed.off-heap.size=322122552b -D taskmanager.memory.shuffle.min=80530638b --configDir . -Dweb.port=0 -Dtaskmanager.memory.managed.size=322122552 bytes -Djobmanager.rpc.address=30.25.94.103 -Drest.address=30.25.94.103 -Dweb.tmpdir=/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/folders/nk/cj8wv8r97rn7w7dhwqzghpr40000gn/T/flink-web-ceab8aec-cf07-4c83-9cfc-9599d39a5980 -Djobmanager.rpc.port=53359 1&amp;gt; /Users/xintongsong/workspace/xintongsong-flink/flink-yarn-tests/target/flink-yarn-tests-with-distributed-cache/flink-yarn-tests-with-distributed-cache-logDir-nm-1_0/application_1575456859645_0001/container_1575456859645_0001_01_000002/taskmanager.out 2&amp;gt; /Users/xintongsong/workspace/xintongsong-flink/flink-yarn-tests/target/flink-yarn-tests-with-distributed-cache/flink-yarn-tests-with-distributed-cache-logDir-nm-1_0/application_1575456859645_0001/container_1575456859645_0001_01_000002/taskmanager.err&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And this is the starting command in a success case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/bin/bash -c /Library/Java/JavaVirtualMachines/jdk1.8.0_171.jdk/Contents/Home/bin/java -Xmx268435450 -Xms268435450 -XX:MaxDirectMemorySize=214748366 -XX:MaxMetaspaceSize=134217728 -Dlog.file=/Users/xintongsong/workspace/xintongsong-flink/flink-yarn-tests/target/flink-yarn-tests-with-distributed-cache/flink-yarn-tests-with-distributed-cache-logDir-nm-1_0/application_1575456859645_0001/container_1575456859645_0001_01_000002/taskmanager.log -Dlog4j.configuration=file:./log4j.properties org.apache.flink.yarn.YarnTaskExecutorRunner -D taskmanager.memory.shuffle.max=80530638b -D taskmanager.memory.framework.off-heap.size=134217728b -D taskmanager.memory.framework.heap.size=134217728b -D taskmanager.memory.managed.size=322122552b -D taskmanager.memory.task.heap.size=134217722b -D taskmanager.memory.task.off-heap.size=0b -D taskmanager.memory.managed.off-heap.size=322122552b -D taskmanager.memory.shuffle.min=80530638b --configDir . -Dweb.port=0 -Dtaskmanager.memory.managed.size=322122552 bytes -Djobmanager.rpc.address=30.25.94.103 -Drest.address=30.25.94.103 -Dweb.tmpdir=/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/folders/nk/cj8wv8r97rn7w7dhwqzghpr40000gn/T/flink-web-ceab8aec-cf07-4c83-9cfc-9599d39a5980 -Djobmanager.rpc.port=53359 1&amp;gt; /Users/xintongsong/workspace/xintongsong-flink/flink-yarn-tests/target/flink-yarn-tests-with-distributed-cache/flink-yarn-tests-with-distributed-cache-logDir-nm-1_0/application_1575456859645_0001/container_1575456859645_0001_01_000002/taskmanager.out 2&amp;gt; /Users/xintongsong/workspace/xintongsong-flink/flink-yarn-tests/target/flink-yarn-tests-with-distributed-cache/flink-yarn-tests-with-distributed-cache-logDir-nm-1_0/application_1575456859645_0001/container_1575456859645_0001_01_000002/taskmanager.err
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You will find &quot;-Dtaskmanager.memory.managed.size=322122552 bytes&quot; in both commands. The space between the number and &quot;bytes&quot; prevents parsing of the subsequent dynamic properties. In the failure case, the space comes before &quot;jobmanager.rpc.address&quot;, so the address is not parsed. In the success case, the space comes after the address, so the address is not affected.&lt;/p&gt;

&lt;p&gt;The dynamic properties are generated by &lt;tt&gt;Utils#getDynamicProperties&lt;/tt&gt;, where &lt;tt&gt;streram().flatMap().toArray()&lt;/tt&gt; is used. So the order of the properties depends on the internal implementation of java stream, probably related to number of configurations.&lt;/p&gt;

&lt;p&gt;The cause of the space in this case is that, in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13983&quot; title=&quot;Launch task executor with new memory calculation logics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13983&quot;&gt;&lt;del&gt;FLINK-13983&lt;/del&gt;&lt;/a&gt; we use &lt;tt&gt;tmResourceSpec.getManagedMemorySize().toString()&lt;/tt&gt; in &lt;tt&gt;ActiveResourceManagerFactory#createActiveResourceManagerConfiguration&lt;/tt&gt; to explicitly set managed memory size into the &lt;tt&gt;configuration&lt;/tt&gt;. &lt;tt&gt;MemorySize#toString&lt;/tt&gt; generates strings with spaces. I&apos;ve verified that changing it to &lt;tt&gt;tmResourceSpec.getManagedMemorySize().getBytes + &quot;b&quot;&lt;/tt&gt; can fix the problem.&lt;/p&gt;

&lt;p&gt;I already included the fix in our PR, so the test case should be fixed soon. &lt;/p&gt;

&lt;p&gt;And according to the findings during debugging this case, I would suggest two follow-ups.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;YarnDistributedCacheITCase&lt;/tt&gt; should generate jobmanager / taskmanager logs. &lt;tt&gt;YarnTestUtils.createClusterDescriptorWithLogging&lt;/tt&gt; may be used here.&lt;/li&gt;
	&lt;li&gt;Flink allows config options to have values that contain spaces. E.g., the default value of &lt;tt&gt;AkkaOption#ASK_TIMEOUT&lt;/tt&gt; is &quot;10 s&quot;. To prevent such problem in future, we should also allow spaces when dynamic properties. E.g., surround the values with double quotation marks, or escaping special characters.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="16987906" author="gjy" created="Wed, 4 Dec 2019 14:18:28 +0000"  >&lt;p&gt;I just want to point out that there are also other characters that potentially need to be escaped &lt;a href=&quot;https://stackoverflow.com/questions/15783701/which-characters-need-to-be-escaped-when-using-bash&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/15783701/which-characters-need-to-be-escaped-when-using-bash&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16987919" author="rmetzger" created="Wed, 4 Dec 2019 14:42:18 +0000"  >&lt;p&gt;If I&apos;m not mistaken, the test failed in all recent travis builds that had no caching issues:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/apache/flink/builds/620414836&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/flink/builds/620414836&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/apache/flink/builds/620386904&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/flink/builds/620386904&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/apache/flink/builds/620569917&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/flink/builds/620569917&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/apache/flink/builds/620497074&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/flink/builds/620497074&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16987945" author="xintongsong" created="Wed, 4 Dec 2019 15:29:16 +0000"  >&lt;p&gt;True, the master branch is broken.&lt;br/&gt;
Two PRs passed ci tests separately without each other. The failure is triggered when both of them are merged.&lt;br/&gt;
Andrey is merging the fix right now.&lt;/p&gt;</comment>
                            <comment id="16987952" author="azagrebin" created="Wed, 4 Dec 2019 15:34:41 +0000"  >&lt;p&gt;merged into master by&#160;4060acc46ebd31184f0e74ce11a3e3479ebef9dc&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13272653">FLINK-15088</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13272244">FLINK-15053</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13272256">FLINK-15055</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z099j4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>