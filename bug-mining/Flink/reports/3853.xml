<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:44:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-15579] UpsertStreamTableSink should work on batch mode</title>
                <link>https://issues.apache.org/jira/browse/FLINK-15579</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Because JDBCTableSourceSinkFactory.createStreamTableSink() create JDBCUpsertTableSink. But BatchExecSink can not work with UpsertStreamTableSink.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; translateToPlanInternal(
      planner: BatchPlanner): Transformation[&lt;span class=&quot;code-object&quot;&gt;Any&lt;/span&gt;] = {
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; resultTransformation = sink &lt;span class=&quot;code-keyword&quot;&gt;match&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _: RetractStreamTableSink[T] | _: UpsertStreamTableSink[T] =&amp;gt;
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TableException(&lt;span class=&quot;code-quote&quot;&gt;&quot;RetractStreamTableSink and UpsertStreamTableSink is not&quot;&lt;/span&gt; +
          &lt;span class=&quot;code-quote&quot;&gt;&quot; supported in Batch environment.&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;DDL like:&lt;br/&gt;
CREATE TABLE USER_RESULT(&lt;br/&gt;
NAME VARCHAR,&lt;br/&gt;
CITY VARCHAR,&lt;br/&gt;
SCORE BIGINT&lt;br/&gt;
) WITH (&lt;br/&gt;
&apos;connector.type&apos; = &apos;jdbc&apos;,&lt;br/&gt;
&apos;connector.url&apos; = &apos;&apos;,&lt;br/&gt;
&apos;connector.table&apos; = &apos;&apos;,&lt;br/&gt;
&apos;connector.driver&apos; = &apos;com.mysql.cj.jdbc.Driver&apos;,&lt;br/&gt;
&apos;connector.username&apos; = &apos;root&apos;,&lt;br/&gt;
&apos;connector.password&apos; = &apos;&apos;,&lt;br/&gt;
&apos;connector.write.flush.interval&apos; = &apos;1s&apos;)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13279252">FLINK-15579</key>
            <summary>UpsertStreamTableSink should work on batch mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="eric.zheng">Shu Li Zheng</assignee>
                                    <reporter username="eric.zheng">Shu Li Zheng</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 14 Jan 2020 04:08:10 +0000</created>
                <updated>Fri, 27 Mar 2020 01:25:41 +0000</updated>
                            <resolved>Wed, 25 Mar 2020 05:12:15 +0000</resolved>
                                    <version>1.9.2</version>
                    <version>1.10.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17014848" author="eric.zheng" created="Tue, 14 Jan 2020 04:27:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ykt836&quot; class=&quot;user-hover&quot; rel=&quot;ykt836&quot;&gt;ykt836&lt;/a&gt; Could you assign this bug to me? I would like to fix it.&lt;/p&gt;</comment>
                            <comment id="17014875" author="ykt836" created="Tue, 14 Jan 2020 06:05:28 +0000"  >&lt;p&gt;So you want to use JDBC as a batch sink?&lt;/p&gt;</comment>
                            <comment id="17014915" author="eric.zheng" created="Tue, 14 Jan 2020 08:06:56 +0000"  >&lt;p&gt;Yes, We have this requirement.&lt;/p&gt;</comment>
                            <comment id="17014930" author="ykt836" created="Tue, 14 Jan 2020 08:42:15 +0000"  >&lt;p&gt;Sounds good to me, assigning to you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eric.zheng&quot; class=&quot;user-hover&quot; rel=&quot;eric.zheng&quot;&gt;eric.zheng&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17014931" author="lzljs3620320" created="Tue, 14 Jan 2020 08:45:44 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eric.zheng&quot; class=&quot;user-hover&quot; rel=&quot;eric.zheng&quot;&gt;eric.zheng&lt;/a&gt;, I changed the title to &quot;Support UpsertStreamTableSink on Blink batch mode&quot;. FYI.&lt;/p&gt;</comment>
                            <comment id="17015665" author="eric.zheng" created="Wed, 15 Jan 2020 06:26:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; Hi jark, I&apos;m wondering why BatchExecSink do not support UpsertStreamTableSink now, Could you give me any suggestion? I want to modify BatchExecSink.translateToPlanInternal() and JDBCTableSourceSinkFactory.createStreamTableSink() related code to support UpsertStreamTableSink.&lt;/p&gt;</comment>
                            <comment id="17015674" author="jark" created="Wed, 15 Jan 2020 06:40:01 +0000"  >&lt;p&gt;In old planner, &lt;tt&gt;UpsertStreamTableSink&lt;/tt&gt; is only used for streaming mode. For batch mode, a sink should implement &lt;tt&gt;BatchTableSink&lt;/tt&gt;.&lt;br/&gt;
After introducing the new blink planner, streaming and batch are both using &lt;tt&gt;StreamTableSink&lt;/tt&gt; now. &lt;br/&gt;
And I think it&apos;s fine to support UpsertStreamTableSink for batch mode with all change flag set to &lt;tt&gt;true&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="17015715" author="eric.zheng" created="Wed, 15 Jan 2020 08:09:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; Thank you for the suggestion, In other words,  BatchExecSink. translateToPlanInternal() and StreamExecSink.translateToPlanInternal() should have exactly same logic now. right?&lt;/p&gt;</comment>
                            <comment id="17059996" author="xingoo" created="Mon, 16 Mar 2020 07:08:49 +0000"  >&lt;p&gt;I&apos;m try the code in this pullrequest: &lt;a href=&quot;https://github.com/apache/flink/pull/11045/files/ab87a7aa2192c0129929f5600f3fcdfec9512e46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/11045/files/ab87a7aa2192c0129929f5600f3fcdfec9512e46&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and I found if use upsert, must close the primary key validation in&#160;org.apache.flink.table.planner.operations.SqlToOperationConverter(line 169)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//&#20195;&#30721;&#21344;&#20301;&#31526;
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Operation convertCreateTable(SqlCreateTable sqlCreateTable) {
      &lt;span class=&quot;code-comment&quot;&gt;// primary key and unique keys are not supported
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((sqlCreateTable.getPrimaryKeyList().size() &amp;gt; 0)
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//       || (sqlCreateTable.getUniqueKeysList().size() &amp;gt; 0)) {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//       &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SqlConversionException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Primary key and unique key are not supported yet.&quot;&lt;/span&gt;);
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    }&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;if not, the tableKeys can not found&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//&#20195;&#30721;&#21344;&#20301;&#31526;
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; upsertSink: UpsertStreamTableSink[T] =&amp;gt;
  &lt;span class=&quot;code-comment&quot;&gt;// check &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; append only table
&lt;/span&gt;  val isAppendOnlyTable = UpdatingPlanChecker.isAppendOnly(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)
  upsertSink.setIsAppendOnly(isAppendOnlyTable)
  val tableKeys = {
    val sinkFieldNames = upsertSink.getTableSchema.getFieldNames
    UpdatingPlanChecker.getUniqueKeyFields(getInput, planner, sinkFieldNames) match {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Some(keys) =&amp;gt; keys.sortBy(_.length).headOption
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; None =&amp;gt; None
    }
  }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17060001" author="lzljs3620320" created="Mon, 16 Mar 2020 07:18:24 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xingoo&quot; class=&quot;user-hover&quot; rel=&quot;xingoo&quot;&gt;xingoo&lt;/a&gt;, you can not use primary key in DDL now.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Now the keys are inferred by the plan, as your list codes. Your query/plan must produce changelog like aggregation query.&#160;&lt;/li&gt;
	&lt;li&gt;We are doing to support primary keys in DDL. Maybe will be supported in the 1.11.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17064713" author="lzljs3620320" created="Mon, 23 Mar 2020 11:03:43 +0000"  >&lt;p&gt;Change it to bug, because so many users treat it as a bug...&lt;/p&gt;</comment>
                            <comment id="17066392" author="lzljs3620320" created="Wed, 25 Mar 2020 05:12:15 +0000"  >&lt;p&gt;master:&lt;/p&gt;

&lt;p&gt;56424794c291b9115080005220a17963048c3621&lt;/p&gt;

&lt;p&gt;d38a010c55ad78f4e421d581ec72a96a79324dfe&lt;/p&gt;</comment>
                            <comment id="17068189" author="xingoo" created="Fri, 27 Mar 2020 01:25:41 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;&#160;,&lt;/p&gt;

&lt;p&gt;how can i use upsert in batch jdbc sink.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//&#20195;&#30721;&#21344;&#20301;&#31526;
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; upsertSink: UpsertStreamTableSink[T] =&amp;gt;
  
  &lt;span class=&quot;code-comment&quot;&gt;// &#36825;&#37324;&#20160;&#20040;&#26102;&#20505;&#26159;true?
&lt;/span&gt;  val isAppendOnlyTable = UpdatingPlanChecker.isAppendOnly(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)

  upsertSink.setIsAppendOnly(isAppendOnlyTable)
  &lt;span class=&quot;code-comment&quot;&gt;// &#36825;&#37324;&#20160;&#20040;&#26102;&#20505;&#25165;&#33021;&#33719;&#21462;&#21040;keys?
&lt;/span&gt;  val tableKeys = {
    val sinkFieldNames = upsertSink.getTableSchema.getFieldNames
    UpdatingPlanChecker.getUniqueKeyFields(getInput, planner, sinkFieldNames) match {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Some(keys) =&amp;gt; keys.sortBy(_.length).headOption
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; None =&amp;gt; None
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ah7s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>