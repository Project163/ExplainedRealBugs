<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19852] Managed memory released check can block IterativeTask</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19852</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;UnsafeMemoryBudget#reserveMemory, called on&#160;TempBarrier, needs time to wait on GC of all allocated/released managed memory at every iteration.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;stack:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13014276/13014276_image-2020-10-28-17-48-48-583.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;new TempBarrier in BatchTask&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13014277/13014277_image-2020-10-28-17-48-28-395.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;These will be very slow than before.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13337630">FLINK-19852</key>
            <summary>Managed memory released check can block IterativeTask</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="shaomeng.wang">shaomeng.wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 28 Oct 2020 10:11:06 +0000</created>
                <updated>Tue, 22 Jun 2021 13:55:46 +0000</updated>
                            <resolved>Fri, 27 Nov 2020 15:04:47 +0000</resolved>
                                    <version>1.10.2</version>
                    <version>1.11.0</version>
                    <version>1.11.1</version>
                    <version>1.11.2</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.11.3</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17231231" author="azagrebin" created="Fri, 13 Nov 2020 07:58:57 +0000"  >&lt;p&gt;UnsafeMemory usage has indeed become more safe after 1.11. We do not just expect users of&#160;UnsafeMemory to always explicitly release it. MemorySegments are tracked by JVM GC to make sure that they are reused only once no other code refers to them, basically when they are GC&apos;ed but&#160;GC takes time, of course, this is the price for safety. It is very similar to JVM direct memory. The problem here is that the limit is relatively small per operator and it is exact (no playground to over-allocate). The usage pattern in&#160;TempBarrier is the worst for this safe approach because it tries to (re)-allocate all segments at once. Hence, it has to wait for GC of all&#160;segments between iterations (stop the world event). From what I see in&#160;SpillingBuffer/ListMemorySegmentSource it does not really need all segments at once, the segments are just pulled on-demand one-by-one. If&#160;ListMemorySegmentSource reserved segments also one-by-one then GC would be amortised between segments allocation. Ideally using code should also release segments asap once they are not needed anymore, this would give GC more time.&lt;/p&gt;</comment>
                            <comment id="17231267" author="arvid" created="Fri, 13 Nov 2020 08:59:47 +0000"  >&lt;p&gt;Another option that I discussed with Andrey offline is to not reallocate pages at all during batch iterations. Memory usage on batch-side should be rather safe. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; WDYT?&lt;/p&gt;</comment>
                            <comment id="17232483" author="xintongsong" created="Mon, 16 Nov 2020 03:27:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt;&#160;and I also had a discussion around this issue. We have similar opinion as yours, that the least invasive fix might be to have iterative tasks cache the pages and do not re-allocate them on each iteration.&lt;/p&gt;</comment>
                            <comment id="17233895" author="roman_khachatryan" created="Tue, 17 Nov 2020 19:51:05 +0000"  >&lt;p&gt;I took at the code and I think it can be solved by:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&quot;transferring&quot; memory segments from an old&#160;TempBarrier to the new one in BatchTask.resetAllInputs()&lt;/li&gt;
	&lt;li&gt;For that, add TempBarrier.closeForReuse() method, from which return the segments instead of calling&#160;memManager.release()&lt;/li&gt;
	&lt;li&gt;In TempBarrier constructor,&#160;some memory still has to be allocated because some segments might have been returned to reader/writer&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I don&apos;t see a clean way to collect old segments and create a new TB instance atomically. In between&#160;initInputLocalStrategy should be called. Reusing a TempBarrier instance seems to be error-prone.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Besides that, I have some concerns regarding the issue:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;initInputLocalStrategy() might also allocate memory; Are we sure that degradation is not caused by this?&#160;(e.g. ExternalSorterBuilder.doBuild())&lt;/li&gt;
	&lt;li&gt;at least one thread is created - for each&#160;TempBarrier - the same question&lt;/li&gt;
	&lt;li&gt;How big is the regression, are there any numbers? Critical Priority seems a bit subjective given that this issue appeared first in 1.10&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shaomeng.wang&quot; class=&quot;user-hover&quot; rel=&quot;shaomeng.wang&quot;&gt;shaomeng.wang&lt;/a&gt;, can you maybe clarify this?&lt;/p&gt;</comment>
                            <comment id="17236668" author="stephanewen" created="Sat, 21 Nov 2020 13:34:17 +0000"  >&lt;p&gt;Transferring the memory sounds reasonable here.&lt;/p&gt;

&lt;p&gt;I would go for the simplest solution here, not necessarily for the most long-term maintainable, because this code is not expected to be evolved too much any more. DataStream is taking over more and more functionality from DataSet.&lt;/p&gt;</comment>
                            <comment id="17237697" author="roman_khachatryan" created="Mon, 23 Nov 2020 21:00:25 +0000"  >&lt;p&gt;Thanks for your feedback &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ve created a PR to implement this approach:&#160;&lt;a href=&quot;https://github.com/apache/flink/pull/14184&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/14184&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17238748" author="arvid" created="Wed, 25 Nov 2020 13:17:58 +0000"  >&lt;p&gt;Merged into master as e46ee85824796db83b994d37cd757d4fe52a0dd2.&lt;/p&gt;</comment>
                            <comment id="17239718" author="arvid" created="Fri, 27 Nov 2020 15:04:38 +0000"  >&lt;p&gt;Merged into 1.11 as 05a7875448b6f92450083c17153e7f21e7de2e31.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13281453">FLINK-15758</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13014277" name="image-2020-10-28-17-48-28-395.png" size="132473" author="shaomeng.wang" created="Wed, 28 Oct 2020 09:48:29 +0000"/>
                            <attachment id="13014276" name="image-2020-10-28-17-48-48-583.png" size="159987" author="shaomeng.wang" created="Wed, 28 Oct 2020 09:48:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 50 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k2sw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>