<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:42:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-15105] Resuming Externalized Checkpoint after terminal failure (rocks, incremental) end-to-end test stalls on travis</title>
                <link>https://issues.apache.org/jira/browse/FLINK-15105</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Resuming Externalized Checkpoint after terminal failure (rocks, incremental) end-to-end test fails on release-1.9 nightly build stalls with &quot;The job exceeded the maximum log length, and has been terminated&quot;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://api.travis-ci.org/v3/job/621090394/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/621090394/log.txt&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13272747">FLINK-15105</key>
            <summary>Resuming Externalized Checkpoint after terminal failure (rocks, incremental) end-to-end test stalls on travis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="klion26">Congxian Qiu</assignee>
                                    <reporter username="liyu">Yu Li</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Fri, 6 Dec 2019 12:51:49 +0000</created>
                <updated>Tue, 17 Dec 2019 15:32:54 +0000</updated>
                            <resolved>Tue, 17 Dec 2019 15:32:54 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16989741" author="zentol" created="Fri, 6 Dec 2019 13:07:01 +0000"  >&lt;p&gt;If you run into this error message in 99% of the cases some exception occurred and the e2e tests prints the logs of all processes.&lt;/p&gt;

&lt;p&gt;The only error I found so far is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
	at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1205)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.Exception: Artificial failure.
	at org.apache.flink.streaming.tests.FailureMapper.notifyCheckpointComplete(FailureMapper.java:70)
	at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.notifyCheckpointComplete(AbstractUdfStreamOperator.java:130)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.notifyCheckpointComplete(StreamTask.java:822)
	at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1200)
	... 5 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The artificial failure is whitelisted; maybe something has changed how we bubble them up?&lt;/p&gt;</comment>
                            <comment id="16989912" author="yunta" created="Fri, 6 Dec 2019 16:02:17 +0000"  >&lt;p&gt;I&apos;m afraid it&apos;s not easy to figure out this issue. The shell scripts detect the logs containing errors, however, when it tries to print all logs out it exceeded the maximum log length. In other words, we do not know the actual errors.&lt;/p&gt;</comment>
                            <comment id="16991179" author="klion26" created="Mon, 9 Dec 2019 06:37:46 +0000"  >&lt;p&gt;The test complete checkpoint successfully in the first job, and resumed from the checkpoint successfully in the second job, and can complete checkpoint in the seconde job successfully,&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// log &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; first job
&lt;/span&gt;2019-12-05 20:12:17,410 INFO&#160; org.apache.flink.runtime.executiongraph.ExecutionGraph&#160; &#160; &#160; &#160; - SlidingWindowOperator (1/2) (5a5c73dd041a0145bc02dc017e46bf1f) switched from DE
PLOYING to RUNNING.
2019-12-05 20:12:17,970 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160; - Triggering checkpoint 1 @ 1575576737956 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 39a292088648857cac5f7e110547c18
0.
2019-12-05 20:12:21,095 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160; - Completed checkpoint 1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 39a292088648857cac5f7e110547c180 (261564 bytes in 3114 ms).
2019-12-05 20:12:21,113 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160; - Triggering checkpoint 2 @ 1575576741094 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 39a292088648857cac5f7e110547c180.
2019-12-05 20:12:22,002 INFO&#160; org.apache.flink.runtime.executiongraph.ExecutionGraph&#160; &#160; &#160; &#160; - FailureMapper (1/1) (4d273da136346ef3ff6e1a54d197f00b) switched from RUNNING to
 FAILED.
java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
&#160; &#160; &#160; &#160; at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1205)
&#160; &#160; &#160; &#160; at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
&#160; &#160; &#160; &#160; at java.util.concurrent.FutureTask.run(FutureTask.java:266)
&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
&#160; &#160; &#160; &#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.Exception: Artificial failure.
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.tests.FailureMapper.notifyCheckpointComplete(FailureMapper.java:70)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.notifyCheckpointComplete(AbstractUdfStreamOperator.java:130)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.notifyCheckpointComplete(StreamTask.java:822)
&#160; &#160; &#160; &#160; at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1200)
&#160; &#160; &#160; &#160; ... 5 more
2019-12-05 20:12:22,014 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160; - Discarding checkpoint 2 of job 39a292088648857cac5f7e110547c180.
java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
&#160; &#160; &#160; &#160; at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1205)
&#160; &#160; &#160; &#160; at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
&#160; &#160; &#160; &#160; at java.util.concurrent.FutureTask.run(FutureTask.java:266)
&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
&#160; &#160; &#160; &#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.Exception: Artificial failure.
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.tests.FailureMapper.notifyCheckpointComplete(FailureMapper.java:70)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.notifyCheckpointComplete(AbstractUdfStreamOperator.java:130)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.notifyCheckpointComplete(StreamTask.java:822)
&#160; &#160; &#160; &#160; at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1200)
&#160; &#160; &#160; &#160; ... 5 more

&lt;span class=&quot;code-comment&quot;&gt;// log &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; second job
&lt;/span&gt;2019-12-05 20:12:27,190 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160; - Starting job 7c862506012fb04c0d565bfda7cc9595 from savepoint file:&lt;span class=&quot;code-comment&quot;&gt;///home/travis/build/apache/flink/flink-end-to-end-tests/test-scripts/temp-test-directory-02075534631/externalized-chckpt-e2e-backend-dir/39a292088648857cac5f7e110547c180/chk-1 ()
&lt;/span&gt;2019-12-05 20:12:27,213 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160; - Reset the checkpoint ID of job 7c862506012fb04c0d565bfda7cc9595 to 2.
2019-12-05 20:12:27,220 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160; - Restoring job 7c862506012fb04c0d565bfda7cc9595 from latest valid checkpoint: Checkpoint 1 @ 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 7c862506012fb04c0d565bfda7cc9595.
2019-12-05 20:12:27,231 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160; - No master state to restore
2019-12-05 20:12:27,232 INFO&#160; org.apache.flink.runtime.jobmaster.JobManagerRunner &#160; &#160; &#160; &#160; &#160; - JobManager runner &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job General purpose test job (7c862506012fb04c0d565bfda7cc9595) was granted leadership with session id 00000000-0000-0000-0000-000000000000 at akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@localhost:6123/user/jobmanager_1.
&lt;/span&gt;2019-12-05 20:12:27,233 INFO&#160; org.apache.flink.runtime.jobmaster.JobMaster&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; - Starting execution of job General purpose test job (7c862506012fb04c0d565bfda7cc9595) under job master id 00000000000000000000000000000000.
2019-12-05 20:12:27,233 INFO&#160; org.apache.flink.runtime.executiongraph.ExecutionGraph&#160; &#160; &#160; &#160; - Job General purpose test job (7c862506012fb04c0d565bfda7cc9595) switched from state CREATED to RUNNING.
2019-12-05 20:12:29,668 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160; - Completed checkpoint 2 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 7c862506012fb04c0d565bfda7cc9595 (272831 bytes in 1389 ms).
2019-12-05 20:12:29,683 INFO&#160; org.apache.flink.runtime.checkpoint.CheckpointCoordinator &#160; &#160; - Triggering checkpoint 3 @ 1575576749668 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 7c862506012fb04c0d565bfda7cc9595.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;it failed because the log contains some error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Found error in log files:^M&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;if we execute the command(copied from common.sh)&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
grep -rv &lt;span class=&quot;code-quote&quot;&gt;&quot;GroupCoordinatorNotAvailableException&quot;&lt;/span&gt; log.txt| grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;RetriableCommitFailedException&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;NoAvailableBrokersException&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;Async Kafka commit failed&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;DisconnectException&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;AskTimeoutException&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; loading kafka-version.properties&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;WARN&#160; akka.remote.transport.netty.NettyTransport&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;WARN&#160; org.apache.flink.shaded.akka.org.jboss.netty.channel.DefaultChannelPipeline&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;jvm-exit-on-fatal-error&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&apos;^INFO:.*AWSErrorCode=\[400 Bad Request\].*ServiceEndpoint=\[https:&lt;span class=&quot;code-comment&quot;&gt;//.*\.s3\.amazonaws\.com\].*RequestType=\[HeadBucketRequest\]&apos;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;RejectedExecutionException&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;An exception was thrown by an exception handler&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.NoClassDefFoundError: org/apache/hadoop/yarn/exceptions/YarnException&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.NoClassDefFoundError: org/apache/hadoop/conf/Configuration&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.flink.fs.shaded.hadoop3.org.apache.commons.beanutils.FluentPropertyBeanIntrospector&#160; - Error when creating PropertyDescriptor &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; void org.apache.flink.fs.shaded.hadoop3.org.apache.commons.configuration2.AbstractConfiguration.setProperty(java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)! Ignoring &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; property.&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; loading kafka-version.properties :&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;Failed Elasticsearch item request&quot;&lt;/span&gt; | grep -v &lt;span class=&quot;code-quote&quot;&gt;&quot;[Terror] modules&quot;&lt;/span&gt; | grep -i &lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;then we&apos;ll get the following output&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
log.txt:Checking &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; errors...
log.txt:Found error in log files:
log.txt:java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
log.txt:java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
log.txt:java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
log.txt:java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
log.txt:java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
log.txt:java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;All the above &lt;tt&gt;java.lang.RuntimeException: Error while confirming checkpoint&lt;/tt&gt; was caused by&#160;Artificial failure.&lt;/p&gt;

&lt;p&gt;The Artificial failure was throw when completing checkpoint in &lt;a href=&quot;https://github.com/apache/flink/blob/171020749f7fccfa7781563569e2c88ea5e8b6a1/flink-end-to-end-tests/flink-datastream-allround-test/src/main/java/org/apache/flink/streaming/tests/FailureMapper.java#L66&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FailureMapper&lt;/a&gt;, and seems we have an infinite source from &lt;a href=&quot;https://github.com/apache/flink/blob/171020749f7fccfa7781563569e2c88ea5e8b6a1/flink-end-to-end-tests/flink-datastream-allround-test/src/main/java/org/apache/flink/streaming/tests/SequenceGeneratorSource.java#L102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SequenceGeneratorSource&lt;/a&gt;,&#160;I&apos;m not sure why we need to throw Artificial failure when completing checkpoint, maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;know more about this, as he introduced the &lt;tt&gt;FailureMapper&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If we do not rely on throwing Exception when completing checkpoint, I think we can remove the logic throwing Artifical failure when completing checkpoint. and if this is the right direction, I can help to fix it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16992425" author="till.rohrmann" created="Tue, 10 Dec 2019 10:54:04 +0000"  >&lt;p&gt;I&apos;m not sure whether it is the problem of the &lt;tt&gt;FailureMapper&lt;/tt&gt;. The failure mapper is an operator which throws exceptions after processing a given amount of records and having completed so and so many checkpoints. This sounds fine to me. I believe the problem is more how the test is set up and maybe the assumptions about the job behaviour are wrong. But then we should rather correct the test or its setup instead of removing the &lt;tt&gt;FailureMapper&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16992673" author="klion26" created="Tue, 10 Dec 2019 15:47:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160; In the previous comment, I didn&apos;t want to remove the&#160;whole&#160;&lt;tt&gt;FailureMapper&lt;/tt&gt;, but just want to remove the &lt;tt&gt;Artificial failure&lt;/tt&gt; throwing statement in &lt;tt&gt;FailureMapper&lt;/tt&gt;#&lt;tt&gt;notifyCheckpointComplete just as the comment in the below code block.&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T map(T value) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
   numProcessedRecords++;

   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isReachedFailureThreshold()) {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Exception(&lt;span class=&quot;code-quote&quot;&gt;&quot;Artificial failure.&quot;&lt;/span&gt;);
   }

   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value;
}

@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void notifyCheckpointComplete(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; checkpointId) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
   numCompleteCheckpoints++;

   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isReachedFailureThreshold()) { &lt;span class=&quot;code-comment&quot;&gt;////// =========== just want to remove &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; ===========
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Exception(&lt;span class=&quot;code-quote&quot;&gt;&quot;Artificial failure.&quot;&lt;/span&gt;);
   }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think the problem here is that we throw Artifical failure when completing checkpoint&lt;/p&gt;

&lt;p&gt;After throwing &lt;tt&gt;Artificial failure&lt;/tt&gt; in &lt;tt&gt;FailureMapper#notifyCheckpointComplete&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;---&amp;gt; we got the following exception(attached below)&lt;/p&gt;

&lt;p&gt;---&amp;gt; test failed when &lt;tt&gt;check_logs_for_errors&lt;/tt&gt;&#160;using the commands in &lt;tt&gt;common.sh&lt;/tt&gt;.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
        at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1205)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.Exception: Artificial failure.
        at org.apache.flink.streaming.tests.FailureMapper.notifyCheckpointComplete(FailureMapper.java:70)
        at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.notifyCheckpointComplete(AbstractUdfStreamOperator.java:130)
        at org.apache.flink.streaming.runtime.tasks.StreamTask.notifyCheckpointComplete(StreamTask.java:822)
        at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1200)
        ... 5 more

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Remove the &lt;tt&gt;Artificial failure throwing&lt;/tt&gt; in &lt;tt&gt;FailureMapper#notifyCheckpointComplete, we can still throw }}{{Aritifical failure&lt;/tt&gt; in &lt;tt&gt;FailureMapper#notifyCheckpointComplete&lt;/tt&gt;, IMHO, the &lt;tt&gt;Artificial failure throwing&lt;/tt&gt; is just needed when the source is finite, but in the test job, we use&#160;&lt;a href=&quot;https://github.com/apache/flink/blob/171020749f7fccfa7781563569e2c88ea5e8b6a1/flink-end-to-end-tests/flink-datastream-allround-test/src/main/java/org/apache/flink/streaming/tests/SequenceGeneratorSource.java#L102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SequenceGeneratorSource&lt;/a&gt;, it is an infinite source.&lt;/p&gt;</comment>
                            <comment id="16993437" author="till.rohrmann" created="Wed, 11 Dec 2019 10:59:48 +0000"  >&lt;p&gt;Wouldn&apos;t this affect all tests which use the &lt;tt&gt;FailureMapper&lt;/tt&gt;? Moreover, we would no longer be able to test the behaviour when &lt;tt&gt;notifyCheckpointComplete&lt;/tt&gt; fails which imo is a valid case. We would need to check all tests that no other test uses this feature for any test.&lt;/p&gt;

&lt;p&gt;Does the above-mentioned test case rely on the &lt;tt&gt;isReachedFailureThreshold&lt;/tt&gt; in the &lt;tt&gt;map&lt;/tt&gt; function? If not, then one could maybe reconfigure the &lt;tt&gt;FailureMapper&lt;/tt&gt; to not throw exceptions at all. Or one extends it so that one can control that it should not throw exceptions in &lt;tt&gt;notifyCheckpointComplete&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Alternatively, one could change the message of the &lt;tt&gt;RuntimeException&lt;/tt&gt; to not contain &quot;error&quot; in it. Then the check should not fail.&lt;/p&gt;</comment>
                            <comment id="16993554" author="klion26" created="Wed, 11 Dec 2019 13:45:46 +0000"  >&lt;p&gt;First, answer the last question: we can&apos;t just remove &quot;error&quot; message in &lt;tt&gt;RuntimeException&lt;/tt&gt;,&#160; we&apos;ll fail in &lt;tt&gt;common.sh#&lt;/tt&gt;&lt;tt&gt;check_logs_for_exceptions()&lt;/tt&gt;&#160;because of the &lt;tt&gt;RuntimeException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Then I&apos;ll try to describe more about the things about &lt;tt&gt;FailureMapper&lt;/tt&gt;.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;FailureMapper is only used in {{DataStreamAllroundTestProgram.&lt;/tt&gt;}}&lt;/li&gt;
	&lt;li&gt;we&apos;ll add a &lt;tt&gt;FailureMapper&lt;/tt&gt; in &lt;tt&gt;DataStreamAllroundTestProgram only if we &lt;a href=&quot;https://github.com/apache/flink/blob/eddad99123525211c900102206384dacaf8385fc/flink-end-to-end-tests/flink-datastream-allround-test/src/main/java/org/apache/flink/streaming/tests/DataStreamAllroundTestProgram.java#L173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;enabled TEST_SIMULATE_FAILURE&lt;/a&gt;&lt;/tt&gt;&#160;in &lt;tt&gt;DataStreamAllroundTestProgram&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;We&apos;ll throw Exception in {{FailureMapper#map&lt;/tt&gt;}}&#160;and &lt;tt&gt;FailureMapper#notifyCheckpointComplete&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;we&apos;ll enable {{TEST_SIMULATE_FAILURE&lt;/tt&gt;&#160;}}&#160;in &lt;tt&gt;test_ha_datastream.sh&lt;/tt&gt;, &lt;tt&gt;test_ha_per_job_cluster_datastream.sh&lt;/tt&gt; and &lt;tt&gt;test_resume_externalized_checkpoints.sh&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;IIUC, all the above tests are wanna test whether the job can restore from(restore with checkpoint) the last failed job successfully(but we do not care where the exception come from, then Exception thrown from FailureMapper#mapper or FailureMapper#notifyCheckpointComplete have the same effect). If we want to verify that&#160;`failure of notifyCheckpointComplete can fail task`, maybe we can add a ut for it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16994618" author="zentol" created="Thu, 12 Dec 2019 12:46:44 +0000"  >&lt;p&gt;Since this tests results in error behavior, wouldn&apos;t the simplest solution be to disable the exception check for runs where failures are being simulated?&lt;br/&gt;
This would only affect the &lt;tt&gt;after terminal failure&lt;/tt&gt; variant of the &lt;tt&gt;Resuming Externalized Checkpoint&lt;/tt&gt; tests.&lt;/p&gt;

&lt;p&gt;The correctness of the execution is verified by the test itself; checking that only very specific exceptions are being thrown in case of an error seems a bit strict and a contract we realistically can&apos;t enforce.&lt;/p&gt;</comment>
                            <comment id="16994631" author="till.rohrmann" created="Thu, 12 Dec 2019 12:58:41 +0000"  >&lt;p&gt;Sounds good to me. Additionally, we already whitelisted the &quot;Artificial failure&quot; &lt;tt&gt;Exception&lt;/tt&gt; which indicates that we tried to ignore these exceptions. Apparently, this was not fully achieved as there are other stack traces where it occurs. Hence, the easiest solution could be to disable the check altogether.&lt;/p&gt;</comment>
                            <comment id="16994704" author="klion26" created="Thu, 12 Dec 2019 14:02:00 +0000"  >&lt;p&gt;Agree that &lt;tt&gt;disable the exception check&lt;/tt&gt; here is the easiest way to fix this issue, and we don&apos;t need to touch any existing code.&#160; Then we&apos;ll disable exception check for all test running &lt;tt&gt;test_resume_externalized_checkpoints.sh&lt;/tt&gt;. I can help to fix this, could someone help to assign this ticket to me?&lt;/p&gt;</comment>
                            <comment id="16996978" author="carp84" created="Mon, 16 Dec 2019 05:34:54 +0000"  >&lt;p&gt;Another stalling instance observed but on different case &apos;Resuming Externalized Checkpoint (rocks, incremental, scale down) end-to-end test&apos;: &lt;a href=&quot;https://api.travis-ci.org/v3/job/625037128/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/625037128/log.txt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16996981" author="carp84" created="Mon, 16 Dec 2019 05:52:11 +0000"  >&lt;p&gt;Another stalling instance on &apos;Resuming Externalized Checkpoint (file, sync, no parallelism change) end-to-end test&apos;: &lt;a href=&quot;https://api.travis-ci.org/v3/job/625037135/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/625037135/log.txt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16998327" author="gjy" created="Tue, 17 Dec 2019 15:32:54 +0000"  >&lt;p&gt;1.10: 527d0584065b899e739f652cb5ade3d1440571a9&lt;br/&gt;
master: ca02ebc8e2f7bad2c64aa7e35aa8249d94ca180c&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 48 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09deg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>