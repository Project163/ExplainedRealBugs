<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:21:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-35764] TimerGauge is incorrect when update is called during a measurement</title>
                <link>https://issues.apache.org/jira/browse/FLINK-35764</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Currently in &lt;tt&gt;TimerGauge&lt;/tt&gt;, the timer measures the time spent in a state (marked by &lt;tt&gt;markStart()&lt;/tt&gt; and &lt;tt&gt;markEnd()&lt;/tt&gt;). The current logic is as follows:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;markStart()&lt;/tt&gt; bumps &lt;tt&gt;currentMeasurementStartTS&lt;/tt&gt; and &lt;tt&gt;currentUpdateTS&lt;/tt&gt;, while &lt;tt&gt;update()&lt;/tt&gt; bumps &lt;tt&gt;currentUpdateTS&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;currentCount&lt;/tt&gt; stores the time in the state within this update interval&lt;/li&gt;
	&lt;li&gt;When calling &lt;tt&gt;markEnd()&lt;/tt&gt;, the time since &lt;tt&gt;currentMeasurementStartTS&lt;/tt&gt; is added to the &lt;tt&gt;currentCount&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;When calling &lt;tt&gt;update()&lt;/tt&gt;, the time since &lt;tt&gt;currentUpdateTS&lt;/tt&gt; is added to the &lt;tt&gt;currentCount&lt;/tt&gt;, and the &lt;tt&gt;currentCount&lt;/tt&gt; is used to update the gauge value&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The intent is that a state can span across two update intervals (by calling &lt;tt&gt;markStart() -&amp;gt; update() -&amp;gt; markEnd()&lt;/tt&gt;). However, the results will be incorrect, since the time between &lt;tt&gt;markStart()&lt;/tt&gt; and &lt;tt&gt;update()&lt;/tt&gt; will be counted in the first update interval by &lt;tt&gt;update()&lt;/tt&gt;, and then in the second update interval by &lt;tt&gt;markEnd()&lt;/tt&gt;, so the measurement will be larger than the correct value. The correct solution is to only add the time since &lt;tt&gt;currentUpdateTS&lt;/tt&gt; to &lt;tt&gt;currentCount&lt;/tt&gt; in &lt;tt&gt;markEnd()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Test case&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;@Test &#160;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;void testUpdateBeforeMarkingEnd() { &#160;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; ManualClock clock = new ManualClock(42_000_000);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; // this timer gauge measures 2 update intervals&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; TimerGauge gauge = new TimerGauge(clock, 2 * View.UPDATE_INTERVAL_SECONDS);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; long UPDATE_INTERVAL_MILLIS = TimeUnit.SECONDS.toMillis(View.UPDATE_INTERVAL_SECONDS); &#160;// 5000 ms&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; long SLEEP = 10; &#160;// 10 ms&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; &#160; // interval 1&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; clock.advanceTime(UPDATE_INTERVAL_MILLIS - SLEEP, TimeUnit.MILLISECONDS); &#160;// *(1)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; gauge.markStart(); &#160;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; clock.advanceTime(SLEEP, TimeUnit.MILLISECONDS); &#160;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; gauge.update();&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; // interval 2&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; clock.advanceTime(SLEEP, TimeUnit.MILLISECONDS); &#160;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; gauge.markEnd();&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; clock.advanceTime(UPDATE_INTERVAL_MILLIS - SLEEP, TimeUnit.MILLISECONDS); &#160;// *(1)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; gauge.update(); &#160;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; &#160; // expected: 2, actual: 3&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; assertThat(gauge.getValue()).isEqualTo(SLEEP / View.UPDATE_INTERVAL_SECONDS); &#160;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;}&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The current test cases in &lt;tt&gt;TimerGaugeTest&lt;/tt&gt; do not catch this bug, because the assert condition is (conveniently) &lt;tt&gt;isGreaterThanOrEqualTo&lt;/tt&gt;, and the code does not simulate the time passed outside the state (&lt;tt&gt;*(1)&lt;/tt&gt; in the code above).&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Proposed changes&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In &lt;tt&gt;TimerGauge&lt;/tt&gt;, only add the time since &lt;tt&gt;currentUpdateTS&lt;/tt&gt; to &lt;tt&gt;currentCount&lt;/tt&gt; in &lt;tt&gt;markEnd()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Add the test case above to &lt;tt&gt;TimerGaugeTest&lt;/tt&gt;, and adjust other test cases&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13584796">FLINK-35764</key>
            <summary>TimerGauge is incorrect when update is called during a measurement</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="auroflow">Liu Liu</assignee>
                                    <reporter username="auroflow">Liu Liu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 5 Jul 2024 07:35:55 +0000</created>
                <updated>Sat, 12 Oct 2024 02:25:11 +0000</updated>
                            <resolved>Mon, 30 Sep 2024 09:54:44 +0000</resolved>
                                    <version>1.15.0</version>
                    <version>1.16.0</version>
                    <version>1.17.0</version>
                    <version>1.18.0</version>
                    <version>1.19.0</version>
                    <version>1.20.0</version>
                                    <fixVersion>1.19.2</fixVersion>
                    <fixVersion>1.20.1</fixVersion>
                    <fixVersion>2.0-preview</fixVersion>
                                    <component>Runtime / Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17863148" author="JIRAUSER306078" created="Fri, 5 Jul 2024 07:36:37 +0000"  >&lt;p&gt;Could someone assign this to me please?&lt;/p&gt;</comment>
                            <comment id="17883025" author="JIRAUSER306078" created="Thu, 19 Sep 2024 14:17:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Hello, I see you edited the TimerGauge class since I opened this issue, but this problem still exists. I have made the patch and opened the pull request. Could you help me get this reviewed, please?&lt;/p&gt;</comment>
                            <comment id="17885852" author="pnowojski" created="Mon, 30 Sep 2024 09:54:44 +0000"  >&lt;p&gt;Thanks for reporting and fixing the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=auroflow&quot; class=&quot;user-hover&quot; rel=&quot;auroflow&quot;&gt;auroflow&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Merged to master as 4fae64cb011&lt;br/&gt;
Merged to release-1.20 as c4dd2a6550a&lt;br/&gt;
Merged to release-1.19 as 98f1349bb4b&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1q614:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>