<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19557] Issue retrieving leader after zookeeper session reconnect</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19557</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We have noticed an issue with leaders being retrieved after reconnecting to zookeeper. The steps to reproduce this issue are to break the connection between a job manager that is not the leader and zookeeper. Wait for the session to be lost between the two. At this point, flink notifies for a loss of leader. After the loss of leader has occured, reconnect the job manager to zookeeper. At this point, the leader will still be the same as it was before, but when trying to access the rest API, you will see this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ curl -s localhost:8999/jobs
{&lt;span class=&quot;code-quote&quot;&gt;&quot;errors&quot;&lt;/span&gt;:[&lt;span class=&quot;code-quote&quot;&gt;&quot;Service temporarily unavailable due to an ongoing leader election. Please refresh.&quot;&lt;/span&gt;]}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I have been using `stress -t 60 -m 2048` (which spins up 2048 threads continuously alloc and freeing 256MB, to swap out the job manager and cause the connection loss.&lt;/p&gt;

&lt;p&gt;I have done some amount of digging on this. The ZooKeeperLeaderRetrievalService has this code block for handling state changes&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void handleStateChange(ConnectionState newState) {
		&lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (newState) {
			&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; CONNECTED:
				LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Connected to ZooKeeper quorum. Leader retrieval can start.&quot;&lt;/span&gt;);
				&lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
			&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; SUSPENDED:
				LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Connection to ZooKeeper suspended. Can no longer retrieve the leader from &quot;&lt;/span&gt; +
						&lt;span class=&quot;code-quote&quot;&gt;&quot;ZooKeeper.&quot;&lt;/span&gt;);
				&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (lock) {
					notifyLeaderLoss();
				}
				&lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
			&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; RECONNECTED:
				LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Connection to ZooKeeper was reconnected. Leader retrieval can be restarted.&quot;&lt;/span&gt;);
				&lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
			&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; LOST:
				LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Connection to ZooKeeper lost. Can no longer retrieve the leader from &quot;&lt;/span&gt; +
						&lt;span class=&quot;code-quote&quot;&gt;&quot;ZooKeeper.&quot;&lt;/span&gt;);
				&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (lock) {
					notifyLeaderLoss();
				}
				&lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It calls notifyLeaderLoss() when the connection is lost, but it doesn&apos;t do anything when the connection is reconnected. It appears that curator&apos;s NodeCache will retrieve the value of the leader znode after reconnect, but it won&apos;t notify the listeners if the value is the same as before the connection loss. So, unless a leader election happens after a zookeeper connection loss, the job managers that are not the leader will never know that there is a leader.&lt;/p&gt;

&lt;p&gt;The method that is called for NodeCache when a new value is retrieved&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void setNewData(ChildData newData) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException
    {
        ChildData   previousData = data.getAndSet(newData);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( !Objects.equal(previousData, newData) )
        {
            listeners.forEach(listener -&amp;gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
                {
                    listener.nodeChanged();
                }
                &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; ( Exception e )
                {
                    ThreadUtils.checkInterrupted(e);
                    log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Calling listener&quot;&lt;/span&gt;, e);
                }
            });

            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( rebuildTestExchanger != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; )
            {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
                {
                    rebuildTestExchanger.exchange(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;());
                }
                &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; ( InterruptedException e )
                {
                    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
                }
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;note the&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( !Objects.equal(previousData, newData) )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;seems to be preventing the job managers from getting the leader after a zookeeper connection loss.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13334673">FLINK-19557</key>
            <summary>Issue retrieving leader after zookeeper session reconnect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="maxmzkr">Max Mizikar</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 9 Oct 2020 15:41:20 +0000</created>
                <updated>Fri, 23 Oct 2020 12:52:08 +0000</updated>
                            <resolved>Fri, 23 Oct 2020 12:52:07 +0000</resolved>
                                    <version>1.10.2</version>
                    <version>1.11.2</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.10.3</fixVersion>
                    <fixVersion>1.11.3</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17217929" author="till.rohrmann" created="Tue, 20 Oct 2020 20:57:47 +0000"  >&lt;p&gt;Thanks for reporting this issue and analyzing it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maxmzkr&quot; class=&quot;user-hover&quot; rel=&quot;maxmzkr&quot;&gt;maxmzkr&lt;/a&gt;. I will take a look. Maybe we need to clear the leader data upon a connection suspension.&lt;/p&gt;</comment>
                            <comment id="17217944" author="till.rohrmann" created="Tue, 20 Oct 2020 21:21:21 +0000"  >&lt;p&gt;Hmm I see. The problem is the caching of the &lt;tt&gt;NodeCache&lt;/tt&gt;. So either we keep the last leader information in the &lt;tt&gt;ZooKeeperLeaderRetrievalService&lt;/tt&gt; and call &lt;tt&gt;leaderListener.notifyLeaderAddress&lt;/tt&gt; when we reconnect to ZooKeeper or we bind the lifecycle of a &lt;tt&gt;NodeCache&lt;/tt&gt; to the lifecycle of an established ZooKeeper connection. I guess the former should be easier. The downside of the first approach is that we might send a stale leader address to the listener.&lt;/p&gt;</comment>
                            <comment id="17218257" author="maxmzkr" created="Wed, 21 Oct 2020 12:11:10 +0000"  >&lt;p&gt;In our fork, we went with the second approach mostly because we didn&apos;t know what the ramifications of retrieving a stale leader would be. The second approach isn&apos;t super clean, however, because you have to completely close out the NodeCache and then open a new one. Both of the closing and opening can raise exceptions. The reconnect callback does&apos;t allow you to raise exceptions, so we had to add a big try catch. There&apos;s likely a case where we will still stall the leader election if we fail to open a new NodeCache but it&apos;s a smaller chance of stalling out. It&apos;s increased our stability a good amount now. (We&apos;re really good at swapping nodes out &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;</comment>
                            <comment id="17218264" author="till.rohrmann" created="Wed, 21 Oct 2020 12:30:39 +0000"  >&lt;p&gt;The stale leader address should get resolved as soon as a new leader arrives. Hence, I believe that this should work. I have opened a PR with change. Maybe you can take a look or try it out in your setup &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maxmzkr&quot; class=&quot;user-hover&quot; rel=&quot;maxmzkr&quot;&gt;maxmzkr&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17219661" author="till.rohrmann" created="Fri, 23 Oct 2020 12:52:08 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.12.0: 594e6c03aa2942dcfe7d9ab37edacaaebf3af556&lt;br/&gt;
1.11.3: 751d42ca4a9642f53cb68f4b315b1a2cd000a42f&lt;br/&gt;
1.10.3: 933041b3d8d192391437e343857f1dec14c544d1&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jkkw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>