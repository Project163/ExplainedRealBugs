<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:08:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-26064] KinesisFirehoseSinkITCase IllegalStateException: Trying to access closed classloader</title>
                <link>https://issues.apache.org/jira/browse/FLINK-26064</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=31044&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=ed165f3f-d0f6-524b-5279-86f8ee7d0e2d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=31044&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=ed165f3f-d0f6-524b-5279-86f8ee7d0e2d&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(shortened stack trace, as full is too large)&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Feb 09 20:05:04 java.util.concurrent.ExecutionException: software.amazon.awssdk.core.exception.SdkClientException: Unable to execute HTTP request: Trying to access closed classloader. Please check if you store classloaders directly or indirectly in static fields. If the stacktrace suggests that the leak occurs in a third party library and cannot be fixed immediately, you can disable this check with the configuration &apos;classloader.check-leaked-classloader&apos;.
Feb 09 20:05:04 	at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)
Feb 09 20:05:04 	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1908)
(...)
Feb 09 20:05:04 Caused by: software.amazon.awssdk.core.exception.SdkClientException: Unable to execute HTTP request: Trying to access closed classloader. Please check if you store classloaders directly or indirectly in static fields. If the stacktrace suggests that the leak occurs in a third party library and cannot be fixed immediately, you can disable this check with the configuration &apos;classloader.check-leaked-classloader&apos;.
Feb 09 20:05:04 	at software.amazon.awssdk.core.exception.SdkClientException$BuilderImpl.build(SdkClientException.java:98)
Feb 09 20:05:04 	at software.amazon.awssdk.core.exception.SdkClientException.create(SdkClientException.java:43)
Feb 09 20:05:04 	at software.amazon.awssdk.core.internal.http.pipeline.stages.utils.RetryableStageHelper.setLastException(RetryableStageHelper.java:204)
Feb 09 20:05:04 	at software.amazon.awssdk.core.internal.http.pipeline.stages.utils.RetryableStageHelper.setLastException(RetryableStageHelper.java:200)
Feb 09 20:05:04 	at software.amazon.awssdk.core.internal.http.pipeline.stages.AsyncRetryableStage$RetryingExecutor.maybeRetryExecute(AsyncRetryableStage.java:179)
Feb 09 20:05:04 	at software.amazon.awssdk.core.internal.http.pipeline.stages.AsyncRetryableStage$RetryingExecutor.lambda$attemptExecute$1(AsyncRetryableStage.java:159)
(...)
Feb 09 20:05:04 Caused by: java.lang.IllegalStateException: Trying to access closed classloader. Please check if you store classloaders directly or indirectly in static fields. If the stacktrace suggests that the leak occurs in a third party library and cannot be fixed immediately, you can disable this check with the configuration &apos;classloader.check-leaked-classloader&apos;.
Feb 09 20:05:04 	at org.apache.flink.runtime.execution.librarycache.FlinkUserCodeClassLoaders$SafetyNetWrapperClassLoader.ensureInner(FlinkUserCodeClassLoaders.java:164)
Feb 09 20:05:04 	at org.apache.flink.runtime.execution.librarycache.FlinkUserCodeClassLoaders$SafetyNetWrapperClassLoader.getResources(FlinkUserCodeClassLoaders.java:188)
Feb 09 20:05:04 	at java.util.ServiceLoader$LazyIterator.hasNextService(ServiceLoader.java:348)
Feb 09 20:05:04 	at java.util.ServiceLoader$LazyIterator.hasNext(ServiceLoader.java:393)
Feb 09 20:05:04 	at java.util.ServiceLoader$1.hasNext(ServiceLoader.java:474)
Feb 09 20:05:04 	at javax.xml.stream.FactoryFinder$1.run(FactoryFinder.java:352)
Feb 09 20:05:04 	at java.security.AccessController.doPrivileged(Native Method)
Feb 09 20:05:04 	at javax.xml.stream.FactoryFinder.findServiceProvider(FactoryFinder.java:341)
Feb 09 20:05:04 	at javax.xml.stream.FactoryFinder.find(FactoryFinder.java:313)
Feb 09 20:05:04 	at javax.xml.stream.FactoryFinder.find(FactoryFinder.java:227)
Feb 09 20:05:04 	at javax.xml.stream.XMLInputFactory.newInstance(XMLInputFactory.java:154)
Feb 09 20:05:04 	at software.amazon.awssdk.protocols.query.unmarshall.XmlDomParser.createXmlInputFactory(XmlDomParser.java:124)
Feb 09 20:05:04 	at java.lang.ThreadLocal$SuppliedThreadLocal.initialValue(ThreadLocal.java:284)
Feb 09 20:05:04 	at java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:180)
Feb 09 20:05:04 	at java.lang.ThreadLocal.get(ThreadLocal.java:170)
(...)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13427587">FLINK-26064</key>
            <summary>KinesisFirehoseSinkITCase IllegalStateException: Trying to access closed classloader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="CrynetLogistics">Zichen Liu</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 9 Feb 2022 20:49:48 +0000</created>
                <updated>Sun, 30 Mar 2025 06:28:54 +0000</updated>
                            <resolved>Mon, 21 Feb 2022 15:34:08 +0000</resolved>
                                                    <fixVersion>1.15.0</fixVersion>
                                    <component>Connectors / Kinesis</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17489992" author="gaoyunhaii" created="Thu, 10 Feb 2022 07:22:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=30979&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=ed165f3f-d0f6-524b-5279-86f8ee7d0e2d&amp;amp;l=44192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=30979&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=ed165f3f-d0f6-524b-5279-86f8ee7d0e2d&amp;amp;l=44192&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17489998" author="gaoyunhaii" created="Thu, 10 Feb 2022 07:31:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=31012&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=ed165f3f-d0f6-524b-5279-86f8ee7d0e2d&amp;amp;l=43799&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=31012&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=ed165f3f-d0f6-524b-5279-86f8ee7d0e2d&amp;amp;l=43799&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17490000" author="gaoyunhaii" created="Thu, 10 Feb 2022 07:35:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=31035&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=ed165f3f-d0f6-524b-5279-86f8ee7d0e2d&amp;amp;l=44189&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=31035&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=ed165f3f-d0f6-524b-5279-86f8ee7d0e2d&amp;amp;l=44189&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17490010" author="dannycranmer" created="Thu, 10 Feb 2022 07:54:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=CrynetLogistics&quot; class=&quot;user-hover&quot; rel=&quot;CrynetLogistics&quot;&gt;CrynetLogistics&lt;/a&gt; is working on this test failure. &lt;/p&gt;</comment>
                            <comment id="17490388" author="mapohl" created="Thu, 10 Feb 2022 17:16:53 +0000"  >&lt;p&gt;This test is temporarily disabled on &lt;tt&gt;master&lt;/tt&gt;: &lt;a href=&quot;https://github.com/apache/flink/commit/6b17d319c4cfa37027e3ccfb00d742d52b2d794d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;6b17d319c4cfa37027e3ccfb00d742d52b2d794d&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17490456" author="davidmoravek" created="Thu, 10 Feb 2022 19:18:01 +0000"  >&lt;p&gt;There is actually not a problem with reusing http clients, it just makes the root cause more visible for some reason.&lt;/p&gt;

&lt;p&gt;The actual problem is that if the underlying netty event loop group is not configured, the SharedSdkEventLoopGroup is used. This means that clients that are used by the test suite and clients that are used by the actual pipeline are using the very same thread pool for handling HTTP communication.&lt;/p&gt;

&lt;p&gt;By default the thread pool uses quite high number of threads (I think something like 2x number of CPUs, but would have to dive into Netty to confirm this).&lt;/p&gt;

&lt;p&gt;Now the problem is that the Netty thread inherits a context classloader from the thread that has created it. This could either be the main thread (if thread has been created in the test suite) or FlinkUserClassLoader (if the thread has been created by the pipeline - in taskmanager).&lt;/p&gt;

&lt;p&gt;There is a slight chance, that once the pipeline finishes (and user classloader is closed), we&apos;ll initiate a call on thread that has been created with this classloader attached.&lt;/p&gt;

&lt;p&gt;That has couple of consequences:&lt;/p&gt;

&lt;p&gt;    It will simply fail.&lt;br/&gt;
    If two jobs are running on the same TM and both are using AWS related clients, they will also eventually fail.&lt;/p&gt;

&lt;p&gt;The fix if fairly simple, we need to set separate event loops for tests and for each sink executed by the TM (we can eventually try to find a way to reuse ELG within the TM -&amp;gt; some kind of reference counting scoped per job, if that causes too much overhead).&lt;/p&gt;

&lt;p&gt;The proper place for fix would be AWSGeneralUtil#createAsyncHttpClient(software.amazon.awssdk.utils.AttributeMap, software.amazon.awssdk.http.nio.netty.NettyNioAsyncHttpClient.Builder).&lt;/p&gt;</comment>
                            <comment id="17495587" author="dannycranmer" created="Mon, 21 Feb 2022 15:34:02 +0000"  >&lt;p&gt;Test is fixed, working on the root cause in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-26256&quot; title=&quot;AWS SDK Async Event Loop Group Classloader Issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-26256&quot;&gt;&lt;del&gt;FLINK-26256&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13426379">FLINK-25945</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13429363">FLINK-26256</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0zfa0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>