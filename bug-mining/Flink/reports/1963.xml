<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7728] StatusWatermarkValve has different min watermark advancement behavior depending on the ordering inputs become idle</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7728</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently, once all inputs of a &lt;tt&gt;StatusWatermarkValve&lt;/tt&gt; becomes idle, we only emit the &lt;tt&gt;StreamStatus.IDLE&lt;/tt&gt; marker, and check nothing else. This makes the watermark advancement behavior inconsistent in the case that all inputs become idle, depending on the order that they become idle.&lt;/p&gt;

&lt;p&gt;Consider the following setup:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Channel #1: Watermark 10, ACTIVE
Channel #2: Watermark 5, ACTIVE
Channel #3: Watermark 5, ACTIVE
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If the channels become IDLE with the order #2 -&amp;gt; #3 -&amp;gt; #1, watermark 10 will be emitted as the new min watermark once both #2 and #3 becomes idle.&lt;br/&gt;
On the other hand, if the order is #1 -&amp;gt; #2 -&amp;gt; #3, watermark 10 will not be emitted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13105739">FLINK-7728</key>
            <summary>StatusWatermarkValve has different min watermark advancement behavior depending on the ordering inputs become idle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tzulitai">Tzu-Li (Gordon) Tai</assignee>
                                    <reporter username="tzulitai">Tzu-Li (Gordon) Tai</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Sep 2017 12:34:05 +0000</created>
                <updated>Mon, 12 Mar 2018 15:24:41 +0000</updated>
                            <resolved>Mon, 12 Mar 2018 15:24:41 +0000</resolved>
                                    <version>1.2.1</version>
                    <version>1.3.2</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.3.4</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16185574" author="githubbot" created="Fri, 29 Sep 2017 09:34:55 +0000"  >&lt;p&gt;GitHub user tzulitai opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4747&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4747&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7728&quot; title=&quot;StatusWatermarkValve has different min watermark advancement behavior depending on the ordering inputs become idle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7728&quot;&gt;&lt;del&gt;FLINK-7728&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream&amp;#93;&lt;/span&gt; Flush StatusWatermarkValve once all inputs become idle &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR is based on #4738. Only the last three commits are relevant.&lt;/p&gt;

&lt;p&gt;    Prior to this PR, once all inputs of the `StatusWatermarkValve` becomes idle, we only emit the `StreamStatus.IDLE marker`, and check nothing else. This makes the watermark advancement behaviour inconsistent in the case that all inputs become idle, depending on the order that they become idle.&lt;/p&gt;

&lt;p&gt;    This PR fixes this by &quot;flushing&quot; the max watermark across all channels once all inputs become idle. At a high-level, what this means for downstream operators is that all inputs have become idle and will temporarily cease to advance their watermarks, so they can safely advance their event time to whatever the largest watermark is.&lt;/p&gt;

&lt;p&gt;    This PR also includes changes to `StatusWatermarkValveTest` to cover the above mentioned case, as well as reworking the unit tests to be more fine-grained with small enough test case scope, so that we have a better overview of what cases are covered.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;d11d98d preliminary cleanup of `StatusWatermarkValveTest#BufferedValveOutputHandler`. Previous implementation was overly complex and could not provide test behaviors that we required.&lt;/li&gt;
	&lt;li&gt;0e386da main change for this PR. Includes a new test in `StatusWatermarkValve` to cover the missing case. That test does not pass without this change.&lt;/li&gt;
	&lt;li&gt;b977c18 refactor unit tests to be more fine-grained scoped.&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    `StatusWatermarkValveTest`, `OneInputStreamTaskTest`, `TwoInputStreamTaskTest` should be able to verify this change.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): *&lt;b&gt;YES&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? n/a&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tzulitai/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tzulitai/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7728&quot; title=&quot;StatusWatermarkValve has different min watermark advancement behavior depending on the ordering inputs become idle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7728&quot;&gt;&lt;del&gt;FLINK-7728&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4747.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4747.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4747&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit a9ce90aaee99374513941270b804de2f5564c47e&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-09-27T18:05:21Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7721&quot; title=&quot;StatusWatermarkValve should output a new min watermark only if it was aggregated from aligned chhanels&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7721&quot;&gt;&lt;del&gt;FLINK-7721&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream&amp;#93;&lt;/span&gt; Only emit new min watermark iff it was aggregated from watermark-aligned inputs&lt;/p&gt;

&lt;p&gt;    Prior to this commit, In the calculation of the new min watermark in&lt;br/&gt;
    StatusWatermarkValve#findAndOutputNewMinWatermarkAcrossAlignedChannels(),&lt;br/&gt;
    there is no verification that the calculated new min watermark&lt;br/&gt;
    really is aggregated from some aligned channel.&lt;/p&gt;

&lt;p&gt;    In the corner case where all input channels are currently not aligned&lt;br/&gt;
    but actually some are active, we would then incorrectly determine that&lt;br/&gt;
    the final aggregation is Long.MAX_VALUE and emit that.&lt;/p&gt;

&lt;p&gt;    This commit fixes this by only emitting the aggregated watermark iff it was&lt;br/&gt;
    really calculated from some aligned input channel (as well as the&lt;br/&gt;
    already existing constraint that it needs to be larger than the last&lt;br/&gt;
    emitted watermark). This change should also safely cover the case that a&lt;br/&gt;
    Long.MAX_VALUE was genuinely aggregated from the input channels.&lt;/p&gt;

&lt;p&gt;commit d11d98dda4723760e7d9fb3b9680a1e9daca3705&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-09-28T12:11:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7728&quot; title=&quot;StatusWatermarkValve has different min watermark advancement behavior depending on the ordering inputs become idle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7728&quot;&gt;&lt;del&gt;FLINK-7728&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream&amp;#93;&lt;/span&gt; Simplify BufferedValveOutputHandler used in StatusWatermarkValveTest&lt;/p&gt;

&lt;p&gt;    The previous implementation was overly complicated. Having separate&lt;br/&gt;
    buffers for the StreamStatus and Watermarks is not required for our&lt;br/&gt;
    tests. Also, that design doesn&apos;t allow checking the order StreamStatus /&lt;br/&gt;
    Watermarks are emitted from a single input to the valve.&lt;/p&gt;

&lt;p&gt;    This commit reworks it by buffering both StreamStatus and Watermarks in&lt;br/&gt;
    a shared queue.&lt;/p&gt;

&lt;p&gt;commit 0e386dab2fc19df78276ce203ed8f38792145759&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-09-28T14:49:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7728&quot; title=&quot;StatusWatermarkValve has different min watermark advancement behavior depending on the ordering inputs become idle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7728&quot;&gt;&lt;del&gt;FLINK-7728&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream&amp;#93;&lt;/span&gt; Flush max watermark across all inputs once all become idle&lt;/p&gt;

&lt;p&gt;    Prior to this commit, once all inputs of the StatusWatermarkValve&lt;br/&gt;
    becomes idle, we only emit the StreamStatus.IDLE marker, and check&lt;br/&gt;
    nothing else. This makes the watermark advancement behaviour&lt;br/&gt;
    inconsistent in the case that all inputs become idle depending on the&lt;br/&gt;
    order that they become idle.&lt;/p&gt;

&lt;p&gt;    This commit fixes this by &quot;flushing&quot; the max watermark across all&lt;br/&gt;
    channels once all inputs become idle. At a high-level, what this means&lt;br/&gt;
    for downstream operators is that all inputs have become idle and will&lt;br/&gt;
    temporariliy cease to advance their watermarks, so they can safely&lt;br/&gt;
    advance their event time to whatever the largest watermark is.&lt;/p&gt;

&lt;p&gt;commit b977c18c802fcb0060b47d7079bf214da7e764bb&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-09-29T09:16:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7728&quot; title=&quot;StatusWatermarkValve has different min watermark advancement behavior depending on the ordering inputs become idle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7728&quot;&gt;&lt;del&gt;FLINK-7728&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream&amp;#93;&lt;/span&gt; Make StatusWatermarkValve unit tests more fine-grained&lt;/p&gt;

&lt;p&gt;    Previously, the unit tests in StatusWatermarkValveTest were too&lt;br/&gt;
    cluttered and testing too many behaviours in a single test. This makes&lt;br/&gt;
    it hard to have a good overview of what test cases are covered.&lt;/p&gt;

&lt;p&gt;    This commit is a rework of the previous tests, making them more&lt;br/&gt;
    fine-grained so that the scope of each test is small enough. All&lt;br/&gt;
    previously tested behaviours are still covered.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16187842" author="githubbot" created="Mon, 2 Oct 2017 10:33:11 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4747&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4747&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This looks very good, the test is also much cleaner and understandable now. &#128076; &lt;/p&gt;

&lt;p&gt;    One thing, in the refactoring the bit of testing code that verifies the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7721&quot; title=&quot;StatusWatermarkValve should output a new min watermark only if it was aggregated from aligned chhanels&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7721&quot;&gt;&lt;del&gt;FLINK-7721&lt;/del&gt;&lt;/a&gt; was dropped (I checked this by commenting out the fix in the code). I&apos;ll re-add a test for that and merge.&lt;/p&gt;</comment>
                            <comment id="16188218" author="aljoscha" created="Mon, 2 Oct 2017 14:47:44 +0000"  >&lt;p&gt;Fixed on master in &lt;br/&gt;
6481564cb581164a761444922ddfb4ad11a8ef55&lt;br/&gt;
f9b79662ef575580a841af36747618a29a3955d9&lt;br/&gt;
ea86a537e6db1606241c0b8afe03c0754176c85e&lt;/p&gt;</comment>
                            <comment id="16188230" author="aljoscha" created="Mon, 2 Oct 2017 14:55:18 +0000"  >&lt;p&gt;Fixed on release-1.3 in&lt;br/&gt;
4dcd9fba21eef157063d2d70b0e55869009f2954&lt;br/&gt;
2875260d067c1e6754a248b8e281516ad9b5a269&lt;br/&gt;
c528139c3c2b33ba7bd11df154ba204408713b02&lt;/p&gt;</comment>
                            <comment id="16188232" author="githubbot" created="Mon, 2 Oct 2017 14:55:51 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4747&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4747&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merged. &#128076; Could you please also close this PR?&lt;/p&gt;</comment>
                            <comment id="16194281" author="githubbot" created="Fri, 6 Oct 2017 08:19:59 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4747&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4747&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for merging @aljoscha. Closing this ..&lt;/p&gt;</comment>
                            <comment id="16194282" author="githubbot" created="Fri, 6 Oct 2017 08:20:00 +0000"  >&lt;p&gt;Github user tzulitai closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4747&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4747&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3knuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>