<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:11:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-27031] ChangelogRescalingITCase.test failed due to IllegalStateException</title>
                <link>https://issues.apache.org/jira/browse/FLINK-27031</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=923&amp;amp;view=logs&amp;amp;j=cc649950-03e9-5fae-8326-2f1ad744b536&amp;amp;t=a9a20597-291c-5240-9913-a731d46d6dd1&amp;amp;l=12961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This build&lt;/a&gt; failed in &lt;tt&gt;ChangelogRescalingITCase.test&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Apr 01 20:26:53 Caused by: java.lang.IllegalArgumentException: Key group 94 is not in KeyGroupRange{startKeyGroup=96, endKeyGroup=127}. Unless you&apos;re directly using low level state access APIs, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is most likely caused by non-deterministic shuffle key (hashCode and equals implementation).
Apr 01 20:26:53 	at org.apache.flink.runtime.state.KeyGroupRangeOffsets.newIllegalKeyGroupException(KeyGroupRangeOffsets.java:37)
Apr 01 20:26:53 	at org.apache.flink.runtime.state.heap.StateTable.getMapForKeyGroup(StateTable.java:305)
Apr 01 20:26:53 	at org.apache.flink.runtime.state.heap.StateTable.get(StateTable.java:261)
Apr 01 20:26:53 	at org.apache.flink.runtime.state.heap.StateTable.get(StateTable.java:143)
Apr 01 20:26:53 	at org.apache.flink.runtime.state.heap.HeapListState.add(HeapListState.java:94)
Apr 01 20:26:53 	at org.apache.flink.state.changelog.ChangelogListState.add(ChangelogListState.java:78)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.operators.windowing.WindowOperator.processElement(WindowOperator.java:404)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.tasks.ChainingOutput.pushToOperator(ChainingOutput.java:99)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.tasks.ChainingOutput.collect(ChainingOutput.java:80)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.tasks.ChainingOutput.collect(ChainingOutput.java:39)
Apr 01 20:26:53 	at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:56)
Apr 01 20:26:53 	at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:29)
Apr 01 20:26:53 	at org.apache.flink.streaming.api.operators.StreamMap.processElement(StreamMap.java:38)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.tasks.OneInputStreamTask$StreamTaskNetworkOutput.emitRecord(OneInputStreamTask.java:233)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.io.AbstractStreamTaskNetworkInput.processElement(AbstractStreamTaskNetworkInput.java:134)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.io.AbstractStreamTaskNetworkInput.emitNext(AbstractStreamTaskNetworkInput.java:105)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:65)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:531)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:227)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:841)
Apr 01 20:26:53 	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:767)
Apr 01 20:26:53 	at org.apache.flink.runtime.taskmanager.Task.runWithSystemExitMonitoring(Task.java:948)
Apr 01 20:26:53 	at org.apache.flink.runtime.taskmanager.Task.restoreAndInvoke(Task.java:927)
Apr 01 20:26:53 	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:741)
Apr 01 20:26:53 	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:563)
Apr 01 20:26:53 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13437493">FLINK-27031</key>
            <summary>ChangelogRescalingITCase.test failed due to IllegalStateException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akalashnikov">Anton Kalashnikov</assignee>
                                    <reporter username="mapohl">Matthias Pohl</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 3 Apr 2022 09:02:46 +0000</created>
                <updated>Fri, 12 May 2023 11:14:32 +0000</updated>
                            <resolved>Thu, 30 Jun 2022 12:09:24 +0000</resolved>
                                    <version>1.15.0</version>
                    <version>1.16.0</version>
                                    <fixVersion>1.16.0</fixVersion>
                    <fixVersion>1.15.2</fixVersion>
                                    <component>Runtime / Network</component>
                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17516478" author="mapohl" created="Sun, 3 Apr 2022 09:04:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt;&#160; may you have a look&lt;/p&gt;</comment>
                            <comment id="17516661" author="roman_khachatryan" created="Mon, 4 Apr 2022 07:36:30 +0000"  >&lt;p&gt;Sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;, I&apos;ll take a look.&lt;/p&gt;</comment>
                            <comment id="17516867" author="roman_khachatryan" created="Mon, 4 Apr 2022 14:42:14 +0000"  >&lt;p&gt;The test fails reliably when rescaling from 1 to 3 or higher DoP, ~6 runs out of 10.  ACCUMULATE_TIME_MILLIS doesn&apos;t affect it and can be zero.&lt;/p&gt;

&lt;p&gt;Furthermore, it only fails when both Changelog and Unaligned checkpoints are enabled.&lt;/p&gt;

&lt;p&gt;While debugging, I can see that:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the problematic record comes from ResultSubpartition state&lt;/li&gt;
	&lt;li&gt;according to its key, it should be assigned to subtask 1 or 2&lt;/li&gt;
	&lt;li&gt;it is produced by upstream 0 and  consumed by downstream 0 (the downstream should filter it out)&lt;/li&gt;
	&lt;li&gt;however, the downstream 0 doesn&apos;t setup Virtual Channels that could filter the record; when it does, the test passes&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I didn&apos;t look further why Virtual Channels aren&apos;t being setup.&lt;/p&gt;

&lt;p&gt;From the above, the failure seems to be caused by Unaligned checkpoints rather than changelog.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; could you please take a look?&lt;/p&gt;</comment>
                            <comment id="17519687" author="roman_khachatryan" created="Fri, 8 Apr 2022 16:30:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/khachatryanroman/flink/_build/results?buildId=1548&amp;amp;view=logs&amp;amp;j=cc649950-03e9-5fae-8326-2f1ad744b536&amp;amp;t=a9a20597-291c-5240-9913-a731d46d6dd1&amp;amp;l=41041&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/khachatryanroman/flink/_build/results?buildId=1548&amp;amp;view=logs&amp;amp;j=cc649950-03e9-5fae-8326-2f1ad744b536&amp;amp;t=a9a20597-291c-5240-9913-a731d46d6dd1&amp;amp;l=41041&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17520361" author="gaoyunhaii" created="Mon, 11 Apr 2022 07:33:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=34494&amp;amp;view=logs&amp;amp;j=39d5b1d5-3b41-54dc-6458-1e2ddd1cdcf3&amp;amp;t=0c010d0c-3dec-5bf1-d408-7b18988b1b2b&amp;amp;l=5380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=34494&amp;amp;view=logs&amp;amp;j=39d5b1d5-3b41-54dc-6458-1e2ddd1cdcf3&amp;amp;t=0c010d0c-3dec-5bf1-d408-7b18988b1b2b&amp;amp;l=5380&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17539477" author="akalashnikov" created="Thu, 19 May 2022 11:24:32 +0000"  >&lt;p&gt;As I can see we setup Virtual Channels inside `StreamTaskNetworkInputFactory#create` when `InflightDataRescalingDescriptor` is not equal to &apos;NO_RESCALE&apos;. It happens only if the subtask receives the &apos;JobManagerTaskRestore&apos;(see &apos;TaskStateManagerImpl#getInputRescalingDescriptor&apos;).  So if the subtask doesn&apos;t receive  &apos;JobManagerTaskRestore&apos; but it receives the old state which should be filtered then we have an error described in this ticket. &lt;br/&gt;
As I understand, It is only possible when the subtask doesn&apos;t have any states for restoring, but this task&apos;s upstream has output channel states. According to current logic(see last &apos;for&apos; in &apos;StateAssignmentOperation#assignStates&apos;), we assign states only based on states of current subtask and ignore its upstream states which actually leads to the described problem. &lt;br/&gt;
So I think we can expand the condition for assigning the states by including upstream output channel states check.(which I have done in &lt;a href=&quot;https://github.com/apache/flink/pull/19702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/19702&lt;/a&gt;).  Or we can think of another fix that should somehow notify the subtask about creating the Virtual Channels. &lt;/p&gt;</comment>
                            <comment id="17561010" author="roman_khachatryan" created="Thu, 30 Jun 2022 12:09:24 +0000"  >&lt;p&gt;Merged as d98a34be120c1906dc3f01e9c48ab847a75b5822 (master),&lt;br/&gt;
012a3602a9188b9d4b147ec8779aab5f1349a2dd (1.15)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13534378">FLINK-31963</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z113q8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>