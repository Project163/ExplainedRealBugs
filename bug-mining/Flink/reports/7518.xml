<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:20:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-35351] Restore from unaligned checkpoints with a custom partitioner fails.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-35351</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We encountered a problem when using a custom partitioner with unaligned checkpoints. The bug reproduces under the following steps:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Run a job with graph: Source&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;-&amp;gt;Sink&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;, the custom partitioner applied after the Source task.&lt;/li&gt;
	&lt;li&gt;Make a checkpoint.&lt;/li&gt;
	&lt;li&gt;Restore from the checkpoint with a different source parallelism: Source&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;-&amp;gt;Sink&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;.&lt;/li&gt;
	&lt;li&gt;An exception is thrown.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This issue does not occur when restoring with the same parallelism or when changing the Sink parallelism. The exception only occurs when the parallelism of the Source is changed while the Sink parallelism remains the same.&lt;/p&gt;

&lt;p&gt;See the exception below and the test code at the end.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[db13789c52b80aad852c53a0afa26247] Task [Sink: sink (3/3)#0] WARN &#160;Sink: sink (3/3)#0 (be1d158c2e77fc9ed9e3e5d9a8431dc2_0a448493b4782967b150582570326227_2_0) switched from RUNNING to FAILED with failure cause:
java.io.IOException: Can&apos;t get next record &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; channel InputChannelInfo{gateIdx=0, inputChannelIdx=0}
&#160; &#160; at org.apache.flink.streaming.runtime.io.AbstractStreamTaskNetworkInput.emitNext(AbstractStreamTaskNetworkInput.java:106) ~[classes/:?]
&#160; &#160; at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:65) ~[classes/:?]
&#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:600) ~[classes/:?]
&#160; &#160; at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:231) ~[classes/:?]
&#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:930) ~[classes/:?]
&#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:879) ~[classes/:?]
&#160; &#160; at org.apache.flink.runtime.taskmanager.Task.runWithSystemExitMonitoring(Task.java:960) ~[classes/:?]
&#160; &#160; at org.apache.flink.runtime.taskmanager.Task.restoreAndInvoke(Task.java:939) [classes/:?]
&#160; &#160; at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:753) [classes/:?]
&#160; &#160; at org.apache.flink.runtime.taskmanager.Task.run(Task.java:568) [classes/:?]
&#160; &#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [?:1.8.0_121]
Caused by: java.io.IOException: Corrupt stream, found tag: -1
&#160; &#160; at org.apache.flink.streaming.runtime.streamrecord.StreamElementSerializer.deserialize(StreamElementSerializer.java:222) ~[classes/:?]
&#160; &#160; at org.apache.flink.streaming.runtime.streamrecord.StreamElementSerializer.deserialize(StreamElementSerializer.java:44) ~[classes/:?]
&#160; &#160; at org.apache.flink.runtime.plugable.NonReusingDeserializationDelegate.read(NonReusingDeserializationDelegate.java:53) ~[classes/:?]
&#160; &#160; at org.apache.flink.runtime.io.network.api.serialization.NonSpanningWrapper.readInto(NonSpanningWrapper.java:337) ~[classes/:?]
&#160; &#160; at org.apache.flink.runtime.io.network.api.serialization.SpillingAdaptiveSpanningRecordDeserializer.readNonSpanningRecord(SpillingAdaptiveSpanningRecordDeserializer.java:128) ~[classes/:?]
&#160; &#160; at org.apache.flink.runtime.io.network.api.serialization.SpillingAdaptiveSpanningRecordDeserializer.readNextRecord(SpillingAdaptiveSpanningRecordDeserializer.java:103) ~[classes/:?]
&#160; &#160; at org.apache.flink.runtime.io.network.api.serialization.SpillingAdaptiveSpanningRecordDeserializer.getNextRecord(SpillingAdaptiveSpanningRecordDeserializer.java:93) ~[classes/:?]
&#160; &#160; at org.apache.flink.streaming.runtime.io.recovery.DemultiplexingRecordDeserializer$VirtualChannel.getNextRecord(DemultiplexingRecordDeserializer.java:79) ~[classes/:?]
&#160; &#160; at org.apache.flink.streaming.runtime.io.recovery.DemultiplexingRecordDeserializer.getNextRecord(DemultiplexingRecordDeserializer.java:154) ~[classes/:?]
&#160; &#160; at org.apache.flink.streaming.runtime.io.recovery.DemultiplexingRecordDeserializer.getNextRecord(DemultiplexingRecordDeserializer.java:54) ~[classes/:?]
&#160; &#160; at org.apache.flink.streaming.runtime.io.AbstractStreamTaskNetworkInput.emitNext(AbstractStreamTaskNetworkInput.java:103) ~[classes/:?]
&#160; &#160; ... 10 more &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We discovered that this issue occurs due to an optimization in the &lt;a href=&quot;https://github.com/apache/flink/blame/master/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/StateAssignmentOperation.java#L424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;StateAssignmentOperation::reDistributeInputChannelStates&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inputState.getParallelism() == executionJobVertex.getParallelism()) {
&#160; &#160; &#160; &#160; &#160; &#160; stateAssignment.inputChannelStates.putAll(
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; toInstanceMap(stateAssignment.inputOperatorID, inputOperatorState));
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&#160; &#160; &#160; &#160; }
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At the moment of checkpointing, some in-flight records could be partially sent. The Sink sub-task&apos;s input has one half of a record, and the Source sub-task&apos;s output has the second part of the record. When restoring in-flight data, all the records are sent from all Source sub-tasks to all Sink sub-tasks. However, due to the optimization mentioned above, some Sink sub-tasks might not have information about the beginnings of in-flight records.&lt;/p&gt;

&lt;p&gt;The proposed fix involves checking the situations when the optimization should not be applied:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; noNeedRescale = stateAssignment.executionJobVertex
        .getJobVertex()
        .getInputs()
        .stream()
        .map(JobEdge::getDownstreamSubtaskStateMapper)
        .anyMatch(m -&amp;gt; !m.equals(SubtaskStateMapper.FULL))
        &amp;amp;&amp;amp; stateAssignment.executionJobVertex
        .getInputs()
        .stream()
        .map(IntermediateResult::getProducer)
        .map(vertexAssignments::get)
        .anyMatch(taskStateAssignment -&amp;gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; oldParallelism =
                    stateAssignment.oldState.get(stateAssignment.inputOperatorID).getParallelism();
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; oldParallelism == taskStateAssignment.executionJobVertex.getParallelism();
        });
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inputState.getParallelism() == executionJobVertex.getParallelism() &amp;amp;&amp;amp; noNeedRescale) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Test for reproduce:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.flink.test.checkpointing;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.api.common.JobID;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.api.common.JobStatus;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.api.common.functions.Partitioner;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.configuration.Configuration;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.core.fs.Path;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.runtime.jobgraph.JobGraph;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.runtime.jobgraph.SavepointRestoreSettings;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.runtime.minicluster.MiniCluster;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.runtime.minicluster.MiniClusterConfiguration;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.streaming.api.environment.CheckpointConfig;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.streaming.api.functions.sink.SinkFunction;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.streaming.api.functions.source.ParallelSourceFunction;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flink.util.FileUtils;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.After;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Rule;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Test;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.rules.TemporaryFolder;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.File;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.apache.flink.streaming.api.environment.StreamExecutionEnvironment.createLocalEnvironmentWithWebUI;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.junit.Assert.fail;

&lt;span class=&quot;code-comment&quot;&gt;/** Integration test &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; performing rescale of unaligned checkpoint with custom partitioner. */&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;UnalignedCheckpointCustomRescaleITCase {

    @Rule
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TemporaryFolder tempFolder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TemporaryFolder();

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; File CHECKPOINT_FILE = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;src/test/resources/custom-checkpoint&quot;&lt;/span&gt;);

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void createCheckpoint() {
        runJob(2, 3, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    }

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void restoreFromCheckpoint() {
        runJob(1, 3, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    }

    @After
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void after() {
        tempFolder.delete();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void runJob(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; sourceParallelism, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; sinkParallelism, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; createCheckpoint) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (MiniCluster miniCluster = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MiniCluster(buildMiniClusterConfig())) {
            miniCluster.start();
            Configuration configuration = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration();
            StreamExecutionEnvironment env = createLocalEnvironmentWithWebUI(configuration);
            CheckpointConfig checkpointConfig = env.getCheckpointConfig();
            env.enableCheckpointing(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
            checkpointConfig.setForceUnalignedCheckpoints(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            checkpointConfig.enableUnalignedCheckpoints();
            checkpointConfig.setMaxConcurrentCheckpoints(1);
            checkpointConfig.setExternalizedCheckpointCleanup(CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION);
            checkpointConfig.setCheckpointStorage(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:&lt;span class=&quot;code-comment&quot;&gt;//&quot;&lt;/span&gt; + tempFolder.newFolder() + &lt;span class=&quot;code-quote&quot;&gt;&quot;/checkPoints&quot;&lt;/span&gt;);
&lt;/span&gt;            env
                    .addSource(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringsSource(createCheckpoint ? 10 : 0, sinkParallelism))
                    .name(&lt;span class=&quot;code-quote&quot;&gt;&quot;source&quot;&lt;/span&gt;)
                    .setParallelism(sourceParallelism)
                    .partitionCustom(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringPartitioner(), str -&amp;gt; str.split(&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;)[0])
                    .addSink(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringSink(createCheckpoint ? 16 : 100000))
                    .name(&lt;span class=&quot;code-quote&quot;&gt;&quot;sink&quot;&lt;/span&gt;)
                    .setParallelism(sinkParallelism);
            JobGraph job = env.getStreamGraph().getJobGraph();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!createCheckpoint) {
                job.setSavepointRestoreSettings(SavepointRestoreSettings.forPath(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:&lt;span class=&quot;code-comment&quot;&gt;//&quot;&lt;/span&gt; + CHECKPOINT_FILE.getAbsolutePath(), &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;));
&lt;/span&gt;            }
            JobID jobId = miniCluster.submitJob(job).get().getJobID();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (createCheckpoint) {
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!miniCluster.getJobStatus(jobId).get().equals(JobStatus.RUNNING)) {
                    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
                }
                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; savepointPath = miniCluster.triggerCheckpoint(jobId).get();
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;SAVE PATH &quot;&lt;/span&gt; + savepointPath);
                &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
                miniCluster.cancelJob(jobId);
                FileUtils.copy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(savepointPath), Path.fromLocalFile(CHECKPOINT_FILE), &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; count = 0;
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!miniCluster.getJobStatus(jobId).get().equals(JobStatus.RUNNING)) {
                    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
                    count++;
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (count &amp;gt; 10) {
                        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                    }
                }
                &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(10000);
                &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; fail = !miniCluster.getJobStatus(jobId).get().equals(JobStatus.RUNNING);
                miniCluster.cancelJob(jobId);
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fail) {
                    fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;Job fails&quot;&lt;/span&gt;);
                }
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(e);
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; MiniClusterConfiguration buildMiniClusterConfig() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MiniClusterConfiguration.Builder()
                .setNumTaskManagers(2)
                .setNumSlotsPerTaskManager(4)
                .build();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;StringsSource &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; ParallelSourceFunction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isCanceled;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; producePerPartition;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; partitionCount;

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; StringsSource(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; producePerPartition, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; partitionCount) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.producePerPartition = producePerPartition;
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.partitionCount = partitionCount;
        }

        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; buildString(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; partition, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index) {
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; longStr = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[3713]).replace(&lt;span class=&quot;code-quote&quot;&gt;&apos;\0&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;\uFFFF&apos;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; partition + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + index + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + longStr;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run(SourceContext&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; ctx) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; producePerPartition; i++) {
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; partition = 0; partition &amp;lt; partitionCount; partition++) {
                    ctx.collect(buildString(partition, i));
                }
            }
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!isCanceled) { &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000); }
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void cancel() { isCanceled = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;; }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;StringSink &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; SinkFunction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; consumeBeforeCheckpoint;
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; consumed = 0;

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; StringSink(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; consumeBeforeCheckpoint) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.consumeBeforeCheckpoint = consumeBeforeCheckpoint;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void invoke(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value, Context ctx) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
            consumed++;
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;--- CONSUMED --- &quot;&lt;/span&gt; + value.substring(0, 10));
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (consumed == consumeBeforeCheckpoint) {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;--- WAITING FOR CHECKPOINT START ---&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(4000);
            }
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;StringPartitioner &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Partitioner&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; {
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; partition(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numPartitions) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.parseInt(key) % numPartitions;
        }
    }
}
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13579198">FLINK-35351</key>
            <summary>Restore from unaligned checkpoints with a custom partitioner fails.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lda-dima">Dmitriy Linevich</assignee>
                                    <reporter username="lda-dima">Dmitriy Linevich</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 14 May 2024 08:06:11 +0000</created>
                <updated>Fri, 31 May 2024 08:02:01 +0000</updated>
                            <resolved>Fri, 31 May 2024 08:02:01 +0000</resolved>
                                                    <fixVersion>1.18.2</fixVersion>
                    <fixVersion>1.20.0</fixVersion>
                    <fixVersion>1.19.1</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17846222" author="lda-dima" created="Tue, 14 May 2024 08:47:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=MartijnVisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;MartijnVisser&lt;/a&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Please, assign me to this task&lt;/p&gt;</comment>
                            <comment id="17846231" author="pnowojski" created="Tue, 14 May 2024 09:07:43 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lda-dima&quot; class=&quot;user-hover&quot; rel=&quot;lda-dima&quot;&gt;lda-dima&lt;/a&gt;, thanks for reporting this issue and what looks like correct analysis. However I think the proposed solution goes in the wrong direction - we can not disallow rescaling, as that might prevent jobs from recovering in case of for example a loss of a TaskManager. Note that the problem probably happens due to the use of &quot; custom partitioner&quot; here. AFAIR unaligned checkpoints are (for most likely the exactly same reason that you discovered in this bug) enabled only for keyed exchanges. &lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-master/docs/ops/state/checkpointing_under_backpressure/#certain-data-distribution-patterns-are-not-checkpointed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Pointwise/broadcast connections with unaligned checkpoints are unsupported&lt;/a&gt;. There is somewhere in the codebase code, that checks whether for given partitioning unaligned checkpoints should be enabled or not. I would guess that custom partitioners are mishandled there?  &lt;/p&gt;

&lt;p&gt;Relevant code pointers:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;org.apache.flink.runtime.checkpoint.CheckpointOptions.AlignmentType#FORCED_ALIGNED&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;org.apache.flink.streaming.runtime.io.RecordWriterOutput#supportsUnalignedCheckpoints&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;org.apache.flink.streaming.api.graph.StreamGraphGenerator#shouldDisableUnalignedCheckpointing&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17846241" author="lda-dima" created="Tue, 14 May 2024 09:21:29 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;I am not suggesting to disallow rescaling, just that in our particular example we change parallelism only for source and do not change sink. If we change parallelism for both, there will be no problems with recovery.&lt;br/&gt;
I think the problem is not in the custom partitioner, but in SubtaskStateMapper.FULL.&lt;/p&gt;

&lt;p&gt;In the nearest future I will try to create a Pull Request, which will make the proposed solution clearer.&lt;/p&gt;</comment>
                            <comment id="17846869" author="pnowojski" created="Thu, 16 May 2024 08:31:11 +0000"  >&lt;p&gt;Thanks, after reading the PR indeed I understand this more &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17850957" author="pnowojski" created="Fri, 31 May 2024 08:02:01 +0000"  >&lt;p&gt;merged to master as ce0b61f376b and ce0b61f376b^&lt;br/&gt;
merged to release-1.19 as 551f4ae7dde and 551f4ae7dde^&lt;br/&gt;
merged to release-1.18 as 70f775e7ba1 and 70f775e7ba1^&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 23 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1p7js:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>