<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18070] Time attribute been materialized after sub graph optimize</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18070</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Hi, I want to use window aggregate after create temporary, and has multiple sinks. But throw exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: type mismatch:
ref:
TIME ATTRIBUTE(PROCTIME) NOT NULL
input:
TIMESTAMP(3) NOT NULL
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I look into the optimizer logic, there is comment at &lt;tt&gt;CommonSubGraphBasedOptimizer&lt;/tt&gt;:&lt;br/&gt;
&quot;1. In general, for multi-sinks users tend to use VIEW which is a natural common sub-graph.&quot;&lt;/p&gt;

&lt;p&gt;After sub graph optimize, time attribute from source have been convert to basic TIMESTAMP type according to &lt;tt&gt;FlinkRelTimeIndicatorProgram&lt;/tt&gt;. But my create view sql is simple query, I think didn&apos;t need to materialized time attribute in theory.&lt;/p&gt;

&lt;p&gt;Here is my code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// connector.type COLLECTION is &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; debug use
&lt;/span&gt;tableEnv.sqlUpdate(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE source (\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    `ts` AS PROCTIME(),\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    `order_type` INT\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;) WITH (\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    &lt;span class=&quot;code-quote&quot;&gt;&apos;connector.type&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;COLLECTION&apos;&lt;/span&gt;,\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    &lt;span class=&quot;code-quote&quot;&gt;&apos;format.type&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;json&apos;&lt;/span&gt;\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;)\n&quot;&lt;/span&gt;);
tableEnv.createTemporaryView(&lt;span class=&quot;code-quote&quot;&gt;&quot;source_view&quot;&lt;/span&gt;, tableEnv.sqlQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM source&quot;&lt;/span&gt;));
tableEnv.sqlUpdate(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE sink (\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    `result` BIGINT\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;) WITH (\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    &lt;span class=&quot;code-quote&quot;&gt;&apos;connector.type&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;COLLECTION&apos;&lt;/span&gt;,\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    &lt;span class=&quot;code-quote&quot;&gt;&apos;format.type&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;json&apos;&lt;/span&gt;\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;)\n&quot;&lt;/span&gt;);
tableEnv.sqlUpdate(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO sink \n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    COUNT(1)\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;FROM\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    `source_view`\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;WHERE\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;     `order_type` = 33\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;GROUP BY\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    TUMBLE(`ts`, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;5&apos;&lt;/span&gt; SECOND)\n&quot;&lt;/span&gt;);
tableEnv.sqlUpdate(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO sink \n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    COUNT(1)\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;FROM\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    `source_view`\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;WHERE\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;     `order_type` = 34\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;GROUP BY\n&quot;&lt;/span&gt; +
	&lt;span class=&quot;code-quote&quot;&gt;&quot;    TUMBLE(`ts`, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;5&apos;&lt;/span&gt; SECOND)\n&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</description>
                <environment></environment>
        <key id="13308955">FLINK-18070</key>
            <summary>Time attribute been materialized after sub graph optimize</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="liuyufei">YufeiLiu</assignee>
                                    <reporter username="liuyufei">YufeiLiu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 2 Jun 2020 13:21:12 +0000</created>
                <updated>Tue, 10 Nov 2020 07:23:35 +0000</updated>
                            <resolved>Tue, 10 Nov 2020 07:23:35 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17124713" author="libenchao" created="Wed, 3 Jun 2020 07:39:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liuyufei&quot; class=&quot;user-hover&quot; rel=&quot;liuyufei&quot;&gt;liuyufei&lt;/a&gt;&#160;Thanks for reporting this issue, I also verified this bug in master branch.&lt;/p&gt;

&lt;p&gt;And I&apos;ve took a deeper look into it, it&apos;s because we materialize the `proctime` field in middle block. CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Actually we suffers from this bug in our internal 1.9 branch.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17124735" author="jark" created="Wed, 3 Jun 2020 08:09:44 +0000"  >&lt;p&gt;Yes, I think this is a bug in CommonSubGraphBasedOptimizer.&lt;/p&gt;</comment>
                            <comment id="17124763" author="libenchao" created="Wed, 3 Jun 2020 08:39:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liuyufei&quot; class=&quot;user-hover&quot; rel=&quot;liuyufei&quot;&gt;liuyufei&lt;/a&gt;&#160;Do you want to contribute to this issue&#65311; If you don&apos;t have time, I can give a hand here.&lt;/p&gt;</comment>
                            <comment id="17124894" author="liuyufei" created="Wed, 3 Jun 2020 12:05:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=libenchao&quot; class=&quot;user-hover&quot; rel=&quot;libenchao&quot;&gt;libenchao&lt;/a&gt; Sure, I&apos;d love to contribute. Please assign this issue to me.&lt;/p&gt;</comment>
                            <comment id="17125587" author="liuyufei" created="Thu, 4 Jun 2020 06:40:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=libenchao&quot; class=&quot;user-hover&quot; rel=&quot;libenchao&quot;&gt;libenchao&lt;/a&gt; I feel uncertain about why we need &quot;&lt;em&gt;materialize remaining proctime indicators&lt;/em&gt;&quot; in &lt;tt&gt;RelTimeIndicatorConverter&lt;/tt&gt;, I only change &lt;tt&gt;needFinalTimeIndicatorConversion&lt;/tt&gt; to false skip follow materialize convert, seems the problem sloved and didn&apos;t see other affects.&lt;/p&gt;</comment>
                            <comment id="17125873" author="libenchao" created="Thu, 4 Jun 2020 12:18:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liuyufei&quot; class=&quot;user-hover&quot; rel=&quot;liuyufei&quot;&gt;liuyufei&lt;/a&gt;&#160;we need to materialize the proctime time if we need it in sink, that&apos;s why it exists.&#160;&lt;/p&gt;</comment>
                            <comment id="17125952" author="liuyufei" created="Thu, 4 Jun 2020 14:16:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=libenchao&quot; class=&quot;user-hover&quot; rel=&quot;libenchao&quot;&gt;libenchao&lt;/a&gt; &lt;br/&gt;
process time have already been materialized at begining of convert.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val converter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RelTimeIndicatorConverter(rexBuilder)
val convertedRoot = rootRel.accept(converter)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17126322" author="libenchao" created="Fri, 5 Jun 2020 02:53:39 +0000"  >&lt;p&gt;As you can see, we only convert the time attributes from the input of sink. Actually, the sink node can have it&apos;s time attributes too, that&apos;s why this line exists:&lt;/p&gt;

&lt;p&gt;```java&lt;/p&gt;

&lt;p&gt;// the LogicalSink is converted in RelTimeIndicatorConverter before&lt;br/&gt;
if (rootRel.isInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalLegacySink&amp;#93;&lt;/span&gt; || !needFinalTimeIndicatorConversion) &lt;/p&gt;
{
 return convertedRoot
}

&lt;p&gt;```&lt;/p&gt;

&lt;p&gt;I think the right way to fix this is to leverage the `needFinalTimeIndicatorConversion` variable in `RelTimeIndicatorConverter.convert`, it&apos;s always true for now. We need to&#160;differentiate the case whether current optimization block is a final block or an intermediate logical block.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17126599" author="liuyufei" created="Fri, 5 Jun 2020 09:50:20 +0000"  >&lt;p&gt;I still didn&apos;t get it, could you give me a example about this situation?&lt;/p&gt;

&lt;p&gt;Is a final block always a LogicSink? So if we don&apos;t need materialize processtime in intermediate block and LogicSink, it will always return convertedRoot directly. &lt;/p&gt;</comment>
                            <comment id="17138087" author="jark" created="Wed, 17 Jun 2020 04:05:11 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=godfreyhe&quot; class=&quot;user-hover&quot; rel=&quot;godfreyhe&quot;&gt;godfreyhe&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17138114" author="godfreyhe" created="Wed, 17 Jun 2020 05:28:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liuyufei&quot; class=&quot;user-hover&quot; rel=&quot;liuyufei&quot;&gt;liuyufei&lt;/a&gt; Thanks for reporting this. the simple approach to fix this is &lt;tt&gt;needFinalTimeIndicatorConversion&lt;/tt&gt; method should return the value of &lt;tt&gt;isSinkBlock&lt;/tt&gt; instead of &lt;tt&gt;true&lt;/tt&gt; in &lt;tt&gt;StreamCommonSubGraphBasedOptimizer&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="17138115" author="godfreyhe" created="Wed, 17 Jun 2020 05:31:19 +0000"  >&lt;p&gt;we need to materialize time attribute only in sink-block.&lt;/p&gt;</comment>
                            <comment id="17229027" author="godfreyhe" created="Tue, 10 Nov 2020 07:23:35 +0000"  >&lt;p&gt;master: &lt;a href=&quot;https://github.com/apache/flink/pull/13280&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/13280&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ffbc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>