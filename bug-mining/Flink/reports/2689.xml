<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10663] Closing StreamingFileSink can cause NPE</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10663</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;&lt;br/&gt;
If the sink is closed before it&apos;s state is initialized, an NPE is thrown.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Stacktrace&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException
	at org.apache.flink.streaming.api.functions.sink.filesystem.StreamingFileSink.close(StreamingFileSink.java:378)
	at org.apache.flink.api.common.functions.util.FunctionUtils.closeFunction(FunctionUtils.java:43)
	at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.dispose(AbstractUdfStreamOperator.java:117)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.disposeAllOperators(StreamTask.java:477)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:378)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:704)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Rev cb141940821bcf62f4102dfd5c76aff99d0c15d1&lt;/p&gt;</environment>
        <key id="13193785">FLINK-10663</key>
            <summary>Closing StreamingFileSink can cause NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gjy">Gary Yao</assignee>
                                    <reporter username="gjy">Gary Yao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 24 Oct 2018 08:34:15 +0000</created>
                <updated>Thu, 25 Oct 2018 11:57:59 +0000</updated>
                            <resolved>Thu, 25 Oct 2018 11:57:58 +0000</resolved>
                                    <version>1.6.1</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.6.3</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Connectors / Common</component>
                    <component>Connectors / FileSystem</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16662130" author="githubbot" created="Wed, 24 Oct 2018 11:10:32 +0000"  >&lt;p&gt;GJL opened a new pull request #6915: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10663&quot; title=&quot;Closing StreamingFileSink can cause NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10663&quot;&gt;&lt;del&gt;FLINK-10663&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Fix NPE when StreamingFileSink is closed without initialization.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6915&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6915&lt;/a&gt;&lt;/p&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   &lt;b&gt;There is a potential NPE in the StreamingFileSink. If you don&apos;t want the NPE, this PR should be merged.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;   cc: @kl0u &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Add null check to `StreamingFileSink#close()`.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change added tests and can be verified as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Added unit test to `LocalStreamingFileSinkTest`.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (*&lt;b&gt;yes&lt;/b&gt;* / no)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16662140" author="githubbot" created="Wed, 24 Oct 2018 11:21:54 +0000"  >&lt;p&gt;kl0u commented on a change in pull request #6915: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10663&quot; title=&quot;Closing StreamingFileSink can cause NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10663&quot;&gt;&lt;del&gt;FLINK-10663&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Fix NPE when StreamingFileSink is closed without initialization.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6915#discussion_r227746184&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6915#discussion_r227746184&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/filesystem/LocalStreamingFileSinkTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -59,6 +59,17 @@ public void testClosingWithoutInput() throws Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testClosingWithoutOpenShouldNotFail() throws Exception {&lt;br/&gt;
+		final File outDir = TEMP_FOLDER.newFolder();&lt;br/&gt;
+&lt;br/&gt;
+		try (OneInputStreamOperatorTestHarness&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;, Object&amp;gt; testHarness =&lt;br/&gt;
+				 TestUtils.createRescalingTestSink(outDir, 1, 0, 100L, 124L)&lt;br/&gt;
+		) &lt;/p&gt;
{
+			testHarness.setup();
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I would rename the test to `testClosingWithoutInitializingStateShouldNotFail ` and also I would not use `try-with-resource` but I would call `close()` explicitly so that the test is clearer.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16662141" author="githubbot" created="Wed, 24 Oct 2018 11:21:54 +0000"  >&lt;p&gt;kl0u commented on a change in pull request #6915: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10663&quot; title=&quot;Closing StreamingFileSink can cause NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10663&quot;&gt;&lt;del&gt;FLINK-10663&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Fix NPE when StreamingFileSink is closed without initialization.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6915#discussion_r227746375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6915#discussion_r227746375&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/StreamingFileSink.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -375,6 +375,8 @@ public void invoke(IN value, SinkFunction.Context context) throws Exception {&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public void close() throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;buckets.close();&lt;br/&gt;
+		if (buckets != null) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Here I would also add a comment to explain when this can be `null`. I know it is covered by a test, but it is nice to also explain the why.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16662158" author="githubbot" created="Wed, 24 Oct 2018 11:39:36 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6915: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10663&quot; title=&quot;Closing StreamingFileSink can cause NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10663&quot;&gt;&lt;del&gt;FLINK-10663&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Fix NPE when StreamingFileSink is closed without initialization.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6915#discussion_r227751210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6915#discussion_r227751210&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/filesystem/LocalStreamingFileSinkTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -59,6 +59,17 @@ public void testClosingWithoutInput() throws Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testClosingWithoutOpenShouldNotFail() throws Exception {&lt;br/&gt;
+		final File outDir = TEMP_FOLDER.newFolder();&lt;br/&gt;
+&lt;br/&gt;
+		try (OneInputStreamOperatorTestHarness&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;, Object&amp;gt; testHarness =&lt;br/&gt;
+				 TestUtils.createRescalingTestSink(outDir, 1, 0, 100L, 124L)&lt;br/&gt;
+		) &lt;/p&gt;
{
+			testHarness.setup();
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Renamed. I&apos;d keep `try-with-resource` to avoid potential problems with static code analyzers.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16662174" author="githubbot" created="Wed, 24 Oct 2018 11:50:44 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6915: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10663&quot; title=&quot;Closing StreamingFileSink can cause NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10663&quot;&gt;&lt;del&gt;FLINK-10663&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Fix NPE when StreamingFileSink is closed without initialization.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6915#discussion_r227754363&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6915#discussion_r227754363&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/StreamingFileSink.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -375,6 +375,8 @@ public void invoke(IN value, SinkFunction.Context context) throws Exception {&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public void close() throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;buckets.close();&lt;br/&gt;
+		if (buckets != null) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   `bucket` is non-final, and `Cmd + Alt + F7` shows there is only one assignment in `initializeState()`. One reason why `buckets` can be `null` is that `initializeState()` is not called at all. Another reason is that `initializeState()` exits prematurely due to exceptions. &lt;br/&gt;
   If there were more things to be closed, we would need more null checks, and I would not add a comment to every null check. Hence, I would also not add a comment when there is only a single null check. Imo a comment could be perceived as too verbose because the necessity of it is simple enough to understand.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16662175" author="githubbot" created="Wed, 24 Oct 2018 11:51:05 +0000"  >&lt;p&gt;GJL commented on issue #6915: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10663&quot; title=&quot;Closing StreamingFileSink can cause NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10663&quot;&gt;&lt;del&gt;FLINK-10663&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Fix NPE when StreamingFileSink is closed without initialization.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6915#issuecomment-432624343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6915#issuecomment-432624343&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for the review @kl0u. Merging as soon tests have passed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16662176" author="githubbot" created="Wed, 24 Oct 2018 11:51:49 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6915: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10663&quot; title=&quot;Closing StreamingFileSink can cause NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10663&quot;&gt;&lt;del&gt;FLINK-10663&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Fix NPE when StreamingFileSink is closed without initialization.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6915#discussion_r227754363&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6915#discussion_r227754363&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/StreamingFileSink.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -375,6 +375,8 @@ public void invoke(IN value, SinkFunction.Context context) throws Exception {&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public void close() throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;buckets.close();&lt;br/&gt;
+		if (buckets != null) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   `bucket` is non-final, and `Cmd + Alt + F7` shows there is only one assignment in `initializeState()`. One reason why `buckets` can be `null` is that `initializeState()` is not called at all. Another reason is that `initializeState()` exits prematurely due to exceptions. &lt;br/&gt;
   If there were more things to be closed, we would need more null checks, and I would not add a comment to every null check. Hence, I would also not add a comment when there is only a single null check. Imo a comment could be perceived as too verbose because the necessity of the check is simple enough to understand.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16663554" author="githubbot" created="Thu, 25 Oct 2018 10:29:26 +0000"  >&lt;p&gt;GJL closed pull request #6915: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10663&quot; title=&quot;Closing StreamingFileSink can cause NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10663&quot;&gt;&lt;del&gt;FLINK-10663&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Fix NPE when StreamingFileSink is closed without initialization.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6915&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6915&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/StreamingFileSink.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/StreamingFileSink.java&lt;br/&gt;
index 6c7e135caf8..6f57fee81f3 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/StreamingFileSink.java&lt;br/&gt;
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/StreamingFileSink.java&lt;br/&gt;
@@ -375,6 +375,8 @@ public void invoke(IN value, SinkFunction.Context context) throws Exception {&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public void close() throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;buckets.close();&lt;br/&gt;
+		if (buckets != null) 
{
+			buckets.close();
+		}
&lt;p&gt; 	}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/filesystem/LocalStreamingFileSinkTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/filesystem/LocalStreamingFileSinkTest.java&lt;br/&gt;
index ab487d168bc..8bb35ff244a 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/filesystem/LocalStreamingFileSinkTest.java&lt;br/&gt;
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/filesystem/LocalStreamingFileSinkTest.java&lt;br/&gt;
@@ -59,6 +59,16 @@ public void testClosingWithoutInput() throws Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testClosingWithoutInitializingStateShouldNotFail() throws Exception {&lt;br/&gt;
+		final File outDir = TEMP_FOLDER.newFolder();&lt;br/&gt;
+&lt;br/&gt;
+		try (OneInputStreamOperatorTestHarness&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;, Object&amp;gt; testHarness =&lt;br/&gt;
+					TestUtils.createRescalingTestSink(outDir, 1, 0, 100L, 124L)) &lt;/p&gt;
{
+			testHarness.setup();
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testTruncateAfterRecoveryAndOverwrite() throws Exception {&lt;br/&gt;
 		final File outDir = TEMP_FOLDER.newFolder();&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16663645" author="gjy" created="Thu, 25 Oct 2018 11:57:59 +0000"  >&lt;p&gt;1.6: 4e276415183e1fbfd855a4a946db7281b4715101&lt;br/&gt;
1.7: 5377c772d3c9f54cd2040ca67743cad128999f57&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13185546">FLINK-10357</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zkmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>