<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:08:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-25441] ProducerFailedException will cause task status switch from RUNNING to CANCELED, which will cause the job to hang.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-25441</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;ProducerFailedException&lt;/tt&gt; extends &lt;tt&gt;CancelTaskException&lt;/tt&gt;, which will cause the task status switched from RUNNING to CANCELED. As described in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17726&quot; title=&quot;Scheduler should take care of tasks directly canceled by TaskManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17726&quot;&gt;FLINK-17726&lt;/a&gt;, if a task is directly CANCELED by TaskManager due to its own runtime issue, the task will not be recovered by JM and thus the job would hang.&lt;/p&gt;

&lt;p&gt;Note that it will not cause problems before &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24182&quot; title=&quot;Tasks canceler should not immediately interrupt&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24182&quot;&gt;&lt;del&gt;FLINK-24182&lt;/del&gt;&lt;/a&gt; (it unifies the failureCause handling, changes the check of CancelTaskException from &quot;&lt;tt&gt;instanceof CancelTaskException&lt;/tt&gt;&quot; to &quot;&lt;tt&gt;ExceptionUtils.findThrowable&lt;/tt&gt;&quot;), because the &lt;tt&gt;ProducerFailedException&lt;/tt&gt; is always wrapped by &lt;tt&gt;RemoteTransportException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The example log is as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-12-23 21:20:14,965 DEBUG org.apache.flink.runtime.taskmanager.Task                    [] - MultipleInput[945] [Source: HiveSource-tpcds_bin_orc_10000.catalog_sales, Source: HiveSource-tpcds_bin_orc_10000.store_sales, Source: HiveSource-tpcds_bin_orc_10000.catalog_sales, Source: HiveSource-tpcds_bin_orc_10000.store_sales, Source: HiveSource-tpcds_bin_orc_10000.store_sales, Source: HiveSource-tpcds_bin_orc_10000.item, Source: HiveSource-tpcds_bin_orc_10000.web_sales, Source: HiveSource-tpcds_bin_orc_10000.web_sales] -&amp;amp;gt; Calc[885] (143/1024)#0 (8a883116ab601dd5b9ad5d2717d18918) switched from RUNNING to CANCELED due to CancelTaskException: org.apache.flink.runtime.io.network.netty.exception.RemoteTransportException: Error at remote task manager &lt;span class=&quot;code-quote&quot;&gt;&apos;k28b09250.eu95sqa.tbsite.net/100.69.96.154:47459&apos;&lt;/span&gt;.
  at org.apache.flink.runtime.io.network.netty.CreditBasedPartitionRequestClientHandler.decodeMsg(CreditBasedPartitionRequestClientHandler.java:301)
  at org.apache.flink.runtime.io.network.netty.CreditBasedPartitionRequestClientHandler.channelRead(CreditBasedPartitionRequestClientHandler.java:190)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)
  at org.apache.flink.runtime.io.network.netty.NettyMessageClientDecoderDelegate.channelRead(NettyMessageClientDecoderDelegate.java:112)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)
  at org.apache.flink.shaded.netty4.io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)
  at org.apache.flink.shaded.netty4.io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)
  at org.apache.flink.shaded.netty4.io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:795)
  at org.apache.flink.shaded.netty4.io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:480)
  at org.apache.flink.shaded.netty4.io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:378)
  at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)
  at org.apache.flink.shaded.netty4.io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)
Caused by: org.apache.flink.runtime.io.network.partition.ProducerFailedException: java.util.concurrent.TimeoutException: Buffer request timeout, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; means there is a fierce contention of the batch shuffle read memory, please increase &lt;span class=&quot;code-quote&quot;&gt;&apos;taskmanager.memory.framework.off-heap.batch-shuffle.size&apos;&lt;/span&gt;.
  at org.apache.flink.runtime.io.network.netty.PartitionRequestQueue.writeAndFlushNextMessageIfPossible(PartitionRequestQueue.java:285)
  at org.apache.flink.runtime.io.network.netty.PartitionRequestQueue.enqueueAvailableReader(PartitionRequestQueue.java:123)
  at org.apache.flink.runtime.io.network.netty.PartitionRequestQueue.userEventTriggered(PartitionRequestQueue.java:234)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:346)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:332)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.fireUserEventTriggered(AbstractChannelHandlerContext.java:324)
  at org.apache.flink.shaded.netty4.io.netty.channel.ChannelInboundHandlerAdapter.userEventTriggered(ChannelInboundHandlerAdapter.java:117)
  at org.apache.flink.shaded.netty4.io.netty.handler.codec.ByteToMessageDecoder.userEventTriggered(ByteToMessageDecoder.java:365)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:346)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:332)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.fireUserEventTriggered(AbstractChannelHandlerContext.java:324)
  at org.apache.flink.shaded.netty4.io.netty.channel.DefaultChannelPipeline$HeadContext.userEventTriggered(DefaultChannelPipeline.java:1428)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:346)
  at org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:332)
  at org.apache.flink.shaded.netty4.io.netty.channel.DefaultChannelPipeline.fireUserEventTriggered(DefaultChannelPipeline.java:913)
  at org.apache.flink.runtime.io.network.netty.PartitionRequestQueue.lambda$notifyReaderNonEmpty$0(PartitionRequestQueue.java:91)
  at org.apache.flink.shaded.netty4.io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:164)
  at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:472)
  at org.apache.flink.shaded.netty4.io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:384)
  at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)
  at org.apache.flink.shaded.netty4.io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:756)
Caused by: java.util.concurrent.TimeoutException: Buffer request timeout, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; means there is a fierce contention of the batch shuffle read memory, please increase &lt;span class=&quot;code-quote&quot;&gt;&apos;taskmanager.memory.framework.off-heap.batch-shuffle.size&apos;&lt;/span&gt;.
  at org.apache.flink.runtime.io.network.partition.SortMergeResultPartitionReadScheduler.allocateBuffers(SortMergeResultPartitionReadScheduler.java:168)
  at org.apache.flink.runtime.io.network.partition.SortMergeResultPartitionReadScheduler.run(SortMergeResultPartitionReadScheduler.java:139)
  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
  ... 1 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13419324">FLINK-25441</key>
            <summary>ProducerFailedException will cause task status switch from RUNNING to CANCELED, which will cause the job to hang.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wanglijie">Lijie Wang</assignee>
                                    <reporter username="wanglijie">Lijie Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 24 Dec 2021 08:27:36 +0000</created>
                <updated>Thu, 13 Jan 2022 14:08:10 +0000</updated>
                            <resolved>Thu, 13 Jan 2022 14:08:10 +0000</resolved>
                                    <version>1.15.0</version>
                                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17464930" author="wanglijie95" created="Fri, 24 Dec 2021 08:29:40 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17466466" author="pnowojski" created="Wed, 29 Dec 2021 14:02:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wanglijie95&quot; class=&quot;user-hover&quot; rel=&quot;wanglijie95&quot;&gt;wanglijie95&lt;/a&gt;, do you mean that &lt;a href=&quot;https://github.com/apache/flink/pull/17253/commits/43f4db7ade41eb0d5e052dcc81748d71740d540f#diff-b84174e55cb1999d99ad60cdeded7be20ff4978472bfc785c5a77b6270f47b56R799-R801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;exactly this change&lt;/a&gt; is causing the problems?&lt;/p&gt;

&lt;p&gt;It sounds to me like the logic there is correct. `ProducerFailedException` should be handled as `CancelTaskException`, as the downstream task is not the primary reason behind this failure. In principle I think&lt;/p&gt;

&lt;p&gt;&amp;gt; ProducerFailedException will cause task status switch from RUNNING to CANCELED&lt;/p&gt;

&lt;p&gt;is the correct thing to do. A better question would be why this error was not propagated up on the upstream task? It should be the upstream task&apos;s switch from `RUNNING` to `FAILED` trigger the job failover by JM. In other words, I think the bug here is that the &quot;java.util.concurrent.TimeoutException: Buffer request timeout, this means there is a fierce contention of the batch shuffle read memory, please increase &apos;taskmanager.memory.framework.off-heap.batch-shuffle.size&apos;.&quot; was not propagated on the upstream task. WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;?&lt;/p&gt;
</comment>
                            <comment id="17466662" author="wanglijie95" created="Thu, 30 Dec 2021 02:27:32 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;, thanks for your detailed&#160;explanation.&lt;/p&gt;

&lt;p&gt;&amp;gt; do you mean that &lt;a href=&quot;https://github.com/apache/flink/pull/17253/commits/43f4db7ade41eb0d5e052dcc81748d71740d540f#diff-b84174e55cb1999d99ad60cdeded7be20ff4978472bfc785c5a77b6270f47b56R799-R801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;exactly this change&lt;/a&gt; is causing the problems?&lt;/p&gt;

&lt;p&gt;Yes, I think that change exposes this problem, although it may not the root cause.&lt;/p&gt;

&lt;p&gt;&amp;gt; `ProducerFailedException` should be handled as `CancelTaskException`&lt;/p&gt;

&lt;p&gt;If so, I think the &quot;java.util.concurrent.TimeoutException: Buffer request timeout, this means there is a fierce contention of the batch shuffle read memory, please increase &apos;taskmanager.memory.framework.off-heap.batch-shuffle.size&apos;&quot; should probably be wrapped as&#160; &lt;tt&gt;PartitionException&lt;/tt&gt; instead of &lt;tt&gt;ProducerFailedException&lt;/tt&gt;, because the producer (upstream task) was FINISHED. (This problem appeared in batch jobs using sort shuffle). WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="17466731" author="pnowojski" created="Thu, 30 Dec 2021 08:31:00 +0000"  >&lt;p&gt;&amp;gt; because the producer (upstream task) was FINISHED. (This problem appeared in batch jobs using sort shuffle). &lt;/p&gt;

&lt;p&gt;If so, there shouldn&apos;t be any exception in the first place. In one way or another, the downstream task should reach `EndOfData`/``EndOfPartitionEvent` states cleanly.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wanglijie95&quot; class=&quot;user-hover&quot; rel=&quot;wanglijie95&quot;&gt;wanglijie95&lt;/a&gt; what is the scenario that&apos;s happening here? Upstream task finished before the downstream managed to start up? Was there any data produced, or was the partition empty?&lt;/p&gt;</comment>
                            <comment id="17466869" author="wanglijie95" created="Thu, 30 Dec 2021 13:23:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; what is the scenario that&apos;s happening here? Upstream task finished before the downstream managed to start up?&lt;/p&gt;

&lt;p&gt;For batch jobs, I think it&apos;s always the upstream tasks finished first, and then the downstream tasks are scheduled and started? And the partition gereratlly should not be empty because the upstream task is finished normally.&lt;/p&gt;</comment>
                            <comment id="17468394" author="kevin.cyj" created="Tue, 4 Jan 2022 06:59:32 +0000"  >&lt;p&gt;I guess for batch jobs, we should not throw ProducerFailedException. Maybe throwing the&#160;original root exception is better? An easy fix maybe moving the wrapping of ProducerFailedException from to PartitionRequestQueue to&#160;PipelinedSubpartitionView?&lt;/p&gt;</comment>
                            <comment id="17472719" author="pnowojski" created="Tue, 11 Jan 2022 13:32:44 +0000"  >&lt;p&gt;I think your suggestion &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; is the right thing to do. Indeed in this case the subpartition/subpartition view should be able to decide whether this is a primary or secondary failure. (secondary - i.e., upstream task is responsible for reporting the root cause). &lt;/p&gt;</comment>
                            <comment id="17474262" author="kevin.cyj" created="Wed, 12 Jan 2022 05:45:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wanglijie95&quot; class=&quot;user-hover&quot; rel=&quot;wanglijie95&quot;&gt;wanglijie95&lt;/a&gt; Would you prepare a fix for it?&lt;/p&gt;</comment>
                            <comment id="17474304" author="wanglijie95" created="Wed, 12 Jan 2022 07:13:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; I would, I will prepare a fix according your suggestion.&lt;/p&gt;</comment>
                            <comment id="17475388" author="pnowojski" created="Thu, 13 Jan 2022 14:08:10 +0000"  >&lt;p&gt;merged commit f957e3f into apache:master now&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0y0ig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>