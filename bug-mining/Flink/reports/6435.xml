<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:10:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-27247] ScalarOperatorGens.numericCasting is not compatible with legacy behavior</title>
                <link>https://issues.apache.org/jira/browse/FLINK-27247</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Add the following test cases in&#160;ScalarFunctionsTest:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;@Test
def test(): Unit ={
  testSqlApi(&lt;span class=&quot;code-quote&quot;&gt;&quot;rand(1) + 1&quot;&lt;/span&gt;,&quot;&quot;)
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;it will throw the following exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;org.apache.flink.table.planner.codegen.CodeGenException: Unsupported casting from DOUBLE to DOUBLE NOT NULL.
&#160; &#160; at org.apache.flink.table.planner.codegen.calls.ScalarOperatorGens$.numericCasting(ScalarOperatorGens.scala:1734)
&#160; &#160; at org.apache.flink.table.planner.codegen.calls.ScalarOperatorGens$.generateBinaryArithmeticOperator(ScalarOperatorGens.scala:85)
&#160; &#160; at org.apache.flink.table.planner.codegen.ExprCodeGenerator.generateCallExpression(ExprCodeGenerator.scala:507)
&#160; &#160; at org.apache.flink.table.planner.codegen.ExprCodeGenerator.visitCall(ExprCodeGenerator.scala:481)
&#160; &#160; at org.apache.flink.table.planner.codegen.ExprCodeGenerator.visitCall(ExprCodeGenerator.scala:57)
&#160; &#160; at org.apache.calcite.rex.RexCall.accept(RexCall.java:174)
&#160; &#160; at org.apache.flink.table.planner.codegen.ExprCodeGenerator.$anonfun$visitCall$1(ExprCodeGenerator.scala:478)
&#160; &#160; at scala.collection.TraversableLike.$anonfun$map$1(TraversableLike.scala:233)
&#160; &#160; at scala.collection.mutable.ResizableArray.foreach(ResizableArray.scala:58)
&#160; &#160; at scala.collection.mutable.ResizableArray.foreach$(ResizableArray.scala:51)
&#160; &#160; at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:47)
&#160; &#160; at scala.collection.TraversableLike.map(TraversableLike.scala:233)
&#160; &#160; at scala.collection.TraversableLike.map$(TraversableLike.scala:226)
&#160; &#160; at scala.collection.AbstractTraversable.map(Traversable.scala:104)
&#160; &#160; at org.apache.flink.table.planner.codegen.ExprCodeGenerator.visitCall(ExprCodeGenerator.scala:469)
... &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is because in&#160;ScalarOperatorGens#numericCasting, &#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24779&quot; title=&quot;Port Numeric casting logic to CastRule&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24779&quot;&gt;&lt;del&gt;FLINK-24779&lt;/del&gt;&lt;/a&gt;&#160; lost the logic that in some cases there is no need to casting the left and right type.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13439603">FLINK-27247</key>
            <summary>ScalarOperatorGens.numericCasting is not compatible with legacy behavior</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xuyangzhong">Xuyang Zhong</assignee>
                                    <reporter username="xuyangzhong">Xuyang Zhong</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 14 Apr 2022 08:06:01 +0000</created>
                <updated>Thu, 21 Apr 2022 06:15:47 +0000</updated>
                            <resolved>Thu, 21 Apr 2022 06:15:41 +0000</resolved>
                                                    <fixVersion>1.15.1</fixVersion>
                    <fixVersion>1.16.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17522146" author="xuyangzhong" created="Thu, 14 Apr 2022 08:10:15 +0000"  >&lt;p&gt;I&apos;ll try to fix it&lt;/p&gt;</comment>
                            <comment id="17522367" author="matriv" created="Thu, 14 Apr 2022 15:01:26 +0000"  >&lt;p&gt;Commented on the PR as well, I think we need to fix the root of the issue which is the implicit cast introduced to cast from a nullable to a not nullable type, and not just allow this in the code gen.&lt;/p&gt;</comment>
                            <comment id="17522626" author="xuyangzhong" created="Fri, 15 Apr 2022 02:55:39 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=matriv&quot; class=&quot;user-hover&quot; rel=&quot;matriv&quot;&gt;matriv&lt;/a&gt;, I think currently this is not the problem with casting. Because this part of code gen doesn&apos;t not care of the nullable with the type and other part of code gen will avoid the nullable exists. For example, you can see the following code generated:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// the result rand(...) will be &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; only &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the arg in rand is nullable, like &lt;span class=&quot;code-quote&quot;&gt;&quot;rand(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; as &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;))&quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// so &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the sql is &lt;span class=&quot;code-quote&quot;&gt;&quot;rand() + 1&quot;&lt;/span&gt;, the generated code is:
&lt;/span&gt;        
    isNull$3 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&#160; &#160; result$4 = random$2.nextDouble();

&lt;span class=&quot;code-comment&quot;&gt;// and &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the sql is &lt;span class=&quot;code-quote&quot;&gt;&quot;rand(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; as &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;))&quot;&lt;/span&gt;:
&lt;/span&gt;
 &#160; &#160;isNull$3 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&#160; &#160; result$4 = -1.0d;
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isNull$3) {
&#160; &#160; &#160; &#160; &#160; result$4 = random$2.nextDouble();
&#160; &#160; }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This part that i fixed is only about the code : &quot;result$4 = random$2.nextDouble();&quot;&#160; and this should just ignore the nullable between DOUBLE and DOUBLE NOT NULL. And actually the logic of the legacy code does this by pre-checking the same type not necessary to cast before casting this different types.&lt;/p&gt;

&lt;p&gt;I strongly agree with you that the logic in casting should throw an exception if it meets casting a type from nullable to not nullable. But the problem of this issue is before casting logic.&lt;/p&gt;

&lt;p&gt;By the way, I think converting casting logic to different rules is a good improvement but should not affect the base logic when change the code. You can see the code before and after rewriting casting rules:&lt;/p&gt;

&lt;p&gt;before:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// no casting necessary
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isInteroperable(operandType, resultType)) {
  operandTerm =&amp;gt; s&lt;span class=&quot;code-quote&quot;&gt;&quot;$operandTerm&quot;&lt;/span&gt;
}
&lt;span class=&quot;code-comment&quot;&gt;// decimal to decimal, may have different precision/scale
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isDecimal(resultType) &amp;amp;&amp;amp; isDecimal(operandType)) {
  val dt = resultType.asInstanceOf[DecimalType]
  operandTerm =&amp;gt;
    s&lt;span class=&quot;code-quote&quot;&gt;&quot;$DECIMAL_UTIL.castToDecimal($operandTerm, ${dt.getPrecision}, ${dt.getScale})&quot;&lt;/span&gt;
}
&lt;span class=&quot;code-comment&quot;&gt;// non_decimal_numeric to decimal
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;after:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// All numeric rules are assumed to be instance of AbstractExpressionCodeGeneratorCastRule
&lt;/span&gt;val rule = CastRuleProvider.resolve(operandType, resultType)
rule match {
  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; codeGeneratorCastRule: ExpressionCodeGeneratorCastRule[_, _] =&amp;gt;
    operandTerm =&amp;gt;
      codeGeneratorCastRule.generateExpression(
        toCodegenCastContext(ctx),
        operandTerm,
        operandType,
        resultType
      )
  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt;
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CodeGenException(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Unsupported casting from $operandType to $resultType.&quot;&lt;/span&gt;)
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Looking forward to your reply &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17524251" author="matriv" created="Tue, 19 Apr 2022 11:20:25 +0000"  >&lt;p&gt;We can fix the issue with the quick fix in your PR.&lt;/p&gt;

&lt;p&gt;We have to open an issue, so that these kind of explicit casting is introduced with a Rule during the analysis/planning phase, and not in the code generation.&lt;/p&gt;

&lt;p&gt;This way, it will be visible what kind of implicit cast is introduced, by looking at the plan, and not just generate code for it under the hood.&lt;/p&gt;</comment>
                            <comment id="17524689" author="xuyangzhong" created="Wed, 20 Apr 2022 03:22:06 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17525434" author="twalthr" created="Thu, 21 Apr 2022 06:15:41 +0000"  >&lt;p&gt;Fixed in master: fcbbcf9bf91dc15ac5fc6d37a0b1445aa897f0d4&lt;br/&gt;
Fixed in 1.15: b9727d5b1914b64395e58cd6783f2f3a2f4957b7&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z11gmg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>