<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:22:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-37833] Code generated for binary key in BatchExecExchange causes incorrect shuffle</title>
                <link>https://issues.apache.org/jira/browse/FLINK-37833</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Context:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-table/flink-table-planner/src/main/scala/org/apache/flink/table/planner/codegen/CodeGenUtils.scala#L319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CodegenUtils.hashCodeForType&lt;/a&gt; function generates hash function code for &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-table/flink-table-runtime/src/main/java/org/apache/flink/table/runtime/partitioner/BinaryHashPartitioner.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;BinaryHashPartitioner&lt;/a&gt; evaluates &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-table/flink-table-runtime/src/main/java/org/apache/flink/table/data/binary/BinaryRowDataUtil.java#L31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;BYTE_ARRAY_BASE_OFFSET&lt;/a&gt; on the JobManager&#8217;s (JM) side and executes the code in TaskManager (TM) to compute the hashcode.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-table/flink-table-runtime/src/main/java/org/apache/flink/table/runtime/util/MurmurHashUtil.java#L52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;MurmurHashUtil.hashUnsafeBytes&lt;/a&gt; uses Java&#8217;s &lt;em&gt;Unsafe&lt;/em&gt; API to access the byte[] (16 bytes) as ints of 4 bytes, operates on it and computes the hashcode. Note: this is what Spark does too for efficient hash computation.&lt;/li&gt;
	&lt;li&gt;JVM optimizes the record layout of the objects based on JVM memory size, JVM args (-XX:-UseCompressedOops), processor architecture (64-bit, 32-bit) etc. JVM optimizes the record layout of a byte[] and its base offset as below:
	&lt;ol&gt;
		&lt;li&gt;&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;JVM Config / Scenario&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Likely ARRAY_BYTE_BASE_OFFSET&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;64-bit JVM with compressed OOPs (default)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;16&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;64-bit JVM without compressed OOPs&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;24&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32-bit JVM&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Typically 12 or less&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Custom JVM / non-HotSpot&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Depends&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In our environment, when JM heap size was &amp;gt; 32G while TM heap size was &amp;lt; 32G. This means the ARRAY_BYTE_BASE_OFFSET of byte[] on JM was 24 while on TM was 16.&lt;/li&gt;
	&lt;li&gt;Due to the above HashPartitioner codegen bug, the offset to read from was 24 (ARRAY_BYTE_BASE_OFFSET computed on JM and sent to TM) while the base offset on TM should have been 16 given the JVM heap size is &amp;lt; 32G. The issue here is &lt;em&gt;Offset misalignment relative to base&lt;/em&gt;.&lt;/li&gt;
	&lt;li&gt;This made the entire shuffle of the data by the byte[] key go totally wrong&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;The fix is to not evaluate BYTE_ARRAY_BASE_OFFSET (&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-table/flink-table-planner/src/main/scala/org/apache/flink/table/planner/codegen/CodeGenUtils.scala#L319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CodeGenUtils.hashCodeForType&lt;/a&gt;) in JM rather only in TM&lt;/p&gt;</description>
                <environment></environment>
        <key id="13618967">FLINK-37833</key>
            <summary>Code generated for binary key in BatchExecExchange causes incorrect shuffle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vsowrirajan">Venkata krishnan Sowrirajan</assignee>
                                    <reporter username="vsowrirajan">Venkata krishnan Sowrirajan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 22 May 2025 23:12:37 +0000</created>
                <updated>Thu, 12 Jun 2025 11:45:34 +0000</updated>
                            <resolved>Wed, 11 Jun 2025 02:50:38 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>1.19.2</version>
                    <version>1.20.1</version>
                                    <fixVersion>1.19.3</fixVersion>
                    <fixVersion>1.20.2</fixVersion>
                    <fixVersion>2.0.1</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17953555" author="vsowrirajan" created="Thu, 22 May 2025 23:13:07 +0000"  >&lt;p&gt;I&apos;m working on this issue, can I get this assigned to myself?&lt;/p&gt;</comment>
                            <comment id="17959628" author="becket_qin" created="Wed, 11 Jun 2025 02:50:38 +0000"  >&lt;p&gt;Patch Merged.&lt;/p&gt;

&lt;p&gt;master: 0fcde771ba23eae7f1756d8961c385c2d7a16b88&lt;br/&gt;
release-2.0:&#160;abf59fa2608a547f32bb9b2afcdd464abcf5804a&lt;br/&gt;
release-1.20:&#160;de4a5b71dafad1e9ca0954746d43436263c46228&lt;br/&gt;
release-1.19:&#160;aa277c283795953b6e8717f0e0f4f30341c05d46&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vzy0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>