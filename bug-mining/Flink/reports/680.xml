<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:21:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2977] Cannot access HBase in a Kerberos secured Yarn cluster</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2977</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I have created a very simple Flink topology consisting of a streaming Source (the outputs the timestamp a few times per second) and a Sink (that puts that timestamp into a single record in HBase).&lt;br/&gt;
Running this on a non-secure Yarn cluster works fine.&lt;/p&gt;

&lt;p&gt;To run it on a secured Yarn cluster my main routine now looks like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;java.security.krb5.conf&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;/etc/krb5.conf&quot;&lt;/span&gt;);
    UserGroupInformation.loginUserFromKeytab(&lt;span class=&quot;code-quote&quot;&gt;&quot;nbasjes@xxxxxx.NET&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/nbasjes/.krb/nbasjes.keytab&quot;&lt;/span&gt;);

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
    env.setParallelism(1);

    DataStream&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; stream = env.addSource(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TimerTicksSource());
    stream.addSink(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SetHBaseRowSink());
    env.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; running Flink application&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When I run this &lt;br/&gt;
     flink run -m yarn-cluster -yn 1 -yjm 1024 -ytm 4096 ./kerberos-1.0-SNAPSHOT.jar&lt;/p&gt;

&lt;p&gt;I see after the startup messages:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;17:13:24,466 INFO  org.apache.hadoop.security.UserGroupInformation               - Login successful for user nbasjes@xxxxxx.NET using keytab file /home/nbasjes/.krb/nbasjes.keytab&lt;br/&gt;
11/03/2015 17:13:25	Job execution switched to status RUNNING.&lt;br/&gt;
11/03/2015 17:13:25	Custom Source -&amp;gt; Stream Sink(1/1) switched to SCHEDULED &lt;br/&gt;
11/03/2015 17:13:25	Custom Source -&amp;gt; Stream Sink(1/1) switched to DEPLOYING &lt;br/&gt;
11/03/2015 17:13:25	Custom Source -&amp;gt; Stream Sink(1/1) switched to RUNNING &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Which looks good.&lt;/p&gt;

&lt;p&gt;However ... no data goes into HBase.&lt;br/&gt;
After some digging I found this error in the task managers log:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;17:13:42,677 WARN  org.apache.hadoop.hbase.ipc.RpcClient                         - Exception encountered while connecting to the server : javax.security.sasl.SaslException: GSS initiate failed &lt;span class=&quot;error&quot;&gt;&amp;#91;Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)&amp;#93;&lt;/span&gt;&lt;br/&gt;
17:13:42,677 FATAL org.apache.hadoop.hbase.ipc.RpcClient                         - SASL authentication failed. The most likely cause is missing or invalid credentials. Consider &apos;kinit&apos;.&lt;br/&gt;
javax.security.sasl.SaslException: GSS initiate failed &lt;span class=&quot;error&quot;&gt;&amp;#91;Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at com.sun.security.sasl.gsskerb.GssKrb5Client.evaluateChallenge(GssKrb5Client.java:212)&lt;br/&gt;
	at org.apache.hadoop.hbase.security.HBaseSaslRpcClient.saslConnect(HBaseSaslRpcClient.java:177)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.RpcClient$Connection.setupSaslConnection(RpcClient.java:815)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.RpcClient$Connection.access$800(RpcClient.java:349)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;First starting a yarn-session and then loading my job gives the same error.&lt;/p&gt;

&lt;p&gt;My best guess at this point is that Flink needs the same fix as described here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-6918&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-6918&lt;/a&gt;   ( &lt;a href=&quot;https://github.com/apache/spark/pull/5586&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5586&lt;/a&gt; )&lt;/p&gt;</description>
                <environment></environment>
        <key id="12910701">FLINK-2977</key>
            <summary>Cannot access HBase in a Kerberos secured Yarn cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nielsbasjes">Niels Basjes</assignee>
                                    <reporter username="nielsbasjes">Niels Basjes</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Nov 2015 12:36:55 +0000</created>
                <updated>Mon, 19 Dec 2016 12:47:07 +0000</updated>
                            <resolved>Tue, 17 Nov 2015 09:07:51 +0000</resolved>
                                                    <fixVersion>0.10.1</fixVersion>
                    <fixVersion>1.0.0</fixVersion>
                                    <component>Deployment / YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14991608" author="nielsbasjes" created="Thu, 5 Nov 2015 12:38:39 +0000"  >&lt;p&gt;In the mailing list &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt; responded:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt; I agree with you. It seems that HDFS and HBase are using their own tokes which we need to transfer from the client to the YARN containers. We should be able to port the fix from Spark (which they got from Storm) into our YARN client. &lt;br/&gt;
I think we would add this in org.apache.flink.yarn.Utils#setTokensFor().&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14991857" author="nielsbasjes" created="Thu, 5 Nov 2015 15:49:54 +0000"  >&lt;p&gt;First attempt, untested.&lt;br/&gt;
Essentially copied from &lt;a href=&quot;https://github.com/apache/spark/pull/5586/files#diff-b050df3f55b82065803d6e83453b9706R1091&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5586/files#diff-b050df3f55b82065803d6e83453b9706R1091&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Currently building the whole stack.&lt;/p&gt;</comment>
                            <comment id="14996785" author="nielsbasjes" created="Mon, 9 Nov 2015 16:11:39 +0000"  >&lt;p&gt;This patch &quot;works on my machine&quot;.&lt;br/&gt;
I am currently testing what happens if the original ticket expires.&lt;/p&gt;</comment>
                            <comment id="14996806" author="mxm" created="Mon, 9 Nov 2015 16:24:27 +0000"  >&lt;p&gt;Is the new patch your final take or are you still testing?&lt;/p&gt;</comment>
                            <comment id="14996842" author="nielsbasjes" created="Mon, 9 Nov 2015 16:41:02 +0000"  >&lt;p&gt;I just started a simple test Flink application with a keytab file on a secured cluster.&lt;br/&gt;
Our Kerberos tickets expire after about 10 hours so if this is still running tomorrow morning I&apos;ll press the &quot;Patch Available&quot; button.&lt;/p&gt;
</comment>
                            <comment id="14996857" author="mxm" created="Mon, 9 Nov 2015 16:47:10 +0000"  >&lt;p&gt;Great. Let&apos;s see what happens &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14998341" author="githubbot" created="Tue, 10 Nov 2015 10:05:37 +0000"  >&lt;p&gt;GitHub user nielsbasjes opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2977&quot; title=&quot;Cannot access HBase in a Kerberos secured Yarn cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2977&quot;&gt;&lt;del&gt;FLINK-2977&lt;/del&gt;&lt;/a&gt; Added support for accessing a Kerberos secured HBase installation.&lt;/p&gt;

&lt;p&gt;    See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2977&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-2977&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/nielsbasjes/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nielsbasjes/flink&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1342&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 81c0180f74dd8711d6cf8a61ecfb4fb5c0d187d1&lt;br/&gt;
Author: Niels Basjes &amp;lt;niels@basjes.nl&amp;gt;&lt;br/&gt;
Date:   2015-11-10T10:04:00Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2977&quot; title=&quot;Cannot access HBase in a Kerberos secured Yarn cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2977&quot;&gt;&lt;del&gt;FLINK-2977&lt;/del&gt;&lt;/a&gt; Added support for accessing a Kerberos secured HBase installation.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14998346" author="nielsbasjes" created="Tue, 10 Nov 2015 10:07:47 +0000"  >&lt;p&gt;I ran this version over night but the VPN from my system stopped before the ticket could expire.&lt;br/&gt;
I am quite confident that this patch is right though.&lt;br/&gt;
I&apos;ll start a new test on my end. With this pull request you guys can verify my patch and give me feedback on any improvements you see.&lt;/p&gt;</comment>
                            <comment id="14998350" author="githubbot" created="Tue, 10 Nov 2015 10:11:14 +0000"  >&lt;p&gt;Github user nielsbasjes commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-155376887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-155376887&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I ran this version over night but the VPN from my system to the cluster stopped before the Kerberos ticket could expire.&lt;br/&gt;
    I am quite confident that this patch is right though.&lt;br/&gt;
    I&apos;ll start a new test on my end. With this pull request you guys can verify my patch and give me feedback on any improvements you see.&lt;/p&gt;</comment>
                            <comment id="14998371" author="githubbot" created="Tue, 10 Nov 2015 10:25:02 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#discussion_r44390519&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#discussion_r44390519&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/Utils.java &amp;#8212;&lt;br/&gt;
    @@ -135,7 +142,40 @@ public static void setTokensFor(ContainerLaunchContext amContainer, Path[] paths&lt;br/&gt;
     		ByteBuffer securityTokens = ByteBuffer.wrap(dob.getData(), 0, dob.getLength());&lt;br/&gt;
     		amContainer.setTokens(securityTokens);&lt;br/&gt;
     	}&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Obtain Kerberos security token for HBase.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private static void obtainTokenForHBase(Credentials credentials, Configuration conf) {&lt;br/&gt;
    +		if (UserGroupInformation.isSecurityEnabled()) {&lt;br/&gt;
    +			LOG.info(&quot;Attempting to obtain Kerberos security token for HBase&quot;);&lt;br/&gt;
    +			try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				HBaseConfiguration.addHbaseResources(conf);    +				if (!&amp;quot;kerberos&amp;quot;.equals(conf.get(&amp;quot;hbase.security.authentication&amp;quot;))) {
    +					LOG.info(&quot;HBase has not been configured to use Kerberos.&quot;);
    +					return;
    +				}    +    +				LOG.info(&amp;quot;Connecting to HBase&amp;quot;);    +				Connection connection = ConnectionFactory.createConnection(conf);    +    +				LOG.info(&amp;quot;Obtaining Kerberos security token for HBase&amp;quot;);    +				Token&amp;lt;AuthenticationTokenIdentifier&amp;gt; token = TokenUtil.obtainToken(connection);    +    +				if (token == null) {
    +					LOG.error(&quot;No Kerberos security token for HBase available&quot;);
    +					return;
    +				}    +    +				credentials.addToken(token.getService(), token);    +				LOG.info(&amp;quot;Added HBase Kerberos security token to credentials.&amp;quot;);    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (IOException e) {&lt;br/&gt;
    +				LOG.error(&quot;Caught exception while trying to obtain HBase Kerberos security token.&quot;);&lt;br/&gt;
    +				e.printStackTrace();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    You might want to re`throw` the Exception here or not catch it at all. This ensures that it is probably forwarded to the client.&lt;/p&gt;</comment>
                            <comment id="14998373" author="githubbot" created="Tue, 10 Nov 2015 10:25:43 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-155380888&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-155380888&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the pull request. Looks good to me except for one comment. I would like to postpone merging until you have verified the changes.&lt;/p&gt;</comment>
                            <comment id="14998382" author="githubbot" created="Tue, 10 Nov 2015 10:32:08 +0000"  >&lt;p&gt;Github user nielsbasjes commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#discussion_r44391146&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#discussion_r44391146&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/Utils.java &amp;#8212;&lt;br/&gt;
    @@ -135,7 +142,40 @@ public static void setTokensFor(ContainerLaunchContext amContainer, Path[] paths&lt;br/&gt;
     		ByteBuffer securityTokens = ByteBuffer.wrap(dob.getData(), 0, dob.getLength());&lt;br/&gt;
     		amContainer.setTokens(securityTokens);&lt;br/&gt;
     	}&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Obtain Kerberos security token for HBase.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private static void obtainTokenForHBase(Credentials credentials, Configuration conf) {&lt;br/&gt;
    +		if (UserGroupInformation.isSecurityEnabled()) {&lt;br/&gt;
    +			LOG.info(&quot;Attempting to obtain Kerberos security token for HBase&quot;);&lt;br/&gt;
    +			try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				HBaseConfiguration.addHbaseResources(conf);    +				if (!&amp;quot;kerberos&amp;quot;.equals(conf.get(&amp;quot;hbase.security.authentication&amp;quot;))) {
    +					LOG.info(&quot;HBase has not been configured to use Kerberos.&quot;);
    +					return;
    +				}    +    +				LOG.info(&amp;quot;Connecting to HBase&amp;quot;);    +				Connection connection = ConnectionFactory.createConnection(conf);    +    +				LOG.info(&amp;quot;Obtaining Kerberos security token for HBase&amp;quot;);    +				Token&amp;lt;AuthenticationTokenIdentifier&amp;gt; token = TokenUtil.obtainToken(connection);    +    +				if (token == null) {
    +					LOG.error(&quot;No Kerberos security token for HBase available&quot;);
    +					return;
    +				}    +    +				credentials.addToken(token.getService(), token);    +				LOG.info(&amp;quot;Added HBase Kerberos security token to credentials.&amp;quot;);    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (IOException e) {&lt;br/&gt;
    +				LOG.error(&quot;Caught exception while trying to obtain HBase Kerberos security token.&quot;);&lt;br/&gt;
    +				e.printStackTrace();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes I considered that. I figured that continuing would be &apos;better&apos;. But simply rethrowing would make more sense.&lt;br/&gt;
    I&apos;ll update the patch.&lt;/p&gt;</comment>
                            <comment id="15000127" author="githubbot" created="Wed, 11 Nov 2015 08:58:10 +0000"  >&lt;p&gt;Github user nielsbasjes commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-155708227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-155708227&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I created a test topology that puts the current time in an HBase cell several times per second.&lt;br/&gt;
    In the cluster I did this on HBase is configured to use Kerberos and the Kerberos tickets expire after 10 hours.&lt;br/&gt;
    I let this running for 22:15 (so more than twice the expire time) and it continues to successfully update the column in HBase.&lt;/p&gt;

&lt;p&gt;    So from my standpoint this patch is ready to be committed.&lt;/p&gt;</comment>
                            <comment id="15000170" author="githubbot" created="Wed, 11 Nov 2015 09:55:42 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-155719584&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-155719584&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you for the testing and the patch. I would like to merge this soon.&lt;/p&gt;</comment>
                            <comment id="15000307" author="githubbot" created="Wed, 11 Nov 2015 12:30:21 +0000"  >&lt;p&gt;Github user rmetzger commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-155764769&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-155764769&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The tests on travis are failing&lt;/p&gt;</comment>
                            <comment id="15000317" author="githubbot" created="Wed, 11 Nov 2015 12:38:05 +0000"  >&lt;p&gt;Github user rmetzger commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#discussion_r44527912&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#discussion_r44527912&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/pom.xml &amp;#8212;&lt;br/&gt;
    @@ -63,6 +63,11 @@ under the License.&lt;br/&gt;
     			&amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;&lt;br/&gt;
     		&amp;lt;/dependency&amp;gt;&lt;/p&gt;

&lt;p&gt;    +		&amp;lt;dependency&amp;gt;&lt;br/&gt;
    +			&amp;lt;groupId&amp;gt;org.apache.hbase&amp;lt;/groupId&amp;gt;&lt;br/&gt;
    +			&amp;lt;artifactId&amp;gt;hbase-client&amp;lt;/artifactId&amp;gt;&lt;br/&gt;
    +			&amp;lt;version&amp;gt;${hbase.version}&amp;lt;/version&amp;gt;&lt;br/&gt;
    +		&amp;lt;/dependency&amp;gt;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This change is adding hbase as a dependency into Flink&apos;s fat jar (binary distribution).&lt;br/&gt;
    The `flink-hbase` module is currently an optional module.&lt;/p&gt;</comment>
                            <comment id="15000323" author="githubbot" created="Wed, 11 Nov 2015 12:47:34 +0000"  >&lt;p&gt;Github user rmetzger commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-155768292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-155768292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks a lot for working on this issue! It doesn&apos;t happen everyday that users identify issues, fix them and verify the fix so properly &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;    I would really like to avoid pulling hbase as dependency into Flink&apos;s binary distribution. Can you change to &quot;obtain token&quot; part to do everything by loading the classes dynamically and calling the methods via reflection? (Similar to Spark&apos;s implementation: &lt;a href=&quot;https://github.com/apache/spark/pull/5586/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5586/files&lt;/a&gt;)&lt;br/&gt;
    This way, we only execute this if the hbase classes are in the classpath.&lt;/p&gt;</comment>
                            <comment id="15000325" author="githubbot" created="Wed, 11 Nov 2015 12:50:52 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-155769960&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-155769960&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Robert has a good point. Right now, if some one uses HBase, the HBase dependency is part of the user program JAR. It would be nice to keep HBase out of the core JAR - it would be yet another fat dependency with multiple transitive dependencies.&lt;/p&gt;

&lt;p&gt;    Once you change the code to reflect-load the HBase classes, one gets the Kerberos/HBase support as soon as one drops the HBase jars JAR into Flink&apos;s lib folder, or adds them to the Hadoop Classpath env variable. At the same time, non-HBase users retain a thinner set of dependencies (and possible conflicts).&lt;/p&gt;

&lt;p&gt;    @nielsbasjes What do you think about that approach?&lt;/p&gt;</comment>
                            <comment id="15000326" author="githubbot" created="Wed, 11 Nov 2015 12:51:08 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-155770210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-155770210&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I was thinking about something like a reflection-based mechanism. Not sure though if this will work across different versions. Probably the API didn&apos;t change much in this regard.&lt;/p&gt;</comment>
                            <comment id="15000970" author="githubbot" created="Wed, 11 Nov 2015 19:48:17 +0000"  >&lt;p&gt;Github user nielsbasjes commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-155891180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-155891180&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen: I agree. I&apos;ll get on it.&lt;br/&gt;
    @mxm : The current code uses the 1.1.2 API and was tested against a 0.98 HBase cluster. I&apos;m confident this part of the code hasn&apos;t changed recently.&lt;br/&gt;
    @rmetzger: I&apos;m not really an &apos;average user&apos; &lt;/p&gt;</comment>
                            <comment id="15001933" author="githubbot" created="Thu, 12 Nov 2015 10:25:12 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156061452&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156061452&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Dynamic class loading should work then. Would be great if you could integrate it @nielsbasjes. We understand you&apos;re not an average user since you&apos;re an open source software developer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15002157" author="githubbot" created="Thu, 12 Nov 2015 14:30:50 +0000"  >&lt;p&gt;Github user nielsbasjes commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156116370&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156116370&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I fixed the authentication to use reflection.&lt;br/&gt;
    To make this work I had to switch back to an older (deprecated) version of the token retrieval API because otherwise it wouldn&apos;t work (instead of a &quot;Connection&quot; parameter now use a &quot;Configuration&quot; parameter).&lt;/p&gt;

&lt;p&gt;    I had our IT guys drop the ticket expire time for my user account down to 5 minutes. &lt;br/&gt;
    Given that my topology has been running for more than 22 minutes now so the solution still works.&lt;/p&gt;

&lt;p&gt;    Please review.&lt;/p&gt;</comment>
                            <comment id="15002161" author="githubbot" created="Thu, 12 Nov 2015 14:34:07 +0000"  >&lt;p&gt;Github user nielsbasjes commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156117069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156117069&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I made a mistake that the dependency was still in there &apos;hard&apos;.&lt;br/&gt;
    When I switch it to &apos;provided&apos; or leave it out it fails with a ClassNotFound ... &lt;/p&gt;</comment>
                            <comment id="15002175" author="githubbot" created="Thu, 12 Nov 2015 14:46:37 +0000"  >&lt;p&gt;Github user nielsbasjes commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156122982&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156122982&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Found it and fixed it.&lt;/p&gt;</comment>
                            <comment id="15003779" author="githubbot" created="Fri, 13 Nov 2015 09:42:38 +0000"  >&lt;p&gt;Github user rmetzger commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#discussion_r44764775&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#discussion_r44764775&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/Utils.java &amp;#8212;&lt;br/&gt;
    @@ -135,7 +138,54 @@ public static void setTokensFor(ContainerLaunchContext amContainer, Path[] paths&lt;br/&gt;
     		ByteBuffer securityTokens = ByteBuffer.wrap(dob.getData(), 0, dob.getLength());&lt;br/&gt;
     		amContainer.setTokens(securityTokens);&lt;br/&gt;
     	}&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Obtain Kerberos security token for HBase.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private static void obtainTokenForHBase(Credentials credentials, Configuration conf) throws IOException {&lt;br/&gt;
    +		if (UserGroupInformation.isSecurityEnabled()) {&lt;br/&gt;
    +			LOG.info(&quot;Attempting to obtain Kerberos security token for HBase&quot;);&lt;br/&gt;
    +			try {&lt;br/&gt;
    +				// ----&lt;br/&gt;
    +				// Intended call: HBaseConfiguration.addHbaseResources(conf);&lt;br/&gt;
    +				Class&lt;br/&gt;
    +						.forName(&quot;org.apache.hadoop.hbase.HBaseConfiguration&quot;)&lt;br/&gt;
    +						.getMethod(&quot;addHbaseResources&quot;, Configuration.class )&lt;br/&gt;
    +						.invoke(null, conf);&lt;br/&gt;
    +				// ----&lt;br/&gt;
    +&lt;br/&gt;
    +				LOG.info(&quot;HBase security setting: {}&quot;, conf.get(&quot;hbase.security.authentication&quot;));&lt;br/&gt;
    +&lt;br/&gt;
    +				if (!&quot;kerberos&quot;.equals(conf.get(&quot;hbase.security.authentication&quot;))) &lt;/p&gt;
{
    +					LOG.info(&quot;HBase has not been configured to use Kerberos.&quot;);
    +					return;
    +				}
&lt;p&gt;    +&lt;br/&gt;
    +				LOG.info(&quot;Obtaining Kerberos security token for HBase&quot;);&lt;br/&gt;
    +				// ----&lt;br/&gt;
    +				// Intended call: Token&amp;lt;AuthenticationTokenIdentifier&amp;gt; token = TokenUtil.obtainToken(conf);&lt;br/&gt;
    +				Token&amp;lt;?&amp;gt; token = (Token&amp;lt;?&amp;gt;) Class&lt;br/&gt;
    +						.forName(&quot;org.apache.hadoop.hbase.security.token.TokenUtil&quot;)&lt;br/&gt;
    +						.getMethod(&quot;obtainToken&quot;, Configuration.class)&lt;br/&gt;
    +						.invoke(null, conf);&lt;br/&gt;
    +				// ----&lt;br/&gt;
    +&lt;br/&gt;
    +				if (token == null) &lt;/p&gt;
{
    +					LOG.error(&quot;No Kerberos security token for HBase available&quot;);
    +					return;
    +				}
&lt;p&gt;    +&lt;br/&gt;
    +				credentials.addToken(token.getService(), token);&lt;br/&gt;
    +				LOG.info(&quot;Added HBase Kerberos security token to credentials.&quot;);&lt;br/&gt;
    +			} catch ( ClassNotFoundException&lt;br/&gt;
    +					| NoSuchMethodException&lt;br/&gt;
    +					| IllegalAccessException&lt;br/&gt;
    +					| InvocationTargetException e) {&lt;br/&gt;
    +				LOG.info(&quot;HBase is not available (not packaged with this application).&quot;);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Maybe it makes sense to add the exception to the log message (or even the full stack trace), so that users have a better understanding what exactly went wrong (for example hbase version mismatch)&lt;/p&gt;</comment>
                            <comment id="15003780" author="githubbot" created="Fri, 13 Nov 2015 09:42:58 +0000"  >&lt;p&gt;Github user rmetzger commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#discussion_r44764797&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#discussion_r44764797&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: pom.xml &amp;#8212;&lt;br/&gt;
    @@ -82,6 +82,7 @@ under the License.&lt;br/&gt;
     		&amp;lt;shading-artifact-module.name&amp;gt;error&amp;lt;/shading-artifact-module.name&amp;gt;&lt;br/&gt;
     		&amp;lt;hadoop-one.version&amp;gt;1.2.1&amp;lt;/hadoop-one.version&amp;gt;&lt;br/&gt;
     		&amp;lt;hadoop-two.version&amp;gt;2.3.0&amp;lt;/hadoop-two.version&amp;gt;&lt;br/&gt;
    +		&amp;lt;hbase.version&amp;gt;1.1.2&amp;lt;/hbase.version&amp;gt;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think you can remove this version definition again.&lt;/p&gt;</comment>
                            <comment id="15003782" author="githubbot" created="Fri, 13 Nov 2015 09:44:18 +0000"  >&lt;p&gt;Github user rmetzger commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#discussion_r44764893&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#discussion_r44764893&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-dist/src/main/flink-bin/bin/config.sh &amp;#8212;&lt;br/&gt;
    @@ -249,7 +249,15 @@ if [ -n &quot;$HADOOP_HOME&quot; ]; then&lt;br/&gt;
         fi&lt;br/&gt;
     fi&lt;/p&gt;

&lt;p&gt;    -INTERNAL_HADOOP_CLASSPATHS=&quot;$HADOOP_CLASSPATH:$HADOOP_CONF_DIR:$YARN_CONF_DIR&quot;&lt;br/&gt;
    +INTERNAL_HADOOP_CLASSPATHS=&quot;${HADOOP_CLASSPATH}:${HADOOP_CONF_DIR}:${YARN_CONF_DIR}&quot;&lt;br/&gt;
    +&lt;br/&gt;
    +if [ -n &quot;${HBASE_CONF_DIR}&quot; ]; then&lt;br/&gt;
    +    # Setup the HBase classpath.&lt;br/&gt;
    +    INTERNAL_HADOOP_CLASSPATHS=&quot;${INTERNAL_HADOOP_CLASSPATHS}:`hbase classpath`&quot;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    what happens if the call to `hbase` fails, for example because its not in the `$PATH` ?&lt;/p&gt;</comment>
                            <comment id="15003784" author="githubbot" created="Fri, 13 Nov 2015 09:44:49 +0000"  >&lt;p&gt;Github user rmetzger commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156379250&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156379250&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I had some minor remarks to the PR, but overall, I&apos;d like to merge it like this!&lt;/p&gt;</comment>
                            <comment id="15003790" author="githubbot" created="Fri, 13 Nov 2015 09:54:02 +0000"  >&lt;p&gt;Github user nielsbasjes commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#discussion_r44765814&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#discussion_r44765814&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-dist/src/main/flink-bin/bin/config.sh &amp;#8212;&lt;br/&gt;
    @@ -249,7 +249,15 @@ if [ -n &quot;$HADOOP_HOME&quot; ]; then&lt;br/&gt;
         fi&lt;br/&gt;
     fi&lt;/p&gt;

&lt;p&gt;    -INTERNAL_HADOOP_CLASSPATHS=&quot;$HADOOP_CLASSPATH:$HADOOP_CONF_DIR:$YARN_CONF_DIR&quot;&lt;br/&gt;
    +INTERNAL_HADOOP_CLASSPATHS=&quot;${HADOOP_CLASSPATH}:${HADOOP_CONF_DIR}:${YARN_CONF_DIR}&quot;&lt;br/&gt;
    +&lt;br/&gt;
    +if [ -n &quot;${HBASE_CONF_DIR}&quot; ]; then&lt;br/&gt;
    +    # Setup the HBase classpath.&lt;br/&gt;
    +    INTERNAL_HADOOP_CLASSPATHS=&quot;${INTERNAL_HADOOP_CLASSPATHS}:`hbase classpath`&quot;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    1) You see an error during the startup of your flink job&lt;br/&gt;
    2) An empty value is inserted in the path causing your homedirectory to be in the classpath.&lt;br/&gt;
    3) HBase support doesn&apos;t work.&lt;/p&gt;

&lt;p&gt;    A quick test on the commandline:&lt;br/&gt;
    ```&lt;br/&gt;
    $ INTERNAL_HADOOP_CLASSPATHS=foo:bar&lt;br/&gt;
    $ INTERNAL_HADOOP_CLASSPATHS=&quot;${INTERNAL_HADOOP_CLASSPATHS}:`hbasexx classpath`&quot;&lt;br/&gt;
    bash: hbasexx: command not found...&lt;br/&gt;
    $ echo $INTERNAL_HADOOP_CLASSPATHS &lt;br/&gt;
    foo:bar:&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="15003796" author="githubbot" created="Fri, 13 Nov 2015 10:04:30 +0000"  >&lt;p&gt;Github user nielsbasjes commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#discussion_r44766715&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#discussion_r44766715&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/Utils.java &amp;#8212;&lt;br/&gt;
    @@ -135,7 +138,54 @@ public static void setTokensFor(ContainerLaunchContext amContainer, Path[] paths&lt;br/&gt;
     		ByteBuffer securityTokens = ByteBuffer.wrap(dob.getData(), 0, dob.getLength());&lt;br/&gt;
     		amContainer.setTokens(securityTokens);&lt;br/&gt;
     	}&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Obtain Kerberos security token for HBase.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private static void obtainTokenForHBase(Credentials credentials, Configuration conf) throws IOException {&lt;br/&gt;
    +		if (UserGroupInformation.isSecurityEnabled()) {&lt;br/&gt;
    +			LOG.info(&quot;Attempting to obtain Kerberos security token for HBase&quot;);&lt;br/&gt;
    +			try {&lt;br/&gt;
    +				// ----&lt;br/&gt;
    +				// Intended call: HBaseConfiguration.addHbaseResources(conf);&lt;br/&gt;
    +				Class&lt;br/&gt;
    +						.forName(&quot;org.apache.hadoop.hbase.HBaseConfiguration&quot;)&lt;br/&gt;
    +						.getMethod(&quot;addHbaseResources&quot;, Configuration.class )&lt;br/&gt;
    +						.invoke(null, conf);&lt;br/&gt;
    +				// ----&lt;br/&gt;
    +&lt;br/&gt;
    +				LOG.info(&quot;HBase security setting: {}&quot;, conf.get(&quot;hbase.security.authentication&quot;));&lt;br/&gt;
    +&lt;br/&gt;
    +				if (!&quot;kerberos&quot;.equals(conf.get(&quot;hbase.security.authentication&quot;))) &lt;/p&gt;
{
    +					LOG.info(&quot;HBase has not been configured to use Kerberos.&quot;);
    +					return;
    +				}
&lt;p&gt;    +&lt;br/&gt;
    +				LOG.info(&quot;Obtaining Kerberos security token for HBase&quot;);&lt;br/&gt;
    +				// ----&lt;br/&gt;
    +				// Intended call: Token&amp;lt;AuthenticationTokenIdentifier&amp;gt; token = TokenUtil.obtainToken(conf);&lt;br/&gt;
    +				Token&amp;lt;?&amp;gt; token = (Token&amp;lt;?&amp;gt;) Class&lt;br/&gt;
    +						.forName(&quot;org.apache.hadoop.hbase.security.token.TokenUtil&quot;)&lt;br/&gt;
    +						.getMethod(&quot;obtainToken&quot;, Configuration.class)&lt;br/&gt;
    +						.invoke(null, conf);&lt;br/&gt;
    +				// ----&lt;br/&gt;
    +&lt;br/&gt;
    +				if (token == null) &lt;/p&gt;
{
    +					LOG.error(&quot;No Kerberos security token for HBase available&quot;);
    +					return;
    +				}
&lt;p&gt;    +&lt;br/&gt;
    +				credentials.addToken(token.getService(), token);&lt;br/&gt;
    +				LOG.info(&quot;Added HBase Kerberos security token to credentials.&quot;);&lt;br/&gt;
    +			} catch ( ClassNotFoundException&lt;br/&gt;
    +					| NoSuchMethodException&lt;br/&gt;
    +					| IllegalAccessException&lt;br/&gt;
    +					| InvocationTargetException e) {&lt;br/&gt;
    +				LOG.info(&quot;HBase is not available (not packaged with this application).&quot;);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Now the error looks like this (not the full stacktrace, yet enough to understand what happened):&lt;br/&gt;
    ```&lt;br/&gt;
    11:01:49,970 INFO  org.apache.flink.yarn.Utils  - HBase is not available (not packaged with this application): ClassNotFoundException : &quot;org.apache.hadoop.hbase.HBaseConfiguration&quot;.&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="15003813" author="githubbot" created="Fri, 13 Nov 2015 10:14:49 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156387638&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156387638&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 thanks for improving it!&lt;/p&gt;</comment>
                            <comment id="15003817" author="githubbot" created="Fri, 13 Nov 2015 10:19:37 +0000"  >&lt;p&gt;Github user rmetzger commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#discussion_r44767927&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#discussion_r44767927&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-dist/src/main/flink-bin/bin/config.sh &amp;#8212;&lt;br/&gt;
    @@ -249,7 +249,15 @@ if [ -n &quot;$HADOOP_HOME&quot; ]; then&lt;br/&gt;
         fi&lt;br/&gt;
     fi&lt;/p&gt;

&lt;p&gt;    -INTERNAL_HADOOP_CLASSPATHS=&quot;$HADOOP_CLASSPATH:$HADOOP_CONF_DIR:$YARN_CONF_DIR&quot;&lt;br/&gt;
    +INTERNAL_HADOOP_CLASSPATHS=&quot;${HADOOP_CLASSPATH}:${HADOOP_CONF_DIR}:${YARN_CONF_DIR}&quot;&lt;br/&gt;
    +&lt;br/&gt;
    +if [ -n &quot;${HBASE_CONF_DIR}&quot; ]; then&lt;br/&gt;
    +    # Setup the HBase classpath.&lt;br/&gt;
    +    INTERNAL_HADOOP_CLASSPATHS=&quot;${INTERNAL_HADOOP_CLASSPATHS}:`hbase classpath`&quot;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Okay great, as long as it is not stopping the bash script, its fine.&lt;/p&gt;</comment>
                            <comment id="15003819" author="githubbot" created="Fri, 13 Nov 2015 10:20:50 +0000"  >&lt;p&gt;Github user rmetzger commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156388624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156388624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you for addressing my concerns so quickly&lt;br/&gt;
    +1 to merge.&lt;/p&gt;</comment>
                            <comment id="15003942" author="githubbot" created="Fri, 13 Nov 2015 12:45:01 +0000"  >&lt;p&gt;Github user nielsbasjes commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156423436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156423436&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I redid my test to make sure it still all works as desired;&lt;/p&gt;

&lt;p&gt;    I had our IT guys drop the ticket expire time for my user account down to 5 minutes and the max renew time to 10 minutes. (Which makes doing normal work near impossible).&lt;br/&gt;
    Given that my topology has been updating my HBase column for more than 42 minutes now.&lt;br/&gt;
    I say: works the way I want it to.&lt;/p&gt;



</comment>
                            <comment id="15003946" author="githubbot" created="Fri, 13 Nov 2015 12:46:04 +0000"  >&lt;p&gt;Github user rmetzger commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156423600&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156423600&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Amazing, thank you.&lt;br/&gt;
    I&apos;m going to merge you change as soon as Travis gives me green light &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
    I&apos;ve squashed and rebased your commit and will push it probably as &lt;a href=&quot;https://github.com/rmetzger/flink/commit/55248ec26337797d56bc8bddd5f62c4db0ea195c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rmetzger/flink/commit/55248ec26337797d56bc8bddd5f62c4db0ea195c&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15006323" author="githubbot" created="Mon, 16 Nov 2015 08:18:31 +0000"  >&lt;p&gt;Github user nielsbasjes commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156952942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156952942&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    FYI: I let my test run over the weekend (i.e. for 65 hours) with the 5 &amp;amp; 10 minutes ticket times and it is still running fine.&lt;/p&gt;</comment>
                            <comment id="15006384" author="githubbot" created="Mon, 16 Nov 2015 09:23:28 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342#issuecomment-156965181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342#issuecomment-156965181&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for testing this so thoroughly. +1 to merge.&lt;/p&gt;</comment>
                            <comment id="15006649" author="githubbot" created="Mon, 16 Nov 2015 13:19:33 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1342&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15006650" author="rmetzger" created="Mon, 16 Nov 2015 13:20:02 +0000"  >&lt;p&gt;Resolved for 1.0 in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/flink/commit/aba37794&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/flink/commit/aba37794&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you for the contribution &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nielsbasjes&quot; class=&quot;user-hover&quot; rel=&quot;nielsbasjes&quot;&gt;nielsbasjes&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15008322" author="rmetzger" created="Tue, 17 Nov 2015 09:07:38 +0000"  >&lt;p&gt;Resolved for the 0.10 branch as well: &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/flink/commit/7c4cde3a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/flink/commit/7c4cde3a&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12770817" name="FLINK-2977-20151005-untested.patch" size="3659" author="nielsbasjes" created="Thu, 5 Nov 2015 15:49:54 +0000"/>
                            <attachment id="12771365" name="FLINK-2977-20151009.patch" size="4517" author="nielsbasjes" created="Mon, 9 Nov 2015 16:11:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2o00n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>