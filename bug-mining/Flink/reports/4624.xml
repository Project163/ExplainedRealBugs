<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:49:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19427] SplitFetcherTest.testNotifiesWhenGoingIdleConcurrent is instable</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19427</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=6983&amp;amp;view=logs&amp;amp;j=8fd975ef-f478-511d-4997-6f15fe8a1fd3&amp;amp;t=ac0fa443-5d45-5a6b-3597-0310ecc1d2ab&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=6983&amp;amp;view=logs&amp;amp;j=8fd975ef-f478-511d-4997-6f15fe8a1fd3&amp;amp;t=ac0fa443-5d45-5a6b-3597-0310ecc1d2ab&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-09-26T21:27:46.6223579Z [ERROR] testNotifiesWhenGoingIdleConcurrent(org.apache.flink.connector.base.source.reader.fetcher.SplitFetcherTest)  Time elapsed: 0.602 s  &amp;lt;&amp;lt;&amp;lt; FAILURE!
2020-09-26T21:27:46.6224448Z java.lang.AssertionError
2020-09-26T21:27:46.6224804Z 	at org.junit.Assert.fail(Assert.java:86)
2020-09-26T21:27:46.6225136Z 	at org.junit.Assert.assertTrue(Assert.java:41)
2020-09-26T21:27:46.6225498Z 	at org.junit.Assert.assertTrue(Assert.java:52)
2020-09-26T21:27:46.6225984Z 	at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcherTest.testNotifiesWhenGoingIdleConcurrent(SplitFetcherTest.java:129)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13329568">FLINK-19427</key>
            <summary>SplitFetcherTest.testNotifiesWhenGoingIdleConcurrent is instable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="dian.fu">Dian Fu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Sun, 27 Sep 2020 01:12:25 +0000</created>
                <updated>Tue, 13 Oct 2020 09:38:11 +0000</updated>
                            <resolved>Tue, 13 Oct 2020 09:38:07 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Connectors / Common</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17208509" author="roman_khachatryan" created="Tue, 6 Oct 2020 06:35:30 +0000"  >&lt;p&gt;Another instance: &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=7213&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=62110053-334f-5295-a0ab-80dd7e2babbf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=7213&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=62110053-334f-5295-a0ab-80dd7e2babbf&lt;/a&gt;&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17208634" author="kezhuw" created="Tue, 6 Oct 2020 10:17:47 +0000"  >&lt;p&gt;I could image the execution steps for this failure:&lt;/p&gt;

&lt;p&gt;1. After &lt;tt&gt;fetcher.runOnce()&lt;/tt&gt;, the queue is available for pop.&lt;br/&gt;
 2. Then &lt;tt&gt;QueueDrainerThread.go&lt;/tt&gt; pop the last element from the queue and move the queue to un-available.&lt;br/&gt;
 3. &lt;tt&gt;assertTrue(queue.getAvailabilityFuture().isDone())&lt;/tt&gt; fails.&lt;/p&gt;

&lt;p&gt;The assertion in &lt;tt&gt;SplitFetcherTest.testNotifiesWhenGoingIdleConcurrent&lt;/tt&gt; is similar to &lt;tt&gt;SourceReaderBase.finishedOrAvailableLater&lt;/tt&gt;, they are all some kind of end-of-input checking. &lt;tt&gt;FutureCompletingBlockingQueue&lt;/tt&gt; has no builtin end-of-input checking, &lt;tt&gt;SourceReaderBase&lt;/tt&gt; uses external knowledge to check end-of-input. After reaching end-of-input, &lt;tt&gt;SourceReaderBase.elementsQueue.getAvailabilityFuture().isDone()&lt;/tt&gt; is indeterministic. It could be &lt;tt&gt;false&lt;/tt&gt; due to last poll, or &lt;tt&gt;true&lt;/tt&gt; due to no atomic concurrent &lt;tt&gt;SplitFetcher.checkAndSetIdle()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I think we can pass this test by run &lt;tt&gt;SplitFetcher.runOnce&lt;/tt&gt; in separate thread and merge &lt;tt&gt;QueueDrainerThread&lt;/tt&gt; to main testing method, this is actually the way &lt;tt&gt;SourceReaderBase&lt;/tt&gt; taken. This way, after &lt;tt&gt;SplitFetcher.runOnce&lt;/tt&gt; joined, we can safely assert &lt;tt&gt;SplitFetcher.isIdle()&lt;/tt&gt; and &lt;tt&gt;FutureCompletingBlockingQueue.getAvailabilityFuture().isDone()&lt;/tt&gt;. But then, this test looks almost same to its no concurrent counterpart.&lt;/p&gt;

&lt;p&gt;Seems that we are testing wrong assumption, may be we can just delete this test ?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dian.fu&quot; class=&quot;user-hover&quot; rel=&quot;dian.fu&quot;&gt;dian.fu&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; Any thoughts ?&lt;/p&gt;</comment>
                            <comment id="17212322" author="stephanewen" created="Mon, 12 Oct 2020 12:15:07 +0000"  >&lt;p&gt;You are right. The test is somehow not correctly written.&lt;/p&gt;

&lt;p&gt;What we really need to check here is the following: We must have either of the following conditions being true:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Either the fetcher was already set to idle when the thread pulled the fetch from the queue, because that is when the reader thread is supposed to check for fetcher being idle and shutting it down (which signals end of input)&lt;/li&gt;
	&lt;li&gt;Or the fetcher was not yet marked idle, because the fetch was pulled before that flag was set. In that case, the future must be complete, so that the reader thread goes back to checking the fetcher.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I prepared a PR that changes this. As a side effect, this should also fix &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19489&quot; title=&quot;SplitFetcherTest.testNotifiesWhenGoingIdleConcurrent gets stuck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19489&quot;&gt;&lt;del&gt;FLINK-19489&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17212328" author="stephanewen" created="Mon, 12 Oct 2020 12:24:40 +0000"  >&lt;p&gt;Here is the PR: &lt;a href=&quot;https://github.com/apache/flink/pull/13593&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/13593&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17213008" author="stephanewen" created="Tue, 13 Oct 2020 09:38:07 +0000"  >&lt;p&gt;Fixed in 1.12 (master) via 401f56fe9d6b0271260edf9787cdcbfe4d03874d&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0iy1c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>