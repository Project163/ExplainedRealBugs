<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:08:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-25126] FlinkKafkaInternalProducer state is not reset if transaction finalization fails</title>
                <link>https://issues.apache.org/jira/browse/FLINK-25126</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;flinksql task submitted by sql client will failed,&lt;/p&gt;

&lt;p&gt;this is the sql :&lt;/p&gt;

&lt;p&gt;SET &apos;execution.runtime-mode&apos; = &apos;batch&apos;;&lt;/p&gt;

&lt;p&gt;&#160;CREATE TABLE ka15 (&lt;br/&gt;
&#160; &#160; &#160;name String,&lt;br/&gt;
&#160; &#160; &#160;cnt bigint&lt;br/&gt;
&#160;) WITH (&lt;br/&gt;
&#160; &#160;&apos;connector&apos; = &apos;kafka&apos;,&lt;br/&gt;
&#160; &#160;&apos;topic&apos; = &apos;shifang8888&apos;,&lt;br/&gt;
&#160; &apos;properties.bootstrap.servers&apos; = &apos;flinkx1:9092&apos;,&lt;br/&gt;
&#160; &apos;properties.transaction.timeout.ms&apos; = &apos;800000&apos;,&lt;br/&gt;
&#160; &apos;properties.max.block.ms&apos; = &apos;300000&apos;,&lt;br/&gt;
&#160; &#160;&apos;value.format&apos; = &apos;json&apos;,&lt;br/&gt;
&#160; &#160;&apos;sink.parallelism&apos; = &apos;2&apos;,&lt;br/&gt;
&#160; &#160;&apos;sink.delivery-guarantee&apos; = &apos;exactly-once&apos;,&lt;br/&gt;
&#160; &#160;&apos;sink.transactional-id-prefix&apos; = &apos;dtstack9999&apos;);&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;insert into ka15 SELECT&lt;br/&gt;
&#160; name,&lt;br/&gt;
&#160; cnt&lt;br/&gt;
FROM&lt;br/&gt;
&#160; (VALUES (&apos;Bob&apos;,100), (&apos;Alice&apos;,100), (&apos;Greg&apos;,100), (&apos;Bob&apos;,100)) AS NameTable(name,cnt);&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;this is the error:&lt;/p&gt;

&lt;p&gt;Caused by: java.lang.IllegalStateException&lt;br/&gt;
at org.apache.flink.util.Preconditions.checkState(Preconditions.java:177)&lt;br/&gt;
at org.apache.flink.connector.kafka.sink.FlinkKafkaInternalProducer.setTransactionId(FlinkKafkaInternalProducer.java:164)&lt;br/&gt;
at org.apache.flink.connector.kafka.sink.KafkaCommitter.getRecoveryProducer(KafkaCommitter.java:144)&lt;br/&gt;
at org.apache.flink.connector.kafka.sink.KafkaCommitter.lambda$commit$0(KafkaCommitter.java:76)&lt;br/&gt;
at java.util.Optional.orElseGet(Optional.java:267)&lt;br/&gt;
at org.apache.flink.connector.kafka.sink.KafkaCommitter.commit(KafkaCommitter.java:76)&lt;br/&gt;
... 14 more&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
i found the reason why&#160; kafka commit failed, when downstream operator CommitterOperator was commiting transaction, the upstream &#160;operator SinkOperator has closed , it will abort the transaction which&#160; is committing by CommitterOperator, this is occurs when execution.runtime-mode is batch&lt;/p&gt;</description>
                <environment>&lt;p&gt;SET &apos;execution.runtime-mode&apos; = &apos;batch&apos;;&lt;/p&gt;

&lt;p&gt;&#160;CREATE TABLE ka15 (&lt;br/&gt;
&#160; &#160; &#160;name String,&lt;br/&gt;
&#160; &#160; &#160;cnt bigint&lt;br/&gt;
&#160;) WITH (&lt;br/&gt;
&#160; &#160;&apos;connector&apos; = &apos;kafka&apos;,&lt;br/&gt;
&#160; &#160;&apos;topic&apos; = &apos;shifang8888&apos;,&lt;br/&gt;
&#160; &apos;properties.bootstrap.servers&apos; = &apos;flinkx1:9092&apos;,&lt;br/&gt;
&#160; &apos;properties.transaction.timeout.ms&apos; = &apos;800000&apos;,&lt;br/&gt;
&#160; &apos;properties.max.block.ms&apos; = &apos;300000&apos;,&lt;br/&gt;
&#160; &#160;&apos;value.format&apos; = &apos;json&apos;,&lt;br/&gt;
&#160; &#160;&apos;sink.parallelism&apos; = &apos;2&apos;,&lt;br/&gt;
&#160; &#160;&apos;sink.delivery-guarantee&apos; = &apos;exactly-once&apos;,&lt;br/&gt;
&#160; &#160;&apos;sink.transactional-id-prefix&apos; = &apos;dtstack9999&apos;);&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;insert into ka15 SELECT&lt;br/&gt;
&#160; name,&lt;br/&gt;
&#160; cnt&lt;br/&gt;
FROM&lt;br/&gt;
&#160; (VALUES (&apos;Bob&apos;,100), (&apos;Alice&apos;,100), (&apos;Greg&apos;,100), (&apos;Bob&apos;,100)) AS NameTable(name,cnt);&lt;/p&gt;</environment>
        <key id="13414698">FLINK-25126</key>
            <summary>FlinkKafkaInternalProducer state is not reset if transaction finalization fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fpaul">Fabian Paul</assignee>
                                    <reporter username="tonyboo9527">eric yu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 1 Dec 2021 08:11:58 +0000</created>
                <updated>Wed, 15 Dec 2021 01:44:03 +0000</updated>
                            <resolved>Fri, 10 Dec 2021 15:05:10 +0000</resolved>
                                    <version>1.14.0</version>
                    <version>1.15.0</version>
                                    <fixVersion>1.14.3</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17451603" author="lzljs3620320" created="Wed, 1 Dec 2021 08:20:36 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17451606" author="JIRAUSER281032" created="Wed, 1 Dec 2021 08:24:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17451608" author="lzljs3620320" created="Wed, 1 Dec 2021 08:25:39 +0000"  >&lt;p&gt;CC: &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpaul&quot; class=&quot;user-hover&quot; rel=&quot;fpaul&quot;&gt;fpaul&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17451611" author="fabian.paul" created="Wed, 1 Dec 2021 08:29:21 +0000"  >&lt;p&gt;I&apos;ll take that we fix it before releasing 1.14.1&lt;/p&gt;</comment>
                            <comment id="17451669" author="JIRAUSER281032" created="Wed, 1 Dec 2021 09:42:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpaul&quot; class=&quot;user-hover&quot; rel=&quot;fpaul&quot;&gt;fpaul&lt;/a&gt;&#160; hi,I wonder to know your ideas to solve this problem, &lt;br/&gt;
I fix the problem by modify the source code of KafkaWriter, when KafkaWriter executing the method close,before aborting transcation ,I let the thread sleep(transaction.timeout.ms)&lt;/p&gt;</comment>
                            <comment id="17452962" author="fabian.paul" created="Fri, 3 Dec 2021 12:09:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tonyboo9527&quot; class=&quot;user-hover&quot; rel=&quot;tonyboo9527&quot;&gt;tonyboo9527&lt;/a&gt; thanks for the investigation. I had a look and think the problem is a slightly different one. I suspect that somewhere in your Kafka logs the committing failed and was retried. In this case, the old KafkaProducer is reused and a new transactional id is set &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;Unfortunately, if the committing fails &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; we do not reset the `inTransaction` variable so during the recycling it seems that another transaction is still open and it fails. I am preparing a fix to always reset the `inTransaction` variable.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/flink/blob/bbfe6521c2dfe9c48b810e7266e8dc3e5a501f21/flink-connectors/flink-connector-kafka/src/main/java/org/apache/flink/connector/kafka/sink/FlinkKafkaInternalProducer.java#L162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/bbfe6521c2dfe9c48b810e7266e8dc3e5a501f21/flink-connectors/flink-connector-kafka/src/main/java/org/apache/flink/connector/kafka/sink/FlinkKafkaInternalProducer.java#L162&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/flink/blob/bbfe6521c2dfe9c48b810e7266e8dc3e5a501f21/flink-connectors/flink-connector-kafka/src/main/java/org/apache/flink/connector/kafka/sink/FlinkKafkaInternalProducer.java#L97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/bbfe6521c2dfe9c48b810e7266e8dc3e5a501f21/flink-connectors/flink-connector-kafka/src/main/java/org/apache/flink/connector/kafka/sink/FlinkKafkaInternalProducer.java#L97&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17456985" author="fabian.paul" created="Fri, 10 Dec 2021 09:02:49 +0000"  >&lt;p&gt;Merged release-1.14: dccd7f08cde2b13ba4549c94ebbc04ff2c0c5152&lt;/p&gt;</comment>
                            <comment id="17457197" author="fabian.paul" created="Fri, 10 Dec 2021 15:04:50 +0000"  >&lt;p&gt;Merged master: 577648379c2abb429259ac1a46ca6a04550f3dbd&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0x8i0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>