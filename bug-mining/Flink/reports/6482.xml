<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:10:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-27762] Kafka WakeupException during handling splits changes</title>
                <link>https://issues.apache.org/jira/browse/FLINK-27762</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We enable dynamic partition discovery in our flink job, but job failed when kafka partition is changed.&#160;&lt;/p&gt;

&lt;p&gt;Exception detail is shown as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.RuntimeException: One or more fetchers have encountered exception
	at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcherManager.checkErrors(SplitFetcherManager.java:225)
	at org.apache.flink.connector.base.source.reader.SourceReaderBase.getNextFetch(SourceReaderBase.java:169)
	at org.apache.flink.connector.base.source.reader.SourceReaderBase.pollNext(SourceReaderBase.java:130)
	at org.apache.flink.streaming.api.operators.SourceOperator.emitNext(SourceOperator.java:350)
	at org.apache.flink.streaming.runtime.io.StreamTaskSourceInput.emitNext(StreamTaskSourceInput.java:68)
	at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:65)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:496)
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:203)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:809)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:761)
	at org.apache.flink.runtime.taskmanager.Task.runWithSystemExitMonitoring(Task.java:958)
	at org.apache.flink.runtime.taskmanager.Task.restoreAndInvoke(Task.java:937)
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:766)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:575)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.RuntimeException: SplitFetcher thread 0 received unexpected exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; polling the records
	at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher.runOnce(SplitFetcher.java:150)
	at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher.run(SplitFetcher.java:105)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	... 1 more
Caused by: org.apache.kafka.common.errors.WakeupException
	at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.maybeTriggerWakeup(ConsumerNetworkClient.java:511)
	at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:275)
	at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:233)
	at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:224)
	at org.apache.kafka.clients.consumer.KafkaConsumer.position(KafkaConsumer.java:1726)
	at org.apache.kafka.clients.consumer.KafkaConsumer.position(KafkaConsumer.java:1684)
	at org.apache.flink.connector.kafka.source.reader.KafkaPartitionSplitReader.removeEmptySplits(KafkaPartitionSplitReader.java:315)
	at org.apache.flink.connector.kafka.source.reader.KafkaPartitionSplitReader.handleSplitsChanges(KafkaPartitionSplitReader.java:200)
	at org.apache.flink.connector.base.source.reader.fetcher.AddSplitsTask.run(AddSplitsTask.java:51)
	at org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher.runOnce(SplitFetcher.java:142)
	... 6 more &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;After preliminary investigation, according to source code of KafkaSource,&lt;/p&gt;

&lt;p&gt;At first:&#160;&lt;/p&gt;

&lt;p&gt;method &lt;b&gt;org.apache.kafka.clients.consumer.KafkaConsumer.wakeup()&lt;/b&gt; will be called if consumer is polling data.&lt;/p&gt;

&lt;p&gt;Later:&#160;&lt;/p&gt;

&lt;p&gt;method &lt;b&gt;org.apache.kafka.clients.consumer.KafkaConsumer.position()&lt;/b&gt; will be called during handle splits changes.&lt;/p&gt;

&lt;p&gt;Since consumer has been waken up, it will throw WakeUpException.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13446690">FLINK-27762</key>
            <summary>Kafka WakeupException during handling splits changes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="renqs">Qingsheng Ren</assignee>
                                    <reporter username="zoucan">zoucan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 25 May 2022 06:00:13 +0000</created>
                <updated>Fri, 17 Jun 2022 02:45:12 +0000</updated>
                            <resolved>Fri, 17 Jun 2022 02:45:12 +0000</resolved>
                                    <version>1.14.3</version>
                                    <fixVersion>1.15.1</fixVersion>
                    <fixVersion>1.14.6</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17541861" author="martijnvisser" created="Wed, 25 May 2022 07:07:47 +0000"  >&lt;p&gt;Can you please try this with the latest Flink 1.14 and/or Flink 1.15 version? &lt;/p&gt;</comment>
                            <comment id="17541896" author="JIRAUSER289972" created="Wed, 25 May 2022 08:42:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks for your reply.&lt;/p&gt;

&lt;p&gt;I have checked the source code of latest version, but there&apos;s no difference for this part.&lt;/p&gt;

&lt;p&gt;It&apos;s difficult to test since this exception doesn&apos;t happen every time of partition change.&lt;/p&gt;

&lt;p&gt;In my opinion, it happend only if method &lt;b&gt;org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher.wakeUp()&lt;/b&gt; is called while consumer is polling data.&#160;&lt;/p&gt;

&lt;p&gt;In this situation, above method will eventually call &lt;b&gt;org.apache.kafka.clients.consumer.KafkaConsumer.wakeup()&lt;/b&gt;.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// org.apache.flink.connector.base.source.reader.fetcher.SplitFetcher.wakeUp()
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void wakeUp() {
    wakeup = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastRecords == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-comment&quot;&gt;// 1. consumer is polling data, execute org.apache.flink.connector.kafka.source.reader.KafkaPartitionSplitReader.wakeUp() 
&lt;/span&gt;        splitReader.wakeUp()
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        elementsQueue.wakeUpPuttingThread(fetcherIndex);
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// org.apache.flink.connector.kafka.source.reader.KafkaPartitionSplitReader.wakeUp()
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void wakeUp() {
    &lt;span class=&quot;code-comment&quot;&gt;// 2. execute org.apache.kafka.clients.consumer.KafkaConsumer.wakeup()
&lt;/span&gt;    consumer.wakeup();
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And in method&#160;&lt;b&gt;org.apache.flink.connector.kafka.source.reader.KafkaPartitionSplitReader.handleSplitsChanges()&lt;/b&gt;,&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;org.apache.kafka.clients.consumer.KafkaConsumer.position()&lt;/b&gt; will be called.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// org.apache.flink.connector.kafka.source.reader.KafkaPartitionSplitReader.handleSplitsChanges()
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void handleSplitsChanges(SplitsChange&amp;lt;KafkaPartitionSplit&amp;gt; splitsChange) {
    &lt;span class=&quot;code-comment&quot;&gt;// ignore irrelevant code...
&lt;/span&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// 3.execute &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.removeEmptySplits()
&lt;/span&gt; &#160; removeEmptySplits();

    maybeLogSplitChangesHandlingResult(splitsChange);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// org.apache.flink.connector.kafka.source.reader.KafkaPartitionSplitReader.removeEmptySplits()
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void removeEmptySplits() {
    List&amp;lt;TopicPartition&amp;gt; emptyPartitions = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
   
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (TopicPartition tp : consumer.assignment()) {
        &lt;span class=&quot;code-comment&quot;&gt;// 4. execute org.apache.kafka.clients.consumer.KafkaConsumer.position()
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// since kafka consumer is waken up before, it will &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; WakeUpException.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (consumer.position(tp) &amp;gt;= getStoppingOffset(tp)) {
            emptyPartitions.add(tp);
        }
    }

 &#160; &lt;span class=&quot;code-comment&quot;&gt;// ignore irrelevant code... &#160; &#160; 
&lt;/span&gt;} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Since our application is already online, we must evaluate the risk for upgrading version.&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;ll try to test with latest version and share the result.&#160; And If you have any suggestion, please share with me.&lt;/p&gt;</comment>
                            <comment id="17541907" author="martijnvisser" created="Wed, 25 May 2022 08:55:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt; WDYT?&lt;/p&gt;</comment>
                            <comment id="17541932" author="renqs" created="Wed, 25 May 2022 09:30:01 +0000"  >&lt;p&gt;Thanks for reporting the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zoucan&quot; class=&quot;user-hover&quot; rel=&quot;zoucan&quot;&gt;zoucan&lt;/a&gt;! I think it is indeed a bug that hard to reproduce. It could only happen if the wakeup operation is triggered after KafkaConsumer#poll returns and the flow is still in KafkaPartitionSplitReader#fetch.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt;&#160;could you assign the ticket to me? Thanks&lt;/p&gt;</comment>
                            <comment id="17541933" author="martijnvisser" created="Wed, 25 May 2022 09:32:07 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt; I&apos;ve assigned it to you!&lt;/p&gt;</comment>
                            <comment id="17543756" author="JIRAUSER289972" created="Mon, 30 May 2022 02:44:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks for your effort for this issue.&lt;/p&gt;

&lt;p&gt;I&#8216;ve reviewed your pr and i have a question. The exception i met is in method &lt;b&gt;KafkaPartitionSplitReader#removeEmptySplits&lt;/b&gt;. But i can&apos;t find any action for handling this exception in that method.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// org.apache.flink.connector.kafka.source.reader.KafkaPartitionSplitReader#removeEmptySplits
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void removeEmptySplits() {
    List&amp;lt;TopicPartition&amp;gt; emptyPartitions = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
   
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (TopicPartition tp : consumer.assignment()) {
        &lt;span class=&quot;code-comment&quot;&gt;// WakeUpException is thrown here.
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// since KafkaConsumer#wakeUp is called before,&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; execute KafkaConsumer#postion() in &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; statement&apos;&lt;/span&gt; above, it will &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; WakeUpException.   
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (consumer.position(tp) &amp;gt;= getStoppingOffset(tp)) {
            emptyPartitions.add(tp);
        }
    }

 &#160; &lt;span class=&quot;code-comment&quot;&gt;// ignore irrelevant code... &#160; &#160; 
&lt;/span&gt;} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Maybe we should check whether &lt;b&gt;KafkaConsumer#wakeUp&lt;/b&gt; is called before, or catch WakeUpException in &lt;b&gt;KafkaPartitionSplitReader#removeEmptySplits.&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="17543766" author="renqs" created="Mon, 30 May 2022 03:21:19 +0000"  >&lt;p&gt;Thanks a lot for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zoucan&quot; class=&quot;user-hover&quot; rel=&quot;zoucan&quot;&gt;zoucan&lt;/a&gt;&#160;! What about moving the discussion about code and PRs to Github?&lt;/p&gt;</comment>
                            <comment id="17545668" author="mason6345" created="Thu, 2 Jun 2022 21:43:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt;, I also recently encountered a similar issue internally&lt;/p&gt;

&lt;p&gt;&amp;gt; It could only happen if the wakeup operation is triggered after KafkaConsumer#poll returns and the flow is still in KafkaPartitionSplitReader#fetch.&#160;&lt;/p&gt;

&lt;p&gt;I don&apos;t think so, because the exception is thrown from handling the split changes.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17554556" author="leonard xu" created="Wed, 15 Jun 2022 12:38:59 +0000"  >&lt;p&gt;fixed in &lt;br/&gt;
master(1.16):50c19d9f534f86e228f3e0937d92baf766a57165&lt;br/&gt;
release-1.15:a5c0c8776cb06507f12a00c93bd92a7ac6d18375&lt;br/&gt;
release-1.14: 4c9d99bbb5f3f250643b3a057866ec98cce04359&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z12nr4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>