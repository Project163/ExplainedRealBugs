<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:29:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7656] Switch to user ClassLoader when invoking initializeOnMaster finalizeOnMaster</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7656</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The contract that Flink provides to usercode is that that the usercode classloader is the context classloader whenever usercode is called.&lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;OutputFormatVertex&lt;/tt&gt; usercode is called in the &lt;tt&gt;initializeOnMaster()&lt;/tt&gt; and &lt;tt&gt;finalizeOnMaster()&lt;/tt&gt; methods but the context classloader is not set to the usercode classloader.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13103612">FLINK-7656</key>
            <summary>Switch to user ClassLoader when invoking initializeOnMaster finalizeOnMaster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fhueske">Fabian Hueske</assignee>
                                    <reporter username="fhueske">Fabian Hueske</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Sep 2017 14:13:00 +0000</created>
                <updated>Mon, 12 Mar 2018 15:41:17 +0000</updated>
                            <resolved>Mon, 12 Mar 2018 15:41:17 +0000</resolved>
                                    <version>1.3.2</version>
                                    <fixVersion>1.3.4</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16173502" author="githubbot" created="Wed, 20 Sep 2017 17:02:02 +0000"  >&lt;p&gt;GitHub user fhueske opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4690&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4690&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7656&quot; title=&quot;Switch to user ClassLoader when invoking initializeOnMaster finalizeOnMaster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7656&quot;&gt;&lt;del&gt;FLINK-7656&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Switch to user classloader before calling initializeOnMaster and finalizeOnMaster.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Fixes a classloading issue for `OutputFormat`s that implement `InitializeOnMaster` or `FinalizeOnMaster`. The initialize and finalize methods are called without setting the context classloader to the usercode classloader.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul&gt;
	&lt;li&gt;Set the context classloader to the usercode classloader before calling `InitializeOnMaster.initializeGlobal()` and `FinalizeOnMaster.finalizeGlobal()` and restore the original classloader afterwards.&lt;/li&gt;
	&lt;li&gt;Extend test to check that the correct classloader is set.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul&gt;
	&lt;li&gt;Run `JobTaskVertexTest.testOutputFormatVertex()`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The serializers: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: *&lt;b&gt;YES&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? *&lt;b&gt;n/a&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/fhueske/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/fhueske/flink&lt;/a&gt; outputOnMasterFix&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4690.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4690.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4690&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2dfc8a4550981b9b8c417585dfb5e02b3282c77a&lt;br/&gt;
Author: Fabian Hueske &amp;lt;fhueske@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-09-20T14:26:47Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7656&quot; title=&quot;Switch to user ClassLoader when invoking initializeOnMaster finalizeOnMaster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7656&quot;&gt;&lt;del&gt;FLINK-7656&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Switch to user classloader before calling initializeOnMaster and finalizeOnMaster.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16176316" author="githubbot" created="Fri, 22 Sep 2017 11:57:57 +0000"  >&lt;p&gt;Github user fhueske commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4690&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4690&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Can you take a brief look at this change @aljoscha? Thanks!&lt;/p&gt;</comment>
                            <comment id="16176537" author="githubbot" created="Fri, 22 Sep 2017 14:58:34 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4690#discussion_r140515705&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4690#discussion_r140515705&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/jobgraph/JobTaskVertexTest.java &amp;#8212;&lt;br/&gt;
    @@ -84,10 +88,10 @@ public void testConnectMultipleTargets() {&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testOutputFormatVertex() {&lt;br/&gt;
     		try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final TestingOutputFormat outputFormat = new TestingOutputFormat();&lt;br/&gt;
    +			final OutputFormat outputFormat = new TestingOutputFormat();&lt;br/&gt;
     			final OutputFormatVertex of = new OutputFormatVertex(&quot;Name&quot;);&lt;br/&gt;
     			new TaskConfig(of.getConfiguration()).setStubWrapper(new UserCodeObjectWrapper&amp;lt;OutputFormat&amp;lt;?&amp;gt;&amp;gt;(outputFormat));&lt;/li&gt;
	&lt;li&gt;final ClassLoader cl = getClass().getClassLoader();&lt;br/&gt;
    +			final ClassLoader cl = new FlinkUserCodeClassLoader(new URL&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, getClass().getClassLoader());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This doesn&apos;t exist anymore but you can use `FlinkUserCodeClassLoaders.childFirst()`/`parentFirst()`.&lt;/p&gt;</comment>
                            <comment id="16176659" author="githubbot" created="Fri, 22 Sep 2017 16:19:32 +0000"  >&lt;p&gt;Github user fhueske commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4690&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4690&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @aljoscha.&lt;br/&gt;
    I&apos;ll change that and merge the fix.&lt;/p&gt;</comment>
                            <comment id="16177217" author="githubbot" created="Fri, 22 Sep 2017 21:58:09 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4690&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4690&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16177220" author="fhueske" created="Fri, 22 Sep 2017 21:59:42 +0000"  >&lt;p&gt;Fixed for 1.3.3 with 9a8b515c03d21023df4939af02a9ae87c9439284&lt;br/&gt;
Fixed for 1.4.0 with 4afca4b3a13b61c2754bc839c77ba4d4eb1d2da2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 8 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kasf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>