<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:22:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-38137] RocksDB State Backend Null Serialization Causes NPE and Asymmetric (De)Serialization Logic</title>
                <link>https://issues.apache.org/jira/browse/FLINK-38137</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The RocksDB state backend has a critical flaw in its handling of null values, which can cause NullPointerExceptions and create unnecessary serialization overhead.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Problem%C2%A0Description&quot;&gt;&lt;/a&gt;Problem&#160;Description&lt;/h3&gt;

&lt;p&gt;In&#160;&lt;a href=&quot;https://github.com/raminqaf/flink/blob/main/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/state/rocksdb/AbstractRocksDBState.java#L179-L179&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AbstractRocksDBState, the&#160;serializeValueNullSensitive()&lt;/a&gt;&#160;method unconditionally calls the&#160;serializer even&#160;when the value is null:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;T&amp;gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] serializeValueNullSensitive(T value, TypeSerializer&amp;lt;T&amp;gt; serializer)
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&#160; &#160; dataOutputView.clear();
&#160; &#160; dataOutputView.writeBoolean(value == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;); &#160;&lt;span class=&quot;code-comment&quot;&gt;// Write &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; flag
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; serializeValueInternal(value, serializer); &#160;&lt;span class=&quot;code-comment&quot;&gt;// Always serialize, even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &amp;lt;T&amp;gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] serializeValueInternal(T value, TypeSerializer&amp;lt;T&amp;gt; serializer)
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&#160; &#160; serializer.serialize(value, dataOutputView); &#160;&lt;span class=&quot;code-comment&quot;&gt;// Can &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; NPE &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; value is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; dataOutputView.getCopyOfBuffer();
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This&#160;design has&#160;two&#160;major&#160;flaws:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;NPE Risk: The behavior&#160;becomes&#160;dependent&#160;on the TypeSerializer implementation. Serializers not&#160;designed to handle null inputs&#160;will throw NullPointerException.&lt;/li&gt;
	&lt;li&gt;Asymmetric Logic: There&apos;s a&#160;critical&#160;mismatch between serialization and deserialization:&lt;/li&gt;
&lt;/ol&gt;


&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;Serialization: Writes&#160;null flag&#160;+ always&#160;attempts to serialize the&#160;value object&#160;(even if&#160;null)&lt;/li&gt;
		&lt;li&gt;Deserialization: Reads null flag + immediately returns null without attempting deserialization if flag is true&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;&lt;a name=&quot;Evidence%C2%A0from%C2%A0DeserializationCode&quot;&gt;&lt;/a&gt;Evidence&#160;from&#160;Deserialization Code&lt;/h3&gt;

&lt;p&gt;In&#160;&lt;a href=&quot;https://github.com/apache/flink/blob/bf1cd860617f7b51ac91516814c0e931e5bba241/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/state/rocksdb/RocksDBMapState.java#L413&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RocksDBMapState&lt;/a&gt;, the&#160;deserialization logic&#160;shows&#160;this asymmetry:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;UV&amp;gt; UV deserializeValueNullSensitive(
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rawValueBytes,
&#160; &#160; &#160; &#160; TypeSerializer&amp;lt;UV&amp;gt; valueSerializer)
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&#160; &#160; dataInputView.setBuffer(rawValueBytes);
&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isNull = dataInputView.readBoolean();
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; isNull ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : valueSerializer.deserialize(dataInputView); &#160;&lt;span class=&quot;code-comment&quot;&gt;// Never deserializes &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13624384">FLINK-38137</key>
            <summary>RocksDB State Backend Null Serialization Causes NPE and Asymmetric (De)Serialization Logic</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fanrui">Rui Fan</assignee>
                                    <reporter username="raminqaf">Ramin Gharib</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 23 Jul 2025 12:22:19 +0000</created>
                <updated>Fri, 26 Sep 2025 08:37:59 +0000</updated>
                            <resolved>Wed, 30 Jul 2025 08:58:35 +0000</resolved>
                                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>1.20.3</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="18009251" author="JIRAUSER308434" created="Wed, 23 Jul 2025 12:59:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=raminqaf&quot; class=&quot;user-hover&quot; rel=&quot;raminqaf&quot;&gt;raminqaf&lt;/a&gt; This seems to be a straightforward fix for&lt;br/&gt;
serializeValueNullSensitive&lt;br/&gt;
, where we handle the NULL case by returning the copy of the internal buffer&apos;s current content, which would be just the boolean isNull &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. Can I take this up?&lt;br/&gt;
Ideally, it should neither try to serialise or deserialise null values.&lt;/p&gt;

&lt;p&gt;Let me know if this is right understanding?&lt;/p&gt;</comment>
                            <comment id="18009255" author="JIRAUSER304722" created="Wed, 23 Jul 2025 13:21:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nishita0905&quot; class=&quot;user-hover&quot; rel=&quot;nishita0905&quot;&gt;nishita0905&lt;/a&gt; This gets more complicated if you have a MapView of&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;MapView&amp;lt;String, Integer&amp;gt; s&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And then you&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;s.put(&quot;nullValue&quot;, null);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
The value passed to &lt;b&gt;&lt;em&gt;serializeValueNullSensitive&lt;/em&gt;&lt;/b&gt; is not null but is an object of type &lt;b&gt;&lt;em&gt;TtlValue&lt;/em&gt;&lt;/b&gt; with a &lt;em&gt;&lt;b&gt;userValue&lt;/b&gt;&lt;/em&gt; field of null. This causes deserialization errors in some restore tests I am trying to implement for the PTFs.&lt;/p&gt;</comment>
                            <comment id="18010347" author="fanrui" created="Mon, 28 Jul 2025 10:38:23 +0000"  >&lt;p&gt;Merged to&lt;/p&gt;

&lt;p&gt;master(2.2.0) via: 70b673406299fa518300a8ef3bdfcd7899358f63 and 8c8bcecd8d564f6da3ecad521aaab86c5b9fa960&lt;/p&gt;

&lt;p&gt;2.1.1 via: 9faac10f84f56029afbbf6e6a4459762428d2160 and d2a88f6b0e87a637fd0759c7205e93af2f4d1a6f&lt;/p&gt;

&lt;p&gt;2.0.1 via: fca72ea1acd2b8974e2aca1682034f47e08927e7 and db43791a5af26b3e222117fdf67a2dcf064ddc33&lt;/p&gt;

&lt;p&gt;1.20.3 via: fca72ea1acd2b8974e2aca1682034f47e08927e7 and db43791a5af26b3e222117fdf67a2dcf064ddc33&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13629557">FLINK-38408</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1wwyo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>