<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:52:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21351] Incremental checkpoint data would be lost once a non-stop savepoint completed</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21351</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10354&quot; title=&quot;Savepoints should be counted as retained checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10354&quot;&gt;&lt;del&gt;FLINK-10354&lt;/del&gt;&lt;/a&gt; counted savepoint as retained checkpoint so that job could failover from latest position. I think this operation is reasonable, however, current implementation would let incremental checkpoint data lost immediately once a non-stop savepoint completed.&lt;/p&gt;

&lt;p&gt;Current general phase of incremental checkpoints: once a newer checkpoint completed, it would be added to checkpoint store. And if the size of completed checkpoints larger than max retained limit, it would subsume the oldest one. This lead to the reference of incremental data decrease one and data would be deleted once reference reached to zero. As we always ensure to register newer checkpoint and then unregister older checkpoint, current phase works fine as expected.&lt;/p&gt;

&lt;p&gt;However, if a non-stop savepoint (a median manual trigger savepoint) is completed, it would be also added into checkpoint store and just subsume previous added checkpoint (in default retain one checkpoint case), which would unregister older checkpoint without newer checkpoint registered, leading to data lost.&lt;/p&gt;

&lt;p&gt;Thanks for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=banmoy&quot; class=&quot;user-hover&quot; rel=&quot;banmoy&quot;&gt;banmoy&lt;/a&gt; reporting this problem first.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13357954">FLINK-21351</key>
            <summary>Incremental checkpoint data would be lost once a non-stop savepoint completed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="yunta">Yun Tang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 10 Feb 2021 15:16:49 +0000</created>
                <updated>Wed, 3 Mar 2021 21:49:34 +0000</updated>
                            <resolved>Tue, 23 Feb 2021 15:59:25 +0000</resolved>
                                    <version>1.11.3</version>
                    <version>1.12.1</version>
                    <version>1.13.0</version>
                                    <fixVersion>1.12.2</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17282547" author="till.rohrmann" created="Wed, 10 Feb 2021 16:21:41 +0000"  >&lt;p&gt;The problem seems to be that the TaskManager side has its own bookkeeping of already uploaded SST files in &lt;tt&gt;RocksIncrementalSnapshotStrategy&lt;/tt&gt; which can diverge from the &lt;tt&gt;JM&lt;/tt&gt; side in the case of savepoints.&lt;/p&gt;</comment>
                            <comment id="17282550" author="dawidwys" created="Wed, 10 Feb 2021 16:25:10 +0000"  >&lt;p&gt;To be clear, RocksDB incremental checkpoints + savepoints without cancel is the only faulty combination, right?&lt;/p&gt;</comment>
                            <comment id="17282554" author="till.rohrmann" created="Wed, 10 Feb 2021 16:30:06 +0000"  >&lt;p&gt;I think so yes.&lt;/p&gt;</comment>
                            <comment id="17282867" author="yunta" created="Thu, 11 Feb 2021 05:55:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; yes, once a savepoint completed, the previous added incremental checkpoint would be subsumed. If the job is cancelled and savepoint would be used to restore for next running, everything is fine. However, if the job is still running and still depends on checkpoint mechanism for failover, this would cause unrecoverable data lost.&lt;/p&gt;</comment>
                            <comment id="17282968" author="till.rohrmann" created="Thu, 11 Feb 2021 10:29:31 +0000"  >&lt;p&gt;Would it work if we don&apos;t count savepoints towards the number of maximum retained checkpoints? That way we would only remove checkpoints if a non-savepoint is being added. Consequently, we would maintain the assumption on which the current implementation of incremental checkpoints are built that SST files are only deleted if there is no other checkpoint relying on it.&lt;/p&gt;

&lt;p&gt;Implementation wise this could be done by introducing a separate checkpoint counter to the &lt;tt&gt;DefaultCompletedCheckpointStore&lt;/tt&gt;. It adds a bit of logic to always keep this counter correctly set but it should be a rather small change.&lt;/p&gt;</comment>
                            <comment id="17286040" author="roman_khachatryan" created="Wed, 17 Feb 2021 18:06:50 +0000"  >&lt;p&gt;I think that would work but would keep savepoints not subsumed unnecessarily.&lt;/p&gt;

&lt;p&gt;A little bit different approach would allow to subsume savepoints too:&lt;br/&gt;
1. Iterate through the completed checkpoints starting from the earliest &lt;br/&gt;
2. Subsume a checkpoint if it&apos;s earlier than the last checkpoint-not-savepoint&lt;br/&gt;
3. Subsume a savepoint if it&apos;s not the last one&lt;br/&gt;
4. Break whenever checkpoints.size &amp;lt;= maxRetain&lt;/p&gt;

&lt;p&gt;I&apos;ve published a PR with this change, could you take a look: &lt;a href=&quot;https://github.com/apache/flink/pull/14953?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/14953?&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17286454" author="till.rohrmann" created="Thu, 18 Feb 2021 12:42:08 +0000"  >&lt;p&gt;I think that this should work a bit better at the cost of higher complexity.&lt;/p&gt;</comment>
                            <comment id="17286455" author="till.rohrmann" created="Thu, 18 Feb 2021 12:42:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; can you help with the review?&lt;/p&gt;</comment>
                            <comment id="17294788" author="uce" created="Wed, 3 Mar 2021 20:11:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&#160;The ticket includes fixVersion 1.11.4. Are you planning to open a PR against the release-1.11 branch?&lt;/p&gt;</comment>
                            <comment id="17294844" author="roman_khachatryan" created="Wed, 3 Mar 2021 21:49:34 +0000"  >&lt;p&gt;No, I don&apos;t plan to backport the fix to 1.11&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=uce&quot; class=&quot;user-hover&quot; rel=&quot;uce&quot;&gt;uce&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve removed 1.11.4 fixVersion.&lt;/p&gt;

&lt;p&gt;Sorry for confusion.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 36 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0nkag:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>