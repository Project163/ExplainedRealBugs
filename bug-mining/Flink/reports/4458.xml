<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:48:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18581] Cannot find GC cleaner with java version previous jdk8u72(-b01)</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18581</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;tt&gt;JavaGcCleanerWrapper&lt;/tt&gt; is looking for the package-private method &lt;tt&gt;Reference.tryHandlePending&lt;/tt&gt;&#160;using reflection. However, the method is first introduced in the version jdk8u72(-b01). Therefore, if an older version JDK is used, the method cannot be found and Flink will fail.&lt;/p&gt;

&lt;p&gt;See also this &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Error-GC-Cleaner-Provider-Flink-1-11-0-td36565.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ML thread&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13316403">FLINK-18581</key>
            <summary>Cannot find GC cleaner with java version previous jdk8u72(-b01)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="azagrebin">Andrey Zagrebin</assignee>
                                    <reporter username="xtsong">Xintong Song</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 13 Jul 2020 09:12:36 +0000</created>
                <updated>Wed, 29 Jul 2020 07:45:06 +0000</updated>
                            <resolved>Tue, 28 Jul 2020 11:27:14 +0000</resolved>
                                    <version>1.11.0</version>
                                    <fixVersion>1.11.2</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17156584" author="xintongsong" created="Mon, 13 Jul 2020 09:13:05 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17161312" author="azagrebin" created="Mon, 20 Jul 2020 15:13:21 +0000"  >&lt;p&gt;Reference.tryHandlePending was introduced somewhen before&#160;8u202 (I have 8u172 where it works).&lt;/p&gt;

&lt;p&gt;I checked 8u40, it looks like JVM did not have the optimisation of triggering the GC phantom cleaner queue in direct memory reservation. They just tried one GC call which is quite suboptimal for us. Somewhere after&#160;8u40, they factored out&#160;java.lang.ref.Reference#ReferenceHandler#run into static Reference#tryHandlePending to enable the&#160;optimisation.&lt;/p&gt;

&lt;p&gt;java.lang.ref.Reference#ReferenceHandler#run is quite similar to&#160;Reference#tryHandlePending in 8u40. We could create an instance of&#160;ReferenceHandler, which is stateless, and call its run method, which uses the same static vars of&#160;Reference class.&lt;/p&gt;

&lt;p&gt;Not sure that it is really worth the effort. So alternatively, I can binary-find the JVM version where they introduced the Reference#tryHandlePending and we can update the 1.11 release notes that we support Java 8 starting from that build.&lt;br/&gt;
cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17162073" author="till.rohrmann" created="Tue, 21 Jul 2020 14:35:49 +0000"  >&lt;p&gt;I found the first occurrence of &lt;tt&gt;Reference.tryHandlePending&lt;/tt&gt; to be introduced in OpenJDK with the version jdk8u72-b01 &lt;a href=&quot;http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/5ad1e9e8e841/src/share/classes/java/lang/ref/Reference.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/5ad1e9e8e841/src/share/classes/java/lang/ref/Reference.java&lt;/a&gt;. This version should be already a couple of years old.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; I think calling &lt;tt&gt;Reference.ReferenceHandler.run&lt;/tt&gt; would not work because it is an infinite loop.&lt;/p&gt;

&lt;p&gt;I think this is price we are paying for using internal JVM methods which can change across minor versions and which is very unfortunate. Let&apos;s keep this as a warning for the future and let&apos;s try to avoid it.&lt;/p&gt;

&lt;p&gt;I see two ways forward:&lt;/p&gt;

&lt;p&gt;1) Only support Java8 version later or equal than jdk8u72-b01. This would entail that we throw an appropriate exception with a clear message saying that one needs to update the java version. The main problem I see with this approach is that other JVM implementation (other than OpenJDK) might not have these private methods. Have we ever tried running Flink with a different JVM implementation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;? Moreover, there is no guarantee that this method won&apos;t disappear in some future version.&lt;br/&gt;
2) Getting rid of the clean up mechanism which relies on internal JVM methods and implement our own mechanism. This solution which involve a much higher effort, though.&lt;/p&gt;

&lt;p&gt;Maybe there is also some middle ground by trying to call &lt;tt&gt;tryHandlerPending&lt;/tt&gt; and if this method does not exist to fall back to triggering the normal GC or some other mean to trigger the clean up.&lt;/p&gt;</comment>
                            <comment id="17162096" author="azagrebin" created="Tue, 21 Jul 2020 15:00:06 +0000"  >&lt;p&gt;True, I overlooked the loop in&#160;ReferenceHandler.run.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;1) Only support Java8 version later or equal than jdk8u72-b01. This would entail that we throw an appropriate exception with a clear message saying that one needs to update the java version. The main problem I see with this approach is that other JVM implementation (other than OpenJDK) might not have these private methods. Have we ever tried running Flink with a different JVM implementation&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;? Moreover, there is no guarantee that this method won&apos;t disappear in some future version.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I have Oracle JVM locally which I tried. Oracle&#160;jdk8u72 has the required method.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I think this is price we are paying for using internal JVM methods which can change across minor versions and which is very unfortunate. Let&apos;s keep this as a warning for the future and let&apos;s try to avoid it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I totally agree&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;2) Getting rid of the clean up mechanism which relies on internal JVM methods and implement our own mechanism. This solution which involve a much higher effort, though.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is hard to achieve our goal. We need to run release once the memory link is ready for GC which can be detected only by GC. Or we have to change the memory API/semantics somehow.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Maybe there is also some middle ground by trying to call&#160;&lt;tt&gt;tryHandlerPending&lt;/tt&gt;&#160;and if this method does not exist to fall back to triggering the normal GC or some other mean to trigger the clean up.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is an option. We can wait a bit before calling GC to call it not so often and give some time to the previous GC call. This is less performant and we can output warning about the JVM version in this case. I can try it.&lt;/p&gt;</comment>
                            <comment id="17166351" author="azagrebin" created="Tue, 28 Jul 2020 11:27:14 +0000"  >&lt;p&gt;merged into master by&#160;2f03841d5414f9d4a4b810810317c0250065264e&lt;/p&gt;

&lt;p&gt;merged into 1.11 by&#160;fe95187edfe742b64a1f7147e57856c931ef05c3&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0gp0o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>