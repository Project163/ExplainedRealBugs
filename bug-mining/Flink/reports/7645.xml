<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:21:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-30899] FileSystemTableSource with CSV format incorrectly selects fields if filtering for partition</title>
                <link>https://issues.apache.org/jira/browse/FLINK-30899</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In my testing it only affected csv and testcsv formats.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think it&apos;s caused by `FileSystemTableSource` calling `DeserializationFormatFactory#createRuntimeDecoder` with wrong `physicalDataType`. The files won&apos;t contain the partitioned field values, but in case of a projection pushdown (which can happen during planning phase if we filter the partition field by a constant value) the final `physicalDataType` passed to the deserializer by `FileSystemTableSource` will contain the partitioned fields as well. As described in `DecodingFormat`, every field in the `physicalDataType` parameter will have to be present in the serialized record.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE test_table (
&#160; f0 INT,
&#160; f1 INT,
&#160; f2 INT,
&#160; f3 INT
) PARTITIONED BY (f0,f1) WITH (
&#160; &lt;span class=&quot;code-quote&quot;&gt;&apos;connector&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;filesystem&apos;&lt;/span&gt;,
&#160; &lt;span class=&quot;code-quote&quot;&gt;&apos;path&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;file:&lt;span class=&quot;code-comment&quot;&gt;///path/to/whatever&apos;&lt;/span&gt;,
&lt;/span&gt;&#160; &lt;span class=&quot;code-quote&quot;&gt;&apos;format&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;csv&apos;&lt;/span&gt;
)

SELECT * FROM test_table WHERE f0 = 1;
-- !!!! should be 1,4,7,10 !!!! 
+-------------+-------------+-------------+-------------+
| &#160; &#160; &#160; &#160; &#160;f0 | &#160; &#160; &#160; &#160; &#160;f1 | &#160; &#160; &#160; &#160; &#160;f2 | &#160; &#160; &#160; &#160; &#160;f3 |
+-------------+-------------+-------------+-------------+
| &#160; &#160; &#160; &#160; &#160; 1 | &#160; &#160; &#160; &#160; &#160; 4 | &#160; &#160; &#160; &#160; &#160;10 | &#160; &#160; &#160; &#160; &#160; 0 |
+-------------+-------------+-------------+-------------+

SELECT * FROM test_table;
+-------------+-------------+-------------+-------------+
| &#160; &#160; &#160; &#160; &#160;f0 | &#160; &#160; &#160; &#160; &#160;f1 | &#160; &#160; &#160; &#160; &#160;f2 | &#160; &#160; &#160; &#160; &#160;f3 |
+-------------+-------------+-------------+-------------+
| &#160; &#160; &#160; &#160; &#160; 2 | &#160; &#160; &#160; &#160; &#160; 5 | &#160; &#160; &#160; &#160; &#160; 8 | &#160; &#160; &#160; &#160; &#160;11 |
| &#160; &#160; &#160; &#160; &#160; 1 | &#160; &#160; &#160; &#160; &#160; 4 | &#160; &#160; &#160; &#160; &#160; 7 | &#160; &#160; &#160; &#160; &#160;10 |
| &#160; &#160; &#160; &#160; &#160; 3 | &#160; &#160; &#160; &#160; &#160; 6 | &#160; &#160; &#160; &#160; &#160; 9 | &#160; &#160; &#160; &#160; &#160;12 |
+-------------+-------------+-------------+-------------+

SELECT * FROM test_table WHERE f0&amp;gt;0;
+-------------+-------------+-------------+-------------+
| &#160; &#160; &#160; &#160; &#160;f0 | &#160; &#160; &#160; &#160; &#160;f1 | &#160; &#160; &#160; &#160; &#160;f2 | &#160; &#160; &#160; &#160; &#160;f3 |
+-------------+-------------+-------------+-------------+
| &#160; &#160; &#160; &#160; &#160; 1 | &#160; &#160; &#160; &#160; &#160; 4 | &#160; &#160; &#160; &#160; &#160; 7 | &#160; &#160; &#160; &#160; &#160;10 |
| &#160; &#160; &#160; &#160; &#160; 3 | &#160; &#160; &#160; &#160; &#160; 6 | &#160; &#160; &#160; &#160; &#160; 9 | &#160; &#160; &#160; &#160; &#160;12 |
| &#160; &#160; &#160; &#160; &#160; 2 | &#160; &#160; &#160; &#160; &#160; 5 | &#160; &#160; &#160; &#160; &#160; 8 | &#160; &#160; &#160; &#160; &#160;11 |
+-------------+-------------+-------------+-------------+

SELECT * FROM test_table WHERE f0 = 1 AND f1 = 4;
...
Caused by: java.lang.ArrayIndexOutOfBoundsException: Index -1 out of bounds &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; length 4
&#160; &#160; at org.apache.flink.types.parser.IntParser.parseField(IntParser.java:49)
&#160; &#160; at org.apache.flink.types.parser.IntParser.parseField(IntParser.java:27)
&#160; &#160; at org.apache.flink.types.parser.FieldParser.resetErrorStateAndParse(FieldParser.java:101)
&#160; &#160; at org.apache.flink.formats.testcsv.TestCsvDeserializationSchema.deserialize(TestCsvDeserializationSchema.java:92)
&#160; &#160; at org.apache.flink.formats.testcsv.TestCsvDeserializationSchema.deserialize(TestCsvDeserializationSchema.java:42)
&#160; &#160; at org.apache.flink.api.common.serialization.DeserializationSchema.deserialize(DeserializationSchema.java:82)
... &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At &lt;a href=&quot;https://github.com/apache/flink/blob/b1e70aebd3e248d68cf41a43db385ec9c9b6235a/flink-connectors/flink-connector-files/src/main/java/org/apache/flink/connector/file/table/FileSystemTableSource.java#L147&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/b1e70aebd3e248d68cf41a43db385ec9c9b6235a/flink-connectors/flink-connector-files/src/main/java/org/apache/flink/connector/file/table/FileSystemTableSource.java#L147&lt;/a&gt; the `physicalRowDataType` will contain the partition fields as well, but `partitionKeysToExtract` will not contain it since `producedDataType` has been modified in the `applyProjection` method, so it will result in an empty projection. Then on line 154 we construct the final `physicalDataType`, but since `partitionKeysProjections` is empty, it will result with the same value as `physicalDataType` which contains the partition fields too.&lt;/p&gt;

&lt;p&gt;By changing&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Projection partitionKeysProjections = Projection.fromFieldNames(physicalDataType, partitionKeysToExtract);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Projection partitionKeysProjections = Projection.fromFieldNames(physicalDataType, partitionKeys);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the issue can be solved. I have verified this solution with 1 and 2 partition keys, with and without metadata columns, with and without virtual columns. But I still need to test this change with other formats.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If this solution seems correct and a committer could assign me to the JIRA I can start working on it&lt;/p&gt;</description>
                <environment></environment>
        <key id="13523077">FLINK-30899</key>
            <summary>FileSystemTableSource with CSV format incorrectly selects fields if filtering for partition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mateczagany">Mate Czagany</assignee>
                                    <reporter username="mateczagany">Mate Czagany</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sat, 4 Feb 2023 16:04:13 +0000</created>
                <updated>Sat, 12 Oct 2024 07:19:31 +0000</updated>
                            <resolved>Sat, 12 Oct 2024 07:19:31 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>1.17.0</version>
                    <version>1.18.0</version>
                    <version>1.19.0</version>
                    <version>1.20.0</version>
                                    <fixVersion>1.19.2</fixVersion>
                    <fixVersion>1.20.1</fixVersion>
                    <fixVersion>2.0-preview</fixVersion>
                                    <component>Connectors / FileSystem</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17684455" author="luoyuxia" created="Mon, 6 Feb 2023 07:08:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mateczagany&quot; class=&quot;user-hover&quot; rel=&quot;mateczagany&quot;&gt;mateczagany&lt;/a&gt; Thanks for reporting. I think it&apos;s the right solution. Please go head and open a pr, we will happy to help review.&#160;&lt;/p&gt;

&lt;p&gt;I don&apos;t have right to assign ticket, may &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; help assign ticket.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17686337" author="JIRAUSER298834" created="Thu, 9 Feb 2023 10:02:02 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luoyuxia&quot; class=&quot;user-hover&quot; rel=&quot;luoyuxia&quot;&gt;luoyuxia&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have created a PR, can you please take a look at it when you have the time?&lt;/p&gt;</comment>
                            <comment id="17757112" author="flink-jira-bot" created="Mon, 21 Aug 2023 22:35:14 +0000"  >&lt;p&gt;I am the &lt;a href=&quot;https://github.com/apache/flink-jira-bot/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Flink Jira Bot&lt;/a&gt; and I help the community manage its development. I see this issue is assigned but has not received an update in 30 days, so it has been labeled &quot;stale-assigned&quot;.&lt;br/&gt;
If you are still working on the issue, please remove the label and add a comment updating the community on your progress.  If this issue is waiting on feedback, please consider this a reminder to the committer/reviewer. Flink is a very active project, and so we appreciate your patience.&lt;br/&gt;
If you are no longer working on the issue, please unassign yourself so someone else may work on it.&lt;/p&gt;</comment>
                            <comment id="17883018" author="JIRAUSER298834" created="Thu, 19 Sep 2024 13:46:01 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luoyuxia&quot; class=&quot;user-hover&quot; rel=&quot;luoyuxia&quot;&gt;luoyuxia&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Can you please take a look when you have time? The issue is still present, I have rebased the PR.&lt;/p&gt;</comment>
                            <comment id="17888125" author="JIRAUSER306586" created="Thu, 10 Oct 2024 04:52:00 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mateczagany&quot; class=&quot;user-hover&quot; rel=&quot;mateczagany&quot;&gt;mateczagany&lt;/a&gt;, i think it would worth to backport the fix to the 1.19 and 1.20 branches, would you mind opening PRs to those as well?&#160;&lt;/p&gt;</comment>
                            <comment id="17888126" author="JIRAUSER306586" created="Thu, 10 Oct 2024 04:52:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/commit/08b1859cf253ade90e5d6469adc6346b3be7e012&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;08b1859&lt;/tt&gt;&lt;/a&gt; in master&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/commit/9e7794bf4b87c90ca0876df1229f8e9d2d200cf9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;9e7794b&lt;/tt&gt;&lt;/a&gt; in release-1.20&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/commit/117a219d282caebdfe5817e6b356f8697c2154c9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;117a219&lt;/tt&gt;&lt;/a&gt; in release-1.19&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1fnig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>