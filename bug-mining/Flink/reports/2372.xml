<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8836] Duplicating a KryoSerializer does not duplicate registered default serializers</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8836</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;duplicate()&lt;/tt&gt;&#160;method of the &lt;tt&gt;KryoSerializer&lt;/tt&gt;&#160;is as following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; KryoSerializer&amp;lt;T&amp;gt; duplicate() {
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KryoSerializer&amp;lt;&amp;gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
}

&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; KryoSerializer(KryoSerializer&amp;lt;T&amp;gt; toCopy) {
&#160; &#160; defaultSerializers = toCopy.defaultSerializers;
&#160; &#160; defaultSerializerClasses = toCopy.defaultSerializerClasses;

&#160; &#160; kryoRegistrations = toCopy.kryoRegistrations;

&#160; &#160; ...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Shortly put, when duplicating a &lt;tt&gt;KryoSerializer&lt;/tt&gt;, the &lt;tt&gt;defaultSerializers&lt;/tt&gt;&#160;serializer instances are directly provided to the new &lt;tt&gt;KryoSerializer&lt;/tt&gt;&#160;instance.&lt;br/&gt;
 This causes the fact that those default serializers are shared across two different &lt;tt&gt;KryoSerializer&lt;/tt&gt;&#160;instances, and therefore not a correct duplicate.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13142079">FLINK-8836</key>
            <summary>Duplicating a KryoSerializer does not duplicate registered default serializers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="tzulitai">Tzu-Li (Gordon) Tai</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Mar 2018 11:25:52 +0000</created>
                <updated>Wed, 2 Oct 2019 17:46:02 +0000</updated>
                            <resolved>Fri, 25 May 2018 03:42:46 +0000</resolved>
                                                    <fixVersion>1.4.3</fixVersion>
                    <fixVersion>1.5.0</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>API / Type Serialization System</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16383510" author="stephanewen" created="Fri, 2 Mar 2018 11:56:02 +0000"  >&lt;p&gt;Is the concern that the default serializers themselves are stateful?&lt;/p&gt;

&lt;p&gt;As far as I understood it so far, the Kryo object is stateful and not thread safe, hence needs to be exclusive to one thread at a time. Kryo does the tracking of object graphs and generic scopes, which makes it not thread safe during serialization / deserialization.&lt;br/&gt;
The serializers used by Kryo should be stateless and can thus sharable.&lt;/p&gt;

&lt;p&gt;Please double check this assumption - if the serializers are actually stateful, then we need to see how we can handle that.&lt;br/&gt;
If they are not, we should be able to close this issue.&lt;/p&gt;</comment>
                            <comment id="16383515" author="tzulitai" created="Fri, 2 Mar 2018 12:01:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; I think they can be stateful.&lt;/p&gt;

&lt;p&gt;All built-in Kryo default serializers, AFAIK, are stateless. However, users can also register their own serializer implementations via&#160;the &lt;tt&gt;ExecutionConfig&lt;/tt&gt;, making them potentially stateful. The &lt;tt&gt;KryoSerializer&lt;/tt&gt; recognizes these user registrations and adds them to the Kryo object.&lt;/p&gt;</comment>
                            <comment id="16383734" author="stephanewen" created="Fri, 2 Mar 2018 15:56:54 +0000"  >&lt;p&gt;I see. We can check what Kryo&apos;s philosophy on serializers is, but I would assume that they should be stateless. It seems quite exotic to make those stateful.&lt;/p&gt;

&lt;p&gt;Personally, I cannot recall a case when there ever was a stateful Kryo serializer. We could clearly document and require that in user-defined Kryo serializers.&lt;/p&gt;

&lt;p&gt;Going to the point that we pro-actively serialization-copy all user-defined serializers is possible as well, as a hard last resort. We could do that for all serializers that have fields and are passed not as classes, but objects.&lt;/p&gt;</comment>
                            <comment id="16383737" author="stephanewen" created="Fri, 2 Mar 2018 15:58:42 +0000"  >&lt;p&gt;I would actually not classify this as critical but rather minor or major, because it is unclear if this is an issue Flink should handle (stateful Kryo serializers could simply be a non-permitted construct) and to the best of my knowledge, we never had a user that did that.&lt;/p&gt;</comment>
                            <comment id="16413781" author="facboy" created="Mon, 26 Mar 2018 12:38:03 +0000"  >&lt;p&gt;I don&apos;t think they are thread-safe:&#160;&lt;a href=&quot;https://github.com/EsotericSoftware/kryo#threading&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/EsotericSoftware/kryo#threading&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16415372" author="stephanewen" created="Tue, 27 Mar 2018 10:05:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=facboy&quot; class=&quot;user-hover&quot; rel=&quot;facboy&quot;&gt;facboy&lt;/a&gt; Yes, but we are not using Kryo across threads, each thread has its own Kryo instance.&lt;br/&gt;
We are referring here to custom serializers that one can register at Kryo.&lt;/p&gt;</comment>
                            <comment id="16415826" author="facboy" created="Tue, 27 Mar 2018 15:51:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; i asked on the Kryo mailing list and the answer (possibly not authoritative) was that given that &lt;tt&gt;Kryo&lt;/tt&gt;&#160;itself is not intended to be thread-safe, we probably shouldn&apos;t&#160;assume that&#160;implementations&#160;of &lt;tt&gt;com.esotericsoftware.kryo.Serializer&lt;/tt&gt;&#160;are thread-safe.&lt;/p&gt;

&lt;p&gt;I&apos;d suggest we should actually assume the opposite.&lt;/p&gt;</comment>
                            <comment id="16442589" author="srichter" created="Wed, 18 Apr 2018 14:29:14 +0000"  >&lt;p&gt;Hi, I have seen a report on the mailing list that could bring a decision to this issue. The user was registering a &lt;tt&gt;ProtobufSerializer&lt;/tt&gt; as default serializer and it caused problems because the serializer was obviously shared between two threads in the async fs backend. His fix was to use a different class in the state that would not go through the default serializer. I think that makes a case for duplicating the serializer for safety reasons, what do you think?&lt;/p&gt;</comment>
                            <comment id="16442667" author="aljoscha" created="Wed, 18 Apr 2018 15:15:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt; How can we duplicate them?&lt;/p&gt;</comment>
                            <comment id="16442673" author="srichter" created="Wed, 18 Apr 2018 15:18:11 +0000"  >&lt;p&gt;That is a very good question, potentially not at all because there is no equivalent to the &lt;tt&gt;duplicate&lt;/tt&gt; method on a kryo serializer.&lt;/p&gt;</comment>
                            <comment id="16443108" author="stephanewen" created="Wed, 18 Apr 2018 19:59:52 +0000"  >&lt;p&gt;They are either serializable, or defined as classes.&lt;br/&gt;
For the first, you can do a serialization copy.&lt;br/&gt;
For the second, re-instantiate the class.&lt;/p&gt;</comment>
                            <comment id="16443973" author="srichter" created="Thu, 19 Apr 2018 12:16:19 +0000"  >&lt;p&gt;Serialization will probably work in most cases, but still has a loophole if it read-resolves to a singleton. Then again, a singleton, non-threadsafe, stateful serializer is probably begging for problems anyways, so that approach might be better than the status quo.&lt;/p&gt;</comment>
                            <comment id="16444041" author="githubbot" created="Thu, 19 Apr 2018 13:16:33 +0000"  >&lt;p&gt;GitHub user StefanRRichter opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8836&quot; title=&quot;Duplicating a KryoSerializer does not duplicate registered default serializers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8836&quot;&gt;&lt;del&gt;FLINK-8836&lt;/del&gt;&lt;/a&gt; Fix duplicate method in KryoSerializer to perform deep c&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;opy of default/registered serializer instances.&lt;/p&gt;

&lt;p&gt;    This method did create deep copies of registered or default serializer instances and&lt;br/&gt;
    as a result those serializer instances can accidentally be shared across different threads.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR fixes a problem with the `duplicate` method of `KryoSerializer`. We do now perform deep copies for default and registered serializer objects.&lt;/p&gt;

&lt;p&gt;    Otherwise, if we share duplicated `KryoSerializer` instances across different threads, some of their internal serializers might be a shared instance of a stateful object. &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change added tests and can be verified by running `KryoSerializerConcurrencyTest`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (indirectly)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? ( no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StefanRRichter/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StefanRRichter/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8836&quot; title=&quot;Duplicating a KryoSerializer does not duplicate registered default serializers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8836&quot;&gt;&lt;del&gt;FLINK-8836&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5880&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 617ebd114b86d8f00d15e53dd649bb633fc717f9&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@...&amp;gt;&lt;br/&gt;
Date:   2018-04-19T13:10:07Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8836&quot; title=&quot;Duplicating a KryoSerializer does not duplicate registered default serializers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8836&quot;&gt;&lt;del&gt;FLINK-8836&lt;/del&gt;&lt;/a&gt; Fix duplicate method in KryoSerializer to perform deep copy of default/registered serializer instances.&lt;/p&gt;

&lt;p&gt;    This method did create deep copies of registered or default serializer instances and&lt;br/&gt;
    as a result those serializer instances can accidentally be shared across different threads.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16444066" author="githubbot" created="Thu, 19 Apr 2018 13:44:24 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880#discussion_r182749960&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880#discussion_r182749960&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/kryo/KryoSerializer.java &amp;#8212;&lt;br/&gt;
    @@ -140,14 +140,37 @@ public KryoSerializer(Class&amp;lt;T&amp;gt; type, ExecutionConfig executionConfig){&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Copy-constructor that does not copy transient fields. They will be initialized once required.&lt;br/&gt;
     	 */&lt;br/&gt;
     	protected KryoSerializer(KryoSerializer&amp;lt;T&amp;gt; toCopy) {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;defaultSerializers = toCopy.defaultSerializers;&lt;/li&gt;
	&lt;li&gt;defaultSerializerClasses = toCopy.defaultSerializerClasses;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;kryoRegistrations = toCopy.kryoRegistrations;&lt;br/&gt;
    +		this.type = checkNotNull(toCopy.type, &quot;Type class cannot be null.&quot;);&lt;br/&gt;
    +		this.defaultSerializerClasses = toCopy.defaultSerializerClasses;&lt;br/&gt;
    +		this.defaultSerializers = new LinkedHashMap&amp;lt;&amp;gt;(toCopy.defaultSerializers.size());&lt;br/&gt;
    +		this.kryoRegistrations = new LinkedHashMap&amp;lt;&amp;gt;(toCopy.kryoRegistrations.size());&lt;br/&gt;
    +&lt;br/&gt;
    +		// deep copy the serializer instances in defaultSerializers&lt;br/&gt;
    +		for (Map.Entry&amp;lt;Class&amp;lt;?&amp;gt;, ExecutionConfig.SerializableSerializer&amp;lt;?&amp;gt;&amp;gt; entry :&lt;br/&gt;
    +			toCopy.defaultSerializers.entrySet()) {&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;type = toCopy.type;&lt;/li&gt;
	&lt;li&gt;if(type == null)
{
    -			throw new NullPointerException(&quot;Type class cannot be null.&quot;);
    +			this.defaultSerializers.put(entry.getKey(), deepCopySerializer(entry.getValue()));
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		// deep copy the serializer instances in kryoRegistrations&lt;br/&gt;
    +		for (Map.Entry&amp;lt;String, KryoRegistration&amp;gt; entry : toCopy.kryoRegistrations.entrySet()) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    One alternative approach to this loop (though I&apos;m not sure would be better), is in the `buildKryoRegistrationsMethod` we always make a copy of the `ExecutionConfig.SerializableSerializer` when instantiating its corresponding `KryoRegistration`.&lt;br/&gt;
    See &lt;a href=&quot;https://github.com/apache/flink/blob/be7c89596a3b9cd8805a90aaf32336ec2759a1f7/flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/kryo/KryoSerializer.java#L537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/be7c89596a3b9cd8805a90aaf32336ec2759a1f7/flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/kryo/KryoSerializer.java#L537&lt;/a&gt;. Here we can make a copy already when building the registrations.&lt;/p&gt;

&lt;p&gt;    Then, when duplicating the `KryoSerializer`, for duplicating the registrations, this would only be a matter of calling `buildKryoRegistrations` again from the execution config because that method would handle stateful serializer registrations properly.&lt;br/&gt;
    IMO, this seems like a cleaner solution. What do you think?&lt;/p&gt;

</comment>
                            <comment id="16444068" author="githubbot" created="Thu, 19 Apr 2018 13:46:23 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880#discussion_r182750453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880#discussion_r182750453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/kryo/KryoSerializer.java &amp;#8212;&lt;br/&gt;
    @@ -140,14 +140,37 @@ public KryoSerializer(Class&amp;lt;T&amp;gt; type, ExecutionConfig executionConfig){&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Copy-constructor that does not copy transient fields. They will be initialized once required.&lt;br/&gt;
     	 */&lt;br/&gt;
     	protected KryoSerializer(KryoSerializer&amp;lt;T&amp;gt; toCopy) {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;defaultSerializers = toCopy.defaultSerializers;&lt;/li&gt;
	&lt;li&gt;defaultSerializerClasses = toCopy.defaultSerializerClasses;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;kryoRegistrations = toCopy.kryoRegistrations;&lt;br/&gt;
    +		this.type = checkNotNull(toCopy.type, &quot;Type class cannot be null.&quot;);&lt;br/&gt;
    +		this.defaultSerializerClasses = toCopy.defaultSerializerClasses;&lt;br/&gt;
    +		this.defaultSerializers = new LinkedHashMap&amp;lt;&amp;gt;(toCopy.defaultSerializers.size());&lt;br/&gt;
    +		this.kryoRegistrations = new LinkedHashMap&amp;lt;&amp;gt;(toCopy.kryoRegistrations.size());&lt;br/&gt;
    +&lt;br/&gt;
    +		// deep copy the serializer instances in defaultSerializers&lt;br/&gt;
    +		for (Map.Entry&amp;lt;Class&amp;lt;?&amp;gt;, ExecutionConfig.SerializableSerializer&amp;lt;?&amp;gt;&amp;gt; entry :&lt;br/&gt;
    +			toCopy.defaultSerializers.entrySet()) {&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;type = toCopy.type;&lt;/li&gt;
	&lt;li&gt;if(type == null)
{
    -			throw new NullPointerException(&quot;Type class cannot be null.&quot;);
    +			this.defaultSerializers.put(entry.getKey(), deepCopySerializer(entry.getValue()));
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		// deep copy the serializer instances in kryoRegistrations&lt;br/&gt;
    +		for (Map.Entry&amp;lt;String, KryoRegistration&amp;gt; entry : toCopy.kryoRegistrations.entrySet()) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    One alternative approach to this loop (though I&apos;m not sure would be better), is in the `buildKryoRegistrationsMethod` we always make a copy of the `ExecutionConfig.SerializableSerializer` when instantiating its corresponding `KryoRegistration`.&lt;br/&gt;
    See &lt;a href=&quot;https://github.com/apache/flink/blob/be7c89596a3b9cd8805a90aaf32336ec2759a1f7/flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/kryo/KryoSerializer.java#L537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/be7c89596a3b9cd8805a90aaf32336ec2759a1f7/flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/kryo/KryoSerializer.java#L537&lt;/a&gt;. Here we can make a copy already when building the registrations.&lt;/p&gt;

&lt;p&gt;    Then, when duplicating the `KryoSerializer`, for duplicating the registrations, this would only be a matter of calling `buildKryoRegistrations` again with the execution config because that method would handle stateful serializer registrations properly.&lt;br/&gt;
    IMO, this seems like a cleaner solution. What do you think?&lt;/p&gt;</comment>
                            <comment id="16444169" author="githubbot" created="Thu, 19 Apr 2018 14:57:01 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880#discussion_r182776735&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880#discussion_r182776735&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/kryo/KryoSerializer.java &amp;#8212;&lt;br/&gt;
    @@ -140,14 +140,37 @@ public KryoSerializer(Class&amp;lt;T&amp;gt; type, ExecutionConfig executionConfig){&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Copy-constructor that does not copy transient fields. They will be initialized once required.&lt;br/&gt;
     	 */&lt;br/&gt;
     	protected KryoSerializer(KryoSerializer&amp;lt;T&amp;gt; toCopy) {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;defaultSerializers = toCopy.defaultSerializers;&lt;/li&gt;
	&lt;li&gt;defaultSerializerClasses = toCopy.defaultSerializerClasses;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;kryoRegistrations = toCopy.kryoRegistrations;&lt;br/&gt;
    +		this.type = checkNotNull(toCopy.type, &quot;Type class cannot be null.&quot;);&lt;br/&gt;
    +		this.defaultSerializerClasses = toCopy.defaultSerializerClasses;&lt;br/&gt;
    +		this.defaultSerializers = new LinkedHashMap&amp;lt;&amp;gt;(toCopy.defaultSerializers.size());&lt;br/&gt;
    +		this.kryoRegistrations = new LinkedHashMap&amp;lt;&amp;gt;(toCopy.kryoRegistrations.size());&lt;br/&gt;
    +&lt;br/&gt;
    +		// deep copy the serializer instances in defaultSerializers&lt;br/&gt;
    +		for (Map.Entry&amp;lt;Class&amp;lt;?&amp;gt;, ExecutionConfig.SerializableSerializer&amp;lt;?&amp;gt;&amp;gt; entry :&lt;br/&gt;
    +			toCopy.defaultSerializers.entrySet()) {&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;type = toCopy.type;&lt;/li&gt;
	&lt;li&gt;if(type == null)
{
    -			throw new NullPointerException(&quot;Type class cannot be null.&quot;);
    +			this.defaultSerializers.put(entry.getKey(), deepCopySerializer(entry.getValue()));
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		// deep copy the serializer instances in kryoRegistrations&lt;br/&gt;
    +		for (Map.Entry&amp;lt;String, KryoRegistration&amp;gt; entry : toCopy.kryoRegistrations.entrySet()) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The problem is that we don&apos;t have the `ExecutionConfig` in the copy constructor.&lt;/p&gt;</comment>
                            <comment id="16444174" author="githubbot" created="Thu, 19 Apr 2018 14:58:53 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880#discussion_r182777472&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880#discussion_r182777472&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/api/java/typeutils/runtime/kryo/KryoSerializerConcurrencyTest.java &amp;#8212;&lt;br/&gt;
    @@ -24,21 +24,71 @@&lt;br/&gt;
     import org.apache.flink.core.testutils.BlockerSync;&lt;br/&gt;
     import org.apache.flink.core.testutils.CheckedThread;&lt;/p&gt;

&lt;p&gt;    +import com.esotericsoftware.kryo.Kryo;&lt;br/&gt;
    +import com.esotericsoftware.kryo.Serializer;&lt;br/&gt;
    +import com.esotericsoftware.kryo.io.Input;&lt;br/&gt;
    +import com.esotericsoftware.kryo.io.Output;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
     import org.junit.Test;&lt;/p&gt;

&lt;p&gt;     import java.io.IOException;&lt;br/&gt;
    +import java.io.Serializable;&lt;/p&gt;

&lt;p&gt;     import static org.junit.Assert.fail;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This tests that the 
{@link KryoSerializer}
&lt;p&gt; properly fails when accessed by two threads&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* concurrently.&lt;br/&gt;
    + * concurrently and that Kryo serializers are properly duplicated to use them in different threads.&lt;br/&gt;
      *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;&amp;lt;b&amp;gt;Important:&amp;lt;/b&amp;gt; This test only works if assertions are activated (-ea) on the JVM&lt;/li&gt;
	&lt;li&gt;when running tests.&lt;br/&gt;
      */&lt;br/&gt;
     public class KryoSerializerConcurrencyTest {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +	@Test&lt;br/&gt;
    +	public void testDuplicateSerializerWithDefaultSerializerClass() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    test names are mixed up, this and the next one should be switched&lt;/p&gt;</comment>
                            <comment id="16445330" author="githubbot" created="Fri, 20 Apr 2018 05:24:39 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1, Will this PR also get into 1.4.x?&lt;/p&gt;</comment>
                            <comment id="16445550" author="githubbot" created="Fri, 20 Apr 2018 09:41:47 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @sihuazhou I think it can and should also go into 1.4.&lt;/p&gt;

&lt;p&gt;    @aljoscha is that a +1 once I have fixed the method names?&lt;/p&gt;</comment>
                            <comment id="16445761" author="githubbot" created="Fri, 20 Apr 2018 14:01:31 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yes, +1 after that is fixed.&lt;/p&gt;</comment>
                            <comment id="16445763" author="githubbot" created="Fri, 20 Apr 2018 14:02:58 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the comments, will fix the names and then merge.&lt;/p&gt;</comment>
                            <comment id="16445981" author="githubbot" created="Fri, 20 Apr 2018 16:21:10 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5880&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16448327" author="srichter" created="Mon, 23 Apr 2018 15:38:55 +0000"  >&lt;p&gt;Merged in:&lt;/p&gt;

&lt;p&gt;master:&#160;321039f783cd5ba0b2a936e6fac7cca3c542ef3b&lt;/p&gt;

&lt;p&gt;release 1.4:&#160;e3433d9300ad4ae35693ff76c2de987a37724c2f&lt;/p&gt;

&lt;p&gt;release 1.5:&#160;537f452d9ae89d55aca6a8907c23494ee553b3ec&lt;/p&gt;</comment>
                            <comment id="16490185" author="tzulitai" created="Fri, 25 May 2018 03:42:19 +0000"  >&lt;p&gt;Reopening to fix incorrect fix version.&lt;br/&gt;
1.4.0 should be 1.4.3.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13179342">FLINK-10160</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qsjb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>