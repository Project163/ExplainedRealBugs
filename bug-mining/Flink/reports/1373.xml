<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4973] Flakey Yarn tests due to recently added latency marker</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4973</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The newly introduced &lt;tt&gt;LatencyMarksEmitter&lt;/tt&gt; emits latency marker on the &lt;tt&gt;Output&lt;/tt&gt;. This can still happen after the underlying &lt;tt&gt;BufferPool&lt;/tt&gt; has been destroyed. The occurring exception is then logged:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-10-29 15:00:48,088 INFO  org.apache.flink.runtime.taskmanager.Task                     - Source: Custom File Source (1/1) switched to FINISHED
2016-10-29 15:00:48,089 INFO  org.apache.flink.runtime.taskmanager.Task                     - Freeing task resources &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Source: Custom File Source (1/1)
2016-10-29 15:00:48,089 INFO  org.apache.flink.yarn.YarnTaskManager                         - Un-registering task and sending &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; execution state FINISHED to JobManager &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task Source: Custom File Source (8fe0f817fa6d960ea33f6e57e0c3891c)
2016-10-29 15:00:48,101 WARN  org.apache.flink.streaming.api.operators.AbstractStreamOperator  - Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; emitting latency marker
java.lang.RuntimeException: Buffer pool is destroyed.
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.emitLatencyMarker(RecordWriterOutput.java:99)
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.emitLatencyMarker(AbstractStreamOperator.java:734)
	at org.apache.flink.streaming.api.operators.StreamSource$LatencyMarksEmitter$1.run(StreamSource.java:134)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:304)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:178)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.IllegalStateException: Buffer pool is destroyed.
	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestBuffer(LocalBufferPool.java:144)
	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestBufferBlocking(LocalBufferPool.java:133)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.sendToTarget(RecordWriter.java:118)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.randomEmit(RecordWriter.java:103)
	at org.apache.flink.streaming.runtime.io.StreamRecordWriter.randomEmit(StreamRecordWriter.java:104)
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.emitLatencyMarker(RecordWriterOutput.java:96)
	... 9 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This exception is clearly related to the shutdown of a stream operator and does not indicate a wrong behaviour. Since the yarn tests simply scan the log for some keywords (including exception) such a case can make them fail.&lt;/p&gt;

&lt;p&gt;Best if we could make sure that the &lt;tt&gt;LatencyMarksEmitter&lt;/tt&gt; would only emit latency marker if the &lt;tt&gt;Output&lt;/tt&gt; would still be active. But we could also simply not log exceptions which occurred after the stream operator has been stopped.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://s3.amazonaws.com/archive.travis-ci.org/jobs/171578846/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://s3.amazonaws.com/archive.travis-ci.org/jobs/171578846/log.txt&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13016630">FLINK-4973</key>
            <summary>Flakey Yarn tests due to recently added latency marker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>test-stability</label>
                    </labels>
                <created>Mon, 31 Oct 2016 15:32:51 +0000</created>
                <updated>Wed, 26 Apr 2017 12:01:45 +0000</updated>
                            <resolved>Tue, 20 Dec 2016 16:49:37 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15622478" author="rmetzger" created="Mon, 31 Oct 2016 15:35:01 +0000"  >&lt;p&gt;Thank you for reporting this issue. I&apos;ll look into it.&lt;/p&gt;</comment>
                            <comment id="15622624" author="stephanewen" created="Mon, 31 Oct 2016 16:18:59 +0000"  >&lt;p&gt;I think the fix should remove the dedicated threadpool from the emitter.&lt;br/&gt;
The Stream Task already has a special threadpool that is also integrated with the life cycle of the task, and aborts timers cleanly and on shutdown so that these situations cannot occur.&lt;/p&gt;</comment>
                            <comment id="15748686" author="githubbot" created="Wed, 14 Dec 2016 15:55:27 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3008&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3008&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4973&quot; title=&quot;Flakey Yarn tests due to recently added latency marker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4973&quot;&gt;&lt;del&gt;FLINK-4973&lt;/del&gt;&lt;/a&gt; Let LatencyMarksEmitter use StreamTask&apos;s ProcessingTimeService&lt;/p&gt;

&lt;p&gt;    The LatencyMarksEmitter class uses now the StreamTask&apos;s ProcessingTimeService to schedule&lt;br/&gt;
    latency mark emission. For that the ProcessingTimeService was extended to have the method&lt;br/&gt;
    scheduleAtFixedRate to schedule repeated tasks. The latency mark emission is such a repeated&lt;br/&gt;
    task.&lt;/p&gt;

&lt;p&gt;    cc @rmetzger.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; fixLatencyMarksEmitter&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3008.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3008.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3008&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c06b3457f2b98969f444da07569656ac07727166&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-12-14T13:53:11Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4973&quot; title=&quot;Flakey Yarn tests due to recently added latency marker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4973&quot;&gt;&lt;del&gt;FLINK-4973&lt;/del&gt;&lt;/a&gt; Let LatencyMarksEmitter use StreamTask&apos;s ProcessingTimeService&lt;/p&gt;

&lt;p&gt;    The LatencyMarksEmitter class uses now the StreamTask&apos;s ProcessingTimeService to schedule&lt;br/&gt;
    latency mark emission. For that the ProcessingTimeService was extended to have the method&lt;br/&gt;
    scheduleAtFixedRate to schedule repeated tasks. The latency mark emission is such a repeated&lt;br/&gt;
    task.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15751279" author="githubbot" created="Thu, 15 Dec 2016 12:46:39 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3008&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3008&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks good to me, +1&lt;/p&gt;</comment>
                            <comment id="15751281" author="githubbot" created="Thu, 15 Dec 2016 12:46:47 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3008&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3008&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Just for curiosity: I think that could have been solved also without extending the ProcessingTimeService for periodic tasks - each task could simply schedule its successor.&lt;/p&gt;</comment>
                            <comment id="15751395" author="githubbot" created="Thu, 15 Dec 2016 13:38:13 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3008&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3008&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    True. The `ProcessingTimeService` extension seemed to me like the slightly cleaner approach (even though, the `ScheduledThreadPoolExecutor` does it in a similar fashion internally). Thanks for the review @StephanEwen.&lt;/p&gt;</comment>
                            <comment id="15751438" author="githubbot" created="Thu, 15 Dec 2016 13:55:01 +0000"  >&lt;p&gt;Github user rmetzger commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3008&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3008&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 to merge.&lt;/p&gt;</comment>
                            <comment id="15754116" author="githubbot" created="Fri, 16 Dec 2016 10:58:11 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3008&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3008&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging this PR.&lt;/p&gt;</comment>
                            <comment id="15764639" author="stephanewen" created="Tue, 20 Dec 2016 16:49:37 +0000"  >&lt;p&gt;Fixed via ab2125b82ed10389dafecf1712efc1f8fb977c11&lt;/p&gt;</comment>
                            <comment id="15764644" author="githubbot" created="Tue, 20 Dec 2016 16:50:31 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3008&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3008&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15814982" author="rmetzger" created="Tue, 10 Jan 2017 13:35:29 +0000"  >&lt;p&gt;Any objections for logging only the exception message in the &lt;tt&gt;LatencyMarksEmitter&lt;/tt&gt; ? Currently, we log the full stack trace, which pollutes the logs.&lt;/p&gt;</comment>
                            <comment id="15814994" author="till.rohrmann" created="Tue, 10 Jan 2017 13:41:03 +0000"  >&lt;p&gt;Where else is the stack trace logged then?&lt;/p&gt;</comment>
                            <comment id="15815053" author="rmetzger" created="Tue, 10 Jan 2017 14:11:17 +0000"  >&lt;p&gt;The stack trace is only logged in the LatencyMarksEmitter. But my job is failing frequently. In a 24 hrs run, I got over 8000 of these stack traces in my log.&lt;/p&gt;</comment>
                            <comment id="15817890" author="stephanewen" created="Wed, 11 Jan 2017 10:14:27 +0000"  >&lt;p&gt;I thought we made use of the Timer Service that is quiesced before shutting down. That should prevent any such exception.&lt;/p&gt;

&lt;p&gt;Confused why this is still occurring...&lt;/p&gt;</comment>
                            <comment id="15818260" author="till.rohrmann" created="Wed, 11 Jan 2017 12:58:10 +0000"  >&lt;p&gt;What exception are you observing exactly &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt;? It should no longer be the &lt;tt&gt;RejectedExecutionException&lt;/tt&gt; because we should be using the operators timer service.&lt;/p&gt;</comment>
                            <comment id="15819056" author="rmetzger" created="Wed, 11 Jan 2017 20:23:58 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2017-01-10 04:59:22,578 INFO  org.apache.flink.runtime.taskmanager.Task                     - Task Source: sale event generator (4/20) is already in state CANCELING
2017-01-10 04:59:22,578 INFO  org.apache.flink.runtime.taskmanager.Task                     - Triggering cancellation of task code Sink: control events sink (4/20) (85881281bb76d124a85b50156f59b0fd).
2017-01-10 04:59:22,579 WARN  org.apache.flink.streaming.api.operators.AbstractStreamOperator  - Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; emitting latency marker.
java.lang.RuntimeException: Buffer pool is destroyed.
        at org.apache.flink.streaming.runtime.io.RecordWriterOutput.emitLatencyMarker(RecordWriterOutput.java:99)
        at org.apache.flink.streaming.runtime.tasks.OperatorChain$BroadcastingOutputCollector.emitLatencyMarker(OperatorChain.java:445)
        at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.emitLatencyMarker(AbstractStreamOperator.java:743)
        at org.apache.flink.streaming.api.operators.StreamSource$LatencyMarksEmitter$1.onProcessingTime(StreamSource.java:142)
        at org.apache.flink.streaming.runtime.tasks.SystemProcessingTimeService$RepeatedTriggerTask.run(SystemProcessingTimeService.java:256)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:304)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:178)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.IllegalStateException: Buffer pool is destroyed.
        at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestBuffer(LocalBufferPool.java:149)
        at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestBufferBlocking(LocalBufferPool.java:138)
        at org.apache.flink.runtime.io.network.api.writer.RecordWriter.sendToTarget(RecordWriter.java:126)
        at org.apache.flink.runtime.io.network.api.writer.RecordWriter.randomEmit(RecordWriter.java:102)
        at org.apache.flink.streaming.runtime.io.StreamRecordWriter.randomEmit(StreamRecordWriter.java:104)
        at org.apache.flink.streaming.runtime.io.RecordWriterOutput.emitLatencyMarker(RecordWriterOutput.java:96)
        ... 11 more
2017-01-10 04:59:22,581 WARN  org.apache.flink.streaming.api.operators.AbstractStreamOperator  - Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; emitting latency marker.
java.lang.RuntimeException: Buffer pool is destroyed.
        at org.apache.flink.streaming.runtime.io.RecordWriterOutput.emitLatencyMarker(RecordWriterOutput.java:99)
        at org.apache.flink.streaming.runtime.tasks.OperatorChain$BroadcastingOutputCollector.emitLatencyMarker(OperatorChain.java:445)
        at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.emitLatencyMarker(AbstractStreamOperator.java:743)
        at org.apache.flink.streaming.api.operators.StreamSource$LatencyMarksEmitter$1.onProcessingTime(StreamSource.java:142)
        at org.apache.flink.streaming.runtime.tasks.SystemProcessingTimeService$RepeatedTriggerTask.run(SystemProcessingTimeService.java:256)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:304)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:178)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.IllegalStateException: Buffer pool is destroyed.
        at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestBuffer(LocalBufferPool.java:149)
        at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestBufferBlocking(LocalBufferPool.java:138)
        at org.apache.flink.runtime.io.network.api.writer.RecordWriter.sendToTarget(RecordWriter.java:126)
        at org.apache.flink.runtime.io.network.api.writer.RecordWriter.randomEmit(RecordWriter.java:102)
        at org.apache.flink.streaming.runtime.io.StreamRecordWriter.randomEmit(StreamRecordWriter.java:104)
        at org.apache.flink.streaming.runtime.io.RecordWriterOutput.emitLatencyMarker(RecordWriterOutput.java:96)
        ... 11 more
2017-01-10 04:59:22,581 INFO  org.apache.flink.runtime.taskmanager.Task                     - Attempting to fail task externally Source: product impressions generator (fast) (4/20) (c92e73b4f0898d1e21d1aa9d245fe4e7).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15820897" author="till.rohrmann" created="Thu, 12 Jan 2017 12:31:57 +0000"  >&lt;p&gt;I think that exactly for these cases it is not good to remove logging of exceptions. Instead we should check the lifecycle assumptions of the timer service and the buffer pools. If it cannot be corrected and does not indicate a bug, then we could think about filtering out this specific exceptions. But the filtering could also happen on the user level when you parse the actual log.&lt;/p&gt;</comment>
                            <comment id="15821266" author="stephanewen" created="Thu, 12 Jan 2017 15:32:35 +0000"  >&lt;p&gt;I think the problem is the following: An inner component logs errors, without being able to place them into context.&lt;/p&gt;

&lt;p&gt;Most other operators simply forward exceptions and let the stream task decide whether this is actually log-worthy (when happening during regular execution) or whether this can be ignored (for example as a side effect of cancellation). The same should happen here...&lt;/p&gt;</comment>
                            <comment id="15965884" author="dernasherbrezon" created="Wed, 12 Apr 2017 13:46:23 +0000"  >&lt;p&gt;Was able to reproduce in 1.2.0. &lt;/p&gt;

&lt;p&gt;It looks like components shutdown in wrong sequence. For example SystemProcessingTimeService has:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shutdownService() {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (status.compareAndSet(STATUS_ALIVE, STATUS_SHUTDOWN) || 
				status.compareAndSet(STATUS_QUIESCED, STATUS_SHUTDOWN))
		{
			timerService.shutdownNow();
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which means it won&apos;t wait while tasks terminate. And cause the exception above in the following sequence:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;SystemProcessingTimeService call shutdown now and continue termination sequence.
	&lt;ul&gt;
		&lt;li&gt;OutputFlusher thread got termination event&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;LocalBufferPool got termination request before OutputFlusher&lt;/li&gt;
	&lt;li&gt;Exception in logs.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There are several ways to fix that:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Await thread pool termination&lt;/li&gt;
	&lt;li&gt;Properly handle InterruptedException. The following catch is not a correct way of handling InterruptedException.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;			&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
				&lt;span class=&quot;code-comment&quot;&gt;// ignore on close
&lt;/span&gt;			}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here is good article on how to handle such exceptions: &lt;a href=&quot;https://www.ibm.com/developerworks/library/j-jtp05236/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.ibm.com/developerworks/library/j-jtp05236/index.html&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15972667" author="till.rohrmann" created="Tue, 18 Apr 2017 13:31:24 +0000"  >&lt;p&gt;Hi Andrey,&lt;/p&gt;

&lt;p&gt;thanks for reporting this issue. You&apos;re right that shutting the timer service down without waiting for the completion of the timer tasks can lead to such a problem. We should introduce a short timeout. However, I fear that this will only mitigate the problem, because theoretically it is possible that the emit latency marker call waits infinitely long in case of back pressure. Therefore, we won&apos;t solve this problem completely. I would like to open a new issue for that.&lt;/p&gt;

&lt;p&gt;Concerning the handling of &lt;tt&gt;InterruptedExceptions&lt;/tt&gt; you&apos;re right that at some places they might not be treated entirely correct. However, I don&apos;t see how this relates to the described problem, because the interrupted exception handling is not reached by the code path for the latency marker emission if I&apos;m not mistaken.&lt;/p&gt;</comment>
                            <comment id="15972693" author="till.rohrmann" created="Tue, 18 Apr 2017 13:48:14 +0000"  >&lt;p&gt;I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6319&quot; title=&quot;Add timeout when shutting SystemProcessingTimeService down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6319&quot;&gt;&lt;del&gt;FLINK-6319&lt;/del&gt;&lt;/a&gt; to track the proper shutdown of the &lt;tt&gt;SystemProcessingTimeService&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15972750" author="dernasherbrezon" created="Tue, 18 Apr 2017 14:13:10 +0000"  >&lt;p&gt;Proper handling InterruptedException will make it possible to clean and fast thread pool shutdown. See except from the link:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;The standard thread pool (ThreadPoolExecutor) worker thread implementation is responsive to interruption, so interrupting a task running in a thread pool may have the effect of both canceling the task and notifying the execution thread that the thread pool is shutting down. If the task were to swallow the interrupt request, the worker thread might not learn that an interrupt was requested, which could delay the application or service shutdown.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So it might indirectly affect shutdown sequence. I agree it won&apos;t fix the root cause, but could make life a bit easier &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15978430" author="till.rohrmann" created="Fri, 21 Apr 2017 10:01:26 +0000"  >&lt;p&gt;Hi Andrey,&lt;/p&gt;

&lt;p&gt;could you share the logs for the failing YARN test case with me? I&apos;d like to see how the test case failure could actually happen because we should wait for all timer tasks to be finished before closing the thread pool (via calling &lt;tt&gt;ProcessingTimeSerivce#quiesceAndAwaitPending&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="15978513" author="dernasherbrezon" created="Fri, 21 Apr 2017 11:00:48 +0000"  >&lt;p&gt;Actually we were able to reproduce this stacktrace in the running Flink cluster. &lt;/p&gt;</comment>
                            <comment id="15980957" author="till.rohrmann" created="Mon, 24 Apr 2017 10:06:16 +0000"  >&lt;p&gt;Did it happen when a job was cancelled? If this is the case, then it is not a problem, because in the wake of a job failure, exceptions are allowed to appear due to the cancelling operation.&lt;/p&gt;</comment>
                            <comment id="15981426" author="dernasherbrezon" created="Mon, 24 Apr 2017 16:10:17 +0000"  >&lt;p&gt;This was happen during the job cancellation. However it was controlled job shutdown, when no Exceptions are expected. It&apos;s not very straightforward to reproduce, but I will try to attach more info here.&lt;/p&gt;</comment>
                            <comment id="15984659" author="dernasherbrezon" created="Wed, 26 Apr 2017 12:01:45 +0000"  >&lt;p&gt;Here is more logs. Job was executed for some time and then was cancelled from the cli:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2017-04-26 11:26:44,209 INFO  org.apache.flink.runtime.taskmanager.Task                     - Attempting to cancel task Source: Custom Source (2/2) (62b7b08d204abbb64f03325032b6d7b5). [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-14]
2017-04-26 11:26:44,209 INFO  org.apache.flink.runtime.taskmanager.Task                     - Source: Custom Source (2/2) (62b7b08d204abbb64f03325032b6d7b5) switched from RUNNING to CANCELING. [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-14]
2017-04-26 11:26:44,213 INFO  org.apache.flink.runtime.taskmanager.Task                     - Triggering cancellation of task code Source: Custom Source (2/2) (62b7b08d204abbb64f03325032b6d7b5). [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-14]
2017-04-26 11:26:44,216 INFO  org.apache.flink.runtime.taskmanager.Task                     - Attempting to cancel task Map (2/2) (32731388b322028553940b6c65216398). [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-14]
2017-04-26 11:26:44,216 INFO  org.apache.flink.runtime.taskmanager.Task                     - Map (2/2) (32731388b322028553940b6c65216398) switched from RUNNING to CANCELING. [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-14]
2017-04-26 11:26:44,218 INFO  org.apache.flink.runtime.taskmanager.Task                     - Triggering cancellation of task code Map (2/2) (32731388b322028553940b6c65216398). [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-14]
2017-04-26 11:26:44,222 WARN  org.apache.flink.streaming.api.operators.AbstractStreamOperator  - Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; emitting latency marker. [Time Trigger &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Source: Custom Source (2/2)]
java.lang.RuntimeException: Buffer pool is destroyed.
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.emitLatencyMarker(RecordWriterOutput.java:99)
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.emitLatencyMarker(AbstractStreamOperator.java:791)
	at org.apache.flink.streaming.api.operators.StreamSource$LatencyMarksEmitter$1.onProcessingTime(StreamSource.java:142)
	at org.apache.flink.streaming.runtime.tasks.SystemProcessingTimeService$RepeatedTriggerTask.run(SystemProcessingTimeService.java:256)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.IllegalStateException: Buffer pool is destroyed.
	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestBuffer(LocalBufferPool.java:149)
	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestBufferBlocking(LocalBufferPool.java:138)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.sendToTarget(RecordWriter.java:131)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.randomEmit(RecordWriter.java:106)
	at org.apache.flink.streaming.runtime.io.StreamRecordWriter.randomEmit(StreamRecordWriter.java:104)
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.emitLatencyMarker(RecordWriterOutput.java:96)
	... 10 more
2017-04-26 11:26:44,320 INFO  org.apache.flink.runtime.taskmanager.Task                     - Source: Custom Source (2/2) (62b7b08d204abbb64f03325032b6d7b5) switched from CANCELING to CANCELED. [Source: Custom Source (2/2)]
2017-04-26 11:26:44,320 INFO  org.apache.flink.runtime.taskmanager.Task                     - Map (2/2) (32731388b322028553940b6c65216398) switched from CANCELING to CANCELED. [Map (2/2)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 29 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35mkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>