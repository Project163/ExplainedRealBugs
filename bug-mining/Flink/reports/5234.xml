<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:55:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-22014] Flink JobManager failed to restart after failure in kubernetes HA setup</title>
                <link>https://issues.apache.org/jira/browse/FLINK-22014</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;After the JobManager pod failed and the new one started, it was not able to recover jobs due to the absence of recovery data in storage - config map pointed at not existing file.&lt;br/&gt;
 &#160;&lt;br/&gt;
 Due to this the JobManager pod entered into the `CrashLoopBackOff`state and was not able to recover - each attempt failed with the same error so the whole cluster became unrecoverable and not operating.&lt;br/&gt;
 &#160;&lt;br/&gt;
 I had to manually delete the config map and start the jobs again without the save point.&lt;br/&gt;
 &#160;&lt;br/&gt;
 If I tried to emulate the failure further by deleting job manager pod manually, the new pod every time recovered well and issue was not reproducible anymore artificially.&lt;br/&gt;
 &#160;&lt;br/&gt;
 Below is the failure log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-03-26 08:22:57,925 INFO org.apache.flink.runtime.resourcemanager.slotmanager.SlotManagerImpl [] - Starting the SlotManager.
 2021-03-26 08:22:57,928 INFO org.apache.flink.runtime.leaderretrieval.DefaultLeaderRetrievalService [] - Starting DefaultLeaderRetrievalService with KubernetesLeaderRetrievalDriver
{configMapName=&lt;span class=&quot;code-quote&quot;&gt;&apos;stellar-flink-cluster-dispatcher-leader&apos;&lt;/span&gt;}.
 2021-03-26 08:22:57,931 INFO org.apache.flink.runtime.jobmanager.DefaultJobGraphStore [] - Retrieved job ids [198c46bac791e73ebcc565a550fa4ff6, 344f5ebc1b5c3a566b4b2837813e4940, 96c4603a0822d10884f7fe536703d811, d9ded24224aab7c7041420b3efc1b6ba] from KubernetesStateHandleStore{configMapName=&lt;span class=&quot;code-quote&quot;&gt;&apos;stellar-flink-cluster-dispatcher-leader&apos;&lt;/span&gt;}
2021-03-26 08:22:57,933 INFO org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Trying to recover job with job id 198c46bac791e73ebcc565a550fa4ff6.
 2021-03-26 08:22:58,029 INFO org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Stopping SessionDispatcherLeaderProcess.
 2021-03-26 08:28:22,677 INFO org.apache.flink.runtime.jobmanager.DefaultJobGraphStore [] - Stopping DefaultJobGraphStore. 2021-03-26 08:28:22,681 ERROR org.apache.flink.runtime.entrypoint.ClusterEntrypoint [] - Fatal error occurred in the cluster entrypoint. java.util.concurrent.CompletionException: org.apache.flink.util.FlinkRuntimeException: Could not recover job with job id 198c46bac791e73ebcc565a550fa4ff6.
   at java.util.concurrent.CompletableFuture.encodeThrowable(Unknown Source) ~[?:?]
   at java.util.concurrent.CompletableFuture.completeThrowable(Unknown Source) [?:?]
   at java.util.concurrent.CompletableFuture$AsyncSupply.run(Unknown Source) [?:?]
   at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source) [?:?]
   at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source) [?:?]
   at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source) [?:?] Caused by: org.apache.flink.util.FlinkRuntimeException: Could not recover job with job id 198c46bac791e73ebcc565a550fa4ff6.
   at org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess.recoverJob(SessionDispatcherLeaderProcess.java:144 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess.recoverJobs(SessionDispatcherLeaderProcess.java:122 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.AbstractDispatcherLeaderProcess.supplyUnsynchronizedIfRunning(AbstractDispatcherLeaderProcess.java:198 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess.recoverJobsIfRunning(SessionDispatcherLeaderProcess.java:113 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2] ... 4 more 
Caused by: org.apache.flink.util.FlinkException: Could not retrieve submitted JobGraph from state handle under jobGraph-198c46bac791e73ebcc565a550fa4ff6. This indicates that the retrieved state handle is broken. Try cleaning the state handle store.
   at org.apache.flink.runtime.jobmanager.DefaultJobGraphStore.recoverJobGraph(DefaultJobGraphStore.java:171 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess.recoverJob(SessionDispatcherLeaderProcess.java:141 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess.recoverJobs(SessionDispatcherLeaderProcess.java:122 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.AbstractDispatcherLeaderProcess.supplyUnsynchronizedIfRunning(AbstractDispatcherLeaderProcess.java:198 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess.recoverJobsIfRunning(SessionDispatcherLeaderProcess.java:113 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2] ... 4 more 
Caused by: java.io.FileNotFoundException: No such file or directory: s3a:&lt;span class=&quot;code-comment&quot;&gt;//XXX-flink-state-eu-central-1-live/recovery/YYY-flink-cluster/submittedJobGraph6797768d0737
&lt;/span&gt;   at org.apache.hadoop.fs.s3a.S3AFileSystem.s3GetFileStatus(S3AFileSystem.java:2255 undefined) ~[?:?]
   at org.apache.hadoop.fs.s3a.S3AFileSystem.innerGetFileStatus(S3AFileSystem.java:2149 undefined) ~[?:?]
   at org.apache.hadoop.fs.s3a.S3AFileSystem.getFileStatus(S3AFileSystem.java:2088 undefined) ~[?:?]
   at org.apache.hadoop.fs.s3a.S3AFileSystem.open(S3AFileSystem.java:699 undefined) ~[?:?]
   at org.apache.hadoop.fs.FileSystem.open(FileSystem.java:950 undefined) ~[?:?]
   at org.apache.flink.fs.s3hadoop.common.HadoopFileSystem.open(HadoopFileSystem.java:131 undefined) ~[?:?]
   at org.apache.flink.fs.s3hadoop.common.HadoopFileSystem.open(HadoopFileSystem.java:37 undefined) ~[?:?]
   at org.apache.flink.core.fs.PluginFileSystemFactory$ClassLoaderFixingFileSystem.open(PluginFileSystemFactory.java:125 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.state.filesystem.FileStateHandle.openInputStream(FileStateHandle.java:68 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.state.RetrievableStreamStateHandle.openInputStream(RetrievableStreamStateHandle.java:66 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.state.RetrievableStreamStateHandle.retrieveState(RetrievableStreamStateHandle.java:58 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.jobmanager.DefaultJobGraphStore.recoverJobGraph(DefaultJobGraphStore.java:162 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess.recoverJob(SessionDispatcherLeaderProcess.java:141 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess.recoverJobs(SessionDispatcherLeaderProcess.java:122 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.AbstractDispatcherLeaderProcess.supplyUnsynchronizedIfRunning(AbstractDispatcherLeaderProcess.java:198 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2]
   at org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess.recoverJobsIfRunning(SessionDispatcherLeaderProcess.java:113 undefined) ~[flink-dist_2.12-1.12.2.jar:1.12.2] ... 4 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13368349">FLINK-22014</key>
            <summary>Flink JobManager failed to restart after failure in kubernetes HA setup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mlushchytski">Mikalai Lushchytski</reporter>
                        <labels>
                            <label>k8s-ha</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 29 Mar 2021 10:59:08 +0000</created>
                <updated>Sun, 3 Dec 2023 06:25:35 +0000</updated>
                            <resolved>Tue, 10 Aug 2021 08:43:47 +0000</resolved>
                                    <version>1.11.3</version>
                    <version>1.12.2</version>
                    <version>1.13.0</version>
                                                    <component>Deployment / Kubernetes</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17311360" author="till.rohrmann" created="Tue, 30 Mar 2021 10:15:15 +0000"  >&lt;p&gt;Do you have the logs of the problematic run &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt;? Could you check whether s3a://XXX-flink-state-eu-central-1-live/recovery/YYY-flink-cluster/submittedJobGraph6797768d0737 really no longer exists? Flink should only remove the submitted &lt;tt&gt;JobGraph&lt;/tt&gt; file after it has removed the entry from the K8s config map. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17311375" author="mlushchytski" created="Tue, 30 Mar 2021 10:29:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, I don&apos;t have the log of failed job manager pod, only the log of the new pod started and I&apos;ve provided it in the description.&lt;/p&gt;

&lt;p&gt;Regarding the recovery data - yes, I verified that the inconsistency actually existed: there was no &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;s3a://XXX-flink-state-eu-central-1-live/recovery/YYY-flink-cluster/submittedJobGraph6797768d0737
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; path in s3, however, the corresponding &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;jobGraph-ZZZ
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; entry in &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;stellar-flink-cluster-dispatcher-leader&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; config map had a metadata pointing at &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;s3a://XXX-flink-state-eu-central-1-live/recovery/YYY-flink-cluster/submittedJobGraph6797768d0737&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; (I&apos;ve base64-decoded the value)&lt;/p&gt;</comment>
                            <comment id="17311377" author="mlushchytski" created="Tue, 30 Mar 2021 10:30:09 +0000"  >&lt;p&gt;So, to sum up - somehow the recovery file has been deleted (or not created before) in s3, but the job metadata in config map referenced this non-existing s3 file.&lt;/p&gt;</comment>
                            <comment id="17311442" author="fly_in_gis" created="Tue, 30 Mar 2021 11:35:24 +0000"  >&lt;p&gt;Refer to the &lt;tt&gt;KubernetesStateHandleStore#releaseAndTryRemove&lt;/tt&gt;, we try to remove the job graph from ConfigMap first and then discard the file on the distributed storage. For the &lt;tt&gt;addAndLock&lt;/tt&gt;, we persist to the DFS first and then write the state handle to the ConfigMap.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So it should not happen the file is deleted but the key in ConfigMap still exists, as well as the creating case.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;One possible cause I could imagine is about the&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21008&quot; title=&quot;Residual HA related Kubernetes ConfigMaps and ZooKeeper nodes when cluster entrypoint received SIGTERM in shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21008&quot;&gt;&lt;del&gt;FLINK-21008&lt;/del&gt;&lt;/a&gt;. We have residual ConfigMaps and start a new Flink application with same cluster-id. Then it could not recover successfully. Since we clean up&#160;the HA related data on DFS first and then delete the ConfigMaps, we may have non-existing job graph in the ConfigMap.&lt;/p&gt;</comment>
                            <comment id="17311488" author="mlushchytski" created="Tue, 30 Mar 2021 12:38:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;, I found some logs just before the new job manager pod was started - below is a part of it:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-03-26 08:20:28,082 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 5610 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 198c46bac791e73ebcc565a550fa4ff6 (1253706 bytes in 657 ms).
2021-03-26 08:21:20,070 INFO  org.apache.flink.runtime.taskexecutor.TaskManagerRunner      [] - RECEIVED SIGNAL 15: SIGTERM. Shutting down as requested.
2021-03-26 08:21:20,071 INFO  org.apache.flink.runtime.state.TaskExecutorLocalStateStoresManager [] - Shutting down TaskExecutorLocalStateStoresManager.
2021-03-26 08:21:20,071 INFO  org.apache.flink.runtime.blob.PermanentBlobCache             [] - Shutting down BLOB cache
2021-03-26 08:21:20,073 INFO  org.apache.flink.runtime.blob.TransientBlobCache             [] - Shutting down BLOB cache
2021-03-26 08:21:20,533 WARN  akka.remote.ReliableDeliverySupervisor                       [] - Association with remote system [akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink@10.2.108.214:6122] has failed, address is now gated &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [50] ms. Reason: [Disassociated]
&lt;/span&gt;2021-03-26 08:21:20,533 WARN  akka.remote.ReliableDeliverySupervisor                       [] - Association with remote system [akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//flink-metrics@10.2.108.214:43541] has failed, address is now gated &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [50] ms. Reason: [Disassociated]
&lt;/span&gt;Shutting down, got signal: Terminated
Will wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; AWS credentials &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; up to 60 s.
2021-03-26 08:21:22,060 INFO  org.apache.flink.runtime.entrypoint.ClusterEntrypoint        [] - RECEIVED SIGNAL 15: SIGTERM. Shutting down as requested.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17312124" author="fly_in_gis" created="Wed, 31 Mar 2021 07:00:23 +0000"  >&lt;p&gt;Could you please check whether you could find the following logs?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Close and clean up all data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
...
Finished cleaning up the high availability data&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17312137" author="mlushchytski" created="Wed, 31 Mar 2021 07:15:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;, I was not able to find neither &quot;Close and clean up all data for&quot;&#160;nor &quot;Finished cleaning up the high availability data&quot; logs.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17312241" author="till.rohrmann" created="Wed, 31 Mar 2021 09:49:10 +0000"  >&lt;p&gt;The SIGTERM signal could still prove &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt; theory that it might be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21008&quot; title=&quot;Residual HA related Kubernetes ConfigMaps and ZooKeeper nodes when cluster entrypoint received SIGTERM in shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21008&quot;&gt;&lt;del&gt;FLINK-21008&lt;/del&gt;&lt;/a&gt;. We are currently working on fixing this problem.&lt;/p&gt;</comment>
                            <comment id="17312980" author="till.rohrmann" created="Thu, 1 Apr 2021 08:19:23 +0000"  >&lt;p&gt;Looking at &lt;tt&gt;AbstractHaServices.closeAndCleanupAllData&lt;/tt&gt; we should actually invert the cleanup order. First we should call &lt;tt&gt;internalCleanup&lt;/tt&gt; to remove the pointers from ZooKeeper/K8s and then only we should remove the blobs from the blob store. This could have caused the problem.&lt;/p&gt;</comment>
                            <comment id="17313033" author="fly_in_gis" created="Thu, 1 Apr 2021 09:13:17 +0000"  >&lt;p&gt;Yes. I agree with you that we should clean up the ConfigMap/ZNodes first. And then the concrete data on the DFS.&lt;/p&gt;</comment>
                            <comment id="17313681" author="fly_in_gis" created="Fri, 2 Apr 2021 07:54:03 +0000"  >&lt;p&gt;I might lead to a wrong direction. From the attached logs, Flink could not find the&#160;submittedJobGraph. However, it is not cleaned up in the &lt;tt&gt;AbstractHaServices.closeAndCleanupAllData&lt;/tt&gt;, but in the &lt;tt&gt;KubernetesStateHandleStore#releaseAndTryRemove&lt;/tt&gt; called by &lt;tt&gt;DefaultJobGraphStore#removeJobGraph&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It is still strange that the job graph existed in the ConfigMap, but file not on the distributed storage.&lt;br/&gt;
 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt; Could you please confirm that whether the parent directory(s3a://XXX-flink-state-eu-central-1-live/recovery/YYY-flink-cluster) existed? &lt;br/&gt;
 &#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
No such file or directory: s3a:&lt;span class=&quot;code-comment&quot;&gt;//XXX-flink-state-eu-central-1-live/recovery/YYY-flink-cluster/submittedJobGraph6797768d0737&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17314242" author="mlushchytski" created="Sat, 3 Apr 2021 11:16:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;, yes, the parent directory existed and it contained `submittedJobGraphXXX` files, but not the ones listed in config map.&lt;/p&gt;</comment>
                            <comment id="17315352" author="till.rohrmann" created="Tue, 6 Apr 2021 08:48:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt; I think the problem is that &lt;tt&gt;AbstractHaServices.closeAndCleanupAllData&lt;/tt&gt; calls &lt;tt&gt;blobStoreService.closeAndCleanupAllData()&lt;/tt&gt; which deletes the blobs from the HA store (in our case S3). If the system now stops after this method has been executed, then we keep the references in the ConfigMap/ZooKeeper but have no longer the blobs available. This should be the problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt; experienced.&lt;/p&gt;</comment>
                            <comment id="17315386" author="fly_in_gis" created="Tue, 6 Apr 2021 09:29:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; But from the exception stack, &quot;submittedJobGraph6797768d0737&quot; could not be found on S3, not the blob files(user jars, artifacts, etc.).&lt;/p&gt;

&lt;p&gt;And we should not have the residual ConfigMap key for submitted job graph since we cleanup it using &lt;tt&gt;KubernetesStateHandleStore#releaseAndTryRemove&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17315409" author="till.rohrmann" created="Tue, 6 Apr 2021 09:54:11 +0000"  >&lt;p&gt;You are right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;. The &lt;tt&gt;DefaultJobGraphStore&lt;/tt&gt; and the the &lt;tt&gt;BlobStore&lt;/tt&gt; are unrelated here. Hence, the problem in &lt;tt&gt;AbstractHaServices.closeAndCleanupAllData&lt;/tt&gt; does not explain the problem.&lt;/p&gt;</comment>
                            <comment id="17315413" author="till.rohrmann" created="Tue, 6 Apr 2021 10:03:24 +0000"  >&lt;p&gt;I guess the best way to move forward from here is to take a look at the full logs. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt; could you provide us with the full logs of the problematic runs? Ideally on &lt;tt&gt;DEBUG&lt;/tt&gt; log level.&lt;/p&gt;</comment>
                            <comment id="17315416" author="mlushchytski" created="Tue, 6 Apr 2021 10:09:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, unfortunately, it happened only once in prod and therefore the log level was &lt;tt&gt;INFO&lt;/tt&gt;,&#160;therefore &lt;tt&gt;DEBUG&lt;/tt&gt; logs are not available. There is no more log except that I&apos;ve already provided.&lt;/p&gt;</comment>
                            <comment id="17315433" author="till.rohrmann" created="Tue, 6 Apr 2021 10:49:41 +0000"  >&lt;p&gt;Hmm, then my only explanation at the moment is that somebody else deleted the submitted job graph from S3.&lt;/p&gt;

&lt;p&gt;Could you share the complete info logs with us? Maybe the contain some hints we haven&apos;t thought about yet.&lt;/p&gt;</comment>
                            <comment id="17315441" author="till.rohrmann" created="Tue, 6 Apr 2021 11:05:33 +0000"  >&lt;p&gt;Looking again at the code of &lt;tt&gt;KubernetesStateHandleStore.releaseAndTryRemove&lt;/tt&gt; could the following happen &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;The call to &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/highavailability/KubernetesStateHandleStore.java#L352&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;deserializeObject&lt;/tt&gt;&lt;/a&gt; fails but the config map update succeeds. Then in &lt;tt&gt;whenComplete&lt;/tt&gt; handler we do not run &lt;tt&gt;discardState&lt;/tt&gt; because &lt;tt&gt;stateHandleRefer&lt;/tt&gt; is empty.&lt;/p&gt;

&lt;p&gt;If this happened, then you should see the following log line &quot;Could not retrieve the state handle of {} from ConfigMap {}.&quot; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17315473" author="mlushchytski" created="Tue, 6 Apr 2021 11:53:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, there is no similar lines in logs&lt;/p&gt;</comment>
                            <comment id="17315479" author="mlushchytski" created="Tue, 6 Apr 2021 12:07:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, I&apos;ve uploaded the&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13023436/13023436_flink-logs.txt.zip&quot; title=&quot;flink-logs.txt.zip attached to FLINK-22014&quot;&gt;flink-logs.txt.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;logs file.&lt;/p&gt;</comment>
                            <comment id="17316021" author="fly_in_gis" created="Wed, 7 Apr 2021 06:34:04 +0000"  >&lt;p&gt;From the attached logs, we could find that the JobManager tried to recover 4 jobs from the store. If only the job graph of &lt;tt&gt;198c46bac791e73ebcc565a550fa4ff6&lt;/tt&gt; could not be found, then I second &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&apos;s comments. Someone else deleted the job graph on S3 manually.&lt;/p&gt;

&lt;p&gt;After checking the codes more, I do not find some potential bugs which could cause such an issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-03-26 08:33:32,175 INFO  org.apache.flink.runtime.jobmanager.DefaultJobGraphStore     [] - Retrieved job ids [198c46bac791e73ebcc565a550fa4ff6, 344f5ebc1b5c3a566b4b2837813e4940, 96c4603a0822d10884f7fe536703d811, d9ded24224aab7c7041420b3efc1b6ba] from KubernetesStateHandleStore{configMapName=&lt;span class=&quot;code-quote&quot;&gt;&apos;stellar-flink-cluster-dispatcher-leader&apos;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17316090" author="mlushchytski" created="Wed, 7 Apr 2021 07:56:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;&#160;, From what I understand, it tried to recover first job and failed, i.e. job graphs were not available for all jobs, not a single one. It&apos;s unlikely that someone removed the files manually from s3 as we have a limited access to it.&lt;/p&gt;</comment>
                            <comment id="17316118" author="fly_in_gis" created="Wed, 7 Apr 2021 08:32:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt; Do you mean all the job graphs for these 4 jobs(&lt;tt&gt;198c46bac791e73ebcc565a550fa4ff6, 344f5ebc1b5c3a566b4b2837813e4940, 96c4603a0822d10884f7fe536703d811, d9ded24224aab7c7041420b3efc1b6ba&lt;/tt&gt;) do not exist on S3?&lt;/p&gt;</comment>
                            <comment id="17316143" author="mlushchytski" created="Wed, 7 Apr 2021 08:57:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;, I mean that from my understanding and from the logs it recovers jobs one by one and it failed on the first from the list -&#160;198c46bac791e73ebcc565a550fa4ff6. I can&apos;t say at the moment whether the all job graphs not existed on s3 or only for&#160;198c46bac791e73ebcc565a550fa4ff6, just want to guess that it might be missing for all.&lt;/p&gt;</comment>
                            <comment id="17316475" author="till.rohrmann" created="Wed, 7 Apr 2021 16:33:47 +0000"  >&lt;p&gt;Added hardening for the &lt;tt&gt;AbstractHaServices.closeAndCleanupAllData&lt;/tt&gt; call which ensures that we first clean up the HA data before cleaning up the blob information:&lt;/p&gt;

&lt;p&gt;master: 9c4da7c3f30dd755562c63cab1283cf5bfaf782f&lt;br/&gt;
1.12.3: 709c4110370b845f42d916a06e56c6026cf2fac8&lt;br/&gt;
1.11.4: 9faa553d5b28b5dfdf4804e8c7e73b52e95624d2&lt;/p&gt;

&lt;p&gt;Note that this does not fix the problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt; is reporting.&lt;/p&gt;</comment>
                            <comment id="17318000" author="till.rohrmann" created="Fri, 9 Apr 2021 13:51:18 +0000"  >&lt;p&gt;In the logs, I couldn&apos;t find anything suspicious. It simply says that Flink can no longer find the job under &lt;tt&gt;s3a://yyyy/recovery/stellar-flink-cluster/submittedJobGraph6797768d0737&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;However, I also found the following line in the logs &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;java.io.FileNotFoundException: No such file or directory: s3a://yyyy/recovery/stellar-flink-cluster/blob/job_d9ded24224aab7c7041420b3efc1b6ba/blob_p-7a8321732b802055a30ecce46aa12d6d7bfc1120-2ea8cb6e2fbe05174ebeb74e141a9ab6&lt;/tt&gt; &lt;/p&gt;

&lt;p&gt;which is logged by a TaskManager. This indicates that some blobs stored in the S3 directory have been deleted. Since I couldn&apos;t find a JobManager restart before this log line (the log is unfortunately not complete), this indicates that something might have indeed messed around with the s3 storage. This could also explain the lost submitted job graph data.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt; could you double check whether there has been some other s3 access to the s3a://yyyy/recovery/stellar-flink-cluster bucket?&lt;/p&gt;</comment>
                            <comment id="17319149" author="till.rohrmann" created="Mon, 12 Apr 2021 08:20:01 +0000"  >&lt;p&gt;Downgrading this ticket for the time being because we could not find the problem in Flink and suspect that this problem could have been caused by some external S3 modifications. If this proves to be wrong, then I will revert the priority downgrade.&lt;/p&gt;</comment>
                            <comment id="17324843" author="mlushchytski" created="Mon, 19 Apr 2021 08:20:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, we faced the same issue again - from what I can see, recovery folder does not contain &lt;tt&gt;submittedJobGraphXXX&lt;/tt&gt; at all, meanwhile config map refers to it and therefore the job manager fails to restart with `CrashLoopBackOff`.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13024271/13024271_image-2021-04-19-11-17-58-215.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;kubectl describe cm cluster-dispatcher-leader&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Data
====
jobGraph-d369cb029bed8f036d3a3a9ba3b78e64:
----
rO0ABXNyADtvcmcuYXBhY2hlLmZsaW5rLnJ1bnRpbWUuc3RhdGUuUmV0cmlldmFibGVTdHJlYW1TdGF0ZUhhbmRsZQABHhjxVZcrAgABTAAYd3JhcHBlZFN0cmVhbVN0YXRlSGFuZGxldAAyTG9yZy9hcGFjaGUvZmxpbmsvcnVudGltZS9zdGF0ZS9TdHJlYW1TdGF0ZUhhbmRsZTt4cHNyADlvcmcuYXBhY2hlLmZsaW5rLnJ1bnRpbWUuc3RhdGUuZmlsZXN5c3RlbS5GaWxlU3RhdGVIYW5kbGUE3HXYYr0bswIAAkoACXN0YXRlU2l6ZUwACGZpbGVQYXRodAAfTG9yZy9hcGFjaGUvZmxpbmsvY29yZS9mcy9QYXRoO3hwAAAAAAABqkdzcgAdb3JnLmFwYWNoZS5mbGluay5jb3JlLmZzLlBhdGgAAAAAAAAAAQIAAUwAA3VyaXQADkxqYXZhL25ldC9VUkk7eHBzcgAMamF2YS5uZXQuVVJJrAF4LkOeSasDAAFMAAZzdHJpbmd0ABJMamF2YS9sYW5nL1N0cmluZzt4cHQAcHMzYTovL3phbGFuZG8tc3RlbGxhci1mbGluay1zdGF0ZS1ldS1jZW50cmFsLTEtbGl2ZS9yZWNvdmVyeS9zdGVsbGFyLWZsaW5rLWNsdXN0ZXIvc3VibWl0dGVkSm9iR3JhcGhhNDJiMTA4MWY1YWN4
jobGraph-d9bd3b398099254d57d871c899d8117c:
----
rO0ABXNyADtvcmcuYXBhY2hlLmZsaW5rLnJ1bnRpbWUuc3RhdGUuUmV0cmlldmFibGVTdHJlYW1TdGF0ZUhhbmRsZQABHhjxVZcrAgABTAAYd3JhcHBlZFN0cmVhbVN0YXRlSGFuZGxldAAyTG9yZy9hcGFjaGUvZmxpbmsvcnVudGltZS9zdGF0ZS9TdHJlYW1TdGF0ZUhhbmRsZTt4cHNyADlvcmcuYXBhY2hlLmZsaW5rLnJ1bnRpbWUuc3RhdGUuZmlsZXN5c3RlbS5GaWxlU3RhdGVIYW5kbGUE3HXYYr0bswIAAkoACXN0YXRlU2l6ZUwACGZpbGVQYXRodAAfTG9yZy9hcGFjaGUvZmxpbmsvY29yZS9mcy9QYXRoO3hwAAAAAAABQq5zcgAdb3JnLmFwYWNoZS5mbGluay5jb3JlLmZzLlBhdGgAAAAAAAAAAQIAAUwAA3VyaXQADkxqYXZhL25ldC9VUkk7eHBzcgAMamF2YS5uZXQuVVJJrAF4LkOeSasDAAFMAAZzdHJpbmd0ABJMamF2YS9sYW5nL1N0cmluZzt4cHQAcHMzYTovL3phbGFuZG8tc3RlbGxhci1mbGluay1zdGF0ZS1ldS1jZW50cmFsLTEtbGl2ZS9yZWNvdmVyeS9zdGVsbGFyLWZsaW5rLWNsdXN0ZXIvc3VibWl0dGVkSm9iR3JhcGhhOWUwNDQ1YWQwMDV4
runningJobsRegistry-8491f68c1c03631714c598a4b614eb35:
----
RUNNING
runningJobsRegistry-c3f2563e46c60f98799f7ce9aa537f0a:
----
RUNNING
runningJobsRegistry-d369cb029bed8f036d3a3a9ba3b78e64:
----
RUNNING
runningJobsRegistry-d9bd3b398099254d57d871c899d8117c:
----
RUNNING
jobGraph-8491f68c1c03631714c598a4b614eb35:
----
rO0ABXNyADtvcmcuYXBhY2hlLmZsaW5rLnJ1bnRpbWUuc3RhdGUuUmV0cmlldmFibGVTdHJlYW1TdGF0ZUhhbmRsZQABHhjxVZcrAgABTAAYd3JhcHBlZFN0cmVhbVN0YXRlSGFuZGxldAAyTG9yZy9hcGFjaGUvZmxpbmsvcnVudGltZS9zdGF0ZS9TdHJlYW1TdGF0ZUhhbmRsZTt4cHNyADlvcmcuYXBhY2hlLmZsaW5rLnJ1bnRpbWUuc3RhdGUuZmlsZXN5c3RlbS5GaWxlU3RhdGVIYW5kbGUE3HXYYr0bswIAAkoACXN0YXRlU2l6ZUwACGZpbGVQYXRodAAfTG9yZy9hcGFjaGUvZmxpbmsvY29yZS9mcy9QYXRoO3hwAAAAAAABQlZzcgAdb3JnLmFwYWNoZS5mbGluay5jb3JlLmZzLlBhdGgAAAAAAAAAAQIAAUwAA3VyaXQADkxqYXZhL25ldC9VUkk7eHBzcgAMamF2YS5uZXQuVVJJrAF4LkOeSasDAAFMAAZzdHJpbmd0ABJMamF2YS9sYW5nL1N0cmluZzt4cHQAcHMzYTovL3phbGFuZG8tc3RlbGxhci1mbGluay1zdGF0ZS1ldS1jZW50cmFsLTEtbGl2ZS9yZWNvdmVyeS9zdGVsbGFyLWZsaW5rLWNsdXN0ZXIvc3VibWl0dGVkSm9iR3JhcGg2ODA0N2NlZjliYWZ4
jobGraph-c3f2563e46c60f98799f7ce9aa537f0a:
----
rO0ABXNyADtvcmcuYXBhY2hlLmZsaW5rLnJ1bnRpbWUuc3RhdGUuUmV0cmlldmFibGVTdHJlYW1TdGF0ZUhhbmRsZQABHhjxVZcrAgABTAAYd3JhcHBlZFN0cmVhbVN0YXRlSGFuZGxldAAyTG9yZy9hcGFjaGUvZmxpbmsvcnVudGltZS9zdGF0ZS9TdHJlYW1TdGF0ZUhhbmRsZTt4cHNyADlvcmcuYXBhY2hlLmZsaW5rLnJ1bnRpbWUuc3RhdGUuZmlsZXN5c3RlbS5GaWxlU3RhdGVIYW5kbGUE3HXYYr0bswIAAkoACXN0YXRlU2l6ZUwACGZpbGVQYXRodAAfTG9yZy9hcGFjaGUvZmxpbmsvY29yZS9mcy9QYXRoO3hwAAAAAAACZ/5zcgAdb3JnLmFwYWNoZS5mbGluay5jb3JlLmZzLlBhdGgAAAAAAAAAAQIAAUwAA3VyaXQADkxqYXZhL25ldC9VUkk7eHBzcgAMamF2YS5uZXQuVVJJrAF4LkOeSasDAAFMAAZzdHJpbmd0ABJMamF2YS9sYW5nL1N0cmluZzt4cHQAcHMzYTovL3phbGFuZG8tc3RlbGxhci1mbGluay1zdGF0ZS1ldS1jZW50cmFsLTEtbGl2ZS9yZWNvdmVyeS9zdGVsbGFyLWZsaW5rLWNsdXN0ZXIvc3VibWl0dGVkSm9iR3JhcGgwZDhmMWY0NjYyZTV4
Events:  &amp;lt;none&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And a similar log again:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR org.apache.flink.runtime.entrypoint.ClusterEntrypoint        [] - Fatal error occurred in the cluster entrypoint.
 15:15:16.372   java.util.concurrent.CompletionException: org.apache.flink.util.FlinkRuntimeException: Could not recover job with job id 8491f68c1c03631714c598a4b614eb35.
 15:15:16.372   Caused by: org.apache.flink.util.FlinkRuntimeException: Could not recover job with job id 8491f68c1c03631714c598a4b614eb35.
 15:15:16.372   Caused by: org.apache.flink.util.FlinkException: Could not retrieve submitted JobGraph from state handle under jobGraph-8491f68c1c03631714c598a4b614eb35. This indicates that the retrieved state handle is broken. Try cleaning the state handle store.
 15:15:16.372   Caused by: java.io.FileNotFoundException: No such file or directory: s3a:&lt;span class=&quot;code-comment&quot;&gt;//zalando-stellar-flink-state-eu-central-1-live/recovery/stellar-flink-cluster/submittedJobGraph68047cef9baf&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17324951" author="mlushchytski" created="Mon, 19 Apr 2021 11:14:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;, attaching the log when the issue occurred &#160;-&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13024283/13024283_scalyr-logs+%281%29.txt&quot; title=&quot;scalyr-logs (1).txt attached to FLINK-22014&quot;&gt;scalyr-logs (1).txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17337369" author="till.rohrmann" created="Fri, 30 Apr 2021 12:50:15 +0000"  >&lt;p&gt;I couldn&apos;t really find anything suspicious in the logs. Would it be possible to configure a different filesystem for the HA storage directory &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt;? Maybe it has something to do with S3. If not, then the problem should also arise with a different filesystem.&lt;/p&gt;</comment>
                            <comment id="17339678" author="mlushchytski" created="Wed, 5 May 2021 14:04:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, sorry, it&apos;s a production job and we can&apos;t switch to other storage. What is interesting &#160;is that we have a couple of clusters and jobs, but only one cluster had this issue (twice for now, not reproduced since then).&lt;/p&gt;</comment>
                            <comment id="17340187" author="till.rohrmann" created="Thu, 6 May 2021 12:46:10 +0000"  >&lt;p&gt;Hmm, this is very strange. I will try to keep an eye on this issue and maybe I still find something in Flink which could explain the behavior. But at the moment I cannot explain it based on Flink alone.&lt;/p&gt;</comment>
                            <comment id="17340752" author="mlushchytski" created="Fri, 7 May 2021 11:38:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, the issue happened today again on the same cluster. May it be somehow related to cluster misconfiguration ? This time before the standard error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR org.apache.flink.runtime.entrypoint.ClusterEntrypoint        [] - Fatal error occurred in the cluster entrypoint.
 12:09:39.252  java.util.concurrent.CompletionException: org.apache.flink.util.FlinkRuntimeException: Could not recover job with job id 49768ef918811278aef1769ab940857d.
 12:09:39.252  Caused by: org.apache.flink.util.FlinkRuntimeException: Could not recover job with job id 49768ef918811278aef1769ab940857d.
 12:09:39.252   Caused by: org.apache.flink.util.FlinkException: Could not retrieve submitted JobGraph from state handle under jobGraph-49768ef918811278aef1769ab940857d. This indicates that the retrieved state handle is broken. Try cleaning the state handle store.
 12:09:39.252  Caused by: java.io.FileNotFoundException: No such file or directory: s3a:&lt;span class=&quot;code-comment&quot;&gt;//XXXXX/recovery/stellar-flink-cluster/submittedJobGrapha371438bee25 &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I also noticed an error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-05-07 09:09:19,034 ERROR org.apache.flink.runtime.entrypoint.ClusterEntrypoint        [] - Fatal error occurred in the cluster entrypoint.
 12:09:19.03   org.apache.flink.util.FlinkException: JobMaster &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 49768ef918811278aef1769ab940857d failed.
 12:09:19.035  Caused by: org.apache.flink.util.FlinkException: Could not start the job manager.
 12:09:19.035  Caused by: java.util.concurrent.CompletionException: java.lang.IllegalStateException: DefaultLeaderRetrievalService can only be started once. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17340805" author="till.rohrmann" created="Fri, 7 May 2021 12:58:26 +0000"  >&lt;p&gt;Which version of Flink are you using &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt;? I&apos;ve checked that it should not happen with the latest Flink version.&lt;/p&gt;</comment>
                            <comment id="17340808" author="mlushchytski" created="Fri, 7 May 2021 13:04:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, we are using Flink 1.12.2&lt;/p&gt;</comment>
                            <comment id="17340882" author="till.rohrmann" created="Fri, 7 May 2021 15:08:22 +0000"  >&lt;p&gt;I could reproduce the problem in Flink 1.12.2. The problem should be gone in Flink 1.13.0. I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22597&quot; title=&quot;JobMaster cannot be restarted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22597&quot;&gt;&lt;del&gt;FLINK-22597&lt;/del&gt;&lt;/a&gt; to fix this issue.&lt;/p&gt;</comment>
                            <comment id="17341113" author="fly_in_gis" created="Sat, 8 May 2021 03:31:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;Do you mean that you could reproduce the issue JobGraph existed in ConfigMap but not in S3? Or just the &quot;DefaultLeaderRetrievalService can only be started once&quot;.&lt;/p&gt;</comment>
                            <comment id="17341795" author="till.rohrmann" created="Mon, 10 May 2021 09:30:18 +0000"  >&lt;p&gt;I meant the problem with &quot;DefaultLeaderRetrievalService can only be started once&quot;.&lt;/p&gt;</comment>
                            <comment id="17369752" author="jeromexlee" created="Fri, 25 Jun 2021 23:01:52 +0000"  >&lt;p&gt;Can Flink provides such config option that Flink skip recover job from configmap if the HA storage like s3 somehow cleans up by external operations?&lt;/p&gt;</comment>
                            <comment id="17370563" author="till.rohrmann" created="Mon, 28 Jun 2021 12:03:47 +0000"  >&lt;p&gt;Currently, Flink does not support this. What you have to do now is to manually change the config map and remove the respective entry.&lt;/p&gt;</comment>
                            <comment id="17371293" author="fly_in_gis" created="Tue, 29 Jun 2021 11:02:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeromexlee&quot; class=&quot;user-hover&quot; rel=&quot;jeromexlee&quot;&gt;jeromexlee&lt;/a&gt;&#160;I think&#160;silently ignoring such exception is a danger behavior. Because it could start the Flink job from begging and have an intolerable delay. Instead, if we fail the application, users could simply delete the ConfigMap manually and restore the job from retained checkpoint via &lt;tt&gt;&lt;del&gt;s/&lt;/del&gt;-fromSavepoint&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17396546" author="mlushchytski" created="Tue, 10 Aug 2021 08:43:47 +0000"  >&lt;p&gt;Closing issue as we finally managed to figure out the root cause and it was related to bucket lifecycle policy which expired files in 7 days which resulted in missing `submittedJobGraphXXX` data.&lt;/p&gt;</comment>
                            <comment id="17396700" author="till.rohrmann" created="Tue, 10 Aug 2021 14:07:41 +0000"  >&lt;p&gt;This is great to hear &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt;. Thanks a lot for sharing your findings with the community. I am quite relieved that this is not a problem on Flink&apos;s side.&lt;/p&gt;</comment>
                            <comment id="17450147" author="JIRAUSER280892" created="Sun, 28 Nov 2021 22:50:08 +0000"  >&lt;p&gt;Hello&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlushchytski&quot; class=&quot;user-hover&quot; rel=&quot;mlushchytski&quot;&gt;mlushchytski&lt;/a&gt; or anyone knowing:&lt;/p&gt;

&lt;p&gt;In our company, we observe symptoms similar to those reported in this issue while using Flink 1.13.2. That is, job managers in CrashLoopbackOff with similar errors in their logs. The storage is in a ReadWriteMany PV using rook-cephfs storage class.&lt;/p&gt;

&lt;p&gt;The Flink version information from the log of job manager:&lt;br/&gt;
Starting StandaloneSessionClusterEntrypoint (Version: 1.13.2, Scala: 2.11, Rev:5f007ff, Date:2021-07-23T04:35:55+02:00)&lt;/p&gt;

&lt;p&gt;The issue happens in a non-systematic manner, but observed it in at least 3 deployments on different OpenShift clusters.&#160;&lt;br/&gt;
Reducing the number of Flink job managers from 3 (HA) to 1 (non-HA) avoids the CrashloopbackOff.&lt;/p&gt;

&lt;p&gt;For some reason, while previously the &quot;Fix version(s)&quot; field of this issue has been assigned different values, it presently shows &quot;None&quot;.&#160;&lt;/p&gt;

&lt;p&gt;Has this been observed by others with Flink 1.13.2? Should this issue be reopened or should we open a new issue?&lt;/p&gt;</comment>
                            <comment id="17450524" author="till.rohrmann" created="Mon, 29 Nov 2021 15:21:03 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adrianalexvasiliu&quot; class=&quot;user-hover&quot; rel=&quot;adrianalexvasiliu&quot;&gt;adrianalexvasiliu&lt;/a&gt;, I think the underlying problem of this issue was that the bucket lifecycle policy deleted files after 7 days. Hence, the problem was not caused by Flink.&lt;/p&gt;

&lt;p&gt;Your problem sounds a bit different. Maybe it is related to what kind of guarantees the ReadWriteMany PV using rook-cephfs gives you. But it could also be a Flink problem. What I would suggest is to open a new tickets and to provide the debug logs of the Flink cluster that could not recover. Also it would be interesting to know if you can reproduce the problem with the latest Flink version.&lt;/p&gt;</comment>
                            <comment id="17450640" author="JIRAUSER280892" created="Mon, 29 Nov 2021 18:01:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; OK, thanks. I&apos;ll open a new issue with the logs of the job manager. We did reproduce it with: Flink 1.13.2 and Flink 1.13.3. Not yet tried Flink 1.14.&lt;/p&gt;</comment>
                            <comment id="17450716" author="JIRAUSER280892" created="Mon, 29 Nov 2021 20:56:42 +0000"  >&lt;p&gt;Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25098&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-25098&lt;/a&gt; .&lt;/p&gt;</comment>
                            <comment id="17766891" author="mason6345" created="Tue, 19 Sep 2023 17:32:49 +0000"  >&lt;p&gt;We are also hitting this issue with Flink 1.16.2&lt;/p&gt;</comment>
                            <comment id="17769548" author="novakov.alex" created="Wed, 27 Sep 2023 11:24:45 +0000"  >&lt;p&gt;the same issue in my case with Flink 1.16.1. Storage used is Azure Blob Storage (&lt;b&gt;WASBS)&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="17792482" author="JIRAUSER295713" created="Sun, 3 Dec 2023 05:29:00 +0000"  >&lt;p&gt;The same issue in my case with flink-1.15.4, we found that our running flink tasks some have &#8217;submittedJobGraphXXXX&#8217; file and &#8216;job-result-store&#8216; folder, some tasks all don&#8217;t exist, we use S3 storage and K8S HA&lt;/p&gt;</comment>
                            <comment id="17792489" author="JIRAUSER295713" created="Sun, 3 Dec 2023 06:25:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mason6345&quot; class=&quot;user-hover&quot; rel=&quot;mason6345&quot;&gt;mason6345&lt;/a&gt; Is it caused by this issue &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-33011&quot; title=&quot;Operator deletes HA data unexpectedly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-33011&quot;&gt;&lt;del&gt;FLINK-33011&lt;/del&gt;&lt;/a&gt;? we use flink-kubernetes-operator 1.6 for flink tasks deployment.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13023436" name="flink-logs.txt.zip" size="190359" author="mlushchytski" created="Tue, 6 Apr 2021 12:07:11 +0000"/>
                            <attachment id="13024271" name="image-2021-04-19-11-17-58-215.png" size="241280" author="mlushchytski" created="Mon, 19 Apr 2021 08:17:58 +0000"/>
                            <attachment id="13024283" name="scalyr-logs (1).txt" size="245609" author="mlushchytski" created="Mon, 19 Apr 2021 11:15:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 49 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0pbm0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>