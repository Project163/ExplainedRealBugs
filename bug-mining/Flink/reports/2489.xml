<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8067] User code ClassLoader not set before calling ProcessingTimeCallback</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8067</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The user code ClassLoader is not set as the context ClassLoader for the thread invoking &lt;tt&gt;ProcessingTimeCallback#onProcessingTime(long timestamp)&lt;/tt&gt;:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/blob/84a07a34ac22af14f2dd0319447ca5f45de6d0bb/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L222&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/84a07a34ac22af14f2dd0319447ca5f45de6d0bb/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L222&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is problematic, for example, if user code dynamically loads classes in &lt;tt&gt;ProcessFunction#onTimer(long timestamp, OnTimerContext ctx, Collector&amp;lt;O&amp;gt; out)&lt;/tt&gt; using the current thread&apos;s context ClassLoader (also see &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8005&quot; title=&quot;Snapshotting FlinkKafkaProducer011 fails due to ClassLoader issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8005&quot;&gt;&lt;del&gt;FLINK-8005&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13118190">FLINK-8067</key>
            <summary>User code ClassLoader not set before calling ProcessingTimeCallback</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yanghua">vinoyang</assignee>
                                    <reporter username="gjy">Gary Yao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 14 Nov 2017 09:46:37 +0000</created>
                <updated>Thu, 28 Feb 2019 11:14:35 +0000</updated>
                            <resolved>Fri, 29 Jun 2018 12:35:01 +0000</resolved>
                                    <version>1.4.0</version>
                    <version>1.5.0</version>
                                    <fixVersion>1.6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16491612" author="githubbot" created="Sat, 26 May 2018 10:47:39 +0000"  >&lt;p&gt;GitHub user yanghua opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8067&quot; title=&quot;User code ClassLoader not set before calling ProcessingTimeCallback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8067&quot;&gt;&lt;del&gt;FLINK-8067&lt;/del&gt;&lt;/a&gt; User code ClassLoader not set before calling ProcessingTimeCallback&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    &lt;b&gt;This pull request sets the user code class loader for the thread factory&lt;/b&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Sets the user code class loader for the thread factory&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change is already covered by existing tests*.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable / docs / JavaDocs / *&lt;b&gt;not documented&lt;/b&gt;*)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/yanghua/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yanghua/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8067&quot; title=&quot;User code ClassLoader not set before calling ProcessingTimeCallback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8067&quot;&gt;&lt;del&gt;FLINK-8067&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6081&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2f11cabedc62ceded05a2ef02b88abfc79a77ba1&lt;br/&gt;
Author: yanghua &amp;lt;yanghua1127@...&amp;gt;&lt;br/&gt;
Date:   2018-05-26T10:44:21Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8067&quot; title=&quot;User code ClassLoader not set before calling ProcessingTimeCallback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8067&quot;&gt;&lt;del&gt;FLINK-8067&lt;/del&gt;&lt;/a&gt; User code ClassLoader not set before calling ProcessingTimeCallback&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16504327" author="githubbot" created="Thu, 7 Jun 2018 07:13:19 +0000"  >&lt;p&gt;Github user yanghua commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @pnowojski I&apos;ve tried but it seams it&apos;s hard to do this. The class loader can not be accessed out of the class. @GJL any suggestion? Or need to test?&lt;/p&gt;</comment>
                            <comment id="16508057" author="githubbot" created="Mon, 11 Jun 2018 13:34:35 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @yanghua why is it difficult? Can not you create more or less similar test to @GJL&apos;s `testSetsUserCodeClassLoader` from here: &lt;a href=&quot;https://github.com/apache/flink/pull/4980/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4980/files&lt;/a&gt;. With couple side notes:&lt;/p&gt;

&lt;p&gt;    1. build `MockEnvironment` using `MockEnvironmentBuilder` with a custom user class loader - do not use mockito for that&lt;br/&gt;
    2. create a stream task (reusing one of the implementation in `StreamTaskTest.java` or create a new one)&lt;br/&gt;
    3. register a timer service, wait for it&apos;s triggering and assert the user class loader in `ProcessingTimeCallback#onProcessingTime`&lt;/p&gt;</comment>
                            <comment id="16510736" author="githubbot" created="Wed, 13 Jun 2018 07:45:51 +0000"  >&lt;p&gt;Github user yanghua commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    cc @pnowojski please review this, thanks~&lt;/p&gt;</comment>
                            <comment id="16510837" author="githubbot" created="Wed, 13 Jun 2018 09:25:58 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081#discussion_r195011678&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081#discussion_r195011678&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java &amp;#8212;&lt;br/&gt;
    @@ -1239,6 +1286,50 @@ protected void cancelTask() throws Exception {&lt;/p&gt;

&lt;p&gt;     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * A task that register a processing time service callback.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static class TimeServiceTask extends StreamTask&amp;lt;String, AbstractStreamOperator&amp;lt;String&amp;gt;&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		public TimeServiceTask(Environment env) &lt;/p&gt;
{
    +			super(env, null);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		protected void init() throws Exception {&lt;br/&gt;
    +			getProcessingTimeService().registerTimer(1000, new ProcessingTimeCallback() {&lt;br/&gt;
    +				@Override&lt;br/&gt;
    +				public void onProcessingTime(long timestamp) throws Exception &lt;/p&gt;
{
    +					classLoaders.add(Thread.currentThread().getContextClassLoader());
    +				}
&lt;p&gt;    +			});&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		protected void run() throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The test is failing on the travis. Probably because here in `run()` you do not wait for at least one execution of `onProcessingTime(...)`. Probably you need to add a `OneShotLatch` and `tigger` it in `onProcessingTime` while `await`&apos;ing in `run()`.&lt;/p&gt;</comment>
                            <comment id="16510838" author="githubbot" created="Wed, 13 Jun 2018 09:25:58 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081#discussion_r195007239&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081#discussion_r195007239&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java &amp;#8212;&lt;br/&gt;
    @@ -806,6 +819,40 @@ public void testOperatorClosingBeforeStopRunning() throws Throwable {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Test set user code ClassLoader before calling ProcessingTimeCallback.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSetsUserCodeClassLoaderForTimerThreadFactory() throws Throwable {&lt;br/&gt;
    +		try (MockEnvironment mockEnvironment = new MockEnvironmentBuilder()&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Maybe reformat to:&lt;br/&gt;
    ```&lt;br/&gt;
    try (MockEnvironment mockEnvironment = &lt;br/&gt;
    		 new MockEnvironmentBuilder()&lt;br/&gt;
    			 .setUserCodeClassLoader(new TestUserCodeClassLoader())&lt;br/&gt;
    			 .build()) {&lt;/p&gt;

&lt;p&gt;    }&lt;br/&gt;
    ```&lt;br/&gt;
    ?&lt;/p&gt;</comment>
                            <comment id="16510839" author="githubbot" created="Wed, 13 Jun 2018 09:25:58 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081#discussion_r195012204&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081#discussion_r195012204&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java &amp;#8212;&lt;br/&gt;
    @@ -1239,6 +1286,50 @@ protected void cancelTask() throws Exception {&lt;/p&gt;

&lt;p&gt;     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * A task that register a processing time service callback.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static class TimeServiceTask extends StreamTask&amp;lt;String, AbstractStreamOperator&amp;lt;String&amp;gt;&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		public TimeServiceTask(Environment env) &lt;/p&gt;
{
    +			super(env, null);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		protected void init() throws Exception {&lt;br/&gt;
    +			getProcessingTimeService().registerTimer(1000, new ProcessingTimeCallback() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Please change `1000` to `0`. This parameter is not a delay in miliseconds/seconds from now, but specifies exact timestamp when the timer should fire, thus value `1000` is misleading.&lt;/p&gt;</comment>
                            <comment id="16510840" author="githubbot" created="Wed, 13 Jun 2018 09:25:58 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081#discussion_r195013346&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081#discussion_r195013346&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java &amp;#8212;&lt;br/&gt;
    @@ -169,6 +175,13 @@&lt;/p&gt;

&lt;p&gt;     	private static OneShotLatch syncLatch;&lt;/p&gt;

&lt;p&gt;    +	private static final List&amp;lt;ClassLoader&amp;gt; classLoaders = Collections.synchronizedList(new ArrayList&amp;lt;&amp;gt;());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    maybe move this field to `TimeServiceTask` since it&apos;s tightly connected to it.&lt;/p&gt;</comment>
                            <comment id="16510841" author="githubbot" created="Wed, 13 Jun 2018 09:25:58 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081#discussion_r195007487&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081#discussion_r195007487&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java &amp;#8212;&lt;br/&gt;
    @@ -806,6 +819,40 @@ public void testOperatorClosingBeforeStopRunning() throws Throwable {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Test set user code ClassLoader before calling ProcessingTimeCallback.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSetsUserCodeClassLoaderForTimerThreadFactory() throws Throwable {&lt;br/&gt;
    +		try (MockEnvironment mockEnvironment = new MockEnvironmentBuilder()&lt;br/&gt;
    +			.setUserCodeClassLoader(new TestUserCodeClassLoader()).build()) {&lt;br/&gt;
    +			TimeServiceTask timerServiceTask = spy(new TimeServiceTask(mockEnvironment));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    why do you need `spy` here?&lt;/p&gt;</comment>
                            <comment id="16511270" author="githubbot" created="Wed, 13 Jun 2018 15:03:23 +0000"  >&lt;p&gt;Github user yanghua commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @pnowojski  test error has fixed~&lt;/p&gt;</comment>
                            <comment id="16511283" author="githubbot" created="Wed, 13 Jun 2018 15:13:47 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081#discussion_r195123173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081#discussion_r195123173&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java &amp;#8212;&lt;br/&gt;
    @@ -806,6 +811,44 @@ public void testOperatorClosingBeforeStopRunning() throws Throwable {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Test set user code ClassLoader before calling ProcessingTimeCallback.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSetsUserCodeClassLoaderForTimerThreadFactory() throws Throwable {&lt;br/&gt;
    +		syncLatch = new OneShotLatch();&lt;br/&gt;
    +&lt;br/&gt;
    +		try (MockEnvironment mockEnvironment =&lt;br/&gt;
    +			new MockEnvironmentBuilder()&lt;br/&gt;
    +				.setUserCodeClassLoader(new TestUserCodeClassLoader())&lt;br/&gt;
    +				.build()) {&lt;br/&gt;
    +			TimeServiceTask timerServiceTask = new TimeServiceTask(mockEnvironment);&lt;br/&gt;
    +&lt;br/&gt;
    +			final AtomicReference&amp;lt;Throwable&amp;gt; atomicThrowable = new AtomicReference&amp;lt;&amp;gt;(null);&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture&amp;lt;Void&amp;gt; invokeFuture = CompletableFuture.runAsync(&lt;br/&gt;
    +				() -&amp;gt; {&lt;br/&gt;
    +					try &lt;/p&gt;
{
    +						timerServiceTask.invoke();
    +					}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +						atomicThrowable.set(e);
    +					}
&lt;p&gt;    +				},&lt;br/&gt;
    +				TestingUtils.defaultExecutor());&lt;br/&gt;
    +&lt;br/&gt;
    +			// wait until the invoke is complete&lt;br/&gt;
    +			invokeFuture.get();&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(timerServiceTask.getClassLoaders(), hasSize(greaterThanOrEqualTo(1)));&lt;br/&gt;
    +			assertThat(timerServiceTask.getClassLoaders(), everyItem(instanceOf(TestUserCodeClassLoader.class)));&lt;br/&gt;
    +&lt;br/&gt;
    +			// check if an exception occurred&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    tiny nits: you could drop this (and the one above) comment. The code is pretty self explanatory on it&apos;s own.&lt;/p&gt;</comment>
                            <comment id="16511285" author="githubbot" created="Wed, 13 Jun 2018 15:16:07 +0000"  >&lt;p&gt;Github user yanghua commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081#discussion_r195124501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081#discussion_r195124501&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java &amp;#8212;&lt;br/&gt;
    @@ -806,6 +811,44 @@ public void testOperatorClosingBeforeStopRunning() throws Throwable {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Test set user code ClassLoader before calling ProcessingTimeCallback.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSetsUserCodeClassLoaderForTimerThreadFactory() throws Throwable {&lt;br/&gt;
    +		syncLatch = new OneShotLatch();&lt;br/&gt;
    +&lt;br/&gt;
    +		try (MockEnvironment mockEnvironment =&lt;br/&gt;
    +			new MockEnvironmentBuilder()&lt;br/&gt;
    +				.setUserCodeClassLoader(new TestUserCodeClassLoader())&lt;br/&gt;
    +				.build()) {&lt;br/&gt;
    +			TimeServiceTask timerServiceTask = new TimeServiceTask(mockEnvironment);&lt;br/&gt;
    +&lt;br/&gt;
    +			final AtomicReference&amp;lt;Throwable&amp;gt; atomicThrowable = new AtomicReference&amp;lt;&amp;gt;(null);&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture&amp;lt;Void&amp;gt; invokeFuture = CompletableFuture.runAsync(&lt;br/&gt;
    +				() -&amp;gt; {&lt;br/&gt;
    +					try &lt;/p&gt;
{
    +						timerServiceTask.invoke();
    +					}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +						atomicThrowable.set(e);
    +					}
&lt;p&gt;    +				},&lt;br/&gt;
    +				TestingUtils.defaultExecutor());&lt;br/&gt;
    +&lt;br/&gt;
    +			// wait until the invoke is complete&lt;br/&gt;
    +			invokeFuture.get();&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(timerServiceTask.getClassLoaders(), hasSize(greaterThanOrEqualTo(1)));&lt;br/&gt;
    +			assertThat(timerServiceTask.getClassLoaders(), everyItem(instanceOf(TestUserCodeClassLoader.class)));&lt;br/&gt;
    +&lt;br/&gt;
    +			// check if an exception occurred&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    hold on, will fix it~&lt;/p&gt;</comment>
                            <comment id="16511288" author="githubbot" created="Wed, 13 Jun 2018 15:18:31 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081#discussion_r195125463&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081#discussion_r195125463&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java &amp;#8212;&lt;br/&gt;
    @@ -806,6 +811,44 @@ public void testOperatorClosingBeforeStopRunning() throws Throwable {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Test set user code ClassLoader before calling ProcessingTimeCallback.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSetsUserCodeClassLoaderForTimerThreadFactory() throws Throwable {&lt;br/&gt;
    +		syncLatch = new OneShotLatch();&lt;br/&gt;
    +&lt;br/&gt;
    +		try (MockEnvironment mockEnvironment =&lt;br/&gt;
    +			new MockEnvironmentBuilder()&lt;br/&gt;
    +				.setUserCodeClassLoader(new TestUserCodeClassLoader())&lt;br/&gt;
    +				.build()) {&lt;br/&gt;
    +			TimeServiceTask timerServiceTask = new TimeServiceTask(mockEnvironment);&lt;br/&gt;
    +&lt;br/&gt;
    +			final AtomicReference&amp;lt;Throwable&amp;gt; atomicThrowable = new AtomicReference&amp;lt;&amp;gt;(null);&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture&amp;lt;Void&amp;gt; invokeFuture = CompletableFuture.runAsync(&lt;br/&gt;
    +				() -&amp;gt; {&lt;br/&gt;
    +					try &lt;/p&gt;
{
    +						timerServiceTask.invoke();
    +					}
&lt;p&gt; catch (Exception e) {&lt;br/&gt;
    +						atomicThrowable.set(e);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    you can fail this with a `CompletionException` instead, then we don&apos;t need the atomic reference and will fail at `invokeFuture.get`&lt;/p&gt;</comment>
                            <comment id="16512542" author="githubbot" created="Thu, 14 Jun 2018 14:29:23 +0000"  >&lt;p&gt;Github user yanghua commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    cc @pnowojski does this PR look good to you?&lt;/p&gt;</comment>
                            <comment id="16512555" author="githubbot" created="Thu, 14 Jun 2018 14:39:39 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &#128077; Yes, I have already approved it on github:&lt;br/&gt;
    &amp;gt; pnowojski approved these changes 23 hours ago&lt;/p&gt;</comment>
                            <comment id="16527557" author="githubbot" created="Fri, 29 Jun 2018 12:31:44 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the contribution! Merged.&lt;/p&gt;</comment>
                            <comment id="16527558" author="githubbot" created="Fri, 29 Jun 2018 12:33:09 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6081&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16527561" author="pnowojski" created="Fri, 29 Jun 2018 12:35:01 +0000"  >&lt;p&gt;Fixed for 1.6.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 20 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mr0n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>