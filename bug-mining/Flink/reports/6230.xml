<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:09:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-25893] ResourceManagerServiceImpl&apos;s lifecycle can lead to exceptions</title>
                <link>https://issues.apache.org/jira/browse/FLINK-25893</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;ResourceManagerServiceImpl&lt;/tt&gt; lifecycle can lead to exceptions when calling &lt;tt&gt;ResourceManagerServiceImpl.deregisterApplication&lt;/tt&gt;. The problem arises when the &lt;tt&gt;DispatcherResourceManagerComponent&lt;/tt&gt; is shutdown before the &lt;tt&gt;ResourceManagerServiceImpl&lt;/tt&gt; gains leadership or while it is starting the &lt;tt&gt;ResourceManager&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;One problem is that &lt;tt&gt;deregisterApplication&lt;/tt&gt; returns an exceptionally completed future if there is no leading &lt;tt&gt;ResourceManager&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Another problem is that if there is a leading &lt;tt&gt;ResourceManager&lt;/tt&gt;, then it can still be the case that it has not been started yet. If this is the case, then &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManagerServiceImpl.java#L143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ResourceManagerGateway.deregisterApplication&lt;/a&gt; will be discarded. The reason for this behaviour is that we create a &lt;tt&gt;ResourceManager&lt;/tt&gt; in one &lt;tt&gt;Runnable&lt;/tt&gt; and only start it in another. Due to this there can be the &lt;tt&gt;deregisterApplication&lt;/tt&gt; call that gets the &lt;tt&gt;lock&lt;/tt&gt; in between.&lt;/p&gt;

&lt;p&gt;I&apos;d suggest to correct the lifecycle and contract of the &lt;tt&gt;ResourceManagerServiceImpl.deregisterApplication&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Please note that due to this problem, the error reporting of this method has been suppressed. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25885&quot; title=&quot;ClusterEntrypointTest.testWorkingDirectoryIsDeletedIfApplicationCompletes  failed on azure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25885&quot;&gt;&lt;del&gt;FLINK-25885&lt;/del&gt;&lt;/a&gt; for more details.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13425746">FLINK-25893</key>
            <summary>ResourceManagerServiceImpl&apos;s lifecycle can lead to exceptions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xtsong">Xintong Song</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 31 Jan 2022 10:22:39 +0000</created>
                <updated>Mon, 21 Feb 2022 10:56:10 +0000</updated>
                            <resolved>Mon, 21 Feb 2022 10:55:48 +0000</resolved>
                                    <version>1.14.3</version>
                    <version>1.15.0</version>
                                    <fixVersion>1.14.4</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17484597" author="till.rohrmann" created="Mon, 31 Jan 2022 10:23:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xtsong&quot; class=&quot;user-hover&quot; rel=&quot;xtsong&quot;&gt;xtsong&lt;/a&gt; could you take a look at this problem. I think you know this code part the best.&lt;/p&gt;</comment>
                            <comment id="17486189" author="xintongsong" created="Thu, 3 Feb 2022 02:44:24 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;For problem 2, I think it is indeed a problem. &lt;tt&gt;ResourceManagerServiceImpl&lt;/tt&gt; should not only check whether there is a leading &lt;tt&gt;ResourceManager&lt;/tt&gt;, but also make sure the leading &lt;tt&gt;ResourceManager&lt;/tt&gt; is fully started, before calling the &lt;tt&gt;ResourceManagerGateway#deregisterApplication&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;For problem 1, I think it&apos;s kind of expected. When there&apos;s no leading &lt;tt&gt;ResourceManager&lt;/tt&gt;, the &lt;tt&gt;ResourceManagerServiceImpl&lt;/tt&gt; can respond to a `deregisterApplication` call by either ignoring the call or report an exception. When there&apos;s a leading &lt;tt&gt;ResourceManager&lt;/tt&gt; in another process, it is desired that the non-leading process ignores the `deregisterApplication` call. On the other hand, if there is no leading &lt;tt&gt;ResourceManager&lt;/tt&gt; in any process of the cluster, it would be desired that the failure of `deregisterApplication` is reported. Since &lt;tt&gt;ResourceManagerServiceImpl&lt;/tt&gt; cannot know whether there&apos;s a leading &lt;tt&gt;ResourceManager&lt;/tt&gt; in another process, I think a false alarm in the non-leading process when there is another leading process is probably better than failing the `deregisterApplication` silently when there&apos;s no leading process, as in the latter case Kubernetes / Yarn may unexpectedly bring the master process up again.&lt;/p&gt;</comment>
                            <comment id="17486288" author="till.rohrmann" created="Thu, 3 Feb 2022 08:33:48 +0000"  >&lt;p&gt;Hmm, I think we had a similar discussion before. The problem seems to be that a &lt;tt&gt;RM&lt;/tt&gt; is needed for the application deregistration. However, the decision whether to deregister or not will be made by another component that might run in a different process. I think this problem should be solved in one way or another. I could see two ideas:&lt;/p&gt;

&lt;p&gt;1) Make the (de)registration independent of the &lt;tt&gt;RM&lt;/tt&gt;.&lt;br/&gt;
2) Change the contract of the &lt;tt&gt;ClusterEntrypoint&lt;/tt&gt; to not deregister the application if the &lt;tt&gt;RM&lt;/tt&gt; is not running. In this case the process running eventually the &lt;tt&gt;RM&lt;/tt&gt; should gain leadership and initiate the shut down.&lt;/p&gt;</comment>
                            <comment id="17487853" author="xintongsong" created="Mon, 7 Feb 2022 03:32:13 +0000"  >&lt;p&gt;I also have the impression of a similar discussion, just couldn&apos;t remember whom I discussed with. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m leaning towards to option 2).&lt;/p&gt;

&lt;p&gt;I&apos;m afraid your option 1) would not work. &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Any component that is responsible for the deregistering would need a leader election. Otherwise, we may accidentally deregister the application from a non-leading master process while there is another leading master process. Thus, we still face the same problem that deregistering is called while no leader is elected.&lt;/li&gt;
	&lt;li&gt;It exposes the Kubernetes/Yarn client to either &lt;tt&gt;ClusterEntrypoint&lt;/tt&gt; or &lt;tt&gt;Dispatcher&lt;/tt&gt;, which complicates the system.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For option 2), changing the contract means the process will exit with code 0 when there&apos;s no leading RM. That should not affect the native Kubernetes &amp;amp; Yarn deployment (neither of them relies on the exit code for process restarting), but will help the standalone Kubernetes deployment (which performs nothing in deregistering and relies on the exit code for restarting).&lt;/p&gt;

&lt;p&gt;If we have consensus, I can work on this ticket and make the following changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Makes &lt;tt&gt;ResourceManagerGateway#deregisterApplication&lt;/tt&gt; wait for the leading RM being fully started.&lt;/li&gt;
	&lt;li&gt;Change the contract to not deregister the application if there&apos;s no leading RM in the process.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17488033" author="till.rohrmann" created="Mon, 7 Feb 2022 10:46:33 +0000"  >&lt;p&gt;For option 1) I think a leading &lt;tt&gt;Dispatcher&lt;/tt&gt; would decide that it is now time to shut down and to deregister the application. Then the &lt;tt&gt;ClusterEntrypoint&lt;/tt&gt; would get the signal and initiate the deregistration.&lt;/p&gt;

&lt;p&gt;For option 2): Assuming that eventually a &lt;tt&gt;Dispatcher&lt;/tt&gt; becomes leader that is running in the same process as the leading &lt;tt&gt;RM&lt;/tt&gt; which then triggers the shut down, I think this can work. Moreover with &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24038&quot; title=&quot;DispatcherResourceManagerComponent fails to deregister application if no leading ResourceManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24038&quot;&gt;&lt;del&gt;FLINK-24038&lt;/del&gt;&lt;/a&gt; the problem of a leading RM and &lt;tt&gt;Dispatcher&lt;/tt&gt; running in different processes should no longer happen.&lt;/p&gt;</comment>
                            <comment id="17488063" author="xintongsong" created="Mon, 7 Feb 2022 12:25:13 +0000"  >&lt;p&gt;For option 1): Do we have the guarantee that the deregistration only happens when there&apos;s a leading &lt;tt&gt;Dispatcher&lt;/tt&gt;? I think it can also happen e.g., in the catch block of &lt;tt&gt;ClusterEntrypoint#startCluster&lt;/tt&gt;. This may not be a perfect example, as the process will exit with non-zero code anyway. My point is we may still need to face the problem when shutting down the cluster without a leading &lt;tt&gt;Dispatcher&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17495307" author="xintongsong" created="Mon, 21 Feb 2022 03:42:08 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;master (1.15): cb478fb751dbe28405152707040f9126b5a5269b&lt;/li&gt;
	&lt;li&gt;release-1.14: 451c5aa98b516bc7dde2dedfe01a6d3ae8d9c8dd&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13387637">FLINK-23240</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13425703">FLINK-25885</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0z40w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>