<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6775] StateDescriptor cannot be shared by multiple subtasks</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6775</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;StateDescriptor&lt;/tt&gt; contains the &lt;tt&gt;TypeSerializer&lt;/tt&gt; which is used to serialize the state. The serializer instance won&apos;t be duplicated when it is accessed. Therefore, the &lt;tt&gt;StateDescriptor&lt;/tt&gt; cannot be shared if the &lt;tt&gt;TypeSerializer&lt;/tt&gt; is stateful as in the case of the &lt;tt&gt;KryoSerializer&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This problem can easily arise when a user defines a stateful operator which defines the &lt;tt&gt;StateDescriptor&lt;/tt&gt; statically. The work around is to not define a static &lt;tt&gt;StateDescriptor&lt;/tt&gt;. However, I would still make it a blocker, because it is extremely hard to debug for the user if things fail because the &lt;tt&gt;TypeSerializer&lt;/tt&gt; is used concurrently.&lt;/p&gt;

&lt;p&gt;The following operator produces the problem:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;StatefulMapper &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; RichMapFunction&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;, Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; CheckpointedFunction {
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; serialVersionUID = -1175717056869107847L;
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ValueStateDescriptor&amp;lt;PojoType&amp;gt; POJO_VALUE_STATE = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ValueStateDescriptor&amp;lt;PojoType&amp;gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;pojoType&quot;&lt;/span&gt;, PojoType.class);

        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; ValueState&amp;lt;PojoType&amp;gt; valueState;

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; StatefulMapper() {
            valueState = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; map(Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; tuple) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
            PojoType pojoType = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PojoType(1, 1.0, &lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NestedPojo(2, 2.0));
            valueState.update(pojoType);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; tuple;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void snapshotState(FunctionSnapshotContext functionSnapshotContext) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {}

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void initializeState(FunctionInitializationContext functionInitializationContext) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
            valueState = functionInitializationContext.getKeyedStateStore().getState(POJO_VALUE_STATE);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13075846">FLINK-6775</key>
            <summary>StateDescriptor cannot be shared by multiple subtasks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>flink-rel-1.3.1-blockers</label>
                    </labels>
                <created>Tue, 30 May 2017 14:14:35 +0000</created>
                <updated>Fri, 2 Jun 2017 09:19:38 +0000</updated>
                            <resolved>Fri, 2 Jun 2017 09:19:38 +0000</resolved>
                                    <version>1.0.3</version>
                    <version>1.1.4</version>
                    <version>1.2.1</version>
                    <version>1.3.0</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.2.2</fixVersion>
                    <fixVersion>1.3.1</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16031052" author="githubbot" created="Wed, 31 May 2017 12:02:04 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4025&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6775&quot; title=&quot;StateDescriptor cannot be shared by multiple subtasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6775&quot;&gt;&lt;del&gt;FLINK-6775&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;state&amp;#93;&lt;/span&gt; Duplicate StateDescriptor&apos;s serializer&lt;/p&gt;

&lt;p&gt;    Duplicate the TypeSerializer before returning it from the StateDescriptor. That way&lt;br/&gt;
    we ensure that StateDescriptors can be shared by multiple threads.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; fixStateDescriptor&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4025.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4025.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4025&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 16cb7b12e9d8a59ad957c206f03076fca2143b71&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-05-31T11:59:55Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6775&quot; title=&quot;StateDescriptor cannot be shared by multiple subtasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6775&quot;&gt;&lt;del&gt;FLINK-6775&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;state&amp;#93;&lt;/span&gt; Duplicate StateDescriptor&apos;s serializer&lt;/p&gt;

&lt;p&gt;    Duplicate the TypeSerializer before returning it from the StateDescriptor. That way&lt;br/&gt;
    we ensure that StateDescriptors can be shared by multiple threads.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16031059" author="githubbot" created="Wed, 31 May 2017 12:08:13 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4025#discussion_r119340007&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4025#discussion_r119340007&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/api/common/state/ListStateDescriptorTest.java &amp;#8212;&lt;br/&gt;
    @@ -101,4 +108,35 @@ public void testValueStateDescriptorAutoSerializer() throws Exception &lt;/p&gt;
{
     		assertNotNull(copy.getElementSerializer());
     		assertEquals(StringSerializer.INSTANCE, copy.getElementSerializer());
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6775&quot; title=&quot;StateDescriptor cannot be shared by multiple subtasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6775&quot;&gt;&lt;del&gt;FLINK-6775&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * Tests that the returned serializer is duplicated if it is stateful. This allows to&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think the wording could be a bit misleading, it&apos;s not only duplicated when it is stateful but it&apos;s always duplicated. (also holds for the other tests)&lt;/p&gt;</comment>
                            <comment id="16031061" author="githubbot" created="Wed, 31 May 2017 12:09:44 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4025#discussion_r119340919&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4025#discussion_r119340919&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/api/common/state/ListStateDescriptorTest.java &amp;#8212;&lt;br/&gt;
    @@ -101,4 +108,35 @@ public void testValueStateDescriptorAutoSerializer() throws Exception &lt;/p&gt;
{
     		assertNotNull(copy.getElementSerializer());
     		assertEquals(StringSerializer.INSTANCE, copy.getElementSerializer());
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6775&quot; title=&quot;StateDescriptor cannot be shared by multiple subtasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6775&quot;&gt;&lt;del&gt;FLINK-6775&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * Tests that the returned serializer is duplicated if it is stateful. This allows to&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Will change it.&lt;/p&gt;</comment>
                            <comment id="16031064" author="githubbot" created="Wed, 31 May 2017 12:10:12 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4025&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the quick review @aljoscha. Yes my filter condition was `*StateDescriptorTest`. Will add a test for the `AggregatingStateDescriptor`.&lt;/p&gt;</comment>
                            <comment id="16032681" author="githubbot" created="Thu, 1 Jun 2017 09:20:55 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4025&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    LGTM, really like the change on the `testCorrectClassLoaderUsedOnSnapshot` test!&lt;/p&gt;</comment>
                            <comment id="16032726" author="githubbot" created="Thu, 1 Jun 2017 10:01:03 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4025&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @tzulitai and @aljoscha. Failing test case is unrelated. Merging this PR.&lt;/p&gt;</comment>
                            <comment id="16033192" author="githubbot" created="Thu, 1 Jun 2017 15:54:09 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4025&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16033193" author="till.rohrmann" created="Thu, 1 Jun 2017 15:55:27 +0000"  >&lt;p&gt;1.4.0: 88ffad272eea5865cc43bf44a8980754d8711178&lt;br/&gt;
1.3.1: d0e417e51fb7f29adfbb8779ceee7c01a9cdc7c7&lt;br/&gt;
1.2.2: 6f482aeb36f79a8059be1a2350e6d049cf2020e5&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3fmxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>