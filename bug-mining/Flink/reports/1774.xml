<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6833] Race condition: Asynchronous checkpointing task can fail completed StreamTask</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6833</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;A &lt;tt&gt;StreamTask&lt;/tt&gt; which is about to finish and thus transitioning its containing &lt;tt&gt;Task&lt;/tt&gt; into the &lt;tt&gt;ExecutionState.FINISHED&lt;/tt&gt; state, can be failed by a concurrent asynchronous checkpointing operation. The problem is that upon termination the &lt;tt&gt;StreamTask&lt;/tt&gt; cancels all concurrent operations (amongst others ongoing asynchronous checkpoints). The cancellation of the async checkpoint triggers the &lt;tt&gt;StreamTask#handleAsyncException&lt;/tt&gt; call which will fail the containing &lt;tt&gt;Task&lt;/tt&gt;. If the &lt;tt&gt;handleAsyncException&lt;/tt&gt; completes before the &lt;tt&gt;StreamTask&lt;/tt&gt; has been properly terminated, then the containing &lt;tt&gt;Task&lt;/tt&gt; will transition into &lt;tt&gt;ExecutionState.FAILED&lt;/tt&gt; instead of &lt;tt&gt;ExecutionState.FINISHED&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;In order to resolve this race condition, we should check in the &lt;tt&gt;StreamTask#handleAsyncException&lt;/tt&gt; whether the &lt;tt&gt;StreamTask&lt;/tt&gt; is still running or has already been terminated. Only in the former case, we should fail the containing &lt;tt&gt;Task&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13076865">FLINK-6833</key>
            <summary>Race condition: Asynchronous checkpointing task can fail completed StreamTask</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Jun 2017 13:48:04 +0000</created>
                <updated>Mon, 14 Aug 2017 22:35:44 +0000</updated>
                            <resolved>Tue, 13 Jun 2017 08:40:01 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.3.1</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16034717" author="githubbot" created="Fri, 2 Jun 2017 13:53:10 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6833&quot; title=&quot;Race condition: Asynchronous checkpointing task can fail completed StreamTask&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6833&quot;&gt;&lt;del&gt;FLINK-6833&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;task&amp;#93;&lt;/span&gt; Fail StreamTask only due to async exception if it is running&lt;/p&gt;

&lt;p&gt;    In order to resolve a race condition between a properly terminated StreamTask which&lt;br/&gt;
    cleans up its resources (stopping asynchronous operations, etc.) and a cancelled&lt;br/&gt;
    asynchronous operation (e.g. asynchronous checkpointing operation), we check whether&lt;br/&gt;
    the StreamTask is still running before failing it externally.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; fixStreamTaskRaceCondition&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4058.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4058.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4058&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 3d119a115e707e80b4b14174edd7de5048b732e9&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-06-02T13:48:54Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6833&quot; title=&quot;Race condition: Asynchronous checkpointing task can fail completed StreamTask&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6833&quot;&gt;&lt;del&gt;FLINK-6833&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;task&amp;#93;&lt;/span&gt; Fail StreamTask only due to async exception if it is running&lt;/p&gt;

&lt;p&gt;    In order to resolve a race condition between a properly terminated StreamTask which&lt;br/&gt;
    cleans up its resources (stopping asynchronous operations, etc.) and a cancelled&lt;br/&gt;
    asynchronous operation (e.g. asynchronous checkpointing operation), we check whether&lt;br/&gt;
    the StreamTask is still running before failing it externally.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16034728" author="githubbot" created="Fri, 2 Jun 2017 14:00:00 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The test will not pass checkstyle. You can run `mvn checkstyle:check` on the command-line to quickly verify checkstyle compliance.&lt;/p&gt;</comment>
                            <comment id="16038356" author="githubbot" created="Tue, 6 Jun 2017 08:19:56 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4058#discussion_r120291185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4058#discussion_r120291185&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java &amp;#8212;&lt;br/&gt;
    @@ -824,11 +824,14 @@ public ProcessingTimeService getProcessingTimeService() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;FAILED, and, if the invokable code is running, starts an asynchronous thread&lt;/li&gt;
	&lt;li&gt;that aborts that code.&lt;br/&gt;
     	 *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This method never blocks.&amp;lt;/p&amp;gt;&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;This method never blocks.&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Override&lt;br/&gt;
     	public void handleAsyncException(String message, Throwable exception) {&lt;/li&gt;
	&lt;li&gt;getEnvironment().failExternally(exception);&lt;br/&gt;
    +		if (isRunning) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I doubt that this is working fix, it will only make the problem less likely to occur. This method can be called asynchronously to Threads that manipulate `isRunning`, which means that the stream task can leave running status after the condition was checked as true, but before `failExternally(...)` went through.&lt;/p&gt;</comment>
                            <comment id="16041755" author="githubbot" created="Wed, 7 Jun 2017 22:09:20 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4058#discussion_r120757786&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4058#discussion_r120757786&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java &amp;#8212;&lt;br/&gt;
    @@ -824,11 +824,14 @@ public ProcessingTimeService getProcessingTimeService() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;FAILED, and, if the invokable code is running, starts an asynchronous thread&lt;/li&gt;
	&lt;li&gt;that aborts that code.&lt;br/&gt;
     	 *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This method never blocks.&amp;lt;/p&amp;gt;&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;This method never blocks.&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Override&lt;br/&gt;
     	public void handleAsyncException(String message, Throwable exception) {&lt;/li&gt;
	&lt;li&gt;getEnvironment().failExternally(exception);&lt;br/&gt;
    +		if (isRunning) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    If `isRunning == true` when entering the if branch, then depending on what happens before `failExternally`, we can assume that the `handleAsyncException` either happened atomically before `isRunning` was set to `false` or not. But what we don&apos;t want to happen is that if `isRunning == false`, that we can still fail the task. Thus, I think it solves a valid problem.&lt;/p&gt;</comment>
                            <comment id="16041788" author="githubbot" created="Wed, 7 Jun 2017 22:26:17 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I would like to merge this PR if I could clarify all concerns and there are no further objections.&lt;/p&gt;</comment>
                            <comment id="16042408" author="githubbot" created="Thu, 8 Jun 2017 08:33:45 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    LGTM +1&lt;/p&gt;</comment>
                            <comment id="16047560" author="githubbot" created="Tue, 13 Jun 2017 08:28:39 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @zentol and @StefanRRichter. Merging this PR.&lt;/p&gt;</comment>
                            <comment id="16047571" author="githubbot" created="Tue, 13 Jun 2017 08:35:54 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4058&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16047575" author="till.rohrmann" created="Tue, 13 Jun 2017 08:40:01 +0000"  >&lt;p&gt;1.4.0: ab2fc023047662b650af6e6625196bd72cbb30a0&lt;br/&gt;
1.3.1: a3103c2ddd6b8a7566b8fd27f3acd695b4b345c7&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13094076">FLINK-7430</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ft7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>