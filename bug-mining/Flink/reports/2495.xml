<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9665] PrometheusReporter does not properly unregister metrics</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9665</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;PrometheusReporter&lt;/tt&gt; groups metrics with the same logical scope in a single &lt;tt&gt;Collector&lt;/tt&gt; which are periodically polled by Prometheus.&lt;/p&gt;

&lt;p&gt;New metrics are added to an existing collector, and a reference count is maintained so we can eventually cleanup the &lt;tt&gt;Collector&lt;/tt&gt; itself.&lt;/p&gt;

&lt;p&gt;For removed metrics we decrease the reference count, do not however remove the metrics that were added. As a result the collector will continue to expose metrics, as long as at least 1 metric exists with the same logical scope.&lt;/p&gt;

&lt;p&gt;If the collector is a &lt;tt&gt;io.prometheus.client.Gauge&lt;/tt&gt; we can use the &lt;tt&gt;#remove()&lt;/tt&gt; method. For histograms we will have to modify our &lt;tt&gt;HistogramSummaryProxy&lt;/tt&gt; class to allow removing individual histograms.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13168400">FLINK-9665</key>
            <summary>PrometheusReporter does not properly unregister metrics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jelmer1">Jelmer Kuperus</assignee>
                                    <reporter username="chesnay">Chesnay Schepler</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 26 Jun 2018 16:46:41 +0000</created>
                <updated>Mon, 17 May 2021 04:08:56 +0000</updated>
                            <resolved>Tue, 3 Jul 2018 08:13:47 +0000</resolved>
                                    <version>1.4.2</version>
                    <version>1.5.0</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.4.3</fixVersion>
                    <fixVersion>1.5.1</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16524725" author="githubbot" created="Wed, 27 Jun 2018 07:49:14 +0000"  >&lt;p&gt;GitHub user jelmerk opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6211&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9665&quot; title=&quot;PrometheusReporter does not properly unregister metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9665&quot;&gt;&lt;del&gt;FLINK-9665&lt;/del&gt;&lt;/a&gt; PrometheusReporter does not properly unregister metrics&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Prometheus metrics from canceled jobs are not always correctly cleaned up. This patch aims to remedy this&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;always unregister childs from collectors in notifyOfRemovedMetric so that no metrics stay behind when a job gets canceled but the collector does not get unregistered&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    I added a metricIsRemovedWhenCollectorIsNotUnregisteredYet test to PrometheusReporterTest&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: no&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature?: no&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented?: not applicable&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jelmerk/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jelmerk/flink&lt;/a&gt; FLINK_9665&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6211.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6211.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6211&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 1dc5eb1e3ee8a1a15ecb95e5084db37fe7298cf4&lt;br/&gt;
Author: Jelmer Kuperus &amp;lt;jkuperus@...&amp;gt;&lt;br/&gt;
Date:   2018-06-26T23:05:11Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9665&quot; title=&quot;PrometheusReporter does not properly unregister metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9665&quot;&gt;&lt;del&gt;FLINK-9665&lt;/del&gt;&lt;/a&gt; PrometheusReporter does not properly unregister metrics&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16524816" author="githubbot" created="Wed, 27 Jun 2018 09:30:56 +0000"  >&lt;p&gt;Github user lamber-ken commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6211&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi, @jelmerk, I have a question that when will there be two taskmanager registered in the same registry?&lt;/p&gt;</comment>
                            <comment id="16524936" author="githubbot" created="Wed, 27 Jun 2018 11:30:08 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6211&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @lamber-ken If you are referring to the added test, it covers the case of 2 jobs (`TaskManager&amp;gt;&amp;gt;Job&amp;lt;&amp;lt;MetricGroup`) in the same registry, not TaskManagers.&lt;/p&gt;

&lt;p&gt;    There will usually not be multiple TaskManagers registered in a single registry, but this issue applies in general to any subset of metrics with the same logical scope.&lt;/p&gt;</comment>
                            <comment id="16524939" author="githubbot" created="Wed, 27 Jun 2018 11:33:26 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6211#discussion_r198460116&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6211#discussion_r198460116&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-metrics/flink-metrics-prometheus/src/test/java/org/apache/flink/metrics/prometheus/PrometheusReporterTest.java &amp;#8212;&lt;br/&gt;
    @@ -159,6 +162,27 @@ public void histogramIsReportedAsPrometheusSummary() throws UnirestException {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	@Test&lt;br/&gt;
    +	public void metricIsRemovedWhenCollectorIsNotUnregisteredYet() throws UnirestException {&lt;br/&gt;
    +		TaskManagerMetricGroup tmMetricGroup = new TaskManagerMetricGroup(registry, HOST_NAME, TASK_MANAGER);&lt;br/&gt;
    +&lt;br/&gt;
    +		String metricName = &quot;numRecordsOut&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +		Counter metric1 = new SimpleCounter();&lt;br/&gt;
    +		FrontMetricGroup&amp;lt;TaskManagerJobMetricGroup&amp;gt; metricGroup1 = new FrontMetricGroup&amp;lt;&amp;gt;(1, new TaskManagerJobMetricGroup(registry, tmMetricGroup, JobID.generate(), &quot;job_1&quot;));&lt;br/&gt;
    +		reporter.notifyOfAddedMetric(metric1, metricName, metricGroup1);&lt;br/&gt;
    +&lt;br/&gt;
    +		Counter metric2 = new SimpleCounter();&lt;br/&gt;
    +		FrontMetricGroup&amp;lt;TaskManagerJobMetricGroup&amp;gt; metricGroup2 = new FrontMetricGroup&amp;lt;&amp;gt;(2, new TaskManagerJobMetricGroup(registry, tmMetricGroup, JobID.generate(), &quot;job_2&quot;));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: the first argument to `FrontMetricGroup` should be identical since you&apos;re passing it to the same reporter. Actually it shouldn&apos;t be necessary to create a `FrontMetricGroup` at all, as it is only need to introduce reporter specific configuration properties.&lt;/p&gt;</comment>
                            <comment id="16525017" author="githubbot" created="Wed, 27 Jun 2018 12:59:32 +0000"  >&lt;p&gt;Github user jelmerk commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6211#discussion_r198484545&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6211#discussion_r198484545&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-metrics/flink-metrics-prometheus/src/test/java/org/apache/flink/metrics/prometheus/PrometheusReporterTest.java &amp;#8212;&lt;br/&gt;
    @@ -159,6 +162,27 @@ public void histogramIsReportedAsPrometheusSummary() throws UnirestException {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	@Test&lt;br/&gt;
    +	public void metricIsRemovedWhenCollectorIsNotUnregisteredYet() throws UnirestException {&lt;br/&gt;
    +		TaskManagerMetricGroup tmMetricGroup = new TaskManagerMetricGroup(registry, HOST_NAME, TASK_MANAGER);&lt;br/&gt;
    +&lt;br/&gt;
    +		String metricName = &quot;numRecordsOut&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +		Counter metric1 = new SimpleCounter();&lt;br/&gt;
    +		FrontMetricGroup&amp;lt;TaskManagerJobMetricGroup&amp;gt; metricGroup1 = new FrontMetricGroup&amp;lt;&amp;gt;(1, new TaskManagerJobMetricGroup(registry, tmMetricGroup, JobID.generate(), &quot;job_1&quot;));&lt;br/&gt;
    +		reporter.notifyOfAddedMetric(metric1, metricName, metricGroup1);&lt;br/&gt;
    +&lt;br/&gt;
    +		Counter metric2 = new SimpleCounter();&lt;br/&gt;
    +		FrontMetricGroup&amp;lt;TaskManagerJobMetricGroup&amp;gt; metricGroup2 = new FrontMetricGroup&amp;lt;&amp;gt;(2, new TaskManagerJobMetricGroup(registry, tmMetricGroup, JobID.generate(), &quot;job_2&quot;));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    PrometheusReporter does an explicit cast to FrontMetricGroup&lt;br/&gt;
    &lt;a href=&quot;https://github.com/jelmerk/flink/blob/642b21647d78653ebe6a3e9fad8f629599e10367/flink-metrics/flink-metrics-prometheus/src/main/java/org/apache/flink/metrics/prometheus/PrometheusReporter.java#L242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jelmerk/flink/blob/642b21647d78653ebe6a3e9fad8f629599e10367/flink-metrics/flink-metrics-prometheus/src/main/java/org/apache/flink/metrics/prometheus/PrometheusReporter.java#L242&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;ll fix the first argument&lt;/p&gt;</comment>
                            <comment id="16530986" author="githubbot" created="Tue, 3 Jul 2018 08:12:38 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6211&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;ve merged the PR, @jelmerk could you close it? Thanks!&lt;/p&gt;</comment>
                            <comment id="16530988" author="zentol" created="Tue, 3 Jul 2018 08:13:47 +0000"  >&lt;p&gt;master: 75d12f967ccef5df3c6c513765bb8db1106a7c87&lt;/p&gt;

&lt;p&gt;1.5: 903a323366b91a6f2f471f067462df9dd20cd3f4&lt;/p&gt;

&lt;p&gt;1.4: 7719fddbf570075465a7a81722f9412735e83e6e&lt;/p&gt;</comment>
                            <comment id="16531147" author="githubbot" created="Tue, 3 Jul 2018 10:02:04 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6211&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3v98v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>