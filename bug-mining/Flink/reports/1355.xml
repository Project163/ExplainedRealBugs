<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5326] IllegalStateException: Bug in Netty consumer logic: reader queue got notified by partition about available data,  but none was available</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5326</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-12-10 23:56:39,056 DEBUG org.apache.flink.runtime.io.network.partition.ResultPartition  - Source: control events generator (1/40) (3360ced43a57fed83904f22e93281ce0): Releasing ResultPartition e585300594a68036b0983cefaf048e17@3360ced43a57fed83904f22e93281ce0 [PIPELINED, 1 subpartitions, 0 pending references].
2016-12-10 23:56:39,056 INFO  org.apache.flink.runtime.taskmanager.Task                     - dynamic filter (1/40) (b1b7284e0b4a6ba08a16c50dcf13ff0d) switched from RUNNING to FAILED.
org.apache.flink.runtime.io.network.netty.exception.RemoteTransportException: Fatal error at remote task manager &lt;span class=&quot;code-quote&quot;&gt;&apos;permanent-qa-cluster-2wv1/10.240.0.27:45062&apos;&lt;/span&gt;.
        at org.apache.flink.runtime.io.network.netty.PartitionRequestClientHandler.decodeMsg(PartitionRequestClientHandler.java:229)
        at org.apache.flink.runtime.io.network.netty.PartitionRequestClientHandler.channelRead(PartitionRequestClientHandler.java:164)
        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:339)
        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:324)
        at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:103)
        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:339)
        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:324)
        at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:242)
        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:339)
        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:324)
        at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:847)
        at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:131)
        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:511)
        at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:468)
        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:382)
        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:354)
        at io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:111)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.IllegalStateException: Bug in Netty consumer logic: reader queue got notified by partition about available data, but none was available.
        at org.apache.flink.runtime.io.network.netty.PartitionRequestQueue.writeAndFlushNextMessageIfPossible(PartitionRequestQueue.java:177)
        at org.apache.flink.runtime.io.network.netty.PartitionRequestQueue.userEventTriggered(PartitionRequestQueue.java:111)
        at io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:308)
        at io.netty.channel.AbstractChannelHandlerContext.fireUserEventTriggered(AbstractChannelHandlerContext.java:294)
        at io.netty.channel.ChannelInboundHandlerAdapter.userEventTriggered(ChannelInboundHandlerAdapter.java:108)
        at io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:308)
        at io.netty.channel.AbstractChannelHandlerContext.fireUserEventTriggered(AbstractChannelHandlerContext.java:294)
        at io.netty.channel.ChannelInboundHandlerAdapter.userEventTriggered(ChannelInboundHandlerAdapter.java:108)
        at io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:308)
        at io.netty.channel.AbstractChannelHandlerContext.fireUserEventTriggered(AbstractChannelHandlerContext.java:294)
        at io.netty.channel.ChannelInboundHandlerAdapter.userEventTriggered(ChannelInboundHandlerAdapter.java:108)
        at io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:308)
        at io.netty.channel.AbstractChannelHandlerContext.fireUserEventTriggered(AbstractChannelHandlerContext.java:294)
        at io.netty.channel.DefaultChannelPipeline.fireUserEventTriggered(DefaultChannelPipeline.java:841)
        at org.apache.flink.runtime.io.network.netty.PartitionRequestQueue$1.run(PartitionRequestQueue.java:84)
        at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:357)
        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:357)
        ... 2 more
2016-12-10 23:56:39,073 INFO  org.apache.flink.runtime.taskmanager.Task                     - Freeing task resources &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; dynamic filter (1/40) (b1b7284e0b4a6ba08a16c50dcf13ff0d).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13027726">FLINK-5326</key>
            <summary>IllegalStateException: Bug in Netty consumer logic: reader queue got notified by partition about available data,  but none was available</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="uce">Ufuk Celebi</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                            <label>qa</label>
                    </labels>
                <created>Tue, 13 Dec 2016 09:07:00 +0000</created>
                <updated>Tue, 13 Dec 2016 13:04:30 +0000</updated>
                            <resolved>Tue, 13 Dec 2016 13:04:29 +0000</resolved>
                                    <version>1.1.4</version>
                    <version>1.2.0</version>
                                    <fixVersion>1.1.4</fixVersion>
                    <fixVersion>1.2.0</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15744737" author="mxm" created="Tue, 13 Dec 2016 10:03:31 +0000"  >&lt;p&gt;Is only 1.1.4 affected?&lt;/p&gt;</comment>
                            <comment id="15744744" author="uce" created="Tue, 13 Dec 2016 10:06:12 +0000"  >&lt;p&gt;No, 1.2.0 too.&lt;/p&gt;</comment>
                            <comment id="15744827" author="githubbot" created="Tue, 13 Dec 2016 10:38:49 +0000"  >&lt;p&gt;GitHub user uce opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2996&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5326&quot; title=&quot;IllegalStateException: Bug in Netty consumer logic: reader queue got notified by partition about available data,  but none was available&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5326&quot;&gt;&lt;del&gt;FLINK-5326&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Check release flag of parent in reader&lt;/p&gt;

&lt;p&gt;    In `PipelinedSubpartitionView`, there is a possible race with releasing the parent subpartition and querying for a buffer in the view.&lt;/p&gt;

&lt;p&gt;    The parent partition release clears all buffers in locked scope and releases the view outside of the lock. If concurrently the view is queried for a buffer it might get `null`, which is only allowed if the view was released.&lt;/p&gt;

&lt;p&gt;    Because the release is only forwarded out of the lock scope, this can happen before the release has propagated.&lt;/p&gt;

&lt;p&gt;    As a solution, we check the parent release status as well in the view. This is how it is handled in the spilled views, too.&lt;/p&gt;

&lt;p&gt;    This surfaced with the recent refactorings, because the previous consumption model required multiple rounds of `get, registerListener, isReleased` calls, which hid this problem. The added parent isReleased call does not affect normal operation as it is only checked when the returned buffer is null, which only happens when the partition is consumed or released. &lt;/p&gt;

&lt;p&gt;    &amp;#8212;&lt;/p&gt;

&lt;p&gt;    This needs to be applied to `release-1.1`, too.&lt;/p&gt;

&lt;p&gt;    cc @StephanEwen &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/uce/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/uce/flink&lt;/a&gt; 5326-illegal_state&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2996.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2996.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2996&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d965d5abdc389e9b65fd35a69bb16bfb71008504&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-12-13T10:26:47Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5326&quot; title=&quot;IllegalStateException: Bug in Netty consumer logic: reader queue got notified by partition about available data,  but none was available&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5326&quot;&gt;&lt;del&gt;FLINK-5326&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Check release flag of parent in reader&lt;/p&gt;

&lt;p&gt;    In PipelinedSubpartitionView, there is a possible race with&lt;br/&gt;
    releasing the parent subpartition and querying for a buffer&lt;br/&gt;
    in the view.&lt;/p&gt;

&lt;p&gt;    The parent partition release clears all buffers in locked&lt;br/&gt;
    scope and releases the view outside of the lock. If concurrently&lt;br/&gt;
    the view is queried for a buffer it might get null, which&lt;br/&gt;
    is only allowed if the view was released.&lt;/p&gt;

&lt;p&gt;    Because the release is only forwarded out of the lock scope,&lt;br/&gt;
    this can happen before the release has propagated.&lt;/p&gt;

&lt;p&gt;    As a solution, we check the parent release status as well in the&lt;br/&gt;
    view. This is how it is handled in the spilled views, too.&lt;/p&gt;

&lt;p&gt;    This surfaced with the recent refactorings, because the previous&lt;br/&gt;
    consumption model required multiple rounds of get, registerListener,&lt;br/&gt;
    isReleased calls, which hid this problem.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15745083" author="githubbot" created="Tue, 13 Dec 2016 12:52:43 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2996&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks good, +1 for this fix&lt;/p&gt;</comment>
                            <comment id="15745097" author="githubbot" created="Tue, 13 Dec 2016 12:59:29 +0000"  >&lt;p&gt;Github user uce closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2996&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15745115" author="uce" created="Tue, 13 Dec 2016 13:04:30 +0000"  >&lt;p&gt;Fixed in 04db15a, 9ed7752 (release-1.1) and d965d5a, fc62723 (master).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37j1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>