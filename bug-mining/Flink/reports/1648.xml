<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6353] Restoring using CheckpointedRestoring does not work from 1.2 to 1.2</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6353</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;State that was checkpointed using &lt;tt&gt;Checkpointed&lt;/tt&gt; (on a user function) cannot be restored using &lt;tt&gt;CheckpointedRestoring&lt;/tt&gt; when the savepoint was done on Flink 1.2. The reason is an overzealous check in &lt;tt&gt;AbstractUdfStreamOperator&lt;/tt&gt; that only restores from &quot;legacy&quot; operator state using &lt;tt&gt;CheckpointedRestoring&lt;/tt&gt; when the stream is a &lt;tt&gt;Migration&lt;/tt&gt; stream.&lt;/p&gt;

&lt;p&gt;We can remove that check but still need to make sure to read away the byte that indicates whether there is legacy state, which is written when we&apos;re restoring from a Flink 1.1 savepoint.&lt;/p&gt;

&lt;p&gt;Also, if we remove the check, the procedure for a user to migrate a user function away from the &lt;tt&gt;Checkpointed&lt;/tt&gt; interface is this:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Perform savepoint with user function still implementing &lt;tt&gt;Checkpointed&lt;/tt&gt;, shutdown job&lt;/li&gt;
	&lt;li&gt;Change user function to implement &lt;tt&gt;CheckpointedRestoring&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Restore from previous savepoint, user function has to somehow move the state that is restored using &lt;tt&gt;CheckpointedRestoring&lt;/tt&gt; to another type of state, .e.g operator state, using the &lt;tt&gt;OperatorStateStore&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Perform another savepoint, shutdown job&lt;/li&gt;
	&lt;li&gt;Remove &lt;tt&gt;CheckpointedRestoring&lt;/tt&gt; interface from user function&lt;/li&gt;
	&lt;li&gt;Restore from the second savepoint&lt;/li&gt;
	&lt;li&gt;Done.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If the &lt;tt&gt;CheckpointedRestoring&lt;/tt&gt; interface is not removed as prescribed in the last steps then a future restore of a new savepoint will fail because Flink will try to read legacy operator state that is not there anymore.&lt;/p&gt;

&lt;p&gt;The above steps also apply to Flink 1.3, when a user want&apos;s to move away from the &lt;tt&gt;Checkpointed&lt;/tt&gt; interface.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13065822">FLINK-6353</key>
            <summary>Restoring using CheckpointedRestoring does not work from 1.2 to 1.2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aljoscha">Aljoscha Krettek</assignee>
                                    <reporter username="aljoscha">Aljoscha Krettek</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Apr 2017 09:41:32 +0000</created>
                <updated>Tue, 19 Sep 2017 08:51:01 +0000</updated>
                            <resolved>Tue, 19 Sep 2017 08:51:01 +0000</resolved>
                                    <version>1.2.0</version>
                    <version>1.2.1</version>
                                                    <component>API / DataStream</component>
                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15979042" author="srichter" created="Fri, 21 Apr 2017 16:40:08 +0000"  >&lt;p&gt;Just a small idea: do you think that from a users perspective we should simply allow to implement both, &lt;tt&gt;Checkpointed&lt;/tt&gt; and the new &lt;tt&gt;CheckpointedFunction&lt;/tt&gt; with the result that &lt;tt&gt;CheckpointedFunction&lt;/tt&gt; overrides &lt;tt&gt;Checkpointed&lt;/tt&gt; for snapshots, essentially making it equivalent to &lt;tt&gt;CheckpointedRestoring&lt;/tt&gt;. We can log that that &lt;tt&gt;Checkpointed&lt;/tt&gt; is disabled on the snapshots. Then, starting from the next savepoint, the &lt;tt&gt;Checkpointed&lt;/tt&gt; interface could be dropped at any time, or kept for backwards compatibility. This way we could avoid fiddling around with too many different interfaces.&lt;/p&gt;

&lt;p&gt;Then the upgrade story is simply:&lt;/p&gt;

&lt;p&gt;1. Implement &lt;tt&gt;CheckpointedFunction&lt;/tt&gt;.&lt;br/&gt;
2. Drop &lt;tt&gt;Checkpointed&lt;/tt&gt; at convenience, when backwards compatibility is obsolete.&lt;/p&gt;</comment>
                            <comment id="15980977" author="aljoscha" created="Mon, 24 Apr 2017 10:25:00 +0000"  >&lt;p&gt;So having &lt;tt&gt;CheckpointedFunction&lt;/tt&gt; would mean that &lt;tt&gt;Checkpointed.snapshotState()&lt;/tt&gt; is never called while &lt;tt&gt;Checkpointed.restoreState()&lt;/tt&gt; is called only the first time we restore from a snapshot with legacy state. Correct? That sounds good and we could do it in addition to the complicated way, which just works without us adding anything once this fix is in.&lt;/p&gt;</comment>
                            <comment id="15980978" author="srichter" created="Mon, 24 Apr 2017 10:28:07 +0000"  >&lt;p&gt;Yes, that is the idea. After implementing &lt;tt&gt;CheckpointedFunction&lt;/tt&gt;, no more legacy state should be produced in future check/savepoints and therefore no more calls to &lt;tt&gt;Checkpointed::restoreState()&lt;/tt&gt; will happen when restoring from the those new check/savepoints. The old interface can then be kept or dropped at the user&apos;s convenience. I think all we need to change is just how some &lt;tt&gt;instanceof&lt;/tt&gt; checks are evaluated, iirc implementing both interfaces currently leads to a (intentional) runtime exception.&lt;/p&gt;</comment>
                            <comment id="15996523" author="stephanewen" created="Thu, 4 May 2017 10:34:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; With the set of tests that have gone into &lt;tt&gt;master&lt;/tt&gt; yesterday, is this issue solved?&lt;/p&gt;</comment>
                            <comment id="15996707" author="aljoscha" created="Thu, 4 May 2017 13:16:49 +0000"  >&lt;p&gt;It does work now, yes, with the process outlined in the description. I left it open because we might want to implement &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt;&apos;s idea to simplify the migration process. We can open a separate issue for that, though.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dx53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>