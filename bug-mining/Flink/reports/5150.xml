<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:54:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21707] Job is possible to hang when restarting a FINISHED task with POINTWISE BLOCKING consumers</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21707</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Job is possible to hang when restarting a FINISHED task with POINTWISE BLOCKING consumers. This is because &lt;tt&gt;PipelinedRegionSchedulingStrategy#onExecutionStateChange()&lt;/tt&gt; will try to schedule all the consumer tasks/regions of the finished &lt;b&gt;ExecutionJobVertex&lt;/b&gt;, even though the regions are not the exact consumers of the finished &lt;b&gt;ExecutionVertex&lt;/b&gt;. In this case, some of the regions can be in non-CREATED state because they are not connected to nor affected by the restarted tasks. However, &lt;tt&gt;PipelinedRegionSchedulingStrategy#maybeScheduleRegion()&lt;/tt&gt; does not allow to schedule a non-CREATED region and will throw an Exception and breaks the scheduling of all the other regions. One example to show this problem case can be found at &lt;a href=&quot;https://github.com/zhuzhurk/flink/commit/1eb036b6566c5cb4958d9957ba84dc78ce62a08c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PipelinedRegionSchedulingITCase#testRecoverFromPartitionException &lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To fix the problem, we can add a filter in &lt;tt&gt;PipelinedRegionSchedulingStrategy#onExecutionStateChange()&lt;/tt&gt; to only trigger the scheduling of regions in CREATED state.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13363447">FLINK-21707</key>
            <summary>Job is possible to hang when restarting a FINISHED task with POINTWISE BLOCKING consumers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zhuzh">Zhu Zhu</assignee>
                                    <reporter username="zhuzh">Zhu Zhu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 10 Mar 2021 07:54:36 +0000</created>
                <updated>Wed, 17 Mar 2021 04:20:06 +0000</updated>
                            <resolved>Tue, 16 Mar 2021 06:12:31 +0000</resolved>
                                    <version>1.12.2</version>
                    <version>1.13.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                    <fixVersion>1.12.3</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17298608" author="zhuzh" created="Wed, 10 Mar 2021 07:56:38 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17298666" author="mapohl" created="Wed, 10 Mar 2021 09:10:59 +0000"  >&lt;p&gt;Thanks for bringing this up, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;. This is related to how we handled the stop-with-savepoint issue in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21030&quot; title=&quot;Broken job restart for job with disjoint graph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21030&quot;&gt;&lt;del&gt;FLINK-21030&lt;/del&gt;&lt;/a&gt;, isn&apos;t it?&lt;/p&gt;

&lt;p&gt;I managed to reproduce the hanging job locally with the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt; suggest. We run into the following exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.reflect.InvocationTargetException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_265]
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_265]
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_265]
	at java.lang.reflect.Method.invoke(Method.java:498) ~[?:1.8.0_265]
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcInvocation(AkkaRpcActor.java:305) ~[classes/:?]
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:212) ~[classes/:?]
	at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleRpcMessage(FencedAkkaRpcActor.java:77) ~[classes/:?]
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleMessage(AkkaRpcActor.java:158) ~[classes/:?]
	at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:26) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:21) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at scala.PartialFunction$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;applyOrElse(PartialFunction.scala:123) [scala-library-2.11.12.jar:?]
	at akka.japi.pf.UnitCaseStatement.applyOrElse(CaseStatements.scala:21) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:170) [scala-library-2.11.12.jar:?]
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171) [scala-library-2.11.12.jar:?]
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171) [scala-library-2.11.12.jar:?]
	at akka.actor.Actor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;aroundReceive(Actor.scala:517) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.actor.AbstractActor.aroundReceive(AbstractActor.scala:225) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:592) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.actor.ActorCell.invoke(ActorCell.scala:561) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:258) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.Mailbox.run(Mailbox.scala:225) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.Mailbox.exec(Mailbox.scala:235) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979) [akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107) [akka-actor_2.11-2.5.21.jar:2.5.21]
Caused by: java.lang.IllegalStateException: BUG: trying to schedule a region which is not in CREATED state
	at org.apache.flink.util.Preconditions.checkState(Preconditions.java:193) ~[classes/:?]
	at org.apache.flink.runtime.scheduler.strategy.PipelinedRegionSchedulingStrategy.maybeScheduleRegion(PipelinedRegionSchedulingStrategy.java:162) ~[classes/:?]
	at org.apache.flink.runtime.scheduler.strategy.PipelinedRegionSchedulingStrategy.maybeScheduleRegions(PipelinedRegionSchedulingStrategy.java:153) ~[classes/:?]
	at org.apache.flink.runtime.scheduler.strategy.PipelinedRegionSchedulingStrategy.onExecutionStateChange(PipelinedRegionSchedulingStrategy.java:141) ~[classes/:?]
	at org.apache.flink.runtime.scheduler.DefaultScheduler.updateTaskExecutionStateInternal(DefaultScheduler.java:201) ~[classes/:?]
	at org.apache.flink.runtime.scheduler.SchedulerBase.updateTaskExecutionState(SchedulerBase.java:699) ~[classes/:?]
	at org.apache.flink.runtime.scheduler.SchedulerNG.updateTaskExecutionState(SchedulerNG.java:80) ~[classes/:?]
	at org.apache.flink.runtime.jobmaster.JobMaster.updateTaskExecutionState(JobMaster.java:433) ~[classes/:?]
	... 26 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17298711" author="till.rohrmann" created="Wed, 10 Mar 2021 09:56:44 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;. Why do we have to wait for a blocking intermediate result to be fully produced before scheduling independent consumers? Not having to do this could allow us to get rid of the &lt;tt&gt;PipelinedRegionSchedulingStrategy.correlatedResultPartitions&lt;/tt&gt; and avoid the problem you are describing. Is it because we want to support stage wise scheduling?&lt;/p&gt;

&lt;p&gt;If this is strictly required, then your proposal should work. However, I am bit hesitant because it feels as if we are complicating things a bit and that these special cases makes everything a bit more brittle.&lt;/p&gt;

&lt;p&gt;As a side comment: We should make sure that these kind of &lt;tt&gt;IllegalStateException&lt;/tt&gt; don&apos;t only show up when the DEBUG log is enabled. Instead, we should fail hard.&lt;/p&gt;</comment>
                            <comment id="17298809" author="zhuzh" created="Wed, 10 Mar 2021 12:55:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; Sorry for the confusing. It is not related to stop-with-savepoint. It is a BUG of &lt;tt&gt;PipelinedRegionSchedulingStrategy&lt;/tt&gt;. And thanks a lot that the exception you post clearly shows the problem. (I did not tried debug log so it take me quite some time to figure out the cause)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; &lt;br/&gt;
&amp;gt;&amp;gt; Why do we have to wait for a blocking intermediate result to be fully produced before scheduling independent consumers?&lt;br/&gt;
I think it is not strictly required. But Flink was scheduling batch jobs in stage-wise pattern so pipelined region scheduling was designed to be aligned with it.&lt;br/&gt;
In Blink version the scheduler was already reworked to trigger the scheduling of BLOCKING partition downstream vertices individually. It has been working well so I think it&apos;s safe to also do this for Flink.&lt;br/&gt;
One known side effect is the computing complexity will increase because we now need to check all the consumers for each finished partition. However, with the improvement &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21328&quot; title=&quot;Optimize the initialization of DefaultExecutionTopology&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21328&quot;&gt;&lt;del&gt;FLINK-21328&lt;/del&gt;&lt;/a&gt; the performance will no longer be a problem.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; We should make sure that these kind of IllegalStateException don&apos;t only show up when the DEBUG log is enabled. Instead, we should fail hard.&lt;br/&gt;
Big +1. The trouble shooting took me quite some time because the root error was not printed in INFO logs. What I am thinking is to wrap all the invocations on SchedulingStrategy methods with a try-catch and fail globally when any exception is caught. This is because the call stack can be quite deep and complex considering the underlying &lt;tt&gt;DefaultScheduler&lt;/tt&gt; and &lt;tt&gt;ExecutionSlotAllocator&lt;/tt&gt;. And we actually do not expect any exception to be thrown directly in these invocations. WDYT?&lt;/p&gt;</comment>
                            <comment id="17298880" author="till.rohrmann" created="Wed, 10 Mar 2021 14:45:11 +0000"  >&lt;p&gt;Whether to schedule it stage-wise or not could be a concern of the scheduler and not the underlying &lt;tt&gt;IntermediateResult&lt;/tt&gt; and &lt;tt&gt;IntermediateResultPartition&lt;/tt&gt;. Hence, I would be in favour of removing this logic from the &lt;tt&gt;IntermediateResult&lt;/tt&gt;/&lt;tt&gt;IntermediateResultPartition&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Maybe we can create a &lt;tt&gt;FatallyFailingSchedulerNGWrapper&lt;/tt&gt; which does the failing if an exception occurs. That way it would work for all &lt;tt&gt;SchedulerNG&lt;/tt&gt; implementations.&lt;/p&gt;</comment>
                            <comment id="17299293" author="zhuzh" created="Thu, 11 Mar 2021 03:56:29 +0000"  >&lt;p&gt;Agreed to &quot;removing this logic from the IntermediateResult/IntermediateResultPartition&quot;. However, given that the problem of this ticket also exists in 1.11/1.12, how about we do a simple fix for this ticket first as the initial proposal and open a separate 1.13 ticket to change the step-wise scheduling logic? &lt;/p&gt;

&lt;p&gt;Regarding &lt;tt&gt;FatallyFailingSchedulerNGWrapper&lt;/tt&gt;, I can see that currently exceptions are acceptable for some of the RPCs, e.g. &lt;tt&gt;requestNextInputSplit(), requestPartitionState()&lt;/tt&gt; and I do not have confidence to find out all this kind of RPCs at the moment. If we always fail the job on exceptions, Flink might become more unstable than it is. Currently what I can only say that direct exceptions from &lt;tt&gt;updateTaskExecutionState()&lt;/tt&gt; are not expected. So how about we just do try-catch for &lt;tt&gt;updateTaskExecutionState()&lt;/tt&gt; in JobMaster? It can also work for all SchedulerNG implementations. And I also prefer it to be a separate task for 1.13 only to give it more exposure time.&lt;/p&gt;</comment>
                            <comment id="17299443" author="till.rohrmann" created="Thu, 11 Mar 2021 09:43:05 +0000"  >&lt;p&gt;Both proposals sound good to me. Do you have time to work on it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17299534" author="zhuzh" created="Thu, 11 Mar 2021 12:43:51 +0000"  >&lt;p&gt;I have a fix for it already so I will take this ticket.&lt;br/&gt;
I opened 2 other tickets &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21734&quot; title=&quot;Allow BLOCKING result partition to be individually consumable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21734&quot;&gt;&lt;del&gt;FLINK-21734&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21735&quot; title=&quot;Harden JobMaster#updateTaskExecutionState()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21735&quot;&gt;&lt;del&gt;FLINK-21735&lt;/del&gt;&lt;/a&gt; according to the discussion but may not be able to work on them soon. Anyone else who are interested can take them, or I can also get back to them one or two weeks later.&lt;/p&gt;</comment>
                            <comment id="17302241" author="zhuzh" created="Tue, 16 Mar 2021 06:12:31 +0000"  >&lt;p&gt;fixed via:&lt;br/&gt;
master(1.13): c1aa6b41841342ddf6e168f326a183db8a8edcac&lt;br/&gt;
1.12: f935621fb357613a501cbd285a88b0a470758878&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13363829">FLINK-21734</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13363835">FLINK-21735</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 35 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ohig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>