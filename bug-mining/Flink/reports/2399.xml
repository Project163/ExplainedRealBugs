<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8533] Support MasterTriggerRestoreHook state reinitialization</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8533</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;tt&gt;MasterTriggerRestoreHook&lt;/tt&gt; enables coordination with an external system for taking or restoring checkpoints. When execution is restarted from a checkpoint, &lt;tt&gt;restoreCheckpoint&lt;/tt&gt; is called to restore or reinitialize the external system state. There&apos;s an edge case where the external state is not adequately reinitialized, that is when execution fails &lt;em&gt;before the first checkpoint&lt;/em&gt;. In that case, the hook is not invoked and has no opportunity to restore the external state to initial conditions.&lt;/p&gt;

&lt;p&gt;The impact is a loss of exactly-once semantics in this case. For example, in the Pravega source function, the reader group state (e.g. stream position data) is stored externally. In the normal restore case, the reader group state is forcibly rewound to the checkpointed position. In the edge case where no checkpoint has yet been successful, the reader group state is not rewound and consequently some amount of stream data is not reprocessed.&lt;/p&gt;

&lt;p&gt;A possible fix would be to introduce an &lt;tt&gt;initializeState&lt;/tt&gt; method on the hook interface. Similar to &lt;tt&gt;CheckpointedFunction::initializeState&lt;/tt&gt;, this method would be invoked unconditionally upon hook initialization. The Pravega&#160;hook&#160;would, for example, initialize or forcibly reinitialize the reader group state.&#160; &#160;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13135008">FLINK-8533</key>
            <summary>Support MasterTriggerRestoreHook state reinitialization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="eronwright">Eron Wright</assignee>
                                    <reporter username="eronwright">Eron Wright</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Jan 2018 08:01:19 +0000</created>
                <updated>Wed, 9 May 2018 07:56:09 +0000</updated>
                            <resolved>Wed, 9 May 2018 07:56:04 +0000</resolved>
                                    <version>1.3.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16346400" author="eronwright" created="Wed, 31 Jan 2018 08:04:40 +0000"  >&lt;p&gt;This relates to &lt;a href=&quot;https://github.com/pravega/flink-connectors/issues/89&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;issue #89&lt;/a&gt; in flink-connectors. &lt;br/&gt;
cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="16348017" author="eronwright" created="Thu, 1 Feb 2018 05:06:43 +0000"  >&lt;p&gt;Incidentally, a variation on this problem would (I believe) occur when using the Kafka consumer and &lt;tt&gt;setStartFromGroupOffsets&lt;/tt&gt; is enabled.   That&apos;s because the Kafka connector uses external storage to initialize its state (i.e. the starting position) in the non-restore case.&lt;/p&gt;</comment>
                            <comment id="16356449" author="githubbot" created="Thu, 8 Feb 2018 03:46:31 +0000"  >&lt;p&gt;GitHub user EronWright opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8533&quot; title=&quot;Support MasterTriggerRestoreHook state reinitialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8533&quot;&gt;&lt;del&gt;FLINK-8533&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;checkpointing&amp;#93;&lt;/span&gt; Support MasterTriggerRestoreHook state reinitialization&lt;/p&gt;


&lt;p&gt;    Signed-off-by: Eron Wright &amp;lt;eronwright@gmail.com&amp;gt;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;br/&gt;
    Support MasterTriggerRestoreHook state re-initialization, to eliminate an edge case involving execution restarts where no checkpoint state is available.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;extend `MasterTriggerRestoreHook` with `initializeState` method.&lt;/li&gt;
	&lt;li&gt;invoke `initializeState` upon initial execution and upon global restart.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Revised test: `CheckpointCoordinatorMasterHooksTest`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency):  no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`:  *&lt;b&gt;yes&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: *&lt;b&gt;yes&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The S3 file system connector:  no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature?  no&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/EronWright/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/EronWright/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8533&quot; title=&quot;Support MasterTriggerRestoreHook state reinitialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8533&quot;&gt;&lt;del&gt;FLINK-8533&lt;/del&gt;&lt;/a&gt;-hook-initialization&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5427&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 9ad0e03c1aa81012ae14f598acdcf3eb76c9ec9f&lt;br/&gt;
Author: Eron Wright &amp;lt;eronwright@...&amp;gt;&lt;br/&gt;
Date:   2018-02-08T03:38:47Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8533&quot; title=&quot;Support MasterTriggerRestoreHook state reinitialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8533&quot;&gt;&lt;del&gt;FLINK-8533&lt;/del&gt;&lt;/a&gt; Support MasterTriggerRestoreHook state reinitialization&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;extend `MasterTriggerRestoreHook` with `initializeState` method.&lt;/li&gt;
	&lt;li&gt;invoke `initializeState` upon initial execution and upon global&lt;br/&gt;
    restart.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Signed-off-by: Eron Wright &amp;lt;eronwright@gmail.com&amp;gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16356450" author="githubbot" created="Thu, 8 Feb 2018 03:47:30 +0000"  >&lt;p&gt;Github user EronWright commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tzulitai @StephanEwen please take a look, thanks.&lt;/p&gt;</comment>
                            <comment id="16360404" author="tzulitai" created="Mon, 12 Feb 2018 07:57:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eronwright&quot; class=&quot;user-hover&quot; rel=&quot;eronwright&quot;&gt;eronwright&lt;/a&gt;thanks for the heads up on this ticket.&lt;/p&gt;

&lt;p&gt;Regarding your comment on the Kafka connector&apos;s `setStartFromGroupOffsets`:&lt;br/&gt;
The problem should, AFAIK, not occur there because we differentiate between having some restored state / no restored state, when determining whether or not to respect the `StartupMode`.&lt;/p&gt;

&lt;p&gt;But yes, for the Pravega connector, I think this is valid. Will take a look at the pull request soon.&lt;/p&gt;</comment>
                            <comment id="16361128" author="githubbot" created="Mon, 12 Feb 2018 17:33:52 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Given the already non-trivial complexity of the `CheckpointCoordinator`, I am wondering if there is a way to do this without adding the `resetForNewExecution()` method.&lt;/p&gt;

&lt;p&gt;    Adding another life cycle method (even if it is not exploited for other purposes currently) would need more involved tests and make future maintenance harder.&lt;/p&gt;

&lt;p&gt;    Can we reset all hooks in the `restoreLatestCheckpointedState()` method? Would we miss any cases if we do only that? &lt;/p&gt;</comment>
                            <comment id="16361295" author="githubbot" created="Mon, 12 Feb 2018 19:10:54 +0000"  >&lt;p&gt;Github user EronWright commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen thanks for taking a look, I agree with trying to avoid a new lifecycle method.&lt;/p&gt;

&lt;p&gt;    The `initializeState` method on the hook interface gives the hook an unconditional initialization point. &lt;br/&gt;
    In the Pravega case, we would move reader-group (RG) initialization from client to server, and always reset the RG to its initial conditions.   A subsequent restore may or may not occur.&lt;/p&gt;

&lt;p&gt;    Assuming we like this approach, let&apos;s discuss how to make it work purely with `restoreLatestCheckpointedState`.   The `restoreLatestCheckpointedState` method is not called by the ExecutionGraph (EG) upon initial execution, which we would want to support the new `initializeState` method.   Would there be any issue with calling `restoreLatestCheckpointedState` on initial execution? Such symmetry would seem desirable.  &lt;/p&gt;

&lt;p&gt;    *&lt;b&gt;Existing approach&lt;/b&gt;*:&lt;br/&gt;
    ```&lt;br/&gt;
    === initial ===&lt;br/&gt;
    &amp;#45;- JM.submitJob&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- EG.scheduleForExecution&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;    === restart===&lt;br/&gt;
    &amp;#45;- RestartCallback.triggerFullRecovery&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- EG.restart&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- CC.restoreLatestCheckpointedState&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- EG.scheduleForExecution&lt;br/&gt;
    ```&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;    *&lt;b&gt;Suggested approach&lt;/b&gt;*:&lt;br/&gt;
    ```&lt;br/&gt;
    === initial ===&lt;br/&gt;
    &amp;#45;- JM.submitJob&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- EG.start  (** new method **)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- CC.restoreLatestCheckpointedState&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- Hook.initializeState&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- EG.scheduleForExecution&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;    === restart===&lt;br/&gt;
    &amp;#45;- RestartCallback.triggerFullRecovery&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- EG.restart&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- CC.restoreLatestCheckpointedState&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- Hook.initializeState&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &amp;#45;- EG.scheduleForExecution&lt;br/&gt;
    ```&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16362662" author="githubbot" created="Tue, 13 Feb 2018 16:59:59 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think we may get around adding a new method. I checked with @tillrohrmann , here are the thoughts:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Submitting a job initially as a new reader group, no need to reset here&lt;/li&gt;
	&lt;li&gt;Recovering at any point calls the `restoreLatestCheckpointedState()` method&lt;/li&gt;
	&lt;li&gt;Also recovering from a JobManager failover basically &quot;resubmits&quot; the job with a special flag causing the JM to call the `restoreLatestCheckpointedState()` for the job.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16362722" author="githubbot" created="Tue, 13 Feb 2018 17:39:20 +0000"  >&lt;p&gt;Github user EronWright commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen do you mean that we could avoid adding an initialization method to the hook interface?  We need to somehow call into the hook to reset its state, even when there&apos;s no checkpoint data to work with.   Could you rephrase your suggestion?  Thanks.&lt;/p&gt;</comment>
                            <comment id="16363764" author="githubbot" created="Wed, 14 Feb 2018 10:44:03 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @EronWright, you&apos;re right that on initial submission we don&apos;t call `restoreLatestCheckpointedState` in the old code. With Flip-6 this will be the case. See #5444.&lt;/p&gt;

&lt;p&gt;    The underlying assumption to make this work, though, is that a user won&apos;t submit a new job with the a job id to a cluster with a cluster id for which ZooKeeper already contains persisted checkpoints from a previous run. So either the cluster id or the job id must be different. &lt;/p&gt;

&lt;p&gt;    I think so far, when using the Flink client this should be the case. However, when generating the `JobGraph` yourself and keeping it around to submit it to a standalone cluster, then this assumption will break because both the `JobID` and the cluster id will be the same.&lt;/p&gt;</comment>
                            <comment id="16364336" author="githubbot" created="Wed, 14 Feb 2018 16:06:49 +0000"  >&lt;p&gt;Github user EronWright commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I feel that we&apos;re not addressing the core issue that we&apos;re trying to fix.   &lt;br/&gt;
    1. A new job starts up with checkpointing enabled and a hook-based source.&lt;br/&gt;
    2. The source begins to consume events, causing some external state to become mutated.&lt;br/&gt;
    3. &lt;em&gt;Before the first checkpoint&lt;/em&gt;, a task throws an exception, causing a global restart.&lt;br/&gt;
    4. Since the hook has no opportunity to rewind the external state to initial conditions, data loss occurs.&lt;/p&gt;

&lt;p&gt;    The above is a special case.  In the normal case, one or more checkpoints have occurred before the restart occurs, and so the hook&apos;s `restore` method is effective.&lt;/p&gt;
</comment>
                            <comment id="16365234" author="githubbot" created="Thu, 15 Feb 2018 08:26:05 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think we are talking about two different things here:&lt;/p&gt;

&lt;p&gt;      1. We DO need a new method on the hook interface to reinitialize the reader group. I think the one suggested by Eron works.&lt;br/&gt;
      2. We DO NOT need a new method on the CheckpointCoordinator, but calling `Hook.initializeState()` within `CC.restoreLatestCheckpointedState()` (whenever there is no checkpoint to be restored) should work.&lt;/p&gt;

&lt;p&gt;    ==&amp;gt; Let&apos;s add the Hook method, but not add an additional method to the CheckpointCoordinator.&lt;/p&gt;</comment>
                            <comment id="16419889" author="githubbot" created="Thu, 29 Mar 2018 22:30:18 +0000"  >&lt;p&gt;Github user EronWright commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tillrohrmann @StephanEwen sorry about the long delay here, would you please take another look?&lt;/p&gt;

&lt;p&gt;    I followed Stephan&apos;s suggestion of not introducing a new method.   However, the semantics that I was shooting for with `initializeState` is that it would be called on both &lt;em&gt;start&lt;/em&gt; and &lt;em&gt;restart&lt;/em&gt;.  I adjusted `JobManager` to call `restoreLatestCheckpointedState` on first execution (as does `JobMaster`).  Are you OK with that?&lt;/p&gt;</comment>
                            <comment id="16454651" author="githubbot" created="Thu, 26 Apr 2018 18:13:30 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427#discussion_r184477785&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427#discussion_r184477785&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java &amp;#8212;&lt;br/&gt;
    @@ -1009,6 +1013,11 @@ public boolean restoreLatestCheckpointedState(&lt;/p&gt;

&lt;p&gt;     			LOG.debug(&quot;Status of the shared state registry after restore: {}.&quot;, sharedStateRegistry);&lt;/p&gt;

&lt;p&gt;    +			// Instruct the master hooks to initialize their state (unconditionally)&lt;br/&gt;
    +			LOG.debug(&quot;Initializing the master hooks.&quot;);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Can you elaborate a bit why this initialization is happening in all cases?&lt;br/&gt;
    An alternative would be to have a `reset()` method or so on the master hook that is called further below, in the `if (latest == null)` code block.&lt;/p&gt;

&lt;p&gt;    Initializing the state seems a tad bit unituitive to me here - I somehow assume that an init function is called once, while this one here is called on every restore.&lt;/p&gt;</comment>
                            <comment id="16454652" author="githubbot" created="Thu, 26 Apr 2018 18:13:30 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427#discussion_r184481704&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427#discussion_r184481704&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/hooks/MasterHooks.java &amp;#8212;&lt;br/&gt;
    @@ -291,6 +341,34 @@ else if (!allowUnmatchedState) &lt;/p&gt;
{
     			this.userClassLoader = Preconditions.checkNotNull(userClassLoader);
     		}

&lt;p&gt;    +		@Override&lt;br/&gt;
    +		public void initializeState(HookInitializationContext context) throws Exception {&lt;br/&gt;
    +			final Thread thread = Thread.currentThread();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    We could use a utility like:&lt;br/&gt;
    ```java&lt;br/&gt;
    public static void withContextClassLoader(ClassLoader cl, Runnable r) {&lt;br/&gt;
        final Thread thread = Thread.currentThread();&lt;br/&gt;
        final ClassLoader originalClassLoader = thread.getContextClassLoader();&lt;/p&gt;

&lt;p&gt;        try &lt;/p&gt;
{
            thread.setContextClassLoader(userClassLoader);
            r.run();
        }
&lt;p&gt;        finally &lt;/p&gt;
{
            thread.setContextClassLoader(originalClassLoader);
        }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;    withContextClassLoader(userClassLoader, () -&amp;gt; &lt;/p&gt;
{ hook.initializeState(context); }
&lt;p&gt;);&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    How about adding that to `org.apache.flink.util.LambdaUtil`?&lt;/p&gt;</comment>
                            <comment id="16454653" author="githubbot" created="Thu, 26 Apr 2018 18:13:30 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427#discussion_r184482881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427#discussion_r184482881&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1358,6 +1358,10 @@ class JobManager(&lt;br/&gt;
                       throw new SuppressRestartsException(e)&lt;br/&gt;
                   }&lt;br/&gt;
                 }&lt;br/&gt;
    +            else {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    If we did not have the unconditional initialization logic, we should also be able to drop this part. That would also make this work with the flip-6 code.&lt;/p&gt;</comment>
                            <comment id="16454654" author="githubbot" created="Thu, 26 Apr 2018 18:13:30 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427#discussion_r184478068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427#discussion_r184478068&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/MasterTriggerRestoreHook.java &amp;#8212;&lt;br/&gt;
    @@ -138,4 +158,11 @@&lt;br/&gt;
     		 */&lt;br/&gt;
     		&amp;lt;V&amp;gt; MasterTriggerRestoreHook&amp;lt;V&amp;gt; create();&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * The hook initialization context.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	interface HookInitializationContext {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I assume this is for ease of future evolvability?&lt;/p&gt;</comment>
                            <comment id="16464530" author="githubbot" created="Sat, 5 May 2018 00:25:09 +0000"  >&lt;p&gt;Github user EronWright commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen thanks again for the feedback, which I took to heart and simplified the hook.  It now has a `reset ` method that is called only in the special case.&lt;/p&gt;

&lt;p&gt;    I will refactor the thread context code in a separate PR.&lt;/p&gt;
</comment>
                            <comment id="16465742" author="githubbot" created="Mon, 7 May 2018 10:20:50 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks a lot, looks good, can merge this now.&lt;/p&gt;

&lt;p&gt;    One quick question: You decided to have empty default implementations for the new methods in the master hook interface. Given that Pravega is currently the only known user of that interface, I would be okay with breaking the interface (no default methods) if you think that would be cleaner.&lt;/p&gt;</comment>
                            <comment id="16468521" author="githubbot" created="Wed, 9 May 2018 07:55:38 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5427&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16468522" author="stephanewen" created="Wed, 9 May 2018 07:56:04 +0000"  >&lt;p&gt;Fixed in&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1.5.0 via e3b193961583421b1bf6e67d84842d02b0321815&lt;/li&gt;
	&lt;li&gt;1.6.0 via af29172bf555558e579a92f0ee3e56ed76fd7a1a&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3pkzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>