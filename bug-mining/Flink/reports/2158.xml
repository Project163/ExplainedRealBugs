<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8306] FlinkKafkaConsumerBaseTest has invalid mocks on final methods</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8306</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;FlinkKafkaConsumerBaseTest&lt;/tt&gt; has invalid mocks on a final &lt;tt&gt;AbstractFetcher::commitInternalOffsetsToKafka(...)&lt;/tt&gt; method. While an easy fix would be to simply make that method non-final, that is not ideal since it would be best that the method is left final to prevent overrides in subclasses.&lt;/p&gt;

&lt;p&gt;This suggests that offset committing functionality is too tightly coupled with the &lt;tt&gt;AbstractFetcher&lt;/tt&gt;, making it hard to perform concise tests to verify offset committing.&lt;/p&gt;

&lt;p&gt;I suggest that we decouple record fetching and offset committing as separate services behind different interfaces. We should introduce a new interface, say &lt;tt&gt;KafkaOffsetCommitter&lt;/tt&gt;, and test against that instead. Initially, we can simply let &lt;tt&gt;AbstractFetcher&lt;/tt&gt; implement &lt;tt&gt;KafkaOffsetCommitter&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13126632">FLINK-8306</key>
            <summary>FlinkKafkaConsumerBaseTest has invalid mocks on final methods</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tzulitai">Tzu-Li (Gordon) Tai</assignee>
                                    <reporter username="tzulitai">Tzu-Li (Gordon) Tai</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Dec 2017 18:52:48 +0000</created>
                <updated>Sat, 13 Jan 2018 08:13:01 +0000</updated>
                            <resolved>Sat, 13 Jan 2018 08:13:01 +0000</resolved>
                                                    <fixVersion>1.4.1</fixVersion>
                    <fixVersion>1.5.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16300588" author="githubbot" created="Thu, 21 Dec 2017 21:51:11 +0000"  >&lt;p&gt;GitHub user tzulitai opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8306&quot; title=&quot;FlinkKafkaConsumerBaseTest has invalid mocks on final methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8306&quot;&gt;&lt;del&gt;FLINK-8306&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Introduce KafkaOffsetCommitter interface&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR is built upon the reworked `FlinkKafkaConsumerBaseTest` in #5188.&lt;/p&gt;

&lt;p&gt;    Prior to this PR, offset committing was coupled tightly with the `AbstractFetcher`, making unit tests for offset committing behaviours hard to compose concisely. For example, we had tests that required mocking the offset commit methods on `AbstractFetcher`, while ideally, it would be best that those methods are made final (thus, unable to be mocked) to prevent accidental overrides.&lt;/p&gt;

&lt;p&gt;    This PR decouples offset committing as a separate service behind a new `KafkaOffsetCommitter` interface. For now, the `AbstractFetcher` is reused as an implementation of this service, so that this PR does not introduce any more change other than introducing a new layer of abstraction.&lt;/p&gt;

&lt;p&gt;    Unit tests that verify offset committing behaviour now provide a dummy verifiable implementation of the `KafkaOffsetCommitter` (instead of using mocks on `AbstractFetcher`) and test against that.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Migrate `AbstractFetcher::commitInternalOffsetsToKafka` method to the newly introduced `KafkaOffsetCommitter` interface.&lt;/li&gt;
	&lt;li&gt;Let `AbstractFetcher` implement `KafkaOffsetCommitter`&lt;/li&gt;
	&lt;li&gt;In the `FlinkKafkaConsumerBase`, let &quot;offset committing&quot; and &quot;record fetching&quot; be logically separated to be handled by two services, i.e. namely a `KafkaOffsetCommitter` and a `AbstractFetcher`. Physically, the fetcher instance sits behind both service abstractions.&lt;/li&gt;
	&lt;li&gt;In `FlinkKafkaConsumerBaseTest`, remove all mocks on `AbstractFetcher::commitInternalOffsetsToKafka`, and test against a `KafkaOffsetCommitter` instead.&lt;/li&gt;
	&lt;li&gt;Additional hotfix 2906968 that fixes a stale comment referring to an old `AbstractFetcher` behaviour to avoid confusion.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR does not add any new functionality. Reworked test also do not affect test coverage.&lt;br/&gt;
    `FlinkKafkaConsumerBaseTest` verifies all changes.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: no&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? n/a&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tzulitai/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tzulitai/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8306&quot; title=&quot;FlinkKafkaConsumerBaseTest has invalid mocks on final methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8306&quot;&gt;&lt;del&gt;FLINK-8306&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5200&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit cb3f488877b7fb2ab0dfcc5c24fe53035bc765e7&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2017-12-20T00:10:44Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8296&quot; title=&quot;Rework FlinkKafkaConsumerBestTest to not use Java reflection for dependency injection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8296&quot;&gt;&lt;del&gt;FLINK-8296&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Rework FlinkKafkaConsumerBaseTest to not rely on Java reflection&lt;/p&gt;

&lt;p&gt;    Reflection was mainly used to inject mocks into private fields of the&lt;br/&gt;
    FlinkKafkaConsumerBase, without the need to fully execute all operator&lt;br/&gt;
    life cycle methods. This, however, caused the unit tests to be too&lt;br/&gt;
    implementation-specific.&lt;/p&gt;

&lt;p&gt;    This commit reworks the FlinkKafkaConsumerBaseTest to remove test&lt;br/&gt;
    consumer instantiation methods that rely on reflection for dependency&lt;br/&gt;
    injection. All tests now instantiate dummy test consumers normally, and&lt;br/&gt;
    let all tests properly execute all operator life cycle methods&lt;br/&gt;
    regardless of the tested logic.&lt;/p&gt;

&lt;p&gt;commit 21491d567ef5d3b8294deec2890b48900c22dd56&lt;br/&gt;
Author: Nico Kruber &amp;lt;nico@...&amp;gt;&lt;br/&gt;
Date:   2017-12-19T17:14:19Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8295&quot; title=&quot;Netty shading does not work properly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8295&quot;&gt;&lt;del&gt;FLINK-8295&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;build&amp;#93;&lt;/span&gt; Properly shade netty for the datastax driver&lt;/p&gt;

&lt;p&gt;    com.datastax.driver.core.NettyUtil expects netty to be present either at its&lt;br/&gt;
    original package or relocated to com.datastax.shaded.netty. By relocating it&lt;br/&gt;
    to this package we make sure the driver follows its designated path.&lt;/p&gt;

&lt;p&gt;    This closes #5183.&lt;/p&gt;

&lt;p&gt;commit ef40aaa9d942cc49c3d51816eacdaa5e7dbe9fa5&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2017-12-19T19:55:16Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8306&quot; title=&quot;FlinkKafkaConsumerBaseTest has invalid mocks on final methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8306&quot;&gt;&lt;del&gt;FLINK-8306&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Introduce KafkaOffsetCommitter interface&lt;/p&gt;

&lt;p&gt;    Prior to this commit, offset committing was coupled tightly with the&lt;br/&gt;
    AbstractFetcher, making unit tests for offset committing behaviours hard&lt;br/&gt;
    to compose concisely. For example, we had tests that mock the offset&lt;br/&gt;
    commit methods on AbstractFetcher, while ideally, it would be best that&lt;br/&gt;
    those methods are made final to prevent accidental overrides.&lt;/p&gt;

&lt;p&gt;    This commit decouples offset committing as a separate service behind a&lt;br/&gt;
    new KafkaOffsetCommitter interface. For now, the AbstractFetcher is&lt;br/&gt;
    reused as an implementation of this service.&lt;/p&gt;

&lt;p&gt;    Unit tests that verify offset committing behaviour now provide a dummy&lt;br/&gt;
    verifyable implementation of the KafkaOffsetCommitter, instead of using&lt;br/&gt;
    mocks on AbstractFetcher.&lt;/p&gt;

&lt;p&gt;commit 59917867ed19bf9f1ef9b6fba696983675e2747e&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2017-12-20T19:54:40Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Remove stale comment on publishing procedures of AbstractFetcher&lt;/p&gt;

&lt;p&gt;    The previous comment mentioned &quot;only now will the fetcher return at&lt;br/&gt;
    least the restored offsets when calling snapshotCurrentState()&quot;. This is&lt;br/&gt;
    a remnant of the previous fetcher initialization behaviour, where in the&lt;br/&gt;
    past the fetcher wasn&apos;t directly seeded with restored offsets on&lt;br/&gt;
    instantiation.&lt;/p&gt;

&lt;p&gt;    Since this is no longer true, this commit fixes the stale comment to&lt;br/&gt;
    avoid confusion.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16316105" author="githubbot" created="Mon, 8 Jan 2018 10:57:25 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200#discussion_r160103116&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200#discussion_r160103116&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaConsumerBase.java &amp;#8212;&lt;br/&gt;
    @@ -887,4 +894,9 @@ OffsetCommitMode getOffsetCommitMode() {&lt;br/&gt;
     	LinkedMap getPendingOffsetsToCommit() &lt;/p&gt;
{
     		return pendingOffsetsToCommit;
     	}
&lt;p&gt;    +&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	KafkaOffsetCommitter createOffsetCommitter() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    rename to `getOffsetCommitter()`?&lt;/p&gt;</comment>
                            <comment id="16316106" author="githubbot" created="Mon, 8 Jan 2018 10:57:25 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200#discussion_r160105955&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200#discussion_r160105955&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/main/java/org/apache/flink/streaming/connectors/kafka/internals/AbstractFetcher.java &amp;#8212;&lt;br/&gt;
    @@ -51,7 +50,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the Flink data streams.&lt;/li&gt;
	&lt;li&gt;@param &amp;lt;KPH&amp;gt; The type of topic/partition identifier used by Kafka in the specific version.&lt;br/&gt;
      */&lt;br/&gt;
    -public abstract class AbstractFetcher&amp;lt;T, KPH&amp;gt; {&lt;br/&gt;
    +public abstract class AbstractFetcher&amp;lt;T, KPH&amp;gt; implements KafkaOffsetCommitter {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Maybe use composition instead of inheritance here? `AbstractFetcher` as &quot;being a&quot; `KafkaOffsetCommitter` do not make sense to me when I say it out laud, while `AbstractFetcher` &quot;having a&quot;  `KafkaOffsetCommitter` sounds better.&lt;/p&gt;</comment>
                            <comment id="16316107" author="githubbot" created="Mon, 8 Jan 2018 10:57:26 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200#discussion_r160112834&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200#discussion_r160112834&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaConsumerBase.java &amp;#8212;&lt;br/&gt;
    @@ -559,6 +565,7 @@ public void onException(Throwable cause) {&lt;br/&gt;
     		//            the fetchers &apos;snapshotCurrentState()&apos; method return at least&lt;br/&gt;
     		//            the restored offsets&lt;br/&gt;
     		this.kafkaFetcher = fetcher;&lt;br/&gt;
    +		this.kafkaOffsetCommitter = createOffsetCommitter();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Changing order of those lines:&lt;br/&gt;
    ```&lt;br/&gt;
    		this.kafkaFetcher = fetcher;&lt;br/&gt;
    		this.kafkaOffsetCommitter = createOffsetCommitter();&lt;br/&gt;
    ```&lt;br/&gt;
    will brake the code. This is super fragile and is kind of hard to follow. &lt;/p&gt;</comment>
                            <comment id="16316108" author="githubbot" created="Mon, 8 Jan 2018 10:57:26 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200#discussion_r160107329&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200#discussion_r160107329&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/test/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaConsumerBaseTest.java &amp;#8212;&lt;br/&gt;
    @@ -89,30 +90,44 @@&lt;br/&gt;
     	@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     	public void testEitherWatermarkExtractor() {&lt;br/&gt;
     		try &lt;/p&gt;
{
    -			new DummyFlinkKafkaConsumer&amp;lt;String&amp;gt;(mock(AbstractFetcher.class), mock(AbstractPartitionDiscoverer.class), false)
    +			new DummyFlinkKafkaConsumer&amp;lt;String&amp;gt;(
    +					mock(AbstractFetcher.class),
    +					mock(AbstractPartitionDiscoverer.class),
    +					mock(KafkaOffsetCommitter.class),
    +					false)
     				.assignTimestampsAndWatermarks((AssignerWithPeriodicWatermarks&amp;lt;String&amp;gt;) null);
     			fail();
     		}
&lt;p&gt; catch (NullPointerException ignored) {}&lt;/p&gt;

&lt;p&gt;     		try &lt;/p&gt;
{
    -			new DummyFlinkKafkaConsumer&amp;lt;String&amp;gt;(mock(AbstractFetcher.class), mock(AbstractPartitionDiscoverer.class), false)
    +			new DummyFlinkKafkaConsumer&amp;lt;String&amp;gt;(
    +					mock(AbstractFetcher.class),
    +					mock(AbstractPartitionDiscoverer.class),
    +					mock(KafkaOffsetCommitter.class),
    +					false)
     				.assignTimestampsAndWatermarks((AssignerWithPunctuatedWatermarks&amp;lt;String&amp;gt;) null);
     			fail();
     		}
&lt;p&gt; catch (NullPointerException ignored) {}&lt;/p&gt;

&lt;p&gt;     		final AssignerWithPeriodicWatermarks&amp;lt;String&amp;gt; periodicAssigner = mock(AssignerWithPeriodicWatermarks.class);&lt;br/&gt;
     		final AssignerWithPunctuatedWatermarks&amp;lt;String&amp;gt; punctuatedAssigner = mock(AssignerWithPunctuatedWatermarks.class);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;DummyFlinkKafkaConsumer&amp;lt;String&amp;gt; c1 =&lt;/li&gt;
	&lt;li&gt;new DummyFlinkKafkaConsumer&amp;lt;&amp;gt;(mock(AbstractFetcher.class), mock(AbstractPartitionDiscoverer.class), false);&lt;br/&gt;
    +		DummyFlinkKafkaConsumer&amp;lt;String&amp;gt; c1 = new DummyFlinkKafkaConsumer&amp;lt;&amp;gt;(&lt;br/&gt;
    +				mock(AbstractFetcher.class),&lt;br/&gt;
    +				mock(AbstractPartitionDiscoverer.class),&lt;br/&gt;
    +				mock(KafkaOffsetCommitter.class),
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Please replace everywhere `mock(KafkaOffsetCommitter.class)` with `new DummyKafkaOffsetCommitter()` or `new NoOpKafkaOffsetCommitter()`.&lt;/p&gt;
</comment>
                            <comment id="16316109" author="githubbot" created="Mon, 8 Jan 2018 10:57:26 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200#discussion_r160107827&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200#discussion_r160107827&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaConsumerBase.java &amp;#8212;&lt;br/&gt;
    @@ -770,8 +777,8 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception &lt;/p&gt;
{
     			return;
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final AbstractFetcher&amp;lt;?, ?&amp;gt; fetcher = this.kafkaFetcher;&lt;/li&gt;
	&lt;li&gt;if (fetcher == null) {&lt;br/&gt;
    +		final KafkaOffsetCommitter offsetCommitter = this.kafkaOffsetCommitter;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    why do we need this `final` local variable? `kafkaOffsetCommitter` seems to be &quot;write-once&quot; variable.&lt;/p&gt;</comment>
                            <comment id="16316300" author="githubbot" created="Mon, 8 Jan 2018 13:31:54 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Btw, doesn&apos;t the `org.apache.flink.streaming.connectors.kafka.internal.KafkaConsumerThread#setOffsetsToCommit` have a race condition on those lines:&lt;/p&gt;


&lt;p&gt;    ```&lt;br/&gt;
    		// record the work to be committed by the main consumer thread and make sure the consumer notices that&lt;br/&gt;
    		if (nextOffsetsToCommit.getAndSet(offsetsToCommit) != null) &lt;/p&gt;
{
    			log.warn(&quot;Committing offsets to Kafka takes longer than the checkpoint interval. &quot; +
    					&quot;Skipping commit of previous offsets because newer complete checkpoint offsets are available. &quot; +
    					&quot;This does not compromise Flink&apos;s checkpoint integrity.&quot;);
    		}
&lt;p&gt;    		this.offsetCommitCallback = commitCallback;&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    (`getAndSet` followed by `volatile`) with `org.apache.flink.streaming.connectors.kafka.internal.KafkaConsumerThread#run`? However currently it doesn&apos;t seem to be so important, since:&lt;/p&gt;

&lt;p&gt;    1. it&apos;s used only for metrics&lt;br/&gt;
    2. and only first `successfulCommits.inc()` can be omitted because of that., because (at least now) `offsetCommitCallback` is a `write-once` variable, and any subsequent overwrites, are overwriting it to the same value.&lt;/p&gt;</comment>
                            <comment id="16319761" author="githubbot" created="Wed, 10 Jan 2018 06:33:30 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200#discussion_r160598772&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200#discussion_r160598772&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/main/java/org/apache/flink/streaming/connectors/kafka/internals/AbstractFetcher.java &amp;#8212;&lt;br/&gt;
    @@ -51,7 +50,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the Flink data streams.&lt;/li&gt;
	&lt;li&gt;@param &amp;lt;KPH&amp;gt; The type of topic/partition identifier used by Kafka in the specific version.&lt;br/&gt;
      */&lt;br/&gt;
    -public abstract class AbstractFetcher&amp;lt;T, KPH&amp;gt; {&lt;br/&gt;
    +public abstract class AbstractFetcher&amp;lt;T, KPH&amp;gt; implements KafkaOffsetCommitter {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I agree that composition suits better here, or maybe even neither of both. However, the reality is that currently the offset committing logic is implemented tightly as part of the `AbstractFetcher`, sharing the same Kafka client for both fetching records and committing offsets. Decoupling that would require further refactoring, which I think is a bit out of scope for the current issue at hand.&lt;/p&gt;

&lt;p&gt;    I have been thinking that we should simply have two separate service implementations for offset committing and record fetching. If that happens, then neither composition or inheritance is required; offset committing and record fetching simply lives as two separate services.&lt;/p&gt;

&lt;p&gt;    What do you think?&lt;/p&gt;</comment>
                            <comment id="16319762" author="githubbot" created="Wed, 10 Jan 2018 06:34:34 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200#discussion_r160598888&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200#discussion_r160598888&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaConsumerBase.java &amp;#8212;&lt;br/&gt;
    @@ -559,6 +565,7 @@ public void onException(Throwable cause) {&lt;br/&gt;
     		//            the fetchers &apos;snapshotCurrentState()&apos; method return at least&lt;br/&gt;
     		//            the restored offsets&lt;br/&gt;
     		this.kafkaFetcher = fetcher;&lt;br/&gt;
    +		this.kafkaOffsetCommitter = createOffsetCommitter();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This is a very valid argument. Will address this with a factory perhaps, as you suggested.&lt;/p&gt;</comment>
                            <comment id="16319763" author="githubbot" created="Wed, 10 Jan 2018 06:35:03 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200#discussion_r160598939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200#discussion_r160598939&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/test/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaConsumerBaseTest.java &amp;#8212;&lt;br/&gt;
    @@ -89,30 +90,44 @@&lt;br/&gt;
     	@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     	public void testEitherWatermarkExtractor() {&lt;br/&gt;
     		try &lt;/p&gt;
{
    -			new DummyFlinkKafkaConsumer&amp;lt;String&amp;gt;(mock(AbstractFetcher.class), mock(AbstractPartitionDiscoverer.class), false)
    +			new DummyFlinkKafkaConsumer&amp;lt;String&amp;gt;(
    +					mock(AbstractFetcher.class),
    +					mock(AbstractPartitionDiscoverer.class),
    +					mock(KafkaOffsetCommitter.class),
    +					false)
     				.assignTimestampsAndWatermarks((AssignerWithPeriodicWatermarks&amp;lt;String&amp;gt;) null);
     			fail();
     		}
&lt;p&gt; catch (NullPointerException ignored) {}&lt;/p&gt;

&lt;p&gt;     		try &lt;/p&gt;
{
    -			new DummyFlinkKafkaConsumer&amp;lt;String&amp;gt;(mock(AbstractFetcher.class), mock(AbstractPartitionDiscoverer.class), false)
    +			new DummyFlinkKafkaConsumer&amp;lt;String&amp;gt;(
    +					mock(AbstractFetcher.class),
    +					mock(AbstractPartitionDiscoverer.class),
    +					mock(KafkaOffsetCommitter.class),
    +					false)
     				.assignTimestampsAndWatermarks((AssignerWithPunctuatedWatermarks&amp;lt;String&amp;gt;) null);
     			fail();
     		}
&lt;p&gt; catch (NullPointerException ignored) {}&lt;/p&gt;

&lt;p&gt;     		final AssignerWithPeriodicWatermarks&amp;lt;String&amp;gt; periodicAssigner = mock(AssignerWithPeriodicWatermarks.class);&lt;br/&gt;
     		final AssignerWithPunctuatedWatermarks&amp;lt;String&amp;gt; punctuatedAssigner = mock(AssignerWithPunctuatedWatermarks.class);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;DummyFlinkKafkaConsumer&amp;lt;String&amp;gt; c1 =&lt;/li&gt;
	&lt;li&gt;new DummyFlinkKafkaConsumer&amp;lt;&amp;gt;(mock(AbstractFetcher.class), mock(AbstractPartitionDiscoverer.class), false);&lt;br/&gt;
    +		DummyFlinkKafkaConsumer&amp;lt;String&amp;gt; c1 = new DummyFlinkKafkaConsumer&amp;lt;&amp;gt;(&lt;br/&gt;
    +				mock(AbstractFetcher.class),&lt;br/&gt;
    +				mock(AbstractPartitionDiscoverer.class),&lt;br/&gt;
    +				mock(KafkaOffsetCommitter.class),
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Will do.&lt;/p&gt;</comment>
                            <comment id="16319766" author="githubbot" created="Wed, 10 Jan 2018 06:39:19 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200#discussion_r160599433&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200#discussion_r160599433&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/main/java/org/apache/flink/streaming/connectors/kafka/internals/AbstractFetcher.java &amp;#8212;&lt;br/&gt;
    @@ -51,7 +50,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the Flink data streams.&lt;/li&gt;
	&lt;li&gt;@param &amp;lt;KPH&amp;gt; The type of topic/partition identifier used by Kafka in the specific version.&lt;br/&gt;
      */&lt;br/&gt;
    -public abstract class AbstractFetcher&amp;lt;T, KPH&amp;gt; {&lt;br/&gt;
    +public abstract class AbstractFetcher&amp;lt;T, KPH&amp;gt; implements KafkaOffsetCommitter {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The result could also very well be that we should use this opportunity to refactor the vague dependencies between fetcher / consumer thread / consumer base, and include in this PR. I would not be against that.&lt;/p&gt;</comment>
                            <comment id="16319780" author="githubbot" created="Wed, 10 Jan 2018 06:48:27 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @pnowojski thanks a lot for your insightful review!&lt;/p&gt;

&lt;p&gt;    regarding the choice of composition or inheritance: actually, in the end I think we should be leaning towards neither of both, and let offset committing and record fetching live as separate components. I&apos;ve left more detailed comments inline.&lt;/p&gt;</comment>
                            <comment id="16319816" author="githubbot" created="Wed, 10 Jan 2018 07:27:43 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Regarding the race condition you mentioned:&lt;br/&gt;
    hmm, I can&apos;t seem to exactly nail down the &quot;and only first `successfulCommits.inc()` can be omitted because of that&quot; case you mentioned, could you elaborate on that a bit more?&lt;/p&gt;

&lt;p&gt;    But yes, it seems like there certainly is a race condition here, and can even cause an NPE on:&lt;br/&gt;
    &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-connectors/flink-connector-kafka-0.9/src/main/java/org/apache/flink/streaming/connectors/kafka/internal/KafkaConsumerThread.java#L496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-connectors/flink-connector-kafka-0.9/src/main/java/org/apache/flink/streaming/connectors/kafka/internal/KafkaConsumerThread.java#L496&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Seems like the `nextOffsetsToCommit` and its callback instance should be bundled as a single `AtomicReference` here ...&lt;/p&gt;

&lt;p&gt;    Would you like to open a PR for that? I wanted to ask because you discovered it in the first place; if not I&apos;ll open a fix for it.&lt;/p&gt;</comment>
                            <comment id="16320327" author="githubbot" created="Wed, 10 Jan 2018 14:33:09 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200#discussion_r160692827&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200#discussion_r160692827&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/main/java/org/apache/flink/streaming/connectors/kafka/internals/AbstractFetcher.java &amp;#8212;&lt;br/&gt;
    @@ -51,7 +50,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the Flink data streams.&lt;/li&gt;
	&lt;li&gt;@param &amp;lt;KPH&amp;gt; The type of topic/partition identifier used by Kafka in the specific version.&lt;br/&gt;
      */&lt;br/&gt;
    -public abstract class AbstractFetcher&amp;lt;T, KPH&amp;gt; {&lt;br/&gt;
    +public abstract class AbstractFetcher&amp;lt;T, KPH&amp;gt; implements KafkaOffsetCommitter {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Probably you are right, however I haven&apos;t thought this through, but if you had and you feel that&apos;s a good opportunity to make some larger refactor I&apos;m fine with that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;    Anyway, as we discussed offline, such refactor could be made in separate PR and here you could just implement `AbstractFetcher#doCommitInternalOffsetsToKafka` for the testing purposes. &lt;/p&gt;

&lt;p&gt;    I don&apos;t mind if you choose one over the other approach &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16320339" author="githubbot" created="Wed, 10 Jan 2018 14:37:08 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Regarding the race condition. I think we meant the same thing or maybe I misunderstood part of the code, but yes, this NPE seems like a possible outcome of this race condition.&lt;/p&gt;

&lt;p&gt;    If you have spare cycles to fix this race feel free to do so, I would like to avoid working on it in this and the following week because of some code handing over before some lengthy vacation in my team.&lt;/p&gt;</comment>
                            <comment id="16320455" author="githubbot" created="Wed, 10 Jan 2018 15:39:27 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    As discussed offline:&lt;br/&gt;
    Will re-open a PR for this that avoids introducing a new interface. I agree that it would make more sense to introduce new interface when we actually decide to go for a major refactor &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16323429" author="githubbot" created="Fri, 12 Jan 2018 02:14:05 +0000"  >&lt;p&gt;GitHub user tzulitai opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5284&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5284&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8306&quot; title=&quot;FlinkKafkaConsumerBaseTest has invalid mocks on final methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8306&quot;&gt;&lt;del&gt;FLINK-8306&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka, tests&amp;#93;&lt;/span&gt; Fix invalid mock verifications on final method&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This is a reworked version of #5200.&lt;br/&gt;
    Instead of introducing a new interface while we are still unsure of how the refactoring of the Kafka consumer should head towards, this version is a simple fix to have proper mocks in the `FlinkKafkaConsumerBase`.&lt;/p&gt;

&lt;p&gt;    Only the last two commits are relevant (PR is based on #5188).&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ca1aa00 Remove invalid mock verifications, and introduce a proper `MockFetcher` mock.&lt;/li&gt;
	&lt;li&gt;d08727c is a hotfix that corrects a stale comment on a no-longer existing behaviour&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change is a code cleanup, and is already covered by existing tests.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tzulitai/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tzulitai/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8306&quot; title=&quot;FlinkKafkaConsumerBaseTest has invalid mocks on final methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8306&quot;&gt;&lt;del&gt;FLINK-8306&lt;/del&gt;&lt;/a&gt;-reworked&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5284.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5284.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5284&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 735972332ff25623898b25f210b7277aafbc7351&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2017-12-20T00:10:44Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8296&quot; title=&quot;Rework FlinkKafkaConsumerBestTest to not use Java reflection for dependency injection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8296&quot;&gt;&lt;del&gt;FLINK-8296&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Rework FlinkKafkaConsumerBaseTest to not rely on Java reflection&lt;/p&gt;

&lt;p&gt;    Reflection was mainly used to inject mocks into private fields of the&lt;br/&gt;
    FlinkKafkaConsumerBase, without the need to fully execute all operator&lt;br/&gt;
    life cycle methods. This, however, caused the unit tests to be too&lt;br/&gt;
    implementation-specific.&lt;/p&gt;

&lt;p&gt;    This commit reworks the FlinkKafkaConsumerBaseTest to remove test&lt;br/&gt;
    consumer instantiation methods that rely on reflection for dependency&lt;br/&gt;
    injection. All tests now instantiate dummy test consumers normally, and&lt;br/&gt;
    let all tests properly execute all operator life cycle methods&lt;br/&gt;
    regardless of the tested logic.&lt;/p&gt;

&lt;p&gt;commit ca1aa0074c0ae4ff8e2da4f8d87b8378c2413ef5&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-01-12T00:45:32Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8306&quot; title=&quot;FlinkKafkaConsumerBaseTest has invalid mocks on final methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8306&quot;&gt;&lt;del&gt;FLINK-8306&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka, tests&amp;#93;&lt;/span&gt; Fix mock verifications on final method&lt;/p&gt;

&lt;p&gt;    Previously, offset commit behavioural tests relied on verifying on&lt;br/&gt;
    AbstractFetcher::commitInternalOffsetsToKafka(). That method is actually&lt;br/&gt;
    final, and could not be mocked.&lt;/p&gt;

&lt;p&gt;    This commit fixes that by implementing a proper mock AbstractFetcher,&lt;br/&gt;
    which keeps track of the offset commits that go through.&lt;/p&gt;

&lt;p&gt;commit d08727c4f8816e408dabc12a673ad24593b27023&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2017-12-20T19:54:40Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Remove stale comment on publishing procedures of AbstractFetcher&lt;/p&gt;

&lt;p&gt;    The previous comment mentioned &quot;only now will the fetcher return at&lt;br/&gt;
    least the restored offsets when calling snapshotCurrentState()&quot;. This is&lt;br/&gt;
    a remnant of the previous fetcher initialization behaviour, where in the&lt;br/&gt;
    past the fetcher wasn&apos;t directly seeded with restored offsets on&lt;br/&gt;
    instantiation.&lt;/p&gt;

&lt;p&gt;    Since this is no longer true, this commit fixes the stale comment to&lt;br/&gt;
    avoid confusion.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16323430" author="githubbot" created="Fri, 12 Jan 2018 02:14:30 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Subsumed be re-opened PR: #5284 &lt;/p&gt;</comment>
                            <comment id="16323431" author="githubbot" created="Fri, 12 Jan 2018 02:14:45 +0000"  >&lt;p&gt;Github user tzulitai closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5200&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16323676" author="githubbot" created="Fri, 12 Jan 2018 08:05:05 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5284#discussion_r161159244&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5284#discussion_r161159244&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/test/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaConsumerBaseTest.java &amp;#8212;&lt;br/&gt;
    @@ -265,10 +274,8 @@ public void testSnapshotStateWithCommitOnCheckpointsEnabled() throws Exception {&lt;/p&gt;

&lt;p&gt;     		// --------------------------------------------------------------------&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final OneShotLatch runLatch = new OneShotLatch();&lt;/li&gt;
	&lt;li&gt;final OneShotLatch stopLatch = new OneShotLatch();&lt;/li&gt;
	&lt;li&gt;final AbstractFetcher&amp;lt;String, ?&amp;gt; fetcher = getRunnableMockFetcher(runLatch, stopLatch);&lt;/li&gt;
	&lt;li&gt;when(fetcher.snapshotCurrentState()).thenReturn(state1, state2, state3);&lt;br/&gt;
    +		final MockFetcher&amp;lt;String&amp;gt; fetcher = spy(new MockFetcher&amp;lt;&amp;gt;());&lt;br/&gt;
    +		doReturn(state1).doReturn(state2).doReturn(state3).when(fetcher).snapshotCurrentState();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Maybe we could go one small step further?&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    private static class MockFetcher&amp;lt;T&amp;gt; ... {&lt;br/&gt;
      private final ArrayDeque&amp;lt;HashMap&amp;lt;KafkaTopicPartition, Long&amp;gt;&amp;gt; stateSnapshotsToReturn = new ArrayDeque&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;      public MockFetcher(HashMap&amp;lt;KafkaTopicPartition, Long&amp;gt;.. stateSnapshotsToReturn) &lt;/p&gt;
{
        this.stateSnapshotsToReturn.addAll(Arrays.asList(stateSnapshotsToReturn));
      }

&lt;p&gt;      @Override&lt;br/&gt;
      public HashMap&amp;lt;KafkaTopicPartition, Long&amp;gt; snapshotCurrentState() &lt;/p&gt;
{
        checkState(!stateSnapshotsToReturn.isEmpty());
        return stateSnapshotsToReturn.poll();
      }
&lt;p&gt;    }&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16323681" author="githubbot" created="Fri, 12 Jan 2018 08:10:18 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5284#discussion_r161160136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5284#discussion_r161160136&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/test/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaConsumerBaseTest.java &amp;#8212;&lt;br/&gt;
    @@ -265,10 +274,8 @@ public void testSnapshotStateWithCommitOnCheckpointsEnabled() throws Exception {&lt;/p&gt;

&lt;p&gt;     		// --------------------------------------------------------------------&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final OneShotLatch runLatch = new OneShotLatch();&lt;/li&gt;
	&lt;li&gt;final OneShotLatch stopLatch = new OneShotLatch();&lt;/li&gt;
	&lt;li&gt;final AbstractFetcher&amp;lt;String, ?&amp;gt; fetcher = getRunnableMockFetcher(runLatch, stopLatch);&lt;/li&gt;
	&lt;li&gt;when(fetcher.snapshotCurrentState()).thenReturn(state1, state2, state3);&lt;br/&gt;
    +		final MockFetcher&amp;lt;String&amp;gt; fetcher = spy(new MockFetcher&amp;lt;&amp;gt;());&lt;br/&gt;
    +		doReturn(state1).doReturn(state2).doReturn(state3).when(fetcher).snapshotCurrentState();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes, if we really want to get rid of Mockito for good &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;    Though `checkState(!stateSnapshotsToReturn.isEmpty())` is a bit problematic, because the unit tests rely on the last return stub to re-occur for all remaining calls.&lt;/p&gt;

&lt;p&gt;    I&apos;ll change this while merging.&lt;/p&gt;</comment>
                            <comment id="16323753" author="githubbot" created="Fri, 12 Jan 2018 09:40:33 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5284#discussion_r161176765&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5284#discussion_r161176765&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-base/src/test/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaConsumerBaseTest.java &amp;#8212;&lt;br/&gt;
    @@ -265,10 +274,8 @@ public void testSnapshotStateWithCommitOnCheckpointsEnabled() throws Exception {&lt;/p&gt;

&lt;p&gt;     		// --------------------------------------------------------------------&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final OneShotLatch runLatch = new OneShotLatch();&lt;/li&gt;
	&lt;li&gt;final OneShotLatch stopLatch = new OneShotLatch();&lt;/li&gt;
	&lt;li&gt;final AbstractFetcher&amp;lt;String, ?&amp;gt; fetcher = getRunnableMockFetcher(runLatch, stopLatch);&lt;/li&gt;
	&lt;li&gt;when(fetcher.snapshotCurrentState()).thenReturn(state1, state2, state3);&lt;br/&gt;
    +		final MockFetcher&amp;lt;String&amp;gt; fetcher = spy(new MockFetcher&amp;lt;&amp;gt;());&lt;br/&gt;
    +		doReturn(state1).doReturn(state2).doReturn(state3).when(fetcher).snapshotCurrentState();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Ops, haven&apos;t noticed that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16323756" author="githubbot" created="Fri, 12 Jan 2018 09:41:33 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5284&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5284&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yes, I&apos;ve fixed that checkstyle on my local pre-merge branch &#128076; &lt;/p&gt;</comment>
                            <comment id="16323956" author="githubbot" created="Fri, 12 Jan 2018 13:32:51 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5284&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5284&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16325033" author="tzulitai" created="Sat, 13 Jan 2018 08:12:51 +0000"  >&lt;p&gt;Merged.&lt;/p&gt;

&lt;p&gt;1.4: c4bfc7de36201d7a144ae995931ffd3a079ed649&lt;br/&gt;
1.5: 69fff746ac99ec3ad428edf4500e38de17f2b797&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 44 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3o6vr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>