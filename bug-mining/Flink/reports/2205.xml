<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8421] HeapInternalTimerService should reconfigure compatible key / namespace serializers on restore</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8421</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;HeapInternalTimerService&lt;/tt&gt; still uses simple &lt;tt&gt;equals&lt;/tt&gt; checks on restored / newly provided serializers for compatibility checks. This should be replaced with the &lt;tt&gt;TypeSerializer::ensureCompatibility&lt;/tt&gt; checks instead, so that new serializers can be reconfigured.&lt;/p&gt;

&lt;p&gt;This would entail that the &lt;tt&gt;TypeSerializerConfiguration&lt;/tt&gt; of the key and namespace serializer in the &lt;tt&gt;HeapInternalTimerService&lt;/tt&gt; also needs to be written to the raw state.&lt;/p&gt;

&lt;p&gt;For Flink 1.4.0 release and current master, this is a critical bug since the &lt;tt&gt;KryoSerializer&lt;/tt&gt; has different default base registrations than before due to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7420&quot; title=&quot;Move all Avro code to flink-avro&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7420&quot;&gt;&lt;del&gt;FLINK-7420&lt;/del&gt;&lt;/a&gt;. i.e if the key of a window is serialized using the &lt;tt&gt;KryoSerializer&lt;/tt&gt; in 1.3.x, the restore would never succeed in 1.4.0.&lt;/p&gt;

&lt;p&gt;For 1.3.x, this fix would be an improvement, such that the &lt;tt&gt;HeapInternalTimerService&lt;/tt&gt; restore will make use of serializer reconfiguration.&lt;/p&gt;

&lt;p&gt;Other remarks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We need to double check all operators that checkpoint / restore from *&lt;b&gt;raw&lt;/b&gt;* state. Apparently, the serializer compatibility checks were only implemented for managed state.&lt;/li&gt;
	&lt;li&gt;Migration ITCases apparently do not have enough coverage. A migration test job that uses a key type which required the &lt;tt&gt;KryoSerializer&lt;/tt&gt;, and uses windows, would have caught this issue.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13130571">FLINK-8421</key>
            <summary>HeapInternalTimerService should reconfigure compatible key / namespace serializers on restore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tzulitai">Tzu-Li (Gordon) Tai</assignee>
                                    <reporter username="tzulitai">Tzu-Li (Gordon) Tai</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Jan 2018 16:29:37 +0000</created>
                <updated>Mon, 12 Mar 2018 15:27:42 +0000</updated>
                            <resolved>Mon, 12 Mar 2018 15:27:42 +0000</resolved>
                                    <version>1.4.0</version>
                    <version>1.5.0</version>
                                    <fixVersion>1.3.4</fixVersion>
                    <fixVersion>1.4.1</fixVersion>
                    <fixVersion>1.5.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16339236" author="githubbot" created="Thu, 25 Jan 2018 13:53:14 +0000"  >&lt;p&gt;GitHub user tzulitai opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5362&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8421&quot; title=&quot;HeapInternalTimerService should reconfigure compatible key / namespace serializers on restore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8421&quot;&gt;&lt;del&gt;FLINK-8421&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream&amp;#93;&lt;/span&gt; Make timer serializers reconfigurable on restore&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Previously, key and namespace serializers of the `HeapInternalTimerService` were not reconfigured on restore.&lt;/p&gt;

&lt;p&gt;    In Flink 1.4.0, we removed Avro dependency, and on restore if the Avro dependency is not present, a `DummyAvroKryoSerializerClass` was registered to Kryo as a placeholder, which altered the base Kryo registrations in the `KryoSerializer`. This change required a serializer reconfiguration in order for restores to work. Effectively, this allowed the issue in the `HeapInternalTimerService` to surface.&lt;/p&gt;

&lt;p&gt;    This PR fixes this by writing also the `TypeSerializerConfigSnapshot`s of the key and namespace serializer of the `HeapInternalTimerService` into savepoints, and use them to reconfigure new serializers on restore.&lt;br/&gt;
    Since this would change the binary format of the written timer services, this PR also uses this opportunity to properly make the format versioned.&lt;/p&gt;

&lt;p&gt;    More details of the change is explained below.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1bc3cd0: A preliminary migration test that took a savepoint of a `WindowOperator` with keys that required serialization using the `KryoSerializer`. Savepoint were taken for Flink versions 1.2 and 1.3. Restoring from this savepoint in Flink 1.4 fails, and requires the following commits to pass.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;b9a1695: Always use the `FailureTolerantObjectInputStream` to read objects in the `InstantiationUtil.deserializeObject(...)` methods. That special stream avoids restore failures with `ClassNotFoundException` if Avro is not present, but there were leaks where during the restore process, that special input stream was not used.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ff2e6b7 and 8bd955d: Introduced `ByteArrayPrependedInputStream` and `PostVersionedIOReadableWritable`. These are utility classes that were required to migrate the serialization format of the timer services from non-versioned to versioned.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;bcdc1f1: The main change, which adds key / namespace serializer config snapshots and use them for serializer reconfiguration on restore. This commit also makes the format versioned.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The migration test added in 1bc3cd0 will not pass without all fixes.&lt;/li&gt;
	&lt;li&gt;Unit tests are added for the new `ByteArrayPrependedInputStream` and `PostVersionedIOReadableWritable` classes.&lt;/li&gt;
	&lt;li&gt;The `testSnapshotAndRestore` and `testSnapshotAndRebalancedRestore` tests in `HeapInternalTimerServiceTest` are adapted to test both versioned and previous non-versioned formats.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;YES&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tzulitai/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tzulitai/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8421&quot; title=&quot;HeapInternalTimerService should reconfigure compatible key / namespace serializers on restore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8421&quot;&gt;&lt;del&gt;FLINK-8421&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5362.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5362.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5362&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 1bc3cd0214d2d17f19d76a9aa094429730b5ba13&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-01-24T16:08:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8421&quot; title=&quot;HeapInternalTimerService should reconfigure compatible key / namespace serializers on restore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8421&quot;&gt;&lt;del&gt;FLINK-8421&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream, tests&amp;#93;&lt;/span&gt; Add WindowOperator migration test for Kryo-serialized window keys&lt;/p&gt;

&lt;p&gt;commit b9a169535a91d5678ae916d8e54b7e60724a7486&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-01-24T16:15:08Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8421&quot; title=&quot;HeapInternalTimerService should reconfigure compatible key / namespace serializers on restore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8421&quot;&gt;&lt;del&gt;FLINK-8421&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Let InstantiationUtil.deserializeObject() always use FailureTolerantObjectInputStream&lt;/p&gt;

&lt;p&gt;commit ff2e6b75f39f0d474ecca451ac1a47c0183e9a6f&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-01-24T17:07:14Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8421&quot; title=&quot;HeapInternalTimerService should reconfigure compatible key / namespace serializers on restore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8421&quot;&gt;&lt;del&gt;FLINK-8421&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Introduce ByteArrayPrependedInputStream&lt;/p&gt;

&lt;p&gt;commit 8bd955d701f9f9278a5e52befea4308f42a60b45&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-01-24T17:08:52Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8421&quot; title=&quot;HeapInternalTimerService should reconfigure compatible key / namespace serializers on restore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8421&quot;&gt;&lt;del&gt;FLINK-8421&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Introduce PostVersionedIOReadableWritable&lt;/p&gt;

&lt;p&gt;commit bcdc1f14d29ef272d07c8e52c46a355ac565d853&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-01-24T17:09:44Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8421&quot; title=&quot;HeapInternalTimerService should reconfigure compatible key / namespace serializers on restore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8421&quot;&gt;&lt;del&gt;FLINK-8421&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream&amp;#93;&lt;/span&gt; Make timer serializers reconfigurable on restore&lt;/p&gt;

&lt;p&gt;    Previously, the key and namespace serializers for the&lt;br/&gt;
    HeapInternalTimerService were not reconfigured on restore to be compatible&lt;br/&gt;
    with previously written serializers.&lt;/p&gt;

&lt;p&gt;    This caused an immediate error to restore savepoints in Flink 1.4.0,&lt;br/&gt;
    since in Flink 1.4.0 we changed the base registrations in the Kryo&lt;br/&gt;
    serializer. That change requires serializer reconfiguration.&lt;/p&gt;

&lt;p&gt;    This commit fixes this by writing also the serializer configuration&lt;br/&gt;
    snapshots of the key and namespace serializer into savepoints, and use&lt;br/&gt;
    them to reconfigure the new serializers on rrestore. This improvement also&lt;br/&gt;
    comes along with making the written data for timer service snapshots&lt;br/&gt;
    versioned. Backwards compatibility with previous non-versioned formats&lt;br/&gt;
    is not broken.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16348936" author="githubbot" created="Thu, 1 Feb 2018 17:16:13 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5362&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @aljoscha As discussed offline, I&apos;ve:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;replaced `ByteArrayPrependedInputStream` with Java&apos;s `PushbackInputStream`&lt;/li&gt;
	&lt;li&gt;use negative values in `VERSIONED_IDENTIFIER` to be extra safe&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16349905" author="githubbot" created="Fri, 2 Feb 2018 07:28:10 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5362#discussion_r165573730&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5362#discussion_r165573730&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/core/io/PostVersionedIOReadableWritable.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,78 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.core.io;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.annotation.Internal;&lt;br/&gt;
    +import org.apache.flink.core.memory.DataInputView;&lt;br/&gt;
    +import org.apache.flink.core.memory.DataInputViewStreamWrapper;&lt;br/&gt;
    +import org.apache.flink.core.memory.DataOutputView;&lt;br/&gt;
    +import org.apache.flink.core.memory.InputStreamViewWrapper;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.io.PushbackInputStream;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * A &lt;/p&gt;
{@link VersionedIOReadableWritable} which allows to differentiate whether the previous&lt;br/&gt;
    + * data was versioned with a {@link VersionedIOReadableWritable}
&lt;p&gt;. This can be used if previously&lt;br/&gt;
    + * written data was not versioned, and is to be migrated to a versioned format.&lt;br/&gt;
    + */&lt;br/&gt;
    +@Internal&lt;br/&gt;
    +public abstract class PostVersionedIOReadableWritable extends VersionedIOReadableWritable {&lt;br/&gt;
    +&lt;br/&gt;
    +	/** NOTE: CANNOT CHANGE! */&lt;br/&gt;
    +	private static final byte[] VERSIONED_IDENTIFIER = new byte[] {-15, -51, -123, -97};&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Read from the provided &lt;/p&gt;
{@link DataInputView in}
&lt;p&gt;. A flag &lt;/p&gt;
{@code wasVersioned}
&lt;p&gt; can be&lt;br/&gt;
    +	 * used to determine whether or not the data to read was previously written&lt;br/&gt;
    +	 * by a &lt;/p&gt;
{@link VersionedIOReadableWritable}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	protected abstract void read(DataInputView in, boolean wasVersioned) throws IOException;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public void write(DataOutputView out) throws IOException &lt;/p&gt;
{
    +		out.write(VERSIONED_IDENTIFIER);
    +		super.write(out);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * This read attempts to first identify if the input view contains the special&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link #VERSIONED_IDENTIFIER}
&lt;p&gt; by reading and buffering the first few bytes.&lt;br/&gt;
    +	 * If identified to be versioned, the usual version resolution read path&lt;br/&gt;
    +	 * in &lt;/p&gt;
{@link VersionedIOReadableWritable#read(DataInputView)}
&lt;p&gt; is invoked.&lt;br/&gt;
    +	 * Otherwise, we &quot;reset&quot; the input view by pushing back the read buffered bytes&lt;br/&gt;
    +	 * into the stream.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public final void read(DataInputView in) throws IOException {&lt;br/&gt;
    +		PushbackInputStream stream = new PushbackInputStream(new InputStreamViewWrapper(in), VERSIONED_IDENTIFIER.length);&lt;br/&gt;
    +&lt;br/&gt;
    +		byte[] tmp = new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;VERSIONED_IDENTIFIER.length&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +		stream.read(tmp);&lt;br/&gt;
    +&lt;br/&gt;
    +		if (Arrays.equals(tmp, VERSIONED_IDENTIFIER)) &lt;/p&gt;
{
    +			super.read(in);
    +			read(in, true);
    +		}
&lt;p&gt; else &lt;/p&gt;
{
    +			stream.unread(tmp);
    +			read(new DataInputViewStreamWrapper(stream), false);
    +		}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Not-so-nice things about this current implementation is:&lt;br/&gt;
    1) it requires several layers of transforming back and forth between a `DataInputView` and `InputStream`, and &lt;br/&gt;
    2) it uses a separate `read(DataInputView, boolean)` method in order to wrap a &quot;reset&quot; `DataInputView` for the remaining reads.&lt;/p&gt;

&lt;p&gt;    I think the implementation would have been much more elegant if `DataInputView` has an `unread(byte[])` method, though I&apos;m not sure how non-trivial it is to support this across all subclasses.&lt;br/&gt;
    Maybe a food for thought for the future ..&lt;/p&gt;</comment>
                            <comment id="16350259" author="githubbot" created="Fri, 2 Feb 2018 12:50:41 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5362#discussion_r165636384&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5362#discussion_r165636384&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/InternalTimeServiceManager.java &amp;#8212;&lt;br/&gt;
    @@ -52,7 +52,7 @@&lt;/p&gt;

&lt;p&gt;     	private final ProcessingTimeService processingTimeService;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final Map&amp;lt;String, HeapInternalTimerService&amp;lt;K, N&amp;gt;&amp;gt; timerServices;&lt;br/&gt;
    +	public final Map&amp;lt;String, HeapInternalTimerService&amp;lt;K, N&amp;gt;&amp;gt; timerServices;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Is this only public for testing?&lt;/p&gt;</comment>
                            <comment id="16350342" author="githubbot" created="Fri, 2 Feb 2018 13:40:59 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5362#discussion_r165646464&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5362#discussion_r165646464&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/InternalTimeServiceManager.java &amp;#8212;&lt;br/&gt;
    @@ -52,7 +52,7 @@&lt;/p&gt;

&lt;p&gt;     	private final ProcessingTimeService processingTimeService;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final Map&amp;lt;String, HeapInternalTimerService&amp;lt;K, N&amp;gt;&amp;gt; timerServices;&lt;br/&gt;
    +	public final Map&amp;lt;String, HeapInternalTimerService&amp;lt;K, N&amp;gt;&amp;gt; timerServices;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    no, this is a mistake that should be reverted.&lt;/p&gt;</comment>
                            <comment id="16354066" author="githubbot" created="Tue, 6 Feb 2018 16:02:47 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5362&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think this is good to go now. &#128077; &#128515; &lt;/p&gt;</comment>
                            <comment id="16354073" author="githubbot" created="Tue, 6 Feb 2018 16:08:54 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5362&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the reviews!&lt;br/&gt;
    Will merge after Travis gives green.&lt;/p&gt;</comment>
                            <comment id="16354363" author="githubbot" created="Tue, 6 Feb 2018 19:04:05 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5362&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16354388" author="tzulitai" created="Tue, 6 Feb 2018 19:11:32 +0000"  >&lt;p&gt;Merged.&lt;/p&gt;

&lt;p&gt;1.5 -&#160;a79916b88ef3d97c11980c25d3887d43964c152d&lt;br/&gt;
1.4 -&#160;fb1e24e25eddaded9668041ba4f24e35384962c3&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ov0v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>