<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10715] E2e tests fail with ConcurrentModificationException in MetricRegistryImpl</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10715</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Couple of e2e tests that rely on metrics fail with exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-10-29 11:40:32,781 WARN  org.apache.flink.runtime.metrics.MetricRegistryImpl           - Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; reporting metrics
java.util.ConcurrentModificationException
	at java.util.HashMap$HashIterator.nextNode(HashMap.java:1437)
	at java.util.HashMap$EntryIterator.next(HashMap.java:1471)
	at java.util.HashMap$EntryIterator.next(HashMap.java:1469)
	at org.apache.flink.metrics.slf4j.Slf4jReporter.report(Slf4jReporter.java:101)
	at org.apache.flink.runtime.metrics.MetricRegistryImpl$ReporterTask.run(MetricRegistryImpl.java:427)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Tests that failed:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&apos;Resuming Externalized Checkpoint (file, sync, no parallelism change) end-to-end test&lt;/li&gt;
	&lt;li&gt;&apos;State TTL Heap backend end-to-end test&apos;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13194841">FLINK-10715</key>
            <summary>E2e tests fail with ConcurrentModificationException in MetricRegistryImpl</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="igal">Igal Shilman</assignee>
                                    <reporter username="dwysakowicz">Dawid Wysakowicz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 29 Oct 2018 12:35:47 +0000</created>
                <updated>Thu, 22 Nov 2018 09:21:40 +0000</updated>
                            <resolved>Sat, 3 Nov 2018 09:37:44 +0000</resolved>
                                    <version>1.7.0</version>
                                    <fixVersion>1.5.6</fixVersion>
                    <fixVersion>1.6.3</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                    <component>Test Infrastructure</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16667296" author="zentol" created="Mon, 29 Oct 2018 14:41:02 +0000"  >&lt;p&gt;This is effectively a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10035&quot; title=&quot;ConcurrentModificationException with flink-metrics-slf4j&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10035&quot;&gt;&lt;del&gt;FLINK-10035&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16671819" author="githubbot" created="Thu, 1 Nov 2018 16:18:49 +0000"  >&lt;p&gt;igalshilman opened a new pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Metric reporters might periodically fail due to transient errors downstream, therefore they should not pollute the log with the full stack trace (unless debug is enabled)&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`MetricRegistryImpl` now logs reports failure without the stack trace. (unless log level is debug)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change is a trivial rework / code cleanup without any test coverage.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / &lt;b&gt;no&lt;/b&gt;)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / &lt;b&gt;no&lt;/b&gt;)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / &lt;b&gt;no&lt;/b&gt; / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / &lt;b&gt;no&lt;/b&gt; / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / &lt;b&gt;no&lt;/b&gt; / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / &lt;b&gt;no&lt;/b&gt; / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / &lt;b&gt;no&lt;/b&gt;)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (&lt;b&gt;not applicable&lt;/b&gt; / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672748" author="githubbot" created="Fri, 2 Nov 2018 08:20:11 +0000"  >&lt;p&gt;dawidwys commented on issue #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#issuecomment-435304280&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#issuecomment-435304280&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks @igalshilman for the contribution, I am not sure if I understood this change. Was it intended that in the default case nothing changed (we log the same message on the same level), but we change it to debug level (if this level is enabled) and print then only the message? &lt;/p&gt;

&lt;p&gt;   Was that intended, I would assume that in the debug cases we could actually log more than in the standard ones. Also could you describe a bit more, e.g. as a comment in the code why do we do it like this?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672750" author="githubbot" created="Fri, 2 Nov 2018 08:21:44 +0000"  >&lt;p&gt;dawidwys edited a comment on issue #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#issuecomment-435304280&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#issuecomment-435304280&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks @igalshilman for the contribution, I am not sure if I understood this change. Was it intended that in the default case nothing changed (we log the same message on the same level), but we change it to debug level (if this level is enabled) and print then only the message? &lt;/p&gt;

&lt;p&gt;   Was that intended? I would assume that in the debug cases we could actually log more than in the standard ones. Also could you describe a bit more, e.g. as a comment in the code why do we do it like this?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672755" author="githubbot" created="Fri, 2 Nov 2018 08:26:05 +0000"  >&lt;p&gt;zentol commented on issue #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#issuecomment-435305641&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#issuecomment-435305641&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I&apos;m not really fond of this change since eventually (i.e. once we solved the concurrency issues in all reporters) this change should be reverted again as we can no longer assume this to be some &quot;intermittent&quot; failure.&lt;/p&gt;

&lt;p&gt;   @kl0u Effectively the purpose of this PR is to not log the word &quot;Exception&quot; so that the E2E tests pass. Which imo we can achieve just as well with the recently introduced switch to disable log checks.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672758" author="githubbot" created="Fri, 2 Nov 2018 08:31:08 +0000"  >&lt;p&gt;kl0u commented on issue #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#issuecomment-435306788&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#issuecomment-435306788&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @zentol I see. So essentially we do not solve the issue but we just temporarily make the test pass until the real issue is resolved? In this case, I would say we should create subtasks on the issue that explain what are the steps taken. &lt;/p&gt;

&lt;p&gt;   If this gets merged, the JIRA will be closed and we also never see the issue again because we &quot;fixed it&quot; in the test. This means that next time we see the issue, it will be a user reporting it. Which is not good.&lt;/p&gt;

&lt;p&gt;   Also this will be misleading because if someone searches the JIRA, he/she will think that the issue is resolved.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672815" author="githubbot" created="Fri, 2 Nov 2018 09:32:46 +0000"  >&lt;p&gt;igalshilman closed pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java b/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
index 6b3770907a9..402de5f2d36 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
@@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else 
{
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());
+				}
&lt;p&gt; 			}&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672846" author="githubbot" created="Fri, 2 Nov 2018 10:04:25 +0000"  >&lt;p&gt;tillrohrmann commented on issue #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#issuecomment-435330002&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#issuecomment-435330002&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Why did you close this PR @igalshilman?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672848" author="githubbot" created="Fri, 2 Nov 2018 10:04:51 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230313024&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230313024&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   `LOG.debug(&quot;Error while reporting metrics.&quot;, t);`&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672849" author="githubbot" created="Fri, 2 Nov 2018 10:04:51 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230312787&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230312787&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I would actually log this on `info` level since warnings and errors should indicate a Flink problem.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672850" author="githubbot" created="Fri, 2 Nov 2018 10:04:51 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230312915&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230312915&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   `LOG.info(&quot;Error while reporting metrics: {}.&quot;, t.getMessage());`&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672857" author="githubbot" created="Fri, 2 Nov 2018 10:07:32 +0000"  >&lt;p&gt;tillrohrmann commented on issue #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#issuecomment-435330790&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#issuecomment-435330790&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I think the PR fixes a valid problem which is the logging of a non-critical issue in a way that it seems to affect the proper functioning of Flink. This can be very confusing to our users and, thus, I think we should change it.&lt;/p&gt;

&lt;p&gt;   Even after fixing the underlying problem of the reporters I think we should not report a Reporter failure as a warning since Flink can easily recover from that.&lt;/p&gt;

&lt;p&gt;   The problem with the `ConcurrentModificationException` in the e2e tests is that they occur in tests where no exceptions should be thrown. Thus, disabling the log verification and adding some other test assertions to ensure the correctness of the test seems not right to me.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672864" author="githubbot" created="Fri, 2 Nov 2018 10:13:49 +0000"  >&lt;p&gt;kl0u commented on issue #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#issuecomment-435332294&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#issuecomment-435332294&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   The functionality can be valid but I am not sure if the attached JIRA is solved by this PR. Or at least the two do not seem to be related. This seems to be solving a concurrent modification exception with changing the debug level of the logger, which is counter-intuitive.&lt;/p&gt;

&lt;p&gt;   My suggestion is to change the JIRA because the two do not seem to be related. Either change the title and description of the existing JIRA or create a subtask that explains what this commit does.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672872" author="githubbot" created="Fri, 2 Nov 2018 10:18:53 +0000"  >&lt;p&gt;igalshilman commented on issue #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#issuecomment-435333511&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#issuecomment-435333511&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for the review @tillrohrmann , I will address your comments and create a new PR, I&apos;ve closed this accidentally.&lt;/p&gt;

&lt;p&gt;   @kl0u - as far as I can tell &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; is specifically addresses the false positive failures caught by the e2e framework due to a reporter throwing an exception (where it is some what valid). I will follow your suggestion and add further information into the JIRA. The root issue is (as far as I can tell) is tracked here: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10035&quot; title=&quot;ConcurrentModificationException with flink-metrics-slf4j&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10035&quot;&gt;&lt;del&gt;FLINK-10035&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672877" author="githubbot" created="Fri, 2 Nov 2018 10:23:23 +0000"  >&lt;p&gt;zentol commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230327489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230327489&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   We already log it as a warning and not as an error due to that reasoning.&lt;/p&gt;

&lt;p&gt;   I think we&apos;re a bit naive when it comes to reporting errors in the metric system. Our argument is &quot;it&apos;s &lt;em&gt;just&lt;/em&gt; tooling&quot;, but any Flink deployment that is important for the business-logic will be monitored, and issues in the metric system should be highlighted in some way accordingly.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672881" author="githubbot" created="Fri, 2 Nov 2018 10:25:13 +0000"  >&lt;p&gt;zentol commented on issue #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#issuecomment-435335044&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#issuecomment-435335044&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @igalshilman You can also re-open this PR.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672905" author="githubbot" created="Fri, 2 Nov 2018 10:42:06 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230332712&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230332712&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   We could also keep it as a warning. I&apos;m just wondering whether we should log the stack traces of an exception where we now that some of these exceptions are actually caused by us and are not critical. This will make people wary even though there is nothing to be concerned about.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672906" author="githubbot" created="Fri, 2 Nov 2018 10:42:17 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230332712&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230332712&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   We could also keep it as a warning. I&apos;m just wondering whether we should log the stack traces of an exception where we know that some of these exceptions are actually caused by us and are not critical. This will make people wary even though there is nothing to be concerned about.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672928" author="githubbot" created="Fri, 2 Nov 2018 10:57:13 +0000"  >&lt;p&gt;zentol commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230336292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230336292&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I&apos;d rather be on the safe side and log the stack-trace in case it is not caused by us. Whether a report failing or not being critical depends on the context and user.&lt;/p&gt;

&lt;p&gt;   For example, a reporter failing consistently over a large period of time should show up in the logs in a manner that allows the user to make make a conscious decision whether the cluster has to be restarted or not. However in the worst case you get a `null` error message, which is entirely unhelpful for making said decision.&lt;/p&gt;

&lt;p&gt;   If we want to go for temporary band-aids then iterate over all reporters and catch `ConcurrentModificationExceptions`. Then you don&apos;t have these somewhat-expected intermittent exceptions caused by us anymore.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672939" author="githubbot" created="Fri, 2 Nov 2018 11:04:06 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230337879&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230337879&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Do we know where `ConcurrentModificationExceptions` can be thrown in the reporters @zentol?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672958" author="githubbot" created="Fri, 2 Nov 2018 11:21:13 +0000"  >&lt;p&gt;zentol commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230341614&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230341614&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   sure we do, when iterating over the internal maps `report()`. Some reporters (like Prometheus) already catch them and continue on.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16672959" author="githubbot" created="Fri, 2 Nov 2018 11:21:20 +0000"  >&lt;p&gt;zentol commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230341614&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230341614&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   sure we do, when iterating over the internal maps in `report()`. Some reporters (like Prometheus) already catch them and continue on.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673033" author="githubbot" created="Fri, 2 Nov 2018 12:30:40 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230357918&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230357918&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   We could also think about only fixing the `Slf4jReporter` used in the e2e tests. But this is really only a band aid.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673043" author="githubbot" created="Fri, 2 Nov 2018 12:41:42 +0000"  >&lt;p&gt;zentol commented on a change in pull request #6996: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt; Change reporter log level&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6996#discussion_r230360487&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6996#discussion_r230360487&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistryImpl.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -426,7 +426,12 @@ public void run() {&lt;br/&gt;
 			try &lt;/p&gt;
{
 				reporter.report();
 			}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.warn(&quot;Error while reporting metrics&quot;, t);&lt;br/&gt;
+				if (LOG.isDebugEnabled()) {&lt;br/&gt;
+					LOG.debug(&quot;Error while reporting metrics {}&quot;, t);&lt;br/&gt;
+				}&lt;br/&gt;
+				else {&lt;br/&gt;
+					LOG.warn(&quot;Error while reporting metrics&quot;, t.getMessage());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I agree that it is a band-aid. That&apos;s why I haven&apos;t made that change yet, I wanted to solve this properly &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673984" author="githubbot" created="Sat, 3 Nov 2018 09:37:37 +0000"  >&lt;p&gt;asfgit closed pull request #7008: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10715&quot; title=&quot;E2e tests fail with ConcurrentModificationException in MetricRegistryImpl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10715&quot;&gt;&lt;del&gt;FLINK-10715&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Suppress ConcurrentModificationException thrown by the Slf4jReporter&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7008&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7008&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-metrics/flink-metrics-slf4j/src/main/java/org/apache/flink/metrics/slf4j/Slf4jReporter.java b/flink-metrics/flink-metrics-slf4j/src/main/java/org/apache/flink/metrics/slf4j/Slf4jReporter.java&lt;br/&gt;
index 124efe227a3..ce6acb0c9ac 100644&lt;br/&gt;
&amp;#8212; a/flink-metrics/flink-metrics-slf4j/src/main/java/org/apache/flink/metrics/slf4j/Slf4jReporter.java&lt;br/&gt;
+++ b/flink-metrics/flink-metrics-slf4j/src/main/java/org/apache/flink/metrics/slf4j/Slf4jReporter.java&lt;br/&gt;
@@ -33,6 +33,7 @@&lt;br/&gt;
 import org.slf4j.Logger;&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;+import java.util.ConcurrentModificationException;&lt;br/&gt;
 import java.util.Map;&lt;/p&gt;

&lt;p&gt; /**&lt;br/&gt;
@@ -75,6 +76,16 @@ public void close() {&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public void report() {&lt;br/&gt;
+		try &lt;/p&gt;
{
+			tryReport();
+		}
&lt;p&gt;+		catch (ConcurrentModificationException ignored) &lt;/p&gt;
{
+			// at tryReport() we don&apos;t synchronize while iterating over the various maps which might cause a
+			// ConcurrentModificationException to be thrown, if concurrently a metric is being added or removed.
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
+	private void tryReport() {&lt;br/&gt;
 		// initialize with previous size to avoid repeated resizing of backing array&lt;br/&gt;
 		// pad the size to allow deviations in the final string, for example due to different double value representations&lt;br/&gt;
 		StringBuilder builder = new StringBuilder((int) (previousSize * 1.1));&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673985" author="till.rohrmann" created="Sat, 3 Nov 2018 09:37:44 +0000"  >&lt;p&gt;Fixed via &lt;/p&gt;

&lt;p&gt;1.7.0: e91848858cbb760f4429ab306c82232bf9854cb8&lt;br/&gt;
1.6.3: 246fd8e212eff48505fe037a783ed03288a4cae6&lt;br/&gt;
1.5.6: 04496e912d58b4056f7b98b0b7f0c017db6eea1b&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13176558">FLINK-10035</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zr53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>