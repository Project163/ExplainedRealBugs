<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9190] YarnResourceManager sometimes does not request new Containers</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9190</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;&lt;br/&gt;
The &lt;tt&gt;YarnResourceManager&lt;/tt&gt; does not request new containers if &lt;tt&gt;TaskManagers&lt;/tt&gt; are killed rapidly in succession. After 5 minutes the job is restarted due to &lt;tt&gt;NoResourceAvailableException&lt;/tt&gt;, and the job runs normally afterwards. I suspect that &lt;tt&gt;TaskManager&lt;/tt&gt; failures are not registered if the failure occurs before the &lt;tt&gt;TaskManager&lt;/tt&gt; registers with the master. Logs are attached; I added additional log statements to &lt;tt&gt;YarnResourceManager.onContainersCompleted&lt;/tt&gt; and &lt;tt&gt;YarnResourceManager.onContainersAllocated&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Expected Behavior&lt;/b&gt;&lt;br/&gt;
The &lt;tt&gt;YarnResourceManager&lt;/tt&gt; should recognize that the container is completed and keep requesting new containers. The job should run as soon as resources are available. &lt;/p&gt;

</description>
                <environment>&lt;p&gt;Hadoop 2.8.3&lt;br/&gt;
ZooKeeper 3.4.5&lt;br/&gt;
Flink 71c3cd2781d36e0a03d022a38cc4503d343f7ff8&lt;/p&gt;</environment>
        <key id="13152998">FLINK-9190</key>
            <summary>YarnResourceManager sometimes does not request new Containers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gjy">Gary Yao</assignee>
                                    <reporter username="gjy">Gary Yao</reporter>
                        <labels>
                            <label>flip-6</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 17 Apr 2018 12:59:22 +0000</created>
                <updated>Fri, 7 Sep 2018 17:16:06 +0000</updated>
                            <resolved>Thu, 10 May 2018 14:24:52 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Deployment / YARN</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16443633" author="sihuazhou" created="Thu, 19 Apr 2018 07:10:03 +0000"  >&lt;p&gt;I think the problem is that in flip6, TM is spawned by &lt;tt&gt;ResourceManager&lt;/tt&gt; and driven by &lt;tt&gt;JobManager&lt;/tt&gt; (when scheduling an &lt;tt&gt;ExecutionGraph&lt;/tt&gt;), in this case &lt;tt&gt;TMs&lt;/tt&gt; were killed before the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; was allocated any &lt;tt&gt;slots&lt;/tt&gt;, so even the &lt;tt&gt;TMs&lt;/tt&gt; were killed, the &lt;tt&gt;JobManager&lt;/tt&gt; can&apos;t be notified and it can&apos;t fail the job immediately to trigger a new round scheduling. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; do you have any idea?&lt;/p&gt;</comment>
                            <comment id="16445315" author="githubbot" created="Fri, 20 Apr 2018 05:09:06 +0000"  >&lt;p&gt;GitHub user sihuazhou opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9190&quot; title=&quot;YarnResourceManager sometimes does not request new Containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9190&quot;&gt;&lt;del&gt;FLINK-9190&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; fix YarnResourceManager sometimes does not request new Containers&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR fixes the problem that `YarnResourceManager` does not request new Containers when container were killed without registering with `ResourceManager`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;fix YarnResourceManager sometimes does not request new Containers&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;add unit test to `YarnResourceManagerTest#testKillContainerBeforeTMRegisterSuccessfully()` verify this&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (&lt;b&gt;yes&lt;/b&gt;)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    no&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/sihuazhou/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sihuazhou/flink&lt;/a&gt; fixYarnResourceManagerRequestContainers&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5881&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit bbf03ca7fc709e11627560466bff01b9e750bbd2&lt;br/&gt;
Author: sihuazhou &amp;lt;summerleafs@...&amp;gt;&lt;br/&gt;
Date:   2018-04-20T05:02:28Z&lt;/p&gt;

&lt;p&gt;    fix YarnResourceManager sometimes does not request new Containers&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16447280" author="githubbot" created="Sun, 22 Apr 2018 16:47:52 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881#discussion_r183243029&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881#discussion_r183243029&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -265,6 +272,29 @@ protected void initialize() throws ResourceManagerException {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	@Override&lt;br/&gt;
    +	public CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registerTaskExecutor(&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think it&apos;s better to override `workerStarted()`&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    	@Override&lt;br/&gt;
    	protected YarnWorkerNode workerStarted(ResourceID resourceID) &lt;/p&gt;
{
    		// ack the pending register
    		pendingContainersExpectedToRegister.remove(resourceID);
    		return workerNodeMap.get(resourceID);
    	}
&lt;p&gt;    ```&lt;/p&gt;

&lt;p&gt;    This method is called when the registration was successful. When `registerTaskExecutor` is called, the registration can still fail.&lt;/p&gt;</comment>
                            <comment id="16447281" author="githubbot" created="Sun, 22 Apr 2018 16:47:52 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881#discussion_r183242992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881#discussion_r183242992&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -114,6 +118,9 @@&lt;/p&gt;

&lt;p&gt;     	private final Map&amp;lt;ResourceProfile, Integer&amp;gt; resourcePriorities = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;    +	/** The containers that we expected to register with ResourceManager. */&lt;br/&gt;
    +	private final Map&amp;lt;ResourceID, Container&amp;gt; pendingContainersExpectedToRegister = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    A concurrent map is not needed because state modifications are performed in the main thread of the RPC framework.&lt;/p&gt;

&lt;p&gt;    It&apos;s enough to use a `HashMap`:&lt;br/&gt;
    ```&lt;br/&gt;
    private final Map&amp;lt;ResourceID, Container&amp;gt; pendingContainersExpectedToRegister = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    ```&lt;/p&gt;
</comment>
                            <comment id="16447282" author="githubbot" created="Sun, 22 Apr 2018 16:47:52 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881#discussion_r183243246&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881#discussion_r183243246&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java &amp;#8212;&lt;br/&gt;
    @@ -388,4 +390,108 @@ public void testStopWorker() throws Exception {&lt;br/&gt;
     			assertTrue(resourceManager.getNumberOfRegisteredTaskManagers().get() == 0);&lt;br/&gt;
     		}};&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests the case that containers are killed before registering with ResourceManager successfully.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testKillContainerBeforeTMRegisterSuccessfully() throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I would drop this test because it is too complicated, uses internal hadoop APIs, and heavily relies on mocking. What do you think?&lt;/p&gt;</comment>
                            <comment id="16447283" author="githubbot" created="Sun, 22 Apr 2018 16:47:52 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881#discussion_r183243055&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881#discussion_r183243055&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -356,17 +395,25 @@ public void onContainersAllocated(List&amp;lt;Container&amp;gt; containers) {&lt;/p&gt;

&lt;p&gt;     					workerNodeMap.put(new ResourceID(containerIdStr), new YarnWorkerNode(container));&lt;/p&gt;

&lt;p&gt;    +					ResourceID resourceID = new ResourceID(containerIdStr);&lt;br/&gt;
    +&lt;br/&gt;
     					try &lt;/p&gt;
{
     						// Context information used to start a TaskExecutor Java process
     						ContainerLaunchContext taskExecutorLaunchContext = createTaskExecutorLaunchContext(
     							container.getResource(),
     							containerIdStr,
     							container.getNodeId().getHost());
     
    +						// remember the pending container that need to be registered with ResourceManager.
    +						pendingContainersExpectedToRegister.put(resourceID, container);
    +
     						nodeManagerClient.startContainer(container, taskExecutorLaunchContext);
     					}
&lt;p&gt; catch (Throwable t) {&lt;br/&gt;
     						log.error(&quot;Could not start TaskManager in container {}.&quot;, container.getId(), t);&lt;/p&gt;

&lt;p&gt;    +						// remove the failed container&lt;br/&gt;
    +						pendingContainersExpectedToRegister.remove(resourceID);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think we also need to call `workerNodeMap.remove(resourceID);`&lt;/p&gt;</comment>
                            <comment id="16447479" author="githubbot" created="Mon, 23 Apr 2018 02:35:23 +0000"  >&lt;p&gt;Github user sihuazhou commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881#discussion_r183265708&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881#discussion_r183265708&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -114,6 +118,9 @@&lt;/p&gt;

&lt;p&gt;     	private final Map&amp;lt;ResourceProfile, Integer&amp;gt; resourcePriorities = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;    +	/** The containers that we expected to register with ResourceManager. */&lt;br/&gt;
    +	private final Map&amp;lt;ResourceID, Container&amp;gt; pendingContainersExpectedToRegister = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I not sure whether a `HashMap` is enough here, because the `pendingContainersExpectedToRegister` not only used in the API that driven by RPC, but also used in some API that related to yarn itself, like the `onContainersCompleted()`, `onContainersAllocated()`. I made it to concurrent map also because I notified that `workerNodeMap` is also a concurrent map which has a similar behavior with `pendingContainersExpectedToRegister`, what do you think?&lt;/p&gt;</comment>
                            <comment id="16447480" author="githubbot" created="Mon, 23 Apr 2018 02:35:42 +0000"  >&lt;p&gt;Github user sihuazhou commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881#discussion_r183265730&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881#discussion_r183265730&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -265,6 +272,29 @@ protected void initialize() throws ResourceManagerException {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	@Override&lt;br/&gt;
    +	public CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registerTaskExecutor(&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Good point! Have to change.&lt;/p&gt;</comment>
                            <comment id="16447483" author="githubbot" created="Mon, 23 Apr 2018 02:38:23 +0000"  >&lt;p&gt;Github user sihuazhou commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881#discussion_r183265947&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881#discussion_r183265947&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -356,17 +395,25 @@ public void onContainersAllocated(List&amp;lt;Container&amp;gt; containers) {&lt;/p&gt;

&lt;p&gt;     					workerNodeMap.put(new ResourceID(containerIdStr), new YarnWorkerNode(container));&lt;/p&gt;

&lt;p&gt;    +					ResourceID resourceID = new ResourceID(containerIdStr);&lt;br/&gt;
    +&lt;br/&gt;
     					try &lt;/p&gt;
{
     						// Context information used to start a TaskExecutor Java process
     						ContainerLaunchContext taskExecutorLaunchContext = createTaskExecutorLaunchContext(
     							container.getResource(),
     							containerIdStr,
     							container.getNodeId().getHost());
     
    +						// remember the pending container that need to be registered with ResourceManager.
    +						pendingContainersExpectedToRegister.put(resourceID, container);
    +
     						nodeManagerClient.startContainer(container, taskExecutorLaunchContext);
     					}
&lt;p&gt; catch (Throwable t) {&lt;br/&gt;
     						log.error(&quot;Could not start TaskManager in container {}.&quot;, container.getId(), t);&lt;/p&gt;

&lt;p&gt;    +						// remove the failed container&lt;br/&gt;
    +						pendingContainersExpectedToRegister.remove(resourceID);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nice catch!&lt;/p&gt;</comment>
                            <comment id="16447492" author="githubbot" created="Mon, 23 Apr 2018 02:48:17 +0000"  >&lt;p&gt;Github user sihuazhou commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881#discussion_r183267016&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881#discussion_r183267016&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java &amp;#8212;&lt;br/&gt;
    @@ -388,4 +390,108 @@ public void testStopWorker() throws Exception {&lt;br/&gt;
     			assertTrue(resourceManager.getNumberOfRegisteredTaskManagers().get() == 0);&lt;br/&gt;
     		}};&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests the case that containers are killed before registering with ResourceManager successfully.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testKillContainerBeforeTMRegisterSuccessfully() throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Hmm...most code of this test is mirror from an another test `testStopWorker()` in this class. I agreed that it&#8216;s a bit complicated but it&apos;s logical could ensure that we can test the corner situation properly (the container is killed before registering successfully). TBH, I don&apos;t know how to make sure this the corner situation can be test, I think I&apos;m a bit fool here... could you give me some more detail advice?&lt;/p&gt;</comment>
                            <comment id="16447495" author="githubbot" created="Mon, 23 Apr 2018 02:53:00 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @GJL! Thanks for your nice reviews, I will address the comments you left ASAP, but some of them I could&apos;t catch up properly, looking forward your reply. &lt;/p&gt;</comment>
                            <comment id="16447519" author="githubbot" created="Mon, 23 Apr 2018 03:20:02 +0000"  >&lt;p&gt;Github user sihuazhou commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881#discussion_r183269424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881#discussion_r183269424&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -265,6 +272,29 @@ protected void initialize() throws ResourceManagerException {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	@Override&lt;br/&gt;
    +	public CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registerTaskExecutor(&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I&apos;ve moved the `ack the pending registration` to `workerStarted()`. but I found it still a little chance could lead the registration to be failed...&lt;/p&gt;

&lt;p&gt;    !&lt;span class=&quot;error&quot;&gt;&amp;#91;image&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://user-images.githubusercontent.com/7480427/39105198-21a59626-46e7-11e8-809b-d111e81af51b.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://user-images.githubusercontent.com/7480427/39105198-21a59626-46e7-11e8-809b-d111e81af51b.png&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;    e.g, if the some unexpected things occur between lines `700` and `720`, then the registration can still fail... I think maybe we should override the `registerTaskExecutor()` and ack the pending registration only when the future of `super.registerTaskExecutor()` is completed, what do you think?&lt;/p&gt;
</comment>
                            <comment id="16447586" author="githubbot" created="Mon, 23 Apr 2018 05:36:20 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Ah, failed on travis, but it is not related to this PR, it&apos;s a bug that should be addressed and there is already a PR for it &lt;a href=&quot;https://github.com/apache/flink/pull/5886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5886&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="16448928" author="githubbot" created="Mon, 23 Apr 2018 22:01:46 +0000"  >&lt;p&gt;Github user GJL commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @sihuazhou I will take a look again. Unfortunately there are still sporadically problems with starting new containers. I am trying to debug this to see whether we should fix it now, or under a new ticket.&lt;/p&gt;</comment>
                            <comment id="16449205" author="githubbot" created="Tue, 24 Apr 2018 02:55:02 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @GJL I also noticed that this PR can only solve part of the problem...it can only make sure that the `TM` is registered with ResourceManager properly, but it can&apos;t make sure that the `TM` could connection with JobManager properly...&lt;/p&gt;

&lt;p&gt;    Is it possible that the problem you met is that the `TM` was killed before connecting to `JM` successfully, that way `ResourceManager `can&apos;t be notified to trigger a new container request and the `JM` can&apos;t be notified either...What do you think?&lt;/p&gt;</comment>
                            <comment id="16449766" author="githubbot" created="Tue, 24 Apr 2018 12:41:44 +0000"  >&lt;p&gt;Github user GJL commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @sihuazhou I think are you right. I don&apos;t see an easy solution to this at the&lt;br/&gt;
    moment.&lt;/p&gt;</comment>
                            <comment id="16449774" author="githubbot" created="Tue, 24 Apr 2018 12:47:06 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 to wait for @tillrohrmann &lt;/p&gt;</comment>
                            <comment id="16456337" author="githubbot" created="Fri, 27 Apr 2018 12:59:13 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @GJL I see you took over this ticket, I closing this PR now, looking forward your PR &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="16456338" author="githubbot" created="Fri, 27 Apr 2018 12:59:17 +0000"  >&lt;p&gt;Github user sihuazhou closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16456605" author="githubbot" created="Fri, 27 Apr 2018 15:21:13 +0000"  >&lt;p&gt;GitHub user GJL opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9190&quot; title=&quot;YarnResourceManager sometimes does not request new Containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9190&quot;&gt;&lt;del&gt;FLINK-9190&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6,yarn&amp;#93;&lt;/span&gt; Request new container if container completed unexpectedly&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    &lt;b&gt;Request new YARN container if container completed unexpectedly.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;    cc: @sihuazhou @StephanEwen @tillrohrmann &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Request new container if container completed unexpectedly.&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Reduce visibility of some fields in `YarnResourceManager`.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change added tests and can be verified as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Manually verified the change by deploying a Flink cluster on YARN and killing `TaskExecutorRunner`s randomly.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/GJL/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/GJL/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9190&quot; title=&quot;YarnResourceManager sometimes does not request new Containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9190&quot;&gt;&lt;del&gt;FLINK-9190&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5931&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 35b02327fcbcb9a7fed3ad162e26f9900c774558&lt;br/&gt;
Author: gyao &amp;lt;gary@...&amp;gt;&lt;br/&gt;
Date:   2018-04-27T13:49:31Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9190&quot; title=&quot;YarnResourceManager sometimes does not request new Containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9190&quot;&gt;&lt;del&gt;FLINK-9190&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6,yarn&amp;#93;&lt;/span&gt; Request new container if container completed unexpectedly.&lt;/p&gt;

&lt;p&gt;commit 3d02f3c171a4473b25377c2319506901228ff8f3&lt;br/&gt;
Author: gyao &amp;lt;gary@...&amp;gt;&lt;br/&gt;
Date:   2018-04-27T13:51:38Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Reduce visibility of fields.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16457261" author="githubbot" created="Sat, 28 Apr 2018 00:35:12 +0000"  >&lt;p&gt;Github user sihuazhou commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931#discussion_r184831311&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#discussion_r184831311&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -293,21 +293,16 @@ public void startNewWorker(ResourceProfile resourceProfile) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public boolean stopWorker(YarnWorkerNode workerNode) {&lt;/li&gt;
	&lt;li&gt;if (workerNode != null) {&lt;/li&gt;
	&lt;li&gt;Container container = workerNode.getContainer();&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;/li&gt;
	&lt;li&gt;// release the container on the node manager&lt;/li&gt;
	&lt;li&gt;try 
{
    -				nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    -			}
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
    -				log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, t);
    -			}&lt;/li&gt;
	&lt;li&gt;resourceManagerClient.releaseAssignedContainer(container.getId());&lt;/li&gt;
	&lt;li&gt;workerNodeMap.remove(workerNode.getResourceID());&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;log.error(&quot;Can not find container for null workerNode.&quot;);&lt;br/&gt;
    +	public boolean stopWorker(final YarnWorkerNode workerNode) {&lt;br/&gt;
    +		final Container container = workerNode.getContainer();&lt;br/&gt;
    +		log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;br/&gt;
    +		try 
{
    +			nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    +		}
&lt;p&gt; catch (final Exception e) {&lt;br/&gt;
    +			log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, e);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Previous version was the `Throwable` here, currently changed to `Exception`, what the reason here? Beside, if we change here from `Throwable` -&amp;gt; `Exception` then maybe we should also change the other places where have a similar operation with `nodeManagerClient` like here, e.g. &lt;/p&gt;

&lt;p&gt;    !&lt;span class=&quot;error&quot;&gt;&amp;#91;image&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://user-images.githubusercontent.com/7480427/39389518-e609686c-4abb-11e8-99df-b0cd013a58ef.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://user-images.githubusercontent.com/7480427/39389518-e609686c-4abb-11e8-99df-b0cd013a58ef.png&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="16457262" author="githubbot" created="Sat, 28 Apr 2018 00:35:12 +0000"  >&lt;p&gt;Github user sihuazhou commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931#discussion_r184832034&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#discussion_r184832034&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -293,21 +293,16 @@ public void startNewWorker(ResourceProfile resourceProfile) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public boolean stopWorker(YarnWorkerNode workerNode) {&lt;/li&gt;
	&lt;li&gt;if (workerNode != null) {&lt;/li&gt;
	&lt;li&gt;Container container = workerNode.getContainer();&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;/li&gt;
	&lt;li&gt;// release the container on the node manager&lt;/li&gt;
	&lt;li&gt;try 
{
    -				nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    -			}
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
    -				log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, t);
    -			}&lt;/li&gt;
	&lt;li&gt;resourceManagerClient.releaseAssignedContainer(container.getId());&lt;/li&gt;
	&lt;li&gt;workerNodeMap.remove(workerNode.getResourceID());&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;log.error(&quot;Can not find container for null workerNode.&quot;);&lt;br/&gt;
    +	public boolean stopWorker(final YarnWorkerNode workerNode) {&lt;br/&gt;
    +		final Container container = workerNode.getContainer();&lt;br/&gt;
    +		log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;br/&gt;
    +		try 
{
    +			nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    +		}
&lt;p&gt; catch (final Exception e) &lt;/p&gt;
{
    +			log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, e);
     		}
&lt;p&gt;    +		resourceManagerClient.releaseAssignedContainer(container.getId());&lt;br/&gt;
    +		workerNodeMap.remove(workerNode.getResourceID());&lt;br/&gt;
     		return true;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    These seems to lead us to have a very little chance to require a new unnecessary Container... Since we call `nodeManagerClient.stopContainer(container.getId(), container.getNodeId());` firstly, then call `workerNodeMap.remove(workerNode.getResourceID())`. I&apos;m not sure whether we can reverse the invocation order of them in this function(I&apos;m not sure because I don&apos;t know whether this would lead to new problem...), what do you think? &lt;/p&gt;</comment>
                            <comment id="16458384" author="githubbot" created="Mon, 30 Apr 2018 08:02:48 +0000"  >&lt;p&gt;Github user GJL commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @sihuazhou Thx for the review. I&apos;ll take a look at your comments later. Unfortunately with this patch it can still happen that a job is not running even if enough TMs are available. I have uploaded the JM logs here &lt;a href=&quot;https://gist.github.com/GJL/3b109db48734ff40103f47d04fc54bd3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/GJL/3b109db48734ff40103f47d04fc54bd3&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="16458767" author="githubbot" created="Mon, 30 Apr 2018 17:01:20 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @GJL , is it possible that the reason is the same as in the previous PR for this ticket, that is even the container setup successfully and connect with ResourceManager successfully, but the TM was killed before connecting to JobManager successfully. In this case, even though there are enough TMs, JobManager won&apos;t fire any new request, and the ResourceManager doesn&apos;t know that the container it assigned to JobManager  has been killed either, so both JobManager &amp;amp; ResourceManager won&apos;t do anything but waiting for timeout... What do you think?&lt;/p&gt;</comment>
                            <comment id="16458891" author="githubbot" created="Mon, 30 Apr 2018 19:03:44 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;     @GJL Briefly digging through the log, there are a few strange things happening:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`YarnResourceManager` still has 8 pending requests even when 11 containers are running:&lt;br/&gt;
    ```Received new container: container_1524853016208_0001_01_000184 - Remaining pending container requests: 8```&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Some slots are requested and then the requests are cancelled again&lt;/li&gt;
	&lt;li&gt;In the end, one request is not fulfilled: `aeec2a9f010a187e04e31e6efd6f0f88`&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Might be an inconsistency in either in the `SlotManager` or `SlotPool`.&lt;/p&gt;</comment>
                            <comment id="16463386" author="githubbot" created="Fri, 4 May 2018 05:35:22 +0000"  >&lt;p&gt;Github user shuai-xu commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @GJL In blink, we solve this problem like this. &lt;br/&gt;
    When a container complete, we will first whether the container has registered yet, if it has registered before, RM will not request a new container, as the job master will ask for it when failover. If it has not registered, RM will request a new one.&lt;/p&gt;</comment>
                            <comment id="16463404" author="githubbot" created="Fri, 4 May 2018 06:09:42 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @shuai-xu, If I&apos;m not misunderstand, I think your approach is exactly what I have done in the previous &lt;span class=&quot;error&quot;&gt;&amp;#91;PR&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/flink/pull/5881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5881&lt;/a&gt;) for this ticket, but it faces the same problem as that faced by this PR. That&apos;s even the  container registered with RM successfully, but after RM offering the slot to JM, the container was killed before it registered with JM successfully. I think one way to overcome this is that the RM should notify the JM which TM it will connect with before the RM assign the slot to it, this way JM could be notified that the TM was killed before connecting with it successfully.&lt;/p&gt;</comment>
                            <comment id="16464885" author="githubbot" created="Sat, 5 May 2018 20:12:30 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @sihuazhou and @shuai-xu thank you for your help in understanding the bug here.&lt;/p&gt;

&lt;p&gt;    Let me rephrase it to make sure I understand the problem exactly. The steps are the following:&lt;/p&gt;

&lt;p&gt;      1. JobMaster / SlotPool requests a slot (AllocationID) from the ResourceManager&lt;br/&gt;
      2. ResourceManager starts a container with a TaskManager&lt;br/&gt;
      3. TaskManager registers at ResourceManager, which tells the TaskManager to push a slot to the JobManager.&lt;br/&gt;
      4. TaskManager container is killed&lt;br/&gt;
      5. The ResourceManager does not queue back the slot requests (AllocationIDs) that it sent to the previous TaskManager, so the requests are lost and need to time out before another attempt is tried.&lt;/p&gt;

&lt;p&gt;    Some thoughts on how to deal with this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It seems the ResourceManager should put the slots from the TaskManager that was failed back to &quot;pending&quot; so they are given to the next TaskManager that starts.&lt;/li&gt;
	&lt;li&gt;I assume that is not happening, because there is concern that the failure is also detected on the JobManager/SlotPool and retried there and there are double re-tries&lt;/li&gt;
	&lt;li&gt;The solution would be to better define the protocol with respect to who is responsible for what retries.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Two ideas on how to fix that:&lt;br/&gt;
      1. The ResourceManager notifies the SlotPool that a certain set of AllocationIDs has failed, and the SlotPool directly retries the allocations, resulting in directly starting new containers.&lt;br/&gt;
      2. The ResourceManager always retries allocations for AllocationIDs it knows. The SlotPool would not retry, it would keep the same allocations always unless they are released as unneeded. We would probably need something to make sure that the SlotPool can distinguish from different offers of the same AllocationID (in case the ResourceManager assumes a timeout but a request goes actually through) - possibly something like an attempt-counter (higher wins).&lt;/p&gt;

&lt;p&gt;    @tillrohrmann also interested in your thoughts here.&lt;/p&gt;
</comment>
                            <comment id="16467046" author="githubbot" created="Tue, 8 May 2018 08:08:01 +0000"  >&lt;p&gt;Github user shuai-xu commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen, Good idea, I prefer the first one. As for the second one, the pending request may have been fulfilled when task executor is killed. so job master can not cancel the pending request. And when job master failover the job at the same time with resource manager request a new container, it may ask one more container than needed.&lt;/p&gt;</comment>
                            <comment id="16467198" author="githubbot" created="Tue, 8 May 2018 10:14:29 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I also `+1` for the first approach, but I would like to wait for @tillrohrmann &apos;s opinion. &lt;/p&gt;

&lt;p&gt;    And I also curious about one thing, that is currently when ResourceManager allocate a slot for the `pendingSlotRequest`, it send JM&apos;s information to the TM, and let TM offer the slot to the JM. What I wonder is that why the ResourceManager doesn&apos;t send the slot&apos;s TM information to the JM, and let the JM fetch slot from TM, is there some special reasons? This problem seems should not exists, if RM send slot&apos;s TM information to JM and let JM fetch slot from TM.&lt;/p&gt;</comment>
                            <comment id="16469092" author="githubbot" created="Wed, 9 May 2018 17:01:07 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931#discussion_r187106742&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#discussion_r187106742&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -293,21 +293,16 @@ public void startNewWorker(ResourceProfile resourceProfile) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public boolean stopWorker(YarnWorkerNode workerNode) {&lt;/li&gt;
	&lt;li&gt;if (workerNode != null) {&lt;/li&gt;
	&lt;li&gt;Container container = workerNode.getContainer();&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;/li&gt;
	&lt;li&gt;// release the container on the node manager&lt;/li&gt;
	&lt;li&gt;try 
{
    -				nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    -			}
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
    -				log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, t);
    -			}&lt;/li&gt;
	&lt;li&gt;resourceManagerClient.releaseAssignedContainer(container.getId());&lt;/li&gt;
	&lt;li&gt;workerNodeMap.remove(workerNode.getResourceID());&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;log.error(&quot;Can not find container for null workerNode.&quot;);&lt;br/&gt;
    +	public boolean stopWorker(final YarnWorkerNode workerNode) {&lt;br/&gt;
    +		final Container container = workerNode.getContainer();&lt;br/&gt;
    +		log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;br/&gt;
    +		try 
{
    +			nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    +		}
&lt;p&gt; catch (final Exception e) &lt;/p&gt;
{
    +			log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, e);
     		}
&lt;p&gt;    +		resourceManagerClient.releaseAssignedContainer(container.getId());&lt;br/&gt;
    +		workerNodeMap.remove(workerNode.getResourceID());&lt;br/&gt;
     		return true;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    the `stopWorker` method should only be called from the main thread. Therefore, there should be no race condition.&lt;/p&gt;</comment>
                            <comment id="16469093" author="githubbot" created="Wed, 9 May 2018 17:01:07 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931#discussion_r187102871&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#discussion_r187102871&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -293,21 +293,16 @@ public void startNewWorker(ResourceProfile resourceProfile) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public boolean stopWorker(YarnWorkerNode workerNode) {&lt;/li&gt;
	&lt;li&gt;if (workerNode != null) {&lt;/li&gt;
	&lt;li&gt;Container container = workerNode.getContainer();&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;/li&gt;
	&lt;li&gt;// release the container on the node manager&lt;/li&gt;
	&lt;li&gt;try 
{
    -				nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    -			}
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
    -				log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, t);
    -			}&lt;/li&gt;
	&lt;li&gt;resourceManagerClient.releaseAssignedContainer(container.getId());&lt;/li&gt;
	&lt;li&gt;workerNodeMap.remove(workerNode.getResourceID());&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;log.error(&quot;Can not find container for null workerNode.&quot;);&lt;br/&gt;
    +	public boolean stopWorker(final YarnWorkerNode workerNode) {&lt;br/&gt;
    +		final Container container = workerNode.getContainer();&lt;br/&gt;
    +		log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;br/&gt;
    +		try 
{
    +			nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    +		}
&lt;p&gt; catch (final Exception e) {&lt;br/&gt;
    +			log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, e);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think the reason is that @GJL does not want to swallow `Errors`.&lt;/p&gt;</comment>
                            <comment id="16469114" author="githubbot" created="Wed, 9 May 2018 17:17:03 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I looked into the problem @GJL reported and I think it is not caused by killed TMs which don&apos;t have the chance to tell the JMs about the slot allocations (even though this can theoretically happen). In such a case, the protocol currently relies on the slot request timeout on the JM side to resend new requests.&lt;/p&gt;

&lt;p&gt;    I think the actual problem is related to #5980. The problem there is that the `ExecutionGraph` does not wait until all of its slots have been properly returned to the `SlotPool` before it is restarted in case of a recovery. Due to this, it might happen that some of the old tasks occupy some slots which are actually needed for the new tasks. If this happens, the actual task to slot assignment might be suboptimal meaning that the tasks are spread across more slots than needed. For example, assume that we have two slots with a mapper and sink task:&lt;/p&gt;

&lt;p&gt;    `S1: M1_old, S1_old`&lt;br/&gt;
    `S2: M2_old, S2_old`&lt;/p&gt;

&lt;p&gt;    Now a failover happens and the system restarts the `ExecutionGraph`. When this happens `M1_old` and `S2_old` have not been properly released.&lt;/p&gt;

&lt;p&gt;    `S1: M1_old`&lt;br/&gt;
    `S2: S2_old`&lt;/p&gt;

&lt;p&gt;    Now we try to schedule the new tasks which suddenly needs 3 slots.&lt;/p&gt;

&lt;p&gt;    `S1: M1_old, S1_new`&lt;br/&gt;
    `S2: M2_new, S2_old`&lt;br/&gt;
    `S3: M1_new, S2_new`&lt;/p&gt;

&lt;p&gt;    After the old tasks have been released it would like that:&lt;/p&gt;

&lt;p&gt;    `S1: S1_new`&lt;br/&gt;
    `S2: M2_new`&lt;br/&gt;
    `S3:M1_new, S2_new`&lt;/p&gt;

&lt;p&gt;    With @GJL tests we had the situation that we could only allocate one additional container due to resource limitations. Thus, if we actually needed 2 additional container, the program could not start.&lt;/p&gt;

&lt;p&gt;    By properly waiting for the slot release such a situation should no longer happen.&lt;/p&gt;

&lt;p&gt;    However, #5980 does not solve the problem of early killed TMs which could not communicate with the JM. At the moment we would have to rely on the slot request timeouts to resolve this situation.&lt;/p&gt;

</comment>
                            <comment id="16469847" author="githubbot" created="Thu, 10 May 2018 02:38:54 +0000"  >&lt;p&gt;Github user sihuazhou commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931#discussion_r187227128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#discussion_r187227128&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -293,21 +293,16 @@ public void startNewWorker(ResourceProfile resourceProfile) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public boolean stopWorker(YarnWorkerNode workerNode) {&lt;/li&gt;
	&lt;li&gt;if (workerNode != null) {&lt;/li&gt;
	&lt;li&gt;Container container = workerNode.getContainer();&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;/li&gt;
	&lt;li&gt;// release the container on the node manager&lt;/li&gt;
	&lt;li&gt;try 
{
    -				nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    -			}
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
    -				log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, t);
    -			}&lt;/li&gt;
	&lt;li&gt;resourceManagerClient.releaseAssignedContainer(container.getId());&lt;/li&gt;
	&lt;li&gt;workerNodeMap.remove(workerNode.getResourceID());&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;log.error(&quot;Can not find container for null workerNode.&quot;);&lt;br/&gt;
    +	public boolean stopWorker(final YarnWorkerNode workerNode) {&lt;br/&gt;
    +		final Container container = workerNode.getContainer();&lt;br/&gt;
    +		log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;br/&gt;
    +		try 
{
    +			nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    +		}
&lt;p&gt; catch (final Exception e) &lt;/p&gt;
{
    +			log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, e);
     		}
&lt;p&gt;    +		resourceManagerClient.releaseAssignedContainer(container.getId());&lt;br/&gt;
    +		workerNodeMap.remove(workerNode.getResourceID());&lt;br/&gt;
     		return true;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Ah, I think I am a bit confused here, even though the `stopWorker` method only called from the main thread, but the `onContainersCompleted` is not. &lt;/p&gt;

&lt;p&gt;    So, imagine that if we insert a `Thread.MILLISECOND.sleep(1000)`(this represents the latency of code execution in reality)  between line 304 and 305, then `onContainersCompleted` would be called during the main thread was sleeping. Then, we require a new unnecessary container in `onContainersCompleted`, because the `workerNodeMap.remove(workerNode.getResourceID())` hasn&apos;t been called yet(during to the sleep). Am I misunderstand something? What do you think? &lt;/p&gt;</comment>
                            <comment id="16470446" author="githubbot" created="Thu, 10 May 2018 14:23:38 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16470453" author="till.rohrmann" created="Thu, 10 May 2018 14:24:52 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
master: fa11015ddcdb0217da6a8b2be1e2a55efd26d7fa&lt;br/&gt;
1.5.0: 3a9df1a89a7511553452b988cf04fd4ca7907e47&lt;/p&gt;</comment>
                            <comment id="16471146" author="githubbot" created="Thu, 10 May 2018 21:30:53 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931#discussion_r187466146&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#discussion_r187466146&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -293,21 +293,16 @@ public void startNewWorker(ResourceProfile resourceProfile) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public boolean stopWorker(YarnWorkerNode workerNode) {&lt;/li&gt;
	&lt;li&gt;if (workerNode != null) {&lt;/li&gt;
	&lt;li&gt;Container container = workerNode.getContainer();&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;/li&gt;
	&lt;li&gt;// release the container on the node manager&lt;/li&gt;
	&lt;li&gt;try 
{
    -				nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    -			}
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
    -				log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, t);
    -			}&lt;/li&gt;
	&lt;li&gt;resourceManagerClient.releaseAssignedContainer(container.getId());&lt;/li&gt;
	&lt;li&gt;workerNodeMap.remove(workerNode.getResourceID());&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;log.error(&quot;Can not find container for null workerNode.&quot;);&lt;br/&gt;
    +	public boolean stopWorker(final YarnWorkerNode workerNode) {&lt;br/&gt;
    +		final Container container = workerNode.getContainer();&lt;br/&gt;
    +		log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;br/&gt;
    +		try 
{
    +			nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    +		}
&lt;p&gt; catch (final Exception e) &lt;/p&gt;
{
    +			log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, e);
     		}
&lt;p&gt;    +		resourceManagerClient.releaseAssignedContainer(container.getId());&lt;br/&gt;
    +		workerNodeMap.remove(workerNode.getResourceID());&lt;br/&gt;
     		return true;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    @sihuazhou  The body in `onContainersCompleted` is wrapped in `runAsync`&lt;br/&gt;
    ```&lt;br/&gt;
    protected void runAsync(Runnable runnable)&lt;br/&gt;
    Execute the runnable in the main thread of the underlying RPC endpoint.&lt;br/&gt;
    Parameters:&lt;br/&gt;
    runnable - Runnable to be executed in the main thread of the underlying RPC endpoint&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16471451" author="githubbot" created="Fri, 11 May 2018 03:44:05 +0000"  >&lt;p&gt;Github user sihuazhou commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5931#discussion_r187514050&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#discussion_r187514050&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -293,21 +293,16 @@ public void startNewWorker(ResourceProfile resourceProfile) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public boolean stopWorker(YarnWorkerNode workerNode) {&lt;/li&gt;
	&lt;li&gt;if (workerNode != null) {&lt;/li&gt;
	&lt;li&gt;Container container = workerNode.getContainer();&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;/li&gt;
	&lt;li&gt;// release the container on the node manager&lt;/li&gt;
	&lt;li&gt;try 
{
    -				nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    -			}
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
    -				log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, t);
    -			}&lt;/li&gt;
	&lt;li&gt;resourceManagerClient.releaseAssignedContainer(container.getId());&lt;/li&gt;
	&lt;li&gt;workerNodeMap.remove(workerNode.getResourceID());&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;log.error(&quot;Can not find container for null workerNode.&quot;);&lt;br/&gt;
    +	public boolean stopWorker(final YarnWorkerNode workerNode) {&lt;br/&gt;
    +		final Container container = workerNode.getContainer();&lt;br/&gt;
    +		log.info(&quot;Stopping container {}.&quot;, container.getId());&lt;br/&gt;
    +		try 
{
    +			nodeManagerClient.stopContainer(container.getId(), container.getNodeId());
    +		}
&lt;p&gt; catch (final Exception e) &lt;/p&gt;
{
    +			log.warn(&quot;Error while calling YARN Node Manager to stop container&quot;, e);
     		}
&lt;p&gt;    +		resourceManagerClient.releaseAssignedContainer(container.getId());&lt;br/&gt;
    +		workerNodeMap.remove(workerNode.getResourceID());&lt;br/&gt;
     		return true;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    @GJL Thanks for figure out that for me, I missed that, I feel I&apos;m a bit stupid now...&lt;/p&gt;</comment>
                            <comment id="16594578" author="githubbot" created="Tue, 28 Aug 2018 06:25:41 +0000"  >&lt;p&gt;TisonKun commented on issue #5931: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9190&quot; title=&quot;YarnResourceManager sometimes does not request new Containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9190&quot;&gt;&lt;del&gt;FLINK-9190&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6,yarn&amp;#93;&lt;/span&gt; Request new container if container completed unexpectedly&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5931#issuecomment-416465819&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#issuecomment-416465819&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Did #6132 implement @StephanEwen first proposal?&lt;/p&gt;

&lt;p&gt;   cc @tillrohrmann @sihuazhou &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16594579" author="githubbot" created="Tue, 28 Aug 2018 06:25:49 +0000"  >&lt;p&gt;TisonKun edited a comment on issue #5931: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9190&quot; title=&quot;YarnResourceManager sometimes does not request new Containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9190&quot;&gt;&lt;del&gt;FLINK-9190&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6,yarn&amp;#93;&lt;/span&gt; Request new container if container completed unexpectedly&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5931#issuecomment-416465819&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#issuecomment-416465819&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Did #6132 implement @StephanEwen first proposal here?&lt;/p&gt;

&lt;p&gt;   cc @tillrohrmann @sihuazhou &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16596147" author="githubbot" created="Wed, 29 Aug 2018 09:52:50 +0000"  >&lt;p&gt;tillrohrmann commented on issue #5931: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9190&quot; title=&quot;YarnResourceManager sometimes does not request new Containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9190&quot;&gt;&lt;del&gt;FLINK-9190&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6,yarn&amp;#93;&lt;/span&gt; Request new container if container completed unexpectedly&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5931#issuecomment-416895148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#issuecomment-416895148&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;    @TisonKun, yes #6132 implements the notification about failed allocations. However, the `SlotPool` won&apos;t directly retry the slot request. Instead the `ExecutionGraph` will be failed and the allocation will be retried after the job has been restarted.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16598274" author="githubbot" created="Fri, 31 Aug 2018 05:45:55 +0000"  >&lt;p&gt;TisonKun commented on issue #5931: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9190&quot; title=&quot;YarnResourceManager sometimes does not request new Containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9190&quot;&gt;&lt;del&gt;FLINK-9190&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6,yarn&amp;#93;&lt;/span&gt; Request new container if container completed unexpectedly&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5931#issuecomment-417558343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#issuecomment-417558343&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @tillrohrmann thanks for your reply. Here is one more question.&lt;br/&gt;
   Does `ResourceManager` asks for slot by itself? With current codebase `ResourceManager` would ask for new worker as container complete unexpectedly. What if `ExecutionGraph` failover concurrent to  `ResourceManager` asks for new worker? Is there one more extra worker be started?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16607348" author="githubbot" created="Fri, 7 Sep 2018 16:50:19 +0000"  >&lt;p&gt;tillrohrmann commented on issue #5931: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9190&quot; title=&quot;YarnResourceManager sometimes does not request new Containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9190&quot;&gt;&lt;del&gt;FLINK-9190&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6,yarn&amp;#93;&lt;/span&gt; Request new container if container completed unexpectedly&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5931#issuecomment-419500186&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#issuecomment-419500186&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Yes at the moment, this could happen. However, the superfluous `TaskManager` should be released after it idled around for too long. Moreover, I&apos;m currently working on making the `SlotManager` aware of how many outstanding slots he has requested. That way he should not allocate additional containers in case of a failover of the `ExecutionGraph`.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16607382" author="githubbot" created="Fri, 7 Sep 2018 17:16:06 +0000"  >&lt;p&gt;TisonKun commented on issue #5931: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9190&quot; title=&quot;YarnResourceManager sometimes does not request new Containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9190&quot;&gt;&lt;del&gt;FLINK-9190&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6,yarn&amp;#93;&lt;/span&gt; Request new container if container completed unexpectedly&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5931#issuecomment-419507178&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5931#issuecomment-419507178&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   IIRC it is &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9455&quot; title=&quot;Make SlotManager aware of multi slot TaskManagers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9455&quot;&gt;&lt;del&gt;FLINK-9455&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/projects/FLINK/issues/FLINK-9455?filter=allopenissues&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/projects/FLINK/issues/FLINK-9455?filter=allopenissues&lt;/a&gt;) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12919407" name="yarn-logs" size="3190324" author="gjy" created="Tue, 17 Apr 2018 12:53:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3sn9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>