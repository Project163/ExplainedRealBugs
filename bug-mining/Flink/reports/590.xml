<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:21:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2713] Custom StateCheckpointers should be included in the snapshots</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2713</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently the restoreInitialState call fails when the user uses a custom StateCheckpointer to create the snapshot, because the state is restored before the StateCheckpointer is set for the StreamOperatorState. (because the restoreInitialState() call precedes the open() call)&lt;/p&gt;

&lt;p&gt;To avoid this issue, the custom StateCheckpointer instance should be stored within the snapshot and should be set in the StreamOperatorState before calling restoreState(..).&lt;/p&gt;

&lt;p&gt;To reduce the overhead induced by this we can do 2 optimizations:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We only include custom StateCheckpointers (the default java serializer one is always available)&lt;/li&gt;
	&lt;li&gt;We only serialize the checkpointer once and store the byte array in the snapshot&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12888801">FLINK-2713</key>
            <summary>Custom StateCheckpointers should be included in the snapshots</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gyfora">Gyula Fora</assignee>
                                    <reporter username="gyfora">Gyula Fora</reporter>
                        <labels>
                    </labels>
                <created>Sat, 19 Sep 2015 21:00:01 +0000</created>
                <updated>Thu, 28 Feb 2019 11:15:01 +0000</updated>
                            <resolved>Mon, 21 Sep 2015 18:04:26 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14877445" author="githubbot" created="Sun, 20 Sep 2015 06:43:05 +0000"  >&lt;p&gt;GitHub user gyfora opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1150&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1150&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2713&quot; title=&quot;Custom StateCheckpointers should be included in the snapshots&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2713&quot;&gt;&lt;del&gt;FLINK-2713&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Include custom StateCheckpointers in the snapshots&lt;/p&gt;

&lt;p&gt;    Currently failure recovery fails when using custom StateCheckpointers because they are not correctly set before trying to restore the operator initial state. This PR solves this issue by including custom StateCheckpointers in the snapshot.&lt;/p&gt;

&lt;p&gt;    The current order of events and the problem:&lt;br/&gt;
     1. Create StreamTask&lt;br/&gt;
     2. Call restoreInitialState(snapshot) -&amp;gt; default java-serialization StateCheckpointer is used&lt;br/&gt;
     3. Open UDF and run computation. -&amp;gt; This is the point when custom StateCheckpointers are set&lt;br/&gt;
     4. Take snapshots....&lt;/p&gt;

&lt;p&gt;    We can see while the custom StateCheckpointers are available and work for taking snapshots they are not set set yet when call restore which obviously leads to error.&lt;/p&gt;

&lt;p&gt;    This PR now includes the custom StateCheckpointer in the snapshot so we can set it in step 2. before calling restore. An optimization is that we include only the serialized version as a byte array in the buffer so we don&apos;t need to serialize it over and over again.&lt;/p&gt;

&lt;p&gt;    The PR also extends the StreamCheckpointingITCase and the PartitionedStateCheckpointingITCase to include a case for custom StateCheckpointers for both local and partitioned OperatorStates.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/gyfora/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/gyfora/flink&lt;/a&gt; checkpointer&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1150.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1150.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1150&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ca8c04899554c0d438154b5eefc3e8e6b5543888&lt;br/&gt;
Author: Gyula Fora &amp;lt;gyfora@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-09-19T19:35:07Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2713&quot; title=&quot;Custom StateCheckpointers should be included in the snapshots&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2713&quot;&gt;&lt;del&gt;FLINK-2713&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Include custom StateCheckpointers in the snapshots&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14877462" author="githubbot" created="Sun, 20 Sep 2015 08:26:57 +0000"  >&lt;p&gt;Github user gyfora commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1150#issuecomment-141758138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1150#issuecomment-141758138&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Travis seems to fail on some unrelated test.&lt;/p&gt;

&lt;p&gt;    I validated that it fixes my issues with the streaming kv-store checkpoint recovery, where custom StateCheckpointers are used.&lt;/p&gt;</comment>
                            <comment id="14900380" author="githubbot" created="Mon, 21 Sep 2015 08:30:14 +0000"  >&lt;p&gt;Github user senorcarbone commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1150#issuecomment-141907506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1150#issuecomment-141907506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    At first I found it a bit odd to include serialized checkpointers on every single statehandle but on a second look maybe that is the only way to generalize operator states. The main problem is that  StreamOperatorState can be defined dynamically during runtime and thus, we need to allow dynamic checkpointers along with the operator states and include them in the state handles. &lt;/p&gt;

&lt;p&gt;    An alternative take which is slightly more restrictive is to enforce the user to pre-define all mappings from custom operator state names to checkpointers so we can configure these in the tasks themselves (kept in the execution graph once) instead of including them on each state handle. &lt;br/&gt;
    Apart from this concern the PR is well tested and documented!&lt;br/&gt;
    Any other opinions?&lt;/p&gt;</comment>
                            <comment id="14900439" author="githubbot" created="Mon, 21 Sep 2015 09:36:54 +0000"  >&lt;p&gt;Github user gyfora commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1150#issuecomment-141924945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1150#issuecomment-141924945&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Another possibility which I am going to try, is to make the state restore lazy, so it is only restored when the user calls state.value() at which point the StateCheckpointer should be set by the user.&lt;/p&gt;</comment>
                            <comment id="14900479" author="githubbot" created="Mon, 21 Sep 2015 10:24:02 +0000"  >&lt;p&gt;GitHub user gyfora opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1154&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2713&quot; title=&quot;Custom StateCheckpointers should be included in the snapshots&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2713&quot;&gt;&lt;del&gt;FLINK-2713&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Set state restore to lazy to avoid StateCheckpointer issues and reduce checkpoint overhead&lt;/p&gt;

&lt;p&gt;    Currently failure recovery fails when using custom StateCheckpointers because they are not correctly set before trying to restore the operator initial state. This PR solves this issue by making state restore lazy (only happens if the user wants to access the value of the state)&lt;/p&gt;

&lt;p&gt;    The current order of events and the problem:&lt;br/&gt;
     1. Create StreamTask&lt;br/&gt;
     2. Call restoreInitialState(snapshot) -&amp;gt; default java-serialization StateCheckpointer is used&lt;br/&gt;
     2. Open UDF and run computation. -&amp;gt; This is the point when custom StateCheckpointers are set&lt;br/&gt;
     2. Take snapshots....&lt;br/&gt;
    We can see while the custom StateCheckpointers are available and work for taking snapshots they are not set set yet when call restore which obviously leads to error.&lt;/p&gt;

&lt;p&gt;    The change is:&lt;br/&gt;
     1. Create StreamTask&lt;br/&gt;
     2. Call restoreInitialState(snapshot) -&amp;gt; state is not restored yet, but a flag is set&lt;br/&gt;
     3. Open UDF and run computation. -&amp;gt; This is the point when custom StateCheckpointers are set&lt;br/&gt;
     4. The state is restored when the user accesses the value&lt;br/&gt;
     5. Take snapshots... (just return the last checkpoint if not restored yet)&lt;/p&gt;

&lt;p&gt;    The PR also extends the StreamCheckpointingITCase and the PartitionedStateCheckpointingITCase to include a case for custom StateCheckpointers for both local and partitioned OperatorStates.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/gyfora/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/gyfora/flink&lt;/a&gt; lazyrestore&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1154.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1154.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1154&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d1e590cbfcf9296a90aa846fd6dc49d9c7a0f077&lt;br/&gt;
Author: Gyula Fora &amp;lt;gyfora@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-09-21T10:07:47Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2713&quot; title=&quot;Custom StateCheckpointers should be included in the snapshots&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2713&quot;&gt;&lt;del&gt;FLINK-2713&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Set state restore to lazy to avoid StateCheckpointer issues and reduce checkpoint overhead&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14900480" author="githubbot" created="Mon, 21 Sep 2015 10:24:38 +0000"  >&lt;p&gt;Github user gyfora commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1150#issuecomment-141934393&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1150#issuecomment-141934393&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I opened another PR with the lazy restore, which seems to work much better &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1154&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14900481" author="githubbot" created="Mon, 21 Sep 2015 10:24:38 +0000"  >&lt;p&gt;Github user gyfora closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1150&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1150&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14900482" author="githubbot" created="Mon, 21 Sep 2015 10:26:49 +0000"  >&lt;p&gt;Github user senorcarbone commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1154#issuecomment-141934683&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1154#issuecomment-141934683&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    That&apos;s much better ^^&lt;br/&gt;
    I approve :+1: &lt;/p&gt;</comment>
                            <comment id="14901098" author="githubbot" created="Mon, 21 Sep 2015 18:03:02 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1154&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2l5rj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>