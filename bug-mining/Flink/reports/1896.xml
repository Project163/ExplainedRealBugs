<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:29:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7268] Zookeeper Checkpoint Store interacting with Incremental State Handles can lead to loss of handles</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7268</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Release testing for Flink 1.3.2 has shown that this combination of features leads to this errors when using a very low restart delay:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalStateException: Could not initialize keyed state backend.
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initKeyedState(AbstractStreamOperator.java:321)
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:217)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.initializeOperators(StreamTask.java:676)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.initializeState(StreamTask.java:663)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:252)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:702)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.io.FileNotFoundException: Item not found: aljoscha/state-machine-checkpoints-2/f26e2b4c6891f2a9e0c5e4ba014733c3/chk-3/b246db8c-4f25-483a-b1fc-234f4319004d
	at com.google.cloud.hadoop.gcsio.GoogleCloudStorageExceptions.getFileNotFoundException(GoogleCloudStorageExceptions.java:42)
	at com.google.cloud.hadoop.gcsio.GoogleCloudStorageImpl.open(GoogleCloudStorageImpl.java:551)
	at com.google.cloud.hadoop.gcsio.GoogleCloudStorageFileSystem.open(GoogleCloudStorageFileSystem.java:322)
	at com.google.cloud.hadoop.fs.gcs.GoogleHadoopFSInputStream.&amp;lt;init&amp;gt;(GoogleHadoopFSInputStream.java:121)
	at com.google.cloud.hadoop.fs.gcs.GoogleHadoopFileSystemBase.open(GoogleHadoopFileSystemBase.java:1076)
	at org.apache.hadoop.fs.FileSystem.open(FileSystem.java:767)
	at org.apache.flink.runtime.fs.hdfs.HadoopFileSystem.open(HadoopFileSystem.java:404)
	at org.apache.flink.runtime.fs.hdfs.HadoopFileSystem.open(HadoopFileSystem.java:48)
	at org.apache.flink.core.fs.SafetyNetWrapperFileSystem.open(SafetyNetWrapperFileSystem.java:85)
	at org.apache.flink.runtime.state.filesystem.FileStateHandle.openInputStream(FileStateHandle.java:69)
	at org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend$RocksDBIncrementalRestoreOperation.readStateData(RocksDBKeyedStateBackend.java:1281)
	at org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend$RocksDBIncrementalRestoreOperation.readAllStateData(RocksDBKeyedStateBackend.java:1468)
	at org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend$RocksDBIncrementalRestoreOperation.restoreInstance(RocksDBKeyedStateBackend.java:1324)
	at org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend$RocksDBIncrementalRestoreOperation.restore(RocksDBKeyedStateBackend.java:1503)
	at org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend.restore(RocksDBKeyedStateBackend.java:970)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.createKeyedStateBackend(StreamTask.java:772)
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initKeyedState(AbstractStreamOperator.java:311)
	... 6 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When this occurs the job is stuck in a restart loop. The problem (according to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt;) seems to be that removal of pending checkpoints from Zookeeper happens asynchronously and those request can go though when the Job has already restarted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13090141">FLINK-7268</key>
            <summary>Zookeeper Checkpoint Store interacting with Incremental State Handles can lead to loss of handles</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="aljoscha">Aljoscha Krettek</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Jul 2017 08:55:20 +0000</created>
                <updated>Wed, 23 Aug 2017 02:55:09 +0000</updated>
                            <resolved>Tue, 15 Aug 2017 13:04:43 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>1.3.1</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.3.2</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16101367" author="aljoscha" created="Wed, 26 Jul 2017 08:56:18 +0000"  >&lt;p&gt;Attaching full logs from a failed run.&lt;/p&gt;</comment>
                            <comment id="16103363" author="githubbot" created="Thu, 27 Jul 2017 15:40:55 +0000"  >&lt;p&gt;GitHub user StefanRRichter opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4410&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4410&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7268&quot; title=&quot;Zookeeper Checkpoint Store interacting with Incremental State Handles can lead to loss of handles&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7268&quot;&gt;&lt;del&gt;FLINK-7268&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;checkpoints&amp;#93;&lt;/span&gt; Scope SharedStateRegistry objects per (re)start&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7268&quot; title=&quot;Zookeeper Checkpoint Store interacting with Incremental State Handles can lead to loss of handles&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7268&quot;&gt;&lt;del&gt;FLINK-7268&lt;/del&gt;&lt;/a&gt;. The problem was that `ZookeeperCompletedCheckpointStore` deletes checkpoints asynchronously. When this happens parallel to a restart, it could happen that the async delete performed shared state de-registration.&lt;/p&gt;

&lt;p&gt;    Before this PR, the old `SharedStateRegistry` was kept after restart and the counts where updated from the completed checkpoint store. In the described race, a checkpoint that has a pending delete will not contribute to the new count, but it can still decrement the count once the shared state is unregistered in the async deletion thread. This can accidentally drop counts below 1 and lead to data loss.&lt;/p&gt;

&lt;p&gt;    The core idea behind the PR is to scope the `SharedStateRegistry` per (re-)start, so that old pending deletes cannot influence the current count.&lt;/p&gt;

&lt;p&gt;    `SharedStateRegistry` is now created via a factory that is passed into the `CheckpointCoordinator` to simplify testing.&lt;/p&gt;

&lt;p&gt;    The PR also introduces additional tests and improves the debug/trace logging of incremental checkpointing.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change added tests and can be verified as follows:&lt;/p&gt;

&lt;p&gt;    Run a job with keyed state, using incremental checkpoints and HA mode. Kill TMs to trigger recovery. After a couple of attemts, the problematic condition should be triggered, leading to an infinite recovery loop due to `FileNotFoundException`.&lt;/p&gt;

&lt;p&gt;    Additional tests:&lt;/p&gt;

&lt;p&gt;    `HAIncrementalRocksDbBackendEventTimeWindowCheckpointingITCase`&lt;br/&gt;
    `CheckpointCoordinatortest::testSharedStateRegistrationOnRestore``&lt;br/&gt;
    `IncrementalKeyedStateHandleTest::testSharedStateReRegistration`&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (YES)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StefanRRichter/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StefanRRichter/flink&lt;/a&gt; ImprovedIncreemntalCPDebug&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4410.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4410.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4410&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2ed4f6b28c2fda674f1319f2a3678b2a231988ac&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-06-26T16:07:59Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7213&quot; title=&quot;Introduce state management by OperatorID in TaskManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7213&quot;&gt;&lt;del&gt;FLINK-7213&lt;/del&gt;&lt;/a&gt; Introduce state management by OperatorID in TaskManager&lt;/p&gt;

&lt;p&gt;commit a50eda8602d2034753b42413d23842a888e73611&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-07-11T15:10:03Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7213&quot; title=&quot;Introduce state management by OperatorID in TaskManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7213&quot;&gt;&lt;del&gt;FLINK-7213&lt;/del&gt;&lt;/a&gt; Introduce TaskStateSnapshot to unify TaskStateHandles and SubtaskState&lt;/p&gt;

&lt;p&gt;commit bce928fcfec73ff7584840ae7eb6b31fb727604f&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-07-25T10:14:03Z&lt;/p&gt;

&lt;p&gt;    review comments zentol&lt;/p&gt;

&lt;p&gt;commit 363f0ee18e06affe95c30095ed229ca8dfd47801&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-07-26T11:31:30Z&lt;/p&gt;

&lt;p&gt;    review comments zentol part 2&lt;/p&gt;

&lt;p&gt;commit 98e657ea02c17d972391dd2360c287a00f27231e&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-07-26T11:31:47Z&lt;/p&gt;

&lt;p&gt;    review comments zentol part 2&lt;/p&gt;

&lt;p&gt;commit 4460d3412f3ffc2e5496b65949751a31dae8a01a&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-07-25T10:04:16Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7268&quot; title=&quot;Zookeeper Checkpoint Store interacting with Incremental State Handles can lead to loss of handles&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7268&quot;&gt;&lt;del&gt;FLINK-7268&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;checkpoints&amp;#93;&lt;/span&gt; Scope SharedStateRegistry objects per (re)start&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16103364" author="githubbot" created="Thu, 27 Jul 2017 15:41:35 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4410&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4410&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    CC @aljoscha &lt;/p&gt;</comment>
                            <comment id="16104963" author="githubbot" created="Fri, 28 Jul 2017 13:39:06 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4410&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4410&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I also reviewed `CheckpointCoordinatorTest.testSharedStateRegistrationOnRestore()`. Looks good &#128077; The rest is the same as in #4410 so let&apos;s wait until #4353 is merged and then we can merge this one as well.&lt;/p&gt;</comment>
                            <comment id="16127177" author="githubbot" created="Tue, 15 Aug 2017 12:58:10 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4410&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4410&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16127189" author="srichter" created="Tue, 15 Aug 2017 13:04:43 +0000"  >&lt;p&gt;Merged in 91a4b27617 (1.4) and 09caa9ffdc (1.3)&lt;/p&gt;</comment>
                            <comment id="16137806" author="githubbot" created="Wed, 23 Aug 2017 02:55:09 +0000"  >&lt;p&gt;Github user tedyu commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4410#discussion_r134647310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4410#discussion_r134647310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java &amp;#8212;&lt;br/&gt;
    @@ -1044,10 +1049,23 @@ public boolean restoreLatestCheckpointedState(&lt;br/&gt;
     				throw new IllegalStateException(&quot;CheckpointCoordinator is shut down&quot;);&lt;br/&gt;
     			}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Recover the checkpoints&lt;/li&gt;
	&lt;li&gt;completedCheckpointStore.recover(sharedStateRegistry);&lt;br/&gt;
    +			// We create a new shared state registry object, so that all pending async disposal requests from previous&lt;br/&gt;
    +			// runs will go against the old object (were they can do no harm).&lt;br/&gt;
    +			// This must happen under the checkpoint lock.&lt;br/&gt;
    +			sharedStateRegistry.close();&lt;br/&gt;
    +			sharedStateRegistry = sharedStateRegistryFactory.create(executor);&lt;br/&gt;
    +&lt;br/&gt;
    +			// Recover the checkpoints, TODO this could be done only when there is a new leader, not on each recovery
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    If we use highAvailabilityServices.getJobManagerLeaderRetriever(), Job Id is required.&lt;br/&gt;
    Can Job Id be obtained from JobVertexID ?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12878960" name="gce_rocks_incr_external_gs-more-logs.txt" size="2767244" author="aljoscha" created="Wed, 26 Jul 2017 08:56:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3i0xr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>