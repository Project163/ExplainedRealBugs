<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:56:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21990] SourceStreamTask will always hang if the CheckpointedFunction#snapshotState throws an exception.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21990</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;If the source in &lt;tt&gt;SourceStreamTask&lt;/tt&gt; implements &lt;tt&gt;CheckpointedFunction&lt;/tt&gt; and an exception is thrown in the snapshotState method, then the &lt;tt&gt;SourceStreamTask&lt;/tt&gt; will always hang.&lt;/p&gt;

&lt;p&gt;The main reason is that the checkpoint is executed in the mailbox. When the &lt;tt&gt;CheckpointedFunction#snapshotState&lt;/tt&gt;&#160; of the source throws an exception, the StreamTask#cleanUpInvoke will be called, where it will wait for the end of the &lt;tt&gt;LegacySourceFunctionThread&lt;/tt&gt; of the source. However, the source thread does not end by itself (this requires the user to control it), the &lt;tt&gt;Task&lt;/tt&gt; will hang at this time, and the JobMaster has no perception of this behavior.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void cleanUpInvoke() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    getCompletionFuture().exceptionally(unused -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;).join(); &lt;span class=&quot;code-comment&quot;&gt;//wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the end of the source
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// clean up everything we initialized
&lt;/span&gt;    isRunning = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    ...
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think we should call the cancel method of the source first, and then wait for the end.&lt;/p&gt;

&lt;p&gt;The following is my test code, the test branch is Flink&apos;s master branch.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testSourceFailure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
    env.enableCheckpointing(2000L);
    env.setRestartStrategy(RestartStrategies.noRestart());
    env.addSource(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FailedSource()).addSink(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DiscardingSink&amp;lt;&amp;gt;());
    JobGraph jobGraph = StreamingJobGraphGenerator.createJobGraph(env.getStreamGraph());
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; that the job only execute checkpoint once and only failed once.
&lt;/span&gt;        TestUtils.submitJobAndWaitForResult(
                cluster.getClusterClient(), jobGraph, getClass().getClassLoader());
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (JobExecutionException jobException) {
        Optional&amp;lt;FlinkRuntimeException&amp;gt; throwable =
                ExceptionUtils.findThrowable(jobException, FlinkRuntimeException.class);
        Assert.assertTrue(throwable.isPresent());
        Assert.assertEquals(
                CheckpointFailureManager.EXCEEDED_CHECKPOINT_TOLERABLE_FAILURE_MESSAGE,
                throwable.get().getMessage());
    }
    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; that the job only failed once.
&lt;/span&gt;    Assert.assertEquals(1, StringGeneratingSourceFunction.INITIALIZE_TIMES.get());
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;FailedSource &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; RichParallelSourceFunction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;
        &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; CheckpointedFunction {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; running;

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void open(Configuration parameters) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        running = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run(SourceContext&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; ctx) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (running) {
            ctx.collect(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);
        }
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void cancel() {
        running = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void snapshotState(FunctionSnapshotContext context) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;source failed&quot;&lt;/span&gt;);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void initializeState(FunctionInitializationContext context) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13367813">FLINK-21990</key>
            <summary>SourceStreamTask will always hang if the CheckpointedFunction#snapshotState throws an exception.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akalashnikov">Anton Kalashnikov</assignee>
                                    <reporter username="Ming Li">Ming Li</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 26 Mar 2021 09:26:03 +0000</created>
                <updated>Sat, 28 Aug 2021 11:14:33 +0000</updated>
                            <resolved>Fri, 16 Apr 2021 06:22:00 +0000</resolved>
                                    <version>1.11.0</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17310341" author="wind_ljy" created="Mon, 29 Mar 2021 02:57:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; We&apos;ve encountered the problem when upgrading Flink version from 1.9 to 1.11. This seems to be a very serious problem and can be reproduced with the test case above. Could you spare some time and take a look? &lt;/p&gt;</comment>
                            <comment id="17310372" author="kezhuw" created="Mon, 29 Mar 2021 03:52:44 +0000"  >&lt;p&gt;Ideally, this should be fixed in &lt;a href=&quot;https://github.com/apache/flink/blob/release-1.12.2/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SourceStreamTask.java#L175&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1.12.2&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SourceStreamTask.java#L181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;master&lt;/a&gt;. But I do run to hang in test case(modified version). Either that run does not touch blocking operations or interruption state was eaten up somewhere(&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21186&quot; title=&quot;RecordWriterOutput swallows interrupt state when interrupted.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21186&quot;&gt;&lt;del&gt;FLINK-21186&lt;/del&gt;&lt;/a&gt; ?) I think that fix worth a test to gain confidence on this.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AHeise&quot; class=&quot;user-hover&quot; rel=&quot;AHeise&quot;&gt;AHeise&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17310387" author="kezhuw" created="Mon, 29 Mar 2021 04:06:04 +0000"  >&lt;p&gt;A &lt;tt&gt;disableChaining&lt;/tt&gt; in between failed source and downstream sink passes the test case. But still hang for a while before run into blocking operations. Seems that simple &lt;tt&gt;Thread.interrupt&lt;/tt&gt; is not that enough, a cooperative &lt;tt&gt;SourceFunction.cancel&lt;/tt&gt;&#160;should help.&lt;/p&gt;</comment>
                            <comment id="17322645" author="roman_khachatryan" created="Fri, 16 Apr 2021 06:22:00 +0000"  >&lt;p&gt;Merged into master 345bf34b858d3c9014559dfab5a4e0dea5b0832d.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0p8c8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>