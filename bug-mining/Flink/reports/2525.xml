<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9703] Mesos does not expose TM Prometheus port</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9703</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;LaunchableMesosWorker makes Mesos expose&#160;these ports for&#160;a Task Manager:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;private static final String[] TM_PORT_KEYS = {&lt;/tt&gt;&lt;br/&gt;
{{ &quot;taskmanager.rpc.port&quot;,}}&lt;br/&gt;
{{ &quot;taskmanager.data.port&quot;};}}&lt;/p&gt;

&lt;p&gt;But when running Prometheus Exporter on a TM, another port needs to be exposed to make&#160;Flink&apos;s&#160;Prometheos endpoint externally scrapable by the Prometheus server. By default this is port 9249, but&#160;it is configurable according to:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-release-1.6/monitoring/metrics.html#prometheus-orgapacheflinkmetricsprometheusprometheusreporter&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-release-1.6/monitoring/metrics.html#prometheus-orgapacheflinkmetricsprometheusprometheusreporter&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;My plan is to make a PR, that just adds another config option for mesos, to enable custom ports&#160;to be exposed in the provisioned TMs.&lt;/p&gt;



&lt;p&gt;I considered carrying parts of the Metrics config into the Mesos code to automatically&#160;map&#160;metrics ports in mesos.&#160;But making such a &quot;shortcut&quot; between&#160;Flink&apos;s metrics and mesos modules would&#160;probably need some sort of integration testing, so I prefer the simple&#160;solution of just adding another Mesos config option.&#160;But comments are welcome.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13169517">FLINK-9703</key>
            <summary>Mesos does not expose TM Prometheus port</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="runeskoularsen">Rune Skou Larsen</assignee>
                                    <reporter username="runeskoularsen">Rune Skou Larsen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 2 Jul 2018 11:36:00 +0000</created>
                <updated>Sat, 20 Oct 2018 07:14:27 +0000</updated>
                            <resolved>Fri, 13 Jul 2018 12:40:09 +0000</resolved>
                                                    <fixVersion>1.6.0</fixVersion>
                                    <component>Deployment / Mesos</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16536859" author="githubbot" created="Mon, 9 Jul 2018 12:25:29 +0000"  >&lt;p&gt;GitHub user rsltrifork opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9703&quot; title=&quot;Mesos does not expose TM Prometheus port&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9703&quot;&gt;&lt;del&gt;FLINK-9703&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;flink-mesos&amp;#93;&lt;/span&gt; Expose Prometheus port for TM through Mesos&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    To enable Task Managers, when set up by mesos, to expose a port for Prometheus monitoring.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If &quot;metrics.reporter.prom.port&apos; is configured, make sure mesos assigns a port for it.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    &lt;b&gt;(Please pick either of the following options)&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;    This change is already covered by existing tests, such as &lt;b&gt;(please describe tests)&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;    &lt;b&gt;(or)&lt;/b&gt;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: yes&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/Safetrack/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Safetrack/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9703&quot; title=&quot;Mesos does not expose TM Prometheus port&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9703&quot;&gt;&lt;del&gt;FLINK-9703&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6288&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ca55557651ca9164d3611d2dfc3f1ce934a6f9ae&lt;br/&gt;
Author: Rune Skou Larsen &amp;lt;rsl@...&amp;gt;&lt;br/&gt;
Date:   2018-07-09T11:54:51Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9703&quot; title=&quot;Mesos does not expose TM Prometheus port&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9703&quot;&gt;&lt;del&gt;FLINK-9703&lt;/del&gt;&lt;/a&gt; Expose Prometheus port for TM through Mesos&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16536872" author="githubbot" created="Mon, 9 Jul 2018 12:44:04 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This doesn&apos;t really work; the configured name for the reporter (&#236;n this case `prom`) is arbitrary and can be chosen by the user. As such this approach will fail the moment users choose a different name. &lt;/p&gt;

&lt;p&gt;    It would also be good if we could figure out a more general solution to the problem, as this will affect other components now/in the future.&lt;/p&gt;</comment>
                            <comment id="16536875" author="githubbot" created="Mon, 9 Jul 2018 12:45:05 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r200987982&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r200987982&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java &amp;#8212;&lt;br/&gt;
    @@ -85,11 +85,11 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param taskID the taskID for this worker.&lt;br/&gt;
     	 */&lt;br/&gt;
     	public LaunchableMesosWorker(&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;MesosArtifactResolver resolver,&lt;/li&gt;
	&lt;li&gt;MesosTaskManagerParameters params,&lt;/li&gt;
	&lt;li&gt;ContainerSpecification containerSpec,&lt;/li&gt;
	&lt;li&gt;Protos.TaskID taskID,&lt;/li&gt;
	&lt;li&gt;MesosConfiguration mesosConfiguration) {&lt;br/&gt;
    +		MesosArtifactResolver resolver,&lt;br/&gt;
    +		MesosTaskManagerParameters params,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    please try to avoid formatting changes.&lt;/p&gt;</comment>
                            <comment id="16538193" author="githubbot" created="Tue, 10 Jul 2018 07:38:57 +0000"  >&lt;p&gt;Github user rsltrifork commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you for the review, zentol. I&apos;ve made a more generic solution now for exposing TM ports through Mesos - please have a look again.&lt;/p&gt;</comment>
                            <comment id="16538529" author="githubbot" created="Tue, 10 Jul 2018 12:58:42 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r201331084&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r201331084&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java &amp;#8212;&lt;br/&gt;
    @@ -332,6 +334,22 @@ public String toString() &lt;/p&gt;
{
     		return taskInfo.build();
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Get port keys representing the TM&apos;s configured endpoints. This includes mandatory TM endpoints such as&lt;br/&gt;
    +	 * data and rpc as well as optionally configured endpoints for services such as prometheus reporter&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A deterministicly ordered Set of port keys to expose from the TM container&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private Set&amp;lt;String&amp;gt; getPortKeys() {&lt;br/&gt;
    +		LinkedHashSet&amp;lt;String&amp;gt; tmPortKeys = new LinkedHashSet&amp;lt;&amp;gt;(Arrays.asList(TM_PORT_KEYS));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Is this allowed to contain port ranges?&lt;/p&gt;</comment>
                            <comment id="16538530" author="githubbot" created="Tue, 10 Jul 2018 13:00:03 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r201331518&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r201331518&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java &amp;#8212;&lt;br/&gt;
    @@ -332,6 +334,22 @@ public String toString() &lt;/p&gt;
{
     		return taskInfo.build();
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Get port keys representing the TM&apos;s configured endpoints. This includes mandatory TM endpoints such as&lt;br/&gt;
    +	 * data and rpc as well as optionally configured endpoints for services such as prometheus reporter&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A deterministicly ordered Set of port keys to expose from the TM container&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private Set&amp;lt;String&amp;gt; getPortKeys() {&lt;br/&gt;
    +		LinkedHashSet&amp;lt;String&amp;gt; tmPortKeys = new LinkedHashSet&amp;lt;&amp;gt;(Arrays.asList(TM_PORT_KEYS));&lt;br/&gt;
    +		containerSpec.getDynamicConfiguration().keySet().stream()&lt;br/&gt;
    +			.filter(key -&amp;gt; key.endsWith(&quot;.port&quot;))  // This matches property naming convention&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    there are at least 2 instances where the key ends with &quot;port*&lt;b&gt;s&lt;/b&gt;*&quot;.&lt;br/&gt;
    &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-master/ops/config.html#query-proxy-ports&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-master/ops/config.html#query-proxy-ports&lt;/a&gt;&lt;br/&gt;
    &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-master/ops/config.html#query-server-ports&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-master/ops/config.html#query-server-ports&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16539889" author="githubbot" created="Wed, 11 Jul 2018 10:47:44 +0000"  >&lt;p&gt;Github user rsltrifork commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r201645393&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r201645393&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java &amp;#8212;&lt;br/&gt;
    @@ -332,6 +334,22 @@ public String toString() &lt;/p&gt;
{
     		return taskInfo.build();
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Get port keys representing the TM&apos;s configured endpoints. This includes mandatory TM endpoints such as&lt;br/&gt;
    +	 * data and rpc as well as optionally configured endpoints for services such as prometheus reporter&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A deterministicly ordered Set of port keys to expose from the TM container&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private Set&amp;lt;String&amp;gt; getPortKeys() {&lt;br/&gt;
    +		LinkedHashSet&amp;lt;String&amp;gt; tmPortKeys = new LinkedHashSet&amp;lt;&amp;gt;(Arrays.asList(TM_PORT_KEYS));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes, ranges are allowed as value. In fact &lt;b&gt;anything&lt;/b&gt; is allowed as value, because the implementation does not look at which value is assigned to a port key. It always overrules your assigned port value and replaces it with a single port provided by Mesos.&lt;/p&gt;

&lt;p&gt;    My understanding is, that port ranges in the first place are only used for one purpose: To allow picking a single available port from within the range. For example when running multiple TMs on the same machine, where ports would otherwise clash. But this complexity is not needed when spawning TMs with Mesos, because Mesos will always choose and assign a port, which is guarenteed to be available. Therefore, it&apos;s safe to only request a single port for each configured portKey.&lt;/p&gt;</comment>
                            <comment id="16539945" author="githubbot" created="Wed, 11 Jul 2018 11:38:18 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r201657551&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r201657551&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java &amp;#8212;&lt;br/&gt;
    @@ -332,6 +334,22 @@ public String toString() &lt;/p&gt;
{
     		return taskInfo.build();
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Get port keys representing the TM&apos;s configured endpoints. This includes mandatory TM endpoints such as&lt;br/&gt;
    +	 * data and rpc as well as optionally configured endpoints for services such as prometheus reporter&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A deterministicly ordered Set of port keys to expose from the TM container&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private Set&amp;lt;String&amp;gt; getPortKeys() {&lt;br/&gt;
    +		LinkedHashSet&amp;lt;String&amp;gt; tmPortKeys = new LinkedHashSet&amp;lt;&amp;gt;(Arrays.asList(TM_PORT_KEYS));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    ah,I think i misunderstood earlier what the code does.&lt;/p&gt;

&lt;p&gt;    So what we &lt;em&gt;are&lt;/em&gt; doing is scanning the taskmanager config for port config options, gather the keys, and later these are overridden by mesos with some port?&lt;/p&gt;

&lt;p&gt;    If so, is there any way to restrict ports to certain ranges? For the taskmanager port this isn&apos;t important as for all intents and purposes it is only used internally anyway, but for reporters this port is very much user-facing.&lt;br/&gt;
    In case of the PrometheusReporter this would imply that prometheus is always started &lt;em&gt;after&lt;/em&gt; the TM, as we can&apos;t determine the port beforehand. Is that correct?&lt;/p&gt;</comment>
                            <comment id="16541286" author="githubbot" created="Thu, 12 Jul 2018 08:04:31 +0000"  >&lt;p&gt;Github user rsltrifork commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r201943310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r201943310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java &amp;#8212;&lt;br/&gt;
    @@ -332,6 +334,22 @@ public String toString() &lt;/p&gt;
{
     		return taskInfo.build();
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Get port keys representing the TM&apos;s configured endpoints. This includes mandatory TM endpoints such as&lt;br/&gt;
    +	 * data and rpc as well as optionally configured endpoints for services such as prometheus reporter&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A deterministicly ordered Set of port keys to expose from the TM container&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private Set&amp;lt;String&amp;gt; getPortKeys() {&lt;br/&gt;
    +		LinkedHashSet&amp;lt;String&amp;gt; tmPortKeys = new LinkedHashSet&amp;lt;&amp;gt;(Arrays.asList(TM_PORT_KEYS));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    &amp;gt; So what we are doing is scanning the taskmanager config for port config options, gather the keys, and later these are overridden by mesos with some port?&lt;/p&gt;

&lt;p&gt;    Yes.&lt;/p&gt;

&lt;p&gt;    &amp;gt; In case of the PrometheusReporter this would imply that prometheus is always started after &lt;br/&gt;
    &amp;gt; the TM, as we can&apos;t determine the port beforehand. Is that correct?&lt;/p&gt;

&lt;p&gt;    No. Prometheus supports dynamicly reloading it&apos;s scrape configuration. So the other part of the monitoring solution is our Prometheus script, which periodically querries mesos to maintain an up-to-date list of active TM prometheus ports to scrape from. We&apos;re working with Mesosphere to open source this Prometheus scripting in DC/OS, but before that makes sense, we need Flink to let Mesos assign the scrape port to the TM container - hence this PR, which I hope will be quickly merged.&lt;/p&gt;</comment>
                            <comment id="16541753" author="githubbot" created="Thu, 12 Jul 2018 14:46:24 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r202062001&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r202062001&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java &amp;#8212;&lt;br/&gt;
    @@ -332,6 +334,22 @@ public String toString() &lt;/p&gt;
{
     		return taskInfo.build();
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Get port keys representing the TM&apos;s configured endpoints. This includes mandatory TM endpoints such as&lt;br/&gt;
    +	 * data and rpc as well as optionally configured endpoints for services such as prometheus reporter&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A deterministicly ordered Set of port keys to expose from the TM container&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private Set&amp;lt;String&amp;gt; getPortKeys() {&lt;br/&gt;
    +		LinkedHashSet&amp;lt;String&amp;gt; tmPortKeys = new LinkedHashSet&amp;lt;&amp;gt;(Arrays.asList(TM_PORT_KEYS));&lt;br/&gt;
    +		containerSpec.getDynamicConfiguration().keySet().stream()&lt;br/&gt;
    +			.filter(key -&amp;gt; key.endsWith(&quot;.port&quot;) || key.endsWith(&quot;.ports&quot;))  // This matches property naming convention&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You have to check the configured value as well, I know of at least one case where negative ports are used to disable features (and we wouldn&apos;t want enable these again).&lt;br/&gt;
    Are there any use-cases where one might &lt;em&gt;not&lt;/em&gt; want mesos to provide the port?&lt;/p&gt;</comment>
                            <comment id="16542188" author="githubbot" created="Thu, 12 Jul 2018 20:41:41 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r202171601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r202171601&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java &amp;#8212;&lt;br/&gt;
    @@ -332,6 +334,22 @@ public String toString() &lt;/p&gt;
{
     		return taskInfo.build();
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Get port keys representing the TM&apos;s configured endpoints. This includes mandatory TM endpoints such as&lt;br/&gt;
    +	 * data and rpc as well as optionally configured endpoints for services such as prometheus reporter&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A deterministicly ordered Set of port keys to expose from the TM container&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private Set&amp;lt;String&amp;gt; getPortKeys() {&lt;br/&gt;
    +		LinkedHashSet&amp;lt;String&amp;gt; tmPortKeys = new LinkedHashSet&amp;lt;&amp;gt;(Arrays.asList(TM_PORT_KEYS));&lt;br/&gt;
    +		containerSpec.getDynamicConfiguration().keySet().stream()&lt;br/&gt;
    +			.filter(key -&amp;gt; key.endsWith(&quot;.port&quot;) || key.endsWith(&quot;.ports&quot;))  // This matches property naming convention&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I agree that simply taking all configuration values which end with `port` and `ports` is problematic. What about configuration values whose value is needed, e.g. remote ports, and should not be overwritten. For example the `jobmanager.rpc.port` is one of these configuration values.&lt;/p&gt;

&lt;p&gt;    I would rather prefer a mesos specific configuration value which we can use to define whose ports need to be dynamically assigned. For example `mesos.dynamic-port-assignment: &quot;metrics.prom.port, taskmanager.rpc.port, taskmanager.data.port&quot;`. What do you think?&lt;/p&gt;</comment>
                            <comment id="16542997" author="till.rohrmann" created="Fri, 13 Jul 2018 12:40:09 +0000"  >&lt;p&gt;Fixed via b74594c488e4c5428c5391b89c32ae6fd7d98a79&lt;/p&gt;</comment>
                            <comment id="16543004" author="githubbot" created="Fri, 13 Jul 2018 12:41:26 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16655055" author="githubbot" created="Thu, 18 Oct 2018 11:05:53 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6288: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9703&quot; title=&quot;Mesos does not expose TM Prometheus port&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9703&quot;&gt;&lt;del&gt;FLINK-9703&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;flink-mesos&amp;#93;&lt;/span&gt; Expose Prometheus port for TM through Mesos&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r226262274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r226262274&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -332,6 +334,27 @@ public String toString() &lt;/p&gt;
{
 		return taskInfo.build();
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Get the port keys representing the TM&apos;s configured endpoints. This includes mandatory TM endpoints such as&lt;br/&gt;
+	 * data and rpc as well as optionally configured endpoints for services such as prometheus reporter&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @return A deterministicly ordered Set of port keys to expose from the TM container&lt;br/&gt;
+	 * @param config&lt;br/&gt;
+	 */&lt;br/&gt;
+	static Set&amp;lt;String&amp;gt; extractPortKeys(Configuration config) {&lt;br/&gt;
+		LinkedHashSet&amp;lt;String&amp;gt; tmPortKeys = new LinkedHashSet&amp;lt;&amp;gt;(Arrays.asList(TM_PORT_KEYS));&lt;br/&gt;
+&lt;br/&gt;
+		if (config.containsKey(PORT_ASSIGNMENT_KEY)) {&lt;br/&gt;
+			String portAssignments = config.getString(PORT_ASSIGNMENT_KEY, &quot;&quot;);&lt;br/&gt;
+			Arrays.stream(portAssignments.split(&quot;,&quot;))&lt;br/&gt;
+				.map(String::trim)&lt;br/&gt;
+				.peek(key -&amp;gt; LOG.debug(&quot;Adding port key &quot; + key + &quot; to mesos request&quot;))&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Slf4j place holder should be preferred to avoid String concatenation, i.e., `LOG.debug(&quot;Adding port key {} to mesos request&quot;, key)`&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16655056" author="githubbot" created="Thu, 18 Oct 2018 11:06:04 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6288: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9703&quot; title=&quot;Mesos does not expose TM Prometheus port&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9703&quot;&gt;&lt;del&gt;FLINK-9703&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;flink-mesos&amp;#93;&lt;/span&gt; Expose Prometheus port for TM through Mesos&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r226262274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r226262274&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -332,6 +334,27 @@ public String toString() &lt;/p&gt;
{
 		return taskInfo.build();
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Get the port keys representing the TM&apos;s configured endpoints. This includes mandatory TM endpoints such as&lt;br/&gt;
+	 * data and rpc as well as optionally configured endpoints for services such as prometheus reporter&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @return A deterministicly ordered Set of port keys to expose from the TM container&lt;br/&gt;
+	 * @param config&lt;br/&gt;
+	 */&lt;br/&gt;
+	static Set&amp;lt;String&amp;gt; extractPortKeys(Configuration config) {&lt;br/&gt;
+		LinkedHashSet&amp;lt;String&amp;gt; tmPortKeys = new LinkedHashSet&amp;lt;&amp;gt;(Arrays.asList(TM_PORT_KEYS));&lt;br/&gt;
+&lt;br/&gt;
+		if (config.containsKey(PORT_ASSIGNMENT_KEY)) {&lt;br/&gt;
+			String portAssignments = config.getString(PORT_ASSIGNMENT_KEY, &quot;&quot;);&lt;br/&gt;
+			Arrays.stream(portAssignments.split(&quot;,&quot;))&lt;br/&gt;
+				.map(String::trim)&lt;br/&gt;
+				.peek(key -&amp;gt; LOG.debug(&quot;Adding port key &quot; + key + &quot; to mesos request&quot;))&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Slf4j placeholders should be preferred to avoid String concatenation, i.e., `LOG.debug(&quot;Adding port key {} to mesos request&quot;, key)`&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16657772" author="githubbot" created="Sat, 20 Oct 2018 07:14:27 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6288: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9703&quot; title=&quot;Mesos does not expose TM Prometheus port&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9703&quot;&gt;&lt;del&gt;FLINK-9703&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;flink-mesos&amp;#93;&lt;/span&gt; Expose Prometheus port for TM through Mesos&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6288#discussion_r226262274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6288#discussion_r226262274&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/LaunchableMesosWorker.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -332,6 +334,27 @@ public String toString() &lt;/p&gt;
{
 		return taskInfo.build();
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Get the port keys representing the TM&apos;s configured endpoints. This includes mandatory TM endpoints such as&lt;br/&gt;
+	 * data and rpc as well as optionally configured endpoints for services such as prometheus reporter&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @return A deterministicly ordered Set of port keys to expose from the TM container&lt;br/&gt;
+	 * @param config&lt;br/&gt;
+	 */&lt;br/&gt;
+	static Set&amp;lt;String&amp;gt; extractPortKeys(Configuration config) {&lt;br/&gt;
+		LinkedHashSet&amp;lt;String&amp;gt; tmPortKeys = new LinkedHashSet&amp;lt;&amp;gt;(Arrays.asList(TM_PORT_KEYS));&lt;br/&gt;
+&lt;br/&gt;
+		if (config.containsKey(PORT_ASSIGNMENT_KEY)) {&lt;br/&gt;
+			String portAssignments = config.getString(PORT_ASSIGNMENT_KEY, &quot;&quot;);&lt;br/&gt;
+			Arrays.stream(portAssignments.split(&quot;,&quot;))&lt;br/&gt;
+				.map(String::trim)&lt;br/&gt;
+				.peek(key -&amp;gt; LOG.debug(&quot;Adding port key &quot; + key + &quot; to mesos request&quot;))&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Slf4j placeholders should be preferred to avoid String concatenation, i.e., `LOG.debug(&quot;Adding port key {} to mesos request&quot;, key)`&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13179047">FLINK-10149</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 4 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vg47:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>