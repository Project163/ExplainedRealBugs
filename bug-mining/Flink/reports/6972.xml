<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:16:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-30513] HA storage dir leaks on cluster termination </title>
                <link>https://issues.apache.org/jira/browse/FLINK-30513</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Problem&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;We found that HA storage dir leaks on cluster termination for a Flink job with HA enabled. The following picture shows the HA storage dir (here on HDFS) of the cluster czh-flink-test-offline (of application mode) after canelling the job with flink-cancel. We are left with an empty dir, and too many empty dirs will greatly hurt the stability of HDFS NameNode!&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13054145/13054145_image-2022-12-27-21-32-17-510.png&quot; height=&quot;158&quot; width=&quot;582&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Furthermore, in case the user choose to retain the checkpoints on job termination, we will have the completedCheckpoints leaked as well. Note that we no longer need the completedCheckpoints files as we&apos;ll directly recover retained CPs from the CP data dir.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Root Cause&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;When we run AbstractHaServices#closeAndCleanupAllData(), we cleaned up blob store, but didn&apos;t clean the HA storage dir.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Proposal&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Clean up the HA storage dir after cleaning up blob store in AbstractHaServices#closeAndCleanupAllData().&lt;/p&gt;</description>
                <environment></environment>
        <key id="13515745">FLINK-30513</key>
            <summary>HA storage dir leaks on cluster termination </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="Zhanghao Chen">Zhanghao Chen</assignee>
                                    <reporter username="Zhanghao Chen">Zhanghao Chen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 27 Dec 2022 13:40:57 +0000</created>
                <updated>Tue, 29 Apr 2025 09:47:20 +0000</updated>
                                            <version>1.15.0</version>
                    <version>1.16.0</version>
                    <version>1.17.0</version>
                    <version>1.18.0</version>
                                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17652438" author="zhanghao chen" created="Wed, 28 Dec 2022 09:25:45 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wangyang0918&quot; class=&quot;user-hover&quot; rel=&quot;wangyang0918&quot;&gt;wangyang0918&lt;/a&gt;, looking forward to your opinions on it. Any feedback is much appreciated.&lt;/p&gt;</comment>
                            <comment id="17675967" author="fly_in_gis" created="Thu, 12 Jan 2023 11:55:16 +0000"  >&lt;p&gt;Given that the cluster-id is configured to k8s-app-ha-1-116, we will have following files in the HA storage directory. The completedCheckpoint and job graph files will be deleted once the job reached global terminal state(e.g. CANCELED, FAILED, FINISHED). So currently we only clean up the blob directory in the &lt;tt&gt;HighAvailabilityServices#closeAndCleanupAllData&lt;/tt&gt;. And then the parent directory will be residual.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It is not a serious problem when using cloud object storage(S3, OSS, etc.). However, it is critical for HDFS since leaked directories will consume too much memory of NameNode.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am +1 to delete the parent directory in &lt;tt&gt;HighAvailabilityServices#closeAndCleanupAllData.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
wangyang-pc:scripts danrtsey.wy$ ossutil ls oss:&lt;span class=&quot;code-comment&quot;&gt;//flink-test-yiqi/flink-ha/
&lt;/span&gt;LastModifiedTime &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Size(B) &#160;StorageClass &#160; ETAG &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ObjectName
2023-01-12 19:42:32 +0800 CST &#160; &#160; &#160; &#160; &#160; &#160;0 &#160; &#160; &#160;Standard &#160; D41D8CD98F00B204E9800998ECF8427E &#160; &#160; &#160;oss:&lt;span class=&quot;code-comment&quot;&gt;//flink-test-yiqi/flink-ha/job-result-store/k8s-app-ha-1-116/
&lt;/span&gt;2023-01-12 19:44:16 +0800 CST &#160; &#160; &#160; &#160; &#160; &#160;0 &#160; &#160; &#160;Standard &#160; D41D8CD98F00B204E9800998ECF8427E &#160; &#160; &#160;oss:&lt;span class=&quot;code-comment&quot;&gt;//flink-test-yiqi/flink-ha/k8s-app-ha-1-116/
&lt;/span&gt;2023-01-12 19:42:32 +0800 CST &#160; &#160; &#160; &#160; &#160; &#160;0 &#160; &#160; &#160;Standard &#160; D41D8CD98F00B204E9800998ECF8427E &#160; &#160; &#160;oss:&lt;span class=&quot;code-comment&quot;&gt;//flink-test-yiqi/flink-ha/k8s-app-ha-1-116/blob/
&lt;/span&gt;2023-01-12 19:42:44 +0800 CST &#160; &#160; &#160;5426525 &#160; &#160; &#160;Standard &#160; EF151FCD3D1F91C3EB512118F05D2E20 &#160; &#160; &#160;oss:&lt;span class=&quot;code-comment&quot;&gt;//flink-test-yiqi/flink-ha/k8s-app-ha-1-116/blob/job_ffffffffe07004590000000000000000/blob_p-a28c3727cd8d501e6b024187013e4311079499be-b327aba6b7fee1f6b0fb4fe66a88a637
&lt;/span&gt;2023-01-12 19:44:16 +0800 CST &#160; &#160; &#160; &#160;14288 &#160; &#160; &#160;Standard &#160; 0983C3E02FBC7A904207A12295A3AF28 &#160; &#160; &#160;oss:&lt;span class=&quot;code-comment&quot;&gt;//flink-test-yiqi/flink-ha/k8s-app-ha-1-116/completedCheckpoint4679f587e15a
&lt;/span&gt;2023-01-12 19:42:44 +0800 CST &#160; &#160; &#160; &#160;34080 &#160; &#160; &#160;Standard &#160; B37673CA07B30B8A0FC76939BBDFA9F7 &#160; &#160; &#160;oss:&lt;span class=&quot;code-comment&quot;&gt;//flink-test-yiqi/flink-ha/k8s-app-ha-1-116/submittedJobGraph427419c216b4 &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17676395" author="zhanghao chen" created="Fri, 13 Jan 2023 02:17:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wangyang0918&quot; class=&quot;user-hover&quot; rel=&quot;wangyang0918&quot;&gt;wangyang0918&lt;/a&gt; Could you assign this task to me? I can start preparing a PR for it. Thanks~&lt;/p&gt;</comment>
                            <comment id="17691123" author="zhanghao chen" created="Mon, 20 Feb 2023 10:22:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wangyang0918&quot; class=&quot;user-hover&quot; rel=&quot;wangyang0918&quot;&gt;wangyang0918&lt;/a&gt; Could you help review the PR when you are free? Much appreciated&lt;/p&gt;</comment>
                            <comment id="17698192" author="weijie guo" created="Thu, 9 Mar 2023 06:08:44 +0000"  >&lt;p&gt;master(1.18) via 13779ab8e4f5539ca311d9f233d031d818af6450.&lt;br/&gt;
revert via 593cc139ab30bb81ab38d94b7b697d00eaaecada as &lt;a href=&quot;https://github.com/apache/flink/pull/21673#discussion_r1130781417&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;comments in pull request&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17753832" author="flink-jira-bot" created="Sun, 13 Aug 2023 22:35:25 +0000"  >&lt;p&gt;I am the &lt;a href=&quot;https://github.com/apache/flink-jira-bot/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Flink Jira Bot&lt;/a&gt; and I help the community manage its development. I see this issue is assigned but has not received an update in 30 days, so it has been labeled &quot;stale-assigned&quot;.&lt;br/&gt;
If you are still working on the issue, please remove the label and add a comment updating the community on your progress.  If this issue is waiting on feedback, please consider this a reminder to the committer/reviewer. Flink is a very active project, and so we appreciate your patience.&lt;br/&gt;
If you are no longer working on the issue, please unassign yourself so someone else may work on it.&lt;/p&gt;</comment>
                            <comment id="17777251" author="JIRAUSER298666" created="Thu, 19 Oct 2023 12:42:29 +0000"  >&lt;p&gt;Also one question, in abnormal scenarios, such as when the task is running on Yarn and I kill it, both the directory and subdirectory blob will still exist. Perhaps the community does not consider abnormal scenarios, as we have previously added a hook to clear the appid directory under &apos;/user/hadoop/. flink&apos;, It includes jar packages uploaded by Flink when submitting tasks.&lt;br/&gt;
But this hook involves Hadoop and it also needs to be modified. In the hook code, hadoop needs to provide us with feedback about the status of the task. I think it may be due to the interaction between multiple communities, and the Flink community did not actively consider clearing in this abnormal situation? And here for &apos;high availability.storageDir&apos;, the situation is the same. &lt;/p&gt;

&lt;p&gt;How to clean up two directories: /user/hadoop/.flink/xxxappId &amp;amp;  &apos;high availability.storageDir&apos; when a task is killed? Whether the community will consider these in the future, and give any better suggestions&#65311;&lt;/p&gt;</comment>
                            <comment id="17948135" author="zhanghao chen" created="Tue, 29 Apr 2025 09:47:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xinchen147&quot; class=&quot;user-hover&quot; rel=&quot;xinchen147&quot;&gt;xinchen147&lt;/a&gt; We imlemented this feature in our internal Flink version to clean up the leaked high availability.storageDir on graceful job cancelling (/user/hadoop/.flink/xxxappId willl be cleaned already when using flink cancel/stop command), and found leakage still exist, as sometimes one just force kill the application via kill -9 (e.g. using the yarn application kill command) and the cleanup is not performed. We decided to implement a cleanup hook on our job management system which continuously monitors job status.&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13554353">FLINK-33288</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13054145" name="image-2022-12-27-21-32-17-510.png" size="123119" author="Zhanghao Chen" created="Tue, 27 Dec 2022 13:32:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            28 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1eekg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>