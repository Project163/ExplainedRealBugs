<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4905] Kafka test instability IllegalStateException: Client is not started</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4905</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The following travis build (&lt;a href=&quot;https://s3.amazonaws.com/archive.travis-ci.org/jobs/170365439/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://s3.amazonaws.com/archive.travis-ci.org/jobs/170365439/log.txt&lt;/a&gt;)  failed because of this error&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;08:17:11,239 INFO  org.apache.flink.runtime.jobmanager.JobManager                - Status of job 33ebdc0e7c91be186d80658ce3d17069 (Read some records to commit offsets to Kafka) changed to FAILING.
java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; confirming checkpoint
	at org.apache.flink.runtime.taskmanager.Task$4.run(Task.java:1040)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.IllegalStateException: Client is not started
	at org.apache.flink.shaded.com.google.common.base.Preconditions.checkState(Preconditions.java:173)
	at org.apache.curator.CuratorZookeeperClient.getZooKeeper(CuratorZookeeperClient.java:113)
	at org.apache.curator.utils.EnsurePath$InitialHelper$1.call(EnsurePath.java:148)
	at org.apache.curator.RetryLoop.callWithRetry(RetryLoop.java:107)
	at org.apache.curator.utils.EnsurePath$InitialHelper.ensure(EnsurePath.java:141)
	at org.apache.curator.utils.EnsurePath.ensure(EnsurePath.java:99)
	at org.apache.flink.streaming.connectors.kafka.internals.ZookeeperOffsetHandler.setOffsetInZooKeeper(ZookeeperOffsetHandler.java:133)
	at org.apache.flink.streaming.connectors.kafka.internals.ZookeeperOffsetHandler.prepareAndCommitOffsets(ZookeeperOffsetHandler.java:93)
	at org.apache.flink.streaming.connectors.kafka.internals.Kafka08Fetcher.commitInternalOffsetsToKafka(Kafka08Fetcher.java:341)
	at org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumerBase.notifyCheckpointComplete(FlinkKafkaConsumerBase.java:421)
	at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.notifyOfCompletedCheckpoint(AbstractUdfStreamOperator.java:229)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.notifyCheckpointComplete(StreamTask.java:571)
	at org.apache.flink.runtime.taskmanager.Task$4.run(Task.java:1035)
	... 5 more
08:17:11,241 INFO  org.apache.flink.runtime.taskmanager.Task                     - Attempting to cancel task Source: Custom Source -&amp;gt; Map -&amp;gt; Map -&amp;gt; Sink: Unnamed (1/3)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13015026">FLINK-4905</key>
            <summary>Kafka test instability IllegalStateException: Client is not started</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Andrew Efimov">Andrew Efimov</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                            <label>test-stability</label>
                    </labels>
                <created>Tue, 25 Oct 2016 09:52:16 +0000</created>
                <updated>Wed, 2 Oct 2019 17:43:30 +0000</updated>
                            <resolved>Wed, 25 Jan 2017 13:34:10 +0000</resolved>
                                                    <fixVersion>1.3.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15607498" author="tzulitai" created="Wed, 26 Oct 2016 05:34:59 +0000"  >&lt;p&gt;Had a quick look at this. The only place we&apos;re closing the curator client ourselves is in the &lt;tt&gt;finally&lt;/tt&gt; clause of the &lt;tt&gt;runFetchLoop&lt;/tt&gt; in the 0.8 Fetcher.&lt;br/&gt;
I&apos;m suspecting the cause is that &lt;tt&gt;notifyCheckpointComplete&lt;/tt&gt; was called before the fetch loop entered the finally clause and started the offset committing to ZK (&lt;tt&gt;prepareAndCommitOffsets() call&lt;/tt&gt;), but the curator client was closed mid-way once the fetch loop entered finally clause. A good fix perhaps would be to add a lock to synchronize &lt;tt&gt;close()&lt;/tt&gt; and &lt;tt&gt;prepareAndCommitOffsets()&lt;/tt&gt; / &lt;tt&gt;getCommittedOffsets&lt;/tt&gt; in the ZK offset handler to make sure we aren&apos;t called close mid way.&lt;/p&gt;

&lt;p&gt;From the test logs the &lt;tt&gt;testStartFromKafkaCommitOffsets&lt;/tt&gt; seems unrelated to this instability.&lt;/p&gt;</comment>
                            <comment id="15608006" author="rmetzger" created="Wed, 26 Oct 2016 09:45:27 +0000"  >&lt;p&gt;I&apos;m not 100% sure if this can happen, because &lt;tt&gt;close()&lt;/tt&gt; and &lt;tt&gt;notifyCheckpointComplete&lt;/tt&gt; are already synchronized.&lt;/p&gt;

&lt;p&gt;The lock for close is here: &lt;a href=&quot;https://github.com/apache/flink/blob/770f2f83a81b2810aff171b2f56390ef686f725a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L279&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/770f2f83a81b2810aff171b2f56390ef686f725a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L279&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;The lock for the notify is here: &lt;a href=&quot;https://github.com/apache/flink/blob/770f2f83a81b2810aff171b2f56390ef686f725a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L565&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/770f2f83a81b2810aff171b2f56390ef686f725a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L565&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15680307" author="andrew efimov" created="Sun, 20 Nov 2016 02:57:40 +0000"  >&lt;p&gt;I have started investigation the issue and what I have:&lt;br/&gt;
1. InterruptedException in &lt;tt&gt;Kafka08Fetcher.runFetchLoop&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2 &amp;gt; 08:18:41,705 ERROR org.apache.flink.streaming.connectors.kafka.internals.Kafka08Fetcher  - Exception while shutting down consumer threads
java.lang.InterruptedException
	at java.lang.Object.wait(Native Method)
	at java.lang.Thread.join(Thread.java:1289)
	at org.apache.flink.streaming.connectors.kafka.internals.Kafka08Fetcher.runFetchLoop(Kafka08Fetcher.java:293)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;root cause - it will occur when call t.join on interrupted thread&lt;br/&gt;
In finally block of the &lt;tt&gt;Kafka08Fetcher.runFetchLoop&lt;/tt&gt; &lt;tt&gt;t.join&lt;/tt&gt; is called for threads cancelation procedure, but &lt;tt&gt;Kafka08Fetcher.runFetchLoop&lt;/tt&gt; is executing in the same thread as &lt;tt&gt;StreamTask&lt;/tt&gt; &lt;br/&gt;
which can be interrupted earlier.&lt;br/&gt;
it is fixed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; (10/26/16):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// clear the interruption flag
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; allows the joining on consumer threads (on best effort) to happen in
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; the initial interrupt already
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.interrupted();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are several problems in the interaction with &lt;tt&gt;ZookeeperOffsetHandler&lt;/tt&gt;:&lt;br/&gt;
2. I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt;, work with object &lt;tt&gt;ZookeeperOffsetHandler&lt;/tt&gt; in &lt;tt&gt;Kafka08Fetcher&lt;/tt&gt; is not assured thread safe:&lt;br/&gt;
ok, there are synchronization points in &lt;tt&gt;StreamTask&lt;/tt&gt;, but what happens in case of failure in &lt;tt&gt;runFetchLoop&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;StreamTask&lt;/tt&gt; lock will be free, because &lt;tt&gt;run()&lt;/tt&gt; is performing, &lt;br/&gt;
during performing finally block of &lt;tt&gt;runFetchLoop&lt;/tt&gt; another thread can call &lt;tt&gt;notifyCheckpointComplete&lt;/tt&gt; and acquire lock&lt;br/&gt;
although close method is already called on &lt;tt&gt;ZookeeperOffsetHandler&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;3. &lt;tt&gt;ZookeeperOffsetHandler&lt;/tt&gt; is given into &lt;tt&gt;PeriodicOffsetCommitter&lt;/tt&gt; thread which is closing without thread join, also there is possibility to call &lt;tt&gt;prepareAndCommitOffsets&lt;/tt&gt; although close method is already called on &lt;tt&gt;ZookeeperOffsetHandler&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15683063" author="andrew efimov" created="Mon, 21 Nov 2016 09:57:43 +0000"  >&lt;p&gt;I would suggest the following solution:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;not only set null in finally block of &lt;tt&gt;Kafka08Fetcher&lt;/tt&gt; &lt;tt&gt;this.zookeeperOffsetHandler = null;&lt;/tt&gt;, also set flag &lt;tt&gt;volatile closed&lt;/tt&gt; for &lt;tt&gt;ZookeeperOffsetHandler&lt;/tt&gt;. Threads will check the flag before call methods &lt;tt&gt;ZookeeperOffsetHandler.setOffsetInZooKeeper&lt;/tt&gt; or &lt;tt&gt;ZookeeperOffsetHandler.getOffsetFromZooKeeper&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;and create atomic thread counter for ZookeeperOffsetHandler and perform close only if counter = 0, with timeout of cause&lt;br/&gt;
or use &lt;tt&gt;CheckpointLock&lt;/tt&gt; that is in context&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Team, what do you think?&lt;/p&gt;</comment>
                            <comment id="15686881" author="tzulitai" created="Tue, 22 Nov 2016 14:27:37 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andrew+Efimov&quot; class=&quot;user-hover&quot; rel=&quot;Andrew Efimov&quot;&gt;Andrew Efimov&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for looking at this. I haven&apos;t looked back at this issue in too much detail, but from what I recall, your first suggestion seems reasonable. However, even with a &lt;tt&gt;closed&lt;/tt&gt; flag, the &lt;tt&gt;ZookeeperOffsetHandler#close()&lt;/tt&gt; and &lt;tt&gt;ZookeeperOffsetHandler#prepareAndCommitOffsets()&lt;/tt&gt; still needs to be synchronized, otherwise the curator client can still be closed by another thread before &lt;tt&gt;prepareAndCommitOffsets&lt;/tt&gt; reaches the client API call.&lt;/p&gt;

&lt;p&gt;Have you found out a way to reproduce this issue? Would be great if we add a test with the fix to ensure this exception doesn&apos;t happen again.&lt;/p&gt;
</comment>
                            <comment id="15708105" author="andrew efimov" created="Wed, 30 Nov 2016 09:55:13 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt;&lt;br/&gt;
Thanks for reply.&lt;br/&gt;
It is very difficult to reproduce this state of concurrency model. But we should make the model more transparent and predictable.&lt;br/&gt;
I have created diagram that describes behaviour (used free idea plugin plantuml): &lt;br/&gt;
see attached file Kafka08Fetcher.png&lt;br/&gt;
There are two thread which can use  the same Kafka08Fetcher and for each we should make a guarantee that curator client will be working at the moment of using.&lt;/p&gt;

&lt;p&gt;And I would suggest two approaches, please take a look at the draft:&lt;br/&gt;
1. If each StreamTask has its Kafka08Fetcher then we can create a flag that will indicate commit handler is used or not &lt;br/&gt;
(or we can create atomicInteger to increment and decrement count of thread which use handler)&lt;br/&gt;
&lt;a href=&quot;https://github.com/BrainLogic/flink/commit/ba327dc5c991d12366ab16ea6d8e707238b2e79c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/BrainLogic/flink/commit/ba327dc5c991d12366ab16ea6d8e707238b2e79c&lt;/a&gt;&lt;br/&gt;
2. using checkpoint lock from sourceContext&lt;br/&gt;
&lt;a href=&quot;https://github.com/BrainLogic/flink/commit/abe16442c5dcf294b3c2bd28142765fe28515f8c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/BrainLogic/flink/commit/abe16442c5dcf294b3c2bd28142765fe28515f8c&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let&apos;s discuss and then I&apos;m going to do tests.&lt;/p&gt;</comment>
                            <comment id="15728171" author="tzulitai" created="Wed, 7 Dec 2016 08:57:44 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andrew+Efimov&quot; class=&quot;user-hover&quot; rel=&quot;Andrew Efimov&quot;&gt;Andrew Efimov&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Sorry for the very late response, I&apos;ve been quite busy recently.&lt;br/&gt;
Thanks a lot for looking into this in so much detail!&lt;/p&gt;

&lt;p&gt;For the two approaches you mentioned, the second one seems more reasonable to me at a first look. I would also recommend that we change the &lt;tt&gt;ZookeeperOffsetHandler&lt;/tt&gt;&apos;s own logic to be fail-proof to these concurrent accesses.&lt;br/&gt;
From what I understand of your approaches, we&apos;re still relying on the fetcher&apos;s logic to call &lt;tt&gt;ZookeeperOffsetHandler&lt;/tt&gt; safely. I think it would be a good design that the &lt;tt&gt;ZookeeperOffsetHandler&lt;/tt&gt; is also self-contained, and don&apos;t need to rely on the callers&apos; behaviour at all.&lt;/p&gt;

&lt;p&gt;I&apos;m not really sure if my comment makes sense, since I haven&apos;t looked too much into this yet. I think it would be great if you can go ahead and open the PR, and we can further look at it from there &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ll be happy to shepherd your contribution!&lt;/p&gt;</comment>
                            <comment id="15751146" author="stephanewen" created="Thu, 15 Dec 2016 11:38:33 +0000"  >&lt;p&gt;I saw the issue happening again: &lt;a href=&quot;https://api.travis-ci.org/jobs/183927280/log.txt?deansi=true&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/jobs/183927280/log.txt?deansi=true&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andrew+Efimov&quot; class=&quot;user-hover&quot; rel=&quot;Andrew Efimov&quot;&gt;Andrew Efimov&lt;/a&gt; are you still working on a patch for this?&lt;/p&gt;</comment>
                            <comment id="15754286" author="andrew efimov" created="Fri, 16 Dec 2016 12:24:34 +0000"  >&lt;p&gt;Hi team, &lt;br/&gt;
Thanks for replay. Sorry, I had a hard work of this week.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt; I will be grateful for your mentoring!&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; I believe, that the fix will be done early next week(19 dec).&lt;/p&gt;</comment>
                            <comment id="15765735" author="githubbot" created="Wed, 21 Dec 2016 01:03:27 +0000"  >&lt;p&gt;GitHub user BrainLogic opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    [ &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4905&quot; title=&quot;Kafka test instability IllegalStateException: Client is not started&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4905&quot;&gt;&lt;del&gt;FLINK-4905&lt;/del&gt;&lt;/a&gt;]  Kafka test instability IllegalStateException: Client is not started&lt;/p&gt;

&lt;p&gt;    Root cause of the issue: &lt;br/&gt;
    `notifyCheckpointComplete` can occur during the cancellation or `runFetchLoop` fail and call `commitOffset` on closed `curatorClient`, so use `CheckpointLock` to close `curatorClient`.&lt;br/&gt;
    There is a diagram in the jira that describes behaviour of using `Kafka08Fetcher`.&lt;/p&gt;

&lt;p&gt;    Notes:&lt;br/&gt;
    1. I don&apos;t like approach where `checkPointLock` is leaked into `SourceContext`, this may lead to deadlock.&lt;br/&gt;
    2. Work with `ZookeeperOffsetHandler` can continue even after the call Kafka08Fetcher.cancel until the `Handler` will not be null.&lt;br/&gt;
    3. `ZookeeperOffsetHandler` could have `ReadWriteLock` and use `writeLock` only for close operation, but I have doubt, Flink code base does not contain any `ReentrantLocks`. There is possibility to implement such logic without any locks by using lock-free approach.&lt;br/&gt;
    4. Also in *&lt;b&gt;jdk8&lt;/b&gt;&lt;b&gt;, we have powerful tool `StampedLock`. In which version of Flink we will be able to use **jdk8&lt;/b&gt;* features? &lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/BrainLogic/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/BrainLogic/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4905&quot; title=&quot;Kafka test instability IllegalStateException: Client is not started&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4905&quot;&gt;&lt;del&gt;FLINK-4905&lt;/del&gt;&lt;/a&gt;_PR&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3035&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit fd5524eb15ec772f95c4168818264c63e45f5784&lt;br/&gt;
Author: cube &amp;lt;aefimov.cube@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-20T23:41:12Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4905&quot; title=&quot;Kafka test instability IllegalStateException: Client is not started&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4905&quot;&gt;&lt;del&gt;FLINK-4905&lt;/del&gt;&lt;/a&gt; Kafka test instability IllegalStateException: Client is not started&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15801086" author="githubbot" created="Thu, 5 Jan 2017 11:15:25 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you for working on this @BrainLogic!&lt;/p&gt;

&lt;p&gt;    First, regarding the approach proposed here:&lt;br/&gt;
    The approach should be able to fix the `IllegalStateException` we&apos;re encountering.&lt;br/&gt;
    However, I would also want to try to make `ZookeeperOffsetHandler` thread-safe and insensitive to the ordering `commitOffsets` and `close` are called from the outside. Otherwise, from the context of `Kafka08Fetcher` alone, the reason for the new synchronization isn&apos;t that obvious, and might result in harder-to-maintain code in the long run. What do you think?&lt;/p&gt;</comment>
                            <comment id="15801100" author="githubbot" created="Thu, 5 Jan 2017 11:22:02 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Regarding some of your notes:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The exposure of the checkpoint lock through `SourceContext` is meant for sources to atomically update their state (e.x. Kafka offsets) with record emitting, with regards to Flink&apos;s checkpointing mechanics for exactly once.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I don&apos;t think there has been any solid discussion on migrating to Java 8 yet.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15804245" author="githubbot" created="Fri, 6 Jan 2017 10:30:51 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Dropping Java 7 has not happened and there is not yet consensus in the community, so it probably will not happen in the next weeks.&lt;/p&gt;</comment>
                            <comment id="15834052" author="githubbot" created="Mon, 23 Jan 2017 08:20:38 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @BrainLogic, we&apos;re still seeing this exception in tests sometimes, and it&apos;ll be great to have this fixed soon.&lt;/p&gt;

&lt;p&gt;    Please let us know on how you&apos;d like to proceed with the contribution, otherwise if you don&apos;t have time, I can also pick it up &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Thank you!&lt;/p&gt;</comment>
                            <comment id="15834660" author="githubbot" created="Mon, 23 Jan 2017 14:32:01 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think we can take a very simple approach here. Many other parts of the code follow the approach to tolerate exceptions thrown during cancellation, or during asynchronous calls on closed operators.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The client may be closed during shutting down of the Kafka08Fetcher, before even the surrounding KafkaConsumerBase knows that it is closing&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The KafkaConsumerBase tries to commit offsets, sees the exception, and re-throws it since it assumes it.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We can make the Kafka08Fetcher catch exceptions when committing offsets, and only re-throwing them if the fetcher is still running. That should do the trick.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    BTW: There are plans to make the streaming API sources appear to be single threaded, to avoid that sources have to plan for such situations.&lt;/p&gt;</comment>
                            <comment id="15834668" author="githubbot" created="Mon, 23 Jan 2017 14:33:07 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I would like to pick this fix up. The exception has still occurred a few times for me in the past, and I prefer the above outlined solution, because it adds less locking on cancellation/shutdown, meaning there are fewer implications on deadlocks or long stalls on cancellation/shutdown.&lt;/p&gt;</comment>
                            <comment id="15834744" author="githubbot" created="Mon, 23 Jan 2017 15:28:34 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Bit of background how the error happens:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The test throws a `SuccessException`&lt;/li&gt;
	&lt;li&gt;While being in the finally clause and shutting down the CluratorClient, the containing `Task` has not seen the exception.&lt;/li&gt;
	&lt;li&gt;When the commitOffsets() call fails, this overrides the `SuccessException` as the reason why the streaming program terminated.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15835783" author="githubbot" created="Tue, 24 Jan 2017 07:15:59 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you for picking this up @StephanEwen! I&apos;ve taken a look at your approach in the local branch, +1 to the approach.&lt;/p&gt;
</comment>
                            <comment id="15836093" author="githubbot" created="Tue, 24 Jan 2017 12:31:32 +0000"  >&lt;p&gt;Github user BrainLogic commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for help and explanation.&lt;br/&gt;
    But in this approach an unlikely bug will be still occurred:&lt;br/&gt;
    `zkHandler.prepareAndCommitOffsets(offsets);` throws important exception when running is true&lt;br/&gt;
    then running becomes `false` and we get a swallowed exception in this rare case. &lt;br/&gt;
    Maybe at least, should log the exception anyway?&lt;/p&gt;

&lt;p&gt;    I agree that it is not rational to spend time for time consuming refactoring kafka connector of 8 version.&lt;br/&gt;
    Current version of kafka is 0.10 and hardly, users will widely use 8 version.&lt;/p&gt;

</comment>
                            <comment id="15836398" author="githubbot" created="Tue, 24 Jan 2017 18:21:09 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15836448" author="githubbot" created="Tue, 24 Jan 2017 18:47:23 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @BrainLogic I&apos;ll incorporate your comment into a followup commit...&lt;/p&gt;</comment>
                            <comment id="15837459" author="githubbot" created="Wed, 25 Jan 2017 09:43:27 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Quick question: I am not sure if this scenario can happen like that:&lt;/p&gt;

&lt;p&gt;    &amp;gt; But in this approach an unlikely bug will be still occurred:&lt;br/&gt;
    zkHandler.prepareAndCommitOffsets(offsets); throws important exception when running is true&lt;br/&gt;
    then running becomes false and we get a swallowed exception in this rare case.&lt;br/&gt;
    Maybe at least, should log the exception anyway?&lt;/p&gt;

&lt;p&gt;    When the exception is thrown in `zkHandler.prepareAndCommitOffsets(offsets)` and `running = true` then the exception does not get swallowed. The `running` flag can become false only after the exception was thrown. If the flag becomes false due to another reason, then there is either another root cause for the failure, or the operator is shutting down anyways. In both cases, it is probably okay to not report the exception.&lt;/p&gt;

&lt;p&gt;    Please let me know if you think I have overlooked something here.&lt;/p&gt;</comment>
                            <comment id="15837665" author="githubbot" created="Wed, 25 Jan 2017 12:41:28 +0000"  >&lt;p&gt;Github user BrainLogic commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Distributed systems and multithreading environments make us think in term of logical clock, like Lamport clock, step by step:&lt;br/&gt;
    Thread1 - fetcher is running `running = true`&lt;br/&gt;
    Thread2 performs `zkHandler.prepareAndCommitOffsets(offsets)`&lt;br/&gt;
    Thread2 `running = true` and `zkHandler.prepareAndCommitOffsets(offsets)` throws an exception&lt;br/&gt;
    Thread1 stop fetcher and change flag `running = false` in normal way without any exception&lt;br/&gt;
    Thread2 read the flag `running = false` and `return` although, there is a reason of the commit failure that is different from &quot;Client was closed and running= false&quot;&lt;br/&gt;
    Thread1 fetcher is stopped successfully&lt;br/&gt;
    There is no exception or any information in log regarding the exception from `zkHandler.prepareAndCommitOffsets(offsets)`&lt;/p&gt;

&lt;p&gt;    Again this is a rare case when we can lose a root cause of strange behavior - offset will not be committed although there are no any exceptions. Am I wrong?&lt;/p&gt;</comment>
                            <comment id="15837684" author="githubbot" created="Wed, 25 Jan 2017 12:49:51 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I this case, the exception would not be logged, true.&lt;br/&gt;
    It is a very rare corner case that should not affect correctness, and not really distinguishable from the case where an exception is thrown after the source went into finishing mode.&lt;/p&gt;

&lt;p&gt;    My feeling is to not log here.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The advantage is that we don&apos;t pollute the log with meaningless exception in the common case (many users would be led onto a false track).&lt;/li&gt;
	&lt;li&gt;Given that the corner case you described does not affect any expected behavior (the committing action might as well not have happened at all it it were started a few msecs later) it is okay to &quot;swallow&quot; the exception.&lt;/li&gt;
	&lt;li&gt;If it does in fact affect the offset committing in more cases, it will surely also occur at another committing attempt during execution.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15837713" author="githubbot" created="Wed, 25 Jan 2017 13:18:35 +0000"  >&lt;p&gt;Github user BrainLogic commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I caught yours idea and together with the argument which I mentioned above - users will not extensively use 8 version of kafka connector, I agree with this proposal.&lt;br/&gt;
    Let me finish this jira, I can create fix based on yours proposal and try to implement test tonight.&lt;/p&gt;</comment>
                            <comment id="15837721" author="githubbot" created="Wed, 25 Jan 2017 13:24:28 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3035&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I pushed a fix for that to master in e7cda75b8594417559d6aac6229b5893f5459f0f&lt;/p&gt;</comment>
                            <comment id="15837742" author="andrew efimov" created="Wed, 25 Jan 2017 13:34:10 +0000"  >&lt;p&gt;Fixed by Stephan Ewen&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12841010" name="Kafka08Fetcher.png" size="39098" author="Andrew Efimov" created="Wed, 30 Nov 2016 09:40:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35con:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>