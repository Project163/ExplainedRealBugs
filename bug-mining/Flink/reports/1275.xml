<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:25:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4544] TaskManager metrics are vulnerable to custom JMX bean installation</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4544</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The TaskManager&apos;s CPU load magic may fail when JMX providers are overwritten.&lt;/p&gt;

&lt;p&gt;The TaskManager logic checks if the class &lt;tt&gt;com.sun.management.OperatingSystemMXBean&lt;/tt&gt; is available. If yes, it assumes that the &lt;tt&gt;ManagementFactory.getOperatingSystemMXBean()&lt;/tt&gt; is of that type. That is not necessarily the case.&lt;/p&gt;

&lt;p&gt;This is visible in the Cassandra tests, as Cassandra overrides the JMX provider - every heartbeat causes an exception that is logged (See below), flooding the log, killing the heartbeat message.&lt;/p&gt;

&lt;p&gt;I would also suggest to move the entire metrics code out of the &lt;tt&gt;TaskManager&lt;/tt&gt; class into a dedicated class &lt;tt&gt;TaskManagerJvmMetrics&lt;/tt&gt;. That one can, with a static method, install the metrics into the TaskManager&apos;s metric group.&lt;/p&gt;


&lt;p&gt;Sample stack trace when default platform beans are overridden:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;23914 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-3] WARN  org.apache.flink.runtime.taskmanager.TaskManager  - Error retrieving CPU Load through OperatingSystemMXBean
java.lang.IllegalArgumentException: object is not an instance of declaring class
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:497)
	at org.apache.flink.runtime.taskmanager.TaskManager$$anon$3$$anonfun$getValue$2.apply(TaskManager.scala:2351)
	at org.apache.flink.runtime.taskmanager.TaskManager$$anon$3$$anonfun$getValue$2.apply(TaskManager.scala:2351)
	at scala.Option.map(Option.scala:145)
	at org.apache.flink.runtime.taskmanager.TaskManager$$anon$3.getValue(TaskManager.scala:2351)
	at org.apache.flink.runtime.taskmanager.TaskManager$$anon$3.getValue(TaskManager.scala:2348)
	at com.codahale.metrics.json.MetricsModule$GaugeSerializer.serialize(MetricsModule.java:32)
	at com.codahale.metrics.json.MetricsModule$GaugeSerializer.serialize(MetricsModule.java:20)
	at com.fasterxml.jackson.databind.ser.std.MapSerializer.serializeFields(MapSerializer.java:616)
	at com.fasterxml.jackson.databind.ser.std.MapSerializer.serialize(MapSerializer.java:519)
	at com.fasterxml.jackson.databind.ser.std.MapSerializer.serialize(MapSerializer.java:31)
	at com.fasterxml.jackson.databind.ser.DefaultSerializerProvider.serializeValue(DefaultSerializerProvider.java:130)
	at com.fasterxml.jackson.databind.ObjectMapper.writeValue(ObjectMapper.java:2444)
	at com.fasterxml.jackson.core.base.GeneratorBase.writeObject(GeneratorBase.java:355)
	at com.fasterxml.jackson.core.JsonGenerator.writeObjectField(JsonGenerator.java:1442)
	at com.codahale.metrics.json.MetricsModule$MetricRegistrySerializer.serialize(MetricsModule.java:186)
	at com.codahale.metrics.json.MetricsModule$MetricRegistrySerializer.serialize(MetricsModule.java:171)
	at com.fasterxml.jackson.databind.ser.DefaultSerializerProvider.serializeValue(DefaultSerializerProvider.java:130)
	at com.fasterxml.jackson.databind.ObjectMapper._configAndWriteValue(ObjectMapper.java:3631)
	at com.fasterxml.jackson.databind.ObjectMapper.writeValueAsBytes(ObjectMapper.java:3022)
	at org.apache.flink.runtime.taskmanager.TaskManager.sendHeartbeatToJobManager(TaskManager.scala:1278)
	at org.apache.flink.runtime.taskmanager.TaskManager$$anonfun$handleMessage$1.applyOrElse(TaskManager.scala:309)
	at scala.runtime.AbstractPartialFunction$mcVL$sp.apply$mcVL$sp(AbstractPartialFunction.scala:33)
	at scala.runtime.AbstractPartialFunction$mcVL$sp.apply(AbstractPartialFunction.scala:33)
	at scala.runtime.AbstractPartialFunction$mcVL$sp.apply(AbstractPartialFunction.scala:25)
	at org.apache.flink.runtime.testingUtils.TestingTaskManagerLike$$anonfun$handleTestingMessage$1.applyOrElse(TestingTaskManagerLike.scala:65)
	at scala.PartialFunction$OrElse.apply(PartialFunction.scala:162)
	at org.apache.flink.runtime.LeaderSessionMessageFilter$$anonfun$receive$1.applyOrElse(LeaderSessionMessageFilter.scala:44)
	at scala.runtime.AbstractPartialFunction$mcVL$sp.apply$mcVL$sp(AbstractPartialFunction.scala:33)
	at scala.runtime.AbstractPartialFunction$mcVL$sp.apply(AbstractPartialFunction.scala:33)
	at scala.runtime.AbstractPartialFunction$mcVL$sp.apply(AbstractPartialFunction.scala:25)
	at org.apache.flink.runtime.LogMessages$$anon$1.apply(LogMessages.scala:33)
	at org.apache.flink.runtime.LogMessages$$anon$1.apply(LogMessages.scala:28)
	at scala.PartialFunction$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;applyOrElse(PartialFunction.scala:118)
	at org.apache.flink.runtime.LogMessages$$anon$1.applyOrElse(LogMessages.scala:28)
	at akka.actor.Actor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;aroundReceive(Actor.scala:465)
	at org.apache.flink.runtime.taskmanager.TaskManager.aroundReceive(TaskManager.scala:124)
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:516)
	at akka.actor.ActorCell.invoke(ActorCell.scala:487)
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:254)
	at akka.dispatch.Mailbox.run(Mailbox.scala:221)
	at akka.dispatch.Mailbox.exec(Mailbox.scala:231)
	at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.pollAndExecAll(ForkJoinPool.java:1253)
	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1346)
	at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
	at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13001710">FLINK-4544</key>
            <summary>TaskManager metrics are vulnerable to custom JMX bean installation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Aug 2016 15:17:06 +0000</created>
                <updated>Fri, 28 Oct 2016 11:47:35 +0000</updated>
                            <resolved>Fri, 28 Oct 2016 11:46:59 +0000</resolved>
                                    <version>1.1.2</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15452596" author="githubbot" created="Wed, 31 Aug 2016 15:50:15 +0000"  >&lt;p&gt;GitHub user zentol opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4544&quot; title=&quot;TaskManager metrics are vulnerable to custom JMX bean installation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4544&quot;&gt;&lt;del&gt;FLINK-4544&lt;/del&gt;&lt;/a&gt; Refactor old CPU metric initialization&lt;/p&gt;

&lt;p&gt;    This PR refactors the old CPU metric initialization code to no longer rely on reflection.&lt;/p&gt;

&lt;p&gt;    Instead it eagerly casts the `OperatingSystemMXBean` returned by `ManagementFactory#getOperationSystemMXBean()` to `com.sun.management.OperatingSystemMXBean`. Should this succeed it is now guaranteed that the gauge will not throw a `ClassCastException` since it doesn&apos;t have to cast anything; if it fails a dummy Gauge is registered that returns -1 in order to retain existing behavior.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zentol/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/flink&lt;/a&gt; 4544_tm_cpu&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2445&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 51ff47711cde8d32d8d0b6d2abf3bd264d207342&lt;br/&gt;
Author: zentol &amp;lt;chesnay@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-08-31T15:46:10Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4544&quot; title=&quot;TaskManager metrics are vulnerable to custom JMX bean installation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4544&quot;&gt;&lt;del&gt;FLINK-4544&lt;/del&gt;&lt;/a&gt; Refactor old CPU metric initialization&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15452699" author="githubbot" created="Wed, 31 Aug 2016 16:32:59 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Does this work? The reason for the initial reflection-based initialization was that the sun-specific class may not be available in some environments. I am unsure when the &quot;ClassNotFound&quot; error will be thrown. Upon loading of the TaskManager? Or upon running the code that installs the Gauge. I fear it may be thrown earlier than when the Gauge is created.&lt;/p&gt;</comment>
                            <comment id="15453446" author="githubbot" created="Wed, 31 Aug 2016 21:38:25 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This is the pretty-much same code that the new CPU metric uses which has not caused issues so far.&lt;/p&gt;</comment>
                            <comment id="15453451" author="githubbot" created="Wed, 31 Aug 2016 21:39:57 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    But i see the issue that could arise, will rework the solution.&lt;/p&gt;</comment>
                            <comment id="15457975" author="githubbot" created="Fri, 2 Sep 2016 08:51:57 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Version 2 is up. Essentially, we now attempt to use the methods before registering the metrics. I&apos;ve also adjusted the new CPU metrics.&lt;/p&gt;</comment>
                            <comment id="15512915" author="githubbot" created="Thu, 22 Sep 2016 10:38:02 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Can we move this code out of the TaskManager as a whole, into a metrics Utility?&lt;br/&gt;
    We could make it reusable for the JobManager as well, by passing the metric group where that should be added.&lt;/p&gt;</comment>
                            <comment id="15512941" author="githubbot" created="Thu, 22 Sep 2016 10:51:19 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    that should be doable, yes.&lt;/p&gt;</comment>
                            <comment id="15516540" author="githubbot" created="Fri, 23 Sep 2016 14:02:43 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen I moved the code into a separate class.&lt;/p&gt;</comment>
                            <comment id="15608808" author="githubbot" created="Wed, 26 Oct 2016 15:40:31 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The approach looks good, but I think it would be good to adjust a few things:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We are migrating most of the Scala code in `flink-runtime` to Java (for example in FLIP-6), so would be good if this new code was also Java&lt;/li&gt;
	&lt;li&gt;Some of the Gauges use some form of JMX querying (`getAttribute(ObjectName)`) that looks more expensive then directly accessing a bean (calling a method)&lt;/li&gt;
	&lt;li&gt;Some metrics may not be available on all JVMs (like mapped direct memory). Can this make sure we don&apos;t log an exception on each access to the Gauge, when the JMX query fails?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15615168" author="zentol" created="Fri, 28 Oct 2016 11:47:00 +0000"  >&lt;p&gt;Fixed in 5b54009ebdf1602bdc9860b46ee34e65ef74246a.&lt;/p&gt;

&lt;p&gt;This issue was extended to a more thorough refactoring of the JM/TM metrics.&lt;/p&gt;

&lt;p&gt;The initial issue regarding the OperatorSystemMXBean was fixed. Other changes include&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the metrics were reqritten in java due to FLIP-6&lt;/li&gt;
	&lt;li&gt;the BufferPool metrics are no longer fetched through JMX and instead use BufferPoolMXBeans&lt;/li&gt;
	&lt;li&gt;the entire JM/TM metrics initialization was moved into a common util class&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15615170" author="githubbot" created="Fri, 28 Oct 2016 11:47:35 +0000"  >&lt;p&gt;Github user zentol closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2445&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i332qf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>