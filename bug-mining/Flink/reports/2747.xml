<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:36:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10531] State TTL RocksDb backend end-to-end test failed on Travis</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10531</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;State TTL RocksDb backend end-to-end test&lt;/tt&gt; end-to-end test failed on Travis.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/apache/flink/jobs/438226190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/flink/jobs/438226190&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://api.travis-ci.org/v3/job/438226190/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/438226190/log.txt&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13190992">FLINK-10531</key>
            <summary>State TTL RocksDb backend end-to-end test failed on Travis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkl0u">Kostas Kloudas</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Thu, 11 Oct 2018 17:21:25 +0000</created>
                <updated>Fri, 16 Nov 2018 19:34:12 +0000</updated>
                            <resolved>Fri, 16 Nov 2018 19:34:12 +0000</resolved>
                                    <version>1.6.1</version>
                                    <fixVersion>1.7.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16676957" author="kkl0u" created="Tue, 6 Nov 2018 16:22:13 +0000"  >&lt;p&gt;It is a test instability. &lt;/p&gt;

&lt;p&gt;The way the test works is the following. For a given state:&lt;br/&gt;
1) it keeps the state with TTL&lt;br/&gt;
2) and keeps all the updates to that state irrespective of their timestamp (e.g. all the elements added in a ListState)&lt;/p&gt;

&lt;p&gt;To verify correctness:&lt;br/&gt;
1) it fetches the state from Flink, as cleaned up by the internal TTL mechanism&lt;br/&gt;
2) it reconstructs the expected state from the stored updates by taking the timestamp &lt;br/&gt;
   of the latest update (ts) discarding elements with timestamp ts-ttl&lt;/p&gt;

&lt;p&gt;As you can see from the stacktrace in the error from Travis, the latest update has timestamp ts=1538918066021&lt;br/&gt;
while there are elements in the list with timestamps greater than ts (e.g. 1538918066136). This means that the internal&lt;br/&gt;
clock on that machine went backwards, so Flink&apos;s TTL may have removed elements that appear in the expected state&lt;br/&gt;
of the test, as it takes as current timestamp the ts=1538918066021.&lt;/p&gt;

&lt;p&gt;The fix is simply to assume that (for the test), processing time increases monotonically and ignore &quot;updates from the past&quot;.&lt;/p&gt;</comment>
                            <comment id="16677018" author="githubbot" created="Tue, 6 Nov 2018 17:08:59 +0000"  >&lt;p&gt;kl0u opened a new pull request #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   As describe on the JIRA, the problem is that the clock on the machine on Travis seems to have jumped backwards.&lt;/p&gt;

&lt;p&gt;   This resulted in a mismatch between the elements discarded as expired by Flink&apos;s internal TTL mechanism, and the &quot;user-code&quot; in the test that computes the expired elements based on the timestamp of the latest update.&lt;/p&gt;

&lt;p&gt;   I repeat the explanation from the JIRA here for reference:&lt;/p&gt;

&lt;p&gt;   -------------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;   The way the test works is the following. For a given state:&lt;br/&gt;
   1) it keeps the state with TTL&lt;br/&gt;
   2) and keeps all the updates to that state irrespective of their timestamp (e.g. all the elements added in a ListState)&lt;/p&gt;

&lt;p&gt;   To verify correctness:&lt;br/&gt;
   1) it fetches the state from Flink, as cleaned up by the internal TTL mechanism&lt;br/&gt;
   2) it reconstructs the expected state from the stored updates by taking the timestamp &lt;br/&gt;
   of the latest update (ts) discarding elements with timestamp ts-ttl&lt;/p&gt;

&lt;p&gt;   As you can see from the stacktrace in the error from Travis, the latest update has timestamp ts=1538918066021&lt;br/&gt;
   while there are elements in the list with timestamps greater than ts (e.g. 1538918066136). This means that the internal&lt;br/&gt;
   clock on that machine went backwards, so Flink&apos;s TTL may have removed elements that appear in the expected state&lt;br/&gt;
   of the test, as it takes as current timestamp the ts=1538918066021.&lt;/p&gt;

&lt;p&gt;   The fix is simply to assume that (for the test), processing time increases monotonically and ignore &quot;updates from the past&quot;.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16677023" author="githubbot" created="Tue, 6 Nov 2018 17:09:51 +0000"  >&lt;p&gt;kl0u commented on issue #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036#issuecomment-436331588&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036#issuecomment-436331588&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   R @azagrebin &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16677872" author="githubbot" created="Wed, 7 Nov 2018 09:02:09 +0000"  >&lt;p&gt;zentol commented on issue #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036#issuecomment-436552626&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036#issuecomment-436552626&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   `performUpdate()` is using `System.currentTimeMillis` which is not guaranteed to be monotonous. Could this be the underlying cause?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16679597" author="githubbot" created="Thu, 8 Nov 2018 10:55:54 +0000"  >&lt;p&gt;StefanRRichter commented on issue #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036#issuecomment-436954874&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036#issuecomment-436954874&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I wonder if it would not make more sense to use a monotonous time provider for a single machine, such as `System.nanoTime()`, or a wrapper around time millis that prevents falling back in time, or some test implementation that the test can control, for the test instead of ignoring elements and potentially missing out on errors. `TtlTimeProvider` is already an interface, and `TtlTimeProvider DEFAULT = System::currentTimeMillis;` is used in all places. Instead this could be the first case where we want to make the time provider configurable via a factor. The simplest case could just replace it when encountering a certain config entry or property. &lt;/p&gt;

&lt;p&gt;   Another option would be that if we detect such time changes we exit the test with a certain exit code and rerun it again. What do you think?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16679915" author="githubbot" created="Thu, 8 Nov 2018 15:35:33 +0000"  >&lt;p&gt;azagrebin commented on issue #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036#issuecomment-437038969&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036#issuecomment-437038969&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I agree that configuring custom processing time provider on the API side is more robust approach for tests. The change might be a bit more involving. I have created issues to consider it: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10830&quot; title=&quot;Consider making processing time provider pluggable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10830&quot;&gt;FLINK-10830&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10831&quot; title=&quot;Consider making processing time monotonically increasing by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10831&quot;&gt;&lt;del&gt;FLINK-10831&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;   One more option is to check if `currentTimeMillis` jumped back in `TtlVerifyUpdateFunction.performUpdate` relatively to the latest consumed value. If jump happened then just wait until it returns the next value greater than the latest consumed value. This way the update never needs to be rejected for this reason and test restarted.&lt;/p&gt;

&lt;p&gt;   There is still potential subtle problem (could be not really practical) if:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`timestampBeforeUpdate` gets increased value&lt;/li&gt;
	&lt;li&gt;Flink gets jumped back `currentTimeMillis`&lt;/li&gt;
	&lt;li&gt;lag happens and&lt;/li&gt;
	&lt;li&gt;`timestampAfterUpdate` gets again increased value.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   In this case, the time queried by Flink is completely out of test control and without plugging the time there is no way to sync it in Flink and test.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16679916" author="githubbot" created="Thu, 8 Nov 2018 15:36:00 +0000"  >&lt;p&gt;azagrebin edited a comment on issue #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036#issuecomment-437038969&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036#issuecomment-437038969&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I agree that configuring custom processing time provider on the API side is more robust approach for tests. The change might be a bit more involving. I have created issues to consider it: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10830&quot; title=&quot;Consider making processing time provider pluggable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10830&quot;&gt;FLINK-10830&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10831&quot; title=&quot;Consider making processing time monotonically increasing by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10831&quot;&gt;&lt;del&gt;FLINK-10831&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;   One more option is to check if `currentTimeMillis` jumped back in `TtlVerifyUpdateFunction.performUpdate` relatively to the latest consumed value. If jump happened then just wait until `currentTimeMillis` returns the next value greater than the latest consumed value. This way the update never needs to be rejected for this reason and test restarted.&lt;/p&gt;

&lt;p&gt;   There is still potential subtle problem (could be not really practical) if:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`timestampBeforeUpdate` gets increased value&lt;/li&gt;
	&lt;li&gt;Flink gets jumped back `currentTimeMillis`&lt;/li&gt;
	&lt;li&gt;lag happens and&lt;/li&gt;
	&lt;li&gt;`timestampAfterUpdate` gets again increased value.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   In this case, the time queried by Flink is completely out of test control and without plugging the time there is no way to sync it in Flink and test.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16679925" author="githubbot" created="Thu, 8 Nov 2018 15:50:35 +0000"  >&lt;p&gt;kl0u commented on issue #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036#issuecomment-437044814&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036#issuecomment-437044814&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @azagrebin I commented on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10830&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-10830&lt;/a&gt; about my concerns of allowing the user to specify his/her own processing time provider.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16679946" author="githubbot" created="Thu, 8 Nov 2018 16:08:14 +0000"  >&lt;p&gt;kl0u commented on issue #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036#issuecomment-437051981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036#issuecomment-437051981&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Actually, now @StefanRRichter mentioned it, we have the `TtlTimeProvider` and the `ProcessingTimeService`. Both of them are used internally by Flink to let it know what is the &quot;current&quot; processing time, but each of them has its own implementation (which happens to be `currentTimeMillis` for both). &lt;/p&gt;

&lt;p&gt;   I think that these two should be unified and the `TtlTimeProvider` should call the `ProcessingTimeService::getCurrentProcessingTime()`.&lt;/p&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16679947" author="githubbot" created="Thu, 8 Nov 2018 16:09:02 +0000"  >&lt;p&gt;kl0u edited a comment on issue #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036#issuecomment-437051981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036#issuecomment-437051981&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Actually, now @StefanRRichter mentioned it, we have the `TtlTimeProvider` and the `ProcessingTimeService`. Both of them are used internally by Flink to let it know what is the &quot;current&quot; processing time, but each of them has its own implementation (which happens to be `currentTimeMillis` for both). &lt;/p&gt;

&lt;p&gt;   I think that these two should be unified and the `TtlTimeProvider` should call the `ProcessingTimeService::getCurrentProcessingTime()`. This will allow to have a &quot;single point of truth&quot;.&lt;/p&gt;

&lt;p&gt;   What do you think @StefanRRichter and @azagrebin &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16686867" author="githubbot" created="Wed, 14 Nov 2018 16:56:25 +0000"  >&lt;p&gt;kl0u commented on issue #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036#issuecomment-438735965&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036#issuecomment-438735965&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @azagrebin Please have another look and let me know what you think!&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16688409" author="githubbot" created="Thu, 15 Nov 2018 17:35:12 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036#discussion_r233938203&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036#discussion_r233938203&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/DataStreamStateTTLTestProgram.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -90,11 +107,83 @@ public static void main(String[] args) throws Exception &lt;/p&gt;
{
 			.addSource(new TtlStateUpdateSource(keySpace, sleepAfterElements, sleepTime))
 			.name(&quot;TtlStateUpdateSource&quot;)
 			.keyBy(TtlStateUpdate::getKey)
-			.flatMap(new TtlVerifyUpdateFunction(ttlConfig, reportStatAfterUpdatesNum))
+			.flatMap(new TtlVerifyUpdateFunction(ttlConfig, ttlTimeProvider, reportStatAfterUpdatesNum))
 			.name(&quot;TtlVerifyUpdateFunction&quot;)
 			.addSink(new PrintSinkFunction&amp;lt;&amp;gt;())
 			.name(&quot;PrintFailedVerifications&quot;);
 
 		env.execute(&quot;State TTL test job&quot;);
 	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Sets the state backend to a new &lt;/p&gt;
{@link StubStateBackend}
&lt;p&gt; which has a &lt;/p&gt;
{@link MonotonicTTLTimeProvider}.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param env The {@link StreamExecutionEnvironment} of the job.&lt;br/&gt;
+	 * @return The {@link MonotonicTTLTimeProvider}
&lt;p&gt;.&lt;br/&gt;
+	 */&lt;br/&gt;
+	private static MonotonicTTLTimeProvider setBackendWithCustomTTLTimeProvider(StreamExecutionEnvironment env) &lt;/p&gt;
{
+		final MonotonicTTLTimeProvider ttlTimeProvider = new MonotonicTTLTimeProvider();
+
+		final StateBackend configuredBackend = env.getStateBackend();
+		final StateBackend stubBackend = new StubStateBackend(configuredBackend, ttlTimeProvider);
+		env.setStateBackend(stubBackend);
+
+		return ttlTimeProvider;
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * A stub implementation of the &lt;/p&gt;
{@link StateBackend}
&lt;p&gt; that allows the use of&lt;br/&gt;
+	 * a custom &lt;/p&gt;
{@link TtlTimeProvider}
&lt;p&gt;.&lt;br/&gt;
+	 */&lt;br/&gt;
+	private static final class StubStateBackend implements StateBackend {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Let&apos;s also generate UUID for `StubStateBackend`, `MonotonicTTLTimeProvider`, `TtlVerifyUpdateFunction`, `UpdateStat`, `AggregateFunction`, `TtlUpdateContext`, `TtlVerificationContext`, `ValueWithTs` and `ValueWithTs.Serializer`.&lt;/p&gt;

&lt;p&gt;   I would suggest to create `StateBackendWrapperAdaptor` in main code along with `StateBackend` as well which would always wrap `wrappedBackend` and forward all `StateBackend` interface methods. Here we would need to override only relevant methods. The adaptor could be reused in future for similar cases like we have here. If `StateBackend` interface gets more methods, they would need default forwarding only in `StateBackendWrapperAdaptor` and other extending classes can stay untouched.&lt;br/&gt;
   Otherwise, I would suggest to move this class at least to separate file.&lt;br/&gt;
   I leave these last ideas up to you.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16689921" author="githubbot" created="Fri, 16 Nov 2018 19:31:33 +0000"  >&lt;p&gt;asfgit closed pull request #7036: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10531&quot; title=&quot;State TTL RocksDb backend end-to-end test failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10531&quot;&gt;&lt;del&gt;FLINK-10531&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;e2e&amp;#93;&lt;/span&gt; Fix unstable TTL end-to-end test.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7036&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7036&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/DataStreamStateTTLTestProgram.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/DataStreamStateTTLTestProgram.java&lt;br/&gt;
index 3b2e4746b62..1a572f314c5 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/DataStreamStateTTLTestProgram.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/DataStreamStateTTLTestProgram.java&lt;br/&gt;
@@ -23,6 +23,7 @@&lt;br/&gt;
 import org.apache.flink.api.java.utils.ParameterTool;&lt;br/&gt;
 import org.apache.flink.configuration.ConfigOption;&lt;br/&gt;
 import org.apache.flink.configuration.ConfigOptions;&lt;br/&gt;
+import org.apache.flink.runtime.state.StateBackend;&lt;br/&gt;
 import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;&lt;br/&gt;
 import org.apache.flink.streaming.api.functions.sink.PrintSinkFunction;&lt;/p&gt;

&lt;p&gt;@@ -74,6 +75,8 @@ public static void main(String[] args) throws Exception {&lt;/p&gt;

&lt;p&gt; 		setupEnvironment(env, pt);&lt;/p&gt;

&lt;p&gt;+		final MonotonicTTLTimeProvider ttlTimeProvider = setBackendWithCustomTTLTimeProvider(env);&lt;br/&gt;
+&lt;br/&gt;
 		int keySpace = pt.getInt(UPDATE_GENERATOR_SRC_KEYSPACE.key(), UPDATE_GENERATOR_SRC_KEYSPACE.defaultValue());&lt;br/&gt;
 		long sleepAfterElements = pt.getLong(UPDATE_GENERATOR_SRC_SLEEP_AFTER_ELEMENTS.key(),&lt;br/&gt;
 			UPDATE_GENERATOR_SRC_SLEEP_AFTER_ELEMENTS.defaultValue());&lt;br/&gt;
@@ -90,11 +93,27 @@ public static void main(String[] args) throws Exception &lt;/p&gt;
{
 			.addSource(new TtlStateUpdateSource(keySpace, sleepAfterElements, sleepTime))
 			.name(&quot;TtlStateUpdateSource&quot;)
 			.keyBy(TtlStateUpdate::getKey)
-			.flatMap(new TtlVerifyUpdateFunction(ttlConfig, reportStatAfterUpdatesNum))
+			.flatMap(new TtlVerifyUpdateFunction(ttlConfig, ttlTimeProvider, reportStatAfterUpdatesNum))
 			.name(&quot;TtlVerifyUpdateFunction&quot;)
 			.addSink(new PrintSinkFunction&amp;lt;&amp;gt;())
 			.name(&quot;PrintFailedVerifications&quot;);
 
 		env.execute(&quot;State TTL test job&quot;);
 	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Sets the state backend to a new &lt;/p&gt;
{@link StubStateBackend}
&lt;p&gt; which has a &lt;/p&gt;
{@link MonotonicTTLTimeProvider}.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param env The {@link StreamExecutionEnvironment} of the job.&lt;br/&gt;
+	 * @return The {@link MonotonicTTLTimeProvider}
&lt;p&gt;.&lt;br/&gt;
+	 */&lt;br/&gt;
+	private static MonotonicTTLTimeProvider setBackendWithCustomTTLTimeProvider(StreamExecutionEnvironment env) &lt;/p&gt;
{
+		final MonotonicTTLTimeProvider ttlTimeProvider = new MonotonicTTLTimeProvider();
+
+		final StateBackend configuredBackend = env.getStateBackend();
+		final StateBackend stubBackend = new StubStateBackend(configuredBackend, ttlTimeProvider);
+		env.setStateBackend(stubBackend);
+
+		return ttlTimeProvider;
+	}
&lt;p&gt; }&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/MonotonicTTLTimeProvider.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/MonotonicTTLTimeProvider.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..0b5637d36c4&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/MonotonicTTLTimeProvider.java&lt;br/&gt;
@@ -0,0 +1,73 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.streaming.tests;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.flink.runtime.state.ttl.TtlTimeProvider;&lt;br/&gt;
+&lt;br/&gt;
+import javax.annotation.concurrent.NotThreadSafe;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.Serializable;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * A stub implementation of a &lt;/p&gt;
{@link TtlTimeProvider} which guarantees that&lt;br/&gt;
+ * processing time increases monotonically.&lt;br/&gt;
+ */&lt;br/&gt;
+@NotThreadSafe&lt;br/&gt;
+final class MonotonicTTLTimeProvider implements TtlTimeProvider, Serializable {&lt;br/&gt;
+&lt;br/&gt;
+	private static final long serialVersionUID = 1L;&lt;br/&gt;
+&lt;br/&gt;
+	/*&lt;br/&gt;
+	 * The following variables are static because the whole TTLTimeProvider will go&lt;br/&gt;
+	 * through serialization and, eventually, the state backend and the task executing&lt;br/&gt;
+	 * the TtlVerifyUpdateFunction will have different instances of it.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * If these were not static, then the TtlVerifyUpdateFunction would e.g. freeze&lt;br/&gt;
+	 * the time, but the backend would not be notified about it, resulting in inconsistent&lt;br/&gt;
+	 * state.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * If the number of task slots per TM changes, then we may need to add also synchronization.&lt;br/&gt;
+	 */&lt;br/&gt;
+&lt;br/&gt;
+	private static boolean timeIsFrozen = false;&lt;br/&gt;
+&lt;br/&gt;
+	private static long lastReturnedProcessingTime = Long.MIN_VALUE;&lt;br/&gt;
+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public long currentTimestamp() {&lt;br/&gt;
+		if (timeIsFrozen &amp;amp;&amp;amp; lastReturnedProcessingTime != Long.MIN_VALUE) {
+			return lastReturnedProcessingTime;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		timeIsFrozen = true;&lt;br/&gt;
+&lt;br/&gt;
+		final long currentProcessingTime = System.currentTimeMillis();&lt;br/&gt;
+		if (currentProcessingTime &amp;lt; lastReturnedProcessingTime) {+			return lastReturnedProcessingTime;+		}&lt;br/&gt;
+&lt;br/&gt;
+		lastReturnedProcessingTime = currentProcessingTime;&lt;br/&gt;
+		return lastReturnedProcessingTime;&lt;br/&gt;
+	}&lt;br/&gt;
+&lt;br/&gt;
+	long unfreezeTime() {
+		timeIsFrozen = false;
+		return lastReturnedProcessingTime;
+	}&lt;br/&gt;
+}&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/StubStateBackend.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/StubStateBackend.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..b93fa362d7f&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/StubStateBackend.java&lt;br/&gt;
@@ -0,0 +1,94 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.streaming.tests;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.flink.api.common.JobID;&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeSerializer;&lt;br/&gt;
+import org.apache.flink.metrics.MetricGroup;&lt;br/&gt;
+import org.apache.flink.runtime.execution.Environment;&lt;br/&gt;
+import org.apache.flink.runtime.query.TaskKvStateRegistry;&lt;br/&gt;
+import org.apache.flink.runtime.state.AbstractKeyedStateBackend;&lt;br/&gt;
+import org.apache.flink.runtime.state.CheckpointStorage;&lt;br/&gt;
+import org.apache.flink.runtime.state.CompletedCheckpointStorageLocation;&lt;br/&gt;
+import org.apache.flink.runtime.state.KeyGroupRange;&lt;br/&gt;
+import org.apache.flink.runtime.state.OperatorStateBackend;&lt;br/&gt;
+import org.apache.flink.runtime.state.StateBackend;&lt;br/&gt;
+import org.apache.flink.runtime.state.ttl.TtlTimeProvider;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.IOException;&lt;br/&gt;
+&lt;br/&gt;
+import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * A stub implementation of the {@link StateBackend} that allows the use of&lt;br/&gt;
+ * a custom {@link TtlTimeProvider}
&lt;p&gt;.&lt;br/&gt;
+ */&lt;br/&gt;
+final class StubStateBackend implements StateBackend {&lt;br/&gt;
+&lt;br/&gt;
+	private static final long serialVersionUID = 1L;&lt;br/&gt;
+&lt;br/&gt;
+	private final TtlTimeProvider ttlTimeProvider;&lt;br/&gt;
+&lt;br/&gt;
+	private final StateBackend backend;&lt;br/&gt;
+&lt;br/&gt;
+	StubStateBackend(final StateBackend wrappedBackend, final TtlTimeProvider ttlTimeProvider) &lt;/p&gt;
{
+		this.backend = checkNotNull(wrappedBackend);
+		this.ttlTimeProvider = checkNotNull(ttlTimeProvider);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public CompletedCheckpointStorageLocation resolveCheckpoint(String externalPointer) throws IOException &lt;/p&gt;
{
+		return backend.resolveCheckpoint(externalPointer);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public CheckpointStorage createCheckpointStorage(JobID jobId) throws IOException &lt;/p&gt;
{
+		return backend.createCheckpointStorage(jobId);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public &amp;lt;K&amp;gt; AbstractKeyedStateBackend&amp;lt;K&amp;gt; createKeyedStateBackend(&lt;br/&gt;
+			Environment env,&lt;br/&gt;
+			JobID jobID,&lt;br/&gt;
+			String operatorIdentifier,&lt;br/&gt;
+			TypeSerializer&amp;lt;K&amp;gt; keySerializer,&lt;br/&gt;
+			int numberOfKeyGroups,&lt;br/&gt;
+			KeyGroupRange keyGroupRange,&lt;br/&gt;
+			TaskKvStateRegistry kvStateRegistry,&lt;br/&gt;
+			TtlTimeProvider ttlTimeProvider,&lt;br/&gt;
+			MetricGroup metricGroup) throws Exception &lt;/p&gt;
{
+
+		return backend.createKeyedStateBackend(
+				env,
+				jobID,
+				operatorIdentifier,
+				keySerializer,
+				numberOfKeyGroups,
+				keyGroupRange,
+				kvStateRegistry,
+				this.ttlTimeProvider,
+				metricGroup
+		);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public OperatorStateBackend createOperatorStateBackend(Environment env, String operatorIdentifier) throws Exception &lt;/p&gt;
{
+		return backend.createOperatorStateBackend(env, operatorIdentifier);
+	}
&lt;p&gt;+}&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlStateUpdate.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlStateUpdate.java&lt;br/&gt;
index e89b544cc66..20e21ead233 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlStateUpdate.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlStateUpdate.java&lt;br/&gt;
@@ -25,6 +25,9 @@&lt;/p&gt;

&lt;p&gt; /** Randomly generated keyed state updates per state type. */&lt;br/&gt;
 class TtlStateUpdate implements Serializable {&lt;br/&gt;
+&lt;br/&gt;
+	private static final long serialVersionUID = 1L;&lt;br/&gt;
+&lt;br/&gt;
 	private final int key;&lt;/p&gt;

&lt;p&gt; 	@Nonnull&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlStateUpdateSource.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlStateUpdateSource.java&lt;br/&gt;
index 6aff14e1cd3..7404adf7771 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlStateUpdateSource.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlStateUpdateSource.java&lt;br/&gt;
@@ -33,6 +33,9 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;and waits for 
{@code sleepTime}
&lt;p&gt; to continue generation.&lt;br/&gt;
  */&lt;br/&gt;
 class TtlStateUpdateSource extends RichParallelSourceFunction&amp;lt;TtlStateUpdate&amp;gt; {&lt;br/&gt;
+&lt;br/&gt;
+	private static final long serialVersionUID = 1L;&lt;br/&gt;
+&lt;br/&gt;
 	private final int maxKey;&lt;br/&gt;
 	private final long sleepAfterElements;&lt;br/&gt;
 	private final long sleepTime;&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlVerifyUpdateFunction.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlVerifyUpdateFunction.java&lt;br/&gt;
index 3cfb0e2d86e..250041d0e34 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlVerifyUpdateFunction.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/TtlVerifyUpdateFunction.java&lt;br/&gt;
@@ -33,7 +33,6 @@&lt;br/&gt;
 import org.apache.flink.streaming.tests.verify.TtlVerificationContext;&lt;br/&gt;
 import org.apache.flink.streaming.tests.verify.ValueWithTs;&lt;br/&gt;
 import org.apache.flink.util.Collector;&lt;br/&gt;
-import org.apache.flink.util.Preconditions;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import org.slf4j.Logger;&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;br/&gt;
@@ -41,12 +40,14 @@&lt;br/&gt;
 import javax.annotation.Nonnull;&lt;/p&gt;

&lt;p&gt; import java.io.Serializable;&lt;br/&gt;
-import java.util.Collections;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.stream.Collectors;&lt;br/&gt;
 import java.util.stream.StreamSupport;&lt;/p&gt;

&lt;p&gt;+import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
+import static org.apache.flink.util.Preconditions.checkState;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Update state with TTL for each verifier.&lt;br/&gt;
  *&lt;br/&gt;
@@ -62,21 +63,26 @@&lt;/li&gt;
	&lt;li&gt;- verifies last update against previous updates&lt;/li&gt;
	&lt;li&gt;- emits verification context in case of failure&lt;br/&gt;
  */&lt;br/&gt;
-class TtlVerifyUpdateFunction&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;extends RichFlatMapFunction&amp;lt;TtlStateUpdate, String&amp;gt; implements CheckpointedFunction {&lt;br/&gt;
+class TtlVerifyUpdateFunction extends RichFlatMapFunction&amp;lt;TtlStateUpdate, String&amp;gt; implements CheckpointedFunction {&lt;br/&gt;
+&lt;br/&gt;
+	private static final long serialVersionUID = 1L;&lt;br/&gt;
+&lt;br/&gt;
 	private static final Logger LOG = LoggerFactory.getLogger(TtlVerifyUpdateFunction.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Nonnull&lt;br/&gt;
 	private final StateTtlConfig ttlConfig;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final long ttl;&lt;br/&gt;
+	private final MonotonicTTLTimeProvider ttlTimeProvider;&lt;br/&gt;
 	private final UpdateStat stat;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	private transient Map&amp;lt;String, State&amp;gt; states;&lt;br/&gt;
 	private transient Map&amp;lt;String, ListState&amp;lt;ValueWithTs&amp;lt;?&amp;gt;&amp;gt;&amp;gt; prevUpdatesByVerifierId;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TtlVerifyUpdateFunction(@Nonnull StateTtlConfig ttlConfig, long reportStatAfterUpdatesNum) {&lt;br/&gt;
+	TtlVerifyUpdateFunction(&lt;br/&gt;
+			@Nonnull StateTtlConfig ttlConfig,&lt;br/&gt;
+			MonotonicTTLTimeProvider ttlTimeProvider,&lt;br/&gt;
+			long reportStatAfterUpdatesNum) 
{
 		this.ttlConfig = ttlConfig;
-		this.ttl = ttlConfig.getTtl().toMilliseconds();
+		this.ttlTimeProvider = checkNotNull(ttlTimeProvider);
 		this.stat = new UpdateStat(reportStatAfterUpdatesNum);
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -91,17 +97,13 @@ public void flatMap(TtlStateUpdate updates, Collector&amp;lt;String&amp;gt; out) throws Except&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt; 	private TtlVerificationContext&amp;lt;?, ?&amp;gt; generateUpdateAndVerificationContext(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TtlStateUpdate updates, TtlStateVerifier&amp;lt;?, ?&amp;gt; verifier) throws Exception {&lt;br/&gt;
+			TtlStateUpdate updates,&lt;br/&gt;
+			TtlStateVerifier&amp;lt;?, ?&amp;gt; verifier) throws Exception {&lt;br/&gt;
+&lt;br/&gt;
 		List&amp;lt;ValueWithTs&amp;lt;?&amp;gt;&amp;gt; prevUpdates = getPrevUpdates(verifier.getId());&lt;br/&gt;
 		Object update = updates.getUpdate(verifier.getId());&lt;br/&gt;
 		TtlUpdateContext&amp;lt;?, ?&amp;gt; updateContext = performUpdate(verifier, update);&lt;/li&gt;
	&lt;li&gt;boolean clashes = updateClashesWithPrevUpdates(updateContext.getUpdateWithTs(), prevUpdates);&lt;/li&gt;
	&lt;li&gt;if (clashes) 
{
-			resetState(verifier.getId());
-			prevUpdates = Collections.emptyList();
-			updateContext = performUpdate(verifier, update);
-		}&lt;/li&gt;
	&lt;li&gt;stat.update(clashes, prevUpdates.size());&lt;br/&gt;
+		stat.update(prevUpdates.size());&lt;br/&gt;
 		prevUpdatesByVerifierId.get(verifier.getId()).add(updateContext.getUpdateWithTs());&lt;br/&gt;
 		return new TtlVerificationContext&amp;lt;&amp;gt;(updates.getKey(), verifier.getId(), prevUpdates, updateContext);&lt;br/&gt;
 	}&lt;br/&gt;
@@ -113,33 +115,22 @@ public void flatMap(TtlStateUpdate updates, Collector&amp;lt;String&amp;gt; out) throws Except&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	private TtlUpdateContext&amp;lt;?, ?&amp;gt; performUpdate(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TtlStateVerifier&amp;lt;?, ?&amp;gt; verifier, Object update) throws Exception {&lt;br/&gt;
+			TtlStateVerifier&amp;lt;?, ?&amp;gt; verifier,&lt;br/&gt;
+			Object update) throws Exception 
{
+
+		final long timestampBeforeUpdate = ttlTimeProvider.currentTimestamp();
 		State state = states.get(verifier.getId());
-		long timestampBeforeUpdate = System.currentTimeMillis();
 		Object valueBeforeUpdate = verifier.get(state);
 		verifier.update(state, update);
 		Object updatedValue = verifier.get(state);
-		return new TtlUpdateContext&amp;lt;&amp;gt;(timestampBeforeUpdate,
-			valueBeforeUpdate, update, updatedValue, System.currentTimeMillis());
-	}
&lt;p&gt;+		final long timestampAfterUpdate = ttlTimeProvider.unfreezeTime();&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private boolean updateClashesWithPrevUpdates(ValueWithTs&amp;lt;?&amp;gt; update, List&amp;lt;ValueWithTs&amp;lt;?&amp;gt;&amp;gt; prevUpdates) 
{
-		return tooSlow(update) ||
-			(!prevUpdates.isEmpty() &amp;amp;&amp;amp; prevUpdates.stream().anyMatch(pu -&amp;gt; updatesClash(pu, update)));
-	}
&lt;p&gt;-&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;private boolean tooSlow(ValueWithTs&amp;lt;?&amp;gt; update) 
{
-		return update.getTimestampAfterUpdate() - update.getTimestampBeforeUpdate() &amp;gt;= ttl;
-	}
&lt;p&gt;+		checkState(&lt;br/&gt;
+				timestampAfterUpdate == timestampBeforeUpdate,&lt;br/&gt;
+				&quot;Timestamps before and after the update do not match.&quot;&lt;br/&gt;
+		);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private boolean updatesClash(ValueWithTs&amp;lt;?&amp;gt; prevUpdate, ValueWithTs&amp;lt;?&amp;gt; nextUpdate) 
{
-		return prevUpdate.getTimestampAfterUpdate() + ttl &amp;gt;= nextUpdate.getTimestampBeforeUpdate() &amp;amp;&amp;amp;
-			prevUpdate.getTimestampBeforeUpdate() + ttl &amp;lt;= nextUpdate.getTimestampAfterUpdate();
-	}
&lt;p&gt;-&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;private void resetState(String verifierId) 
{
-		states.get(verifierId).clear();
-		prevUpdatesByVerifierId.get(verifierId).clear();
+		return new TtlUpdateContext&amp;lt;&amp;gt;(valueBeforeUpdate, update, updatedValue, timestampAfterUpdate);
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Override&lt;br/&gt;
@@ -153,7 +144,7 @@ public void initializeState(FunctionInitializationContext context) {&lt;br/&gt;
 			.collect(Collectors.toMap(TtlStateVerifier::getId, v -&amp;gt; v.createState(context, ttlConfig)));&lt;br/&gt;
 		prevUpdatesByVerifierId = TtlStateVerifier.VERIFIERS.stream()&lt;br/&gt;
 			.collect(Collectors.toMap(TtlStateVerifier::getId, v -&amp;gt; {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Preconditions.checkNotNull(v);&lt;br/&gt;
+				checkNotNull(v);&lt;br/&gt;
 				TypeSerializer&amp;lt;ValueWithTs&amp;lt;?&amp;gt;&amp;gt; typeSerializer = new ValueWithTs.Serializer(v.getUpdateSerializer());&lt;br/&gt;
 				ListStateDescriptor&amp;lt;ValueWithTs&amp;lt;?&amp;gt;&amp;gt; stateDesc = new ListStateDescriptor&amp;lt;&amp;gt;(&lt;br/&gt;
 					&quot;TtlPrevValueState_&quot; + v.getId(), typeSerializer);&lt;br/&gt;
@@ -165,22 +156,17 @@ public void initializeState(FunctionInitializationContext context) {&lt;br/&gt;
 	private static class UpdateStat implements Serializable {&lt;br/&gt;
 		final long reportStatAfterUpdatesNum;&lt;br/&gt;
 		long updates = 0;&lt;/li&gt;
	&lt;li&gt;long clashes = 0;&lt;br/&gt;
 		long prevUpdatesNum = 0;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		UpdateStat(long reportStatAfterUpdatesNum) &lt;/p&gt;
{
 			this.reportStatAfterUpdatesNum = reportStatAfterUpdatesNum;
 		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;void update(boolean clash, long prevUpdatesSize) {&lt;br/&gt;
+		void update(long prevUpdatesSize) {&lt;br/&gt;
 			updates++;&lt;/li&gt;
	&lt;li&gt;if (clash) 
{
-				clashes++;
-			}
&lt;p&gt; 			prevUpdatesNum += prevUpdatesSize;&lt;br/&gt;
 			if (updates % reportStatAfterUpdatesNum == 0) &lt;/p&gt;
{
-				LOG.info(String.format(&quot;Avg update chain length: %d, clash stat: %d/%d&quot;,
-					prevUpdatesNum / updates, clashes, updates));
+				LOG.info(String.format(&quot;Avg update chain length: %d&quot;, prevUpdatesNum / updates));
 			}
&lt;p&gt; 		}&lt;br/&gt;
 	}&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/AbstractTtlStateVerifier.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/AbstractTtlStateVerifier.java&lt;br/&gt;
index 7b6def24204..46becbbbc18 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/AbstractTtlStateVerifier.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/AbstractTtlStateVerifier.java&lt;br/&gt;
@@ -86,15 +86,18 @@ public void update(@Nonnull State state, Object update) throws Exception {&lt;br/&gt;
 	@Override&lt;br/&gt;
 	public boolean verify(@Nonnull TtlVerificationContext&amp;lt;?, ?&amp;gt; verificationContextRaw) 
{
 		TtlVerificationContext&amp;lt;UV, GV&amp;gt; verificationContext = (TtlVerificationContext&amp;lt;UV, GV&amp;gt;) verificationContextRaw;
-		List&amp;lt;ValueWithTs&amp;lt;UV&amp;gt;&amp;gt; updates = new ArrayList&amp;lt;&amp;gt;(verificationContext.getPrevUpdates());
-		long currentTimestamp = verificationContext.getUpdateContext().getTimestampBeforeUpdate();
-		GV prevValue = expected(updates, currentTimestamp);
+		long currentTimestamp = verificationContext.getUpdateContext().getTimestamp();
+
 		GV valueBeforeUpdate = verificationContext.getUpdateContext().getValueBeforeUpdate();
+		List&amp;lt;ValueWithTs&amp;lt;UV&amp;gt;&amp;gt; updates = new ArrayList&amp;lt;&amp;gt;(verificationContext.getPrevUpdates());
+		GV expectedValueBeforeUpdate = expected(updates, currentTimestamp);
+
+		GV valueAfterUpdate = verificationContext.getUpdateContext().getValueAfterUpdate();
 		ValueWithTs&amp;lt;UV&amp;gt; update = verificationContext.getUpdateContext().getUpdateWithTs();
-		GV updatedValue = verificationContext.getUpdateContext().getUpdatedValue();
 		updates.add(update);
-		GV expectedValue = expected(updates, currentTimestamp);
-		return Objects.equals(valueBeforeUpdate, prevValue) &amp;amp;&amp;amp; Objects.equals(updatedValue, expectedValue);
+		GV expectedValueAfterUpdate = expected(updates, currentTimestamp);
+
+		return Objects.equals(valueBeforeUpdate, expectedValueBeforeUpdate) &amp;amp;&amp;amp; Objects.equals(valueAfterUpdate, expectedValueAfterUpdate);
 	}&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	abstract GV expected(@Nonnull List&amp;lt;ValueWithTs&amp;lt;UV&amp;gt;&amp;gt; updates, long currentTimestamp);&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlAggregatingStateVerifier.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlAggregatingStateVerifier.java&lt;br/&gt;
index 960bbe72401..8a629578679 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlAggregatingStateVerifier.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlAggregatingStateVerifier.java&lt;br/&gt;
@@ -71,13 +71,13 @@ String expected(@Nonnull List&amp;lt;ValueWithTs&amp;lt;Integer&amp;gt;&amp;gt; updates, long currentTimesta&lt;br/&gt;
 			return null;&lt;br/&gt;
 		}&lt;br/&gt;
 		long acc = AGG_FUNC.createAccumulator();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;long lastTs = updates.get(0).getTimestampAfterUpdate();&lt;br/&gt;
+		long lastTs = updates.get(0).getTimestamp();&lt;br/&gt;
 		for (ValueWithTs&amp;lt;Integer&amp;gt; update : updates) {&lt;/li&gt;
	&lt;li&gt;if (expired(lastTs, update.getTimestampAfterUpdate())) {&lt;br/&gt;
+			if (expired(lastTs, update.getTimestamp())) 
{
 				acc = AGG_FUNC.createAccumulator();
 			}
&lt;p&gt; 			acc = AGG_FUNC.add(update.getValue(), acc);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;lastTs = update.getTimestampAfterUpdate();&lt;br/&gt;
+			lastTs = update.getTimestamp();&lt;br/&gt;
 		}&lt;br/&gt;
 		return expired(lastTs, currentTimestamp) ? null : AGG_FUNC.getResult(acc);&lt;br/&gt;
 	}&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlFoldingStateVerifier.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlFoldingStateVerifier.java&lt;br/&gt;
index c1cc761b0f3..bcc85905863 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlFoldingStateVerifier.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlFoldingStateVerifier.java&lt;br/&gt;
@@ -74,13 +74,13 @@ Long expected(@Nonnull List&amp;lt;ValueWithTs&amp;lt;Integer&amp;gt;&amp;gt; updates, long currentTimestamp&lt;br/&gt;
 			return null;&lt;br/&gt;
 		}&lt;br/&gt;
 		long acc = INIT_VAL;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;long lastTs = updates.get(0).getTimestampAfterUpdate();&lt;br/&gt;
+		long lastTs = updates.get(0).getTimestamp();&lt;br/&gt;
 		for (ValueWithTs&amp;lt;Integer&amp;gt; update : updates) {&lt;/li&gt;
	&lt;li&gt;if (expired(lastTs, update.getTimestampAfterUpdate())) {&lt;br/&gt;
+			if (expired(lastTs, update.getTimestamp())) 
{
 				acc = INIT_VAL;
 			}
&lt;p&gt; 			acc += update.getValue();&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;lastTs = update.getTimestampAfterUpdate();&lt;br/&gt;
+			lastTs = update.getTimestamp();&lt;br/&gt;
 		}&lt;br/&gt;
 		return expired(lastTs, currentTimestamp) ? null : acc;&lt;br/&gt;
 	}&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlListStateVerifier.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlListStateVerifier.java&lt;br/&gt;
index b355aa9861a..4aed98ffd2f 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlListStateVerifier.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlListStateVerifier.java&lt;br/&gt;
@@ -71,7 +71,7 @@ void updateInternal(@Nonnull ListState&amp;lt;String&amp;gt; state, String update) throws Exce&lt;br/&gt;
 	@Nonnull&lt;br/&gt;
 	List&amp;lt;String&amp;gt; expected(@Nonnull List&amp;lt;ValueWithTs&amp;lt;String&amp;gt;&amp;gt; updates, long currentTimestamp) 
{
 		return updates.stream()
-			.filter(u -&amp;gt; !expired(u.getTimestampAfterUpdate(), currentTimestamp))
+			.filter(u -&amp;gt; !expired(u.getTimestamp(), currentTimestamp))
 			.map(ValueWithTs::getValue)
 			.collect(Collectors.toList());
 	}
&lt;p&gt;diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlMapStateVerifier.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlMapStateVerifier.java&lt;br/&gt;
index a9d6b36f62f..eeda78d73c2 100644&lt;/p&gt;&lt;/li&gt;
			&lt;li&gt;a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlMapStateVerifier.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlMapStateVerifier.java&lt;br/&gt;
@@ -87,7 +87,7 @@ void updateInternal(@Nonnull MapState&amp;lt;String, String&amp;gt; state, Tuple2&amp;lt;String, Stri&lt;br/&gt;
 			.collect(Collectors.groupingBy(u -&amp;gt; u.getValue().f0))&lt;br/&gt;
 			.entrySet().stream()&lt;br/&gt;
 			.map(e -&amp;gt; e.getValue().get(e.getValue().size() - 1))&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;.filter(u -&amp;gt; !expired(u.getTimestampAfterUpdate(), currentTimestamp))&lt;br/&gt;
+			.filter(u -&amp;gt; !expired(u.getTimestamp(), currentTimestamp))&lt;br/&gt;
 			.map(ValueWithTs::getValue)&lt;br/&gt;
 			.collect(Collectors.toMap(u -&amp;gt; u.f0, u -&amp;gt; u.f1));&lt;br/&gt;
 	}&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlReducingStateVerifier.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlReducingStateVerifier.java&lt;br/&gt;
index 773be05e04b..cd33ed08f4e 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlReducingStateVerifier.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlReducingStateVerifier.java&lt;br/&gt;
@@ -73,13 +73,13 @@ Integer expected(@Nonnull List&amp;lt;ValueWithTs&amp;lt;Integer&amp;gt;&amp;gt; updates, long currentTimest&lt;br/&gt;
 			return null;&lt;br/&gt;
 		}&lt;br/&gt;
 		int acc = 0;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;long lastTs = updates.get(0).getTimestampAfterUpdate();&lt;br/&gt;
+		long lastTs = updates.get(0).getTimestamp();&lt;br/&gt;
 		for (ValueWithTs&amp;lt;Integer&amp;gt; update : updates) {&lt;/li&gt;
	&lt;li&gt;if (expired(lastTs, update.getTimestampAfterUpdate())) {&lt;br/&gt;
+			if (expired(lastTs, update.getTimestamp())) 
{
 				acc = 0;
 			}
&lt;p&gt; 			acc += update.getValue();&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;lastTs = update.getTimestampAfterUpdate();&lt;br/&gt;
+			lastTs = update.getTimestamp();&lt;br/&gt;
 		}&lt;br/&gt;
 		return expired(lastTs, currentTimestamp) ? null : acc;&lt;br/&gt;
 	}&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlUpdateContext.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlUpdateContext.java&lt;br/&gt;
index 959340b408d..61bf9e22c63 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlUpdateContext.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlUpdateContext.java&lt;br/&gt;
@@ -24,25 +24,25 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; /** Contains context relevant for state update with TTL. */&lt;br/&gt;
 public class TtlUpdateContext&amp;lt;UV, GV&amp;gt; implements Serializable {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final long timestampBeforeUpdate;&lt;br/&gt;
+&lt;br/&gt;
 	private final GV valueBeforeUpdate;&lt;br/&gt;
 	private final UV update;&lt;/li&gt;
	&lt;li&gt;private final GV updatedValue;&lt;/li&gt;
	&lt;li&gt;private final long timestampAfterUpdate;&lt;br/&gt;
+	private final GV valueAfterUpdate;&lt;br/&gt;
+	private final long timestamp;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	public TtlUpdateContext(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;long timestampBeforeUpdate,&lt;/li&gt;
	&lt;li&gt;GV valueBeforeUpdate, UV update, GV updatedValue,&lt;/li&gt;
	&lt;li&gt;long timestampAfterUpdate) {&lt;br/&gt;
+			GV valueBeforeUpdate,&lt;br/&gt;
+			UV update,&lt;br/&gt;
+			GV updatedValue,&lt;br/&gt;
+			long timestamp) 
{
 		this.valueBeforeUpdate = valueBeforeUpdate;
 		this.update = update;
-		this.updatedValue = updatedValue;
-		this.timestampBeforeUpdate = timestampBeforeUpdate;
-		this.timestampAfterUpdate = timestampAfterUpdate;
+		this.valueAfterUpdate = updatedValue;
+		this.timestamp = timestamp;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;long getTimestampBeforeUpdate() {&lt;/li&gt;
	&lt;li&gt;return timestampBeforeUpdate;&lt;br/&gt;
+	long getTimestamp() 
{
+		return timestamp;
 	}&lt;br/&gt;
 &lt;br/&gt;
 	GV getValueBeforeUpdate() {&lt;br/&gt;
@@ -51,21 +51,20 @@ GV getValueBeforeUpdate() {&lt;br/&gt;
 &lt;br/&gt;
 	@Nonnull&lt;br/&gt;
 	public ValueWithTs&amp;lt;UV&amp;gt; getUpdateWithTs() {
-		return new ValueWithTs&amp;lt;&amp;gt;(update, timestampBeforeUpdate, timestampAfterUpdate);
+		return new ValueWithTs&amp;lt;&amp;gt;(update, timestamp);
 	}&lt;br/&gt;
 &lt;br/&gt;
-	GV getUpdatedValue() {&lt;br/&gt;
-		return updatedValue;&lt;br/&gt;
+	GV getValueAfterUpdate() {
+		return valueAfterUpdate;
 	}&lt;br/&gt;
 &lt;br/&gt;
 	@Override&lt;br/&gt;
 	public String toString() {&lt;br/&gt;
 		return &quot;TtlUpdateContext{&quot; +
-			&quot;timestampBeforeUpdate=&quot; + timestampBeforeUpdate +
-			&quot;, valueBeforeUpdate=&quot; + valueBeforeUpdate +
+			&quot;valueBeforeUpdate=&quot; + valueBeforeUpdate +
 			&quot;, update=&quot; + update +
-			&quot;, updatedValue=&quot; + updatedValue +
-			&quot;, timestampAfterUpdate=&quot; + timestampAfterUpdate +
+			&quot;, valueAfterUpdate=&quot; + valueAfterUpdate +
+			&quot;, timestamp=&quot; + timestamp +
 			&apos;}&apos;;&lt;br/&gt;
 	}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlValueStateVerifier.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlValueStateVerifier.java&lt;br/&gt;
index fa4929b933f..d8bdfd4e79d 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlValueStateVerifier.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlValueStateVerifier.java&lt;br/&gt;
@@ -61,6 +61,6 @@ String expected(@Nonnull List&amp;lt;ValueWithTs&amp;lt;String&amp;gt;&amp;gt; updates, long currentTimestam&lt;br/&gt;
 			return null;&lt;br/&gt;
 		}&lt;br/&gt;
 		ValueWithTs&amp;lt;String&amp;gt; lastUpdate = updates.get(updates.size() - 1);&lt;br/&gt;
-		return expired(lastUpdate.getTimestampAfterUpdate(), currentTimestamp) ? null : lastUpdate.getValue();&lt;br/&gt;
+		return expired(lastUpdate.getTimestamp(), currentTimestamp) ? null : lastUpdate.getValue();&lt;br/&gt;
 	}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlVerificationContext.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlVerificationContext.java&lt;br/&gt;
index 4c985cd525b..6d04c4cb219 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlVerificationContext.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/TtlVerificationContext.java&lt;br/&gt;
@@ -36,10 +36,10 @@&lt;br/&gt;
 &lt;br/&gt;
 	@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
 	public TtlVerificationContext(&lt;br/&gt;
-		int key,&lt;br/&gt;
-		@Nonnull String verifierId,&lt;br/&gt;
-		@Nonnull List&amp;lt;ValueWithTs&amp;lt;?&amp;gt;&amp;gt; prevUpdates,&lt;br/&gt;
-		@Nonnull TtlUpdateContext&amp;lt;?, ?&amp;gt; updateContext) {&lt;br/&gt;
+			int key,&lt;br/&gt;
+			@Nonnull String verifierId,&lt;br/&gt;
+			@Nonnull List&amp;lt;ValueWithTs&amp;lt;?&amp;gt;&amp;gt; prevUpdates,&lt;br/&gt;
+			@Nonnull TtlUpdateContext&amp;lt;?, ?&amp;gt; updateContext) {&lt;br/&gt;
 		this.key = key;&lt;br/&gt;
 		this.verifierId = verifierId;&lt;br/&gt;
 		this.prevUpdates = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
diff --git a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/ValueWithTs.java b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/ValueWithTs.java&lt;br/&gt;
index 9302377d9ed..a4f30804e4f 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/ValueWithTs.java&lt;br/&gt;
+++ b/flink-end-to-end-tests/flink-stream-state-ttl-test/src/main/java/org/apache/flink/streaming/tests/verify/ValueWithTs.java&lt;br/&gt;
@@ -30,33 +30,26 @@&lt;br/&gt;
 /** User state value with timestamps before and after update. */&lt;br/&gt;
 public class ValueWithTs&amp;lt;V&amp;gt; implements Serializable {&lt;br/&gt;
 	private final V value;&lt;br/&gt;
-	private final long timestampBeforeUpdate;&lt;br/&gt;
-	private final long timestampAfterUpdate;&lt;br/&gt;
+	private final long timestamp;&lt;br/&gt;
 &lt;br/&gt;
-	public ValueWithTs(V value, long timestampBeforeUpdate, long timestampAfterUpdate) {&lt;br/&gt;
+	public ValueWithTs(V value, long timestamp) {
 		this.value = value;
-		this.timestampBeforeUpdate = timestampBeforeUpdate;
-		this.timestampAfterUpdate = timestampAfterUpdate;
+		this.timestamp = timestamp;
 	}&lt;br/&gt;
 &lt;br/&gt;
 	V getValue() {
 		return value;
 	}&lt;br/&gt;
 &lt;br/&gt;
-	public long getTimestampBeforeUpdate() {
-		return timestampBeforeUpdate;
-	}&lt;br/&gt;
-&lt;br/&gt;
-	public long getTimestampAfterUpdate() {&lt;br/&gt;
-		return timestampAfterUpdate;&lt;br/&gt;
+	long getTimestamp() {+		return timestamp; 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Override&lt;br/&gt;
 	public String toString() {&lt;br/&gt;
 		return &quot;ValueWithTs&lt;/p&gt;
{&quot; +
 			&quot;value=&quot; + value +
-			&quot;, timestampBeforeUpdate=&quot; + timestampBeforeUpdate +
-			&quot;, timestampAfterUpdate=&quot; + timestampAfterUpdate +
+			&quot;, timestamp=&quot; + timestamp +
 			&apos;}
&lt;p&gt;&apos;;&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;@@ -64,7 +57,7 @@ public String toString() {&lt;br/&gt;
 	public static class Serializer extends CompositeSerializer&amp;lt;ValueWithTs&amp;lt;?&amp;gt;&amp;gt; {&lt;/p&gt;

&lt;p&gt; 		public Serializer(TypeSerializer&amp;lt;?&amp;gt; userValueSerializer) &lt;/p&gt;
{
-			super(true, userValueSerializer, LongSerializer.INSTANCE, LongSerializer.INSTANCE);
+			super(true, userValueSerializer, LongSerializer.INSTANCE);
 		}

&lt;p&gt; 		@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
@@ -74,7 +67,7 @@ public Serializer(TypeSerializer&amp;lt;?&amp;gt; userValueSerializer) {&lt;/p&gt;

&lt;p&gt; 		@Override&lt;br/&gt;
 		public ValueWithTs&amp;lt;?&amp;gt; createInstance(@Nonnull Object ... values) &lt;/p&gt;
{
-			return new ValueWithTs&amp;lt;&amp;gt;(values[0], (Long) values[1], (Long) values[2]);
+			return new ValueWithTs&amp;lt;&amp;gt;(values[0], (Long) values[1]);
 		}

&lt;p&gt; 		@Override&lt;br/&gt;
@@ -88,9 +81,7 @@ protected Object getField(@Nonnull ValueWithTs&amp;lt;?&amp;gt; value, int index) &lt;/p&gt;
{
 				case 0:
 					return value.getValue();
 				case 1:
-					return value.getTimestampBeforeUpdate();
-				case 2:
-					return value.getTimestampAfterUpdate();
+					return value.getTimestamp();
 				default:
 					throw new FlinkRuntimeException(&quot;Unexpected field index for ValueWithTs&quot;);
 			}
&lt;p&gt;@@ -99,8 +90,8 @@ protected Object getField(@Nonnull ValueWithTs&amp;lt;?&amp;gt; value, int index) {&lt;br/&gt;
 		@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
 		@Override&lt;br/&gt;
 		protected CompositeSerializer&amp;lt;ValueWithTs&amp;lt;?&amp;gt;&amp;gt; createSerializerInstance(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;PrecomputedParameters precomputed,&lt;/li&gt;
	&lt;li&gt;TypeSerializer&amp;lt;?&amp;gt;... originalSerializers) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				PrecomputedParameters precomputed,+				TypeSerializer&amp;lt;?&amp;gt;... originalSerializers) {
 			return new Serializer(precomputed, (TypeSerializer&amp;lt;Object&amp;gt;) originalSerializers[0]);
 		} 	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16689926" author="kkl0u" created="Fri, 16 Nov 2018 19:34:12 +0000"  >&lt;p&gt;Merged on master with 52c2ad04c25f277ed65b164f53ce278a7380f058&lt;br/&gt;
and on release-1.7 with a66b2676fa4576f0d1e20c82612fb6b71a32b76c&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13197134">FLINK-10830</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13197137">FLINK-10831</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3z3hj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>