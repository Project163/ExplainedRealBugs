<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:20:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-27519] Fix duplicates names when there are multiple levels of over window aggregate</title>
                <link>https://issues.apache.org/jira/browse/FLINK-27519</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;A similar&#160; issue like &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22121&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;FLINK-22121&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And can be reproduced by adding this unit test&#160;&lt;/p&gt;

&lt;p&gt;org.apache.flink.table.planner.plan.stream.sql.agg.GroupWindowTest#testWindowAggregateWithAnotherWindowAggregate&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//&#20195;&#30721;&#21344;&#20301;&#31526;
&lt;/span&gt;@Test
def testWindowAggregateWithAnotherWindowAggregate(): Unit = {
  val sql =
    &quot;&quot;&quot;
      |SELECT CAST(pv AS INT) AS pv, CAST(uv AS INT) AS uv FROM (
      |  SELECT *, count(distinct(c)) over (partition by a order by b desc) AS uv
      |  FROM (
      |    SELECT *, count(*) over (partition by a, c order by b desc) AS pv
      |    FROM MyTable
      |  )
      |)
      |&quot;&quot;&quot;.stripMargin
  util.verifyExecPlan(sql)
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The error message :&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;


&lt;span class=&quot;code-comment&quot;&gt;//&#20195;&#30721;&#21344;&#20301;&#31526;
&lt;/span&gt;org.apache.flink.table.api.ValidationException: Field names must be unique. Found duplicates: [w0$o0]&#160; &#160; at org.apache.flink.table.types.logical.RowType.validateFields(RowType.java:273)
&#160; &#160; at org.apache.flink.table.types.logical.RowType.&amp;lt;init&amp;gt;(RowType.java:158)
&#160; &#160; at org.apache.flink.table.types.logical.RowType.of(RowType.java:298)
&#160; &#160; at org.apache.flink.table.types.logical.RowType.of(RowType.java:290)
&#160; &#160; at org.apache.flink.table.planner.calcite.FlinkTypeFactory$.toLogicalRowType(FlinkTypeFactory.scala:663)
&#160; &#160; at org.apache.flink.table.planner.plan.nodes.physical.stream.StreamPhysicalOverAggregate.translateToExecNode(StreamPhysicalOverAggregate.scala:57)
&#160; &#160; at org.apache.flink.table.planner.plan.nodes.exec.ExecNodeGraphGenerator.generate(ExecNodeGraphGenerator.java:74)
&#160; &#160; at org.apache.flink.table.planner.plan.nodes.exec.ExecNodeGraphGenerator.generate(ExecNodeGraphGenerator.java:71)
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think we can add come logical in&#160; FlinkLogicalOverAggregate&#160; to avoid duplicate names of&#160; output rowType.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13443519">FLINK-27519</key>
            <summary>Fix duplicates names when there are multiple levels of over window aggregate</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lincoln.86xy">lincoln lee</assignee>
                                    <reporter username="hackergin">Feng Jin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 May 2022 04:18:03 +0000</created>
                <updated>Mon, 2 Sep 2024 09:28:10 +0000</updated>
                            <resolved>Tue, 6 Aug 2024 11:41:05 +0000</resolved>
                                    <version>1.15.0</version>
                                    <fixVersion>2.0-preview</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17532615" author="hackergin" created="Fri, 6 May 2022 04:19:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TsReaper&quot; class=&quot;user-hover&quot; rel=&quot;TsReaper&quot;&gt;TsReaper&lt;/a&gt;&#160; Can you help to confirm this issue.&#160;&lt;/p&gt;

&lt;p&gt;If this is a problem , I can help to fix this.&#160;&lt;/p&gt;</comment>
                            <comment id="17532737" author="paul8263" created="Fri, 6 May 2022 09:36:42 +0000"  >&lt;p&gt;Hi all,&lt;/p&gt;

&lt;p&gt;It should be an issue of Calcite. Calcite will translate the logical field name of over window aggregation to w&amp;lt;window-index&amp;gt;$o&amp;lt;over-index&amp;gt;. Currently all aggregates must be computed on the same window. If the SQL is like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select agg1(*) over (partition by a order by b), agg2(*) over (partition by a order by b)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The two logical fields would be translated to w0$o0 and w0$o1.&lt;/p&gt;

&lt;p&gt;However, it seems that the field name replacement does not work well with nested over window SQL, which will result in duplication of field names.&lt;/p&gt;</comment>
                            <comment id="17532788" author="martijnvisser" created="Fri, 6 May 2022 11:14:18 +0000"  >&lt;p&gt;Could it be that this issue is actually already resolved in Calcite (since we&apos;re not running on the latest version) ? &lt;/p&gt;</comment>
                            <comment id="17532816" author="paul8263" created="Fri, 6 May 2022 12:00:04 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;I am not sure about this, as in the latest version of Calcite I find some similar codes. &#160;This problem is caused by ProjectToWindowRule. When we use HepPlanner and apply this rule from inner nested SQL to outter one, we will get duplicated field names for over aggregation fields.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17533219" author="paul8263" created="Sat, 7 May 2022 08:02:36 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hackergin&quot; class=&quot;user-hover&quot; rel=&quot;hackergin&quot;&gt;hackergin&lt;/a&gt;&#160;&#65292;&lt;/p&gt;

&lt;p&gt;FlinkLogicalOverAggregate&#160; is in VolcanoPlanner. After debug I found the row names have already been&#160; duplicated before applying `LOGICAL_CONVERTERS`&#12290;This issue is caused by rule sets in HepPlanner.&lt;/p&gt;

&lt;p&gt;Correct me if I am wrong.&lt;/p&gt;</comment>
                            <comment id="17533221" author="hackergin" created="Sat, 7 May 2022 08:08:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paul8263&quot; class=&quot;user-hover&quot; rel=&quot;paul8263&quot;&gt;paul8263&lt;/a&gt;&#160; Yes, &#160;there are already duplicate column names before the LOGICAL_CONVERTERS rule is applied,&#160; &#160; I think the easiest way is to modify FlinkLogicalOverAggregate&#160; if&#160; it cannot be fixed in calcite currently.&#160;&lt;/p&gt;</comment>
                            <comment id="17533238" author="paul8263" created="Sat, 7 May 2022 09:37:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hackergin&quot; class=&quot;user-hover&quot; rel=&quot;hackergin&quot;&gt;hackergin&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TsReaper&quot; class=&quot;user-hover&quot; rel=&quot;TsReaper&quot;&gt;TsReaper&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I created a demo using Calcite HepPlanner and ProjectToWindowRule.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SchemaPlus schemaPlus = Frameworks.createRootSchema(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

schemaPlus.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;T&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReflectiveSchema(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TestSchema()));
Frameworks.ConfigBuilder configBuilder = Frameworks.newConfigBuilder();

configBuilder.defaultSchema(schemaPlus);

FrameworkConfig frameworkConfig = configBuilder.build();

SqlParser.ConfigBuilder parserConfig = SqlParser.configBuilder(frameworkConfig.getParserConfig());

parserConfig.setCaseSensitive(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;).setConfig(parserConfig.build());

Planner planner = Frameworks.getPlanner(frameworkConfig);

SqlNode sqlNode;
RelRoot relRoot = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {

    sqlNode = planner.parse(
        &lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT *, count(distinct(\&quot;&lt;/span&gt;z\&lt;span class=&quot;code-quote&quot;&gt;&quot;.\&quot;&lt;/span&gt;o\&lt;span class=&quot;code-quote&quot;&gt;&quot;)) over (partition by \&quot;&lt;/span&gt;z\&lt;span class=&quot;code-quote&quot;&gt;&quot;.\&quot;&lt;/span&gt;s\&lt;span class=&quot;code-quote&quot;&gt;&quot; order by \&quot;&lt;/span&gt;z\&lt;span class=&quot;code-quote&quot;&gt;&quot;.\&quot;&lt;/span&gt;p\&lt;span class=&quot;code-quote&quot;&gt;&quot; desc) as uv&quot;&lt;/span&gt; +
        &lt;span class=&quot;code-quote&quot;&gt;&quot;  FROM (&quot;&lt;/span&gt; +
        &lt;span class=&quot;code-quote&quot;&gt;&quot;    SELECT *, count(*) over (partition by \&quot;&lt;/span&gt;t\&lt;span class=&quot;code-quote&quot;&gt;&quot;.\&quot;&lt;/span&gt;s\&lt;span class=&quot;code-quote&quot;&gt;&quot;, \&quot;&lt;/span&gt;t\&lt;span class=&quot;code-quote&quot;&gt;&quot;.\&quot;&lt;/span&gt;o\&lt;span class=&quot;code-quote&quot;&gt;&quot; order by \&quot;&lt;/span&gt;t\&lt;span class=&quot;code-quote&quot;&gt;&quot;.\&quot;&lt;/span&gt;p\&lt;span class=&quot;code-quote&quot;&gt;&quot; desc) as pv&quot;&lt;/span&gt; +
        &lt;span class=&quot;code-quote&quot;&gt;&quot;    FROM \&quot;&lt;/span&gt;T\&lt;span class=&quot;code-quote&quot;&gt;&quot;.\&quot;&lt;/span&gt;rdf\&lt;span class=&quot;code-quote&quot;&gt;&quot; \&quot;&lt;/span&gt;t\&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; +
        &lt;span class=&quot;code-quote&quot;&gt;&quot;  ) as \&quot;&lt;/span&gt;z\&quot;&quot;
    );

    planner.validate(sqlNode);

    relRoot = planner.rel(sqlNode);
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
    e.printStackTrace();
}

RelNode relNode = relRoot.project();

&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.print(RelOptUtil.toString(relNode));

HepProgram hepProgram = HepProgram.builder()
        .addRuleInstance(CoreRules.PROJECT_TO_LOGICAL_PROJECT_AND_WINDOW)
        .addMatchOrder(HepMatchOrder.BOTTOM_UP)
        .build();
HepPlanner hepPlanner = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HepPlanner(hepProgram);
hepPlanner.setRoot(relNode);
RelNode bestExp = hepPlanner.findBestExp();
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(RelOptUtil.toString(bestExp));
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(bestExp.getRowType().getFieldList());

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The test schema is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Triple {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; p;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; o;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Triple(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; p, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; o) {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.s = s;
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.p = p;
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.o = o;
    }
}
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestSchema {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Triple[] rdf = {&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Triple(&lt;span class=&quot;code-quote&quot;&gt;&quot;s&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;p&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;o&quot;&lt;/span&gt;)};
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then the field list of bestExp it printed was:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[#0: s JavaType(&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;), #1: p JavaType(&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;), #2: o JavaType(&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;), #3: PV BIGINT, #4: w0$o0 BIGINT]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The field names are not duplicated at all. Everything works well.&lt;/p&gt;

&lt;p&gt;I guess the problem might be some rules that precedes ProjectToWindowRule transform the plan. We might need to check the rule set (especially some nested SQL transposition). I am not very faliliar with those rules.&lt;/p&gt;

&lt;p&gt;Currenty as a workaround I think we can add the following inside class FlinkLogicalOverAggregate:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; deriveRowType: RelDataType = {
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; typeFactory = cluster.getRexBuilder.getTypeFactory
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; typeBuilder = typeFactory.builder()
    input.getRowType.getFieldList.foreach(field =&amp;gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (typeBuilder.nameExists(field.getName)) {
        &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; newFieldName = RowTypeUtils.getUniqueName(field.getName, input.getRowType.getFieldNames)
        typeBuilder.add(
          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RelDataTypeFieldImpl(
            newFieldName,
            field.getIndex,
            field.getType))
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        typeBuilder.add(field)
      }
    })
    typeBuilder.build()
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Correct me if I am wrong.&lt;/p&gt;</comment>
                            <comment id="17870999" author="lincoln.86xy" created="Mon, 5 Aug 2024 09:07:44 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hackergin&quot; class=&quot;user-hover&quot; rel=&quot;hackergin&quot;&gt;hackergin&lt;/a&gt; for the tips and the discussion here! Looks like this issue has been on hold for a while.&lt;br/&gt;
I recently encountered this issue in an internal version and had a quick fix after some investigating (since I didn&apos;t search for the jira directly, but it looks like everyone is basically on the same page). So &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hackergin&quot; class=&quot;user-hover&quot; rel=&quot;hackergin&quot;&gt;hackergin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paul8263&quot; class=&quot;user-hover&quot; rel=&quot;paul8263&quot;&gt;paul8263&lt;/a&gt; could some of you help review the pr &lt;a href=&quot;https://github.com/apache/flink/pull/25152&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#25152&lt;/a&gt;?&#160;&lt;/p&gt;</comment>
                            <comment id="17871297" author="lincoln.86xy" created="Tue, 6 Aug 2024 11:30:51 +0000"  >&lt;p&gt;Fixed in master: 475f45ba0fb78f81adaa627ed2e8fbdcd71b83f6&lt;/p&gt;</comment>
                            <comment id="17871303" author="lincoln.86xy" created="Tue, 6 Aug 2024 11:40:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paul8263&quot; class=&quot;user-hover&quot; rel=&quot;paul8263&quot;&gt;paul8263&lt;/a&gt; Current fix uses a unified renaming introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22121&quot; title=&quot;FlinkLogicalRankRuleBase should check if name of rankNumberType already exists in the input&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22121&quot;&gt;&lt;del&gt;FLINK-22121&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;But as you mentioned above, there&apos;s something wrong during the plan rewriting, and I spent some time to debug it, root cause is in calcite&apos;s `CalcRelSplitter`#execute, when split a project which contains over agg call into a overwindow and calc, the new overwindow node lost the original alias name, but semantically it doesn&apos;t mean it&apos;s wrong because the following new calc&apos;s output use the expected alias name. So if the nested over agg query works fine in calcite, we can keep the current renaming code. (encounters some unexpected building error in my local calcite project, will take some time to verify it later.)&lt;/p&gt;</comment>
                            <comment id="17872773" author="lincoln.86xy" created="Mon, 12 Aug 2024 06:01:27 +0000"  >&lt;p&gt;Some updates: after debugged with code, the nested over agg query works fine in calcite.&lt;/p&gt;

&lt;p&gt;Verified related case in&lt;br/&gt;
`RelOptRulesTest`:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test void testProjectToWindowRuleForNestedOver() {
HepProgramBuilder builder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HepProgramBuilder();
builder.addRuleClass(ProjectToWindowRule.class);
HepPlanner hepPlanner = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HepPlanner(builder.build());
hepPlanner.addRule(CoreRules.PROJECT_TO_LOGICAL_PROJECT_AND_WINDOW);

&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; sql = &lt;span class=&quot;code-quote&quot;&gt;&quot;select deptno, f1, f2 from (select *, last_value(deptno) over (order by empno) f2\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot;from (select *, first_value(deptno) over (order by empno) f1 from emp))\n&quot;&lt;/span&gt;;
sql(sql).withPlanner(hepPlanner)
.check();
}
&#160;
LogicalProject(DEPTNO=[$7], F1=[$9], $2=[$10])
&#160; LogicalWindow(window#0=[window(order by [0] aggs [LAST_VALUE($7)])])
&#160; &#160; LogicalWindow(window#0=[window(order by [0] aggs [FIRST_VALUE($7)])])
&#160; &#160; &#160; LogicalTableScan(table=[[CATALOG, SALES, EMP]])
&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13587864">FLINK-35976</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 13 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z124a8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>