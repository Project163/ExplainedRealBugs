<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7371] user defined aggregator assumes nr of arguments smaller or equal than number of row fields</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7371</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The definition of user define aggregations with a number of parameters larger than the row fields causes ArrayIndexOutOfBoundsException because the indexing is based on a linear iteration over row fields. This does not consider cases where fields can be used more than once and constant values are passed to the aggregation function.&lt;/p&gt;

&lt;p&gt;for example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;window(partition {} order by [2] rows between $5 PRECEDING and CURRENT ROW aggs [myAgg($0, $1, $3, $0, $4)])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where $3 and $4 are reference to constants, and $0 and $1 are fields causes:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.ArrayIndexOutOfBoundsException: 4
	at org.apache.flink.table.plan.schema.RowSchema.mapIndex(RowSchema.scala:134)
	at org.apache.flink.table.plan.schema.RowSchema$$anonfun$mapAggregateCall$1.apply(RowSchema.scala:147)
	at org.apache.flink.table.plan.schema.RowSchema$$anonfun$mapAggregateCall$1.apply(RowSchema.scala:147)
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)
	at scala.collection.Iterator$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(Iterator.scala:727)
	at scala.collection.AbstractIterator.foreach(Iterator.scala:1157)
	at scala.collection.IterableLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(IterableLike.scala:72)
	at scala.collection.AbstractIterable.foreach(Iterable.scala:54)
	at scala.collection.TraversableLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;map(TraversableLike.scala:244)
	at scala.collection.AbstractTraversable.map(Traversable.scala:105)
	at org.apache.flink.table.plan.schema.RowSchema.mapAggregateCall(RowSchema.scala:147)
	at org.apache.flink.table.plan.nodes.datastream.DataStreamOverAggregate$$anonfun$9.apply(DataStreamOverAggregate.scala:362)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13092472">FLINK-7371</key>
            <summary>user defined aggregator assumes nr of arguments smaller or equal than number of row fields</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="twalthr">Timo Walther</assignee>
                                    <reporter username="stefano.bortoli">Stefano Bortoli</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Aug 2017 12:56:58 +0000</created>
                <updated>Mon, 16 Oct 2017 16:04:36 +0000</updated>
                            <resolved>Mon, 16 Oct 2017 16:04:36 +0000</resolved>
                                    <version>1.3.1</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16182748" author="githubbot" created="Wed, 27 Sep 2017 15:31:49 +0000"  >&lt;p&gt;GitHub user twalthr opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4736&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4736&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7371&quot; title=&quot;user defined aggregator assumes nr of arguments smaller or equal than number of row fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7371&quot;&gt;&lt;del&gt;FLINK-7371&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Add support for constant parameters in OVER aggregate&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR allows to pass constants to OVER window aggregates. E.g. `.select(&apos;c, weightAvgFun(&apos;a, 42, &apos;b, &quot;2&quot;) over &apos;w as &apos;wAvg)`.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Until now the constants where simply ignored. I added code generation for the literals in `AggregationCodeGenerator`.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    I add a ITCase for it. I might add more tests if I have time. In general, we need to rework the logic there a little bit, because I think we also do not support DATE, TIME etc. right now.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? not applicable&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/twalthr/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/twalthr/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7371&quot; title=&quot;user defined aggregator assumes nr of arguments smaller or equal than number of row fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7371&quot;&gt;&lt;del&gt;FLINK-7371&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4736.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4736.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4736&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 19e056e038009e22e2b607b38931f575d5c948df&lt;br/&gt;
Author: twalthr &amp;lt;twalthr@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-09-27T15:11:28Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7371&quot; title=&quot;user defined aggregator assumes nr of arguments smaller or equal than number of row fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7371&quot;&gt;&lt;del&gt;FLINK-7371&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Add support for constant parameters in OVER aggregate&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16188842" author="githubbot" created="Mon, 2 Oct 2017 21:11:45 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4736#discussion_r142256742&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4736#discussion_r142256742&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/test/java/org/apache/flink/table/runtime/utils/JavaUserDefinedAggFunctions.java &amp;#8212;&lt;br/&gt;
    @@ -86,6 +86,13 @@ public Long getValue(WeightedAvgAccum accumulator) {&lt;br/&gt;
     		}&lt;/p&gt;

&lt;p&gt;     		// overloaded accumulate method&lt;br/&gt;
    +		// dummy to test constants&lt;br/&gt;
    +		public void accumulate(WeightedAvgAccum accumulator, long iValue, int iWeight, int x, String string) {&lt;br/&gt;
    +			accumulator.sum += iWeight + Integer.parseInt(string);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    change the method to &lt;br/&gt;
    ```&lt;br/&gt;
    accumulator.sum += (iValue + Integer.parseInt(string)) * iWeight;&lt;br/&gt;
    accumulator.count += iWeight;&lt;br/&gt;
    ``` &lt;/p&gt;

&lt;p&gt;    to have some influence of the value of `string` in the result?&lt;/p&gt;</comment>
                            <comment id="16188843" author="githubbot" created="Mon, 2 Oct 2017 21:11:45 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4736#discussion_r142254410&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4736#discussion_r142254410&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/table/OverWindowITCase.scala &amp;#8212;&lt;br/&gt;
    @@ -85,6 +85,46 @@ class OverWindowITCase extends StreamingWithStateTestBase {&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       @Test&lt;br/&gt;
    +  def testOverWindowWithConstant(): Unit = {&lt;br/&gt;
    +&lt;br/&gt;
    +    val data = List(&lt;br/&gt;
    +      (1L, 1, &quot;Hello&quot;),&lt;br/&gt;
    +      (2L, 2, &quot;Hello&quot;),&lt;br/&gt;
    +      (3L, 3, &quot;Hello&quot;),&lt;br/&gt;
    +      (4L, 4, &quot;Hello&quot;),&lt;br/&gt;
    +      (5L, 5, &quot;Hello&quot;),&lt;br/&gt;
    +      (6L, 6, &quot;Hello&quot;),&lt;br/&gt;
    +      (7L, 7, &quot;Hello World&quot;),&lt;br/&gt;
    +      (8L, 8, &quot;Hello World&quot;),&lt;br/&gt;
    +      (8L, 8, &quot;Hello World&quot;),&lt;br/&gt;
    +      (20L, 20, &quot;Hello World&quot;))&lt;br/&gt;
    +&lt;br/&gt;
    +    val env = StreamExecutionEnvironment.getExecutionEnvironment&lt;br/&gt;
    +    env.setParallelism(1)&lt;br/&gt;
    +    val tEnv = TableEnvironment.getTableEnvironment(env)&lt;br/&gt;
    +    StreamITCase.testResults = mutable.MutableList()&lt;br/&gt;
    +    StreamITCase.clear&lt;br/&gt;
    +    val stream = env.fromCollection(data)&lt;br/&gt;
    +    val table = stream.toTable(tEnv, &apos;a, &apos;b, &apos;c, &apos;proctime.proctime)&lt;br/&gt;
    +    val weightAvgFun = new WeightedAvg&lt;br/&gt;
    +&lt;br/&gt;
    +    val windowedTable = table&lt;br/&gt;
    +      .window(&lt;br/&gt;
    +        Over partitionBy &apos;c orderBy &apos;proctime preceding UNBOUNDED_ROW as &apos;w)&lt;br/&gt;
    +      .select(&apos;c, weightAvgFun(&apos;a, 42, &apos;b, &quot;2&quot;) over &apos;w as &apos;wAvg)&lt;br/&gt;
    +      .select(&apos;c, &apos;wAvg)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    can be removed&lt;/p&gt;</comment>
                            <comment id="16188844" author="githubbot" created="Mon, 2 Oct 2017 21:11:45 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4736#discussion_r142247401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4736#discussion_r142247401&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/codegen/CodeGenerator.scala &amp;#8212;&lt;br/&gt;
    @@ -1670,4 +1670,34 @@ abstract class CodeGenerator(&lt;/p&gt;

&lt;p&gt;         fieldTerm&lt;br/&gt;
       }&lt;br/&gt;
    +&lt;br/&gt;
    +  /**&lt;br/&gt;
    +    * Adds a reusable constant to the member area of the generated [&lt;span class=&quot;error&quot;&gt;&amp;#91;Function&amp;#93;&lt;/span&gt;].&lt;br/&gt;
    +    *&lt;br/&gt;
    +    * @param constant constant expression&lt;br/&gt;
    +    * @return member variable term&lt;br/&gt;
    +    */&lt;br/&gt;
    +  def addReusableBoxedConstant(constant: GeneratedExpression): String = {&lt;br/&gt;
    +    require(constant.literal, &quot;Literal expected&quot;)&lt;br/&gt;
    +&lt;br/&gt;
    +    val fieldTerm = newName(&quot;constant&quot;)&lt;br/&gt;
    +&lt;br/&gt;
    +    val boxed = generateOutputFieldBoxing(constant)&lt;br/&gt;
    +    val boxedType = boxedTypeTermForTypeInfo(boxed.resultType)&lt;br/&gt;
    +&lt;br/&gt;
    +    val field =&lt;br/&gt;
    +      s&quot;&quot;&quot;&lt;br/&gt;
    +        |transient $boxedType $fieldTerm;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    why `transient`? Couldn&apos;t this be `final`?&lt;/p&gt;</comment>
                            <comment id="16206085" author="githubbot" created="Mon, 16 Oct 2017 15:55:02 +0000"  >&lt;p&gt;Github user twalthr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4736&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4736&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @fhueske. I addressed you feedback. Will merge this now...&lt;/p&gt;</comment>
                            <comment id="16206093" author="githubbot" created="Mon, 16 Oct 2017 15:59:58 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4736&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4736&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16206107" author="twalthr" created="Mon, 16 Oct 2017 16:04:36 +0000"  >&lt;p&gt;Fixed in 1.4.0: 861c57cb10a3ccc862ec068869582bc1551feaa5&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 5 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3if8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>