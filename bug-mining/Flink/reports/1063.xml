<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:24:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4145] JmxReporterTest fails due to port conflicts</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4145</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I saw multiple failures of the &lt;tt&gt;JmxReporterTest&lt;/tt&gt; most likely due to a port conflicts. The test relies on the default JMX reporter port range, which spans 5 ports. Running on Travis with multiple concurrent builds and bad timings, this can lead to port conflicts.&lt;/p&gt;

&lt;p&gt;Some example failed runs:&lt;br/&gt;
&lt;a href=&quot;https://s3.amazonaws.com/archive.travis-ci.org/jobs/141999066/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://s3.amazonaws.com/archive.travis-ci.org/jobs/141999066/log.txt&lt;/a&gt; (one out of 5 jobs failed)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/uce/flink/builds/141917901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/uce/flink/builds/141917901&lt;/a&gt; (all 5 jobs failed)&lt;/p&gt;

&lt;p&gt;I propose to take the fork number into account (like the forkable Flink testing cluster) and configure a larger port range.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12986466">FLINK-4145</key>
            <summary>JmxReporterTest fails due to port conflicts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="uce">Ufuk Celebi</reporter>
                        <labels>
                            <label>test-stability</label>
                    </labels>
                <created>Sun, 3 Jul 2016 14:07:15 +0000</created>
                <updated>Tue, 5 Jul 2016 07:50:17 +0000</updated>
                            <resolved>Tue, 5 Jul 2016 07:50:17 +0000</resolved>
                                                    <fixVersion>1.1.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15360554" author="githubbot" created="Sun, 3 Jul 2016 14:20:58 +0000"  >&lt;p&gt;GitHub user uce opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2193&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4145&quot; title=&quot;JmxReporterTest fails due to port conflicts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4145&quot;&gt;&lt;del&gt;FLINK-4145&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Configure port range for JMXReporterTest&lt;/p&gt;

&lt;p&gt;    I saw multiple failures of the JmxReporterTest most likely due to a port conflicts. The test relies on the default JMX reporter port range, which spans 5 ports. Running on Travis with multiple concurrent builds and bad timings, this can lead to port conflicts.&lt;/p&gt;

&lt;p&gt;    Some example failed runs:&lt;br/&gt;
    &lt;a href=&quot;https://s3.amazonaws.com/archive.travis-ci.org/jobs/141999066/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://s3.amazonaws.com/archive.travis-ci.org/jobs/141999066/log.txt&lt;/a&gt; (one out of 5 jobs failed)&lt;br/&gt;
    &lt;a href=&quot;https://travis-ci.org/uce/flink/builds/141917901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/uce/flink/builds/141917901&lt;/a&gt; (all 5 jobs failed)&lt;/p&gt;

&lt;p&gt;    I propose to take the fork number into account (like the forkable Flink testing cluster) and configure a larger port range.&lt;/p&gt;

&lt;p&gt;    Can you review this, @zentol?&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/uce/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/uce/flink&lt;/a&gt; 4145-jmx_test&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2193.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2193.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2193&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit dbe217a1bd9eaa9a98c7ae9800fec8d2af26e2f3&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-07-03T14:08:17Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4145&quot; title=&quot;JmxReporterTest fails due to port conflicts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4145&quot;&gt;&lt;del&gt;FLINK-4145&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Configure port range for JMXReporterTest&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15360678" author="githubbot" created="Sun, 3 Jul 2016 20:55:10 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2193&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    the default port range is 9010-9025, that&apos;s 15 not 5 ports.&lt;/p&gt;</comment>
                            <comment id="15360682" author="githubbot" created="Sun, 3 Jul 2016 21:02:10 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2193#discussion_r69397170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2193#discussion_r69397170&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/metrics/reporter/JMXReporterTest.java &amp;#8212;&lt;br/&gt;
    @@ -285,4 +289,23 @@ public long getMin() {&lt;br/&gt;
     			};&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Sets the JMX port range config key based on the fork number.&lt;br/&gt;
    +	 * @param config Configuration instance to configure&lt;br/&gt;
    +	 * @return Passed configuration instance&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private static Configuration setJmxPortRange(Configuration config) {&lt;br/&gt;
    +		int forkNumber = 0;&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			forkNumber = Integer.parseInt(System.getProperty(&quot;forkNumber&quot;));
    +		}
&lt;p&gt; catch (NumberFormatException ignored) &lt;/p&gt;
{
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		int minPort = 9000 + forkNumber * 100;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    what does the forkNumber bring us here? wouldn&apos;t it be better to use it for the mapPort to increase the range of ports?&lt;/p&gt;</comment>
                            <comment id="15360685" author="githubbot" created="Sun, 3 Jul 2016 21:07:55 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2193&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I would suggest using a random port range.&lt;/p&gt;</comment>
                            <comment id="15360686" author="vpernin" created="Sun, 3 Jul 2016 21:09:47 +0000"  >&lt;p&gt;Wy not using something like :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getAvailablePort() {
        ServerSocket ss = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            ss = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServerSocket(0);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ss.getLocalPort();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(e);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ss != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !ss.isClosed()) {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    ss.close();
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(e);
                }
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15360691" author="zentol" created="Sun, 3 Jul 2016 21:33:06 +0000"  >&lt;p&gt;because it is prone to race conditions.&lt;/p&gt;</comment>
                            <comment id="15360863" author="vpernin" created="Mon, 4 Jul 2016 05:44:04 +0000"  >&lt;p&gt;Without an os lock, yes, but more flexible.&lt;/p&gt;</comment>
                            <comment id="15360996" author="githubbot" created="Mon, 4 Jul 2016 08:10:29 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2193#discussion_r69421710&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2193#discussion_r69421710&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/metrics/reporter/JMXReporterTest.java &amp;#8212;&lt;br/&gt;
    @@ -285,4 +289,23 @@ public long getMin() {&lt;br/&gt;
     			};&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Sets the JMX port range config key based on the fork number.&lt;br/&gt;
    +	 * @param config Configuration instance to configure&lt;br/&gt;
    +	 * @return Passed configuration instance&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private static Configuration setJmxPortRange(Configuration config) {&lt;br/&gt;
    +		int forkNumber = 0;&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			forkNumber = Integer.parseInt(System.getProperty(&quot;forkNumber&quot;));
    +		}
&lt;p&gt; catch (NumberFormatException ignored) &lt;/p&gt;
{
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		int minPort = 9000 + forkNumber * 100;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think the fort number thing was non sensical as it is only set for integration tests.&lt;/p&gt;</comment>
                            <comment id="15361214" author="githubbot" created="Mon, 4 Jul 2016 11:51:38 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2193&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I believe the underlying issue is that there are a bunch of tests that just don&apos;t close their ports properly, as for quite a few tests a MetricRegistry is fired up silently in the background.&lt;/p&gt;

&lt;p&gt;    To circumvent this we don&apos;t even need a random range or a greater one, just once that is distinct from the default port range.&lt;/p&gt;</comment>
                            <comment id="15361229" author="githubbot" created="Mon, 4 Jul 2016 12:14:55 +0000"  >&lt;p&gt;Github user uce commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2193&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;m closing this after an offline chat with @zentol who will fix this properly.&lt;/p&gt;</comment>
                            <comment id="15361230" author="githubbot" created="Mon, 4 Jul 2016 12:14:55 +0000"  >&lt;p&gt;Github user uce closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2193&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15362163" author="zentol" created="Tue, 5 Jul 2016 07:50:17 +0000"  >&lt;p&gt;Tests were hardened in 647b4c57781ed33467cd0946a34d63be737d66e8.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30h87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>