<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:21:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-36421] Missing fsync in FsCheckpointStreamFactory</title>
                <link>https://issues.apache.org/jira/browse/FLINK-36421</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;With Flink 1.20 we observed another checkpoint corruption bug. This is similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-35217&quot; title=&quot;Missing fsync in FileSystemCheckpointStorage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-35217&quot;&gt;&lt;del&gt;FLINK-35217&lt;/del&gt;&lt;/a&gt;, but affects only files written by the taskmanager (the ones with random names as described &lt;a href=&quot;https://github.com/Planet-X/flink/blob/0d6e25a9738d9d4ee94de94e1437f92611b50758/flink-runtime/src/main/java/org/apache/flink/runtime/state/filesystem/FsCheckpointStreamFactory.java#L47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;After system crash the files written by the taskmanager may be corrupted (file size of 0 bytes) if the changes in the file-system cache haven&apos;t been written to disk. The &quot;_metadata&quot; file written by the jobmanager is always fine because it&apos;s properly fsynced.&lt;/p&gt;

&lt;p&gt;Investigation revealed that &quot;fsync&quot; is missing, this time in &quot;FsCheckpointStreamFactory&quot;. In this case the &quot;OutputStream&quot; is closed without calling &quot;fsync&quot;, thus the file is not durably persisted on disk before the checkpoint is completed. (As previously established in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-35217&quot; title=&quot;Missing fsync in FileSystemCheckpointStorage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-35217&quot;&gt;&lt;del&gt;FLINK-35217&lt;/del&gt;&lt;/a&gt;, calling &quot;fsync&quot; is necessary as simply closing the stream does not have any guarantees on persistence.)&lt;/p&gt;

&lt;p&gt;&quot;strace&quot; on the taskmanager&apos;s process confirms this behavior:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The checkpoint chk-1217&apos;s directory is created at &quot;mkdir&quot;&lt;/li&gt;
	&lt;li&gt;The checkpoint chk-1217&apos;s non-inline state is written by the taskmanager at &quot;openat&quot;, filename is &quot;0507881e-8877-40b0-82d6-3d7dead64ccc&quot;. Note that there&apos;s no &quot;fsync&quot; before &quot;close&quot;.&lt;/li&gt;
	&lt;li&gt;The checkpoint chk-1217 is finished, its &quot;_metadata&quot; is written and synced properly&lt;/li&gt;
	&lt;li&gt;The old checkpoint chk-1216 is deleted at &quot;unlink&quot;&lt;br/&gt;
The new checkpoint chk-1217 now references a not-synced file that can get corrupted on e.g. power loss. This means there is no working checkpoint left as the old checkpoint was deleted.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;For durable persistence an &quot;fsync&quot; call is missing before &quot;close&quot; in step 2.&lt;br/&gt;
Full &quot;strace&quot; log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[pid 947250] 08:22:58 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217&quot;&lt;/span&gt;, 0x7f68414c5b50) = -1 ENOENT (No such file or directory)
[pid 947250] 08:22:58 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217&quot;&lt;/span&gt;, 0x7f68414c5b50) = -1 ENOENT (No such file or directory)
[pid 947250] 08:22:58 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0
[pid 947250] 08:22:58 mkdir(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217&quot;&lt;/span&gt;, 0777) = 0
[pid 1303248] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217/0507881e-8877-40b0-82d6-3d7dead64ccc&quot;&lt;/span&gt;, 0x7f56f08d5610) = -1 ENOENT (No such file or directory)
[pid 1303248] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0
[pid 1303248] 08:22:59 openat(AT_FDCWD, &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217/0507881e-8877-40b0-82d6-3d7dead64ccc&quot;&lt;/span&gt;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 199
[pid 1303248] 08:22:59 fstat(199, {st_mode=S_IFREG|0644, st_size=0, ...}) = 0
[pid 1303248] 08:22:59 close(199)       = 0
[pid 947310] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217/_metadata&quot;&lt;/span&gt;, 0x7f683fb378b0) = -1 ENOENT (No such file or directory)
[pid 947310] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217/_metadata&quot;&lt;/span&gt;, 0x7f683fb37730) = -1 ENOENT (No such file or directory)
[pid 947310] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217/._metadata.inprogress.e87ac62b-5f75-472b-ad21-9579a872b0d0&quot;&lt;/span&gt;, 0x7f683fb37730) = -1 ENOENT (No such file or directory)
[pid 947310] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0
[pid 947310] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0
[pid 947310] 08:22:59 openat(AT_FDCWD, &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217/._metadata.inprogress.e87ac62b-5f75-472b-ad21-9579a872b0d0&quot;&lt;/span&gt;, O_WRONLY|O_CREAT|O_EXCL, 0666) = 148
[pid 947310] 08:22:59 fsync(148)        = 0
[pid 947310] 08:22:59 close(148)        = 0
[pid 947310] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217/._metadata.inprogress.e87ac62b-5f75-472b-ad21-9579a872b0d0&quot;&lt;/span&gt;, {st_mode=S_IFREG|0644, st_size=46265, ...}) = 0
[pid 947310] 08:22:59 rename(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217/._metadata.inprogress.e87ac62b-5f75-472b-ad21-9579a872b0d0&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1217/_metadata&quot;&lt;/span&gt;) = 0
[pid 947310] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216/1a478755-43d1-4094-9283-db5e15fc0cbe&quot;&lt;/span&gt;,  &amp;lt;unfinished ...&amp;gt;
[pid 947250] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216/_metadata&quot;&lt;/span&gt;,  &amp;lt;unfinished ...&amp;gt;
[pid 947310] 08:22:59 &amp;lt;... stat resumed&amp;gt;{st_mode=S_IFREG|0644, st_size=54409, ...}) = 0
[pid 947250] 08:22:59 &amp;lt;... stat resumed&amp;gt;{st_mode=S_IFREG|0644, st_size=46265, ...}) = 0
[pid 947310] 08:22:59 unlink(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216/1a478755-43d1-4094-9283-db5e15fc0cbe&quot;&lt;/span&gt; &amp;lt;unfinished ...&amp;gt;
[pid 947250] 08:22:59 unlink(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216/_metadata&quot;&lt;/span&gt; &amp;lt;unfinished ...&amp;gt;
[pid 947310] 08:22:59 &amp;lt;... unlink resumed&amp;gt;) = 0
[pid 947250] 08:22:59 &amp;lt;... unlink resumed&amp;gt;) = 0
[pid 947250] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0
[pid 947250] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0
[pid 947250] 08:22:59 openat(AT_FDCWD, &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216&quot;&lt;/span&gt;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = 148
[pid 947250] 08:22:59 newfstatat(148, &quot;&quot;, {st_mode=S_IFDIR|0755, st_size=4096, ...}, AT_EMPTY_PATH) = 0
[pid 947250] 08:22:59 close(148)        = 0
[pid 947250] 08:22:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216&quot;&lt;/span&gt;,  &amp;lt;unfinished ...&amp;gt;
[pid 947201] 08:22:59 &amp;lt;... stat resumed&amp;gt;0x7f56f2069a20) = -1 ENOENT (No such file or directory)
[pid 947250] 08:22:59 &amp;lt;... stat resumed&amp;gt;{st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0
[pid 947250] 08:22:59 openat(AT_FDCWD, &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216&quot;&lt;/span&gt;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY &amp;lt;unfinished ...&amp;gt;
[pid 947250] 08:22:59 &amp;lt;... openat resumed&amp;gt;) = 148
[pid 947250] 08:22:59 newfstatat(148, &quot;&quot;,  &amp;lt;unfinished ...&amp;gt;
[pid 947250] 08:22:59 &amp;lt;... newfstatat resumed&amp;gt;{st_mode=S_IFDIR|0755, st_size=4096, ...}, AT_EMPTY_PATH) = 0
[pid 947250] 08:22:59 close(148)        = 0
[pid 947250] 08:22:59 unlink(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216&quot;&lt;/span&gt;) = -1 EISDIR (Is a directory)
[pid 947250] 08:22:59 rmdir(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/d0346e6c26416765a6038fa482b29502/chk-1216&quot;&lt;/span&gt;) = 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Calling &quot;sync()&quot; when closing the stream in &quot;FsCheckpointStreamFactory::closeAndGetHandle&quot; fixes the problem by syncing the serialized state files before returning their reference to the jobmanager. The following commit fixes this: &lt;a href=&quot;https://github.com/Planet-X/flink/commit/0d6e25a9738d9d4ee94de94e1437f92611b50758&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Planet-X/flink/commit/0d6e25a9738d9d4ee94de94e1437f92611b50758&lt;/a&gt;&lt;br/&gt;
Diff is also attached.&lt;/p&gt;

&lt;p&gt;&quot;strace&quot; confirms that &quot;fsync&quot; is now called before the taskmanager&apos;s state file is closed, see line 9:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[pid 108807] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263&quot;&lt;/span&gt;, 0x7f2c167fc890) = -1 ENOENT (No such file or directory)
[pid 108807] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263&quot;&lt;/span&gt;, 0x7f2c167fc890) = -1 ENOENT (No such file or directory)
[pid 108807] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=44, ...}) = 0
[pid 108807] 13:14:59 mkdir(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263&quot;&lt;/span&gt;, 0777) = 0
[pid 110456] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263/9504fadb-182e-4812-857a-3dffa2408222&quot;&lt;/span&gt;, 0x7f7d56efbe90) = -1 ENOENT (No such file or directory)
[pid 110456] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=0, ...}) = 0
[pid 110456] 13:14:59 openat(AT_FDCWD, &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263/9504fadb-182e-4812-857a-3dffa2408222&quot;&lt;/span&gt;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 268
[pid 110456] 13:14:59 fstat(268, {st_mode=S_IFREG|0644, st_size=0, ...}) = 0
[pid 110456] 13:14:59 fsync(268)        = 0
[pid 110456] 13:14:59 close(268)        = 0
[pid 108807] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263/_metadata&quot;&lt;/span&gt;, 0x7f2c167fc710) = -1 ENOENT (No such file or directory)
[pid 108807] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263/_metadata&quot;&lt;/span&gt;,  &amp;lt;unfinished ...&amp;gt;
[pid 108807] 13:14:59 &amp;lt;... stat resumed&amp;gt;0x7f2c167fc670) = -1 ENOENT (No such file or directory)
[pid 108807] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263/._metadata.inprogress.7a1ea631-6dbd-4c7e-a551-849947c39396&quot;&lt;/span&gt;, 0x7f2c167fc670) = -1 ENOENT (No such file or directory)
[pid 108807] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=72, ...}) = 0
[pid 108807] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=72, ...}) = 0
[pid 108807] 13:14:59 openat(AT_FDCWD, &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263/._metadata.inprogress.7a1ea631-6dbd-4c7e-a551-849947c39396&quot;&lt;/span&gt;, O_WRONLY|O_CREAT|O_EXCL, 0666) = 168
[pid 108807] 13:14:59 fsync(168)        = 0
[pid 108807] 13:14:59 close(168)        = 0
[pid 108807] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263/._metadata.inprogress.7a1ea631-6dbd-4c7e-a551-849947c39396&quot;&lt;/span&gt;, {st_mode=S_IFREG|0644, st_size=21416, ...}) = 0
[pid 108807] 13:14:59 rename(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263/._metadata.inprogress.7a1ea631-6dbd-4c7e-a551-849947c39396&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-263/_metadata&quot;&lt;/span&gt;) = 0
[pid 108823] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-262/_metadata&quot;&lt;/span&gt;, {st_mode=S_IFREG|0644, st_size=36684, ...}) = 0
[pid 108823] 13:14:59 unlink(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-262/_metadata&quot;&lt;/span&gt;) = 0
[pid 108823] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-262&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=0, ...}) = 0
[pid 108823] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-262&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=0, ...}) = 0
[pid 108823] 13:14:59 openat(AT_FDCWD, &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-262&quot;&lt;/span&gt;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = 168
[pid 108823] 13:14:59 newfstatat(168, &quot;&quot;, {st_mode=S_IFDIR|0755, st_size=0, ...}, AT_EMPTY_PATH) = 0
[pid 108823] 13:14:59 close(168)        = 0
[pid 108823] 13:14:59 stat(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-262&quot;&lt;/span&gt;, {st_mode=S_IFDIR|0755, st_size=0, ...}) = 0
[pid 108823] 13:14:59 openat(AT_FDCWD, &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-262&quot;&lt;/span&gt;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = 168
[pid 108823] 13:14:59 newfstatat(168, &quot;&quot;, {st_mode=S_IFDIR|0755, st_size=0, ...}, AT_EMPTY_PATH) = 0
[pid 108823] 13:14:59 close(168)        = 0
[pid 108823] 13:14:59 unlink(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-262&quot;&lt;/span&gt;) = -1 EISDIR (Is a directory)
[pid 108823] 13:14:59 rmdir(&lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/flink/statestore/61dc13952604177c452c114faec25afc/chk-262&quot;&lt;/span&gt;) = 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Presumably only checkpoints with larger state sizes are affected as small state is inlined into the &quot;_metadata&quot; file, which is properly persisted since flink 1.19.1 due to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-35217&quot; title=&quot;Missing fsync in FileSystemCheckpointStorage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-35217&quot;&gt;&lt;del&gt;FLINK-35217&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13594182">FLINK-36421</key>
            <summary>Missing fsync in FsCheckpointStreamFactory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="planet9">Marc Aurel Fritz</assignee>
                                    <reporter username="planet9">Marc Aurel Fritz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 3 Oct 2024 14:30:03 +0000</created>
                <updated>Fri, 18 Oct 2024 09:24:35 +0000</updated>
                            <resolved>Thu, 10 Oct 2024 02:27:13 +0000</resolved>
                                    <version>1.17.0</version>
                    <version>1.18.0</version>
                    <version>1.19.0</version>
                    <version>1.20.0</version>
                                    <fixVersion>1.18.2</fixVersion>
                    <fixVersion>1.19.2</fixVersion>
                    <fixVersion>1.20.1</fixVersion>
                    <fixVersion>2.0-preview</fixVersion>
                                    <component>FileSystems</component>
                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17886772" author="gaborgsomogyi" created="Thu, 3 Oct 2024 19:31:40 +0000"  >&lt;p&gt;Not yet checked by myself but sounds serious. Heads-up &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zakelly&quot; class=&quot;user-hover&quot; rel=&quot;zakelly&quot;&gt;zakelly&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17886847" author="gaborgsomogyi" created="Fri, 4 Oct 2024 07:08:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=planet9&quot; class=&quot;user-hover&quot; rel=&quot;planet9&quot;&gt;planet9&lt;/a&gt; we&apos;re dealing with super huge states but not realized such corruption.&lt;/p&gt;

&lt;p&gt;Is there a bare minimal app/test or anything what we can use to repro this issue?&lt;/p&gt;</comment>
                            <comment id="17887306" author="JIRAUSER305204" created="Mon, 7 Oct 2024 10:06:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaborgsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;gaborgsomogyi&quot;&gt;gaborgsomogyi&lt;/a&gt; Are you using the hashmap or the rocksdb state backend? This should only affect the hashmap state backend.&lt;/p&gt;

&lt;p&gt;Currently we don&apos;t have an example to easily reproduce it locally. It&apos;s happening on our edge devices in a manufacturing shopfloor where some devices can often experience power loss, e.g. due to a machine operator cutting power to the machine. The bug seems to be quite hard to catch as it&apos;s a timing thing: the power loss has to happen after the checkpoint and before the OS has flushed the data to disk asynchronously. With a multitude of devices that do a (rather small) checkpoint every minute and have unstable power the bug occurs regularly, though.&lt;br/&gt;
It hasn&apos;t happened again since introducing the &quot;sync()&quot; call as the checkpoint is now only completed when its files are actually persisted on disk, as confirmed by &quot;strace&quot;.&lt;/p&gt;

&lt;p&gt;Asserting the behavior works great with &quot;strace&quot;. Sadly I don&apos;t know of a good way to easily reproduce this without cutting power to the system. Simplest way I can think of would be to start an example flink job with checkpointing in a VM and kill the whole VM directly after a large enough checkpoint happened. This should trigger the bug, but isn&apos;t too practical.&lt;br/&gt;
Do you know of a better way?&lt;/p&gt;</comment>
                            <comment id="17887315" author="gaborgsomogyi" created="Mon, 7 Oct 2024 11:15:18 +0000"  >&lt;p&gt;As we&apos;re dealing with super huge states which doesn&apos;t fit into memory we&apos;re not effected. No better idea to test it in a relatively reliable way. I think the best we can do is to rely on your unstable power supply environment and test it there. Please run the jobs for several week and double check whether it&apos;s stable enough with the mentioned change. We can evaluate the situation when we see stable operation.&lt;/p&gt;</comment>
                            <comment id="17887479" author="zakelly" created="Tue, 8 Oct 2024 05:34:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaborgsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;gaborgsomogyi&quot;&gt;gaborgsomogyi&lt;/a&gt; Thanks for the heads up~&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=planet9&quot; class=&quot;user-hover&quot; rel=&quot;planet9&quot;&gt;planet9&lt;/a&gt; I think this also affects the rocksdb since it also uses the &lt;tt&gt;FsCheckpointStreamFactory&lt;/tt&gt;. A &lt;tt&gt;sync()&lt;/tt&gt; before &lt;tt&gt;close()&lt;/tt&gt; would be fine. Would you please fix this?&lt;/p&gt;</comment>
                            <comment id="17887822" author="JIRAUSER305204" created="Wed, 9 Oct 2024 08:42:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaborgsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;gaborgsomogyi&quot;&gt;gaborgsomogyi&lt;/a&gt; We&apos;re been running the patched version for about a month on the most affected edge device. It&apos;s turned on and off multiple times a day and a corrupted checkpoint happened quite reliably at least once a week pre-patch. About a week ago we also rolled out the patched version to all other edge devices in production and they seem to run perfectly stable. No corrupted checkpoints have been observed with the patch in place for now - I&apos;ll keep you updated if that changes!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zakelly&quot; class=&quot;user-hover&quot; rel=&quot;zakelly&quot;&gt;zakelly&lt;/a&gt; Interesting! I assumed rocksdb wouldn&apos;t be affected as I expected that the rocksdb library is used to&#160; write all the serialized state to disk as part of the database. Does the rocksdb state backend also reference larger state as external files written by the &lt;tt&gt;FsCheckpointStreamFactory&lt;/tt&gt;, then presumably just storing their references in the rocksdb database? I&apos;ll take a closer look on how this works!&lt;/p&gt;

&lt;p&gt;I&apos;ve opened up a PR for this here: &lt;a href=&quot;https://github.com/apache/flink/pull/25468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/25468&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Should I also open up PRs for backporting this?&lt;/p&gt;</comment>
                            <comment id="17887922" author="gaborgsomogyi" created="Wed, 9 Oct 2024 12:55:26 +0000"  >&lt;p&gt;I would backport it to at least 1.20 line to have this fix on 1.x. Thanks for the PR.&lt;/p&gt;</comment>
                            <comment id="17888114" author="zakelly" created="Thu, 10 Oct 2024 02:24:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=planet9&quot; class=&quot;user-hover&quot; rel=&quot;planet9&quot;&gt;planet9&lt;/a&gt;&#160; It is the java part of flink that uploads all the sst files, since the rocksdb lib couldn&apos;t write the remote storage. And when recovery the flink downloads all the files to local and rebuild the rocksdb. So for rocksdb it always manipulates the real files at local.&#160; We are working on a new k-v store based on rocksdb called forst (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-34975&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-34975&lt;/a&gt;), which could read and write the remote storage. So in future the store itself can do checkpoint and recovery.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think it would be better if you backport this to release-1.18/19/20 .&lt;/p&gt;</comment>
                            <comment id="17888115" author="zakelly" created="Thu, 10 Oct 2024 02:26:03 +0000"  >&lt;p&gt;Merged dfb9bfeabac8d3ac289e46a3017ed68c50ba3777 into master&lt;/p&gt;</comment>
                            <comment id="17888187" author="JIRAUSER305204" created="Thu, 10 Oct 2024 07:57:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zakelly&quot; class=&quot;user-hover&quot; rel=&quot;zakelly&quot;&gt;zakelly&lt;/a&gt; Ah, I see! Thanks for the explanation! Definitely looking forward to trying out forst!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve opened up PRs for backporting this to 1.18, 1.19 and 1.20 here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/pull/25479&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/25479&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/pull/25480&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/25480&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/pull/25481&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/25481&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17890877" author="zakelly" created="Fri, 18 Oct 2024 09:24:11 +0000"  >&lt;p&gt;All merged.&lt;/p&gt;

&lt;p&gt;1.18: cabc6f4&lt;/p&gt;

&lt;p&gt;1.19: 8c13611&lt;/p&gt;

&lt;p&gt;1.20: 6a51962&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13071943" name="fsync-fs-stream-factory.diff" size="793" author="planet9" created="Thu, 3 Oct 2024 14:22:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1rrvk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>