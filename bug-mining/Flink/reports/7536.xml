<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:20:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-33936] Outputting Identical Results in Mini-Batch Aggregation with Set TTL</title>
                <link>https://issues.apache.org/jira/browse/FLINK-33936</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;If mini-batch is enabled currently, and if the aggregated result is the same as the previous output, this current aggregation result will not be sent downstream.  This will cause downstream nodes to not receive updated data. If there is a TTL set for states at this time, the TTL of downstream will not be updated either.&lt;/p&gt;

&lt;p&gt;The specific logic is as follows.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/a18c0cd3f0cdfd7e0acb53283f40cd2033a86472/flink-table/flink-table-runtime/src/main/java/org/apache/flink/table/runtime/operators/aggregate/MiniBatchGroupAggFunction.java#L224&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/a18c0cd3f0cdfd7e0acb53283f40cd2033a86472/flink-table/flink-table-runtime/src/main/java/org/apache/flink/table/runtime/operators/aggregate/MiniBatchGroupAggFunction.java#L224&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!equaliser.equals(prevAggValue, newAggValue)) {
                        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; row is not same with prev row
&lt;/span&gt;                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (generateUpdateBefore) {
                            &lt;span class=&quot;code-comment&quot;&gt;// prepare UPDATE_BEFORE message &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; previous row
&lt;/span&gt;                            resultRow
                                    .replace(currentKey, prevAggValue)
                                    .setRowKind(RowKind.UPDATE_BEFORE);
                            out.collect(resultRow);
                        }
                        &lt;span class=&quot;code-comment&quot;&gt;// prepare UPDATE_AFTER message &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; row
&lt;/span&gt;                        resultRow.replace(currentKey, newAggValue).setRowKind(RowKind.UPDATE_AFTER);
                        out.collect(resultRow);
                    }
                    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; row is same with prev row, no need to output&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



&lt;p&gt;When mini-batch is not enabled, even if the aggregation result of this time is the same as last time, new results will still be sent if TTL is set.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/e9353319ad625baa5b2c20fa709ab5b23f83c0f4/flink-table/flink-table-runtime/src/main/java/org/apache/flink/table/runtime/operators/aggregate/GroupAggFunction.java#L170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/e9353319ad625baa5b2c20fa709ab5b23f83c0f4/flink-table/flink-table-runtime/src/main/java/org/apache/flink/table/runtime/operators/aggregate/GroupAggFunction.java#L170&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stateRetentionTime &amp;lt;= 0 &amp;amp;&amp;amp; equaliser.equals(prevAggValue, newAggValue)) {
                    &lt;span class=&quot;code-comment&quot;&gt;// newRow is the same as before and state cleaning is not enabled.
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// We &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not emit retraction and acc message.
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// If state cleaning is enabled, we have to emit messages to prevent too early
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// state eviction of downstream operators.
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    &lt;span class=&quot;code-comment&quot;&gt;// retract previous result
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (generateUpdateBefore) {
                        &lt;span class=&quot;code-comment&quot;&gt;// prepare UPDATE_BEFORE message &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; previous row
&lt;/span&gt;                        resultRow
                                .replace(currentKey, prevAggValue)
                                .setRowKind(RowKind.UPDATE_BEFORE);
                        out.collect(resultRow);
                    }
                    &lt;span class=&quot;code-comment&quot;&gt;// prepare UPDATE_AFTER message &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; row
&lt;/span&gt;                    resultRow.replace(currentKey, newAggValue).setRowKind(RowKind.UPDATE_AFTER);
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Therefore, based on the consideration of TTL scenarios, I believe that when mini-batch aggregation is enabled, new results should also output when the aggregated result is the same as the previous one.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13562872">FLINK-33936</key>
            <summary>Outputting Identical Results in Mini-Batch Aggregation with Set TTL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hackergin">Feng Jin</assignee>
                                    <reporter username="hackergin">Feng Jin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 25 Dec 2023 16:54:21 +0000</created>
                <updated>Mon, 24 Jun 2024 03:24:31 +0000</updated>
                            <resolved>Thu, 20 Jun 2024 02:56:14 +0000</resolved>
                                    <version>1.18.0</version>
                                    <fixVersion>1.18.2</fixVersion>
                    <fixVersion>1.20.0</fixVersion>
                    <fixVersion>1.19.2</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17803395" author="xuyangzhong" created="Fri, 5 Jan 2024 03:34:50 +0000"  >&lt;p&gt;Thanks for your report. This bug seems to be that when optimizations about mini-batch agg were first introduced, some behaviors in the group agg function were not aligned. I think we need to fix it.&lt;/p&gt;</comment>
                            <comment id="17803409" author="hackergin" created="Fri, 5 Jan 2024 05:21:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuyangzhong&quot; class=&quot;user-hover&quot; rel=&quot;xuyangzhong&quot;&gt;xuyangzhong&lt;/a&gt; &#160;Thank you for your reply, I would like to fix this issue.&#160;&lt;/p&gt;</comment>
                            <comment id="17856374" author="weijie guo" created="Thu, 20 Jun 2024 02:56:14 +0000"  >&lt;p&gt;master(1.20) via d661ec2983ef249911698a1d7ebbb7ec58a9e62a.&lt;br/&gt;
release-1.19 via e2c875a50f2edeb59574f962b8805b296a2d7b2a.&lt;br/&gt;
release-1.18 via 3875916e4eae38d3dbf8b07fd12f8ff736f60043.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mfsw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>