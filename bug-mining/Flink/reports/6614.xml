<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:11:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-28265] Inconsistency in Kubernetes HA service: broken state handle</title>
                <link>https://issues.apache.org/jira/browse/FLINK-28265</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I have a JobManager, which at some point failed to acknowledge a checkpoint:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing AcknowledgeCheckpoint message
org.apache.flink.runtime.checkpoint.CheckpointException: Could not complete the pending checkpoint 193393. Failure reason: Failure to finalize checkpoint.
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.completePendingCheckpoint(CheckpointCoordinator.java:1255)
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.receiveAcknowledgeMessage(CheckpointCoordinator.java:1100)
	at org.apache.flink.runtime.scheduler.ExecutionGraphHandler.lambda$acknowledgeCheckpoint$1(ExecutionGraphHandler.java:89)
	at org.apache.flink.runtime.scheduler.ExecutionGraphHandler.lambda$processCheckpointCoordinatorMessage$3(ExecutionGraphHandler.java:119)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
Caused by: org.apache.flink.runtime.persistence.StateHandleStore$AlreadyExistException: checkpointID-0000000000000193393 already exists in ConfigMap cm-00000000000000000000000000000000-jobmanager-leader
	at org.apache.flink.kubernetes.highavailability.KubernetesStateHandleStore.getKeyAlreadyExistException(KubernetesStateHandleStore.java:534)
	at org.apache.flink.kubernetes.highavailability.KubernetesStateHandleStore.lambda$addAndLock$0(KubernetesStateHandleStore.java:155)
	at org.apache.flink.kubernetes.kubeclient.Fabric8FlinkKubeClient.lambda$attemptCheckAndUpdateConfigMap$11(Fabric8FlinkKubeClient.java:316)
	at java.base/java.util.concurrent.CompletableFuture$AsyncSupply.run(Unknown Source)
	... 3 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the JobManager creates subsequent checkpoints successfully.&lt;br/&gt;
Upon failure, it tries to recover this checkpoint (0000000000000193393), but fails to do so because of:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: org.apache.flink.util.FlinkException: Could not retrieve checkpoint 193393 from state handle under checkpointID-0000000000000193393. This indicates that the retrieved state handle is broken. Try cleaning the state handle store ... Caused by: java.io.FileNotFoundException: No such file or directory: s3:&lt;span class=&quot;code-comment&quot;&gt;//xxx/flink-ha/xxx/completedCheckpoint72e30229420c&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m running Flink 1.14.4.&lt;/p&gt;

&lt;p&gt;Note: This issue has been first discussed here: &lt;a href=&quot;https://github.com/apache/flink/pull/15832#pullrequestreview-1005973050&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/15832#pullrequestreview-1005973050&lt;/a&gt; &lt;/p&gt;</description>
                <environment></environment>
        <key id="13468587">FLINK-28265</key>
            <summary>Inconsistency in Kubernetes HA service: broken state handle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wangyang0918">Yang Wang</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 27 Jun 2022 12:29:11 +0000</created>
                <updated>Sat, 27 Aug 2022 06:58:28 +0000</updated>
                            <resolved>Sat, 27 Aug 2022 06:56:34 +0000</resolved>
                                    <version>1.14.4</version>
                                    <fixVersion>1.16.0</fixVersion>
                    <fixVersion>1.15.3</fixVersion>
                                    <component>Deployment / Kubernetes</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="17559146" author="rmetzger" created="Mon, 27 Jun 2022 12:31:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; I&apos;m trying to get the full JobManager logs ... but they might have been gone by now, due to the retention of our log management system.&lt;/p&gt;

&lt;p&gt;UPDATE: the log is indeed gone. I will properly collect the logs next time this happens.&lt;/p&gt;</comment>
                            <comment id="17559147" author="rmetzger" created="Mon, 27 Jun 2022 12:32:37 +0000"  >&lt;p&gt;We don&apos;t have a reliable way of reproducing this issue yet.&lt;br/&gt;
But another user reported something similar in: &lt;a href=&quot;https://github.com/apache/flink/pull/15832#issuecomment-1167167537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/15832#issuecomment-1167167537&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17560073" author="fly_in_gis" created="Wed, 29 Jun 2022 07:26:39 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt; for sharing this issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am curious why Flink still recovers from the checkpoint (0000000000000193393) if JobManager creates subsequent checkpoints successfully. It should pick the latest the successful checkpoint.&lt;/p&gt;</comment>
                            <comment id="17560080" author="rmetzger" created="Wed, 29 Jun 2022 07:36:30 +0000"  >&lt;p&gt;Yes, I was wondering exactly the same. I&apos;ve setup some internal monitoring to catch if this situation occurs again. I&apos;ll then share the logs.&lt;/p&gt;</comment>
                            <comment id="17560985" author="JIRAUSER291806" created="Thu, 30 Jun 2022 11:03:12 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13046087/13046087_flink_checkpoint_issue.txt&quot; title=&quot;flink_checkpoint_issue.txt attached to FLINK-28265&quot;&gt;flink_checkpoint_issue.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17560989" author="martijnvisser" created="Thu, 30 Jun 2022 11:14:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cymau&quot; class=&quot;user-hover&quot; rel=&quot;cymau&quot;&gt;cymau&lt;/a&gt; That log doesn&apos;t relates to this issue, since this issue is strictly about the Kubernetes tests that we are running. Your log are Flink logs&lt;/p&gt;</comment>
                            <comment id="17561240" author="JIRAUSER291806" created="Fri, 1 Jul 2022 02:48:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; We had another incident where we hit this issue and uploaded the full JobManager log:&#160;&lt;/p&gt;

&lt;p&gt;Caused by: java.util.concurrent.CompletionException: java.lang.RuntimeException: org.apache.flink.util.FlinkException: Could not retrieve checkpoint 9702 from state handle under checkpointID-0000000000000009702. This indicates that the retrieved state handle is broken. Try cleaning the state handle store.&lt;/p&gt;

&lt;p&gt;Please ignore if not related to this issue.&lt;/p&gt;</comment>
                            <comment id="17561326" author="martijnvisser" created="Fri, 1 Jul 2022 07:17:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cymau&quot; class=&quot;user-hover&quot; rel=&quot;cymau&quot;&gt;cymau&lt;/a&gt; Like I said, this can&apos;t be related to this ticket. This ticket is about a test instability on the Flink source code. This test isn&apos;t included in the actual released Flink version. If you have a problem, I recommend to post this to the User mailing list, Stackoverflow or Slack per &lt;a href=&quot;https://flink.apache.org/gettinghelp.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://flink.apache.org/gettinghelp.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17564911" author="enriquel8" created="Mon, 11 Jul 2022 10:18:11 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; , &lt;/p&gt;

&lt;p&gt;I understand that the original ticket was created due to a test instability but the test is highlighting the fact that there is a problem in the flow that results in a broken state. What &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cymau&quot; class=&quot;user-hover&quot; rel=&quot;cymau&quot;&gt;cymau&lt;/a&gt; is saying and that I original flagged is that we are seeing the same type of behaviour in the field. I&apos;m happy to raise a separate ticket to track the same problem occurring in the field but it&apos;s the exact same behaviour. All the test is doing which is great is highlighting that there is a problem.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Enrique&lt;/p&gt;</comment>
                            <comment id="17564944" author="martijnvisser" created="Mon, 11 Jul 2022 11:12:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=EnriqueL8&quot; class=&quot;user-hover&quot; rel=&quot;EnriqueL8&quot;&gt;EnriqueL8&lt;/a&gt; It feels like my comment is misplaced on this Jira ticket, because I believe I made that comment when I was talking about &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-28269&quot; title=&quot;Kubernetes test failed with permission denied&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-28269&quot;&gt;&lt;del&gt;FLINK-28269&lt;/del&gt;&lt;/a&gt;. I&apos;ve made a mistake or some comments were removed. &lt;/p&gt;

&lt;p&gt;Regarding the provided logs, are there also logs available of the previous runs? Are there also taskmanager logs available? CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cymau&quot; class=&quot;user-hover&quot; rel=&quot;cymau&quot;&gt;cymau&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wangyang0918&quot; class=&quot;user-hover&quot; rel=&quot;wangyang0918&quot;&gt;wangyang0918&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; What are your thoughts on this? &lt;/p&gt;</comment>
                            <comment id="17566116" author="fly_in_gis" created="Wed, 13 Jul 2022 02:44:41 +0000"  >&lt;p&gt;Since we always add the new checkpoint first and then subsume the oldest one, I am curious how it could happen we only have one checkpoint which is invalid. If adding the new checkpoint failed, we should have the old successful checkpoint. On the contrary, if subsuming the oldest one failed, we should still have the newly added checkpoint.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Could you please verify the checkpoint 9701 or 9703 exists on the S3?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I believe the the logs of previous run(e.g. kubectl logs &amp;lt;pod-name&amp;gt; --previous) and the Kubernetes APIServer audit log will help a lot to debug the root cause.&lt;/p&gt;</comment>
                            <comment id="17566245" author="mapohl" created="Wed, 13 Jul 2022 10:27:38 +0000"  >&lt;p&gt;I looked into the &lt;tt&gt;EOFException&lt;/tt&gt; generation for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cymau&quot; class=&quot;user-hover&quot; rel=&quot;cymau&quot;&gt;cymau&lt;/a&gt; case. Based on the stacktrace, we can assume that the file was empty:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.io.EOFException
	at java.io.ObjectInputStream$PeekInputStream.readFully(Unknown Source) ~[?:?]
	at java.io.ObjectInputStream$BlockDataInputStream.readShort(Unknown Source) ~[?:?]
	at java.io.ObjectInputStream.readStreamHeader(Unknown Source) ~[?:?]
	at java.io.ObjectInputStream.&amp;lt;init&amp;gt;(Unknown Source) ~[?:?]
	at org.apache.flink.util.InstantiationUtil$ClassLoaderObjectInputStream.&amp;lt;init&amp;gt;(InstantiationUtil.java:66) ~[flink-dist_2.11-1.13.2.jar:1.13.2]
	at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:613) ~[flink-dist_2.11-1.13.2.jar:1.13.2]
	at org.apache.flink.util.InstantiationUtil.deserializeObject(InstantiationUtil.java:593) ~[flink-dist_2.11-1.13.2.jar:1.13.2]
[...]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;m wondering whether there is some external process that ran that cleaned up files? Because usually, we only delete files but don&apos;t change the content. Another issue I could think of is that some network issue (since we&apos;re accessing some (maybe distributed) FileSystem) resulted in the InputStream for the deserialization not to contain any data. But I would have thought that this error case would result in a different &lt;tt&gt;IOException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;In contrast, the other appearances were caused by the RetrievableStateHandle file being entirely deleted (i.e. discarded) which is a behavior I would rather expect if we have a bug in Flink.&lt;/p&gt;</comment>
                            <comment id="17570576" author="fly_in_gis" created="Mon, 25 Jul 2022 02:24:26 +0000"  >&lt;p&gt;I want to share some progress about this ticket. The root cause might be we should not discard the state when coming across &lt;tt&gt;AlreadyExistException&lt;/tt&gt; in &lt;tt&gt;KubernetesStateHandleStore#addAndLock&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If something is temporarily wrong with the JobManager network, &lt;tt&gt;Fabric8FlinkKubeClient#checkAndUpdateConfigMap&lt;/tt&gt; failed with &lt;tt&gt;KubernetesException&lt;/tt&gt; in the first run and retried again. However, the http request is actually sent successfully and handled by the K8s APIServer, which means the entry was added to the ConfigMap. This will cause the second retry fails with &lt;tt&gt;AlreadyExistException&lt;/tt&gt; and then discard the state. If the JobManager crashed exactly, it will throw the &lt;tt&gt;FileNotFoundException: No such file or directory: s3://xxx/flink-ha/xxx/completedCheckpoint72e30229420c&lt;/tt&gt; in the following attempts since added entry is not cleaned up.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17580157" author="fly_in_gis" created="Tue, 16 Aug 2022 08:32:47 +0000"  >&lt;p&gt;I will work on this ticket.&lt;/p&gt;</comment>
                            <comment id="17585677" author="fly_in_gis" created="Sat, 27 Aug 2022 06:56:34 +0000"  >&lt;p&gt;Fixed via:&lt;/p&gt;

&lt;p&gt;master(1.16): aae96d0c9d1768c396bdf2ee6510677fbb8f317a&lt;/p&gt;

&lt;p&gt;release-1.15: fcff4903c8d625edb8f4e33b03bfded52c3deba8&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13414397">FLINK-25098</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13478588">FLINK-29105</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13046087" name="flink_checkpoint_issue.txt" size="57907" author="cymau" created="Thu, 30 Jun 2022 11:03:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 11 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z16dzc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>