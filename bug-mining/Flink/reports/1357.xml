<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5332] Non-thread safe FileSystem::initOutPathLocalFS() can cause lost files/directories in local execution</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5332</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;This is mainly relevant to tests and Local Mini Cluster executions.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;FileOutputFormat&lt;/tt&gt; and its subclasses rely on &lt;tt&gt;FileSystem::initOutPathLocalFS()&lt;/tt&gt; to prepare the output directory. When multiple parallel output writers call that method, there is a slim chance that one parallel threads deletes the others directory. The checks that the method has are not bullet proof.&lt;/p&gt;

&lt;p&gt;I believe that this is the cause for many Travis test instabilities that we observed over time.&lt;/p&gt;

&lt;p&gt;Simply synchronizing that method per process should do the trick. Since it is a rare initialization method, and only relevant in tests &amp;amp; local mini cluster executions, it should be a price that is okay to pay. I see no other way, as we do not have simple access to an atomic &quot;check and delete and recreate&quot; file operation.&lt;/p&gt;

&lt;p&gt;The synchronization also makes many &quot;re-try&quot; code paths obsolete (there should be no re-tries needed on proper file systems).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13027886">FLINK-5332</key>
            <summary>Non-thread safe FileSystem::initOutPathLocalFS() can cause lost files/directories in local execution</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Dec 2016 19:48:42 +0000</created>
                <updated>Thu, 28 Feb 2019 13:21:19 +0000</updated>
                            <resolved>Wed, 14 Dec 2016 12:17:09 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15746125" author="githubbot" created="Tue, 13 Dec 2016 20:05:48 +0000"  >&lt;p&gt;GitHub user StephanEwen opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2999&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2999&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5332&quot; title=&quot;Non-thread safe FileSystem::initOutPathLocalFS() can cause lost files/directories in local execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5332&quot;&gt;&lt;del&gt;FLINK-5332&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Synchronize FileSystem::initOutPathLocalFS() to prevent lost files/directories when called concurrently&lt;/p&gt;

&lt;p&gt;    This is mainly relevant to tests and Local Mini Cluster executions.&lt;/p&gt;

&lt;p&gt;    The `FileOutputFormat` and its subclasses rely on `FileSystem::initOutPathLocalFS()` to prepare the output directory. When multiple parallel output writers call that method, there is a slim chance that one parallel threads deletes the others directory. The checks that the method has are not bullet proof.&lt;/p&gt;

&lt;p&gt;    I believe that this is the cause for many Travis test instabilities that we observed over time.&lt;/p&gt;

&lt;p&gt;    Simply synchronizing that method per process should do the trick. Since it is a rare initialization method, and only relevant in tests &amp;amp; local mini cluster executions, it should be a price that is okay to pay. I see no other way, as we do not have simple access to an atomic &quot;check and delete and recreate&quot; file operation.&lt;br/&gt;
    The synchronization also makes many &quot;re-try&quot; code paths obsolete (there should be no re-tries needed on proper file systems).&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Tests&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This is tricky to test. The test in `InitOutputPathTest.java` uses a series of latch to re-produce the problematic thread execution interleaving to validate the problem. The properly fixed variant cannot use that interleaving (because it fixes the problem, duh), but pushes the thread interleaving best-effort towards the case where the problem would occur, were the method not properly synchronized. Sounds weird, I know.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StephanEwen/incubator-flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StephanEwen/incubator-flink&lt;/a&gt; fs_fix&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2999.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2999.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2999&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 7a4d5b2f53e3b8c27a5224e405cf1b671f474a58&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-12-13T18:15:11Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Add &apos;CheckedThread&apos; as a common test utility&lt;/p&gt;

&lt;p&gt;commit e25b436f1de18be0dc2c3b02b82bf0b8203f0b44&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-12-13T18:12:12Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5332&quot; title=&quot;Non-thread safe FileSystem::initOutPathLocalFS() can cause lost files/directories in local execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5332&quot;&gt;&lt;del&gt;FLINK-5332&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Synchronize FileSystem::initOutPathLocalFS() to prevent lost files when called concurrently.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15746126" author="githubbot" created="Tue, 13 Dec 2016 20:06:10 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2999&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2999&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think this should go into 1.2 - it is quite a bug for local testing.&lt;/p&gt;</comment>
                            <comment id="15748048" author="githubbot" created="Wed, 14 Dec 2016 11:12:36 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2999&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2999&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Changes look good to me. Great fix you&apos;ve implemented there @StephanEwen. This will hopefully make some of the failing travis test cases stable again &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; +1 for merging.&lt;/p&gt;</comment>
                            <comment id="15748085" author="githubbot" created="Wed, 14 Dec 2016 11:25:14 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2999&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2999&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks, will merge this...&lt;/p&gt;</comment>
                            <comment id="15748206" author="stephanewen" created="Wed, 14 Dec 2016 12:17:11 +0000"  >&lt;p&gt;Fixed via 2f3ad58b7b73463aa1827baef0eb2e9d87fdb882&lt;/p&gt;</comment>
                            <comment id="15751246" author="githubbot" created="Thu, 15 Dec 2016 12:28:17 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2999&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2999&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Manually merged in 2f3ad58b7b73463aa1827baef0eb2e9d87fdb882&lt;/p&gt;</comment>
                            <comment id="15751247" author="githubbot" created="Thu, 15 Dec 2016 12:28:17 +0000"  >&lt;p&gt;Github user StephanEwen closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2999&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2999&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13011305">FLINK-4798</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13026643">FLINK-5287</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13026671">FLINK-5288</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37k13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>