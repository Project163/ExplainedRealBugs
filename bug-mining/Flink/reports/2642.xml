<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9891] Flink cluster is not shutdown in YARN mode when Flink client is stopped</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9891</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We are not using session mode and detached mode. The command to run Flink job on YARN is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;flink-1.5.1&amp;gt;/bin/flink run -m yarn-cluster -yn 1 -yqu flink -yjm 768 -ytm 2048 -j ./flink-quickstart-java-1.0-SNAPSHOT.jar -c org.test.WordCount
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Flink CLI logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Setting HADOOP_CONF_DIR=/etc/hadoop/conf because no HADOOP_CONF_DIR was set.
SLF4J: &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; path contains multiple SLF4J bindings.
SLF4J: Found binding in [jar:file:/opt/flink-streaming/flink-streaming-1.5.1-1.5.1-bin-hadoop27-scala_2.11-1531485329/lib/slf4j-log4j12-1.7.7.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J: Found binding in [jar:file:/usr/hdp/2.4.2.10-1/hadoop/lib/slf4j-log4j12-1.7.10.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J: See http:&lt;span class=&quot;code-comment&quot;&gt;//www.slf4j.org/codes.html#multiple_bindings &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; an explanation.
&lt;/span&gt;SLF4J: Actual binding is of type [org.slf4j.impl.Log4jLoggerFactory]
2018-07-18 12:47:03,747 INFO org.apache.hadoop.yarn.client.api.impl.TimelineClientImpl - Timeline service address: http:&lt;span class=&quot;code-comment&quot;&gt;//hmaster-1.ipbl.rgcloud.net:8188/ws/v1/timeline/
&lt;/span&gt;2018-07-18 12:47:04,222 INFO org.apache.flink.yarn.cli.FlinkYarnSessionCli - No path &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the flink jar passed. Using the location of &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.yarn.YarnClusterDescriptor to locate the jar
2018-07-18 12:47:04,222 INFO org.apache.flink.yarn.cli.FlinkYarnSessionCli - No path &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the flink jar passed. Using the location of &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.yarn.YarnClusterDescriptor to locate the jar
2018-07-18 12:47:04,248 WARN org.apache.flink.yarn.AbstractYarnClusterDescriptor - Neither the HADOOP_CONF_DIR nor the YARN_CONF_DIR environment variable is set. The Flink YARN Client needs one of these to be set to properly load the Hadoop configuration &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; accessing YARN.
2018-07-18 12:47:04,409 INFO org.apache.flink.yarn.AbstractYarnClusterDescriptor - Cluster specification: ClusterSpecification{masterMemoryMB=768, taskManagerMemoryMB=2048, numberTaskManagers=1, slotsPerTaskManager=1}
2018-07-18 12:47:04,783 WARN org.apache.hadoop.hdfs.shortcircuit.DomainSocketFactory - The &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt;-circuit local reads feature cannot be used because libhadoop cannot be loaded.
2018-07-18 12:47:04,788 WARN org.apache.flink.yarn.AbstractYarnClusterDescriptor - The configuration directory (&lt;span class=&quot;code-quote&quot;&gt;&apos;/opt/flink-streaming/flink-streaming-1.5.1-1.5.1-bin-hadoop27-scala_2.11-1531485329/conf&apos;&lt;/span&gt;) contains both LOG4J and Logback configuration files. Please delete or rename one of them.
2018-07-18 12:47:07,846 INFO org.apache.flink.yarn.AbstractYarnClusterDescriptor - Submitting application master application_1531474158783_10814
2018-07-18 12:47:08,073 INFO org.apache.hadoop.yarn.client.api.impl.YarnClientImpl - Submitted application application_1531474158783_10814
2018-07-18 12:47:08,074 INFO org.apache.flink.yarn.AbstractYarnClusterDescriptor - Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the cluster to be allocated
2018-07-18 12:47:08,076 INFO org.apache.flink.yarn.AbstractYarnClusterDescriptor - Deploying cluster, current state ACCEPTED
2018-07-18 12:47:12,864 INFO org.apache.flink.yarn.AbstractYarnClusterDescriptor - YARN application has been deployed successfully.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Job Manager logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-07-18 12:47:09,913 INFO org.apache.flink.runtime.entrypoint.ClusterEntrypoint - --------------------------------------------------------------------------------
2018-07-18 12:47:09,915 INFO org.apache.flink.runtime.entrypoint.ClusterEntrypoint - Starting YarnSessionClusterEntrypoint (Version: 1.5.1, Rev:3488f8b, Date:10.07.2018 @ 11:51:27 GMT)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Issues:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Flink job is running as a Flink session&lt;/li&gt;
	&lt;li&gt;Ctrl+C or &apos;stop&apos; doesn&apos;t stop a job and YARN cluster&lt;/li&gt;
	&lt;li&gt;Cancel job via Job Maanager web ui doesn&apos;t stop Flink cluster. To kill the cluster we need to run: yarn application -kill &amp;lt;id&amp;gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;We also tried to run a flink job with &apos;mode: legacy&apos; and we have the same issues:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Add property &apos;mode: legacy&apos; to ./conf/flink-conf.yaml&lt;/li&gt;
	&lt;li&gt;Execute the following command:&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;flink-1.5.1&amp;gt;/bin/flink run -m yarn-cluster -yn 1 -yqu flink -yjm 768 -ytm 2048 -j ./flink-quickstart-java-1.0-SNAPSHOT.jar -c org.test.WordCount
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Flink CLI logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Setting HADOOP_CONF_DIR=/etc/hadoop/conf because no HADOOP_CONF_DIR was set.
SLF4J: &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; path contains multiple SLF4J bindings.
SLF4J: Found binding in [jar:file:/opt/flink-streaming/flink-streaming-1.5.1-1.5.1-bin-hadoop27-scala_2.11-1531485329/lib/slf4j-log4j12-1.7.7.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J: Found binding in [jar:file:/usr/hdp/2.4.2.10-1/hadoop/lib/slf4j-log4j12-1.7.10.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J: See http:&lt;span class=&quot;code-comment&quot;&gt;//www.slf4j.org/codes.html#multiple_bindings &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; an explanation.
&lt;/span&gt;SLF4J: Actual binding is of type [org.slf4j.impl.Log4jLoggerFactory]
2018-07-18 16:07:13,820 INFO org.apache.hadoop.yarn.client.api.impl.TimelineClientImpl - Timeline service address: http:&lt;span class=&quot;code-comment&quot;&gt;//hmaster-1.ipbl.rgcloud.net:8188/ws/v1/timeline/
&lt;/span&gt;2018-07-18 16:07:14,165 INFO org.apache.flink.yarn.cli.FlinkYarnSessionCli - No path &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the flink jar passed. Using the location of &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.yarn.LegacyYarnClusterDescriptor to locate the jar
2018-07-18 16:07:14,165 INFO org.apache.flink.yarn.cli.FlinkYarnSessionCli - No path &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the flink jar passed. Using the location of &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.yarn.LegacyYarnClusterDescriptor to locate the jar
2018-07-18 16:07:14,182 WARN org.apache.flink.yarn.AbstractYarnClusterDescriptor - Neither the HADOOP_CONF_DIR nor the YARN_CONF_DIR environment variable is set. The Flink YARN Client needs one of these to be set to properly load the Hadoop configuration &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; accessing YARN.
2018-07-18 16:07:14,356 INFO org.apache.flink.yarn.AbstractYarnClusterDescriptor - Cluster specification: ClusterSpecification{masterMemoryMB=768, taskManagerMemoryMB=2048, numberTaskManagers=1, slotsPerTaskManager=1}
2018-07-18 16:07:14,703 WARN org.apache.hadoop.hdfs.shortcircuit.DomainSocketFactory - The &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt;-circuit local reads feature cannot be used because libhadoop cannot be loaded.
2018-07-18 16:07:14,708 WARN org.apache.flink.yarn.AbstractYarnClusterDescriptor - The configuration directory (&lt;span class=&quot;code-quote&quot;&gt;&apos;/home/skrasovs/flink-conf&apos;&lt;/span&gt;) contains both LOG4J and Logback configuration files. Please delete or rename one of them.
2018-07-18 16:07:17,678 INFO org.apache.flink.yarn.AbstractYarnClusterDescriptor - Submitting application master application_1531474158783_10843
2018-07-18 16:07:17,717 INFO org.apache.hadoop.yarn.client.api.impl.YarnClientImpl - Submitted application application_1531474158783_10843
2018-07-18 16:07:17,717 INFO org.apache.flink.yarn.AbstractYarnClusterDescriptor - Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the cluster to be allocated
2018-07-18 16:07:17,720 INFO org.apache.flink.yarn.AbstractYarnClusterDescriptor - Deploying cluster, current state ACCEPTED
2018-07-18 16:07:23,527 INFO org.apache.flink.yarn.AbstractYarnClusterDescriptor - YARN application has been deployed successfully.
Using the parallelism provided by the remote cluster (1). To use another parallelism, set it at the ./bin/flink client.
Starting execution of program
2018-07-18 16:07:23,551 INFO org.apache.flink.yarn.YarnClusterClient - Starting program in interactive mode (detached: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Job Manager logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-07-18 16:07:19,831 INFO org.apache.flink.yarn.YarnApplicationMasterRunner - --------------------------------------------------------------------------------
2018-07-18 16:07:19,833 INFO org.apache.flink.yarn.YarnApplicationMasterRunner - Starting YARN ApplicationMaster / ResourceManager / JobManager (Version: 1.5.1, Rev:3488f8b, Date:10.07.2018 @ 11:51:27 GMT)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13172971">FLINK-9891</key>
            <summary>Flink cluster is not shutdown in YARN mode when Flink client is stopped</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="azagrebin">Andrey Zagrebin</assignee>
                                    <reporter username="krasovcheg">Sergey Krasovskiy</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 18 Jul 2018 16:37:07 +0000</created>
                <updated>Wed, 17 Oct 2018 08:45:00 +0000</updated>
                            <resolved>Tue, 16 Oct 2018 11:39:32 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.5.1</version>
                                    <fixVersion>1.5.5</fixVersion>
                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Command Line Client</component>
                    <component>Deployment / YARN</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16552017" author="till.rohrmann" created="Sun, 22 Jul 2018 13:42:57 +0000"  >&lt;p&gt;Thanks for reporting the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krasovcheg&quot; class=&quot;user-hover&quot; rel=&quot;krasovcheg&quot;&gt;krasovcheg&lt;/a&gt;. The behaviour you&apos;re observing is unfortunately a technical artifact. If you run the same command with the detached option &lt;tt&gt;-d&lt;/tt&gt;, everything should work as expected.&lt;/p&gt;

&lt;p&gt;Let me quickly explain what&apos;s happening behind the scenes: First of all, a Flink cluster is no longer stopped if the client is terminated because this is just one endpoint for the communication and the user might use a different way to retrieve the job result/wait for the job completion (e.g. calling the REST endpoint with his custom application).&lt;/p&gt;

&lt;p&gt;If you start a Flink per job cluster with the above mentioned command (in attached mode), Flink will actually deploy a session cluster and then submits the program. The reason for this is that your Flink job might consists of multiple parts which the client submits sequentially to the cluster (e.g. a batch job which calls &lt;tt&gt;collect&lt;/tt&gt; or &lt;tt&gt;print&lt;/tt&gt;). Therefore, the Flink cluster needs to be stopped explicitly after a job has finished.&lt;/p&gt;

&lt;p&gt;If you start a Flink per job cluster in detached mode via &lt;tt&gt;-d&lt;/tt&gt;, then Flink knows that there is only a single job which it will include in the deployment message which it sends to Yarn. The cluster will then be started in a slightly different mode which makes sure that the cluster terminates after the job execution finishes (also if you cancel it).&lt;/p&gt;

&lt;p&gt;In order to properly solve this problem, I think we need to rework the client to not start a session cluster if the user uses the above written command (per job mode). Instead, we should start for each job part a dedicated per job cluster. However, also if this works, then the per-job cluster will wait until it has served the execution result at least once before it terminates. Otherwise we won&apos;t be able to send the job results back to a potentially waiting client.&lt;/p&gt;

&lt;p&gt;Moreover, it would be helpful to add a command/utility with which we can stop a Flink cluster (on Yarn, Mesos, etc.).&lt;/p&gt;</comment>
                            <comment id="16563275" author="krasovcheg" created="Tue, 31 Jul 2018 08:08:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; thank you for your response.&lt;/p&gt;

&lt;p&gt;Are you aware if there is any progress on this task? And may we expect the fix in version of Flink 1.5.x?&lt;/p&gt;</comment>
                            <comment id="16563356" author="till.rohrmann" created="Tue, 31 Jul 2018 09:21:22 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krasovcheg&quot; class=&quot;user-hover&quot; rel=&quot;krasovcheg&quot;&gt;krasovcheg&lt;/a&gt;, as far as I know the issue has not been fixed yet. I&apos;m also not sure whether the community will fix it for &lt;tt&gt;1.5.x&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16577358" author="githubbot" created="Sat, 11 Aug 2018 22:27:04 +0000"  >&lt;p&gt;packet23 opened a new pull request #6540: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Added hook to shutdown cluster if a session was created in per-job mode.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6540&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Change minimizes probability of a per-job yarn session cluster surviving after client exited. It restores the Flink 1.4 and below cli behaviour.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;when per-job yarn cluster is deployed, a shutdown hook installed&lt;/li&gt;
	&lt;li&gt;when shutdown hook is called, it terminates the deployed cluster&lt;/li&gt;
	&lt;li&gt;when cli terminates normally, shutdown hook is called by cli and deinstalled&lt;/li&gt;
	&lt;li&gt;otherwise, java runtime will call shutdown hook&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   We verified the change manually by submitting a DataSet API application to Yarn and killing client before job terminated.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: no&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? not documented&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16577359" author="packet" created="Sat, 11 Aug 2018 22:31:00 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&#160;for the detailed explanation. Unfortunately, this bug limits our upgrade possibilities: Our batch jobs (DataSet API) are run by a service that orchestrates complex batch flows. This service needs to cancel running applications if SLA timeout kicks in. So far, we relied on Flink Cli in per-job, attached mode to manage Yarn application life-cycle also in the case of orchestrator cancelling a job.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=suez1224&quot; class=&quot;user-hover&quot; rel=&quot;suez1224&quot;&gt;suez1224&lt;/a&gt;: Is it possible to merge our PR to 1.5 branch, 1.6 branch and master and release 1.5.3 + 1.6.1?&lt;/p&gt;</comment>
                            <comment id="16577421" author="githubbot" created="Sun, 12 Aug 2018 05:34:54 +0000"  >&lt;p&gt;yanghua commented on a change in pull request #6540: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Added hook to shutdown cluster if a session was created in per-job mode.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6540#discussion_r209443483&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6540#discussion_r209443483&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -249,13 +250,24 @@ protected void run(String[] args) throws Exception &lt;/p&gt;
{
 					LOG.info(&quot;Could not properly shut down the client.&quot;, e);
 				}
&lt;p&gt; 			} else {&lt;br/&gt;
+				final ClusterShutdownHook shutdownHook;&lt;br/&gt;
 				if (clusterId != null) &lt;/p&gt;
{
 					client = clusterDescriptor.retrieve(clusterId);
+					shutdownHook = null;
 				}
&lt;p&gt; else {&lt;br/&gt;
 					// also in job mode we have to deploy a session cluster because the job&lt;br/&gt;
 					// might consist of multiple parts (e.g. when using collect)&lt;br/&gt;
 					final ClusterSpecification clusterSpecification = customCommandLine.getClusterSpecification(commandLine);&lt;br/&gt;
 					client = clusterDescriptor.deploySessionCluster(clusterSpecification);&lt;br/&gt;
+					// if not running in detached mode, add a shutdown hook to shut down cluster if client exits&lt;br/&gt;
+					// there&apos;s a race-condition here if cli is killed before shutdown hook is installed&lt;br/&gt;
+					if (!runOptions.getDetachedMode()) {&lt;br/&gt;
+						shutdownHook = new ClusterShutdownHook(client);&lt;br/&gt;
+						Runtime.getRuntime().addShutdownHook(shutdownHook);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   In flink-core there is a `ShutdownHookUtil` util class you can consider&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16577422" author="githubbot" created="Sun, 12 Aug 2018 05:34:54 +0000"  >&lt;p&gt;yanghua commented on a change in pull request #6540: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Added hook to shutdown cluster if a session was created in per-job mode.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6540#discussion_r209443343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6540#discussion_r209443343&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1219,4 +1231,21 @@ public static void setJobManagerAddressInConfig(Configuration config, InetSocket&lt;br/&gt;
 		return constructor.newInstance(params);&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	private static class ClusterShutdownHook extends Thread {&lt;br/&gt;
+		private final ClusterClient&amp;lt;?&amp;gt; client;&lt;br/&gt;
+&lt;br/&gt;
+		ClusterShutdownHook(ClusterClient&amp;lt;?&amp;gt; client) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   here use `@Nonnull` looks better to me&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16577908" author="till.rohrmann" created="Mon, 13 Aug 2018 07:23:04 +0000"  >&lt;p&gt;Would it be an option to use `yarn application -kill` to terminate the Flink cluster instead of adding the shut down hook &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=packet&quot; class=&quot;user-hover&quot; rel=&quot;packet&quot;&gt;packet&lt;/a&gt;? The only thing you need to retrieve is the corresponding application id of the running Flink cluster.&lt;/p&gt;</comment>
                            <comment id="16578017" author="packet" created="Mon, 13 Aug 2018 09:35:53 +0000"  >&lt;p&gt;Exactly, in the past, doing exactly that proved to be very fragile. How would I retrieve the Yarn application id given job was submitted via &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;flink run -m yarn-cluster ...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; ?&lt;/p&gt;</comment>
                            <comment id="16579331" author="githubbot" created="Tue, 14 Aug 2018 06:52:41 +0000"  >&lt;p&gt;packet23 commented on a change in pull request #6540: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Added hook to shutdown cluster if a session was created in per-job mode.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6540#discussion_r209844574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6540#discussion_r209844574&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1219,4 +1231,21 @@ public static void setJobManagerAddressInConfig(Configuration config, InetSocket&lt;br/&gt;
 		return constructor.newInstance(params);&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	private static class ClusterShutdownHook extends Thread {&lt;br/&gt;
+		private final ClusterClient&amp;lt;?&amp;gt; client;&lt;br/&gt;
+&lt;br/&gt;
+		ClusterShutdownHook(ClusterClient&amp;lt;?&amp;gt; client) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Thanks @yanghua for reviewing. Do you mean @Nonnull in addition to Objects.requireNonNull() or as replacement?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16579332" author="githubbot" created="Tue, 14 Aug 2018 06:56:06 +0000"  >&lt;p&gt;yanghua commented on a change in pull request #6540: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Added hook to shutdown cluster if a session was created in per-job mode.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6540#discussion_r209845260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6540#discussion_r209845260&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1219,4 +1231,21 @@ public static void setJobManagerAddressInConfig(Configuration config, InetSocket&lt;br/&gt;
 		return constructor.newInstance(params);&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	private static class ClusterShutdownHook extends Thread {&lt;br/&gt;
+		private final ClusterClient&amp;lt;?&amp;gt; client;&lt;br/&gt;
+&lt;br/&gt;
+		ClusterShutdownHook(ClusterClient&amp;lt;?&amp;gt; client) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Not replace, keep both of them.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16598966" author="azagrebin" created="Fri, 31 Aug 2018 16:25:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=packet&quot; class=&quot;user-hover&quot; rel=&quot;packet&quot;&gt;packet&lt;/a&gt;, do you see something like this in the logs when run the job and cancel it?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Submitting application master&#160;..&amp;lt;ID&amp;gt;..&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;from&#160;AbstractYarnClusterDescriptor.startAppMaster.&lt;/p&gt;

&lt;p&gt;This should the&#160;Yarn application id.&lt;/p&gt;</comment>
                            <comment id="16607349" author="githubbot" created="Fri, 7 Sep 2018 16:51:19 +0000"  >&lt;p&gt;tillrohrmann commented on issue #6540: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Added hook to shutdown cluster if a session was created in per-job mode.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6540#issuecomment-419500426&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6540#issuecomment-419500426&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I like the idea of making this behaviour configurable. @packet23 do you have time to add this functionality?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16608917" author="packet" created="Mon, 10 Sep 2018 09:11:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; It&apos;s not only parsing log outputs &amp;#8211; it&apos;s also keeping state, which we try to avoid.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; I can see where it fits, do you think it should go to flink-conf.yaml or be exposed as one of the yarn options for flink cli?&lt;/p&gt;</comment>
                            <comment id="16620749" author="githubbot" created="Wed, 19 Sep 2018 15:25:50 +0000"  >&lt;p&gt;azagrebin opened a new pull request #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This PR picks up #6540, adds a cli option to activate the cluster shutdown hook. By default, it preserves previous behaviour where cluster is not shutdown in case of abrupt cli exit.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add SHUTDOWN_IF_ATTACHED_OPTION in cli&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Trivial option, can be checked running example job in local yarn cluster:&lt;br/&gt;
   HADOOP_CLASSPATH=`hadoop classpath` $FLINK/bin/flink run -m yarn-cluster $FLINK/examples/streaming/WordCount.jar&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (docs)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16620750" author="githubbot" created="Wed, 19 Sep 2018 15:29:38 +0000"  >&lt;p&gt;azagrebin commented on issue #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#issuecomment-422847652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#issuecomment-422847652&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   cc @tillrohrmann @GJL &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16620752" author="githubbot" created="Wed, 19 Sep 2018 15:29:54 +0000"  >&lt;p&gt;azagrebin edited a comment on issue #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#issuecomment-422847652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#issuecomment-422847652&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   cc @tillrohrmann @GJL @packet23 &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16620755" author="githubbot" created="Wed, 19 Sep 2018 15:33:19 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#discussion_r218853427&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#discussion_r218853427&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: docs/ops/cli.md&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -257,6 +257,9 @@ Action &quot;run&quot; compiles and runs a program.&lt;br/&gt;
      &lt;del&gt;s,&lt;/del&gt;-fromSavepoint &amp;lt;savepointPath&amp;gt;   Path to a savepoint to restore the job&lt;br/&gt;
                                           from (for example&lt;br/&gt;
                                           hdfs:///flink/savepoint-1537).&lt;br/&gt;
+     &lt;del&gt;sae,&lt;/del&gt;-schutdownOnAttachedExist      If the job mode is not detached and&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   &lt;em&gt;shutdown&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16620758" author="githubbot" created="Wed, 19 Sep 2018 15:34:06 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#discussion_r218853732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#discussion_r218853732&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-clients/src/main/java/org/apache/flink/client/cli/ProgramOptions.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -57,6 +58,8 @@&lt;/p&gt;

&lt;p&gt; 	private final boolean detachedMode;&lt;/p&gt;

&lt;p&gt;+	private final boolean schutdownOnAttachedExist;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   &lt;em&gt;shutdown&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16620770" author="githubbot" created="Wed, 19 Sep 2018 15:49:00 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#discussion_r218859953&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#discussion_r218859953&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: docs/ops/cli.md&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -265,6 +268,9 @@ Action &quot;run&quot; compiles and runs a program.&lt;br/&gt;
                                           connect to a different JobManager than&lt;br/&gt;
                                           the one specified in the&lt;br/&gt;
                                           configuration.&lt;br/&gt;
+     &lt;del&gt;sae,&lt;/del&gt;-schutdownOnAttachedExist      If the job mode is not detached and&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Is this supposed to be &lt;em&gt;exit&lt;/em&gt; instead of &lt;em&gt;exist&lt;/em&gt;? How about `--shutdownOnExit`?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16622296" author="githubbot" created="Thu, 20 Sep 2018 16:26:22 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#discussion_r219231030&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#discussion_r219231030&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: docs/ops/cli.md&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -265,6 +269,10 @@ Action &quot;run&quot; compiles and runs a program.&lt;br/&gt;
                                           connect to a different JobManager than&lt;br/&gt;
                                           the one specified in the&lt;br/&gt;
                                           configuration.&lt;br/&gt;
+     &lt;del&gt;sae,&lt;/del&gt;-shutdownOnAttachedExit        If the job mode is not detached and a&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I&apos;d rephrase it a bit: &lt;em&gt;If the job is submitted in attached mode, perform a best-effort cluster shutdown when the CLI is terminated abruptly, e.g., in response to a user interrupt, such as typing Ctrl + C.&lt;/em&gt; &lt;/p&gt;

&lt;p&gt;   If you don&apos;t like it, I&apos;d at least change &lt;em&gt;the best effort cluster shutdown&lt;/em&gt; to &lt;em&gt;a best-effort cluster shutdown&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16622297" author="githubbot" created="Thu, 20 Sep 2018 16:26:22 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#discussion_r219226199&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#discussion_r219226199&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-clients/src/main/java/org/apache/flink/client/cli/ProgramOptions.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -145,6 +149,10 @@ public boolean getDetachedMode() &lt;/p&gt;
{
 		return detachedMode;
 	}

&lt;p&gt;+	public boolean isShutdownOnAttachedExist() {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   &lt;em&gt;exit&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16622298" author="githubbot" created="Thu, 20 Sep 2018 16:26:22 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#discussion_r219225730&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#discussion_r219225730&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -492,11 +505,10 @@ private static void printJobStatusMessages(List&amp;lt;JobStatusMessage&amp;gt; jobs) {&lt;br/&gt;
 		jobsByState.entrySet().stream()&lt;br/&gt;
 			.sorted(statusComparator)&lt;br/&gt;
 			.map(Map.Entry::getValue).flatMap(List::stream).sorted(startTimeComparator)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.forEachOrdered(job -&amp;gt; 
{
-			System.out.println(dateFormat.format(new Date(job.getStartTime()))
-				+ &quot; : &quot; + job.getJobId() + &quot; : &quot; + job.getJobName()
-				+ &quot; (&quot; + job.getJobState() + &quot;)&quot;);
-		}
&lt;p&gt;);&lt;br/&gt;
+			.forEachOrdered(job -&amp;gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   nit: unrelated formatting change?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16622299" author="githubbot" created="Thu, 20 Sep 2018 16:26:23 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#discussion_r219226146&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#discussion_r219226146&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-clients/src/main/java/org/apache/flink/client/cli/ProgramOptions.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -57,6 +58,8 @@&lt;/p&gt;

&lt;p&gt; 	private final boolean detachedMode;&lt;/p&gt;

&lt;p&gt;+	private final boolean shutdownOnAttachedExist;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   &lt;em&gt;exit&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16623270" author="githubbot" created="Fri, 21 Sep 2018 08:32:41 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#discussion_r219421119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#discussion_r219421119&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -492,11 +505,10 @@ private static void printJobStatusMessages(List&amp;lt;JobStatusMessage&amp;gt; jobs) {&lt;br/&gt;
 		jobsByState.entrySet().stream()&lt;br/&gt;
 			.sorted(statusComparator)&lt;br/&gt;
 			.map(Map.Entry::getValue).flatMap(List::stream).sorted(startTimeComparator)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.forEachOrdered(job -&amp;gt; 
{
-			System.out.println(dateFormat.format(new Date(job.getStartTime()))
-				+ &quot; : &quot; + job.getJobId() + &quot; : &quot; + job.getJobName()
-				+ &quot; (&quot; + job.getJobState() + &quot;)&quot;);
-		}
&lt;p&gt;);&lt;br/&gt;
+			.forEachOrdered(job -&amp;gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   yes, redundant brackets in one-line lambda&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16627428" author="githubbot" created="Tue, 25 Sep 2018 14:13:47 +0000"  >&lt;p&gt;GJL commented on issue #6540: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Added hook to shutdown cluster if a session was created in per-job mode.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6540#issuecomment-424360084&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6540#issuecomment-424360084&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   LGTM, merging.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16627429" author="githubbot" created="Tue, 25 Sep 2018 14:14:20 +0000"  >&lt;p&gt;GJL edited a comment on issue #6540: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Added hook to shutdown cluster if a session was created in per-job mode.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6540#issuecomment-424360084&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6540#issuecomment-424360084&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thank you for your contribution to Apache Flink, @packet23. LGTM, merging.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16627431" author="githubbot" created="Tue, 25 Sep 2018 14:14:40 +0000"  >&lt;p&gt;GJL commented on issue #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718#issuecomment-424360423&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718#issuecomment-424360423&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thank you for your contribution to Apache Flink, @azagrebin. LGTM, merging.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16628662" author="githubbot" created="Wed, 26 Sep 2018 12:06:21 +0000"  >&lt;p&gt;asfgit closed pull request #6540: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Added hook to shutdown cluster if a session was created in per-job mode.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6540&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java b/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
index 2e78e4a615b..780f8144029 100644&lt;br/&gt;
&amp;#8212; a/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
+++ b/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
@@ -58,6 +58,7 @@&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
 import org.apache.flink.util.FlinkException;&lt;br/&gt;
 import org.apache.flink.util.Preconditions;&lt;br/&gt;
+import org.apache.flink.util.ShutdownHookUtil;&lt;/p&gt;

&lt;p&gt; import org.apache.commons.cli.CommandLine;&lt;br/&gt;
 import org.apache.commons.cli.Options;&lt;br/&gt;
@@ -249,13 +250,22 @@ protected void run(String[] args) throws Exception &lt;/p&gt;
{
 					LOG.info(&quot;Could not properly shut down the client.&quot;, e);
 				}
&lt;p&gt; 			} else {&lt;br/&gt;
+				final Thread shutdownHook;&lt;br/&gt;
 				if (clusterId != null) &lt;/p&gt;
{
 					client = clusterDescriptor.retrieve(clusterId);
+					shutdownHook = null;
 				}
&lt;p&gt; else {&lt;br/&gt;
 					// also in job mode we have to deploy a session cluster because the job&lt;br/&gt;
 					// might consist of multiple parts (e.g. when using collect)&lt;br/&gt;
 					final ClusterSpecification clusterSpecification = customCommandLine.getClusterSpecification(commandLine);&lt;br/&gt;
 					client = clusterDescriptor.deploySessionCluster(clusterSpecification);&lt;br/&gt;
+					// if not running in detached mode, add a shutdown hook to shut down cluster if client exits&lt;br/&gt;
+					// there&apos;s a race-condition here if cli is killed before shutdown hook is installed&lt;br/&gt;
+					if (!runOptions.getDetachedMode()) &lt;/p&gt;
{
+						shutdownHook = ShutdownHookUtil.addShutdownHook(client::shutDownCluster, client.getClass().getSimpleName(), LOG);
+					}
&lt;p&gt; else &lt;/p&gt;
{
+						shutdownHook = null;
+					}
&lt;p&gt; 				}&lt;/p&gt;

&lt;p&gt; 				try {&lt;br/&gt;
@@ -278,12 +288,12 @@ protected void run(String[] args) throws Exception &lt;/p&gt;
{
 
 					executeProgram(program, client, userParallelism);
 				}
&lt;p&gt; finally {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (clusterId == null &amp;amp;&amp;amp; !client.isDetached()) {&lt;br/&gt;
+					if (shutdownHook != null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: { 						// terminate the cluster only if we have started it before and if it&amp;#39;s not detached 						try {
-							client.shutDownCluster();
-						} catch (final Exception e) {
-							LOG.info(&quot;Could not properly terminate the Flink cluster.&quot;, e);
+							shutdownHook.run();
+						} finally {
+							ShutdownHookUtil.removeShutdownHook(shutdownHook, client.getClass().getSimpleName(), LOG);
 						} 					}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16628663" author="githubbot" created="Wed, 26 Sep 2018 12:06:21 +0000"  >&lt;p&gt;asfgit closed pull request #6718: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9891&quot; title=&quot;Flink cluster is not shutdown in YARN mode when Flink client is stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9891&quot;&gt;&lt;del&gt;FLINK-9891&lt;/del&gt;&lt;/a&gt; Add optional hook to shutdown cluster if a session was created in per-job mode in attached mode&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6718&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6718&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/docs/ops/cli.md b/docs/ops/cli.md&lt;br/&gt;
index f96ccf52ea9..9af5c5b5333 100644&lt;br/&gt;
&amp;#8212; a/docs/ops/cli.md&lt;br/&gt;
+++ b/docs/ops/cli.md&lt;br/&gt;
@@ -257,6 +257,11 @@ Action &quot;run&quot; compiles and runs a program.&lt;br/&gt;
      &lt;del&gt;s,&lt;/del&gt;-fromSavepoint &amp;lt;savepointPath&amp;gt;   Path to a savepoint to restore the job&lt;br/&gt;
                                           from (for example&lt;br/&gt;
                                           hdfs:///flink/savepoint-1537).&lt;br/&gt;
+     &lt;del&gt;sae,&lt;/del&gt;-shutdownOnAttachedExit        If the job is submitted in attached&lt;br/&gt;
+                                          mode, perform a best-effort cluster&lt;br/&gt;
+                                          shutdown when the CLI is terminated&lt;br/&gt;
+                                          abruptly, e.g., in response to a user&lt;br/&gt;
+                                          interrupt, such as typing Ctrl + C.&lt;br/&gt;
   Options for yarn-cluster mode:&lt;br/&gt;
      &lt;del&gt;d,&lt;/del&gt;-detached                        If present, runs the job in detached&lt;br/&gt;
                                           mode&lt;br/&gt;
@@ -265,6 +270,11 @@ Action &quot;run&quot; compiles and runs a program.&lt;br/&gt;
                                           connect to a different JobManager than&lt;br/&gt;
                                           the one specified in the&lt;br/&gt;
                                           configuration.&lt;br/&gt;
+     &lt;del&gt;sae,&lt;/del&gt;-shutdownOnAttachedExit        If the job is submitted in attached&lt;br/&gt;
+                                          mode, perform a best-effort cluster&lt;br/&gt;
+                                          shutdown when the CLI is terminated&lt;br/&gt;
+                                          abruptly, e.g., in response to a user&lt;br/&gt;
+                                          interrupt, such as typing Ctrl + C.&lt;br/&gt;
      -yD &amp;lt;property=value&amp;gt;                 use value for given property&lt;br/&gt;
      &lt;del&gt;yd,&lt;/del&gt;-yarndetached                   If present, runs the job in detached&lt;br/&gt;
                                           mode (deprecated; use non-YARN&lt;br/&gt;
diff --git a/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java b/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
index e2a260c5478..ae0052c3c38 100644&lt;br/&gt;
&amp;#8212; a/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
+++ b/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java&lt;br/&gt;
@@ -58,6 +58,7 @@&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
 import org.apache.flink.util.FlinkException;&lt;br/&gt;
 import org.apache.flink.util.Preconditions;&lt;br/&gt;
+import org.apache.flink.util.ShutdownHookUtil;&lt;/p&gt;

&lt;p&gt; import org.apache.commons.cli.CommandLine;&lt;br/&gt;
 import org.apache.commons.cli.Options;&lt;br/&gt;
@@ -250,13 +251,22 @@ protected void run(String[] args) throws Exception &lt;/p&gt;
{
 					LOG.info(&quot;Could not properly shut down the client.&quot;, e);
 				}
&lt;p&gt; 			} else {&lt;br/&gt;
+				final Thread shutdownHook;&lt;br/&gt;
 				if (clusterId != null) &lt;/p&gt;
{
 					client = clusterDescriptor.retrieve(clusterId);
+					shutdownHook = null;
 				}
&lt;p&gt; else {&lt;br/&gt;
 					// also in job mode we have to deploy a session cluster because the job&lt;br/&gt;
 					// might consist of multiple parts (e.g. when using collect)&lt;br/&gt;
 					final ClusterSpecification clusterSpecification = customCommandLine.getClusterSpecification(commandLine);&lt;br/&gt;
 					client = clusterDescriptor.deploySessionCluster(clusterSpecification);&lt;br/&gt;
+					// if not running in detached mode, add a shutdown hook to shut down cluster if client exits&lt;br/&gt;
+					// there&apos;s a race-condition here if cli is killed before shutdown hook is installed&lt;br/&gt;
+					if (!runOptions.getDetachedMode() &amp;amp;&amp;amp; runOptions.isShutdownOnAttachedExit()) &lt;/p&gt;
{
+						shutdownHook = ShutdownHookUtil.addShutdownHook(client::shutDownCluster, client.getClass().getSimpleName(), LOG);
+					}
&lt;p&gt; else &lt;/p&gt;
{
+						shutdownHook = null;
+					}
&lt;p&gt; 				}&lt;/p&gt;

&lt;p&gt; 				try {&lt;br/&gt;
@@ -286,8 +296,11 @@ protected void run(String[] args) throws Exception {&lt;br/&gt;
 						} catch (final Exception e) &lt;/p&gt;
{
 							LOG.info(&quot;Could not properly terminate the Flink cluster.&quot;, e);
 						}
&lt;p&gt;+						if (shutdownHook != null) &lt;/p&gt;
{
+							// we do not need the hook anymore as we have just tried to shutdown the cluster.
+							ShutdownHookUtil.removeShutdownHook(shutdownHook, client.getClass().getSimpleName(), LOG);
+						}
&lt;p&gt; 					}&lt;br/&gt;
-&lt;br/&gt;
 					try &lt;/p&gt;
{
 						client.shutdown();
 					}
&lt;p&gt; catch (Exception e) {&lt;br/&gt;
@@ -492,11 +505,10 @@ private static void printJobStatusMessages(List&amp;lt;JobStatusMessage&amp;gt; jobs) {&lt;br/&gt;
 		jobsByState.entrySet().stream()&lt;br/&gt;
 			.sorted(statusComparator)&lt;br/&gt;
 			.map(Map.Entry::getValue).flatMap(List::stream).sorted(startTimeComparator)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.forEachOrdered(job -&amp;gt; 
{
-			System.out.println(dateFormat.format(new Date(job.getStartTime()))
-				+ &quot; : &quot; + job.getJobId() + &quot; : &quot; + job.getJobName()
-				+ &quot; (&quot; + job.getJobState() + &quot;)&quot;);
-		}
&lt;p&gt;);&lt;br/&gt;
+			.forEachOrdered(job -&amp;gt;&lt;br/&gt;
+				System.out.println(dateFormat.format(new Date(job.getStartTime()))&lt;br/&gt;
+					+ &quot; : &quot; + job.getJobId() + &quot; : &quot; + job.getJobName()&lt;br/&gt;
+					+ &quot; (&quot; + job.getJobState() + &quot;)&quot;));&lt;br/&gt;
 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;br/&gt;
@@ -827,11 +839,8 @@ protected void executeProgram(PackagedProgram program, ClusterClient&amp;lt;?&amp;gt; client,&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Creates a Packaged program from the given command line options.&lt;br/&gt;
 	 *&lt;/li&gt;
	&lt;li&gt;@return A PackagedProgram (upon success)&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @throws java.io.FileNotFoundException&lt;/li&gt;
	&lt;li&gt;* @throws org.apache.flink.client.program.ProgramInvocationException&lt;br/&gt;
 	 */&lt;/li&gt;
	&lt;li&gt;protected PackagedProgram buildProgram(ProgramOptions options)&lt;/li&gt;
	&lt;li&gt;throws FileNotFoundException, ProgramInvocationException {&lt;br/&gt;
+	PackagedProgram buildProgram(ProgramOptions options) throws FileNotFoundException, ProgramInvocationException {&lt;br/&gt;
 		String[] programArgs = options.getProgramArgs();&lt;br/&gt;
 		String jarFilePath = options.getJarFilePath();&lt;br/&gt;
 		List&amp;lt;URL&amp;gt; classpaths = options.getClasspaths();&lt;br/&gt;
@@ -1163,7 +1172,7 @@ else if (new File(CONFIG_DIRECTORY_FALLBACK_2).exists()) {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param address Address to write to the configuration&lt;/li&gt;
	&lt;li&gt;@param config The configuration to write to&lt;br/&gt;
 	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public static void setJobManagerAddressInConfig(Configuration config, InetSocketAddress address) {&lt;br/&gt;
+	static void setJobManagerAddressInConfig(Configuration config, InetSocketAddress address) {&lt;br/&gt;
 		config.setString(JobManagerOptions.ADDRESS, address.getHostString());&lt;br/&gt;
 		config.setInteger(JobManagerOptions.PORT, address.getPort());&lt;br/&gt;
 		config.setString(RestOptions.ADDRESS, address.getHostString());&lt;br/&gt;
diff --git a/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontendParser.java b/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontendParser.java&lt;br/&gt;
index 357a87e4fbc..8eb0dd6774e 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontendParser.java&lt;br/&gt;
+++ b/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontendParser.java&lt;br/&gt;
@@ -63,6 +63,11 @@&lt;br/&gt;
 	public static final Option DETACHED_OPTION = new Option(&quot;d&quot;, &quot;detached&quot;, false, &quot;If present, runs &quot; +&lt;br/&gt;
 			&quot;the job in detached mode&quot;);&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+	public static final Option SHUTDOWN_IF_ATTACHED_OPTION = new Option(&lt;br/&gt;
+		&quot;sae&quot;, &quot;shutdownOnAttachedExit&quot;, false,&lt;br/&gt;
+		&quot;If the job is submitted in attached mode, perform a best-effort cluster shutdown &quot; +&lt;br/&gt;
+			&quot;when the CLI is terminated abruptly, e.g., in response to a user interrupt, such as typing Ctrl + C.&quot;);&lt;br/&gt;
+&lt;br/&gt;
 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@deprecated use non-prefixed variant 
{@link #DETACHED_OPTION}
&lt;p&gt; for both YARN and non-YARN deployments&lt;br/&gt;
 	 */&lt;br/&gt;
@@ -128,6 +133,7 @@&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		LOGGING_OPTION.setRequired(false);&lt;br/&gt;
 		DETACHED_OPTION.setRequired(false);&lt;br/&gt;
+		SHUTDOWN_IF_ATTACHED_OPTION.setRequired(false);&lt;br/&gt;
 		YARN_DETACHED_OPTION.setRequired(false);&lt;/p&gt;

&lt;p&gt; 		ARGS_OPTION.setRequired(false);&lt;br/&gt;
@@ -170,6 +176,7 @@ private static Options getProgramSpecificOptions(Options options) &lt;/p&gt;
{
 		options.addOption(ARGS_OPTION);
 		options.addOption(LOGGING_OPTION);
 		options.addOption(DETACHED_OPTION);
+		options.addOption(SHUTDOWN_IF_ATTACHED_OPTION);
 		options.addOption(YARN_DETACHED_OPTION);
 		return options;
 	}
&lt;p&gt;@@ -180,6 +187,7 @@ private static Options getProgramSpecificOptionsWithoutDeprecatedOptions(Options&lt;br/&gt;
 		options.addOption(PARALLELISM_OPTION);&lt;br/&gt;
 		options.addOption(LOGGING_OPTION);&lt;br/&gt;
 		options.addOption(DETACHED_OPTION);&lt;br/&gt;
+		options.addOption(SHUTDOWN_IF_ATTACHED_OPTION);&lt;br/&gt;
 		return options;&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;diff --git a/flink-clients/src/main/java/org/apache/flink/client/cli/ProgramOptions.java b/flink-clients/src/main/java/org/apache/flink/client/cli/ProgramOptions.java&lt;br/&gt;
index ccaa4916f9c..da03d64048c 100644&lt;br/&gt;
&amp;#8212; a/flink-clients/src/main/java/org/apache/flink/client/cli/ProgramOptions.java&lt;br/&gt;
+++ b/flink-clients/src/main/java/org/apache/flink/client/cli/ProgramOptions.java&lt;br/&gt;
@@ -36,6 +36,7 @@&lt;br/&gt;
 import static org.apache.flink.client.cli.CliFrontendParser.JAR_OPTION;&lt;br/&gt;
 import static org.apache.flink.client.cli.CliFrontendParser.LOGGING_OPTION;&lt;br/&gt;
 import static org.apache.flink.client.cli.CliFrontendParser.PARALLELISM_OPTION;&lt;br/&gt;
+import static org.apache.flink.client.cli.CliFrontendParser.SHUTDOWN_IF_ATTACHED_OPTION;&lt;br/&gt;
 import static org.apache.flink.client.cli.CliFrontendParser.YARN_DETACHED_OPTION;&lt;/p&gt;

&lt;p&gt; /**&lt;br/&gt;
@@ -57,6 +58,8 @@&lt;/p&gt;

&lt;p&gt; 	private final boolean detachedMode;&lt;/p&gt;

&lt;p&gt;+	private final boolean shutdownOnAttachedExit;&lt;br/&gt;
+&lt;br/&gt;
 	private final SavepointRestoreSettings savepointSettings;&lt;/p&gt;

&lt;p&gt; 	protected ProgramOptions(CommandLine line) throws CliArgsException {&lt;br/&gt;
@@ -113,6 +116,7 @@ else if (args.length &amp;gt; 0) &lt;/p&gt;
{
 		stdoutLogging = !line.hasOption(LOGGING_OPTION.getOpt());
 		detachedMode = line.hasOption(DETACHED_OPTION.getOpt()) || line.hasOption(
 			YARN_DETACHED_OPTION.getOpt());
+		shutdownOnAttachedExit = line.hasOption(SHUTDOWN_IF_ATTACHED_OPTION.getOpt());
 
 		this.savepointSettings = CliFrontendParser.createSavepointRestoreSettings(line);
 	}
&lt;p&gt;@@ -145,6 +149,10 @@ public boolean getDetachedMode() &lt;/p&gt;
{
 		return detachedMode;
 	}

&lt;p&gt;+	public boolean isShutdownOnAttachedExit() &lt;/p&gt;
{
+		return shutdownOnAttachedExit;
+	}
&lt;p&gt;+&lt;br/&gt;
 	public SavepointRestoreSettings getSavepointRestoreSettings() &lt;/p&gt;
{
 		return savepointSettings;
 	}
&lt;p&gt;diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/cli/FlinkYarnSessionCli.java b/flink-yarn/src/main/java/org/apache/flink/yarn/cli/FlinkYarnSessionCli.java&lt;br/&gt;
index c0180a83be1..e0c0f942405 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/main/java/org/apache/flink/yarn/cli/FlinkYarnSessionCli.java&lt;br/&gt;
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/cli/FlinkYarnSessionCli.java&lt;br/&gt;
@@ -85,6 +85,7 @@&lt;br/&gt;
 import java.util.stream.Stream;&lt;/p&gt;

&lt;p&gt; import static org.apache.flink.client.cli.CliFrontendParser.DETACHED_OPTION;&lt;br/&gt;
+import static org.apache.flink.client.cli.CliFrontendParser.SHUTDOWN_IF_ATTACHED_OPTION;&lt;br/&gt;
 import static org.apache.flink.client.cli.CliFrontendParser.YARN_DETACHED_OPTION;&lt;br/&gt;
 import static org.apache.flink.configuration.HighAvailabilityOptions.HA_CLUSTER_ID;&lt;/p&gt;

&lt;p&gt;@@ -218,6 +219,7 @@ public FlinkYarnSessionCli(&lt;br/&gt;
 		allOptions.addOption(slots);&lt;br/&gt;
 		allOptions.addOption(dynamicproperties);&lt;br/&gt;
 		allOptions.addOption(DETACHED_OPTION);&lt;br/&gt;
+		allOptions.addOption(SHUTDOWN_IF_ATTACHED_OPTION);&lt;br/&gt;
 		allOptions.addOption(YARN_DETACHED_OPTION);&lt;br/&gt;
 		allOptions.addOption(streaming);&lt;br/&gt;
 		allOptions.addOption(name);&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16651545" author="till.rohrmann" created="Tue, 16 Oct 2018 11:39:32 +0000"  >&lt;p&gt;fixed via&lt;/p&gt;

&lt;p&gt;1.5:&lt;br/&gt;
70b48d63e5aed6411ccbdb443af0222515331867&lt;br/&gt;
941557026b291217a73ca290ad70b367955d0168&lt;/p&gt;

&lt;p&gt;1.6:&lt;br/&gt;
d753db27757376def72eda1d3c312a3d128a4bae&lt;br/&gt;
8d92e4ea86270e51b143334db5407b4526e8694e&lt;/p&gt;

&lt;p&gt;1.7:&lt;br/&gt;
01fd88502a00bf47975e40f8d8433ebc7c23042b&lt;br/&gt;
a36d1999f743d00c4fac8fdf61ad85a4b5d5f3bc&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w153:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>