<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:25:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-3888] Custom Aggregator with Convergence can&apos;t be registered directly with DeltaIteration</title>
                <link>https://issues.apache.org/jira/browse/FLINK-3888</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Contrary to the &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-master/apis/batch/iterations.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt; the method to add an aggregator with a custom convergence criterion to a DeltaIteration is not exposed directly to DeltaIteration, but can only be accessed via the &lt;tt&gt;aggregatorRegistry&lt;/tt&gt;.&lt;br/&gt;
Moreover, when registering an aggregator with a custom convergence criterion  and running the program, the following exception appears in the logs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Error: Cannot use custom convergence criterion with workset iteration. Workset iterations have implicit convergence criterion where workset is empty.
org.apache.flink.optimizer.CompilerException: Error: Cannot use custom convergence criterion with workset iteration. Workset iterations have implicit convergence criterion where workset is empty.
	at org.apache.flink.optimizer.plantranslate.JobGraphGenerator.finalizeWorksetIteration(JobGraphGenerator.java:1518)
	at org.apache.flink.optimizer.plantranslate.JobGraphGenerator.compileJobGraph(JobGraphGenerator.java:198)
	at org.apache.flink.optimizer.plantranslate.JobGraphGenerator.compileJobGraph(JobGraphGenerator.java:164)
	at org.apache.flink.test.util.TestEnvironment.execute(TestEnvironment.java:76)
	at org.apache.flink.api.java.ExecutionEnvironment.execute(ExecutionEnvironment.java:898)
	at org.apache.flink.api.java.DataSet.collect(DataSet.java:410)
	at org.apache.flink.api.java.DataSet.print(DataSet.java:1605)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The issue has been found while discussing &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2926&quot; title=&quot;Add a Strongly Connected Components Library Method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2926&quot;&gt;&lt;del&gt;FLINK-2926&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12966261">FLINK-3888</key>
            <summary>Custom Aggregator with Convergence can&apos;t be registered directly with DeltaIteration</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vkalavri">Vasia Kalavri</assignee>
                                    <reporter username="mliesenberg">Martin Liesenberg</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 May 2016 18:53:52 +0000</created>
                <updated>Sun, 29 Jan 2017 14:43:44 +0000</updated>
                            <resolved>Fri, 21 Oct 2016 10:37:35 +0000</resolved>
                                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15543133" author="vkalavri" created="Mon, 3 Oct 2016 18:58:44 +0000"  >&lt;p&gt;I had a quick look into this and I don&apos;t see any fundamental reason why we can&apos;t add a custom convergence criterion in delta iterations. It seems that it is currently allowed to add one convergence criterion only, and since delta iterations have the &lt;tt&gt;WorksetEmptyConvergenceCriterion&lt;/tt&gt; by default, adding a custom one is not possible.&lt;/p&gt;

&lt;p&gt;So, one solution could be the following:&lt;br/&gt;
1. use &lt;tt&gt;TaskConfig.setConvergenceCriterion()&lt;/tt&gt; to set the custom, user-defined convergence criterion (like in the case of bulk iteration)&lt;br/&gt;
2. add a new method &lt;tt&gt;TaskConfig.setDefaultConvergeCriterion()&lt;/tt&gt; to add the default empty workset convergence&lt;br/&gt;
&#8203;3. check both criteria in &lt;tt&gt;IterationSynchronizationSinkTask.checkForConvergence()&#8203;&lt;/tt&gt;&lt;br/&gt;
4. expose the custom convergence criterion in &lt;tt&gt;DeltaIteration&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;If I&apos;m not missing something and this seems acceptable I&apos;d like to resolve this issue. Custom convergence would be helpful in several Gelly algorithms.&lt;/p&gt;</comment>
                            <comment id="15543190" author="greghogan" created="Mon, 3 Oct 2016 19:27:50 +0000"  >&lt;p&gt;This looks quite useful. Why have a function to enable the default rather than having &lt;tt&gt;TaskConfig.setConvergenceCriterion()&lt;/tt&gt; override the default? Do we need &lt;tt&gt;TaskConfig.setDefaultConvergeCriterion()&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="15543256" author="vkalavri" created="Mon, 3 Oct 2016 20:00:05 +0000"  >&lt;p&gt;We shouldn&apos;t override the default convergence criterion of the delta iteration. When the workset is empty there&apos;s no work to do. Instead, if a custom criterion is provided, the convergence condition should be the disjunction of the two.&lt;/p&gt;</comment>
                            <comment id="15543308" author="greghogan" created="Mon, 3 Oct 2016 20:19:56 +0000"  >&lt;p&gt;Okay, that sounds better than requiring the user to additionally test for workset convergence.&lt;/p&gt;</comment>
                            <comment id="15569630" author="githubbot" created="Wed, 12 Oct 2016 19:17:03 +0000"  >&lt;p&gt;Github user greghogan commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2606#discussion_r83069609&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2606#discussion_r83069609&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/plantranslate/JobGraphGenerator.java &amp;#8212;&lt;br/&gt;
    @@ -1513,14 +1513,21 @@ private void finalizeWorksetIteration(IterationDescriptor descr) {&lt;/p&gt;

&lt;p&gt;     		String convAggName = aggs.getConvergenceCriterionAggregatorName();&lt;br/&gt;
     		ConvergenceCriterion&amp;lt;?&amp;gt; convCriterion = aggs.getConvergenceCriterion();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;    +&lt;br/&gt;
     		if (convCriterion != null || convAggName != null) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;throw new CompilerException(&quot;Error: Cannot use custom convergence criterion with workset iteration. Workset iterations have implicit convergence criterion where workset is empty.&quot;);&lt;br/&gt;
    +			if (convCriterion == null) 
{
    +				throw new CompilerException(&quot;Error: Convergence criterion aggregator set, but criterion is null.&quot;);
    +			}
&lt;p&gt;    +			if (convAggName == null) &lt;/p&gt;
{
    +				throw new CompilerException(&quot;Error: Aggregator convergence criterion set, but aggregator is null.&quot;);
    +			}
&lt;p&gt;    +&lt;br/&gt;
    +			syncConfig.setConvergenceCriterion(convAggName, convCriterion);&lt;br/&gt;
     		}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		headConfig.addIterationAggregator(WorksetEmptyConvergenceCriterion.AGGREGATOR_NAME, new LongSumAggregator());&lt;br/&gt;
     		syncConfig.addIterationAggregator(WorksetEmptyConvergenceCriterion.AGGREGATOR_NAME, new LongSumAggregator());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;syncConfig.setConvergenceCriterion(WorksetEmptyConvergenceCriterion.AGGREGATOR_NAME, new WorksetEmptyConvergenceCriterion());&lt;br/&gt;
    +		syncConfig.setDefaultConvergenceCriterion(WorksetEmptyConvergenceCriterion.AGGREGATOR_NAME, new WorksetEmptyConvergenceCriterion());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Is it safe to use a fixed name for the aggregator? Could we not have multiple iterations in a single job?&lt;/p&gt;</comment>
                            <comment id="15569631" author="githubbot" created="Wed, 12 Oct 2016 19:17:03 +0000"  >&lt;p&gt;Github user greghogan commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2606#discussion_r83075316&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2606#discussion_r83075316&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-tests/src/test/java/org/apache/flink/test/iterative/aggregators/AggregatorConvergenceITCase.java &amp;#8212;&lt;br/&gt;
    @@ -137,42 +138,51 @@ public void testConnectedComponentsWithParametrizableConvergence() &lt;/p&gt;
{
     			fail(e.getMessage());
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testDeltaConnectedComponentsWithParametrizableConvergence() {&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +
    +			// name of the aggregator that checks for convergence
    +			final String UPDATED_ELEMENTS = &quot;updated.elements.aggr&quot;;
    +
    +			// the iteration stops if less than this number of elements change value
    +			final long convergence_threshold = 3;
    +
    +			final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();
    +
    +			DataSet&amp;lt;Tuple2&amp;lt;Long, Long&amp;gt;&amp;gt; initialSolutionSet = env.fromCollection(verticesInput);
    +			DataSet&amp;lt;Tuple2&amp;lt;Long, Long&amp;gt;&amp;gt; edges = env.fromCollection(edgesInput);
    +
    +			DeltaIteration&amp;lt;Tuple2&amp;lt;Long, Long&amp;gt;, Tuple2&amp;lt;Long, Long&amp;gt;&amp;gt; iteration =
    +					initialSolutionSet.iterateDelta(initialSolutionSet, 10, 0);
    +
    +			// register the convergence criterion
    +			iteration.registerAggregationConvergenceCriterion(UPDATED_ELEMENTS,
    +					new LongSumAggregator(), new UpdatedElementsConvergenceCriterion(convergence_threshold));
    +
    +			DataSet&amp;lt;Tuple2&amp;lt;Long, Long&amp;gt;&amp;gt; verticesWithNewComponents = iteration.getWorkset().join(edges).where(0).equalTo(0)
    +					.with(new NeighborWithComponentIDJoin())
    +					.groupBy(0).min(1);
    +
    +			DataSet&amp;lt;Tuple2&amp;lt;Long, Long&amp;gt;&amp;gt; updatedComponentId =
    +					verticesWithNewComponents.join(iteration.getSolutionSet()).where(0).equalTo(0)
    +							.flatMap(new MinimumIdFilter(UPDATED_ELEMENTS));
    +
    +			List&amp;lt;Tuple2&amp;lt;Long, Long&amp;gt;&amp;gt; result = iteration.closeWith(updatedComponentId, updatedComponentId).collect();
    +			Collections.sort(result, new JavaProgramTestBase.TupleComparator&amp;lt;Tuple2&amp;lt;Long, Long&amp;gt;&amp;gt;());
    +
    +			assertEquals(expectedResult, result);
    +		}
&lt;p&gt;    +		catch (Exception e) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Catching and re-throwing exceptions looks to be unnecessary.&lt;/p&gt;</comment>
                            <comment id="15569632" author="githubbot" created="Wed, 12 Oct 2016 19:17:04 +0000"  >&lt;p&gt;Github user greghogan commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2606#discussion_r83071641&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2606#discussion_r83071641&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/iterative/task/IterationSynchronizationSinkTask.java &amp;#8212;&lt;br/&gt;
    @@ -56,11 +56,15 @@&lt;br/&gt;
     	private SyncEventHandler eventHandler;&lt;/p&gt;

&lt;p&gt;     	private ConvergenceCriterion&amp;lt;Value&amp;gt; convergenceCriterion;&lt;br/&gt;
    +&lt;br/&gt;
    +	private ConvergenceCriterion&amp;lt;Value&amp;gt; defaultConvergenceCriterion;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Perhaps &quot;implicit&quot; instead of &quot;default&quot;? I feel like a default can be overridden, but the use here is for a system configured convergence implicit in how a delta iteration operates.&lt;/p&gt;</comment>
                            <comment id="15582114" author="githubbot" created="Mon, 17 Oct 2016 12:33:23 +0000"  >&lt;p&gt;Github user vasia commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2606#discussion_r83632808&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2606#discussion_r83632808&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-optimizer/src/main/java/org/apache/flink/optimizer/plantranslate/JobGraphGenerator.java &amp;#8212;&lt;br/&gt;
    @@ -1513,14 +1513,21 @@ private void finalizeWorksetIteration(IterationDescriptor descr) {&lt;/p&gt;

&lt;p&gt;     		String convAggName = aggs.getConvergenceCriterionAggregatorName();&lt;br/&gt;
     		ConvergenceCriterion&amp;lt;?&amp;gt; convCriterion = aggs.getConvergenceCriterion();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;    +&lt;br/&gt;
     		if (convCriterion != null || convAggName != null) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;throw new CompilerException(&quot;Error: Cannot use custom convergence criterion with workset iteration. Workset iterations have implicit convergence criterion where workset is empty.&quot;);&lt;br/&gt;
    +			if (convCriterion == null) 
{
    +				throw new CompilerException(&quot;Error: Convergence criterion aggregator set, but criterion is null.&quot;);
    +			}
&lt;p&gt;    +			if (convAggName == null) &lt;/p&gt;
{
    +				throw new CompilerException(&quot;Error: Aggregator convergence criterion set, but aggregator is null.&quot;);
    +			}
&lt;p&gt;    +&lt;br/&gt;
    +			syncConfig.setConvergenceCriterion(convAggName, convCriterion);&lt;br/&gt;
     		}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		headConfig.addIterationAggregator(WorksetEmptyConvergenceCriterion.AGGREGATOR_NAME, new LongSumAggregator());&lt;br/&gt;
     		syncConfig.addIterationAggregator(WorksetEmptyConvergenceCriterion.AGGREGATOR_NAME, new LongSumAggregator());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;syncConfig.setConvergenceCriterion(WorksetEmptyConvergenceCriterion.AGGREGATOR_NAME, new WorksetEmptyConvergenceCriterion());&lt;br/&gt;
    +		syncConfig.setDefaultConvergenceCriterion(WorksetEmptyConvergenceCriterion.AGGREGATOR_NAME, new WorksetEmptyConvergenceCriterion());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Sure that&apos;s possible, but each iteration will have its own TaskConfig.&lt;/p&gt;</comment>
                            <comment id="15582247" author="githubbot" created="Mon, 17 Oct 2016 13:21:53 +0000"  >&lt;p&gt;Github user vasia commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2606&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2606&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you for the review @greghogan! I have addressed your comments.&lt;/p&gt;</comment>
                            <comment id="15589838" author="githubbot" created="Wed, 19 Oct 2016 20:57:54 +0000"  >&lt;p&gt;Github user greghogan commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2606&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2606&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 to merge&lt;/p&gt;</comment>
                            <comment id="15594748" author="githubbot" created="Fri, 21 Oct 2016 10:35:19 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2606&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2606&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12719967">FLINK-787</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2xdk7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>