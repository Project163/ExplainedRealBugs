<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:39:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-12863] Race condition between slot offerings and AllocatedSlotReport</title>
                <link>https://issues.apache.org/jira/browse/FLINK-12863</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;With &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11059&quot; title=&quot;JobMaster may continue using an invalid slot if releasing idle slot meet a timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11059&quot;&gt;&lt;del&gt;FLINK-11059&lt;/del&gt;&lt;/a&gt; we introduced the &lt;tt&gt;AllocatedSlotReport&lt;/tt&gt; which is used by the &lt;tt&gt;TaskExecutor&lt;/tt&gt; to synchronize its internal view on slot allocations with the view of the &lt;tt&gt;JobMaster&lt;/tt&gt;. It seems that there is a race condition between offering slots and receiving the report because the &lt;tt&gt;AllocatedSlotReport&lt;/tt&gt; is sent by the &lt;tt&gt;HeartbeatManagerSenderImpl&lt;/tt&gt; from a separate thread. &lt;/p&gt;

&lt;p&gt;Due to that it can happen that we generate an &lt;tt&gt;AllocatedSlotReport&lt;/tt&gt; just before getting new slots offered. Since the report is sent from a different thread, it can then happen that the response to the slot offerings is sent earlier than the &lt;tt&gt;AllocatedSlotReport&lt;/tt&gt;. Consequently, we might receive an outdated slot report on the &lt;tt&gt;TaskExecutor&lt;/tt&gt; causing active slots to be released.&lt;/p&gt;

&lt;p&gt;In order to solve the problem I propose to add a fencing token to the &lt;tt&gt;AllocatedSlotReport&lt;/tt&gt; which is being updated whenever we offer new slots to the &lt;tt&gt;JobMaster&lt;/tt&gt;. When we receive the &lt;tt&gt;AllocatedSlotReport&lt;/tt&gt; on the &lt;tt&gt;TaskExecutor&lt;/tt&gt; we compare the current slot report fencing token with the received one and only process the report if they are equal. Otherwise we wait for the next heartbeat to send us an up to date &lt;tt&gt;AllocatedSlotReport&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13239796">FLINK-12863</key>
            <summary>Race condition between slot offerings and AllocatedSlotReport</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 16 Jun 2019 13:59:13 +0000</created>
                <updated>Fri, 27 Mar 2020 13:51:02 +0000</updated>
                            <resolved>Fri, 21 Jun 2019 07:31:20 +0000</resolved>
                                    <version>1.9.0</version>
                                    <fixVersion>1.7.3</fixVersion>
                    <fixVersion>1.8.1</fixVersion>
                    <fixVersion>1.9.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16865016" author="till.rohrmann" created="Sun, 16 Jun 2019 14:04:49 +0000"  >&lt;p&gt;This race condition causes the &lt;tt&gt;YARNSessionCapacitySchedulerITCase.perJobYarnClusterWithParallelism&lt;/tt&gt; to fail. An instance of this test failure can be found here &lt;a href=&quot;https://api.travis-ci.org/v3/job/546108501/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/546108501/log.txt&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16865239" author="xiaogang.shi" created="Mon, 17 Jun 2019 02:24:11 +0000"  >&lt;p&gt;I think a similar problem happens in the heartbeats between RM and TM. &lt;/p&gt;

&lt;p&gt;When a RM receives a slot request from JM, it will find an available slot, mark it as pending, and send a slot request to TM. In the cases where the slot request is following a heartbeat request, RM will receive the heartbeat response first and will remove the pending slot. RM may reuse the slot when it receives a new slot request from JM, leading to duplicated slot allocation. &lt;/p&gt;

&lt;p&gt;A solution proposed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yungao.gy&quot; class=&quot;user-hover&quot; rel=&quot;yungao.gy&quot;&gt;yungao.gy&lt;/a&gt; is using version numbers. Each slot is equipped with a version number, which is increased once a new pending request is generated. These version numbers then are attached to the heartbeats sent to TM. Once a heartbeat response is received, we don&apos;t need to remove those pending slot requests whose version numbers are greater than those of heartbeats.&lt;/p&gt;

&lt;p&gt;I think the solution can also work here. What do you think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yungao.gy&quot; class=&quot;user-hover&quot; rel=&quot;yungao.gy&quot;&gt;yungao.gy&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16865269" author="xiaogang.shi" created="Mon, 17 Jun 2019 02:55:32 +0000"  >&lt;p&gt;Btw, i want to note that the race condition may not necessarily be caused by &lt;tt&gt;HeartbeatManagerSenderImpl&lt;/tt&gt; sending heartbeats in a seperate thread. It can solve the problem in JM, but not the one in RM.&lt;/p&gt;

&lt;p&gt;Even when RM send heartbeat requests in the main thread, right after a slot request, the heartbeart responses may be handled first by RM. It&apos;s because RM uses ask to send both heartbeat and slot requests. Temporary &lt;tt&gt;PromiseActor}}s will be created to receive responses from TM. Since there is no guarantee on the execution order of actors, the {{PromiseActor&lt;/tt&gt; which receives response first may be executed later.&lt;/p&gt;
</comment>
                            <comment id="16865278" author="tiemsn" created="Mon, 17 Jun 2019 03:23:17 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;, as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xiaogang.shi&quot; class=&quot;user-hover&quot; rel=&quot;xiaogang.shi&quot;&gt;xiaogang.shi&lt;/a&gt; said, we found the same race condition between RM and TM, and&#160;adding a version in each slot to solve it. I think adding&#160;fencing token to&#160;AllocatedSlotReport&#160;may be have some defects.&#160;Considering how would you update the fencing token? When offering slots succeeds or before offering slots? If when offering slots succeeds, it may happen that JM use the new fencing token while TM&#160;considering the offering slots fail, so TM may not update the token, and JM have no change to use the old token any more. If TM updates the token before offering slots, it may happen that JM doesn&apos;t receive the offering, so JM doesn&apos;t update the token. I think using a version may be more suitable, as we can compare two version, the bigger version will be correct always.&lt;/p&gt;</comment>
                            <comment id="16865333" author="gaoyunhaii" created="Mon, 17 Jun 2019 05:47:59 +0000"  >&lt;p&gt;Hi all, I create a Jira for the state inconsistency between RM and TM:&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;FLINK-12865 |&#160;https://issues.apache.org/jira/browse/FLINK-12865&amp;#93;&lt;/span&gt;. I agree with that this two problems shares similarity. For the inconsistency between RM and TM, previously we solve it with the version method, but currently I has not found the cases&#160;when&#160;FenceToken is not available. I think more thoughts would be required to compare the two methods.&lt;/p&gt;</comment>
                            <comment id="16865665" author="till.rohrmann" created="Mon, 17 Jun 2019 14:43:09 +0000"  >&lt;p&gt;Thanks for mentioning the heartbeat issue between TM and RM &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xiaogang.shi&quot; class=&quot;user-hover&quot; rel=&quot;xiaogang.shi&quot;&gt;xiaogang.shi&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt;. I would suggest to continue the discussion for this problem on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12865&quot; title=&quot;State inconsistency between RM and TM on the slot status&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12865&quot;&gt;&lt;del&gt;FLINK-12865&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tiemsn&quot; class=&quot;user-hover&quot; rel=&quot;tiemsn&quot;&gt;tiemsn&lt;/a&gt; I agree with you that keeping the fencing token up to date can be a bit of a hassle. One would need to include the fencing token in the heartbeat response from the TM to the JM.&lt;/p&gt;

&lt;p&gt;The problem with an increasing version is what do you do in case of an overflow?&lt;/p&gt;

&lt;p&gt;Instead of going this way, I&apos;m actually now in favor of removing the concurrency from the &lt;tt&gt;HeartbeatManager&lt;/tt&gt;. This would execute all heartbeat calls in the actor&apos;s main thread. If the heartbeat response would be generated synchronously, the race condition should be solved. I actually believe that this should also solve &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12865&quot; title=&quot;State inconsistency between RM and TM on the slot status&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12865&quot;&gt;&lt;del&gt;FLINK-12865&lt;/del&gt;&lt;/a&gt; without having to introduce the versions.&lt;/p&gt;</comment>
                            <comment id="16866341" author="sunjincheng121" created="Tue, 18 Jun 2019 08:22:31 +0000"  >&lt;p&gt;Hi guys, Is there a consensus on the solution for &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12863&quot; title=&quot;Race condition between slot offerings and AllocatedSlotReport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12863&quot;&gt;&lt;del&gt;FLINK-12863&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12865&quot; title=&quot;State inconsistency between RM and TM on the slot status&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12865&quot;&gt;&lt;del&gt;FLINK-12865&lt;/del&gt;&lt;/a&gt;? and when do you plan to resolve it? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16866363" author="till.rohrmann" created="Tue, 18 Jun 2019 08:59:59 +0000"  >&lt;p&gt;I&apos;m currently working on a fix. I hope that I can open a PR today or tomorrow which removes concurrency from the &lt;tt&gt;HeartbeatManagerImpls&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16866441" author="sunjincheng121" created="Tue, 18 Jun 2019 10:06:41 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; and Sounds pretty good! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16869262" author="till.rohrmann" created="Fri, 21 Jun 2019 07:31:20 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.9.0: a95dac57ef0e1949fd4751ca19350da96c3bf52f&lt;br/&gt;
1.8.1: 55c8a69cfa4d40ef2863987eb89adb08f0c45dda&lt;br/&gt;
1.7.3: 7333b619fdf3443e179b3f6e8d3147ab4946f91c&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13171612">FLINK-9827</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13161318">FLINK-9417</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13202162">FLINK-11059</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13240355">FLINK-12895</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13239849">FLINK-12865</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 21 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03smo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>