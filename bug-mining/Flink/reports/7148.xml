<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:17:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-32592] (Stream)ExEnv#initializeContextEnvironment isn&apos;t thread-safe</title>
                <link>https://issues.apache.org/jira/browse/FLINK-32592</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Context&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;We are using the flink-k8s-operator to deploy multiple jobs (up to 32) to a single session cluster. The job submissions done by the operator happen concurrently, basically at the same time.&lt;/p&gt;

&lt;p&gt;Operator version: 1.5.0&lt;/p&gt;

&lt;p&gt;Flink version:&#160; 1.15.4, 1.7.1, 1.18 (master@f37d41cf)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Problem&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Rarely (~once every 50 deployments) one of the jobs will not be executed. In the following incident 4 jobs are deployed at the same time:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;gorner-task-staging-e5730831&lt;/li&gt;
	&lt;li&gt;gorner-facility-staging-e5730831&lt;/li&gt;
	&lt;li&gt;gorner-aepp-staging-e5730831&lt;/li&gt;
	&lt;li&gt;gorner-session-staging-e5730831&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;br/&gt;
The operator submits the job, they all get a reasonable jobID:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-07-14 10:25:35,295 o.a.f.k.o.s.AbstractFlinkService [INFO ][aelps-staging/gorner-task-staging-e5730831] Submitting job: 4968b186061e44390000000000000002 to session cluster.
2023-07-14 10:25:35,297 o.a.f.k.o.s.AbstractFlinkService [INFO ][aelps-staging/gorner-facility-staging-e5730831] Submitting job: 91a5260d916c4dff0000000000000002 to session cluster.
2023-07-14 10:25:35,301 o.a.f.k.o.s.AbstractFlinkService [INFO ][aelps-staging/gorner-aepp-staging-e5730831] Submitting job: 103c0446e14749a10000000000000002 to session cluster.
2023-07-14 10:25:35,302 o.a.f.k.o.s.AbstractFlinkService [INFO ][aelps-staging/gorner-session-staging-e5730831] Submitting job: de59304d370b4b8e0000000000000002 to session cluster.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the cluster the JarRunHandler&apos;s handleRequest() method will get the request, all 4 jobIDs are present (also all args, etc are correct):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-07-14 10:25:35,320 WARN  org.apache.flink.runtime.webmonitor.handlers.JarRunHandler   [] - handleRequest - requestBody.jobId: 4968b186061e44390000000000000002
2023-07-14 10:25:35,321 WARN  org.apache.flink.runtime.webmonitor.handlers.JarRunHandler   [] - handleRequest - requestBody.jobId: de59304d370b4b8e0000000000000002
2023-07-14 10:25:35,321 WARN  org.apache.flink.runtime.webmonitor.handlers.JarRunHandler   [] - handleRequest - requestBody.jobId: 91a5260d916c4dff0000000000000002
2023-07-14 10:25:35,321 WARN  org.apache.flink.runtime.webmonitor.handlers.JarRunHandler   [] - handleRequest - requestBody.jobId: 103c0446e14749a10000000000000002
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But once the EmbeddedExecutor&apos;s submitAndGetJobClientFuture() method is called instead of getting 1 call per jobID we have 4 calls but one of the jobIDs twice:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-07-14 10:25:35,616 WARN  org.apache.flink.client.deployment.application.executors.EmbeddedExecutor [] - execute - optJobId: Optional[4968b186061e44390000000000000002]
2023-07-14 10:25:35,616 WARN  org.apache.flink.client.deployment.application.executors.EmbeddedExecutor [] - execute - optJobId: Optional[103c0446e14749a10000000000000002]
2023-07-14 10:25:35,616 WARN  org.apache.flink.client.deployment.application.executors.EmbeddedExecutor [] - execute - optJobId: Optional[de59304d370b4b8e0000000000000002]
2023-07-14 10:25:35,721 WARN  org.apache.flink.client.deployment.application.executors.EmbeddedExecutor [] - execute - optJobId: Optional[de59304d370b4b8e0000000000000002]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If this is important: the jobGraph obtained does not match the jobID. We get 2 times de59304d370b4b8e0000000000000002 but the jobgraph for this jobID is never returned by getJobGraph() in EmbeddedExecutor.submitAndGetJobClientFuture().&lt;/p&gt;

&lt;p&gt;This will then lead to the job already existing:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-07-14 10:25:35,616 WARN  org.apache.flink.client.deployment.application.executors.EmbeddedExecutor [] - execute - submittedJobIds: []
2023-07-14 10:25:35,616 WARN  org.apache.flink.client.deployment.application.executors.EmbeddedExecutor [] - execute - submittedJobIds: []
2023-07-14 10:25:35,616 WARN  org.apache.flink.client.deployment.application.executors.EmbeddedExecutor [] - execute - submittedJobIds: []
2023-07-14 10:25:35,721 WARN  org.apache.flink.client.deployment.application.executors.EmbeddedExecutor [] - execute - submittedJobIds: [de59304d370b4b8e0000000000000002]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But since the jobs are completely different the execution will fail. Depending on the timing with one of the following exceptions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;RestHandlerException: No jobs included in application&lt;/li&gt;
	&lt;li&gt;ClassNotFoundException: io.dectris.aelps.pipelines.gorner.facility.FacilityEventProcessor&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13543555">FLINK-32592</key>
            <summary>(Stream)ExEnv#initializeContextEnvironment isn&apos;t thread-safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="fabiowanner">Fabio Wanner</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 14 Jul 2023 12:26:31 +0000</created>
                <updated>Fri, 21 Jul 2023 16:49:30 +0000</updated>
                            <resolved>Fri, 21 Jul 2023 16:05:39 +0000</resolved>
                                    <version>1.15.4</version>
                    <version>1.18.0</version>
                    <version>1.17.1</version>
                                    <fixVersion>1.18.0</fixVersion>
                    <fixVersion>1.16.3</fixVersion>
                    <fixVersion>1.17.2</fixVersion>
                                    <component>Client / Job Submission</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17743136" author="JIRAUSER298842" created="Fri, 14 Jul 2023 12:31:35 +0000"  >&lt;p&gt;I would be happy to assist in fixing this issue, but could really use some pointers to find the root cause of the problem...&lt;/p&gt;</comment>
                            <comment id="17743214" author="zentol" created="Fri, 14 Jul 2023 16:15:18 +0000"  >&lt;p&gt;Sounds like a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-30596&quot; title=&quot;Multiple POST /jars/:jarid/run requests with the same jobId, runs duplicate jobs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-30596&quot;&gt;&lt;del&gt;FLINK-30596&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17743216" author="zentol" created="Fri, 14 Jul 2023 16:16:58 +0000"  >&lt;p&gt;Are you sure you tested this with the latest mater?&lt;/p&gt;</comment>
                            <comment id="17743218" author="zentol" created="Fri, 14 Jul 2023 16:21:06 +0000"  >&lt;p&gt;ahhh could be the usual ExecutionEnvironment concurrency thing.&lt;/p&gt;

&lt;p&gt;Try to not submits jobs to jar/:jarid/run in parallel but sequentially.&lt;/p&gt;</comment>
                            <comment id="17743495" author="JIRAUSER298842" created="Sun, 16 Jul 2023 06:03:25 +0000"  >&lt;p&gt;Hey! Sorry for my late response and thanks a lot for looking into the issue! As the job submission is done by the official flink k8s operator we do not have direct control over how the jobs are run.&lt;/p&gt;

&lt;p&gt;I am currently on vacation, but I will be able to verify your fix on Wednesday!&lt;/p&gt;</comment>
                            <comment id="17744529" author="zentol" created="Wed, 19 Jul 2023 10:28:28 +0000"  >&lt;p&gt;master: 13d35365f677813d5f0090f121e14e8bdec646d1&lt;br/&gt;
1.17: 32c657c14266531d3c7b1f448d96f513661a59d6&lt;br/&gt;
1.16: 903f122c5acf64e16daf073ec64a0d0a23ade4f1&lt;/p&gt;</comment>
                            <comment id="17745655" author="zentol" created="Fri, 21 Jul 2023 16:05:39 +0000"  >&lt;p&gt;Please re-open if the issue still occurs.&lt;/p&gt;</comment>
                            <comment id="17745668" author="JIRAUSER298842" created="Fri, 21 Jul 2023 16:49:30 +0000"  >&lt;p&gt;We did a few hundred deployments and did not run into the issue anymore! Looks resolved! Thanks a lot!&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13542697">FLINK-32552</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1j5d4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>