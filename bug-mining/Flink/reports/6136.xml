<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:08:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-25683] wrong result if table transfrom to DataStream then window process in batch mode</title>
                <link>https://issues.apache.org/jira/browse/FLINK-25683</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I have 5 line datas,&lt;br/&gt;
i first need to transform current data with SQL&lt;br/&gt;
then mix current data and historical data which is batch get from hbase&lt;br/&gt;
for some special reason the program must run in batch mode&lt;br/&gt;
i think the correct result should be like this&#65306;&lt;br/&gt;
(BOB,1)&lt;br/&gt;
(EMA,1)&lt;br/&gt;
(DOUG,1)&lt;br/&gt;
(ALICE,1)&lt;br/&gt;
(CENDI,1)&lt;br/&gt;
but the result is :&lt;br/&gt;
(EMA,1)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;if i set different parallelism ,the result is different.&lt;/p&gt;</description>
                <environment>&lt;p&gt;mac book pro m1&#160;&lt;/p&gt;

&lt;p&gt;jdk 8&#160;&lt;/p&gt;

&lt;p&gt;scala 2.11&lt;/p&gt;

&lt;p&gt;flink 1.14.2&lt;/p&gt;

&lt;p&gt;idea 2020&lt;/p&gt;</environment>
        <key id="13423166">FLINK-25683</key>
            <summary>wrong result if table transfrom to DataStream then window process in batch mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paul8263">Yao Zhang</assignee>
                                    <reporter username="zhangzihan">zhangzh</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 18 Jan 2022 04:28:56 +0000</created>
                <updated>Mon, 24 Jan 2022 16:03:24 +0000</updated>
                            <resolved>Mon, 24 Jan 2022 08:38:21 +0000</resolved>
                                    <version>1.14.2</version>
                                    <fixVersion>1.13.6</fixVersion>
                    <fixVersion>1.14.4</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Table SQL / API</component>
                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17477584" author="JIRAUSER282729" created="Tue, 18 Jan 2022 05:34:53 +0000"  >&lt;p&gt;hi @&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paul8263&quot; class=&quot;user-hover&quot; rel=&quot;paul8263&quot;&gt;paul8263&lt;/a&gt;&#160; &#65306;&lt;br/&gt;
I found a new problem similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25471&quot; title=&quot;wrong result if table transfrom to DataStream then keyby  sum in Batch Mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25471&quot;&gt;FLINK-25471&lt;/a&gt;&#12290;&lt;/p&gt;

&lt;p&gt;&#160;can you help me&#65311;&lt;/p&gt;</comment>
                            <comment id="17478297" author="paul8263" created="Wed, 19 Jan 2022 01:12:00 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhangzihan&quot; class=&quot;user-hover&quot; rel=&quot;zhangzihan&quot;&gt;zhangzihan&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;Thank you very much for reporting this issue. I have successfully reproduced it.&#160;&lt;/p&gt;</comment>
                            <comment id="17478355" author="paul8263" created="Wed, 19 Jan 2022 06:45:56 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;This issue and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25471&quot; title=&quot;wrong result if table transfrom to DataStream then keyby  sum in Batch Mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25471&quot;&gt;FLINK-25471&lt;/a&gt; is quite similar.&#160; The root cause is BatchExecutionKeyedStateBackend calls&#160;&lt;/p&gt;

&lt;p&gt;notifyKeySelected only if it receives the data with different key. As a result, last elements(right before Task Manager exits) stored in BatchExecutionKeyedStateBackend the will never have a chance to be collected by the downstream. I think it is the root cause.&lt;/p&gt;

&lt;p&gt;I plan to change AbstractStreamOperator by extending BoundedMultiInput and set the key to a designed value when the input reaches END_OF_DATA. By doing this, in batch mode it will trigger notifyKeySelected and finally all elements will be collected. It might not have any side effect in streaming mode. Both &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25471&quot; title=&quot;wrong result if table transfrom to DataStream then keyby  sum in Batch Mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25471&quot;&gt;FLINK-25471&lt;/a&gt; and this ticket can be solved by this change. Correct me if I am wrong.&lt;/p&gt;

&lt;p&gt;Could you please assign this ticket to me?&lt;/p&gt;</comment>
                            <comment id="17478384" author="martijnvisser" created="Wed, 19 Jan 2022 08:05:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paul8263&quot; class=&quot;user-hover&quot; rel=&quot;paul8263&quot;&gt;paul8263&lt;/a&gt; I&apos;ve assigned it to you.&#160;&lt;/p&gt;</comment>
                            <comment id="17478400" author="twalthr" created="Wed, 19 Jan 2022 08:18:40 +0000"  >&lt;p&gt;Thanks for investigating &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paul8263&quot; class=&quot;user-hover&quot; rel=&quot;paul8263&quot;&gt;paul8263&lt;/a&gt;. I will loop in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; who knows this part of the code better.&lt;/p&gt;</comment>
                            <comment id="17478619" author="dawidwys" created="Wed, 19 Jan 2022 12:00:05 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paul8263&quot; class=&quot;user-hover&quot; rel=&quot;paul8263&quot;&gt;paul8263&lt;/a&gt;. This is a very good investigation. Moreover I think your suggested solution goes in the right direction. However, I&apos;d put that logic inside of &lt;tt&gt;AbstractStreamOperator#finish&lt;/tt&gt; (or &lt;tt&gt;AbstractStreamOperator#close&lt;/tt&gt; in older versions). Would you like to create a PR for it?&lt;/p&gt;</comment>
                            <comment id="17479152" author="dawidwys" created="Thu, 20 Jan 2022 07:48:07 +0000"  >&lt;p&gt;Sorry, I have not spotted that before. Actually, I am not sure anymore, the described situation is the root problem. In pure &lt;tt&gt;DataStream&lt;/tt&gt; program, the trailing keys are supposed to be flushed by the &lt;tt&gt;MAX_WATERMARK&lt;/tt&gt; emitted from sources. However, as I looked into the code in the &lt;tt&gt;InputConversionOperator&lt;/tt&gt; we swallow all watermarks for the given program. See &lt;tt&gt;InputConversionOperator#processWatermark&lt;/tt&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; As I am not 100% familiar with that logic. Would it be possible to forward at least the &lt;tt&gt;MAX_WATERMARK&lt;/tt&gt; there?&lt;/p&gt;</comment>
                            <comment id="17479199" author="twalthr" created="Thu, 20 Jan 2022 08:59:13 +0000"  >&lt;p&gt;Yes, this might be indeed a bug. A max watermark should always be forwarded. However, I hope you agree with me that it doesn&apos;t make sense to forward other watermarks if there is no time attribute in SQL for it. I wanted to be conservative here and let the user decide whether it makes sense to rely on DataStream API or not. We should not let watermarks flow throw the SQL engine without a clear purpose, at least this was the original thought behind it.&lt;/p&gt;</comment>
                            <comment id="17479223" author="paul8263" created="Thu, 20 Jan 2022 09:50:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;Thank you very much for your reply. I retested this issue and finally got that the problem only exists if the DataStream is converted from table API. If we use pure Stream API everything works smoothly. It is not a good practice to change AbstractStreamOperator. The problem indeed lies in InputConversionOperator.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void processWatermark(Watermark mark) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (propagateWatermark) {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.processWatermark(mark);
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I debugged and it turned out that the value of propagateWatermark was false. No watermarks will be forwarded to the downstream.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17479234" author="dawidwys" created="Thu, 20 Jan 2022 10:08:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; I can&apos;t think of any other case, where watermarks would be necessary if there is no corresponding time attribute.&lt;/p&gt;

&lt;p&gt;Ok, now that we&apos;re on the same page &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paul8263&quot; class=&quot;user-hover&quot; rel=&quot;paul8263&quot;&gt;paul8263&lt;/a&gt; do you still want to create a PR for it? In the PR, we could propagate if it is the &lt;tt&gt;MAX_WATERMARK&lt;/tt&gt;. Therefore the method could become:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void processWatermark(Watermark mark) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (propagateWatermark || || mark.equals(Watermark.MAX_WATERMARK)) {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.processWatermark(mark);
    }
} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17479252" author="paul8263" created="Thu, 20 Jan 2022 10:46:15 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;I still can&apos;t figure out what actually controls the boolean value propagateWatermark in InputConversionOperator. Does the watermark clause in SQL create statement controls it?&lt;/p&gt;

&lt;p&gt;Currently I will follow you instruction and updated the PR, together with the tests. Thank you very much.&lt;/p&gt;</comment>
                            <comment id="17479357" author="dawidwys" created="Thu, 20 Jan 2022 13:14:34 +0000"  >&lt;p&gt;I can&apos;t explain you where the flag comes from, as I don&apos;t know this part of code. However as Timo explained:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;that it doesn&apos;t make sense to forward other watermarks if there is no time attribute in SQL for it. I wanted to be conservative here and let the user decide whether it makes sense to rely on DataStream API or not. We should not let watermarks flow throw the SQL engine without a clear purpose, at least this was the original thought behind it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So the idea is that if the table API does not expect watermarks from the datastream API, it cuts off any unexpected watermarks.&lt;/p&gt;</comment>
                            <comment id="17479372" author="twalthr" created="Thu, 20 Jan 2022 13:31:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paul8263&quot; class=&quot;user-hover&quot; rel=&quot;paul8263&quot;&gt;paul8263&lt;/a&gt; The propagate watermark is forwarded from the DDL using &lt;tt&gt;SOURCE_WATERMARK()&lt;/tt&gt;. Maybe we need to have another pass over the docs to make this clearer but the content is actually there:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/data_stream_api/#examples-for-fromdatastream&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/data_stream_api/#examples-for-fromdatastream&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The virtual DataStream table source implements SupportsSourceWatermark and thus allows calling the SOURCE_WATERMARK() built-in function as a watermark strategy to adopt watermarks from the DataStream API.&lt;/p&gt;

&lt;p&gt;// === EXAMPLE 4 ===&lt;/p&gt;

&lt;p&gt;// derive all physical columns automatically&lt;br/&gt;
// but access the stream record&apos;s timestamp for creating a rowtime attribute column&lt;br/&gt;
// also rely on the watermarks generated in the DataStream API&lt;/p&gt;

&lt;p&gt;// we assume that a watermark strategy has been defined for `dataStream` before&lt;br/&gt;
// (not part of this example)&lt;br/&gt;
Table table =&lt;br/&gt;
    tableEnv.fromDataStream(&lt;br/&gt;
        dataStream,&lt;br/&gt;
        Schema.newBuilder()&lt;br/&gt;
            .columnByMetadata(&quot;rowtime&quot;, &quot;TIMESTAMP_LTZ(3)&quot;)&lt;br/&gt;
            .watermark(&quot;rowtime&quot;, &quot;SOURCE_WATERMARK()&quot;)&lt;br/&gt;
            .build());&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 to Dawid&apos;s fix for this issue.&lt;/p&gt;</comment>
                            <comment id="17480910" author="dawidwys" created="Mon, 24 Jan 2022 08:32:33 +0000"  >&lt;p&gt;Fixed in:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master
	&lt;ul&gt;
		&lt;li&gt;9aa879f50c32de862831e82613f1cf1bc4d760f9&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;1.14.4
	&lt;ul&gt;
		&lt;li&gt;2cca3a6609a030b6f03fedbaab51da3dce2962cd&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;1.13.6
	&lt;ul&gt;
		&lt;li&gt;16feba605c87645a658947805be50f6c410fde67&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13419812">FLINK-25471</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13038980" name="TableToDataStreamBatchWindowTest.scala" size="2865" author="zhangzihan" created="Tue, 18 Jan 2022 05:30:04 +0000"/>
                            <attachment id="13038973" name="pom.xml" size="12369" author="zhangzihan" created="Tue, 18 Jan 2022 04:28:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0yo68:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>