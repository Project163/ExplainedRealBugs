<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:16:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-31092] Hive ITCases fail with OutOfMemoryError</title>
                <link>https://issues.apache.org/jira/browse/FLINK-31092</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We&apos;re experiencing an OutOfMemoryError where the heap space reaches the upper limit:&lt;br/&gt;
&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=46161&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=23142&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=46161&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=23142&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Feb 15 05:05:14 [INFO] Running org.apache.flink.table.catalog.hive.HiveCatalogITCase
Feb 15 05:05:17 [INFO] java.lang.OutOfMemoryError: Java heap space
Feb 15 05:05:17 [INFO] Dumping heap to java_pid9669.hprof ...
Feb 15 05:05:28 [INFO] Heap dump file created [1957090051 bytes in 11.718 secs]
java.lang.OutOfMemoryError: Java heap space
	at org.apache.maven.surefire.booter.ForkedBooter.cancelPingScheduler(ForkedBooter.java:209)
	at org.apache.maven.surefire.booter.ForkedBooter.acknowledgedExit(ForkedBooter.java:419)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:186)
	at org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:562)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:548)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13524864">FLINK-31092</key>
            <summary>Hive ITCases fail with OutOfMemoryError</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fsk119">Shengkai Fang</assignee>
                                    <reporter username="mapohl">Matthias Pohl</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Wed, 15 Feb 2023 14:55:55 +0000</created>
                <updated>Mon, 6 Mar 2023 11:04:44 +0000</updated>
                            <resolved>Mon, 6 Mar 2023 11:04:44 +0000</resolved>
                                    <version>1.17.0</version>
                    <version>1.16.1</version>
                    <version>1.18.0</version>
                                    <fixVersion>1.17.0</fixVersion>
                    <fixVersion>1.16.2</fixVersion>
                    <fixVersion>1.18.0</fixVersion>
                                    <component>Connectors / Hive</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17689182" author="mapohl" created="Wed, 15 Feb 2023 14:58:41 +0000"  >&lt;p&gt;I&apos;m linking &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-30556&quot; title=&quot;Improve the logic for enumerating splits for Hive source to avoid potential OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-30556&quot;&gt;FLINK-30556&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20945&quot; title=&quot;flink hive insert heap out of memory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20945&quot;&gt;FLINK-20945&lt;/a&gt; here because they also deal with OOM in the Hive connector. That&apos;s the reason why I&apos;m keeping this one at &lt;tt&gt;Critical&lt;/tt&gt; instead of &lt;tt&gt;Blocker&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17689186" author="mapohl" created="Wed, 15 Feb 2023 15:03:49 +0000"  >&lt;p&gt;There&apos;s a heap dump created that reveals that the majority of the data (44.2%=~850MB) comes from &lt;tt&gt;char[]&lt;/tt&gt; instances (e.g. SQL queries). There are also various &lt;tt&gt;ServiceLoaderUtil.LoadResult&lt;/tt&gt; instances stored in the heap (24%=~460MB)  that reference an &lt;tt&gt;IllegalStateException&lt;/tt&gt;.&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13055473/13055473_VisualVM-FLINK-31092.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17689188" author="mapohl" created="Wed, 15 Feb 2023 15:04:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Wencong+Liu&quot; class=&quot;user-hover&quot; rel=&quot;Wencong Liu&quot;&gt;Wencong Liu&lt;/a&gt; may you have a look at it since you worked on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-30556&quot; title=&quot;Improve the logic for enumerating splits for Hive source to avoid potential OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-30556&quot;&gt;FLINK-30556&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17689193" author="JIRAUSER281639" created="Wed, 15 Feb 2023 15:18:47 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;, is the heap dump generated before OOM error occurs?&lt;/p&gt;</comment>
                            <comment id="17689230" author="mapohl" created="Wed, 15 Feb 2023 16:35:26 +0000"  >&lt;p&gt;I&apos;m not sure - based on the logs, it sounds like it was created as soon as the OOM error happened:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Feb 15 05:05:14 [INFO] Running org.apache.flink.table.catalog.hive.HiveCatalogITCase
Feb 15 05:05:17 [INFO] java.lang.OutOfMemoryError: Java heap space
Feb 15 05:05:17 [INFO] Dumping heap to java_pid9669.hprof ...
Feb 15 05:05:28 [INFO] Heap dump file created [1957090051 bytes in 11.718 secs]
java.lang.OutOfMemoryError: Java heap space
[...]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We&apos;re also setting &lt;tt&gt;+HeapDumpOnOutOfMemoryError&lt;/tt&gt; in &lt;a href=&quot;https://github.com/apache/flink/blob/7e37d59f834bca805f5fbee99db87eb909d1814f/tools/ci/test_controller.sh#L67&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tools/ci/test_controller.sh:67&lt;/a&gt;. AFAIU, this makes the JVM generate the heap dump as soon as the OOM occurs.&lt;/p&gt;</comment>
                            <comment id="17691453" author="martijnvisser" created="Tue, 21 Feb 2023 08:15:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luoyuxia&quot; class=&quot;user-hover&quot; rel=&quot;luoyuxia&quot;&gt;luoyuxia&lt;/a&gt; Can you take a look?&lt;/p&gt;</comment>
                            <comment id="17691878" author="luoyuxia" created="Wed, 22 Feb 2023 02:20:17 +0000"  >&lt;p&gt;Sure, I&apos;ll have a look.&#160;&lt;/p&gt;</comment>
                            <comment id="17693779" author="luoyuxia" created="Mon, 27 Feb 2023 04:28:40 +0000"  >&lt;p&gt;Try to analyze the heap dump, I found most of object will be `ServiceLoaderUtil#LoadResult(IllegalStateException)`, and the exception message is `&lt;/p&gt;

&lt;p&gt;Trying to access closed classloader.xxxx`. I think that&apos;s the cause of OOM. From the code:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;T&amp;gt; List&amp;lt;LoadResult&amp;lt;T&amp;gt;&amp;gt; load(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; clazz, &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; classLoader) {
    List&amp;lt;LoadResult&amp;lt;T&amp;gt;&amp;gt; loadResults = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();

    Iterator&amp;lt;T&amp;gt; serviceLoaderIterator = ServiceLoader.load(clazz, classLoader).iterator();

    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            T next = serviceLoaderIterator.next();
            loadResults.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LoadResult&amp;lt;&amp;gt;(next));
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (NoSuchElementException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
            loadResults.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LoadResult&amp;lt;&amp;gt;(t));
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; loadResults;
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Seems it&apos;ll then loop indefinitely when `serviceLoaderIterator.next()` throw exception other than NoSuchElementException. And it&apos;ll add more and more `LoadResult`&#160; utill OOM.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And the stack where OOM happens is as follows:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 at java.lang.OutOfMemoryError.&amp;lt;init&amp;gt;(OutOfMemoryError.java:48)
&#160; &#160; at org.apache.flink.util.FlinkUserCodeClassLoaders$SafetyNetWrapperClassLoader.ensureInner(FlinkUserCodeClassLoaders.java:179)
&#160; &#160; at org.apache.flink.util.FlinkUserCodeClassLoaders$SafetyNetWrapperClassLoader.getResources(FlinkUserCodeClassLoaders.java:213)
&#160; &#160; at java.util.ServiceLoader$LazyIterator.hasNextService(ServiceLoader.java:348)
&#160; &#160; at java.util.ServiceLoader$LazyIterator.nextService(ServiceLoader.java:364)
&#160; &#160; at java.util.ServiceLoader$LazyIterator.next(ServiceLoader.java:404)
&#160; &#160; at java.util.ServiceLoader$1.next(ServiceLoader.java:480)
&#160; &#160; at org.apache.flink.table.factories.ServiceLoaderUtil.load(ServiceLoaderUtil.java:42)
&#160; &#160; at org.apache.flink.table.factories.FactoryUtil.discoverFactories(FactoryUtil.java:805)
&#160; &#160; at org.apache.flink.table.factories.FactoryUtil.discoverFactory(FactoryUtil.java:524)
&#160; &#160; at org.apache.flink.table.factories.PlannerFactoryUtil.createPlanner(PlannerFactoryUtil.java:45)
&#160; &#160; at org.apache.flink.table.gateway.service.operation.OperationExecutor.createStreamTableEnvironment(OperationExecutor.java:375)
&#160; &#160; at org.apache.flink.table.gateway.service.operation.OperationExecutor.getTableEnvironment(OperationExecutor.java:332)
&#160; &#160; at org.apache.flink.table.gateway.service.operation.OperationExecutor.executeStatement(OperationExecutor.java:190)
&#160; &#160; at org.apache.flink.table.gateway.service.SqlGatewayServiceImpl.lambda$executeStatement$1(SqlGatewayServiceImpl.java:212)
&#160; &#160; at org.apache.flink.table.gateway.service.SqlGatewayServiceImpl$$Lambda$1007.apply(&amp;lt;unknown string&amp;gt;)
&#160; &#160; at org.apache.flink.table.gateway.service.operation.OperationManager.lambda$submitOperation$1(OperationManager.java:110)
&#160; &#160; at org.apache.flink.table.gateway.service.operation.OperationManager$$Lambda$1008.call(&amp;lt;unknown string&amp;gt;)
&#160; &#160; at org.apache.flink.table.gateway.service.operation.OperationManager$Operation.lambda$run$0(OperationManager.java:242)
&#160; &#160; at org.apache.flink.table.gateway.service.operation.OperationManager$Operation$$Lambda$1010.run(&amp;lt;unknown string&amp;gt;)
&#160; &#160; at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
&#160; &#160; at java.util.concurrent.FutureTask.run(FutureTask.java:266)
&#160; &#160; at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
&#160; &#160; at java.util.concurrent.FutureTask.run(FutureTask.java:266)
&#160; &#160; at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
&#160; &#160; at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
&#160; &#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fsk119&quot; class=&quot;user-hover&quot; rel=&quot;fsk119&quot;&gt;fsk119&lt;/a&gt; Could you please have a look? Is it possible it&apos;ll access a closed classloader?&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17693945" author="mapohl" created="Mon, 27 Feb 2023 10:21:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=46558&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=22559&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=46558&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=22559&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17693963" author="mapohl" created="Mon, 27 Feb 2023 11:11:19 +0000"  >&lt;p&gt;I&apos;m increasing the priority of this issue to blocker since there was actual work done on the Hive code in 1.17 and so far we&apos;re only seeing the issue in 1.17 (i.e. &lt;tt&gt;master&lt;/tt&gt; or &lt;tt&gt;release-1.17&lt;/tt&gt;)&lt;/p&gt;</comment>
                            <comment id="17694392" author="mapohl" created="Tue, 28 Feb 2023 07:55:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=46609&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=22520&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=46609&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=22520&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17695034" author="fsk119" created="Wed, 1 Mar 2023 12:12:39 +0000"  >&lt;p&gt;Hi, all. I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luoyuxia&quot; class=&quot;user-hover&quot; rel=&quot;luoyuxia&quot;&gt;luoyuxia&lt;/a&gt; is right. `ServiceLoaderUtil#LoadResult(IllegalStateException)` keeps loading the exception when the classloader is closed by the SessionManager. The case is possible to happen when the session is closed but the operation is running. But it&apos;s difficult for Gateway to cancel the task that is submitted to the `ExecutorService` by force if the task doesn&apos;t respect the interrupted flag.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slinkydeveloper&quot; class=&quot;user-hover&quot; rel=&quot;slinkydeveloper&quot;&gt;slinkydeveloper&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; could you share some thoughts about this? Can we limit the type of exception here to prevent endless loading?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;T&amp;gt; List&amp;lt;LoadResult&amp;lt;T&amp;gt;&amp;gt; load(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; clazz, &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; classLoader) {
    List&amp;lt;LoadResult&amp;lt;T&amp;gt;&amp;gt; loadResults = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();

    Iterator&amp;lt;T&amp;gt; serviceLoaderIterator = ServiceLoader.load(clazz, classLoader).iterator();

    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            T next = serviceLoaderIterator.next();
            loadResults.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LoadResult&amp;lt;&amp;gt;(next));
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (NoSuchElementException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
            loadResults.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LoadResult&amp;lt;&amp;gt;(t));
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; loadResults;
} 

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17695160" author="mapohl" created="Wed, 1 Mar 2023 15:34:28 +0000"  >&lt;p&gt;From an outsider&apos;s perspective: What is preventing us from providing cancellation functionality in the Operator interface? It feels like the session should stop any running operation when it is shut down, shouldn&apos;t it? &#129300; As a quickfix it sounds reasonable to replace the &lt;tt&gt;IllegalStateException&lt;/tt&gt; in &lt;a href=&quot;https://github.com/apache/flink/blob/9201f1e3684b130c3d665114f28208f248848b46/flink-core/src/main/java/org/apache/flink/util/FlinkUserCodeClassLoaders.java#L179&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FlinkUserCodeClassLoaders:179&lt;/a&gt; by a &lt;tt&gt;ClosedClassloaderException&lt;/tt&gt; which extends &lt;tt&gt;FlinkRuntimeException&lt;/tt&gt; and make this being caught in the code you already mentioned (&lt;a href=&quot;https://github.com/apache/flink/blob/dd446c9d56be5f33c683611102ec7026cf95e395/flink-table/flink-table-common/src/main/java/org/apache/flink/table/factories/ServiceLoaderUtil.java#L44&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ServiceLoaderUtil:44&lt;/a&gt;). But again, it sounds we&apos;re missing this cancel feature if I understand you correctly.&lt;/p&gt;</comment>
                            <comment id="17695530" author="fsk119" created="Thu, 2 Mar 2023 08:05:26 +0000"  >&lt;p&gt;Yes, Gateway will try to cancel the execution of the running operation by explicitly interrupting the thread in &lt;a href=&quot;https://github.com/apache/flink/blob/9201f1e3684b130c3d665114f28208f248848b46/flink-table/flink-sql-gateway/src/main/java/org/apache/flink/table/gateway/service/operation/OperationManager.java#L377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Operation:377&lt;/a&gt; and wait all task finish. However, the Gateway seems close the resource before all task finishes. This confuses me a lot. BTW, I think we can propose a quick fix like this to prevent endless loading here. WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; ,&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Leonard&quot; class=&quot;user-hover&quot; rel=&quot;leonard&quot;&gt;Leonard&lt;/a&gt; ?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;T&amp;gt; List&amp;lt;LoadResult&amp;lt;T&amp;gt;&amp;gt; load(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; clazz, &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; classLoader) {
        List&amp;lt;LoadResult&amp;lt;T&amp;gt;&amp;gt; loadResults = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();

        Iterator&amp;lt;T&amp;gt; serviceLoaderIterator = ServiceLoader.load(clazz, classLoader).iterator();

        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                T next = serviceLoaderIterator.next();
                loadResults.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LoadResult&amp;lt;&amp;gt;(next));
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (NoSuchElementException e) {
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
                &lt;span class=&quot;code-comment&quot;&gt;// check whether the throwable is as expected
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!clazz.isInstance(t)) {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; t;
                }
                loadResults.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LoadResult&amp;lt;&amp;gt;(t));
            }
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; loadResults;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17695550" author="mapohl" created="Thu, 2 Mar 2023 08:43:18 +0000"  >&lt;p&gt;I guess, your proposal wouldn&apos;t work: It looks like &lt;tt&gt;LoadResult(Throwable)&lt;/tt&gt; is used to mark failed load operations. &lt;tt&gt;clazz&lt;/tt&gt; in contrast is used for actually loading a specifc class. The proposed if condition seems to mix up these two separate code paths.&lt;/p&gt;</comment>
                            <comment id="17695553" author="mapohl" created="Thu, 2 Mar 2023 08:53:42 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Yes, Gateway will try to cancel the execution of the running operation by explicitly interrupting the thread in Operation:377 and wait all task finish. However, the Gateway seems close the resource before all task finishes. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Do we understand why exactly the classloaders are closed before cancelling the operation. IIUC, this should happen the other way around.&lt;/p&gt;</comment>
                            <comment id="17695584" author="fsk119" created="Thu, 2 Mar 2023 09:29:49 +0000"  >&lt;p&gt;After discussing with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lsy&quot; class=&quot;user-hover&quot; rel=&quot;lsy&quot;&gt;lsy&lt;/a&gt; , I think we get why the behavior is not expected on the Gateway side. It&apos;s because of the wrong usage of the `FutureTask` in line &lt;a href=&quot;https://github.com/apache/flink/blob/9201f1e3684b130c3d665114f28208f248848b46/flink-table/flink-sql-gateway/src/main/java/org/apache/flink/table/gateway/service/operation/OperationManager.java#L377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Operation:377&lt;/a&gt;. &lt;tt&gt;FutureTask#cancel&lt;/tt&gt; doesn&apos;t promise the cancel the execution of the running thread by force&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. &lt;tt&gt;FutureTask&lt;/tt&gt; only interrupts the worker thread and then invokes the &lt;tt&gt;FutureTask#done&lt;/tt&gt;. The &lt;tt&gt;FutureTask#done&lt;/tt&gt; notifies the Gateway that all tasks are finished and ready to release used resources in the failed test. I will open a fix about this to truly kill the thread. &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://stackoverflow.com/questions/11158454/future-task-of-executorservice-not-truly-cancelling&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/11158454/future-task-of-executorservice-not-truly-cancelling&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17695609" author="fsk119" created="Thu, 2 Mar 2023 09:44:47 +0000"  >&lt;p&gt;&amp;gt; I guess, your proposal wouldn&apos;t work: It looks like LoadResult(Throwable) is used to mark failed load operations. clazz in contrast is used for actually loading a specifc class. The proposed if condition seems to mix up these two separate code paths.&lt;/p&gt;

&lt;p&gt;I think the&#160;&lt;tt&gt;loadResults&lt;/tt&gt; only should put the Object is an instance of the specified type rather than any objects. It&apos;s a little weird we put something unrelated into the list. What&apos;s more, we check the type explicitly in this &lt;a href=&quot;https://github.com/apache/flink/blob/9201f1e3684b130c3d665114f28208f248848b46/flink-table/flink-table-common/src/main/java/org/apache/flink/table/factories/FactoryUtil.java#L528&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line&lt;/a&gt;.  &lt;/p&gt;</comment>
                            <comment id="17695640" author="mapohl" created="Thu, 2 Mar 2023 10:30:02 +0000"  >&lt;blockquote&gt;
&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; What&apos;s more, we check the type explicitly in this line.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Good pointer: I guess, the error handling could be refactored. Right now it&apos;s separated into two places (&lt;tt&gt;FactoryUtil.discoverFactories&lt;/tt&gt; handles the &lt;tt&gt;NoClassDefFoundError&lt;/tt&gt; and translates any other exception that was handled in &lt;tt&gt;ServiceLoaderUtil.load&lt;/tt&gt; into a &lt;tt&gt;TableException&lt;/tt&gt;) which shouldn&apos;t be the case. We shouldn&apos;t make the service loading loop forever because of an unexpected error but immediately throw a &lt;tt&gt;TableException&lt;/tt&gt; in that case.&lt;/p&gt;</comment>
                            <comment id="17695670" author="fsk119" created="Thu, 2 Mar 2023 11:36:35 +0000"  >&lt;p&gt;+1 to refactor this.&lt;/p&gt;</comment>
                            <comment id="17696063" author="fsk119" created="Fri, 3 Mar 2023 07:41:08 +0000"  >&lt;p&gt;Merged into release-1.17: &lt;br/&gt;
594010624f8084efd99d6d405b5310ab24013aeb&lt;br/&gt;
86e12eb3fcec54d234154e59f8cb0557fc616494&lt;/p&gt;

&lt;p&gt;Merged into master:&lt;br/&gt;
d2296422933c0e3b8895e3b7e0a0a95dacdd3257&lt;br/&gt;
f47b3704867b1d5aa754b1f7325f54e1830014cd&lt;/p&gt;

&lt;p&gt;Merged into release-1.16:&lt;br/&gt;
2dcd6cc6af0109fd1a411320cab400b393d07fe9&lt;br/&gt;
93cd23c55436f3d9c38051e31cfd34f2fd9c4aff&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13516436">FLINK-30556</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13351899">FLINK-20945</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13055926" name="-__w-2-s-flink-connectors-flink-connector-hive-target-surefire-reports-2023-02-15T05-01-18_982-jvmRun4.dump" size="502" author="fsk119" created="Wed, 1 Mar 2023 07:40:43 +0000"/>
                            <attachment id="13055473" name="VisualVM-FLINK-31092.png" size="342557" author="mapohl" created="Wed, 15 Feb 2023 15:03:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 36 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1fyj4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>