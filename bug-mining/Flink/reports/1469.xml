<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5638] Deadlock when closing two chained async I/O operators</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5638</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; can deadlock in a special cases when closing two chained &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; while there is still one element between these two operators in flight.&lt;/p&gt;

&lt;p&gt;The deadlock scenario is the following: Given two chained &lt;tt&gt;AsyncWaitOperators&lt;/tt&gt; &lt;tt&gt;a1&lt;/tt&gt; and &lt;tt&gt;a2&lt;/tt&gt;. &lt;tt&gt;a1&lt;/tt&gt; has its last element completed. This notifies &lt;tt&gt;a1&apos;s&lt;/tt&gt; &lt;tt&gt;Emitter&lt;/tt&gt;, &lt;tt&gt;e1&lt;/tt&gt;, to remove the element from the queue and output it to &lt;tt&gt;a2&lt;/tt&gt;. This poll and output operation happens under the checkpoint lock. Since &lt;tt&gt;a1&lt;/tt&gt; and &lt;tt&gt;a2&lt;/tt&gt; are chained, the &lt;tt&gt;e1&lt;/tt&gt; thread will directly call &lt;tt&gt;a2&apos;s&lt;/tt&gt; &lt;tt&gt;processElement&lt;/tt&gt; function. In this function, we try to add the new element to the &lt;tt&gt;StreamElementQueue&lt;/tt&gt;. Now assume that this queue is full. Then the operation will release the checkpoint lock and wait until it is notified again.&lt;/p&gt;

&lt;p&gt;In the meantime, &lt;tt&gt;a1.close()&lt;/tt&gt; is called by the &lt;tt&gt;StreamTask&lt;/tt&gt;, because we have consumed all input. The close operation also happens under the checkpoint lock. First the close method waits until all elements from the &lt;tt&gt;StreamElementQueue&lt;/tt&gt; have been processed (== empty). This happens by waiting on the checkpoint lock. Next the &lt;tt&gt;e1&lt;/tt&gt; is interrupted and we join on &lt;tt&gt;e1&lt;/tt&gt;. When interrupting &lt;tt&gt;e1&lt;/tt&gt;, it currently waits on the checkpoint lock. Since the closing operation does not release the checkpoint lock, &lt;tt&gt;e1&lt;/tt&gt; cannot regain the synchronization lock and voila we have a deadlock.&lt;/p&gt;

&lt;p&gt;There are two problems which cause the problem:&lt;/p&gt;

&lt;p&gt;1. We assume that the &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; has processed all its elements if the queue is empty. This is usually the case if the output operation is atomic. However in the chained case it can happen that the emitter thread has to wait to insert the element into the queue of the next &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt;. Under these circumstances, we release the checkpoint lock and, thus, the output operation is no longer atomic. We can solve this problem by polling the last queue element after we have outputted it instead of before.&lt;/p&gt;

&lt;p&gt;2. We interrupt the emitter thread while holding the checkpoint lock and not freeing it again. Under these circumstances, the interrupt signal is meaningless because the emitter thread also needs control over the checkpoint lock. We should solve the problem by waiting on the checkpoint lock and periodically checking whether the thread has already stopped or not.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://s3.amazonaws.com/archive.travis-ci.org/jobs/194729330/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://s3.amazonaws.com/archive.travis-ci.org/jobs/194729330/log.txt&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13037649">FLINK-5638</key>
            <summary>Deadlock when closing two chained async I/O operators</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Jan 2017 11:03:01 +0000</created>
                <updated>Tue, 28 Feb 2017 15:36:36 +0000</updated>
                            <resolved>Wed, 25 Jan 2017 16:03:49 +0000</resolved>
                                    <version>1.2.0</version>
                    <version>1.3.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15837716" author="githubbot" created="Wed, 25 Jan 2017 13:19:34 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3209&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3209&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5638&quot; title=&quot;Deadlock when closing two chained async I/O operators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5638&quot;&gt;&lt;del&gt;FLINK-5638&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;asyncIO&amp;#93;&lt;/span&gt; Fix deadlock when closing two chained AsyncWaitOperators&lt;/p&gt;

&lt;p&gt;    This PR addresses the problem by changing the Emitter&apos;s behaviour to first output the&lt;br/&gt;
    element before removing it from the StreamElementQueue. That way the close method waits&lt;br/&gt;
    until also the Emitter has outputted the last completed element. Additionally, the&lt;br/&gt;
    stopResources method now frees the checkpoint lock in order to let the emitter thread&lt;br/&gt;
    react to the interrupt signal.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; asyncIOFixDeadlock&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3209.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3209.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3209&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 30520d95786d630eb14ff613d0990ce03779dd3c&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-25T13:11:48Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5638&quot; title=&quot;Deadlock when closing two chained async I/O operators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5638&quot;&gt;&lt;del&gt;FLINK-5638&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;asyncIO&amp;#93;&lt;/span&gt; Fix deadlock when closing two chained AsyncWaitOperators&lt;/p&gt;

&lt;p&gt;    This PR addresses the problem by changing the Emitter&apos;s behaviour to first output the&lt;br/&gt;
    element before removing it from the StreamElementQueue. That way the close method waits&lt;br/&gt;
    until also the Emitter has outputted the last completed element. Additionally, the&lt;br/&gt;
    stopResources method now frees the checkpoint lock in order to let the emitter thread&lt;br/&gt;
    react to the interrupt signal.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15837717" author="githubbot" created="Wed, 25 Jan 2017 13:20:21 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3210&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5638&quot; title=&quot;Deadlock when closing two chained async I/O operators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5638&quot;&gt;&lt;del&gt;FLINK-5638&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;asyncIO&amp;#93;&lt;/span&gt; Fix deadlock when closing two chained AsyncWaitOperators&lt;/p&gt;

&lt;p&gt;    This PR is a backport of #3209 onto `release-1.2.`&lt;/p&gt;

&lt;p&gt;    This PR addresses the problem by changing the Emitter&apos;s behaviour to first output the&lt;br/&gt;
    element before removing it from the StreamElementQueue. That way the close method waits&lt;br/&gt;
    until also the Emitter has outputted the last completed element. Additionally, the&lt;br/&gt;
    stopResources method now frees the checkpoint lock in order to let the emitter thread&lt;br/&gt;
    react to the interrupt signal.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; asyncIOFixDeadlockBackport&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3210.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3210.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3210&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 770589dd286b1bc30d9bf79d813bc30a371e1995&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-25T13:11:48Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5638&quot; title=&quot;Deadlock when closing two chained async I/O operators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5638&quot;&gt;&lt;del&gt;FLINK-5638&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;asyncIO&amp;#93;&lt;/span&gt; Fix deadlock when closing two chained AsyncWaitOperators&lt;/p&gt;

&lt;p&gt;    This PR addresses the problem by changing the Emitter&apos;s behaviour to first output the&lt;br/&gt;
    element before removing it from the StreamElementQueue. That way the close method waits&lt;br/&gt;
    until also the Emitter has outputted the last completed element. Additionally, the&lt;br/&gt;
    stopResources method now frees the checkpoint lock in order to let the emitter thread&lt;br/&gt;
    react to the interrupt signal.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15837722" author="githubbot" created="Wed, 25 Jan 2017 13:26:20 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3210&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    It&apos;s a bit hacky to release the lock in scope via `wait()` but seems to work.&lt;/p&gt;

&lt;p&gt;    One more reason to go for a post-box model...&lt;/p&gt;

&lt;p&gt;    +1&lt;/p&gt;</comment>
                            <comment id="15837807" author="githubbot" created="Wed, 25 Jan 2017 14:26:34 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3210&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Agreed, the problem is a little bit that you don&apos;t control from where the `close` method is called... Thanks for the review @StephanEwen.&lt;/p&gt;

&lt;p&gt;    Merging once Travis has passed.&lt;/p&gt;</comment>
                            <comment id="15837884" author="githubbot" created="Wed, 25 Jan 2017 15:15:26 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3209&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3209&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Forwarding the review from #3210. Merging this PR.&lt;/p&gt;</comment>
                            <comment id="15837888" author="githubbot" created="Wed, 25 Jan 2017 15:17:58 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3209&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3209&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15837973" author="githubbot" created="Wed, 25 Jan 2017 16:03:06 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3210&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merged&lt;/p&gt;</comment>
                            <comment id="15837974" author="githubbot" created="Wed, 25 Jan 2017 16:03:07 +0000"  >&lt;p&gt;Github user tillrohrmann closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3210&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15837976" author="till.rohrmann" created="Wed, 25 Jan 2017 16:03:49 +0000"  >&lt;p&gt;1.2.0: 103bb361cec6942fb9831d5b0d90b5ee6ee999c5&lt;br/&gt;
1.3.0: a811545ecae762d3d2fd34e5d554c010ccd8b539&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13036527">FLINK-5587</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i396g7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>