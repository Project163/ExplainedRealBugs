<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:56:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21986] taskmanager native memory not release timely after restart</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21986</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I run a regular join job with flink_1.12.1 , and find taskmanager native memory not release timely after restart cause by exceeded checkpoint tolerable failure threshold.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;problem job information&#65306;&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;job first restart cause by&#160;exceeded checkpoint tolerable failure threshold.&lt;/li&gt;
	&lt;li&gt;then taskmanager be killed by yarn many times&lt;/li&gt;
	&lt;li&gt;in this case&#65292;tm heap is set to 7.68G&#65292;bug all tm heap size is under 4.2G&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13022982/13022982_image-2021-03-25-15-53-44-214.png&quot; height=&quot;103&quot; width=&quot;496&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;nonheap size increase after restart&#65292;but still under 160M.&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://km.sankuai.com/api/file/cdn/706284607/716474606?contentType=1&amp;amp;isNewContent=false&amp;amp;isNewContent=false&quot; height=&quot;102&quot; width=&quot;493&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;taskmanager process memory increase 3-4G after restart&#65288;this figure show one of taskmanager&#65289;&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13022981/13022981_image-2021-03-25-16-07-29-083.png&quot; height=&quot;107&quot; width=&quot;493&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;my guess&#65306;&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/facebook/rocksdb/wiki/RocksJava-Basics#memory-management&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RocksDB wiki&lt;/a&gt;&#160;mentioned &#65306;Many of the Java Objects used in the RocksJava API will be backed by C++ objects for which the Java Objects have ownership. As C++ has no notion of automatic garbage collection for its heap in the way that Java does, we must explicitly free the memory used by the C++ objects when we are finished with them.&lt;/p&gt;

&lt;p&gt;So, is it possible that RocksDBStateBackend not call&#160;AbstractNativeReference#close() to release memory use by RocksDB C++ Object ?&lt;/p&gt;

&lt;p&gt;&lt;b&gt;I make a change:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; Actively call System.gc() and System.runFinalization() every minute.&lt;/p&gt;

&lt;p&gt;&#160;&lt;b&gt;And run this test again:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;taskmanager process memory no&#160;obvious increase&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13022980/13022980_image-2021-03-26-11-46-06-828.png&quot; height=&quot;93&quot; width=&quot;495&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;job run for several days&#65292;and restart many times&#65292;but no taskmanager killed by yarn like before&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Summary&#65306;&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;first&#65292;there is some native memory can not release timely after restart in this situation&lt;/li&gt;
	&lt;li&gt;I guess it maybe RocksDB C++ object&#65292;but I hive not check it from source code of&#160;RocksDBStateBackend&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;flink version&#65306;1.12.1&lt;br/&gt;
run &#65306;yarn session&lt;br/&gt;
job type&#65306;mock source -&amp;gt; regular join&lt;br/&gt;
&#160;&lt;br/&gt;
checkpoint interval: 3m&lt;br/&gt;
Taskmanager memory : 16G&lt;br/&gt;
&#160;&lt;/p&gt;</environment>
        <key id="13367764">FLINK-21986</key>
            <summary>taskmanager native memory not release timely after restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Feifan Wang">Feifan Wang</assignee>
                                    <reporter username="Feifan Wang">Feifan Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 26 Mar 2021 03:59:48 +0000</created>
                <updated>Sun, 10 Oct 2021 19:10:42 +0000</updated>
                            <resolved>Tue, 20 Apr 2021 08:33:05 +0000</resolved>
                                    <version>1.11.3</version>
                    <version>1.12.1</version>
                    <version>1.13.0</version>
                                    <fixVersion>1.11.4</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                    <fixVersion>1.12.3</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="17309212" author="yunta" created="Fri, 26 Mar 2021 06:58:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt;, Flink community has ever come across similar problem in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18712&quot; title=&quot;Flink RocksDB statebackend memory leak issue &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18712&quot;&gt;&lt;del&gt;FLINK-18712&lt;/del&gt;&lt;/a&gt; and solved by&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19125&quot; title=&quot;Avoid memory fragmentation when running flink docker image&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19125&quot;&gt;&lt;del&gt;FLINK-19125&lt;/del&gt;&lt;/a&gt; for released docker image, could you try to follow such steps to see whether still problem existed?&lt;/p&gt;</comment>
                            <comment id="17309231" author="feifan wang" created="Fri, 26 Mar 2021 07:26:19 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, I hive read&#160;&lt;del&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18712&quot; title=&quot;Flink RocksDB statebackend memory leak issue &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18712&quot;&gt;&lt;del&gt;FLINK-18712&lt;/del&gt;&lt;/a&gt;&lt;/del&gt;&#160;and&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19125&quot; title=&quot;Avoid memory fragmentation when running flink docker image&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19125&quot;&gt;&lt;del&gt;FLINK-19125&lt;/del&gt;&lt;/a&gt;&#160; , and run two test job to verify that problem before run the test that actively call System.gc() and System.runFinalization().&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;first one, set&#160;MALLOC_ARENA_MAX=1&lt;br/&gt;
 In view of configure containerized.taskmanager.env.MALLOC_ARENA_MAX=1 in flink-conf.yaml not worker in yarn (maybe yarn&apos;s configure override it), I set this env variable in yarn.container-start-command-template , and confirmed&#160; it work ( by check /proc/${tm_pid}/environ).&lt;/li&gt;
	&lt;li&gt;second one, use jemalloc instead of glibc to run taskmanager&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;But, this two test job still has this problem. After that , I run the test actively call System.gc() and System.runFinalization().&lt;/p&gt;</comment>
                            <comment id="17309375" author="yunta" created="Fri, 26 Mar 2021 11:29:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt;, have you confirmed that the second job using jemalloc allocator, you could use&#160;&lt;tt&gt;pmap&lt;/tt&gt; to see whether jemalloc &lt;tt&gt;.so&lt;/tt&gt; file is loaded in your process.&lt;/p&gt;

&lt;p&gt;BTW, since all rocks objects have been disposed when rocksDB keyed state backend is disposed, I doubted whether&#160;System#gc() and System#runFinalization() could help it. Could you make your case as a simple example so that it could be reproduced just like what&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18712&quot; title=&quot;Flink RocksDB statebackend memory leak issue &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18712&quot;&gt;&lt;del&gt;FLINK-18712&lt;/del&gt;&lt;/a&gt;&#160;did.&lt;/p&gt;</comment>
                            <comment id="17309394" author="feifan wang" created="Fri, 26 Mar 2021 12:19:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, I confirmed second test job use jemalloc allocator by&#160;&lt;font color=&quot;#0747a6&quot;&gt;&lt;em&gt;lsof -p ${taskmanager_pid} | grep &apos;jemalloc&apos;&lt;/em&gt; &lt;font color=&quot;#172b4d&quot;&gt;&lt;/font&gt;. And pmap show difference memony usage between problem job and those test jobs.&lt;/font&gt;&lt;font color=&quot;&quot;&gt;&lt;/font&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;in problem job, there are&#160;many 64M memory blocks&lt;/li&gt;
	&lt;li&gt;in first test job with&#160;MALLOC_ARENA_MAX=1, no such many 64M blocks, but a huge memory block amost 12G&lt;/li&gt;
	&lt;li&gt;in second test job which use jemalloc,&#160; no such many 64M blocks too, and some 1G-2G blocks&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;All above there jobs has&#160;a huge memory block with&#160;approximate jvm heap size (7.68G).&lt;/p&gt;</comment>
                            <comment id="17309405" author="yunta" created="Fri, 26 Mar 2021 12:41:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt;, have you ever used &lt;a href=&quot;https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Heap-Profiling&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jemalloc&lt;/a&gt; or &lt;a href=&quot;https://gperftools.github.io/gperftools/heapprofile.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tcmalloc&lt;/a&gt; to help memory profiling? I think they&apos;re the final two methods to see what caused the memory leak. You might need to rebuild jemalloc if truing on &lt;tt&gt;--enable-prof&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17309407" author="feifan wang" created="Fri, 26 Mar 2021 12:45:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, this problem seems like some&#160;garbage java object maintain native memory until be cleaned up by garbage collector. But heap memory usage is always below 60% in those job, so no full gc&#160;occured. Third test job avoid memory usage exceed by call System#gc() and System#runFinalization() , it proves some native memory can be release along with java object cleaned up. It very like situation described in &lt;a href=&quot;https://github.com/facebook/rocksdb/wiki/RocksJava-Basics#memory-management&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RocksJava memory-management&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;My test job is a little&#160;complex, I will simplify it later.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17309409" author="feifan wang" created="Fri, 26 Mar 2021 12:49:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, I haven&apos;t tried jemalloc or tcmalloc memory profiling, this sounds a good idea. I will learn how to use it and try out.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17312197" author="feifan wang" created="Wed, 31 Mar 2021 08:51:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, I have re run&#160;second test job which use jemalloc and truing on --enable-prof, and jeprof shows most memory is used by&#160;rocksdb::UncompressBlockContentsForCompressionType.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Total: 12594.6 MB
 10725.4  85.2%  85.2%  10725.4  85.2% rocksdb::UncompressBlockContentsForCompressionType
  1226.3   9.7%  94.9%   1226.3   9.7% je_prof_backtrace
   220.0   1.7%  96.6%    249.4   2.0% rocksdb::LRUCacheShard::Insert
   184.0   1.5%  98.1%    184.0   1.5% rocksdb::Arena::AllocateNewBlock
   149.5   1.2%  99.3%  10874.9  86.3% rocksdb::BlockBasedTable::PartitionedIndexIteratorState::NewSecondaryIterator
    48.0   0.4%  99.7%     48.0   0.4% init
    29.4   0.2%  99.9%     29.4   0.2% rocksdb::LRUHandleTable::Resize
     3.6   0.0%  99.9%      4.1   0.0% readCEN
     3.1   0.0% 100.0%      3.1   0.0% std::string::_Rep::_S_create
     1.6   0.0% 100.0%      1.6   0.0% rocksdb::WritableFileWriter::WritableFileWriter
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here is svg file produce by jeprof&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13023223/13023223_82544.svg&quot; title=&quot;82544.svg attached to FLINK-21986&quot;&gt;82544.svg&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;.&lt;/p&gt;

&lt;p&gt;It&apos;s not as expected.&#160;Managed Memory is set to 5.9G, but rocksdb used 10.5G.&lt;/p&gt;</comment>
                            <comment id="17312920" author="yunta" created="Thu, 1 Apr 2021 06:58:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt; I think this is really weird after looking at your prof svg. Could you make your example as public so that I could run the job by myselfy.&lt;/p&gt;

&lt;p&gt;If it&apos;s not easy to extract the logic, could you please provided the RocksDB LOG (need to set DEBUG level, and you could set it in Flink-1.13 &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-master/docs/deployment/config/#state-backend-rocksdb-log-level&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-master/docs/deployment/config/#state-backend-rocksdb-log-level&lt;/a&gt; ).&lt;/p&gt;</comment>
                            <comment id="17313537" author="feifan wang" created="Fri, 2 Apr 2021 03:33:32 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, I simplify test code and put it to&#160;&lt;a href=&quot;https://github.com/zoltar9264/flink-21986-regular-join-test-case&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;flink-21986-regular-join-test-case&lt;/a&gt;&#160;, you can run the test job from it. Notice, some configuration in&#160;top.zoltar.flink.issue.config.ConfigConstant, you can modify it.&lt;/p&gt;</comment>
                            <comment id="17321239" author="feifan wang" created="Wed, 14 Apr 2021 18:44:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;,&#160;I confirm that I found the cause of this problem :&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; org.apache.flink.contrib.streaming.state.RocksDBOperationUtils#addColumnFamilyOptionsToCloseLater() &lt;font color=&quot;#FF0000&quot;&gt;called ColumnFamilyHandle#getDescriptor() twice by mistake&lt;/font&gt;&#12290;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void addColumnFamilyOptionsToCloseLater(
        List&amp;lt;ColumnFamilyOptions&amp;gt; columnFamilyOptions, ColumnFamilyHandle columnFamilyHandle) {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (columnFamilyHandle != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; columnFamilyHandle.getDescriptor() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            columnFamilyOptions.add(columnFamilyHandle.getDescriptor().getOptions());
        }
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RocksDBException e) {
        &lt;span class=&quot;code-comment&quot;&gt;// ignore
&lt;/span&gt;    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As every time call&#160;ColumnFamilyHandle#getDescriptor() create a new&#160;ColumnFamilyDescriptor which hold a new ColumnFamilyOptions instance,&#160;RocksDBOperationUtils#addColumnFamilyOptionsToCloseLater create two&#160;ColumnFamilyOptions instances&#160;actually&#65292;but only second be add to &quot;closeLater list&quot;.&#160;As a result, some&#160;ColumnFamilyOptions instances has not been closed.&lt;/p&gt;

&lt;p&gt;I modified this method that only call&#160;ColumnFamilyHandle#getDescriptor() once and run the test job again which result shows the&#160;modification works.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please assign this issue to me, I will open a pull request to fix this problem, thanks.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17321982" author="feifan wang" created="Thu, 15 Apr 2021 07:47:02 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;,&#160; I opened a pull request to fix this problem, but&#160;flinkbot&#160;prompted &quot;&lt;font color=&quot;#de350b&quot;&gt;This pull request references an unassigned&#160;Jira ticket&lt;/font&gt;&quot;.&lt;/p&gt;

&lt;p&gt;So please assign this issue to me, thanks.&#160;&lt;/p&gt;</comment>
                            <comment id="17324461" author="feifan wang" created="Sun, 18 Apr 2021 09:22:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;,&#160;sorry for disturbance, can you&#160;help me review this problem, and assign this issue to me &#65311;&lt;/p&gt;</comment>
                            <comment id="17325570" author="till.rohrmann" created="Tue, 20 Apr 2021 07:54:28 +0000"  >&lt;p&gt;Thanks for reporting this issue and analyzing it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt;. From what you describe I believe that we should fix this problem for the upcoming release. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt; could you help reviewing this change? If not then we should find somebody else taking a look at the PR.&lt;/p&gt;</comment>
                            <comment id="17325573" author="till.rohrmann" created="Tue, 20 Apr 2021 07:59:35 +0000"  >&lt;p&gt;The change is so simple that I can review and merge it. I will take care of it.&lt;/p&gt;</comment>
                            <comment id="17325575" author="yunta" created="Tue, 20 Apr 2021 08:07:33 +0000"  >&lt;p&gt;Sorry for late reply and glad to see you finally figured out the root cause &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt;, great work!&#160;&lt;/p&gt;</comment>
                            <comment id="17325596" author="yunta" created="Tue, 20 Apr 2021 08:32:09 +0000"  >&lt;p&gt;Unlike previous RocksDB memory related problem, the created &lt;tt&gt;ColumnFamilyDescriptor&lt;/tt&gt; is just a java object instead of RocksObject which holds no native reference, that might explain why force GC could help avoid such behavior. Current PR could avoid one time to create &lt;tt&gt;ColumnFamilyDescriptor&lt;/tt&gt;, however, I wonder why another more time to create could cause memory leak. Maybe we need some other efforts to dig into this problem.&lt;/p&gt;</comment>
                            <comment id="17325598" author="till.rohrmann" created="Tue, 20 Apr 2021 08:33:05 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;master: 57ba2ff64add32df2598e1e35ee19a76eff8194c&lt;br/&gt;
1.13.0: 0e1468a4aadf68019f034eaad8bbf50a8ecf9589&lt;br/&gt;
1.12.3: 2cd2fecc121266109f9635a24ca956022b8ab283&lt;br/&gt;
1.11.4: 4dfef1b2e079a0f0e07aec994f721adf27a47b9a&lt;/p&gt;</comment>
                            <comment id="17325600" author="till.rohrmann" created="Tue, 20 Apr 2021 08:34:17 +0000"  >&lt;p&gt;I&apos;ve merged the PR because it is definitely an improvement (in the worst case it avoids duplicate Java object creation). If the problem should still exist, then please re-open this issue.&lt;/p&gt;</comment>
                            <comment id="17346558" author="yunta" created="Tue, 18 May 2021 03:30:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt;, could you tell me what the docker image, the parallelism, the related memory configuration and what operations you would take when you run flink-21986-regular-join-test-case? It seems I did not reproduce the problem of memory continue growing up after failover restore when running flink-21986-regular-join-test-case.&lt;/p&gt;</comment>
                            <comment id="17347275" author="feifan wang" created="Wed, 19 May 2021 03:01:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;,&#160;thank you for your continued attention to this issue.&lt;/p&gt;

&lt;p&gt;You can try reproduce this problem use&#160;flink-21986-regular-join-test-case with 25 taskmanager and 8 slots per taskmanager, and taskmanager process memory set to 16G. By the way, I test it use yarn session instead of docker. And flink version is 1.12.1. Other settings can keep default , such as mock source&#160;parallelism&#12289;join&#160;parallelism, this part configuration is in&#160;src/main/java/top/zoltar/flink/issue/config/ConfigConstant.java .&lt;/p&gt;

&lt;p&gt;After start the job&#65292;you hive no need to create some&#160;failover manually , in my test, it will restart in about one hour.&lt;/p&gt;</comment>
                            <comment id="17426853" author="sap1ens" created="Sun, 10 Oct 2021 19:10:42 +0000"  >&lt;p&gt;We had a very similar problem in 1.13. Found this issue &lt;a href=&quot;https://github.com/facebook/rocksdb/issues/4112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/facebook/rocksdb/issues/4112&lt;/a&gt;&#160;and decided to try disabling RocksDB block cache:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;state.backend.rocksdb.options-factory: xxx.NoBlockCacheRocksDbOptionsFactory&lt;br/&gt;
state.backend.rocksdb.memory.managed: false&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;br/&gt;
Where NoBlockCacheRocksDbOptionsFactory essentially does:&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;val blockBasedTableConfig = new BlockBasedTableConfig()&lt;br/&gt;
blockBasedTableConfig.setNoBlockCache(true)&lt;br/&gt;
// Needed in order to disable block cache&lt;br/&gt;
blockBasedTableConfig.setCacheIndexAndFilterBlocks(false)&lt;br/&gt;
blockBasedTableConfig.setCacheIndexAndFilterBlocksWithHighPriority(false)&lt;br/&gt;
blockBasedTableConfig.setPinL0FilterAndIndexBlocksInCache(false)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;br/&gt;
We did NOT see big performance degradation when running on SSDs.&#160;&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13023223" name="82544.svg" size="94431" author="Feifan Wang" created="Wed, 31 Mar 2021 08:45:14 +0000"/>
                            <attachment id="13022982" name="image-2021-03-25-15-53-44-214.png" size="724605" author="Feifan Wang" created="Thu, 25 Mar 2021 07:53:48 +0000"/>
                            <attachment id="13022981" name="image-2021-03-25-16-07-29-083.png" size="106692" author="Feifan Wang" created="Thu, 25 Mar 2021 08:07:30 +0000"/>
                            <attachment id="13022980" name="image-2021-03-26-11-46-06-828.png" size="109083" author="Feifan Wang" created="Fri, 26 Mar 2021 03:46:08 +0000"/>
                            <attachment id="13022979" name="image-2021-03-26-11-47-21-388.png" size="109083" author="Feifan Wang" created="Fri, 26 Mar 2021 03:47:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 5 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0p81c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>