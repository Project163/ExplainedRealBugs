<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:20:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-35885] proctime aggregate window triggered by watermark</title>
                <link>https://issues.apache.org/jira/browse/FLINK-35885</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We have discovered an unexpected case where abnormal data with a count of 0 occurs when performing proctime window aggregation on data with a watermark.&lt;/p&gt;

&lt;p&gt;The SQL is as follows&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; s1 (
    id &lt;span class=&quot;code-keyword&quot;&gt;INT&lt;/span&gt;,
    event_time &lt;span class=&quot;code-keyword&quot;&gt;TIMESTAMP&lt;/span&gt;(3),
    &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;,
    proc_time &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; PROCTIME (),
    WATERMARK &lt;span class=&quot;code-keyword&quot;&gt;FOR&lt;/span&gt; event_time &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; event_time - &lt;span class=&quot;code-keyword&quot;&gt;INTERVAL&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;10&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;SECOND&lt;/span&gt;
)
&lt;span class=&quot;code-keyword&quot;&gt;WITH&lt;/span&gt;
    (&lt;span class=&quot;code-quote&quot;&gt;&apos;connector&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;my-&lt;span class=&quot;code-keyword&quot;&gt;source&lt;/span&gt;&apos;&lt;/span&gt;)
;

&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt;
    *
&lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt;
    (
        &lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;,
            &lt;span class=&quot;code-keyword&quot;&gt;COUNT&lt;/span&gt;(id) &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; total_count,
            window_start,
            window_end
        &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; (
                TUMBLE (
                    &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; s1,
                    &lt;span class=&quot;code-keyword&quot;&gt;DESCRIPTOR&lt;/span&gt; (proc_time),
                    &lt;span class=&quot;code-keyword&quot;&gt;INTERVAL&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;30&apos;&lt;/span&gt; SECONDS
                )
            )
        &lt;span class=&quot;code-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;BY&lt;/span&gt;
            window_start,
            window_end,
            &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;
    )
&lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt;
    total_count = 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;For detailed test code, please refer to &lt;a href=&quot;https://github.com/xingsuo-zbz/flink/blob/zbz/117/proc-agg-window-process-watermark-bug-test/flink-table/flink-table-planner/src/test/java/org/apache/flink/table/planner/runtime/stream/sql/bug/WindowBugTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/xingsuo-zbz/flink/blob/zbz/117/proc-agg-window-process-watermark-bug-test/flink-table/flink-table-planner/src/test/java/org/apache/flink/table/planner/runtime/stream/sql/bug/WindowBugTest.java&lt;/a&gt;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;The root cause is that &lt;a href=&quot;https://github.com/apache/flink/blob/release-1.17.2/flink-table/flink-table-runtime/src/main/java/org/apache/flink/table/runtime/operators/window/slicing/SlicingWindowOperator.java#L229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/release-1.17.2/flink-table/flink-table-runtime/src/main/java/org/apache/flink/table/runtime/operators/window/slicing/SlicingWindowOperator.java#L229&lt;/a&gt; supports advance progress by watermark. When the watermark suddenly exceeds the next window end timestamp, a result of count 0 will appear.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void processWatermark(Watermark mark) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (mark.getTimestamp() &amp;gt; currentWatermark) {
            windowProcessor.advanceProgress(mark.getTimestamp());
            &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.processWatermark(mark);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.processWatermark(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Watermark(currentWatermark));
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;flink 1.13.6 with blink or flink 1.17.2&lt;/p&gt;</environment>
        <key id="13586671">FLINK-35885</key>
            <summary>proctime aggregate window triggered by watermark</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xuyangzhong">Xuyang Zhong</assignee>
                                    <reporter username="zbz"> xingsuo-zbz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 23 Jul 2024 13:33:19 +0000</created>
                <updated>Mon, 2 Sep 2024 09:35:40 +0000</updated>
                            <resolved>Wed, 7 Aug 2024 15:27:00 +0000</resolved>
                                    <version>1.13.6</version>
                    <version>1.17.2</version>
                                    <fixVersion>1.19.2</fixVersion>
                    <fixVersion>1.20.1</fixVersion>
                    <fixVersion>2.0-preview</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17868232" author="yunta" created="Wed, 24 Jul 2024 03:09:01 +0000"  >&lt;p&gt;I think this problem might be because user misuse event-time watermark with processing-time based window, maybe we could throw some exceptions here. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lincoln.86xy&quot; class=&quot;user-hover&quot; rel=&quot;lincoln.86xy&quot;&gt;lincoln.86xy&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuyangzhong&quot; class=&quot;user-hover&quot; rel=&quot;xuyangzhong&quot;&gt;xuyangzhong&lt;/a&gt; what do you think?&lt;/p&gt;</comment>
                            <comment id="17868658" author="xuyangzhong" created="Thu, 25 Jul 2024 12:06:01 +0000"  >&lt;p&gt;The bug is caused by the advancement of the watermark and the proctime timer, both of which trigger the advance of the window buffer. When the window buffer advances, it records the time of the last advancement, so that when a new advancement point arrives that is smaller than this time, it does not need to flush the data again but can instead retrieve it directly from the state.&lt;/p&gt;

&lt;p&gt;The bug occurs when a watermark (wt) that is larger than the proctime (pt) arrives first. This causes the window buffer to advance and flush the data in the buffer to the state. When the proctime is triggered by the timer, the window buffer assumes that the data for this time point (pt) has already been flushed to the state because pt &amp;lt; wt. However, in reality, the data in the state is incomplete (or possibly even empty).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17868659" author="xuyangzhong" created="Thu, 25 Jul 2024 12:08:16 +0000"  >&lt;p&gt;I think this bug needs to be fixed although it only affects the case where watermark is larger than proctime.&#160;&lt;/p&gt;

&lt;p&gt;I will propose a PR to fix it in the next few days.&lt;/p&gt;</comment>
                            <comment id="17871703" author="lincoln.86xy" created="Wed, 7 Aug 2024 15:27:00 +0000"  >&lt;p&gt;Fixed in master: b3b709f46ca7b12d9a26192a60cdde790d8523b9&lt;/p&gt;</comment>
                            <comment id="17871704" author="lincoln.86xy" created="Wed, 7 Aug 2024 15:28:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuyangzhong&quot; class=&quot;user-hover&quot; rel=&quot;xuyangzhong&quot;&gt;xuyangzhong&lt;/a&gt; Could you also do the backport to both 1.19 &amp;amp; 1.20 branch?&lt;/p&gt;</comment>
                            <comment id="17871956" author="xuyangzhong" created="Thu, 8 Aug 2024 11:27:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lincoln.86xy&quot; class=&quot;user-hover&quot; rel=&quot;lincoln.86xy&quot;&gt;lincoln.86xy&lt;/a&gt; Sure.&lt;/p&gt;</comment>
                            <comment id="17872236" author="lincoln.86xy" created="Fri, 9 Aug 2024 08:11:25 +0000"  >&lt;p&gt;Fixed in 1.20: 01c0a24c9152721a6fe976797e197cfa72cea97d&lt;/p&gt;

&lt;p&gt;1.19: 08649fd6981655bcd131c76ef36f6dd074566dd0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 13 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qhlc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>