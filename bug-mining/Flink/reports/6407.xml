<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:10:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-26394] CheckpointCoordinator.isTriggering can not be reset if a checkpoint expires while the checkpointCoordinator task is queuing in the SourceCoordinator executor.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-26394</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We found a job can no longer trigger checkpoints or savepoints after recovering from a checkpoint timeout failure. After investigation, we found that the `isTriggering` flag is CheckpointCoordinator is true while no checkpoint is actually doing, and the root cause is as following:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The job uses a source whose coordinator needs to scan a table while requesting splits, which may cost more than 10min. The source coordinator executor thread will be occupied by `handleSplitRequest`, and `checkpointCoordinator` task of the first checkpoint will be queued after it.&lt;/li&gt;
	&lt;li&gt;10min later, the checkpoint is expired, removing the pending checkpoint from the coordinator, and triggering a global failover. But the `isTriggering` is not reset here. It can only be reset after the checkpoint completable future is done, which is now holding only by the `checkpointCoordinator` task in the queue, along with the PendingCheckpoint.&lt;/li&gt;
	&lt;li&gt;Then the job failover, and the RecreateOnResetOperatorCoordinator will recreate a new SourceCoordinator, and close the previous coordinator asynchronously. Timeout for the closing is fixed to 60s. SourceCoordinator will try to `shutdown` the coordinator executor then `awaitTermination`. If the tasks are done within 60s, nothing wrong will happen.&lt;/li&gt;
	&lt;li&gt;But if the closing method is stuck for more than 60s (which in this case is actually stuck in the `handleSplitRequest`), the async closing thread will be interrupted and SourceCoordinator will `shutdownNow` the executor. All tasks queuing will be discarded, including the `checkpointCoordinator` task.&lt;/li&gt;
	&lt;li&gt;Then the checkpoint completable future will never complete and the `isTriggering` flag will never be reset.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I see that the closing part of SourceCoordinator is recently refactored. But I find the new implementation also has this issue. And since it calls `shutdownNow` directly, the issue should be easier to encounter.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13430962">FLINK-26394</key>
            <summary>CheckpointCoordinator.isTriggering can not be reset if a checkpoint expires while the checkpointCoordinator task is queuing in the SourceCoordinator executor.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="pltbkd">Gen Luo</assignee>
                                    <reporter username="pltbkd">Gen Luo</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>stale-assigned</label>
                    </labels>
                <created>Mon, 28 Feb 2022 10:38:34 +0000</created>
                <updated>Fri, 11 Nov 2022 08:40:13 +0000</updated>
                                            <version>1.16.0</version>
                    <version>1.15.3</version>
                                    <fixVersion>1.16.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="17499358" author="yunta" created="Tue, 1 Mar 2022 07:03:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pltbkd&quot; class=&quot;user-hover&quot; rel=&quot;pltbkd&quot;&gt;pltbkd&lt;/a&gt;, do you have any test case to reproduce this problem?&lt;/p&gt;</comment>
                            <comment id="17499474" author="pltbkd" created="Tue, 1 Mar 2022 11:29:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt; The problem can be reproduced by:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;add a 10s sleeping (or 120s for the older version) in the RequestSplitEvent processing branch in SourceCoordinator.handleEventFromOperator. This is imitating the behavior that enumerator.handleSplitRequest takes too long.&lt;/li&gt;
	&lt;li&gt;set the checkpoint timeout to 2s for FileSourceTextLinesITCase.testContinuousTextFileSource&lt;/li&gt;
	&lt;li&gt;run the test FileSourceTextLinesITCase.testContinuousTextFileSource (with FailoverType=NONE)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17503579" author="yunta" created="Wed, 9 Mar 2022 13:07:34 +0000"  >&lt;p&gt;Though the PR still has broken tests, I think this problem really exists. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="17505968" author="becket_qin" created="Mon, 14 Mar 2022 03:13:19 +0000"  >&lt;p&gt;Good catch. We need to recycle the futures that are handled to the SourceCoordinator (and in general any user implemented plugins) in case it is not completed for some reason.&lt;/p&gt;</comment>
                            <comment id="17506047" author="pltbkd" created="Mon, 14 Mar 2022 07:58:11 +0000"  >&lt;p&gt;I agree with you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;IMO CheckpointCoordinator should always hold the ownership of the futures and handle the exceptions as the last resort, since the implementations of OperatorCoordinator can be various.&lt;/p&gt;

&lt;p&gt;While since the SourceCoordinator is under control, and the problem may also influence the registered futures from other modules to the SourceCoordinator, I think the SourceCoordinator should also handle the futures in such cases.&lt;/p&gt;</comment>
                            <comment id="17563113" author="flink-jira-bot" created="Wed, 6 Jul 2022 10:40:09 +0000"  >&lt;p&gt;I am the &lt;a href=&quot;https://github.com/apache/flink-jira-bot/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Flink Jira Bot&lt;/a&gt; and I help the community manage its development. I see this issue is assigned but has not received an update in 30 days, so it has been labeled &quot;stale-assigned&quot;.&lt;br/&gt;
If you are still working on the issue, please remove the label and add a comment updating the community on your progress.  If this issue is waiting on feedback, please consider this a reminder to the committer/reviewer. Flink is a very active project, and so we appreciate your patience.&lt;br/&gt;
If you are no longer working on the issue, please unassign yourself so someone else may work on it.&lt;/p&gt;</comment>
                            <comment id="17564195" author="gaoyunhaii" created="Fri, 8 Jul 2022 09:40:48 +0000"  >&lt;p&gt;Merged on master via&#160;31222b9adf1c354b22fd50c587efc16734b18d40&lt;/p&gt;</comment>
                            <comment id="17579959" author="JIRAUSER294435" created="Mon, 15 Aug 2022 23:10:45 +0000"  >&lt;p&gt;I have the same problem. Flink 1.14.4&lt;/p&gt;

&lt;p&gt;It is hard to Cherry pick into 1.14.4.&lt;/p&gt;

&lt;p&gt;Anything else I can do to solve problem.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pltbkd&quot; class=&quot;user-hover&quot; rel=&quot;pltbkd&quot;&gt;pltbkd&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17585177" author="pltbkd" created="Fri, 26 Aug 2022 06:38:13 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gezhiwei8899&quot; class=&quot;user-hover&quot; rel=&quot;gezhiwei8899&quot;&gt;gezhiwei8899&lt;/a&gt;,&lt;br/&gt;
The issue should be existing in any version that has the source coordinator, but in only a few cases (i.e. cdc source) the bug will really happen. I&apos;m working on picking this fix, along with the bugfix (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-27148&quot; title=&quot;UnalignedCheckpointITCase fails on AZP&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-27148&quot;&gt;&lt;del&gt;FLINK-27148&lt;/del&gt;&lt;/a&gt;) for this fix, to 1.13, 1.14 and 1.15, which I also mentioned on the pull request. Would you please take a look at the PRs and verify if it can solve your problem?&lt;/p&gt;</comment>
                            <comment id="17585184" author="JIRAUSER294435" created="Fri, 26 Aug 2022 07:03:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pltbkd&quot; class=&quot;user-hover&quot; rel=&quot;pltbkd&quot;&gt;pltbkd&lt;/a&gt; thanks for replying. &#160;I&apos;m using Flink 1.15.1 which release on 6 Jul.Checkpoint never triggers again when timeout occurs.&lt;/p&gt;</comment>
                            <comment id="17585199" author="pltbkd" created="Fri, 26 Aug 2022 07:32:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gezhiwei8899&quot; class=&quot;user-hover&quot; rel=&quot;gezhiwei8899&quot;&gt;gezhiwei8899&lt;/a&gt; ,&lt;br/&gt;
It&apos;s expected because, though the fix is merged to release-1.15 with 9fc89a05 on 2022/4/6, it&apos;s reverted with 0c718666 on 2022/4/14, and is not added back to release-1.15 again. At present the fix (31222b9a) and its fix (2c608b8e) are only on the master branch. I&apos;m back porting the changes to release 1.15 now in the pull request &lt;a href=&quot;https://github.com/apache/flink/pull/20683&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;20683&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17623913" author="fabian.paul" created="Tue, 25 Oct 2022 16:05:03 +0000"  >&lt;p&gt;I am reopening the issue because it only has been fixed on 1.16 and not on 1.15&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10008:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>