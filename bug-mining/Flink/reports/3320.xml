<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:41:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14434] Dispatcher#createJobManagerRunner should not start JobManagerRunner</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14434</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In an edge case, let&apos;s said&lt;/p&gt;

&lt;p&gt;1) job finished nearly immediately&lt;br/&gt;
2) Dispatcher has been suspended in &lt;tt&gt;#startJobManagerRunner&lt;/tt&gt; after &lt;tt&gt;jobManagerRunner.start();&lt;/tt&gt; but before &lt;tt&gt;return jobManagerRunner;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;due to&lt;/p&gt;

&lt;p&gt;1) we put &lt;tt&gt;jobManagerRunnerFutures&lt;/tt&gt; with &lt;tt&gt;#startJobManagerRunner&lt;/tt&gt; finished.&lt;br/&gt;
2) the creation of JobManagerRunner doesn&apos;t happen in MainThread.&lt;/p&gt;

&lt;p&gt;it is a possible execution order&lt;/p&gt;

&lt;p&gt;1) JobManagerRunner created in akka-dispatcher thread&lt;br/&gt;
2) then apply &lt;tt&gt;Dispatcher#startJobManagerRunner&lt;/tt&gt;&lt;br/&gt;
3) until &lt;tt&gt;jobManagerRunner.start();&lt;/tt&gt; and before &lt;tt&gt;return jobManagerRunner;&lt;/tt&gt;&lt;br/&gt;
4) this thread suspended&lt;br/&gt;
5) job finished, execute callback on MainThread&lt;br/&gt;
6) &lt;tt&gt;jobManagerRunnerFutures.get(jobID).getNow(null)&lt;/tt&gt; returns &lt;tt&gt;null&lt;/tt&gt; because akka-dispatcher thread doesn&apos;t &lt;tt&gt;return jobManagerRunner;&lt;/tt&gt;&lt;br/&gt;
7) it report &lt;tt&gt;There is a newer JobManagerRunner for the job&lt;/tt&gt; but actually not.&lt;/p&gt;

&lt;p&gt;*&lt;b&gt;Solution&lt;/b&gt;*&lt;/p&gt;

&lt;p&gt;Two perspective but we can even have them both.&lt;/p&gt;

&lt;p&gt;1. return &lt;tt&gt;jobManagerRunnerFuture&lt;/tt&gt; in &lt;tt&gt;#createJobManagerRunner&lt;/tt&gt;, let &lt;tt&gt;#startJobManagerRunner&lt;/tt&gt; an action&lt;br/&gt;
2. on JobManagerRunner created, execute &lt;tt&gt;#startJobManagerRunner&lt;/tt&gt; in MainThread.&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13262821">FLINK-14434</key>
            <summary>Dispatcher#createJobManagerRunner should not start JobManagerRunner</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tison">Zili Chen</assignee>
                                    <reporter username="tison">Zili Chen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 17 Oct 2019 10:11:56 +0000</created>
                <updated>Fri, 29 Nov 2019 15:19:12 +0000</updated>
                            <resolved>Mon, 21 Oct 2019 21:23:28 +0000</resolved>
                                    <version>1.8.2</version>
                    <version>1.9.1</version>
                    <version>1.10.0</version>
                                    <fixVersion>1.8.3</fixVersion>
                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16953615" author="tison" created="Thu, 17 Oct 2019 10:35:47 +0000"  >&lt;p&gt;With the patch attached it can reproduce this case. You will see the new test hang while apply solutions mentioned above it passed.&lt;/p&gt;</comment>
                            <comment id="16954316" author="tison" created="Fri, 18 Oct 2019 06:45:26 +0000"  >&lt;p&gt;Now I would prefer 2 only because with 1 we possibly miss exception in JobManagerRunner#start so that user receive submission success but request job result with job not found because start failed and the job manager runner future removed without a result.&lt;/p&gt;</comment>
                            <comment id="16954784" author="till.rohrmann" created="Fri, 18 Oct 2019 16:31:37 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt;. I think you are right with your analysis. I would also prefer option two atm. &lt;/p&gt;

&lt;p&gt;In fact, I actually want to rework this part and the &lt;tt&gt;JobManagerRunner&lt;/tt&gt; a bit with &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11719&quot; title=&quot;Remove JobMaster#start(JobMasterId) and #suspend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11719&quot;&gt;&lt;del&gt;FLINK-11719&lt;/del&gt;&lt;/a&gt;. I hope to get rid of the concurrency introduced by the asynchronous creation of the &lt;tt&gt;JobManagerRunner&lt;/tt&gt; at the cost of a slightly changed submission behaviour.&lt;/p&gt;</comment>
                            <comment id="16955058" author="tison" created="Sat, 19 Oct 2019 03:13:55 +0000"  >&lt;p&gt;Thanks for your reply &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;. I final a possibly better option3 for this issue. The diff is tiny and expressive.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/TisonKun/flink/commit/baacecb92f11cd367dc89bc48744fea6de94670b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/TisonKun/flink/commit/baacecb92f11cd367dc89bc48744fea6de94670b&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In short, the problem described above is mainly caused by when &quot;job manager runner result future&quot; called back, &quot;job manager runner created future&quot; conceptually finished but not completed. Revisit the semantic of &lt;tt&gt;#createJobManagerRunner&lt;/tt&gt; we are able to just return a future represent the creation and let the caller take care of the start.&lt;/p&gt;

&lt;p&gt;Compared with option 2, this approach has a clear semantic and a subtle difference that it execute &lt;tt&gt;JobManagerRunner&lt;/tt&gt; in akka-dispatcher thread, not in MainThread. We internally have some issue if starting jm runner happens in dispatcher MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; but it doesn&apos;t exist in community codebase.&lt;/p&gt;

&lt;p&gt;I&apos;m glad to help with &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11843&quot; title=&quot;Dispatcher fails to recover jobs if leader change happens during JobManagerRunner termination&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11843&quot;&gt;&lt;del&gt;FLINK-11843&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11719&quot; title=&quot;Remove JobMaster#start(JobMasterId) and #suspend&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11719&quot;&gt;&lt;del&gt;FLINK-11719&lt;/del&gt;&lt;/a&gt; on the review side. For this issue I&apos;d like to send this tiny patch as a pull request  so that you can coordinate patches depending on your schedule.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; FYI: It is an interesting case but bias a bit from community codebase. We move the access to job registry totally to Dispatcher so that when job manager runner granted leadership it send a RPC to Dispatcher for querying what job scheduling status now. Our fork is currently based on 1.7 so that there is a dead-lock execution order with solution option 2 above.&lt;/p&gt;

&lt;p&gt;1. job manager runner called &lt;tt&gt;#start&lt;/tt&gt; in Dispatcher MainThread&lt;br/&gt;
2. job manager runner leader election service started, and if it is standalone(non-ha), it directly calls grantLeadership&lt;br/&gt;
3. job manager runner on granted leadership, send a RPC to Dispatcher for querying and wait for the result.&lt;br/&gt;
4. because &lt;tt&gt;#start&lt;/tt&gt; occupied the MainThread, the later RPC cannot be processed.&lt;/p&gt;

&lt;p&gt;We can workaround this case in many ways such as dispatch action a bit, but it might infer that if we can schedule an action out of Dispatcher MainThread without worry about synchronization provided by single-thread, we&apos;d better to do it.&lt;/p&gt;</comment>
                            <comment id="16956044" author="till.rohrmann" created="Mon, 21 Oct 2019 13:03:57 +0000"  >&lt;p&gt;Thanks for the additional information &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt;. I always prefer better solutions &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Will take a look at your PR.&lt;/p&gt;</comment>
                            <comment id="16956456" author="till.rohrmann" created="Mon, 21 Oct 2019 21:23:28 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.10.0: e1f5eade68b54f4771fe7ec50c5812c567e97174&lt;br/&gt;
1.9.2: 43ae34172fd6680861f7c5c54a498e3c5da4b8a2&lt;br/&gt;
1.8.3: 9add2b141e5142627ef397a3ab4be425ce389c8f&lt;/p&gt;</comment>
                            <comment id="16958638" author="tison" created="Thu, 24 Oct 2019 08:01:11 +0000"  >&lt;p&gt;FYI I just notice that &lt;tt&gt;thenApply&lt;/tt&gt; (and so on which doesn&apos;t have a &lt;tt&gt;Async&lt;/tt&gt; suffix) possibly runs in the current thread(instead of the thread executing the previous computation) if the previous computation is completed on &lt;tt&gt;thenApply&lt;/tt&gt; called. Thus the analysis above is a bit wrong because we don&apos;t ensure the starting scheduled to akka-dispatcher but possibly synchronously with &lt;tt&gt;thenApply&lt;/tt&gt; which means in the MainThread.&lt;/p&gt;

&lt;p&gt;However, this fix isn&apos;t affected by this discovery. Just for further information if this difference becomes significant.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12983266" name="patch.diff" size="2332" author="tison" created="Thu, 17 Oct 2019 10:35:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07omo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>