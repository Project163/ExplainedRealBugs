<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:47:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18242] Custom OptionsFactory settings seem to have no effect on RocksDB</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18242</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&#160;When I configure a custom &lt;tt&gt;OptionsFactory&lt;/tt&gt; for RocksDB like this (similarly by specifying it via the &lt;tt&gt;state.backend.rocksdb.options-factory&lt;/tt&gt; configuration):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Configuration globalConfig = GlobalConfiguration.loadConfiguration();
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; checkpointDataUri = globalConfig.getString(CheckpointingOptions.CHECKPOINTS_DIRECTORY);
RocksDBStateBackend stateBackend = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RocksDBStateBackend(checkpointDataUri);
stateBackend.setOptions(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultConfigurableOptionsFactoryWithLog());
env.setStateBackend((StateBackend) stateBackend);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;it seems to be loaded&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-06-10 12:54:20,720 INFO  org.apache.flink.contrib.streaming.state.RocksDBStateBackend  - Using predefined options: DEFAULT.
2020-06-10 12:54:20,721 INFO  org.apache.flink.contrib.streaming.state.RocksDBStateBackend  - Using application-defined options factory: DefaultConfigurableOptionsFactoryWithLog{DefaultConfigurableOptionsFactory{configuredOptions={}}}. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but it seems like none of the options defined in there is actually used. Just as an example, my factory does set the info log level to &lt;tt&gt;INFO_LEVEL&lt;/tt&gt; but this is what you will see in the created RocksDB instance:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt; cat /tmp/flink-io-c95e8f48-0daa-4fb9-a9a7-0e4fb42e9135/*/db/OPTIONS*|grep info_log_level
  info_log_level=HEADER_LEVEL
  info_log_level=HEADER_LEVEL&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Together with the bug from &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18241&quot; title=&quot;Custom OptionsFactory in user code not working when configured via flink-conf.yaml&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18241&quot;&gt;&lt;del&gt;FLINK-18241&lt;/del&gt;&lt;/a&gt;, it seems I cannot re-activate the RocksDB log that we disabled in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15068&quot; title=&quot;Disable RocksDB&amp;#39;s local LOG by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15068&quot;&gt;&lt;del&gt;FLINK-15068&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15747&quot; title=&quot;Enable setting RocksDB log level from configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15747&quot;&gt;&lt;del&gt;FLINK-15747&lt;/del&gt;&lt;/a&gt; was aiming at changing that particular configuration, but the problem seems broader since&#160;&lt;tt&gt;setDbLogDir()&lt;/tt&gt; was actually also ignored and Flink itself does not change that setting.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13310627">FLINK-18242</key>
            <summary>Custom OptionsFactory settings seem to have no effect on RocksDB</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="liyu">Yu Li</assignee>
                                    <reporter username="nkruber">Nico Kruber</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 10 Jun 2020 11:25:42 +0000</created>
                <updated>Sun, 21 Jun 2020 04:59:56 +0000</updated>
                            <resolved>Sun, 21 Jun 2020 04:59:55 +0000</resolved>
                                    <version>1.10.0</version>
                    <version>1.10.1</version>
                    <version>1.11.0</version>
                                    <fixVersion>1.10.2</fixVersion>
                    <fixVersion>1.11.0</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17132880" author="yunta" created="Thu, 11 Jun 2020 03:28:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=NicoK&quot; class=&quot;user-hover&quot; rel=&quot;NicoK&quot;&gt;NicoK&lt;/a&gt; The root cause is current &lt;tt&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/88cc44afbfb5267e2674ecb735561365e735d2b0/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBResourceContainer.java#L90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RocksDBResourceContainer&lt;/a&gt;&lt;/tt&gt; would only deal with new interface &lt;tt&gt;DefaultConfigurableOptionsFactory#createDBOptions(DBOptions currentOptions, Collection&amp;lt;AutoCloseable&amp;gt; handlesToClose)&lt;/tt&gt;.&lt;br/&gt;
As you only override the deprecated interface, that&apos;s why the new options not take effect.&lt;/p&gt;

&lt;p&gt;I think this bug would only occur if user extends &lt;tt&gt;DefaultConfigurableOptionsFactory&lt;/tt&gt; as we migrate &lt;tt&gt;DefaultConfigurableOptionsFactory&lt;/tt&gt; to new &lt;tt&gt;RocksDBOptionsFactory&lt;/tt&gt; but still keep previous interfaces. Not sure whether extending &lt;tt&gt;DefaultConfigurableOptionsFactory&lt;/tt&gt; has been &#8216;abused&#8217; among users.&lt;/p&gt;</comment>
                            <comment id="17132910" author="carp84" created="Thu, 11 Jun 2020 04:37:27 +0000"  >&lt;p&gt;Thanks for the analysis &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, but you may have neglected below code path in `RocksDBStateBackend#setOptions`:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setOptions(OptionsFactory optionsFactory) {
		&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.rocksDbOptionsFactory = optionsFactory &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RocksDBOptionsFactory
				? (RocksDBOptionsFactory) optionsFactory
				: &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RocksDBOptionsFactoryAdapter(optionsFactory);
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While in `RocksDBOptionsFactoryAdaptor` we have below method:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DBOptions createDBOptions(DBOptions currentOptions, Collection&amp;lt;AutoCloseable&amp;gt; handlesToClose) {
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; optionsFactory.createDBOptions(currentOptions);
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please notice that we also have below instructions in `RocksDBOptionsFactory` javadoc:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	/**
	 * Do not override these methods, they are only to maintain &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; compatibility with
	 * prior versions. They will be removed in one of the next versions.
	 */
	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; DBOptions createDBOptions(DBOptions currentOptions) {
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; createDBOptions(currentOptions, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;());
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And since the usage mentioned in description here actually breaks the above rule, IMHO it&apos;s a user error.&lt;/p&gt;

&lt;p&gt;However, we should take some actions to prevent this from happening again, possible ones including:&lt;br/&gt;
1. Make `DefaultConfigurableOptionsFactory` a final class. This may break the compilation of existing application code, but it&apos;s way better than having the problem mentioned here.&lt;br/&gt;
2. Write more explicit notice and suggestions in our documentation.&lt;/p&gt;</comment>
                            <comment id="17133134" author="nicok" created="Thu, 11 Jun 2020 10:25:59 +0000"  >&lt;p&gt;Thanks for the analysis - after changing to the new interface, the options factory did indeed work as expected.&lt;/p&gt;

&lt;p&gt;It seems that I got into this situation by compiling against Flink 1.9 and executing in 1.10: Since I did not bundle the&#160;&lt;tt&gt;DefaultOptionsFactory&lt;/tt&gt; class from 1.9, at runtime Flink would only see the 1.10 file and interfaces and thus missed my &lt;tt&gt;createDBOptions(DBOptions currentOptions)&lt;/tt&gt;. Changing to compile against 1.10 did not help me noticing the interface change since the old code was still valid.&lt;/p&gt;

&lt;p&gt;IMHO, this silent API change may be a problem (for some users): since there are new getters/setters for the new &lt;tt&gt;RocksDBOptionsFactory&lt;/tt&gt; and there is the &lt;tt&gt;RocksDBOptionsFactoryAdapter&lt;/tt&gt;, it would not have to inherit from &lt;tt&gt;OptionsFactory&lt;/tt&gt; to keep backwards compatibility. This may be a different story for &lt;tt&gt;DefaultOptionsFactory&lt;/tt&gt; (which may have needed both interfaces and then special handling, or a &lt;tt&gt;final createDBOptions(DBOptions currentOptions)&lt;/tt&gt;, or just live with the API change) but neither of the mentioned classes has an API annotation, not even &lt;tt&gt;@PublicEvolving&lt;/tt&gt;.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;I would be against making &lt;tt&gt;DefaultConfigurableOptionsFactory&lt;/tt&gt; final as this does not solve anything and the class may actually be useful if you can tune parameters via the cluster config and only need some additional manual settings that are not exposed via config.&lt;/li&gt;
	&lt;li&gt;just adding more documentation would probably not have helped here, at least not for old code&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17133170" author="carp84" created="Thu, 11 Jun 2020 11:18:47 +0000"  >&lt;p&gt;I agree that making `DefaultConfigurableOptionsFactory` final is not a thorough solution. After a second thought, we should consider completely separating `RocksDBOptionsFactory` and `OptionsFactory`. The only problem would be how to make `RocksDBStateBackend#setOptions` backward compatible (accepting an `OptionsFactory` and assign to a `RocksDBOptionsFactory` variable) - I think another &lt;tt&gt;OptionsFactory-&amp;gt;RocksDBOptionsFactory&lt;/tt&gt; adapter could make it work.&lt;/p&gt;

&lt;p&gt;Let me prepare a PR to better Illustrate the idea.&lt;/p&gt;</comment>
                            <comment id="17135986" author="stephanewen" created="Mon, 15 Jun 2020 16:12:31 +0000"  >&lt;p&gt;I see this is a thing we need to fix in 1.10.x.&lt;/p&gt;

&lt;p&gt;For 1.11 / 1.12 what do you think about dropping the &lt;tt&gt;OptionsFactory&lt;/tt&gt; and only go ahead with the &lt;tt&gt;RocksDBOptionsFactory&lt;/tt&gt;?&lt;br/&gt;
That would be less confusing for the users and we had the &lt;tt&gt;OptionsFactory&lt;/tt&gt; deprecated in the previous release.&lt;/p&gt;</comment>
                            <comment id="17136294" author="carp84" created="Tue, 16 Jun 2020 04:37:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;For 1.11 / 1.12 what do you think about dropping the OptionsFactory and only go ahead with the RocksDBOptionsFactory?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1, let me prepare the PRs separately.&lt;/p&gt;</comment>
                            <comment id="17138459" author="carp84" created="Wed, 17 Jun 2020 14:03:11 +0000"  >&lt;p&gt;Merged into master via 5ed371fb17ee842240dbb886bf5fdefab6d9db62&lt;/p&gt;</comment>
                            <comment id="17138946" author="carp84" created="Thu, 18 Jun 2020 01:48:43 +0000"  >&lt;p&gt;Merged into release-1.11 via e13146f80114266aa34c9fe9f3dc27e87f7a7649&lt;/p&gt;</comment>
                            <comment id="17141294" author="carp84" created="Sun, 21 Jun 2020 04:59:56 +0000"  >&lt;p&gt;Merged into release-1.10 via fd91affd8040123e2f757b24859b7dad33e09532&lt;/p&gt;

&lt;p&gt;Closing the JIRA since all work done.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13005362" name="DefaultConfigurableOptionsFactoryWithLog.java" size="966" author="nkruber" created="Wed, 10 Jun 2020 11:18:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 21 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fpmo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>After &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18242&quot; title=&quot;Custom OptionsFactory settings seem to have no effect on RocksDB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18242&quot;&gt;&lt;strike&gt;FLINK-18242&lt;/strike&gt;&lt;/a&gt;, the deprecated `OptionsFactory` and `ConfigurableOptionsFactory` classes are removed (not applicable for release-1.10), please use `RocksDBOptionsFactory` and `ConfigurableRocksDBOptionsFactory` instead. Please also recompile your application codes if any class extending `DefaultConfigurableOptionsFactory`.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>