<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8086] FlinkKafkaProducer011 can permanently fail in recovery through ProducerFencedException</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8086</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Chaos monkey test in a cluster environment can permanently bring down our FlinkKafkaProducer011.&lt;/p&gt;

&lt;p&gt;Typically, after a small number of randomly killed TMs, the data generator job is no longer able to recover from a checkpoint because of the following problem:&lt;/p&gt;

&lt;p&gt;org.apache.kafka.common.errors.ProducerFencedException: Producer attempted an operation with an old epoch. Either there is a newer producer with the same transactionalId, or the producer&apos;s transaction has been expired by the broker.&lt;/p&gt;

&lt;p&gt;The problem is reproduceable and happened for me in every run after the chaos monkey killed a couple of TMs.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13118565">FLINK-8086</key>
            <summary>FlinkKafkaProducer011 can permanently fail in recovery through ProducerFencedException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="srichter">Stefan Richter</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Nov 2017 14:50:03 +0000</created>
                <updated>Mon, 20 Nov 2017 12:37:46 +0000</updated>
                            <resolved>Mon, 20 Nov 2017 12:34:34 +0000</resolved>
                                    <version>1.4.0</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16256977" author="githubbot" created="Fri, 17 Nov 2017 13:48:02 +0000"  >&lt;p&gt;GitHub user pnowojski opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5030&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5030&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8086&quot; title=&quot;FlinkKafkaProducer011 can permanently fail in recovery through ProducerFencedException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8086&quot;&gt;&lt;del&gt;FLINK-8086&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Ignore ProducerFencedException&lt;/p&gt;

&lt;p&gt;        ProducerFencedException can happen if we restore twice from the same checkpoint&lt;br/&gt;
        or if we restore from an old savepoint. In both cases transactional.ids that we&lt;br/&gt;
        want to recoverAndCommit have been already committed and reused. Reusing mean&lt;br/&gt;
        that they will be known by Kafka&apos;s brokers under newer producerId/epochId,&lt;br/&gt;
        which will result in ProducerFencedException if we try to commit again some&lt;br/&gt;
        old (and already committed) transaction.&lt;/p&gt;

&lt;p&gt;        Ignoring this exception might hide some bugs/issues, because instead of failing&lt;br/&gt;
        we might have a semi silent (with a warning) data loss.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change added a `testFailAndRecoverSameCheckpointTwice` for a scenario that was previously not tested (and was failing).&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/pnowojski/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pnowojski/flink&lt;/a&gt; f8086&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5030.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5030.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5030&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d4542339e39adeff69cf18a647c8a5ac0d97969e&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-17T13:31:07Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Improve logging in FlinkKafkaProducer011&lt;/p&gt;

&lt;p&gt;commit 642ba6d0c3e204824f1ff69412d70918be9e3ac7&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-17T13:40:30Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8086&quot; title=&quot;FlinkKafkaProducer011 can permanently fail in recovery through ProducerFencedException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8086&quot;&gt;&lt;del&gt;FLINK-8086&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; Ignore ProducerFencedException during recovery&lt;/p&gt;

&lt;p&gt;    ProducerFencedException can happen if we restore twice from the same checkpoint&lt;br/&gt;
    or if we restore from an old savepoint. In both cases transactional.ids that we&lt;br/&gt;
    want to recoverAndCommit have been already committed and reused. Reusing mean&lt;br/&gt;
    that they will be known by Kafka&apos;s brokers under newer producerId/epochId,&lt;br/&gt;
    which will result in ProducerFencedException if we try to commit again some&lt;br/&gt;
    old (and already committed) transaction.&lt;/p&gt;

&lt;p&gt;    Ignoring this exception might hide some bugs/issues, because instead of failing&lt;br/&gt;
    we might have a semi silent (with a warning) data loss.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16259003" author="githubbot" created="Mon, 20 Nov 2017 09:29:09 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5030#discussion_r151938425&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5030#discussion_r151938425&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java &amp;#8212;&lt;br/&gt;
    @@ -720,11 +719,10 @@ protected void abort(KafkaTransactionState transaction) {&lt;br/&gt;
     	protected void recoverAndAbort(KafkaTransactionState transaction) {&lt;br/&gt;
     		switch (semantic) {&lt;br/&gt;
     			case EXACTLY_ONCE:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FlinkKafkaProducer&amp;lt;byte[], byte[]&amp;gt; producer =&lt;/li&gt;
	&lt;li&gt;initTransactionalProducer(transaction.transactionalId, false);&lt;/li&gt;
	&lt;li&gt;producer.resumeTransaction(transaction.producerId, transaction.epoch);&lt;/li&gt;
	&lt;li&gt;producer.abortTransaction();&lt;/li&gt;
	&lt;li&gt;producer.close();&lt;br/&gt;
    +				try (FlinkKafkaProducer&amp;lt;byte[], byte[]&amp;gt; producer =&lt;br/&gt;
    +						initTransactionalProducer(transaction.transactionalId, false)) {&lt;br/&gt;
    +					producer.initTransactions();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    why is this changed from&lt;br/&gt;
    ```&lt;br/&gt;
    resumeTransaction()&lt;br/&gt;
    abortTransaction()&lt;br/&gt;
    ```&lt;br/&gt;
    to&lt;br/&gt;
    ```&lt;br/&gt;
    initTransaction()&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16259023" author="githubbot" created="Mon, 20 Nov 2017 09:40:17 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5030#discussion_r151940978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5030#discussion_r151940978&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java &amp;#8212;&lt;br/&gt;
    @@ -720,11 +719,10 @@ protected void abort(KafkaTransactionState transaction) {&lt;br/&gt;
     	protected void recoverAndAbort(KafkaTransactionState transaction) {&lt;br/&gt;
     		switch (semantic) {&lt;br/&gt;
     			case EXACTLY_ONCE:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FlinkKafkaProducer&amp;lt;byte[], byte[]&amp;gt; producer =&lt;/li&gt;
	&lt;li&gt;initTransactionalProducer(transaction.transactionalId, false);&lt;/li&gt;
	&lt;li&gt;producer.resumeTransaction(transaction.producerId, transaction.epoch);&lt;/li&gt;
	&lt;li&gt;producer.abortTransaction();&lt;/li&gt;
	&lt;li&gt;producer.close();&lt;br/&gt;
    +				try (FlinkKafkaProducer&amp;lt;byte[], byte[]&amp;gt; producer =&lt;br/&gt;
    +						initTransactionalProducer(transaction.transactionalId, false)) {&lt;br/&gt;
    +					producer.initTransactions();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    `initTransaction()` does the same thing as resuming and aborting previous transactions, but in a safer way, since `resumeTransaction()` is part of our `KafkaProducer`s extension.&lt;/p&gt;</comment>
                            <comment id="16259179" author="githubbot" created="Mon, 20 Nov 2017 12:23:39 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5030#discussion_r151976605&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5030#discussion_r151976605&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kafka-0.11/src/main/java/org/apache/flink/streaming/connectors/kafka/FlinkKafkaProducer011.java &amp;#8212;&lt;br/&gt;
    @@ -720,11 +719,10 @@ protected void abort(KafkaTransactionState transaction) {&lt;br/&gt;
     	protected void recoverAndAbort(KafkaTransactionState transaction) {&lt;br/&gt;
     		switch (semantic) {&lt;br/&gt;
     			case EXACTLY_ONCE:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FlinkKafkaProducer&amp;lt;byte[], byte[]&amp;gt; producer =&lt;/li&gt;
	&lt;li&gt;initTransactionalProducer(transaction.transactionalId, false);&lt;/li&gt;
	&lt;li&gt;producer.resumeTransaction(transaction.producerId, transaction.epoch);&lt;/li&gt;
	&lt;li&gt;producer.abortTransaction();&lt;/li&gt;
	&lt;li&gt;producer.close();&lt;br/&gt;
    +				try (FlinkKafkaProducer&amp;lt;byte[], byte[]&amp;gt; producer =&lt;br/&gt;
    +						initTransactionalProducer(transaction.transactionalId, false)) {&lt;br/&gt;
    +					producer.initTransactions();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I see, thanks! I will merge this now. &#128515; &lt;/p&gt;</comment>
                            <comment id="16259190" author="githubbot" created="Mon, 20 Nov 2017 12:33:37 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5030&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5030&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16259191" author="githubbot" created="Mon, 20 Nov 2017 12:33:38 +0000"  >&lt;p&gt;Github user pnowojski closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5030&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5030&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16259195" author="aljoscha" created="Mon, 20 Nov 2017 12:37:46 +0000"  >&lt;p&gt;Fixed on master in&lt;br/&gt;
d57ebd063bad571d0ea276da5beee18aeb568b50&lt;/p&gt;

&lt;p&gt;Fixed on release-1.4 in&lt;br/&gt;
2f3f8c773d50cca25a0c304c8348ac4db362b136&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mtbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>