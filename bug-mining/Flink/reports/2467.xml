<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9494] Race condition in Dispatcher with concurrent granting and revoking of leaderhship</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9494</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;Dispatcher&lt;/tt&gt; contains a race condition when an instance is granted leadership and then quickly afterwards gets the leadership revoked. The problem is that we don&apos;t check in the recovered jobs future callback that we still have the leadership. This can lead to a corrupted state of the &lt;tt&gt;Dispatcher&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13163442">FLINK-9494</key>
            <summary>Race condition in Dispatcher with concurrent granting and revoking of leaderhship</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Jun 2018 13:42:02 +0000</created>
                <updated>Thu, 14 Jun 2018 16:10:07 +0000</updated>
                            <resolved>Thu, 14 Jun 2018 16:09:57 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.1</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16509684" author="githubbot" created="Tue, 12 Jun 2018 14:23:08 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6155&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6155&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9494&quot; title=&quot;Race condition in Dispatcher with concurrent granting and revoking of leaderhship&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9494&quot;&gt;&lt;del&gt;FLINK-9494&lt;/del&gt;&lt;/a&gt; Fix race condition in Dispatcher with granting and revoking leadership&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    The race condition was caused by the fact that the job recovery is executed outside&lt;br/&gt;
    of the main thread. Only after the recovery finishes, the Dispatcher will set the new&lt;br/&gt;
    fencing token and start the recovered jobs. The problem arose if in between these two&lt;br/&gt;
    operations the Dispatcher gets its leadership revoked. Then it could happen that the&lt;br/&gt;
    Dispatcher tries to run the recovered jobs even though it no longer holds the leadership.&lt;/p&gt;

&lt;p&gt;    The race condition is solved by checking first whether we still hold the leadership which&lt;br/&gt;
    is identified by the given leader session id.&lt;/p&gt;

&lt;p&gt;    This PR is based on #6154.&lt;/p&gt;

&lt;p&gt;    cc @StefanRRichter &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;After recovering the jobs, check whether the leader session is still valid before assigning the fencing token and the starting the recovered jobs&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added `DispatcherHATest`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; fixDispatcherRaceCondition&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6155.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6155.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6155&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 54831c6a07dfcd5691fd732148a7c559514362ec&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-06-12T13:22:50Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Remove Scala dependency from ZooKeeperLeaderElectionTest&lt;/p&gt;

&lt;p&gt;commit e50034088f4d85fe457e7015f162a6f86b1de9e7&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-06-12T12:24:59Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9573&quot; title=&quot;Check for leadership with leader session id&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9573&quot;&gt;&lt;del&gt;FLINK-9573&lt;/del&gt;&lt;/a&gt; Extend LeaderElectionService#hasLeadership to take leader session id&lt;/p&gt;

&lt;p&gt;    The new LeaderElectionService#hasLeadership also takes the leader session id and verifies whether&lt;br/&gt;
    this is the correct leader session id associated with the leadership.&lt;/p&gt;

&lt;p&gt;commit 104b46bd7848cd431afc564f6d3bb364a5257cf9&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-06-12T12:40:13Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Fix checkstyle violations in SingleLeaderElectionService&lt;/p&gt;

&lt;p&gt;commit b5f9ee50dc208b767d56bc74a1705b853b10aa7c&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-06-12T12:26:15Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Make TestingDispatcher and TestingJobManagerRunnerFactory standalone testing classes&lt;/p&gt;

&lt;p&gt;    Refactors the DispatcherTests and moves the TestingDispatcher and the TestingJobManagerRunnerFactory&lt;br/&gt;
    to be top level classes. This makes it easier to reuse them.&lt;/p&gt;

&lt;p&gt;commit 190de76b21c3710d0fcbe5d66018c5853707cc33&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-06-12T12:27:30Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9494&quot; title=&quot;Race condition in Dispatcher with concurrent granting and revoking of leaderhship&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9494&quot;&gt;&lt;del&gt;FLINK-9494&lt;/del&gt;&lt;/a&gt; Fix race condition in Dispatcher with granting and revoking leadership&lt;/p&gt;

&lt;p&gt;    The race condition was caused by the fact that the job recovery is executed outside&lt;br/&gt;
    of the main thread. Only after the recovery finishes, the Dispatcher will set the new&lt;br/&gt;
    fencing token and start the recovered jobs. The problem arose if in between these two&lt;br/&gt;
    operations the Dispatcher gets its leadership revoked. Then it could happen that the&lt;br/&gt;
    Dispatcher tries to run the recovered jobs even though it no longer holds the leadership.&lt;/p&gt;

&lt;p&gt;    The race condition is solved by checking first whether we still hold the leadership which&lt;br/&gt;
    is identified by the given leader session id.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16512143" author="githubbot" created="Thu, 14 Jun 2018 08:20:17 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6155#discussion_r195337102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6155#discussion_r195337102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherHATest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,253 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.dispatcher;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.annotation.VisibleForTesting;&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.api.common.time.Time;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.testutils.OneShotLatch;&lt;br/&gt;
    +import org.apache.flink.runtime.blob.BlobServer;&lt;br/&gt;
    +import org.apache.flink.runtime.blob.VoidBlobStore;&lt;br/&gt;
    +import org.apache.flink.runtime.heartbeat.HeartbeatServices;&lt;br/&gt;
    +import org.apache.flink.runtime.highavailability.HighAvailabilityServices;&lt;br/&gt;
    +import org.apache.flink.runtime.highavailability.TestingHighAvailabilityServices;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobVertex;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.SubmittedJobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.SubmittedJobGraphStore;&lt;br/&gt;
    +import org.apache.flink.runtime.leaderelection.TestingLeaderElectionService;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
    +import org.apache.flink.runtime.resourcemanager.ResourceManagerGateway;&lt;br/&gt;
    +import org.apache.flink.runtime.resourcemanager.utils.TestingResourceManagerGateway;&lt;br/&gt;
    +import org.apache.flink.runtime.rpc.FatalErrorHandler;&lt;br/&gt;
    +import org.apache.flink.runtime.rpc.RpcService;&lt;br/&gt;
    +import org.apache.flink.runtime.rpc.RpcUtils;&lt;br/&gt;
    +import org.apache.flink.runtime.rpc.TestingRpcService;&lt;br/&gt;
    +import org.apache.flink.runtime.util.TestingFatalErrorHandler;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +import org.apache.flink.util.TestLogger;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.AfterClass;&lt;br/&gt;
    +import org.junit.Before;&lt;br/&gt;
    +import org.junit.BeforeClass;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +import java.util.UUID;&lt;br/&gt;
    +import java.util.concurrent.ArrayBlockingQueue;&lt;br/&gt;
    +import java.util.concurrent.BlockingQueue;&lt;br/&gt;
    +import java.util.concurrent.CompletableFuture;&lt;br/&gt;
    +import java.util.concurrent.ExecutionException;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.hamcrest.Matchers.equalTo;&lt;br/&gt;
    +import static org.hamcrest.Matchers.is;&lt;br/&gt;
    +import static org.junit.Assert.assertThat;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests the HA behaviour of the &lt;/p&gt;
{@link Dispatcher}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class DispatcherHATest extends TestLogger {&lt;br/&gt;
    +&lt;br/&gt;
    +	private static final DispatcherId NULL_FENCING_TOKEN = DispatcherId.fromUuid(new UUID(0L, 0L));&lt;br/&gt;
    +&lt;br/&gt;
    +	private static final Time timeout = Time.seconds(10L);&lt;br/&gt;
    +&lt;br/&gt;
    +	private static TestingRpcService rpcService;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TestingFatalErrorHandler testingFatalErrorHandler;&lt;br/&gt;
    +&lt;br/&gt;
    +	@BeforeClass&lt;br/&gt;
    +	public static void setupClass() &lt;/p&gt;
{
    +		rpcService = new TestingRpcService();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setup() &lt;/p&gt;
{
    +		testingFatalErrorHandler = new TestingFatalErrorHandler();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@After&lt;br/&gt;
    +	public void teardown() throws Exception {&lt;br/&gt;
    +		if (testingFatalErrorHandler != null) &lt;/p&gt;
{
    +			testingFatalErrorHandler.rethrowError();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@AfterClass&lt;br/&gt;
    +	public static void teardownClass() throws ExecutionException, InterruptedException {&lt;br/&gt;
    +		if (rpcService != null) &lt;/p&gt;
{
    +			rpcService.stopService().get();
    +			rpcService = null;
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that interleaved granting and revoking of the leadership won&apos;t interfere&lt;br/&gt;
    +	 * with the job recovery and the resulting internal state of the Dispatcher.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testGrantingRevokingLeadership() throws Exception {&lt;br/&gt;
    +&lt;br/&gt;
    +		final Configuration configuration = new Configuration();&lt;br/&gt;
    +		final TestingHighAvailabilityServices highAvailabilityServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    +		final JobGraph nonEmptyJobGraph = createNonEmptyJobGraph();&lt;br/&gt;
    +		final SubmittedJobGraph submittedJobGraph = new SubmittedJobGraph(nonEmptyJobGraph, null);&lt;br/&gt;
    +&lt;br/&gt;
    +		final OneShotLatch enterGetJobIdsLatch = new OneShotLatch();&lt;br/&gt;
    +		final OneShotLatch proceedGetJobIdsLatch = new OneShotLatch();&lt;br/&gt;
    +		highAvailabilityServices.setSubmittedJobGraphStore(new BlockingSubmittedJobGraphStore(submittedJobGraph, enterGetJobIdsLatch, proceedGetJobIdsLatch));&lt;br/&gt;
    +		final TestingLeaderElectionService dispatcherLeaderElectionService = new TestingLeaderElectionService();&lt;br/&gt;
    +		highAvailabilityServices.setDispatcherLeaderElectionService(dispatcherLeaderElectionService);&lt;br/&gt;
    +&lt;br/&gt;
    +		final BlockingQueue&amp;lt;DispatcherId&amp;gt; fencingTokens = new ArrayBlockingQueue&amp;lt;&amp;gt;(2);&lt;br/&gt;
    +&lt;br/&gt;
    +		final HATestingDispatcher dispatcher = new HATestingDispatcher(&lt;br/&gt;
    +			rpcService,&lt;br/&gt;
    +			UUID.randomUUID().toString(),&lt;br/&gt;
    +			configuration,&lt;br/&gt;
    +			highAvailabilityServices,&lt;br/&gt;
    +			new TestingResourceManagerGateway(),&lt;br/&gt;
    +			new BlobServer(configuration, new VoidBlobStore()),&lt;br/&gt;
    +			new HeartbeatServices(1000L, 1000L),&lt;br/&gt;
    +			UnregisteredMetricGroups.createUnregisteredJobManagerMetricGroup(),&lt;br/&gt;
    +			null,&lt;br/&gt;
    +			new MemoryArchivedExecutionGraphStore(),&lt;br/&gt;
    +			new TestingJobManagerRunnerFactory(new CompletableFuture&amp;lt;&amp;gt;(), new CompletableFuture&amp;lt;&amp;gt;()),&lt;br/&gt;
    +			testingFatalErrorHandler,&lt;br/&gt;
    +			fencingTokens);&lt;br/&gt;
    +&lt;br/&gt;
    +		dispatcher.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			final UUID leaderId = UUID.randomUUID();
    +			dispatcherLeaderElectionService.isLeader(leaderId);
    +
    +			dispatcherLeaderElectionService.notLeader();
    +
    +			final DispatcherId firstFencingToken = fencingTokens.take();
    +
    +			assertThat(firstFencingToken, equalTo(NULL_FENCING_TOKEN));
    +
    +			enterGetJobIdsLatch.await();
    +			proceedGetJobIdsLatch.trigger();
    +
    +			assertThat(dispatcher.getNumberJobs(timeout).get(), is(0));
    +
    +		}
&lt;p&gt; finally &lt;/p&gt;
{
    +			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Nonnull&lt;br/&gt;
    +	private JobGraph createNonEmptyJobGraph() &lt;/p&gt;
{
    +		final JobVertex noOpVertex = new JobVertex(&quot;NoOp vertex&quot;);
    +		return new JobGraph(noOpVertex);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private static class HATestingDispatcher extends TestingDispatcher {&lt;br/&gt;
    +&lt;br/&gt;
    +		@Nonnull&lt;br/&gt;
    +		private final BlockingQueue&amp;lt;DispatcherId&amp;gt; fencingTokens;&lt;br/&gt;
    +&lt;br/&gt;
    +		HATestingDispatcher(RpcService rpcService, String endpointId, Configuration configuration, HighAvailabilityServices highAvailabilityServices, ResourceManagerGateway resourceManagerGateway, BlobServer blobServer, HeartbeatServices heartbeatServices, JobManagerMetricGroup jobManagerMetricGroup, @Nullable String metricQueryServicePath, ArchivedExecutionGraphStore archivedExecutionGraphStore, JobManagerRunnerFactory jobManagerRunnerFactory, FatalErrorHandler fatalErrorHandler, @Nonnull BlockingQueue&amp;lt;DispatcherId&amp;gt; fencingTokens) throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I would suggest to introduce some newlines here.&lt;/p&gt;</comment>
                            <comment id="16512196" author="githubbot" created="Thu, 14 Jun 2018 08:58:52 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6155#discussion_r195347814&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6155#discussion_r195347814&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherHATest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,253 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.dispatcher;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.annotation.VisibleForTesting;&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.api.common.time.Time;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.testutils.OneShotLatch;&lt;br/&gt;
    +import org.apache.flink.runtime.blob.BlobServer;&lt;br/&gt;
    +import org.apache.flink.runtime.blob.VoidBlobStore;&lt;br/&gt;
    +import org.apache.flink.runtime.heartbeat.HeartbeatServices;&lt;br/&gt;
    +import org.apache.flink.runtime.highavailability.HighAvailabilityServices;&lt;br/&gt;
    +import org.apache.flink.runtime.highavailability.TestingHighAvailabilityServices;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobVertex;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.SubmittedJobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.SubmittedJobGraphStore;&lt;br/&gt;
    +import org.apache.flink.runtime.leaderelection.TestingLeaderElectionService;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
    +import org.apache.flink.runtime.resourcemanager.ResourceManagerGateway;&lt;br/&gt;
    +import org.apache.flink.runtime.resourcemanager.utils.TestingResourceManagerGateway;&lt;br/&gt;
    +import org.apache.flink.runtime.rpc.FatalErrorHandler;&lt;br/&gt;
    +import org.apache.flink.runtime.rpc.RpcService;&lt;br/&gt;
    +import org.apache.flink.runtime.rpc.RpcUtils;&lt;br/&gt;
    +import org.apache.flink.runtime.rpc.TestingRpcService;&lt;br/&gt;
    +import org.apache.flink.runtime.util.TestingFatalErrorHandler;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +import org.apache.flink.util.TestLogger;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.AfterClass;&lt;br/&gt;
    +import org.junit.Before;&lt;br/&gt;
    +import org.junit.BeforeClass;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +import java.util.UUID;&lt;br/&gt;
    +import java.util.concurrent.ArrayBlockingQueue;&lt;br/&gt;
    +import java.util.concurrent.BlockingQueue;&lt;br/&gt;
    +import java.util.concurrent.CompletableFuture;&lt;br/&gt;
    +import java.util.concurrent.ExecutionException;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.hamcrest.Matchers.equalTo;&lt;br/&gt;
    +import static org.hamcrest.Matchers.is;&lt;br/&gt;
    +import static org.junit.Assert.assertThat;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests the HA behaviour of the &lt;/p&gt;
{@link Dispatcher}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class DispatcherHATest extends TestLogger {&lt;br/&gt;
    +&lt;br/&gt;
    +	private static final DispatcherId NULL_FENCING_TOKEN = DispatcherId.fromUuid(new UUID(0L, 0L));&lt;br/&gt;
    +&lt;br/&gt;
    +	private static final Time timeout = Time.seconds(10L);&lt;br/&gt;
    +&lt;br/&gt;
    +	private static TestingRpcService rpcService;&lt;br/&gt;
    +&lt;br/&gt;
    +	private TestingFatalErrorHandler testingFatalErrorHandler;&lt;br/&gt;
    +&lt;br/&gt;
    +	@BeforeClass&lt;br/&gt;
    +	public static void setupClass() &lt;/p&gt;
{
    +		rpcService = new TestingRpcService();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setup() &lt;/p&gt;
{
    +		testingFatalErrorHandler = new TestingFatalErrorHandler();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@After&lt;br/&gt;
    +	public void teardown() throws Exception {&lt;br/&gt;
    +		if (testingFatalErrorHandler != null) &lt;/p&gt;
{
    +			testingFatalErrorHandler.rethrowError();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@AfterClass&lt;br/&gt;
    +	public static void teardownClass() throws ExecutionException, InterruptedException {&lt;br/&gt;
    +		if (rpcService != null) &lt;/p&gt;
{
    +			rpcService.stopService().get();
    +			rpcService = null;
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that interleaved granting and revoking of the leadership won&apos;t interfere&lt;br/&gt;
    +	 * with the job recovery and the resulting internal state of the Dispatcher.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testGrantingRevokingLeadership() throws Exception {&lt;br/&gt;
    +&lt;br/&gt;
    +		final Configuration configuration = new Configuration();&lt;br/&gt;
    +		final TestingHighAvailabilityServices highAvailabilityServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    +		final JobGraph nonEmptyJobGraph = createNonEmptyJobGraph();&lt;br/&gt;
    +		final SubmittedJobGraph submittedJobGraph = new SubmittedJobGraph(nonEmptyJobGraph, null);&lt;br/&gt;
    +&lt;br/&gt;
    +		final OneShotLatch enterGetJobIdsLatch = new OneShotLatch();&lt;br/&gt;
    +		final OneShotLatch proceedGetJobIdsLatch = new OneShotLatch();&lt;br/&gt;
    +		highAvailabilityServices.setSubmittedJobGraphStore(new BlockingSubmittedJobGraphStore(submittedJobGraph, enterGetJobIdsLatch, proceedGetJobIdsLatch));&lt;br/&gt;
    +		final TestingLeaderElectionService dispatcherLeaderElectionService = new TestingLeaderElectionService();&lt;br/&gt;
    +		highAvailabilityServices.setDispatcherLeaderElectionService(dispatcherLeaderElectionService);&lt;br/&gt;
    +&lt;br/&gt;
    +		final BlockingQueue&amp;lt;DispatcherId&amp;gt; fencingTokens = new ArrayBlockingQueue&amp;lt;&amp;gt;(2);&lt;br/&gt;
    +&lt;br/&gt;
    +		final HATestingDispatcher dispatcher = new HATestingDispatcher(&lt;br/&gt;
    +			rpcService,&lt;br/&gt;
    +			UUID.randomUUID().toString(),&lt;br/&gt;
    +			configuration,&lt;br/&gt;
    +			highAvailabilityServices,&lt;br/&gt;
    +			new TestingResourceManagerGateway(),&lt;br/&gt;
    +			new BlobServer(configuration, new VoidBlobStore()),&lt;br/&gt;
    +			new HeartbeatServices(1000L, 1000L),&lt;br/&gt;
    +			UnregisteredMetricGroups.createUnregisteredJobManagerMetricGroup(),&lt;br/&gt;
    +			null,&lt;br/&gt;
    +			new MemoryArchivedExecutionGraphStore(),&lt;br/&gt;
    +			new TestingJobManagerRunnerFactory(new CompletableFuture&amp;lt;&amp;gt;(), new CompletableFuture&amp;lt;&amp;gt;()),&lt;br/&gt;
    +			testingFatalErrorHandler,&lt;br/&gt;
    +			fencingTokens);&lt;br/&gt;
    +&lt;br/&gt;
    +		dispatcher.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			final UUID leaderId = UUID.randomUUID();
    +			dispatcherLeaderElectionService.isLeader(leaderId);
    +
    +			dispatcherLeaderElectionService.notLeader();
    +
    +			final DispatcherId firstFencingToken = fencingTokens.take();
    +
    +			assertThat(firstFencingToken, equalTo(NULL_FENCING_TOKEN));
    +
    +			enterGetJobIdsLatch.await();
    +			proceedGetJobIdsLatch.trigger();
    +
    +			assertThat(dispatcher.getNumberJobs(timeout).get(), is(0));
    +
    +		}
&lt;p&gt; finally &lt;/p&gt;
{
    +			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Nonnull&lt;br/&gt;
    +	private JobGraph createNonEmptyJobGraph() &lt;/p&gt;
{
    +		final JobVertex noOpVertex = new JobVertex(&quot;NoOp vertex&quot;);
    +		return new JobGraph(noOpVertex);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private static class HATestingDispatcher extends TestingDispatcher {&lt;br/&gt;
    +&lt;br/&gt;
    +		@Nonnull&lt;br/&gt;
    +		private final BlockingQueue&amp;lt;DispatcherId&amp;gt; fencingTokens;&lt;br/&gt;
    +&lt;br/&gt;
    +		HATestingDispatcher(RpcService rpcService, String endpointId, Configuration configuration, HighAvailabilityServices highAvailabilityServices, ResourceManagerGateway resourceManagerGateway, BlobServer blobServer, HeartbeatServices heartbeatServices, JobManagerMetricGroup jobManagerMetricGroup, @Nullable String metricQueryServicePath, ArchivedExecutionGraphStore archivedExecutionGraphStore, JobManagerRunnerFactory jobManagerRunnerFactory, FatalErrorHandler fatalErrorHandler, @Nonnull BlockingQueue&amp;lt;DispatcherId&amp;gt; fencingTokens) throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Sure, will fix it before merging.&lt;/p&gt;</comment>
                            <comment id="16512197" author="githubbot" created="Thu, 14 Jun 2018 08:59:31 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6155&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6155&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    LGTM &#128077; &lt;/p&gt;</comment>
                            <comment id="16512465" author="githubbot" created="Thu, 14 Jun 2018 13:28:25 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6155&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6155&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @StefanRRichter. Merging this PR.&lt;/p&gt;</comment>
                            <comment id="16512685" author="till.rohrmann" created="Thu, 14 Jun 2018 16:09:57 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
1.6.0: 7e51b90d909c6feaac6ed48140df00372e95a45c&lt;br/&gt;
1.5.1: a9787d7fb616d231007b7c82e2f5f526370eddf8&lt;/p&gt;</comment>
                            <comment id="16512686" author="githubbot" created="Thu, 14 Jun 2018 16:10:07 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6155&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6155&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13165576">FLINK-9573</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3uenb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>