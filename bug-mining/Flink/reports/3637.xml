<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:43:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-15488] Cannot start a taskmanger if using logback</title>
                <link>https://issues.apache.org/jira/browse/FLINK-15488</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When using logback it is not possible to start the taskmanager using &lt;tt&gt;taskamanger.sh&lt;/tt&gt; scripts. The same problem (probably) occurs when using slf4j that logs into the console.&lt;/p&gt;

&lt;p&gt;The problem is that when calculating memory configuration with &lt;tt&gt;BashJavaUtils&lt;/tt&gt; class the result is returned through standard output. If something is logged into the console it may result in undefined behavior such as e.g. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error: Could not find or load main &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;13:51:23.961
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13277699">FLINK-15488</key>
            <summary>Cannot start a taskmanger if using logback</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guoyangze">Yangze Guo</assignee>
                                    <reporter username="dwysakowicz">Dawid Wysakowicz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 6 Jan 2020 12:52:29 +0000</created>
                <updated>Mon, 13 Jan 2020 09:44:25 +0000</updated>
                            <resolved>Mon, 13 Jan 2020 09:44:25 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.0</fixVersion>
                                    <component>API / Core</component>
                    <component>Deployment / Scripts</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17008897" author="gjy" created="Mon, 6 Jan 2020 14:16:13 +0000"  >&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xintongsong&quot; class=&quot;user-hover&quot; rel=&quot;xintongsong&quot;&gt;xintongsong&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17009331" author="xintongsong" created="Tue, 7 Jan 2020 03:12:47 +0000"  >&lt;p&gt;Thanks for reporting this issue, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;. This is indeed a design defect.&lt;/p&gt;

&lt;p&gt;I think the simplest solution might be &lt;tt&gt;BashJavaUtils&lt;/tt&gt; output the result with a specific key or pattern, so that {{taskmanager.sh} can find result among other potential outputs.&lt;/p&gt;

&lt;p&gt;Or we can write the results into a temporal file. This is safer but a bit more complicate. We need to have unique per-TM file paths to avoid potential conflicts between multiple TMs, and also handle the file clean-ups&lt;/p&gt;

&lt;p&gt;I think the first approach might be good enough. WDYT? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17009568" author="fly_in_gis" created="Tue, 7 Jan 2020 09:51:40 +0000"  >&lt;p&gt;I think using a fixed pattern to extract the wanted information makes sense to me. It is more&#160;straightforward.&lt;/p&gt;

&lt;p&gt;Maybe we could add an argument &lt;tt&gt;--disable-logging&lt;/tt&gt;&#160;to the &lt;tt&gt;BashJavaUtils&lt;/tt&gt;. The new added arg is used to disable all the logs so that the stdout is cleaner.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Logger.getRootLogger().setLevel(Level.OFF);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17009572" author="karmagyz" created="Tue, 7 Jan 2020 09:55:42 +0000"  >&lt;p&gt;Disable logging makes sense to me. Actually, it&apos;s a bit odd to allow logging in this utility class.&lt;/p&gt;</comment>
                            <comment id="17009620" author="gjy" created="Tue, 7 Jan 2020 11:03:35 +0000"  >&lt;p&gt;Does anyone understand why the string &lt;em&gt;&quot;Could not find or load main class&quot;&lt;/em&gt; is logged in the first place? Why is this logged to stdout and not stderr? Where does the log message originate from?&lt;/p&gt;</comment>
                            <comment id="17009653" author="fly_in_gis" created="Tue, 7 Jan 2020 11:48:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;&#160;We use &lt;tt&gt;org.apache.flink.runtime.util.BashJavaUtils&lt;/tt&gt; to calculate the&#160;ResourceDynamicConfigs and&#160;ResourceJvmParams. When using logback, the configuration logs will show up in the stdout. So the timestamp in the log is wrongly regarded as the class.&#160;&lt;/p&gt;

&lt;p&gt;You could verify this by the following step.&lt;/p&gt;

&lt;p&gt;1. Use&#160;&lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-stable/dev/best_practices.html#use-logback-when-running-flink-on-a-cluster&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;logback&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2. Running the following command&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java -classpath &lt;span class=&quot;code-quote&quot;&gt;&quot;lib/*&quot;&lt;/span&gt; org.apache.flink.runtime.util.BashJavaUtils GET_TM_RESOURCE_JVM_PARAMS --configDir /tmp/flink-release/conf
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3. Then you could get the following output.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
19:35:57.383 [main] INFO org.apache.flink.configuration.GlobalConfiguration - Loading configuration property: jobmanager.rpc.address, localhost
19:35:57.387 [main] INFO org.apache.flink.configuration.GlobalConfiguration - Loading configuration property: jobmanager.rpc.port, 6123
19:35:57.387 [main] INFO org.apache.flink.configuration.GlobalConfiguration - Loading configuration property: jobmanager.heap.size, 1024m
19:35:57.387 [main] INFO org.apache.flink.configuration.GlobalConfiguration - Loading configuration property: taskmanager.memory.process.size, 1024m
19:35:57.388 [main] INFO org.apache.flink.configuration.GlobalConfiguration - Loading configuration property: taskmanager.numberOfTaskSlots, 1
19:35:57.388 [main] INFO org.apache.flink.configuration.GlobalConfiguration - Loading configuration property: parallelism.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;, 1
19:35:57.388 [main] INFO org.apache.flink.configuration.GlobalConfiguration - Loading configuration property: jobmanager.execution.failover-strategy, region
-Xmx268435450 -Xms268435450 -XX:MaxDirectMemorySize=214748366 -XX:MaxMetaspaceSize=134217728
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17009802" author="dawidwys" created="Tue, 7 Jan 2020 14:57:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;&apos;s explanation is on point.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xintongsong&quot; class=&quot;user-hover&quot; rel=&quot;xintongsong&quot;&gt;xintongsong&lt;/a&gt; I think using a regex is very fragile, I would not go that route. I would rather change the utility class to produce a deterministic result and disabling the logging sounds like a sensible solution. Maybe it could also make sense to overwrite the std out to make sure nothing else writes there. Similar to what &lt;tt&gt;org.apache.flink.client.program.OptimizerPlanEnvironment#getPipeline&lt;/tt&gt; does. I don&apos;t have a strong opinion though. &lt;/p&gt;</comment>
                            <comment id="17009803" author="azagrebin" created="Tue, 7 Jan 2020 14:59:06 +0000"  >&lt;p&gt;After offline discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, we think that making the logs of&#160;BashJavaUtils available for the user is important because it operates with initial user configuration and started TM process already gets all calculated values. Ideally, the logs should go into the same place as they configured by user for the JVM process of TM. Whatever approach we take, we should try to ensure that and check if possible. If the logs are outputted to stdout and the program result as well then we could grep the result out by a special marker as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xintongsong&quot; class=&quot;user-hover&quot; rel=&quot;xintongsong&quot;&gt;xintongsong&lt;/a&gt;&#160;suggested but we need also to separate logs (e.g. inverse grep) and forward them to stdout of taskmanager.sh. If it is too complicated we can try the temporary file approach.&lt;/p&gt;

&lt;p&gt;Also, possible error outputs looks muted at the moment. I do not see a reason to do that.&#160;&lt;/p&gt;</comment>
                            <comment id="17010266" author="xintongsong" created="Wed, 8 Jan 2020 02:16:45 +0000"  >&lt;p&gt;I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; that the logs generated during &lt;tt&gt;BashJavaUtils&lt;/tt&gt; should be preserved. Those logs contains information about how memory sizes are calculated from the configurations, and hints of how to fix an improper configuration, which are important to the users. I also agree that if the logs are configured to be outputted to stdout, we should also forward them to stdout of &lt;tt&gt;taskmanager.sh&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The example mentioned by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;, &lt;tt&gt;OptimizerPlanEnvironment#getPipeline&lt;/tt&gt;, inspires me with another approach. If separating logs and &lt;tt&gt;BashJavaUtils&lt;/tt&gt; calculation results with regex is too fragile, maybe we can separate them inside &lt;tt&gt;BashJavaUtils&lt;/tt&gt;, by overwriting the stdout.&lt;/p&gt;

&lt;p&gt;To be specific, we can overwrite stdout to a &lt;tt&gt;ByteArrayOutputStream&lt;/tt&gt; in &lt;tt&gt;BashJavaUtils#main&lt;/tt&gt;, and make &lt;tt&gt;getTmResourceDynamicConfigs&lt;/tt&gt; and &lt;tt&gt;getTmResourceJvmParams&lt;/tt&gt; return string type results. Then we can make sure the calculation result is always outputted in the first or last line (it is already always the last line now but we can make it an explicit contract). If the result is not generated (say an exception is thrown during the calculation), we can use an empty line as a placeholder, and non-zero exit code should be returned so the shell script can learn that the result is invalid by checking the exit code. A &lt;tt&gt;try-catch(Throwable)-finally&lt;/tt&gt; could be used to make sure the cached stdout will be outputted.&lt;/p&gt;</comment>
                            <comment id="17010737" author="azagrebin" created="Wed, 8 Jan 2020 14:51:13 +0000"  >&lt;p&gt;BashJavaUtils&#160;is single-threaded atm. I do not see any reason for the result not to be the last line of stdout. In that case, we can just tail it from the output. We can have a sanity check by prefixing result with some string and assert it in bash to fail fast if this contract breaks.&lt;/p&gt;

&lt;p&gt;For the logs, this looks like another issue which we have to tackle independently. Ideally, it would be nice to preserve&#160;BashJavaUtils logs and make them part of the task manager logs. I have created an issue for that&#160;&lt;a href=&quot;https://jira.apache.org/jira/browse/FLINK-15519&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FLINK-15519&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17010752" author="xintongsong" created="Wed, 8 Jan 2020 15:02:37 +0000"  >&lt;p&gt;I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; that at the moment we can simply rely on the result to be the last line of stdout. We should make the contract explicit in comments. And a sanity check should be helpful for guarding this contract.&lt;/p&gt;</comment>
                            <comment id="17014162" author="gjy" created="Mon, 13 Jan 2020 09:44:25 +0000"  >&lt;p&gt;1.10: 6c886ade7c02840423552025f5d5da535ae40d02&lt;br/&gt;
master: d76f2166396e3758c08851d024e2c23c8a297062&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13278176">FLINK-15519</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 44 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0a7yg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>