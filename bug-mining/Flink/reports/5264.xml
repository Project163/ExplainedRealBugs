<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:55:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20816] NotifyCheckpointAbortedITCase failed due to timeout</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20816</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=152&amp;amp;view=logs&amp;amp;j=0a15d512-44ac-5ba5-97ab-13a5d066c22c&amp;amp;t=634cd701-c189-5dff-24cb-606ed884db87&amp;amp;l=4245&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This build&lt;/a&gt; failed caused by a failing of &lt;tt&gt;NotifyCheckpointAbortedITCase&lt;/tt&gt; due to a timeout.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-12-29T21:48:40.9430511Z [INFO] Running org.apache.flink.test.checkpointing.NotifyCheckpointAbortedITCase
2020-12-29T21:50:28.0087043Z [ERROR] Tests run: 2, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 107.062 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.flink.test.checkpointing.NotifyCheckpointAbortedITCase
2020-12-29T21:50:28.0087961Z [ERROR] testNotifyCheckpointAborted[unalignedCheckpointEnabled =&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;](org.apache.flink.test.checkpointing.NotifyCheckpointAbortedITCase)  Time elapsed: 104.044 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
2020-12-29T21:50:28.0088619Z org.junit.runners.model.TestTimedOutException: test timed out after 100000 milliseconds
2020-12-29T21:50:28.0088972Z 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
2020-12-29T21:50:28.0089267Z 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:502)
2020-12-29T21:50:28.0089633Z 	at org.apache.flink.core.testutils.OneShotLatch.await(OneShotLatch.java:61)
2020-12-29T21:50:28.0090458Z 	at org.apache.flink.test.checkpointing.NotifyCheckpointAbortedITCase.verifyAllOperatorsNotifyAborted(NotifyCheckpointAbortedITCase.java:200)
2020-12-29T21:50:28.0091313Z 	at org.apache.flink.test.checkpointing.NotifyCheckpointAbortedITCase.testNotifyCheckpointAborted(NotifyCheckpointAbortedITCase.java:183)
2020-12-29T21:50:28.0091819Z 	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
2020-12-29T21:50:28.0092199Z 	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
2020-12-29T21:50:28.0092675Z 	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
2020-12-29T21:50:28.0093095Z 	at java.lang.reflect.Method.invoke(Method.java:498)
2020-12-29T21:50:28.0093495Z 	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
2020-12-29T21:50:28.0093980Z 	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
2020-12-29T21:50:28.0094444Z 	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
2020-12-29T21:50:28.0094917Z 	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
2020-12-29T21:50:28.0095663Z 	at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:298)
2020-12-29T21:50:28.0096221Z 	at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:292)
2020-12-29T21:50:28.0096675Z 	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
2020-12-29T21:50:28.0097022Z 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The branch contained changes from &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20594&quot; title=&quot;Remove DefaultExecutionSlotAllocator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20594&quot;&gt;&lt;del&gt;FLINK-20594&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20595&quot; title=&quot;Remove SlotProviderStrategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20595&quot;&gt;&lt;del&gt;FLINK-20595&lt;/del&gt;&lt;/a&gt;. These issues remove code that is not used anymore and should have had only affects on unit tests. &lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=151&amp;amp;view=results&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;The previous build&lt;/a&gt; containing all the changes accept for &lt;a href=&quot;https://github.com/XComp/flink/commit/9c57c37c50733a1f592a4fc5e492b22be80d8279&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;9c57c37&lt;/a&gt; passed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13348417">FLINK-20816</key>
            <summary>NotifyCheckpointAbortedITCase failed due to timeout</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arvid">Arvid Heise</assignee>
                                    <reporter username="mapohl">Matthias Pohl</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Wed, 30 Dec 2020 07:28:21 +0000</created>
                <updated>Tue, 29 Jun 2021 03:03:44 +0000</updated>
                            <resolved>Mon, 12 Apr 2021 18:52:30 +0000</resolved>
                                    <version>1.12.2</version>
                    <version>1.13.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17256599" author="yunta" created="Wed, 30 Dec 2020 16:34:04 +0000"  >&lt;p&gt;After searching in the artifact of &lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=152&amp;amp;view=artifacts&amp;amp;pathAsName=false&amp;amp;type=publishedArtifacts&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;logs-ci_build-tests&lt;/a&gt;, the error is happened with unaligned checkpoint enabled. And happened at line &lt;a href=&quot;https://github.com/apache/flink/blob/55b46d8b8deb2103af4d57dfbd4fc2c0d4d8e948/flink-tests/src/test/java/org/apache/flink/test/checkpointing/NotifyCheckpointAbortedITCase.java#L183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;verifyAllOperatorsNotifyAborted()&lt;/a&gt;&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Verifying whether all operators have been notified of checkpoint-1 aborted.&quot;&lt;/span&gt;);
verifyAllOperatorsNotifyAborted();
log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Verified that all operators have been notified of checkpoint-1 aborted.&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think this might be somehow un-expected as the notification should not be held for 10 seconds, could this problem reproduce locally in your branch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17258063" author="mapohl" created="Mon, 4 Jan 2021 08:29:25 +0000"  >&lt;p&gt;I ran the tests ~3200 times locally without running into that issue. I started &lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=153&amp;amp;view=results&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;another build&lt;/a&gt; on that branch. ...not being confident though about being able to reproduce it.&lt;/p&gt;</comment>
                            <comment id="17258090" author="till.rohrmann" created="Mon, 4 Jan 2021 09:18:05 +0000"  >&lt;p&gt;Have you tried looping this test on AZP &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17258176" author="mapohl" created="Mon, 4 Jan 2021 12:31:11 +0000"  >&lt;p&gt;Thanks for the hint. I committed &lt;a href=&quot;https://github.com/XComp/flink/commit/cdf59dc973ef4e692ba2b9766c3f91c7bca3705d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cdf59dc&lt;/a&gt; looping over the test 2000 times. Let&apos;s see whether the &lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=155&amp;amp;view=results&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;corresponding build&lt;/a&gt; reveals something.&lt;/p&gt;</comment>
                            <comment id="17285103" author="dawidwys" created="Tue, 16 Feb 2021 09:06:12 +0000"  >&lt;p&gt;It failed on 1.12 branch as well: &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=13357&amp;amp;view=logs&amp;amp;j=219e462f-e75e-506c-3671-5017d866ccf6&amp;amp;t=4c5dc768-5c82-5ab0-660d-086cb90b76a0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=13357&amp;amp;view=logs&amp;amp;j=219e462f-e75e-506c-3671-5017d866ccf6&amp;amp;t=4c5dc768-5c82-5ab0-660d-086cb90b76a0&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17299532" author="rmetzger" created="Thu, 11 Mar 2021 12:38:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/rmetzger/Flink/_build/results?buildId=8966&amp;amp;view=logs&amp;amp;j=6e55a443-5252-5db5-c632-109baf464772&amp;amp;t=9df6efca-61d0-513a-97ad-edb76d85786a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/rmetzger/Flink/_build/results?buildId=8966&amp;amp;view=logs&amp;amp;j=6e55a443-5252-5db5-c632-109baf464772&amp;amp;t=9df6efca-61d0-513a-97ad-edb76d85786a&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17305805" author="maguowei" created="Mon, 22 Mar 2021 00:35:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=15083&amp;amp;view=logs&amp;amp;j=34f41360-6c0d-54d3-11a1-0292a2def1d9&amp;amp;t=2d56e022-1ace-542f-bf1a-b37dd63243f2&amp;amp;l=9412&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=15083&amp;amp;view=logs&amp;amp;j=34f41360-6c0d-54d3-11a1-0292a2def1d9&amp;amp;t=2d56e022-1ace-542f-bf1a-b37dd63243f2&amp;amp;l=9412&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17305891" author="maguowei" created="Mon, 22 Mar 2021 05:13:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=15137&amp;amp;view=logs&amp;amp;j=39d5b1d5-3b41-54dc-6458-1e2ddd1cdcf3&amp;amp;t=a99e99c7-21cd-5a1f-7274-585e62b72f56&amp;amp;l=4367&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=15137&amp;amp;view=logs&amp;amp;j=39d5b1d5-3b41-54dc-6458-1e2ddd1cdcf3&amp;amp;t=a99e99c7-21cd-5a1f-7274-585e62b72f56&amp;amp;l=4367&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17309501" author="dawidwys" created="Fri, 26 Mar 2021 15:33:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=15528&amp;amp;view=logs&amp;amp;j=34f41360-6c0d-54d3-11a1-0292a2def1d9&amp;amp;t=2d56e022-1ace-542f-bf1a-b37dd63243f2&amp;amp;l=9680&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=15528&amp;amp;view=logs&amp;amp;j=34f41360-6c0d-54d3-11a1-0292a2def1d9&amp;amp;t=2d56e022-1ace-542f-bf1a-b37dd63243f2&amp;amp;l=9680&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17310891" author="mapohl" created="Mon, 29 Mar 2021 18:27:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=371&amp;amp;view=logs&amp;amp;j=cc649950-03e9-5fae-8326-2f1ad744b536&amp;amp;t=51cab6ca-669f-5dc0-221d-1e4f7dc4fc85&amp;amp;l=9591&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/mapohl/flink/_build/results?buildId=371&amp;amp;view=logs&amp;amp;j=cc649950-03e9-5fae-8326-2f1ad744b536&amp;amp;t=51cab6ca-669f-5dc0-221d-1e4f7dc4fc85&amp;amp;l=9591&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17310915" author="mapohl" created="Mon, 29 Mar 2021 18:51:28 +0000"  >&lt;p&gt;Not sure why I missed that one. But I started a new looped run for the test on &lt;del&gt;&lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=376&amp;amp;view=results&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AzureC #376&lt;/a&gt;&lt;/del&gt; &lt;del&gt;&lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=377&amp;amp;view=results&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AzureCI #377&lt;/a&gt;&lt;/del&gt; &lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=380&amp;amp;view=logs&amp;amp;j=9dc1b5dc-bcfa-5f83-eaa7-0cb181ddc267&amp;amp;t=ab910030-93db-52a7-74a3-34a0addb481b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AzureCI #380&lt;/a&gt; (I had to restart it because I forgot to add the actual test to the Maven command &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_down.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;). Let&apos;s see...&lt;/p&gt;</comment>
                            <comment id="17310923" author="mapohl" created="Mon, 29 Mar 2021 19:02:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=363&amp;amp;view=logs&amp;amp;j=6e55a443-5252-5db5-c632-109baf464772&amp;amp;t=9df6efca-61d0-513a-97ad-edb76d85786a&amp;amp;l=9585&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/mapohl/flink/_build/results?buildId=363&amp;amp;view=logs&amp;amp;j=6e55a443-5252-5db5-c632-109baf464772&amp;amp;t=9df6efca-61d0-513a-97ad-edb76d85786a&amp;amp;l=9585&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17312527" author="mapohl" created="Wed, 31 Mar 2021 16:22:05 +0000"  >&lt;p&gt;I was able to reproduce the timeout on AzureCI. I wasn&apos;t able to pinpoint the reason by diffing the successful and failed run log files. But it looks like in this specific case, the waiting for the abort notification of checkpoint #2 in the DeclineSink does not get triggered. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt; are you able to get anything more out of the logs?&lt;/p&gt;</comment>
                            <comment id="17312831" author="yunta" created="Thu, 1 Apr 2021 03:47:13 +0000"  >&lt;p&gt;From the comparison of success and failure logs, I think the root cause is that&#160;&lt;tt&gt;DeclineSink&lt;/tt&gt; did not execute sync phase of snapshot of checkpoint-2. However, we expect to fail the checkpoint-2 during async phase and that&apos;s why the test timeout as we did not wait for the expect checkpoint failure.&lt;/p&gt;

&lt;p&gt;If we extract all related logs of &lt;tt&gt;DeclineSink&lt;/tt&gt; from failure log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
21:04:19,272 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.runtime.io.network.partition.consumer.ChannelStatePersister [] - found barrier 2, lastSeenBarrier = 1 (COMPLETED) @ InputChannelInfo{gateIdx=0, inputChannelIdx=0}
21:04:19,272 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.streaming.runtime.io.checkpointing.SingleCheckpointBarrierHandler [] - DeclineSink (1/1)#0 (7457bf515844f409738c9929fffc54f7): Received barrier from channel InputChannelInfo{gateIdx=0, inputChannelIdx=0} @ 2.
21:04:19,272 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.runtime.checkpoint.channel.ChannelStateWriterImpl [] - DeclineSink (1/1)#0 starting checkpoint 2 (CheckpointOptions {checkpointType = CHECKPOINT, targetLocation = (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;), isExactlyOnceMode = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, isUnalignedCheckpoint = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, alignmentTimeout = 9223372036854775807})
21:04:19,272 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.runtime.io.network.partition.consumer.ChannelStatePersister [] - startPersisting 2, lastSeenBarrier = 2 (BARRIER_RECEIVED) @ InputChannelInfo{gateIdx=0, inputChannelIdx=0}
21:04:19,272 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.streaming.runtime.io.checkpointing.SingleCheckpointBarrierHandler [] - DeclineSink (1/1)#0 (7457bf515844f409738c9929fffc54f7): Triggering checkpoint 2 on the barrier announcement at 1617138259258.
21:04:19,272 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.StreamTask          [] - Starting checkpoint (2) CHECKPOINT on task DeclineSink (1/1)#0
21:04:19,272 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.runtime.checkpoint.channel.ChannelStateWriterImpl [] - DeclineSink (1/1)#0 finishing output data, checkpoint 2
21:04:19,272 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.runtime.checkpoint.channel.ChannelStateWriterImpl [] - DeclineSink (1/1)#0 requested write result, checkpoint 2
21:04:19,273 [Channel state writer DeclineSink (1/1)#0] DEBUG org.apache.flink.runtime.checkpoint.channel.ChannelStateCheckpointWriter [] - complete output, input completed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
21:05:58,298 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-12] INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - DeclineSink (1/1) (7457bf515844f409738c9929fffc54f7) switched from RUNNING to CANCELING.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since I am not familiar with unaligned checkpoint, I think &lt;tt&gt;Channel state writer DeclineSink&lt;/tt&gt; should wait for input completed as true and then &lt;a href=&quot;https://github.com/apache/flink/blob/04bbf03a0cdb2f455c1b06569dea95ace6fa7e7c/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java#L305-L317&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code below&lt;/a&gt; could execute:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// Step (4): Take the state snapshot. This should be largely asynchronous, to not impact
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// progress of the
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// streaming topology
&lt;/span&gt;
        Map&amp;lt;OperatorID, OperatorSnapshotFutures&amp;gt; snapshotFutures =
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;(operatorChain.getNumberOfOperators());
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (takeSnapshotSync(
                    snapshotFutures, metadata, metrics, options, operatorChain, isRunning)) {
                finishAndReportAsync(snapshotFutures, metadata, metrics, isRunning);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                cleanup(snapshotFutures, metadata, metrics, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Exception(&lt;span class=&quot;code-quote&quot;&gt;&quot;Checkpoint declined&quot;&lt;/span&gt;));
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception ex) {
            cleanup(snapshotFutures, metadata, metrics, ex);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; ex;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="17312934" author="mapohl" created="Thu, 1 Apr 2021 07:19:59 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt; for your analysis. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AHeise&quot; class=&quot;user-hover&quot; rel=&quot;AHeise&quot;&gt;AHeise&lt;/a&gt; could you have a look at this?&lt;/p&gt;</comment>
                            <comment id="17316515" author="arvid" created="Wed, 7 Apr 2021 17:24:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;&apos;s analysis is spot on; there is not much to add as the interesting debug statements are currently not in.&lt;/p&gt;

&lt;p&gt;Interestingly, a line like &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;21:04:11,714 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.runtime.state.SnapshotStrategyRunner        [] - StuckAsyncSnapshotStrategy (FsCheckpointStorageLocation {fileSystem=org.apache.flink.core.fs.SafetyNetWrapperFileSystem@3f0e55b0, checkpointDirectory=file:/tmp/junit7287967740618809656/junit2918432964059421469/663881dcecc7cc89be722ae89e3384ab/chk-2, sharedStateDirectory=file:/tmp/junit7287967740618809656/junit2918432964059421469/663881dcecc7cc89be722ae89e3384ab/shared, taskOwnedStateDirectory=file:/tmp/junit7287967740618809656/junit2918432964059421469/663881dcecc7cc89be722ae89e3384ab/taskowned, metadataFilePath=file:/tmp/junit7287967740618809656/junit2918432964059421469/663881dcecc7cc89be722ae89e3384ab/chk-2/_metadata, reference=(default), fileStateSizeThreshold=20480, writeBufferSize=4096}, synchronous part) in thread Thread[DeclineSink (1/1)#0,5,Flink Task Threads] took 0 ms.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;is missing from the failed log, which indicates that we never successfully execute &lt;tt&gt;SubtaskCheckpointCoordinatorImpl#buildOperatorSnapshotFutures&lt;/tt&gt;. The part of unaligned checkpoint before Yun&apos;s fragment is executed normally, so I don&apos;t immediately see a connection to unaligned checkpoints.&lt;/p&gt;</comment>
                            <comment id="17316519" author="arvid" created="Wed, 7 Apr 2021 17:26:02 +0000"  >&lt;p&gt;Indeed &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=15528&amp;amp;view=logs&amp;amp;j=34f41360-6c0d-54d3-11a1-0292a2def1d9&amp;amp;t=2d56e022-1ace-542f-bf1a-b37dd63243f2&amp;amp;l=9680&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=15528&amp;amp;view=logs&amp;amp;j=34f41360-6c0d-54d3-11a1-0292a2def1d9&amp;amp;t=2d56e022-1ace-542f-bf1a-b37dd63243f2&amp;amp;l=9680&lt;/a&gt; shows that the same occurs for aligned checkpoints.&lt;/p&gt;</comment>
                            <comment id="17317839" author="arvid" created="Fri, 9 Apr 2021 09:59:36 +0000"  >&lt;p&gt;With some more echo debugging, it&apos;s most likely caused by&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;       OperatorSnapshotFutures snapshotInProgress =
                checkpointStreamOperator(
                        op, checkpointMetaData, checkpointOptions, storage, isRunning);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;hanging in the sync phase.&lt;/p&gt;</comment>
                            <comment id="17317847" author="arvid" created="Fri, 9 Apr 2021 10:14:00 +0000"  >&lt;p&gt;That is actually be design of the test&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;            if (context.getCheckpointId() == DECLINE_CHECKPOINT_ID) {
                DeclineSink.waitLatch.await();
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;DeclineSink is not supposed to complete it until the abortion of the first checkpoint is verified.&lt;/p&gt;

&lt;p&gt;However, there is no log statement that indicate that, there is an abortion call happening at all.&lt;br/&gt;
In the attached success.log we have&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;21:04:11,624 [Source: NormalSource (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.SubtaskCheckpointCoordinatorImpl [] - Notification of aborted checkpoint 1 for task Source: NormalSource (1/1)#0
21:04:11,624 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.SubtaskCheckpointCoordinatorImpl [] - Notification of aborted checkpoint 1 for task DeclineSink (1/1)#0
21:04:11,625 [   NormalMap (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.SubtaskCheckpointCoordinatorImpl [] - Notification of aborted checkpoint 1 for task NormalMap (1/1)#0
21:04:11,739 [Source: NormalSource (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.SubtaskCheckpointCoordinatorImpl [] - Notification of aborted checkpoint 2 for task Source: NormalSource (1/1)#0
21:04:11,739 [   NormalMap (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.SubtaskCheckpointCoordinatorImpl [] - Notification of aborted checkpoint 2 for task NormalMap (1/1)#0
21:04:11,739 [ DeclineSink (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.SubtaskCheckpointCoordinatorImpl [] - Notification of aborted checkpoint 2 for task DeclineSink (1/1)#0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;while in failure.log, I can only find&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;21:04:19,260 [Source: NormalSource (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.SubtaskCheckpointCoordinatorImpl [] - Notification of aborted checkpoint 1 for task Source: NormalSource (1/1)#0
21:04:19,268 [   NormalMap (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.SubtaskCheckpointCoordinatorImpl [] - Notification of aborted checkpoint 1 for task NormalMap (1/1)#0
21:05:58,297 [Source: NormalSource (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.SubtaskCheckpointCoordinatorImpl [] - Notification of aborted checkpoint 2 for task Source: NormalSource (1/1)#0
21:05:58,297 [   NormalMap (1/1)#0] DEBUG org.apache.flink.streaming.runtime.tasks.SubtaskCheckpointCoordinatorImpl [] - Notification of aborted checkpoint 2 for task NormalMap (1/1)#0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It might be some race condition, where the &lt;tt&gt;SubtaskCheckpointCoordinatorImpl&lt;/tt&gt; does not know that the &lt;tt&gt;DeclineSink&lt;/tt&gt; is already running.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;21:04:19,037 [flink-akka.actor.default-dispatcher-2] INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - DeclineSink (1/1) (7457bf515844f409738c9929fffc54f7) switched from DEPLOYING to RUNNING.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="17318134" author="arvid" created="Fri, 9 Apr 2021 17:05:24 +0000"  >&lt;p&gt;I found the root cause: the test assumes implicitly that abortion of chk-1 happens before sync phase of chk-2. If abortion is late, the mail that handles the abortion is never executed since the waitLatch blocks the mailbox thread.&lt;/p&gt;

&lt;p&gt;It&apos;s easy to reproduce by adding some sleep into &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    private void CheckpointCoordinator#sendAbortedMessages(
            List&amp;lt;ExecutionVertex&amp;gt; tasksToAbort, long checkpointId, long timeStamp) {
        // send notification of aborted checkpoints asynchronously.
        executor.execute(
                () -&amp;gt; {
                    try {
                        Thread.sleep(1000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17318485" author="arvid" created="Sat, 10 Apr 2021 12:36:46 +0000"  >&lt;p&gt;Downgraded to Major as it&apos;s a test-only issue.&lt;/p&gt;</comment>
                            <comment id="17318490" author="yunta" created="Sat, 10 Apr 2021 13:08:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AHeise&quot; class=&quot;user-hover&quot; rel=&quot;AHeise&quot;&gt;AHeise&lt;/a&gt; Thanks for your troubleshooting and sorry for making this unstable case.&lt;/p&gt;</comment>
                            <comment id="17319664" author="arvid" created="Mon, 12 Apr 2021 18:52:21 +0000"  >&lt;p&gt;Merged into master as fad4874f9866de7d3c2f5fb3a473f4df744c8159 and into 1.12 as a1ee66d9ef9a14414b9c0fee9288a94685740471.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13311753">FLINK-18335</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13023258" name="flink-20816-failure.log" size="231854" author="mapohl" created="Wed, 31 Mar 2021 16:19:57 +0000"/>
                            <attachment id="13023259" name="flink-20816-success.log" size="230935" author="mapohl" created="Wed, 31 Mar 2021 16:19:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 31 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0lxag:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>