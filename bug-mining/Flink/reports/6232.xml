<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:09:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-26016] FileSystemLookupFunction does not produce correct results when hive table uses columnar storage</title>
                <link>https://issues.apache.org/jira/browse/FLINK-26016</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When I use the parquet hive table as the lookup table, there will be some records that cannot be joined. This can be reproduced by adding unit tests to HiveLookupJoinITCase.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-comment&quot;&gt;// create the hive table with columnar storage.
&lt;/span&gt;        tableEnv.executeSql(
                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;create table columnar_table (x string) STORED AS PARQUET &quot;&lt;/span&gt;
                                + &lt;span class=&quot;code-quote&quot;&gt;&quot;tblproperties (&lt;span class=&quot;code-quote&quot;&gt;&apos;%s&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;5min&apos;&lt;/span&gt;)&quot;&lt;/span&gt;,
                        HiveOptions.LOOKUP_JOIN_CACHE_TTL.key()));

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testLookupJoinTableWithColumnarStorage() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-comment&quot;&gt;// constructs test data, as the DEFAULT_SIZE of VectorizedColumnBatch is 2048, we should
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// write as least 2048 records to the test table.
&lt;/span&gt;        List&amp;lt;Row&amp;gt; testData = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;(4096);
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 4096; i++) {
            testData.add(Row.of(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.valueOf(i)));
        }

        &lt;span class=&quot;code-comment&quot;&gt;// constructs test data using values table
&lt;/span&gt;        TableEnvironment batchEnv = HiveTestUtils.createTableEnvInBatchMode(SqlDialect.DEFAULT);
        batchEnv.registerCatalog(hiveCatalog.getName(), hiveCatalog);
        batchEnv.useCatalog(hiveCatalog.getName());
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; dataId = TestValuesTableFactory.registerData(testData);
        batchEnv.executeSql(
                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;create table value_source(x string, p as proctime()) with (&quot;&lt;/span&gt;
                                + &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-quote&quot;&gt;&apos;connector&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;values&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;data-id&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;%s&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;bounded&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt;)&quot;&lt;/span&gt;,
                        dataId));
        batchEnv.executeSql(&lt;span class=&quot;code-quote&quot;&gt;&quot;insert overwrite columnar_table select x from value_source&quot;&lt;/span&gt;).await();
        TableImpl flinkTable =
                (TableImpl)
                        tableEnv.sqlQuery(
                                &lt;span class=&quot;code-quote&quot;&gt;&quot;select t.x as x1, c.x as x2 from value_source t &quot;&lt;/span&gt;
                                        + &lt;span class=&quot;code-quote&quot;&gt;&quot;left join columnar_table &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; system_time as of t.p c &quot;&lt;/span&gt;
                                        + &lt;span class=&quot;code-quote&quot;&gt;&quot;on t.x = c.x where c.x is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
        List&amp;lt;Row&amp;gt; results = CollectionUtil.iteratorToList(flinkTable.execute().collect());
        assertTrue(results.size() == 0);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem may be caused by the following code. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
RowData row;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; ((row = partitionReader.read(reuse)) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
   count++;
   RowData key = extractLookupKey(row);
   List&amp;lt;RowData&amp;gt; rows = cache.computeIfAbsent(key, k -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;());
   rows.add(serializer.copy(row));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;It can be fixed with the following modification&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
RowData row;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; ((row = partitionReader.read(reuse)) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    count++;
    RowData rowData = serializer.copy(row);
    RowData key = extractLookupKey(rowData);
    List&amp;lt;RowData&amp;gt; rows = cache.computeIfAbsent(key, k -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;());
    rows.add(rowData);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13427239">FLINK-26016</key>
            <summary>FileSystemLookupFunction does not produce correct results when hive table uses columnar storage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hackergin">Feng Jin</assignee>
                                    <reporter username="hackergin">Feng Jin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 8 Feb 2022 16:03:48 +0000</created>
                <updated>Mon, 21 Mar 2022 06:06:30 +0000</updated>
                            <resolved>Mon, 21 Mar 2022 06:06:30 +0000</resolved>
                                    <version>1.14.3</version>
                                    <fixVersion>1.14.5</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Connectors / Hive</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17488974" author="hackergin" created="Tue, 8 Feb 2022 16:08:12 +0000"  >&lt;p&gt;&#160;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt; &#160;&lt;/p&gt;</comment>
                            <comment id="17492326" author="hackergin" created="Tue, 15 Feb 2022 02:32:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=MartijnVisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;MartijnVisser&lt;/a&gt; &#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luoyuxia&quot; class=&quot;user-hover&quot; rel=&quot;luoyuxia&quot;&gt;luoyuxia&lt;/a&gt;&#160; Can you help take a look? &#160; &#160;If it&apos;s a bug, I can help fix it&lt;/p&gt;</comment>
                            <comment id="17492332" author="luoyuxia" created="Tue, 15 Feb 2022 03:18:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hackergin&quot; class=&quot;user-hover&quot; rel=&quot;hackergin&quot;&gt;hackergin&lt;/a&gt;Thanks for reporting it. It seems a bug. But I&apos;m a little of confused about the root case. Would you like to explain it a bit more?&lt;/p&gt;</comment>
                            <comment id="17492374" author="hackergin" created="Tue, 15 Feb 2022 05:51:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luoyuxia&quot; class=&quot;user-hover&quot; rel=&quot;luoyuxia&quot;&gt;luoyuxia&lt;/a&gt; &#65292; Thanks for your reply.&#160; I think the root cause is the ColumnarRowData::getString() method. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//&#20195;&#30721;&#21344;&#20301;&#31526;
&lt;/span&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; StringData getString(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; pos) {
Bytes byteArray = vectorizedColumnBatch.getByteArray(rowId, pos);
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; StringData.{_}fromBytes{_}(byteArray.data, byteArray.offset, byteArray.len);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When reading StringData, the data is not copied. And vectorizedColumnBatch is reused when reading different batch. In the lookup join function, the bytes corresponding to the key read first in the cache will be overwritten by the bytes corresponding to the key read later.&lt;/p&gt;</comment>
                            <comment id="17492479" author="luoyuxia" created="Tue, 15 Feb 2022 09:35:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hackergin&quot; class=&quot;user-hover&quot; rel=&quot;hackergin&quot;&gt;hackergin&lt;/a&gt; Thanks, make sense to me. Feel free to open a pr to us, we are glad to review it .&lt;/p&gt;</comment>
                            <comment id="17492949" author="hackergin" created="Wed, 16 Feb 2022 02:03:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luoyuxia&quot; class=&quot;user-hover&quot; rel=&quot;luoyuxia&quot;&gt;luoyuxia&lt;/a&gt; &#160;I have submitted a pr, please take the time to help review the code,&#160; Thanks .&lt;/p&gt;</comment>
                            <comment id="17509616" author="lzljs3620320" created="Mon, 21 Mar 2022 06:06:30 +0000"  >&lt;p&gt;master (1.15): faf9a8a1f6849e3cb0b9e074cc647c9d24915c6a&lt;/p&gt;

&lt;p&gt;release-1.14: a19b44b3932c1799ff837a6ad78595df02a3d5f2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 34 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0zd5k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>