<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:21:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2805] Make user jars available for all job managers to recover</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2805</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;This is a bug in &lt;a href=&quot;https://github.com/apache/flink/pull/1153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1153&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In case of multiple job managers, the user jars need to be accessible by all job managers (including those who arrive later).&lt;/p&gt;

&lt;p&gt;Since #1153 requires the file state backend to be configured, the simplest solution is to make the blob server aware of the configured recovery mode and put/get/delete the user jars from the file state backend as well.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12902084">FLINK-2805</key>
            <summary>Make user jars available for all job managers to recover</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="uce">Ufuk Celebi</assignee>
                                    <reporter username="uce">Ufuk Celebi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Oct 2015 10:08:40 +0000</created>
                <updated>Thu, 28 Feb 2019 14:01:27 +0000</updated>
                            <resolved>Tue, 20 Oct 2015 08:03:42 +0000</resolved>
                                                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14943534" author="githubbot" created="Mon, 5 Oct 2015 15:34:57 +0000"  >&lt;p&gt;GitHub user uce opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2805&quot; title=&quot;Make user jars available for all job managers to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2805&quot;&gt;&lt;del&gt;FLINK-2805&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;blobmanager&amp;#93;&lt;/span&gt; Write JARs to file state backend for recovery&lt;/p&gt;

&lt;p&gt;    This is a follow up to #1153. I&apos;ve taken two changes from #1153 for convenience. Other than that, this is independent.&lt;/p&gt;

&lt;p&gt;    When running the `BlobServer` in `RecoveryMode#ZOOKEEPER`, this will upload the JARs to the configured file system backend (e.g. HDFS). *&lt;b&gt;Important&lt;/b&gt;*: it introduces a hard dependency to have a configured file state backend when running the blob server with recovery. This is in line with #1153.&lt;/p&gt;

&lt;p&gt;    This JAR copying only happens on the server side, e.g. the client uploads to the server and the server uploads it to the state backend. Same when requesting a locally non-existing blob: the client requests from the server and the server downloads if not available and then answers the client.&lt;/p&gt;

&lt;p&gt;    There are other ways to implement this, but this one was minimally invasive and fully circumvents any Akka actor threads for downloading/uploading. A more invasive change could allow to directly interact with the state backend on the client side &lt;span class=&quot;error&quot;&gt;&amp;#91;task manager&amp;#93;&lt;/span&gt; as well. This would spread the load better across the cluster in case of a DFS and save unnecessary network transfers.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/uce/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/uce/flink&lt;/a&gt; hdfs_jars-2805&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1227&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 68a7ac4abab15dc2ef45546de6a94c27129534dc&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-10-05T12:30:46Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2805&quot; title=&quot;Make user jars available for all job managers to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2805&quot;&gt;&lt;del&gt;FLINK-2805&lt;/del&gt;&lt;/a&gt; Apply RecoveryMode and ConfigConstants changes from #1153&lt;/p&gt;

&lt;p&gt;commit 00ea6b02f15f00486c9541af08b8197c41dd94f7&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-10-05T08:05:05Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2805&quot; title=&quot;Make user jars available for all job managers to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2805&quot;&gt;&lt;del&gt;FLINK-2805&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;blobmanager&amp;#93;&lt;/span&gt; Write JARs to file state backend for recovery&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14944722" author="githubbot" created="Tue, 6 Oct 2015 08:48:34 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41238757&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41238757&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/blob/BlobServer.java &amp;#8212;&lt;br/&gt;
    @@ -70,18 +82,65 @@&lt;br/&gt;
     	private final int maxConnections;&lt;/p&gt;

&lt;p&gt;     	/**&lt;br/&gt;
    +	 * Shutdown hook thread to ensure deletion of the storage directory (or &amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt; if&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link RecoveryMode#STANDALONE}
&lt;p&gt;)&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private final Thread shutdownHook;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Instantiates a new BLOB server and binds it to a free network port.&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;@throws IOException&lt;/li&gt;
	&lt;li&gt;thrown if the BLOB server cannot bind to a free network port&lt;br/&gt;
     	 */&lt;br/&gt;
     	public BlobServer(Configuration config) throws IOException {&lt;br/&gt;
    +		checkNotNull(config, &quot;Configuration&quot;);&lt;br/&gt;
    +&lt;br/&gt;
    +		this.recoveryMode = RecoveryMode.fromConfig(config);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		// configure and create the storage directory&lt;br/&gt;
     		String storageDirectory = config.getString(ConfigConstants.BLOB_STORAGE_DIRECTORY_KEY, null);&lt;br/&gt;
     		this.storageDir = BlobUtils.initStorageDirectory(storageDirectory);&lt;br/&gt;
     		LOG.info(&quot;Created BLOB server storage directory {}&quot;, storageDir);&lt;/p&gt;

&lt;p&gt;    +		if (recoveryMode == RecoveryMode.STANDALONE) &lt;/p&gt;
{
    +			recoveryBasePath = null;
    +		}
&lt;p&gt;    +		else {&lt;br/&gt;
    +			// Initialize file state backend for recovery&lt;br/&gt;
    +			String stateBackend = config.getString(ConfigConstants.STATE_BACKEND,&lt;br/&gt;
    +					ConfigConstants.DEFAULT_STATE_BACKEND);&lt;br/&gt;
    +&lt;br/&gt;
    +			if (!stateBackend.toLowerCase().equals(&quot;filesystem&quot;)) &lt;/p&gt;
{
    +				throw new IllegalConfigurationException(String.format(&quot;Illegal state backend &quot; +
    +								&quot;configuration &apos;%s&apos;. Please configure &apos;FILESYSTEM&apos; as state &quot; +
    +								&quot;backend and specify the recovery path via &apos;%s&apos; key.&quot;,
    +						stateBackend, ConfigConstants.STATE_BACKEND_FS_RECOVERY_PATH));
    +			}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Would be imo better to use a `StateBackend` enum value here instead of string equals.&lt;/p&gt;</comment>
                            <comment id="14944727" author="githubbot" created="Tue, 6 Oct 2015 08:50:44 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41238986&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41238986&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/blob/BlobServer.java &amp;#8212;&lt;br/&gt;
    @@ -70,18 +82,65 @@&lt;br/&gt;
     	private final int maxConnections;&lt;/p&gt;

&lt;p&gt;     	/**&lt;br/&gt;
    +	 * Shutdown hook thread to ensure deletion of the storage directory (or &amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt; if&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link RecoveryMode#STANDALONE}
&lt;p&gt;)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    According to the code, this field is not null if `RecoverMode.STANDALONE`&lt;/p&gt;</comment>
                            <comment id="14944729" author="githubbot" created="Tue, 6 Oct 2015 08:51:30 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41239095&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41239095&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/blob/BlobServer.java &amp;#8212;&lt;br/&gt;
    @@ -102,8 +161,13 @@ public BlobServer(Configuration config) throws IOException &lt;/p&gt;
{
     			backlog = ConfigConstants.DEFAULT_BLOB_FETCH_BACKLOG;
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Add shutdown hook to delete storage directory&lt;/li&gt;
	&lt;li&gt;this.shutdownHook = BlobUtils.addShutdownHook(this, LOG);&lt;br/&gt;
    +		if (recoveryMode == RecoveryMode.STANDALONE) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I assume this should be a `!=`?&lt;/p&gt;</comment>
                            <comment id="14944769" author="githubbot" created="Tue, 6 Oct 2015 09:16:12 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41241923&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41241923&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/blob/BlobRecoveryITCase.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,159 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.blob;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.commons.io.FileUtils;&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.configuration.ConfigConstants;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.RecoveryMode;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Before;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.InputStream;&lt;br/&gt;
    +import java.net.InetSocketAddress;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Random;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +&lt;br/&gt;
    +public class BlobRecoveryITCase {&lt;br/&gt;
    +&lt;br/&gt;
    +	private File recoveryDir;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setUp() throws Exception {&lt;br/&gt;
    +		recoveryDir = new File(FileUtils.getTempDirectory(), &quot;BlobRecoveryITCaseDir&quot;);&lt;br/&gt;
    +		if (!recoveryDir.exists() &amp;amp;&amp;amp; !recoveryDir.mkdirs()) &lt;/p&gt;
{
    +			throw new IllegalStateException(&quot;Failed to create temp directory for test&quot;);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@After&lt;br/&gt;
    +	public void cleanUp() throws Exception {&lt;br/&gt;
    +		if (recoveryDir != null) &lt;/p&gt;
{
    +			FileUtils.deleteDirectory(recoveryDir);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that with &lt;/p&gt;
{@link RecoveryMode#ZOOKEEPER}
&lt;p&gt; distributed JARs are recoverable from any&lt;br/&gt;
    +	 * participating BlobServer.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testBlobServerRecovery() throws Exception {&lt;br/&gt;
    +		Random rand = new Random();&lt;br/&gt;
    +&lt;br/&gt;
    +		BlobServer[] server = new BlobServer&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +		InetSocketAddress[] serverAddress = new InetSocketAddress&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +		BlobClient client = null;&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			Configuration config = new Configuration();&lt;br/&gt;
    +			config.setString(ConfigConstants.RECOVERY_MODE, &quot;ZOOKEEPER&quot;);&lt;br/&gt;
    +			config.setString(ConfigConstants.STATE_BACKEND, &quot;FILESYSTEM&quot;);&lt;br/&gt;
    +			config.setString(ConfigConstants.STATE_BACKEND_FS_RECOVERY_PATH, recoveryDir.getPath());&lt;br/&gt;
    +&lt;br/&gt;
    +			for (int i = 0; i &amp;lt; server.length; i++) &lt;/p&gt;
{
    +				server[i] = new BlobServer(config);
    +				serverAddress[i] = new InetSocketAddress(&quot;localhost&quot;, server[i].getPort());
    +			}
&lt;p&gt;    +&lt;br/&gt;
    +			client = new BlobClient(serverAddress&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			// Random data&lt;br/&gt;
    +			byte[] actual = new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;1024&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +			rand.nextBytes(actual);&lt;br/&gt;
    +&lt;br/&gt;
    +			BlobKey[] keys = new BlobKey&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +			// Put data&lt;br/&gt;
    +			keys&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; = client.put(actual); // Request 1&lt;br/&gt;
    +			keys&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; = client.put(actual, 32, 256); // Request 2&lt;br/&gt;
    +&lt;br/&gt;
    +			JobID[] jobId = new JobID[] &lt;/p&gt;
{ new JobID(), new JobID() }
&lt;p&gt;;&lt;br/&gt;
    +			String[] testKey = new String[] &lt;/p&gt;
{ &quot;test-key-1&quot;, &quot;test-key-2&quot; }
&lt;p&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +			client.put(jobId&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, testKey&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, actual); // Request 3&lt;br/&gt;
    +			client.put(jobId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, testKey&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, actual, 32, 256); // Request 4&lt;br/&gt;
    +&lt;br/&gt;
    +			// Close the client and connect to the other server&lt;br/&gt;
    +			client.close();&lt;br/&gt;
    +			client = new BlobClient(serverAddress&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			// Verify request 1&lt;br/&gt;
    +			try (InputStream is = client.get(keys&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;)) {&lt;br/&gt;
    +				byte[] expected = new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;actual.length&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `expected` should be the ground truth and `actual` the value you read.&lt;/p&gt;</comment>
                            <comment id="14944772" author="githubbot" created="Tue, 6 Oct 2015 09:18:37 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41242183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41242183&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/execution/librarycache/BlobLibraryCacheRecoveryITCase.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,174 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.execution.librarycache;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.commons.io.FileUtils;&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.configuration.ConfigConstants;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.runtime.blob.BlobCache;&lt;br/&gt;
    +import org.apache.flink.runtime.blob.BlobClient;&lt;br/&gt;
    +import org.apache.flink.runtime.blob.BlobKey;&lt;br/&gt;
    +import org.apache.flink.runtime.blob.BlobServer;&lt;br/&gt;
    +import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.RecoveryMode;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Before;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.FileInputStream;&lt;br/&gt;
    +import java.net.InetSocketAddress;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.Random;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +&lt;br/&gt;
    +public class BlobLibraryCacheRecoveryITCase {&lt;br/&gt;
    +&lt;br/&gt;
    +	private File recoveryDir;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setUp() throws Exception {&lt;br/&gt;
    +		recoveryDir = new File(FileUtils.getTempDirectory(), &quot;BlobRecoveryITCaseDir&quot;);&lt;br/&gt;
    +		if (!recoveryDir.exists() &amp;amp;&amp;amp; !recoveryDir.mkdirs()) &lt;/p&gt;
{
    +			throw new IllegalStateException(&quot;Failed to create temp directory for test&quot;);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@After&lt;br/&gt;
    +	public void cleanUp() throws Exception {&lt;br/&gt;
    +		if (recoveryDir != null) &lt;/p&gt;
{
    +			FileUtils.deleteDirectory(recoveryDir);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that with &lt;/p&gt;
{@link RecoveryMode#ZOOKEEPER}
&lt;p&gt; distributed JARs are recoverable from any&lt;br/&gt;
    +	 * participating BlobLibraryCacheManager.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testRecoveryRegisterAndDownload() throws Exception {&lt;br/&gt;
    +		Random rand = new Random();&lt;br/&gt;
    +&lt;br/&gt;
    +		BlobServer[] server = new BlobServer&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +		InetSocketAddress[] serverAddress = new InetSocketAddress&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +		BlobLibraryCacheManager[] libServer = new BlobLibraryCacheManager&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +		BlobCache cache = null;&lt;br/&gt;
    +		BlobLibraryCacheManager libCache = null;&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			Configuration config = new Configuration();&lt;br/&gt;
    +			config.setString(ConfigConstants.RECOVERY_MODE, &quot;ZOOKEEPER&quot;);&lt;br/&gt;
    +			config.setString(ConfigConstants.STATE_BACKEND, &quot;FILESYSTEM&quot;);&lt;br/&gt;
    +			config.setString(ConfigConstants.STATE_BACKEND_FS_RECOVERY_PATH, recoveryDir.getPath());&lt;br/&gt;
    +&lt;br/&gt;
    +			for (int i = 0; i &amp;lt; server.length; i++) &lt;/p&gt;
{
    +				server[i] = new BlobServer(config);
    +				serverAddress[i] = new InetSocketAddress(&quot;localhost&quot;, server[i].getPort());
    +				libServer[i] = new BlobLibraryCacheManager(server[i], 3600 * 1000);
    +			}
&lt;p&gt;    +&lt;br/&gt;
    +			// Random data&lt;br/&gt;
    +			byte[] actual = new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;1024&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Same here with `expected` and `actual` confusion.&lt;/p&gt;</comment>
                            <comment id="14944782" author="githubbot" created="Tue, 6 Oct 2015 09:27:33 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41243069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41243069&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/blob/BlobServer.java &amp;#8212;&lt;br/&gt;
    @@ -102,8 +161,13 @@ public BlobServer(Configuration config) throws IOException &lt;/p&gt;
{
     			backlog = ConfigConstants.DEFAULT_BLOB_FETCH_BACKLOG;
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Add shutdown hook to delete storage directory&lt;/li&gt;
	&lt;li&gt;this.shutdownHook = BlobUtils.addShutdownHook(this, LOG);&lt;br/&gt;
    +		if (recoveryMode == RecoveryMode.STANDALONE) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I assume that `==` is correct, but then the JavaDoc is wrong.&lt;/p&gt;</comment>
                            <comment id="14944794" author="githubbot" created="Tue, 6 Oct 2015 09:40:04 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#issuecomment-145799064&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#issuecomment-145799064&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    What happens with the jars on HDFS if the last `BlobServer` dies without properly calling `shutdown`? They will only be removed if a new Flink cluster is started with the same `STATE_BACKEND_FS_RECOVERY_PATH` and shut down properly?&lt;/p&gt;</comment>
                            <comment id="14944815" author="githubbot" created="Tue, 6 Oct 2015 09:56:01 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41245655&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41245655&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/blob/BlobServer.java &amp;#8212;&lt;br/&gt;
    @@ -102,8 +161,13 @@ public BlobServer(Configuration config) throws IOException &lt;/p&gt;
{
     			backlog = ConfigConstants.DEFAULT_BLOB_FETCH_BACKLOG;
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Add shutdown hook to delete storage directory&lt;/li&gt;
	&lt;li&gt;this.shutdownHook = BlobUtils.addShutdownHook(this, LOG);&lt;br/&gt;
    +		if (recoveryMode == RecoveryMode.STANDALONE) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes, sorry the Javadoc is wrong&lt;/p&gt;</comment>
                            <comment id="14944825" author="githubbot" created="Tue, 6 Oct 2015 10:04:16 +0000"  >&lt;p&gt;Github user uce commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#issuecomment-145808965&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#issuecomment-145808965&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Exactly. If the blob server dies, then the job manager will still shutdown the cache service though. This is the same behaviour as in the job manager recovery. Thinking about it, I am wondering myself what we gain by removing the shutdown hook. In case of hard failures (or kill -9) the shutdown hook is not called anyways and for all other cases the job manager will shutdown the components manually anyways. Am I missing something?&lt;/p&gt;</comment>
                            <comment id="14944826" author="githubbot" created="Tue, 6 Oct 2015 10:04:25 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41246319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41246319&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/blob/BlobRecoveryITCase.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,159 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.blob;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.commons.io.FileUtils;&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.configuration.ConfigConstants;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.RecoveryMode;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Before;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.InputStream;&lt;br/&gt;
    +import java.net.InetSocketAddress;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Random;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +&lt;br/&gt;
    +public class BlobRecoveryITCase {&lt;br/&gt;
    +&lt;br/&gt;
    +	private File recoveryDir;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setUp() throws Exception {&lt;br/&gt;
    +		recoveryDir = new File(FileUtils.getTempDirectory(), &quot;BlobRecoveryITCaseDir&quot;);&lt;br/&gt;
    +		if (!recoveryDir.exists() &amp;amp;&amp;amp; !recoveryDir.mkdirs()) &lt;/p&gt;
{
    +			throw new IllegalStateException(&quot;Failed to create temp directory for test&quot;);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@After&lt;br/&gt;
    +	public void cleanUp() throws Exception {&lt;br/&gt;
    +		if (recoveryDir != null) &lt;/p&gt;
{
    +			FileUtils.deleteDirectory(recoveryDir);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that with &lt;/p&gt;
{@link RecoveryMode#ZOOKEEPER}
&lt;p&gt; distributed JARs are recoverable from any&lt;br/&gt;
    +	 * participating BlobServer.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testBlobServerRecovery() throws Exception {&lt;br/&gt;
    +		Random rand = new Random();&lt;br/&gt;
    +&lt;br/&gt;
    +		BlobServer[] server = new BlobServer&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +		InetSocketAddress[] serverAddress = new InetSocketAddress&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +		BlobClient client = null;&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			Configuration config = new Configuration();&lt;br/&gt;
    +			config.setString(ConfigConstants.RECOVERY_MODE, &quot;ZOOKEEPER&quot;);&lt;br/&gt;
    +			config.setString(ConfigConstants.STATE_BACKEND, &quot;FILESYSTEM&quot;);&lt;br/&gt;
    +			config.setString(ConfigConstants.STATE_BACKEND_FS_RECOVERY_PATH, recoveryDir.getPath());&lt;br/&gt;
    +&lt;br/&gt;
    +			for (int i = 0; i &amp;lt; server.length; i++) &lt;/p&gt;
{
    +				server[i] = new BlobServer(config);
    +				serverAddress[i] = new InetSocketAddress(&quot;localhost&quot;, server[i].getPort());
    +			}
&lt;p&gt;    +&lt;br/&gt;
    +			client = new BlobClient(serverAddress&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			// Random data&lt;br/&gt;
    +			byte[] actual = new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;1024&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +			rand.nextBytes(actual);&lt;br/&gt;
    +&lt;br/&gt;
    +			BlobKey[] keys = new BlobKey&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +			// Put data&lt;br/&gt;
    +			keys&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; = client.put(actual); // Request 1&lt;br/&gt;
    +			keys&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; = client.put(actual, 32, 256); // Request 2&lt;br/&gt;
    +&lt;br/&gt;
    +			JobID[] jobId = new JobID[] &lt;/p&gt;
{ new JobID(), new JobID() }
&lt;p&gt;;&lt;br/&gt;
    +			String[] testKey = new String[] &lt;/p&gt;
{ &quot;test-key-1&quot;, &quot;test-key-2&quot; }
&lt;p&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +			client.put(jobId&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, testKey&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, actual); // Request 3&lt;br/&gt;
    +			client.put(jobId&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, testKey&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, actual, 32, 256); // Request 4&lt;br/&gt;
    +&lt;br/&gt;
    +			// Close the client and connect to the other server&lt;br/&gt;
    +			client.close();&lt;br/&gt;
    +			client = new BlobClient(serverAddress&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			// Verify request 1&lt;br/&gt;
    +			try (InputStream is = client.get(keys&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;)) {&lt;br/&gt;
    +				byte[] expected = new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;actual.length&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes, I don&apos;t know what happened there&lt;/p&gt;</comment>
                            <comment id="14944827" author="githubbot" created="Tue, 6 Oct 2015 10:04:42 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41246346&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41246346&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/blob/BlobServer.java &amp;#8212;&lt;br/&gt;
    @@ -70,18 +82,65 @@&lt;br/&gt;
     	private final int maxConnections;&lt;/p&gt;

&lt;p&gt;     	/**&lt;br/&gt;
    +	 * Shutdown hook thread to ensure deletion of the storage directory (or &amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt; if&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link RecoveryMode#STANDALONE}
&lt;p&gt;)&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private final Thread shutdownHook;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Instantiates a new BLOB server and binds it to a free network port.&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;@throws IOException&lt;/li&gt;
	&lt;li&gt;thrown if the BLOB server cannot bind to a free network port&lt;br/&gt;
     	 */&lt;br/&gt;
     	public BlobServer(Configuration config) throws IOException {&lt;br/&gt;
    +		checkNotNull(config, &quot;Configuration&quot;);&lt;br/&gt;
    +&lt;br/&gt;
    +		this.recoveryMode = RecoveryMode.fromConfig(config);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		// configure and create the storage directory&lt;br/&gt;
     		String storageDirectory = config.getString(ConfigConstants.BLOB_STORAGE_DIRECTORY_KEY, null);&lt;br/&gt;
     		this.storageDir = BlobUtils.initStorageDirectory(storageDirectory);&lt;br/&gt;
     		LOG.info(&quot;Created BLOB server storage directory {}&quot;, storageDir);&lt;/p&gt;

&lt;p&gt;    +		if (recoveryMode == RecoveryMode.STANDALONE) &lt;/p&gt;
{
    +			recoveryBasePath = null;
    +		}
&lt;p&gt;    +		else {&lt;br/&gt;
    +			// Initialize file state backend for recovery&lt;br/&gt;
    +			String stateBackend = config.getString(ConfigConstants.STATE_BACKEND,&lt;br/&gt;
    +					ConfigConstants.DEFAULT_STATE_BACKEND);&lt;br/&gt;
    +&lt;br/&gt;
    +			if (!stateBackend.toLowerCase().equals(&quot;filesystem&quot;)) &lt;/p&gt;
{
    +				throw new IllegalConfigurationException(String.format(&quot;Illegal state backend &quot; +
    +								&quot;configuration &apos;%s&apos;. Please configure &apos;FILESYSTEM&apos; as state &quot; +
    +								&quot;backend and specify the recovery path via &apos;%s&apos; key.&quot;,
    +						stateBackend, ConfigConstants.STATE_BACKEND_FS_RECOVERY_PATH));
    +			}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes, same as the job recovery code.&lt;/p&gt;</comment>
                            <comment id="14944835" author="githubbot" created="Tue, 6 Oct 2015 10:09:56 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#issuecomment-145810928&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#issuecomment-145810928&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Good PR @uce. I think the proposal in your description to let the client-side (TMs) 1. check whether they have the file cached, 2. check the filesystem backend and 3. (this case should then never happen in recovery mode) ask the JM, in order to obtain the required Jars would be a good improvement.&lt;/p&gt;

&lt;p&gt;    Currently, I&apos;ve got the feeling that the file state backend is too tightly coupled with the `BlobServer`. IMHO, it would be better to add an abstraction so that the effective backend to distribute the Jars can be easily swapped. &lt;/p&gt;

&lt;p&gt;    Furthermore, I couldn&apos;t find a check whether the user provided `STATE_BACKEND_FS_RECOVERY_PATH` path points actually to a distributed file system and is, thus, accessible by the TMs. Maybe we could add a check which, if false, will give a comprehensive warning.&lt;/p&gt;</comment>
                            <comment id="14944845" author="githubbot" created="Tue, 6 Oct 2015 10:16:07 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#issuecomment-145812243&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#issuecomment-145812243&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think it makes a difference if the JVM is killed with SIGTERM or SIGKILL. In the former case, the shutdown hooks will be executed. I might be that Yarn first sends a SIGTERM signal before SIGKILL in case of a JVM termination which is not intended. But maybe @rmetzger can chime in here.&lt;/p&gt;</comment>
                            <comment id="14945093" author="githubbot" created="Tue, 6 Oct 2015 14:22:07 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41269987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41269987&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/blob/BlobServer.java &amp;#8212;&lt;br/&gt;
    @@ -70,18 +82,65 @@&lt;br/&gt;
     	private final int maxConnections;&lt;/p&gt;

&lt;p&gt;     	/**&lt;br/&gt;
    +	 * Shutdown hook thread to ensure deletion of the storage directory (or &amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt; if&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link RecoveryMode#STANDALONE}
&lt;p&gt;)&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private final Thread shutdownHook;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Instantiates a new BLOB server and binds it to a free network port.&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;@throws IOException&lt;/li&gt;
	&lt;li&gt;thrown if the BLOB server cannot bind to a free network port&lt;br/&gt;
     	 */&lt;br/&gt;
     	public BlobServer(Configuration config) throws IOException {&lt;br/&gt;
    +		checkNotNull(config, &quot;Configuration&quot;);&lt;br/&gt;
    +&lt;br/&gt;
    +		this.recoveryMode = RecoveryMode.fromConfig(config);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		// configure and create the storage directory&lt;br/&gt;
     		String storageDirectory = config.getString(ConfigConstants.BLOB_STORAGE_DIRECTORY_KEY, null);&lt;br/&gt;
     		this.storageDir = BlobUtils.initStorageDirectory(storageDirectory);&lt;br/&gt;
     		LOG.info(&quot;Created BLOB server storage directory {}&quot;, storageDir);&lt;/p&gt;

&lt;p&gt;    +		if (recoveryMode == RecoveryMode.STANDALONE) &lt;/p&gt;
{
    +			recoveryBasePath = null;
    +		}
&lt;p&gt;    +		else {&lt;br/&gt;
    +			// Initialize file state backend for recovery&lt;br/&gt;
    +			String stateBackend = config.getString(ConfigConstants.STATE_BACKEND,&lt;br/&gt;
    +					ConfigConstants.DEFAULT_STATE_BACKEND);&lt;br/&gt;
    +&lt;br/&gt;
    +			if (!stateBackend.toLowerCase().equals(&quot;filesystem&quot;)) &lt;/p&gt;
{
    +				throw new IllegalConfigurationException(String.format(&quot;Illegal state backend &quot; +
    +								&quot;configuration &apos;%s&apos;. Please configure &apos;FILESYSTEM&apos; as state &quot; +
    +								&quot;backend and specify the recovery path via &apos;%s&apos; key.&quot;,
    +						stateBackend, ConfigConstants.STATE_BACKEND_FS_RECOVERY_PATH));
    +			}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    State backend enum is part of the streaming module, which is not a dependency of the runtime atm. I will coordinate with @aljoscha and check what a good place for it is with the streaming rewrite going on.&lt;/p&gt;</comment>
                            <comment id="14945105" author="githubbot" created="Tue, 6 Oct 2015 14:29:07 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#discussion_r41270908&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#discussion_r41270908&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/blob/BlobServer.java &amp;#8212;&lt;br/&gt;
    @@ -70,18 +82,65 @@&lt;br/&gt;
     	private final int maxConnections;&lt;/p&gt;

&lt;p&gt;     	/**&lt;br/&gt;
    +	 * Shutdown hook thread to ensure deletion of the storage directory (or &amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt; if&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link RecoveryMode#STANDALONE}
&lt;p&gt;)&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	private final Thread shutdownHook;&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Instantiates a new BLOB server and binds it to a free network port.&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;@throws IOException&lt;/li&gt;
	&lt;li&gt;thrown if the BLOB server cannot bind to a free network port&lt;br/&gt;
     	 */&lt;br/&gt;
     	public BlobServer(Configuration config) throws IOException {&lt;br/&gt;
    +		checkNotNull(config, &quot;Configuration&quot;);&lt;br/&gt;
    +&lt;br/&gt;
    +		this.recoveryMode = RecoveryMode.fromConfig(config);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		// configure and create the storage directory&lt;br/&gt;
     		String storageDirectory = config.getString(ConfigConstants.BLOB_STORAGE_DIRECTORY_KEY, null);&lt;br/&gt;
     		this.storageDir = BlobUtils.initStorageDirectory(storageDirectory);&lt;br/&gt;
     		LOG.info(&quot;Created BLOB server storage directory {}&quot;, storageDir);&lt;/p&gt;

&lt;p&gt;    +		if (recoveryMode == RecoveryMode.STANDALONE) &lt;/p&gt;
{
    +			recoveryBasePath = null;
    +		}
&lt;p&gt;    +		else {&lt;br/&gt;
    +			// Initialize file state backend for recovery&lt;br/&gt;
    +			String stateBackend = config.getString(ConfigConstants.STATE_BACKEND,&lt;br/&gt;
    +					ConfigConstants.DEFAULT_STATE_BACKEND);&lt;br/&gt;
    +&lt;br/&gt;
    +			if (!stateBackend.toLowerCase().equals(&quot;filesystem&quot;)) &lt;/p&gt;
{
    +				throw new IllegalConfigurationException(String.format(&quot;Illegal state backend &quot; +
    +								&quot;configuration &apos;%s&apos;. Please configure &apos;FILESYSTEM&apos; as state &quot; +
    +								&quot;backend and specify the recovery path via &apos;%s&apos; key.&quot;,
    +						stateBackend, ConfigConstants.STATE_BACKEND_FS_RECOVERY_PATH));
    +			}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You could do it similarly to the `RecoveryMode` enum.&lt;/p&gt;</comment>
                            <comment id="14945116" author="githubbot" created="Tue, 6 Oct 2015 14:36:07 +0000"  >&lt;p&gt;Github user uce commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#issuecomment-145876037&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#issuecomment-145876037&lt;/a&gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It is very tightly coupled in in case of recovery. We won&apos;t loose this, but I agree to introduce an interface to hide this (with a no-op implementation for standalone mode and the filesystem implementation in case of recovery). I fully agree that it&apos;s not a good way to do it, but this is blocking #1153. Is that OK?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There is no check for the provided path. It&apos;s the same behaviour as the configured checkpoint directory `STATE_BACKEND_FS_DIR`. I think the check would have to be performed on the task managers. A check for &quot;file://&quot; does not suffice, because this can also be a DFS. I would open a issue for this and then fix it for the `STATE_BACKEND_FS_DIR` as well.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I&apos;m still undecided about the shutdown hook. It was removed to exactly prevent SIGTERM from removing all recovery data, but the actor postStop will be called after SIGTERM as well and then it will remove it anyways. I think the only advantage (which doesn&apos;t justify it) is for tests.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14950933" author="githubbot" created="Fri, 9 Oct 2015 18:26:18 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227#issuecomment-146954580&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227#issuecomment-146954580&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks good. I will rebase it on the latest state recovery branch and if travis gives green light, then I&apos;ll merge it.&lt;/p&gt;</comment>
                            <comment id="14964747" author="githubbot" created="Tue, 20 Oct 2015 07:59:18 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1227&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14964764" author="till.rohrmann" created="Tue, 20 Oct 2015 08:03:42 +0000"  >&lt;p&gt;Fixed in c3a4d1d&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mj7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>