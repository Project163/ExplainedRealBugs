<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:11:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-28060] Kafka Commit on checkpointing fails repeatedly after a broker restart</title>
                <link>https://issues.apache.org/jira/browse/FLINK-28060</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When Kafka Offset committing is enabled and done on Flinks checkpointing, an error might occur if one Kafka broker is shutdown which might be the leader of that partition in Kafkas internal __consumer_offsets topic.&lt;/p&gt;

&lt;p&gt;This is an expected behaviour. But once the broker is started up again, the next checkpoint issued by flink should commit the meanwhile processed offsets back to kafka. Somehow this does not seem to happen always in Flink 1.15.0 anymore and the offset committing is broken. An warning like the following will be logged on each checkpoint:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[info] 14:33:13.684 WARN  [Source Data Fetcher &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Source: input-kafka-source -&amp;gt; Sink: output-stdout-sink (1/1)#1] o.a.f.c.k.s.reader.KafkaSourceReader - Failed to commit consumer offsets &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; checkpoint 35
[info] org.apache.kafka.clients.consumer.RetriableCommitFailedException: Offset commit failed with a retriable exception. You should retry committing the latest consumed offsets.
[info] Caused by: org.apache.kafka.common.errors.CoordinatorNotAvailableException: The coordinator is not available.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To reproduce this I&apos;ve attached a small flink job program.  To execute this java8, scala sbt and docker / docker-compose is required.  Also see readme.md for more details.&lt;br/&gt;
The job can be run with `sbt run`, kafka cluster is started by `docker-compose up`. If then the kafka brokers are restarted gracefully by e.g. `docker-compose stop kafka1` and `docker-compose start kafka1` with kafka2 and kafka3 afterwards, this warning will occur and no offsets will be committed into kafka.&lt;/p&gt;

&lt;p&gt;This is not reproducible in flink 1.14.4.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Reproduced on MacOS and Linux.&lt;/p&gt;

&lt;p&gt;Using java 8, Flink 1.15.0, Kafka 2.8.1.&lt;/p&gt;</environment>
        <key id="13450052">FLINK-28060</key>
            <summary>Kafka Commit on checkpointing fails repeatedly after a broker restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="Christian.Lorenz77">Christian Lorenz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 14 Jun 2022 15:08:38 +0000</created>
                <updated>Tue, 25 Apr 2023 07:46:09 +0000</updated>
                            <resolved>Wed, 10 Aug 2022 10:14:05 +0000</resolved>
                                    <version>1.15.0</version>
                                    <fixVersion>1.16.0</fixVersion>
                                    <component>API / DataStream</component>
                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>15</watches>
                                                                                                                <comments>
                            <comment id="17554222" author="martijnvisser" created="Tue, 14 Jun 2022 17:42:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt; This seems related to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-27962&quot; title=&quot;KafkaSourceReader fails to commit consumer offsets for checkpoints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-27962&quot;&gt;&lt;del&gt;FLINK-27962&lt;/del&gt;&lt;/a&gt; - Should we raise priority to at least Critical, potential Blocker? Seems like this is a regression. I linked the two tickets together, because they both have value. Probably we should close one of them in the end&lt;/p&gt;</comment>
                            <comment id="17554457" author="renqs" created="Wed, 15 Jun 2022 08:21:42 +0000"  >&lt;p&gt;I did some investigation and strongly suspect that this is caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13563&quot; title=&quot;FindCoordinatorFuture never get cleared in non-group mode( consumer#assign)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-13563&quot;&gt;&lt;del&gt;KAFKA-13563&lt;/del&gt;&lt;/a&gt;. We upgraded the Kafka client from 2.4.1 to 2.8.1 in Flink 1.15, and the bug was introduced in 2.6.2 by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10793&quot; title=&quot;Race condition in FindCoordinatorFuture permanently severs connection to group coordinator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-10793&quot;&gt;&lt;del&gt;KAFKA-10793&lt;/del&gt;&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The patch of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13563&quot; title=&quot;FindCoordinatorFuture never get cleared in non-group mode( consumer#assign)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-13563&quot;&gt;&lt;del&gt;KAFKA-13563&lt;/del&gt;&lt;/a&gt; is applied only on Kafka 3.1 and 3.2, so we have to bump the version as well, or urge Kafka guys to cherry-pick the patch back on 2.x.&#160;&lt;/p&gt;

&lt;p&gt;WDYT? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17554498" author="danderson" created="Wed, 15 Jun 2022 10:13:23 +0000"  >&lt;p&gt;I&apos;d like to include a fix for this in 1.15.1, but I&apos;m not sure about bumping up the Kafka client to 3.x. What are you thinking? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17554530" author="martijnvisser" created="Wed, 15 Jun 2022 11:34:05 +0000"  >&lt;p&gt;I think it depends on the impact of bumping the Kafka Clients dependency. If it&apos;s &quot;just&quot; a dependency update without modifying the actual source code, I would probably be OK with it. If it requires refactoring of the interface, then I would say we can only fix this in Flink 1.16.0. I&apos;ll setup a test CI run to see what happens. &lt;/p&gt;

&lt;p&gt;Looking at the release notes, I do hope that the main reason for going to a new main version was the deprecation of Java 8 and the deprecation of Scala 2.12. If that&apos;s it, I do hope impact will be low. &lt;/p&gt;</comment>
                            <comment id="17554597" author="zentol" created="Wed, 15 Jun 2022 13:24:06 +0000"  >&lt;p&gt;Could someone clarify what this issue means in practice to users? Could we just &lt;em&gt;not&lt;/em&gt; commit the offsets?&lt;/p&gt;

&lt;p&gt;I&apos;m quite wary of doing a major version upgrade, independent of whether we have to adjust our code or not.&lt;br/&gt;
Alternatives include reverting &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24765&quot; title=&quot;Upgrade Kafka dependency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24765&quot;&gt;&lt;del&gt;FLINK-24765&lt;/del&gt;&lt;/a&gt;, or going back to 2.6.1 (i.e., some version that doesn&apos;t have the Kafka bug).&lt;/p&gt;</comment>
                            <comment id="17554609" author="peter.schrott" created="Wed, 15 Jun 2022 13:44:01 +0000"  >&lt;p&gt;From a users perspective I see 2 issues here:&lt;/p&gt;

&lt;p&gt;1) Monitoring / Alerting: We are using consumer offsets / consumer lag to monitor potential issues with the Flink job, also in terms of performance, i.e. the lag gets too large.&lt;/p&gt;

&lt;p&gt;2) StartingOffsets: Flink Kafka connector offers the feature of resuming from committed offsets &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. This feature would be obsolet if offsets are not committed to Kafka (sure, one can always use savepoints when restarting a job)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/connectors/datastream/kafka/#starting-offset&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/connectors/datastream/kafka/#starting-offset&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17554935" author="danderson" created="Thu, 16 Jun 2022 07:07:19 +0000"  >&lt;p&gt;Along the lines of what Chesnay mentioned, what would be the impact of either reverting &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24765&quot; title=&quot;Upgrade Kafka dependency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24765&quot;&gt;&lt;del&gt;FLINK-24765&lt;/del&gt;&lt;/a&gt;, or rolling back the kafka client dependency to something like 2.6.1 (i.e., something newer than 2.4.1 but before the Kafka bug that was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10793&quot; title=&quot;Race condition in FindCoordinatorFuture permanently severs connection to group coordinator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-10793&quot;&gt;&lt;del&gt;KAFKA-10793&lt;/del&gt;&lt;/a&gt; in 2.6.2 and 2.7.1)?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17554941" author="martijnvisser" created="Thu, 16 Jun 2022 07:35:27 +0000"  >&lt;p&gt;I have sincere doubts about reverting &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24765&quot; title=&quot;Upgrade Kafka dependency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24765&quot;&gt;&lt;del&gt;FLINK-24765&lt;/del&gt;&lt;/a&gt;, because more changes has happened since then (like &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25573&quot; title=&quot;Update Kafka Sink to use decomposed interfaces&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25573&quot;&gt;&lt;del&gt;FLINK-25573&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-27487&quot; title=&quot;KafkaMetricWrappers do incorrect cast&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-27487&quot;&gt;&lt;del&gt;FLINK-27487&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-27480&quot; title=&quot;KafkaSources sharing the groupId might lead to InstanceAlreadyExistException warning&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-27480&quot;&gt;&lt;del&gt;FLINK-27480&lt;/del&gt;&lt;/a&gt; and I&apos;m sure I&apos;m missing some more).&lt;/p&gt;

&lt;p&gt;So that probably leaves us with a downgrade of the Kafka Clients dependency or an upgrade of the Kafka Clients dependency? &lt;/p&gt;</comment>
                            <comment id="17554943" author="JIRAUSER290961" created="Thu, 16 Jun 2022 07:40:22 +0000"  >&lt;p&gt;Does someone know if the Kafka Team is aware that this issue exists in 2.8.1? I think Flink might be one of the most prominent usescases of using topic#assign where this is occurring, but for sure this will harm other users as well. The most natural fix for this would be to upgrade to kafka-client 2.8.2 once available. &lt;/p&gt;</comment>
                            <comment id="17554946" author="zentol" created="Thu, 16 Jun 2022 07:54:39 +0000"  >&lt;p&gt;Indeed going back to 2.4.1 doesn&apos;t seem feasible; going back to 2.6.1 at least doesn&apos;t produce compile errors; waiting on CI.&lt;/p&gt;</comment>
                            <comment id="17554949" author="renqs" created="Thu, 16 Jun 2022 08:03:12 +0000"  >&lt;p&gt;Personally I prefer to upgrade the Kafka client. Downgrading the Kafka client could introduce new bugs (like the one fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10793&quot; title=&quot;Race condition in FindCoordinatorFuture permanently severs connection to group coordinator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-10793&quot;&gt;&lt;del&gt;KAFKA-10793&lt;/del&gt;&lt;/a&gt;).&#160;I think the backward compatibility of Kafka is trustable according to our previous experience. On consumer side we don&apos;t use any hacks in Kafka source, purely depend on APIs so I think it should be fine, but for the producer we use &lt;a href=&quot;https://github.com/apache/flink/blob/c9a706b8388b324a37da43298e37074d0a452a34/flink-connectors/flink-connector-kafka/src/main/java/org/apache/flink/connector/kafka/sink/FlinkKafkaInternalProducer.java#L331-L343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reflection&lt;/a&gt; which is concerning. I can have a try to bump the version and see if it works.&#160;&lt;/p&gt;

&lt;p&gt;Any ideas from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="17554952" author="martijnvisser" created="Thu, 16 Jun 2022 08:10:25 +0000"  >&lt;p&gt;I&apos;m waiting for CI to complete a run upgrading to 3.1.1, that&apos;s looking good as well without needing to change any interface/implementation details. &lt;/p&gt;</comment>
                            <comment id="17555057" author="mason6345" created="Thu, 16 Jun 2022 12:29:42 +0000"  >&lt;p&gt;+1 on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peter.schrott&quot; class=&quot;user-hover&quot; rel=&quot;peter.schrott&quot;&gt;peter.schrott&lt;/a&gt; &apos;s assessment&#8211;we need also need this for metrics and in case Flink state is lost or we need to do a migration where it is operationally easier to throwaway Flink state.&lt;/p&gt;

&lt;p&gt;In addition, Flink hasn&apos;t removed support for FlinkKafkaConsumer, right? The group offsets are essential for the migration process to the FLIP 27 Kafka Source since users will have operational issues moving without committed offsets in Kafka.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Christian.Lorenz77&quot; class=&quot;user-hover&quot; rel=&quot;Christian.Lorenz77&quot;&gt;Christian.Lorenz77&lt;/a&gt; I can look at the reproduction code next week. Does the commit eventually succeed? e.g. after the 5th checkpoint, nth checkpoint, etc?&lt;/p&gt;</comment>
                            <comment id="17555058" author="martijnvisser" created="Thu, 16 Jun 2022 12:33:17 +0000"  >&lt;p&gt;&lt;tt&gt;FlinkKafkaConsumer&lt;/tt&gt; has not been removed, but it has been deprecated since 1.14.0 via &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24055&quot; title=&quot;Deprecate FlinkKafkaConsumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24055&quot;&gt;&lt;del&gt;FLINK-24055&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="17555061" author="JIRAUSER290961" created="Thu, 16 Jun 2022 12:37:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mason6345&quot; class=&quot;user-hover&quot; rel=&quot;mason6345&quot;&gt;mason6345&lt;/a&gt; I did not observe that the commit error vanished. To fix the error we currently restart our taskmanagers gracefully. I guess this will implicitly reset the broken kafka consumer state.&lt;/p&gt;</comment>
                            <comment id="17555271" author="martijnvisser" created="Thu, 16 Jun 2022 19:44:23 +0000"  >&lt;p&gt;In my private CI run the upgrade to 3.1.1 was successful (the failing tests are other test stabilities), see &lt;a href=&quot;https://dev.azure.com/martijn0323/Flink/_build/results?buildId=2650&amp;amp;view=results&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/martijn0323/Flink/_build/results?buildId=2650&amp;amp;view=results&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;No interface changes were required. The only thing that would be good to verify is if this the newer version has any change with regards to a minimum version of Kafka protocol or broker.  I looked for it but I think this is not the case based on what I could find&lt;/p&gt;</comment>
                            <comment id="17555303" author="martijnvisser" created="Thu, 16 Jun 2022 21:24:39 +0000"  >&lt;p&gt;I&apos;ve opened a PR against &lt;tt&gt;master&lt;/tt&gt; to bump Kafka Clients there. &lt;/p&gt;

&lt;p&gt;I&apos;ve also opened a draft PR against &lt;tt&gt;release-1.15&lt;/tt&gt; - I&apos;m not sure we&apos;re yet OK with bumping Kafka Clients in a patch release, but I wanted to verify if CI works for this one too. Given the limited change and the arguments brought forward by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt; on possible other bugs that we might re-introduce when we downgrade, I would probably +1 to bump Kafka Clients for Flink 1.15.1&lt;/p&gt;</comment>
                            <comment id="17555527" author="danderson" created="Fri, 17 Jun 2022 10:15:43 +0000"  >&lt;p&gt;It doesn&apos;t seem wise to upgrade the Kafka client from 2.8.1 to 3.1.1 for Flink 1.15.1. That&apos;s a big change to make this close to our release, and we shouldn&apos;t delay this release any further. So here&apos;s a proposal:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We bump the Kafka Clients to 3.1.1 in master now.&lt;/li&gt;
	&lt;li&gt;We don&apos;t try to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-28060&quot; title=&quot;Kafka Commit on checkpointing fails repeatedly after a broker restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-28060&quot;&gt;&lt;del&gt;FLINK-28060&lt;/del&gt;&lt;/a&gt; for 1.15.1.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;We create the Flink 1.15.1 release straight away, noting that there&apos;s a known issue with Kafka (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-28060&quot; title=&quot;Kafka Commit on checkpointing fails repeatedly after a broker restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-28060&quot;&gt;&lt;del&gt;FLINK-28060&lt;/del&gt;&lt;/a&gt;).&lt;/li&gt;
	&lt;li&gt;We reach out to the Kafka community to see if they&apos;re willing to create a 2.8.2 release with this patch.&lt;/li&gt;
	&lt;li&gt;In parallel, we merge the Kafka Clients bump to 3.1.1 after release 1.15.1 is done, to see how it behaves on the CI for the next few weeks and plan a quick Flink 1.15.2 release (most likely something like a month later).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17555558" author="martijnvisser" created="Fri, 17 Jun 2022 11:38:37 +0000"  >&lt;p&gt;+1 for this approach&lt;/p&gt;</comment>
                            <comment id="17555896" author="martijnvisser" created="Sat, 18 Jun 2022 11:03:49 +0000"  >&lt;p&gt;Fixed in master: 189f88485d75821fe285e61bbf6623e88aec24d3&lt;/p&gt;</comment>
                            <comment id="17556320" author="JIRAUSER290961" created="Mon, 20 Jun 2022 10:52:43 +0000"  >&lt;p&gt;I think the according issue in Kafka is &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13840&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-13840&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17557005" author="mason6345" created="Tue, 21 Jun 2022 16:33:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; were we able to reproduce this issue in Flink CI/unit test?&lt;/p&gt;

&lt;p&gt;+1, I think we need to closely monitor &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13840&quot; title=&quot;KafkaConsumer is unable to recover connection to group coordinator after commitOffsetsAsync exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-13840&quot;&gt;&lt;del&gt;KAFKA-13840&lt;/del&gt;&lt;/a&gt;, not sure if bumping to 3.1.1 really fixed the issue. A user states that they still see the issue in the 3.1.1 upgrade.&lt;/p&gt;</comment>
                            <comment id="17557289" author="martijnvisser" created="Wed, 22 Jun 2022 07:13:31 +0000"  >&lt;p&gt;I&apos;m not sure that we have a test for this behaviour. It would actually be nice if we could get one in. &lt;/p&gt;</comment>
                            <comment id="17571628" author="danderson" created="Tue, 26 Jul 2022 21:30:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=renqs&quot; class=&quot;user-hover&quot; rel=&quot;renqs&quot;&gt;renqs&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mason6345&quot; class=&quot;user-hover&quot; rel=&quot;mason6345&quot;&gt;mason6345&lt;/a&gt; Are we any closer to understanding this issue? Do we know how to fix it, either for a 1.15.2 release, or for 1.16.0?&lt;/p&gt;</comment>
                            <comment id="17572197" author="renqs" created="Thu, 28 Jul 2022 02:31:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danderson&quot; class=&quot;user-hover&quot; rel=&quot;danderson&quot;&gt;danderson&lt;/a&gt; The ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13840&quot; title=&quot;KafkaConsumer is unable to recover connection to group coordinator after commitOffsetsAsync exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-13840&quot;&gt;&lt;del&gt;KAFKA-13840&lt;/del&gt;&lt;/a&gt; is still pending for validation. Few things we could do on our side but I&apos;ll try to find some time to validate the patch in Kafka and push it forward.&lt;/p&gt;</comment>
                            <comment id="17574319" author="kyle.stehbens" created="Tue, 2 Aug 2022 16:45:39 +0000"  >&lt;p&gt;Hi, we we&apos;re experiencing this issues and downgraded our kafka client to 2.5.1. There we&apos;re changes to how the group coordinator reconnect logic works in 2.6.0 and later that seems to have broken the recovery of the group co-coordinator and all kafka client version post 2.6.0 (inclusive)&lt;/p&gt;

&lt;p&gt;Downgrading to v2.5.1 of the kafka library is confirmed working for us&lt;/p&gt;</comment>
                            <comment id="17575190" author="showuon" created="Thu, 4 Aug 2022 10:11:25 +0000"  >&lt;p&gt;Could we try to test with Kafka v3.2.1? As mentioned in this comment: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13840?focusedCommentId=17575186&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17575186&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-13840?focusedCommentId=17575186&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17575186&lt;/a&gt; , I believe this issue fix be fixed in Kafka v3.2.1. Thanks.&lt;/p&gt;</comment>
                            <comment id="17577368" author="zentol" created="Tue, 9 Aug 2022 11:45:33 +0000"  >&lt;p&gt;I ran CI with Kafka 3.2.1 and it passed without requiring any other changes.&lt;br/&gt;
&lt;a href=&quot;https://dev.azure.com/chesnay/flink/_build/results?buildId=2944&amp;amp;view=results&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/chesnay/flink/_build/results?buildId=2944&amp;amp;view=results&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We could think about including it in 1.16.0, although I&apos;m not too fond of bumping dependencies so close before the feature freeze. (To be fair though, we would have a few weeks to observe it).&lt;/p&gt;</comment>
                            <comment id="17577675" author="mason6345" created="Wed, 10 Aug 2022 00:05:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; Earlier, I had attempted to write an integration test with testcontainers in an attempt to reproduce the issue by following the steps in the ticket details. I compared the versions kafka-clients 2.8.1 and 3.1.1.&lt;/p&gt;

&lt;p&gt;My test is as follows:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Start Kafka container and create topic&lt;/li&gt;
	&lt;li&gt;Create reader and assign the topics to underlying consumer&lt;/li&gt;
	&lt;li&gt;Fetch and invoke poll()&lt;/li&gt;
	&lt;li&gt;Call commitAsync()&lt;/li&gt;
	&lt;li&gt;Restart Kafka container&#160;&lt;/li&gt;
	&lt;li&gt;Call commitAsync()&lt;/li&gt;
	&lt;li&gt;Call commitAsync()&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;For 2.8.1, there are 2 failures in the commit async call in step 6 and 7. For 3.1.1, there is only 1 failure at step 6.&lt;/p&gt;

&lt;p&gt;3.1.1 seems to be the desired behavior. Some concerns:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;However, unusually, step 4 will fail if the test doesn&apos;t invoke poll regardless of the kafka clients version. I think it is possible for Flink to have a race condition where commitAsync is executed before poll (short checkpoint interval causing commitAsync before poll if topic partitions take long to assign). Is this behavior intended?&lt;/li&gt;
	&lt;li&gt;Otherwise, do you have any recommendations for reproducing the issue in a CI environment where we do not assume poll() is invoked?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17577679" author="showuon" created="Wed, 10 Aug 2022 00:16:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mason6345&quot; class=&quot;user-hover&quot; rel=&quot;mason6345&quot;&gt;mason6345&lt;/a&gt; , yes, Kafka v3.1.1 assumes consumer poll ran before commitAsync call. But in Kafka v3.2.1, this assumption is removed. So, in v3.2.1, even if commitAsync calls earlier than poll, it&apos;ll work well.&lt;/p&gt;

&lt;p&gt;So, for your question:&lt;/p&gt;

&lt;p&gt;1. However, unusually, step 4 will fail if the test doesn&apos;t invoke poll regardless of the kafka clients version. I think it is possible for Flink to have a race condition where commitAsync is executed before poll (short checkpoint interval causing commitAsync before poll if topic partitions take long to assign). Is this behavior intended?&lt;/p&gt;

&lt;p&gt;--&amp;gt; Yes, Kafka should not assume poll calls first or commitAsync calls first. That&apos;s a bug fixed in Kafka v3.2.1&lt;/p&gt;

&lt;p&gt;2. Otherwise, do you have any recommendations for reproducing the issue in a CI environment where we do not assume poll() is invoked?&lt;/p&gt;

&lt;p&gt;--&amp;gt; I think it&apos;s good. I also use the reproducer in this ticket with Kafka v3.2.1, and also investigate Kafka client logs, I confirmed it works well even if commitAsync calls earlier than poll.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="17577900" author="zentol" created="Wed, 10 Aug 2022 10:14:05 +0000"  >&lt;p&gt;master: bc9b401ed1f2e7257c7b44c9838e34ede9c52ed5&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13449081">FLINK-27962</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13449081">FLINK-27962</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13045068" name="flink-kafka-testjob.zip" size="10151" author="Christian.Lorenz77" created="Tue, 14 Jun 2022 15:01:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 13 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z138e0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>The Kafka Client version has been updated to 3.2.1. </customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>