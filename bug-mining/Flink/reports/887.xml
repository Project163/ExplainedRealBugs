<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:23:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-3396] Job submission Savepoint restore logic flawed</title>
                <link>https://issues.apache.org/jira/browse/FLINK-3396</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When savepoint restoring fails, the thrown Exception fails the execution graph, but the client is not informed about the failure.&lt;/p&gt;

&lt;p&gt;The expected behaviour is that the submission should be acked with success or failure in any case. With savepoint restore failures, the ack message will be skipped.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12938904">FLINK-3396</key>
            <summary>Job submission Savepoint restore logic flawed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="uce">Ufuk Celebi</assignee>
                                    <reporter username="uce">Ufuk Celebi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Feb 2016 20:11:04 +0000</created>
                <updated>Wed, 9 Mar 2016 11:17:07 +0000</updated>
                            <resolved>Wed, 9 Mar 2016 11:17:07 +0000</resolved>
                                                    <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15145312" author="githubbot" created="Fri, 12 Feb 2016 21:16:22 +0000"  >&lt;p&gt;GitHub user uce opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3396&quot; title=&quot;Job submission Savepoint restore logic flawed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3396&quot;&gt;&lt;del&gt;FLINK-3396&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Fail job submission after state restore failure&lt;/p&gt;

&lt;p&gt;    If state restore fails during job graph submission, the submitting client never gets notified about the submission failure. For detached submissions, this results in a time out rather than the actual failure cause. The actual failure can only be seen in the logs.&lt;/p&gt;

&lt;p&gt;    This PR changes the behaviour to fail the submission.&lt;/p&gt;

&lt;p&gt;    The failure cause is wrapped in a `SuppressRestartsException` in order to prevent the restart strategy from kicking in. We call `ExecutionGraph#fail(Throwable)` in the first place in order to have proper clean up.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/uce/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/uce/flink&lt;/a&gt; 3396-state_restore&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1633&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 982857bc0f5248a694d908141df0330de2befa3c&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-02-12T20:59:58Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3396&quot; title=&quot;Job submission Savepoint restore logic flawed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3396&quot;&gt;&lt;del&gt;FLINK-3396&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Fail job submission after state restore failure&lt;/p&gt;

&lt;p&gt;    Problem: If state restore fails during job graph submission, the submitting&lt;br/&gt;
    client never gets notified about the submission failure. For detached&lt;br/&gt;
    submissions, this results in a time out rather than the actual failure cause.&lt;br/&gt;
    The actual failure can only be seen in the logs.&lt;/p&gt;

&lt;p&gt;    Solution: Fail the submission if state restore fails.&lt;/p&gt;

&lt;p&gt;commit 9d2f4d88e99c3e50d8c001c8aa2cdb2848c80478&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-02-12T21:09:29Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Rename UnrecoverableException to SuppressRestartsException&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15147465" author="githubbot" created="Mon, 15 Feb 2016 15:20:28 +0000"  >&lt;p&gt;Github user uce commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#issuecomment-184250973&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#issuecomment-184250973&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tillrohrmann, could you have a look at this change?&lt;/p&gt;</comment>
                            <comment id="15147613" author="githubbot" created="Mon, 15 Feb 2016 17:21:34 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#discussion_r52924511&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#discussion_r52924511&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1073,57 +1073,73 @@ class JobManager(&lt;br/&gt;
           // execute the recovery/writing the jobGraph into the SubmittedJobGraphStore asynchronously&lt;br/&gt;
           // because it is a blocking operation&lt;br/&gt;
           future {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;if (isRecovery) 
{
    -            executionGraph.restoreLatestCheckpointedState()
    -          }&lt;/li&gt;
	&lt;li&gt;else {&lt;/li&gt;
	&lt;li&gt;val snapshotSettings = jobGraph.getSnapshotSettings&lt;/li&gt;
	&lt;li&gt;if (snapshotSettings != null) {&lt;/li&gt;
	&lt;li&gt;val savepointPath = snapshotSettings.getSavepointPath()&lt;br/&gt;
    +        val restoreStateSuccess =&lt;br/&gt;
    +          try {&lt;br/&gt;
    +            if (isRecovery) {&lt;br/&gt;
    +              executionGraph.restoreLatestCheckpointedState()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Is it intended that now failures in the `restoreLatestCheckpointedState` are non recoverable as well? This seems to be different from the former implementation.&lt;/p&gt;</comment>
                            <comment id="15147615" author="githubbot" created="Mon, 15 Feb 2016 17:23:02 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#issuecomment-184313039&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#issuecomment-184313039&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Changes look good to me @uce. I had only one inline question concerning a semantic change.&lt;/p&gt;

&lt;p&gt;    Apart from that +1 for merging.&lt;/p&gt;</comment>
                            <comment id="15148337" author="githubbot" created="Tue, 16 Feb 2016 09:35:13 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#discussion_r52986635&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#discussion_r52986635&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1073,57 +1073,73 @@ class JobManager(&lt;br/&gt;
           // execute the recovery/writing the jobGraph into the SubmittedJobGraphStore asynchronously&lt;br/&gt;
           // because it is a blocking operation&lt;br/&gt;
           future {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;if (isRecovery) 
{
    -            executionGraph.restoreLatestCheckpointedState()
    -          }&lt;/li&gt;
	&lt;li&gt;else {&lt;/li&gt;
	&lt;li&gt;val snapshotSettings = jobGraph.getSnapshotSettings&lt;/li&gt;
	&lt;li&gt;if (snapshotSettings != null) {&lt;/li&gt;
	&lt;li&gt;val savepointPath = snapshotSettings.getSavepointPath()&lt;br/&gt;
    +        val restoreStateSuccess =&lt;br/&gt;
    +          try {&lt;br/&gt;
    +            if (isRecovery) {&lt;br/&gt;
    +              executionGraph.restoreLatestCheckpointedState()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes, it had the same issue as the savepoint restore. If restoring the checkpoint failed, job submission was never ACK&apos;d, but execution was restarted etc. I&apos;m not sure that this is the behaviour we want in the long term, but I think failing the submission is clearer behaviour right now.&lt;/p&gt;

&lt;p&gt;    Another issue I&apos;ve noticed is the following: when HA checkpoint recovery fails and the job cannot be scheduled for execution, the job will eventually be removed from ZooKeeper and hence never be recovered again. Let me open an issue for this...&lt;/p&gt;</comment>
                            <comment id="15148354" author="githubbot" created="Tue, 16 Feb 2016 09:45:21 +0000"  >&lt;p&gt;Github user uce commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#issuecomment-184599724&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#issuecomment-184599724&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for review Till! I&apos;ve &lt;span class=&quot;error&quot;&gt;&amp;#91;opened an issue&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3411&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-3411&lt;/a&gt;) for the failure behaviour in case of checkpoint state recovery.&lt;/p&gt;

&lt;p&gt;    I&apos;ll merge this today.&lt;/p&gt;</comment>
                            <comment id="15148413" author="githubbot" created="Tue, 16 Feb 2016 10:26:26 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#discussion_r52992451&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#discussion_r52992451&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1073,57 +1073,73 @@ class JobManager(&lt;br/&gt;
           // execute the recovery/writing the jobGraph into the SubmittedJobGraphStore asynchronously&lt;br/&gt;
           // because it is a blocking operation&lt;br/&gt;
           future {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;if (isRecovery) 
{
    -            executionGraph.restoreLatestCheckpointedState()
    -          }&lt;/li&gt;
	&lt;li&gt;else {&lt;/li&gt;
	&lt;li&gt;val snapshotSettings = jobGraph.getSnapshotSettings&lt;/li&gt;
	&lt;li&gt;if (snapshotSettings != null) {&lt;/li&gt;
	&lt;li&gt;val savepointPath = snapshotSettings.getSavepointPath()&lt;br/&gt;
    +        val restoreStateSuccess =&lt;br/&gt;
    +          try {&lt;br/&gt;
    +            if (isRecovery) {&lt;br/&gt;
    +              executionGraph.restoreLatestCheckpointedState()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I&apos;m not so sure about that, to be honest. What if the `restoreLatestCheckpointedState` fails because of some HDFS/ZooKeeper problems. Then you would like to try restarting the job, wouldn&apos;t you? The client should then be notified once all restarting attempts have been exhausted.&lt;/p&gt;</comment>
                            <comment id="15148466" author="githubbot" created="Tue, 16 Feb 2016 11:14:34 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#discussion_r52997375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#discussion_r52997375&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1073,57 +1073,73 @@ class JobManager(&lt;br/&gt;
           // execute the recovery/writing the jobGraph into the SubmittedJobGraphStore asynchronously&lt;br/&gt;
           // because it is a blocking operation&lt;br/&gt;
           future {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;if (isRecovery) 
{
    -            executionGraph.restoreLatestCheckpointedState()
    -          }&lt;/li&gt;
	&lt;li&gt;else {&lt;/li&gt;
	&lt;li&gt;val snapshotSettings = jobGraph.getSnapshotSettings&lt;/li&gt;
	&lt;li&gt;if (snapshotSettings != null) {&lt;/li&gt;
	&lt;li&gt;val savepointPath = snapshotSettings.getSavepointPath()&lt;br/&gt;
    +        val restoreStateSuccess =&lt;br/&gt;
    +          try {&lt;br/&gt;
    +            if (isRecovery) {&lt;br/&gt;
    +              executionGraph.restoreLatestCheckpointedState()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    But then I would not keep the behaviour as it is right now. Instead, we should then consider the job submitted before trying to recover any checkpoint state and keep the restart behaviour. What do you think?&lt;/p&gt;</comment>
                            <comment id="15148478" author="githubbot" created="Tue, 16 Feb 2016 11:26:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#discussion_r52998567&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#discussion_r52998567&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1073,57 +1073,73 @@ class JobManager(&lt;br/&gt;
           // execute the recovery/writing the jobGraph into the SubmittedJobGraphStore asynchronously&lt;br/&gt;
           // because it is a blocking operation&lt;br/&gt;
           future {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;if (isRecovery) 
{
    -            executionGraph.restoreLatestCheckpointedState()
    -          }&lt;/li&gt;
	&lt;li&gt;else {&lt;/li&gt;
	&lt;li&gt;val snapshotSettings = jobGraph.getSnapshotSettings&lt;/li&gt;
	&lt;li&gt;if (snapshotSettings != null) {&lt;/li&gt;
	&lt;li&gt;val savepointPath = snapshotSettings.getSavepointPath()&lt;br/&gt;
    +        val restoreStateSuccess =&lt;br/&gt;
    +          try {&lt;br/&gt;
    +            if (isRecovery) {&lt;br/&gt;
    +              executionGraph.restoreLatestCheckpointedState()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The behaviour right now for a failure while doing a job recovery would simply fail the `ExecutionGraph` triggering a restart. A successful job recovery would send a `JobSubmitSuccess` to the client. I&apos;m not sure whether this is actually correct, since the client already received a `JobSubmitMessage` from the `JobManager` while initially submitting the job. But I think this will simply be ignored.&lt;/p&gt;

&lt;p&gt;    Thus, suppressing the restart behaviour in case of a job recovery would actually change the behaviour.&lt;/p&gt;

&lt;p&gt;    If it makes sense and if it is possible to recover from failures while recovering a job or restoring a savepoint, it would make sense to not directly fail the job without restarting. Maybe one should distinguish that based on the actually occurring exception.&lt;/p&gt;</comment>
                            <comment id="15148480" author="githubbot" created="Tue, 16 Feb 2016 11:30:35 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#discussion_r52998947&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#discussion_r52998947&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1073,57 +1073,73 @@ class JobManager(&lt;br/&gt;
           // execute the recovery/writing the jobGraph into the SubmittedJobGraphStore asynchronously&lt;br/&gt;
           // because it is a blocking operation&lt;br/&gt;
           future {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;if (isRecovery) 
{
    -            executionGraph.restoreLatestCheckpointedState()
    -          }&lt;/li&gt;
	&lt;li&gt;else {&lt;/li&gt;
	&lt;li&gt;val snapshotSettings = jobGraph.getSnapshotSettings&lt;/li&gt;
	&lt;li&gt;if (snapshotSettings != null) {&lt;/li&gt;
	&lt;li&gt;val savepointPath = snapshotSettings.getSavepointPath()&lt;br/&gt;
    +        val restoreStateSuccess =&lt;br/&gt;
    +          try {&lt;br/&gt;
    +            if (isRecovery) {&lt;br/&gt;
    +              executionGraph.restoreLatestCheckpointedState()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Had an offline discussion with Stephan. He agrees with you that the failure in this case is too hard. I&apos;ll undo that change by ACK&apos;ing the submission earlier.&lt;/p&gt;</comment>
                            <comment id="15148485" author="githubbot" created="Tue, 16 Feb 2016 11:38:56 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#discussion_r52999704&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#discussion_r52999704&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1079,6 +1079,9 @@ class JobManager(&lt;br/&gt;
               executionGraph.registerExecutionListener(gateway)&lt;br/&gt;
               executionGraph.registerJobStatusListener(gateway)&lt;br/&gt;
             }&lt;br/&gt;
    +&lt;br/&gt;
    +        // All good. Submission succeeded!&lt;br/&gt;
    +        jobInfo.client ! decorateMessage(JobSubmitSuccess(jobGraph.getJobID))&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Moved this one up to have correct ACKing behaviour.&lt;/p&gt;</comment>
                            <comment id="15148495" author="githubbot" created="Tue, 16 Feb 2016 11:52:58 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#discussion_r53000913&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#discussion_r53000913&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1073,57 +1073,73 @@ class JobManager(&lt;br/&gt;
           // execute the recovery/writing the jobGraph into the SubmittedJobGraphStore asynchronously&lt;br/&gt;
           // because it is a blocking operation&lt;br/&gt;
           future {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;if (isRecovery) 
{
    -            executionGraph.restoreLatestCheckpointedState()
    -          }&lt;/li&gt;
	&lt;li&gt;else {&lt;/li&gt;
	&lt;li&gt;val snapshotSettings = jobGraph.getSnapshotSettings&lt;/li&gt;
	&lt;li&gt;if (snapshotSettings != null) {&lt;/li&gt;
	&lt;li&gt;val savepointPath = snapshotSettings.getSavepointPath()&lt;br/&gt;
    +        val restoreStateSuccess =&lt;br/&gt;
    +          try {&lt;br/&gt;
    +            if (isRecovery) {&lt;br/&gt;
    +              executionGraph.restoreLatestCheckpointedState()
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Regarding the `JobSubmitSuccess`: we had it as a follow up to have more fine-grained integration with the the client and left it as a duplicate submit message for the time being (instead of something like `JobRecovered`).&lt;/p&gt;

&lt;p&gt;    The other behaviour is back to the previous state now. I hear you that it makes sense to integrate the state restore behaviour with the execution graph restart.&lt;/p&gt;</comment>
                            <comment id="15148628" author="githubbot" created="Tue, 16 Feb 2016 14:06:30 +0000"  >&lt;p&gt;Github user uce commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#issuecomment-184694713&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#issuecomment-184694713&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Travis has passed. Did you have another look at this @tillrohrmann?&lt;/p&gt;</comment>
                            <comment id="15148695" author="githubbot" created="Tue, 16 Feb 2016 14:48:48 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#discussion_r53019468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#discussion_r53019468&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1079,6 +1079,9 @@ class JobManager(&lt;br/&gt;
               executionGraph.registerExecutionListener(gateway)&lt;br/&gt;
               executionGraph.registerJobStatusListener(gateway)&lt;br/&gt;
             }&lt;br/&gt;
    +&lt;br/&gt;
    +        // All good. Submission succeeded!&lt;br/&gt;
    +        jobInfo.client ! decorateMessage(JobSubmitSuccess(jobGraph.getJobID))&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Hmm but now we have the problem that the user might see a `JobSubmitSuccess` without the job being stored in the `SubmittedJobGraphStore`, right? This means that if the `JobManager` dies before the job is persisted, it will never be recovered. I think this violates the `JobSubmitSuccess` contract.&lt;/p&gt;</comment>
                            <comment id="15148700" author="githubbot" created="Tue, 16 Feb 2016 14:51:35 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#discussion_r53019879&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#discussion_r53019879&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/scala/org/apache/flink/runtime/jobmanager/JobManager.scala &amp;#8212;&lt;br/&gt;
    @@ -1079,6 +1079,9 @@ class JobManager(&lt;br/&gt;
               executionGraph.registerExecutionListener(gateway)&lt;br/&gt;
               executionGraph.registerJobStatusListener(gateway)&lt;br/&gt;
             }&lt;br/&gt;
    +&lt;br/&gt;
    +        // All good. Submission succeeded!&lt;br/&gt;
    +        jobInfo.client ! decorateMessage(JobSubmitSuccess(jobGraph.getJobID))&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Oh boy... not my day today. Thanks for catching that. This was not expected.&lt;/p&gt;</comment>
                            <comment id="15148774" author="githubbot" created="Tue, 16 Feb 2016 15:10:03 +0000"  >&lt;p&gt;Github user uce commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633#issuecomment-184719993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633#issuecomment-184719993&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Closing this...&lt;/p&gt;</comment>
                            <comment id="15148775" author="githubbot" created="Tue, 16 Feb 2016 15:10:05 +0000"  >&lt;p&gt;Github user uce closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1633&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1633&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15150365" author="githubbot" created="Wed, 17 Feb 2016 11:40:09 +0000"  >&lt;p&gt;GitHub user uce opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1656&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1656&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3396&quot; title=&quot;Job submission Savepoint restore logic flawed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3396&quot;&gt;&lt;del&gt;FLINK-3396&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Fix JobGraph submission and client ACK logic&lt;/p&gt;

&lt;p&gt;    A failure when recovering savepoint state could lead to not ACKing&lt;br/&gt;
    the job submission. For detached submissions, this could have lead&lt;br/&gt;
    to a submission timeout although the job eventually starts to run.&lt;/p&gt;

&lt;p&gt;    Moreover, a failure to restore savepoint state, could lead to a job&lt;br/&gt;
    graph skipping the submitted graph store for HA.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/uce/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/uce/flink&lt;/a&gt; 3396-submit&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1656.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1656.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1656&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 3847e304c93a30c18560719d8f169ca424d734e6&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-02-12T21:09:29Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Rename UnrecoverableException to SuppressRestartsException&lt;/p&gt;

&lt;p&gt;commit 92e900b3266b93204ea84050d189f00bbbca6678&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-02-16T16:49:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3396&quot; title=&quot;Job submission Savepoint restore logic flawed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3396&quot;&gt;&lt;del&gt;FLINK-3396&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Fix JobGraph submission and client ACK logic&lt;/p&gt;

&lt;p&gt;    A failure when recovering savepoint state could lead to not ACKing&lt;br/&gt;
    the job submission. For detached submissions, this could have lead&lt;br/&gt;
    to a submission timeout although the job eventually starts to run.&lt;/p&gt;

&lt;p&gt;    Moreover, a failure to restore savepoint state, could lead to a job&lt;br/&gt;
    graph skipping the submitted graph store for HA.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15150374" author="githubbot" created="Wed, 17 Feb 2016 11:46:06 +0000"  >&lt;p&gt;Github user uce closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1656&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1656&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15150499" author="githubbot" created="Wed, 17 Feb 2016 13:32:21 +0000"  >&lt;p&gt;GitHub user uce opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1657&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1657&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3396&quot; title=&quot;Job submission Savepoint restore logic flawed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3396&quot;&gt;&lt;del&gt;FLINK-3396&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Suppress job restart if adding to job graph store fails&lt;/p&gt;

&lt;p&gt;    @tillrohrmann, this leaves everything as is, but suppresses the restart in case of a failure to add the job graph to ZooKeeper (the standalone case should never fail). This applies only to the initial job submission.&lt;/p&gt;

&lt;p&gt;    The behaviour before was possibly leading to restart and the job being submitted w/o being added to ZooKeeper. Furthermore, the submission was not ACK&apos;d in such a case. Now it will simply fail and the user can/has to react.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/uce/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/uce/flink&lt;/a&gt; 3396-submit&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1657.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1657.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1657&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 3847e304c93a30c18560719d8f169ca424d734e6&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-02-12T21:09:29Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Rename UnrecoverableException to SuppressRestartsException&lt;/p&gt;

&lt;p&gt;commit 07753af54db020ddef5540ab0ae3dcbb3af69c54&lt;br/&gt;
Author: Ufuk Celebi &amp;lt;uce@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-02-16T16:49:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3396&quot; title=&quot;Job submission Savepoint restore logic flawed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3396&quot;&gt;&lt;del&gt;FLINK-3396&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Suppress job restart if adding to job graph store fails&lt;/p&gt;

&lt;p&gt;    A failure to add the job graph to the submitted job graphs in ZooKeeper&lt;br/&gt;
    could lead to a job restart w/o the job graph ever being added to the&lt;br/&gt;
    submitted graphs store. Although the job submission was not ACK&apos;d in&lt;br/&gt;
    this case before, it received job status messages. Now the job will&lt;br/&gt;
    not be ACK&apos;d as before, but the job will be failed.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15179633" author="githubbot" created="Fri, 4 Mar 2016 09:44:02 +0000"  >&lt;p&gt;Github user uce commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1657#issuecomment-192209616&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1657#issuecomment-192209616&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    If there are no objections, I am going to merge this to master later today.&lt;/p&gt;</comment>
                            <comment id="15186961" author="githubbot" created="Wed, 9 Mar 2016 11:15:36 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1657&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1657&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15186962" author="uce" created="Wed, 9 Mar 2016 11:17:07 +0000"  >&lt;p&gt;Fixed in cdc8f0a (master).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 36 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ssfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>