<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5465] RocksDB fails with segfault while calling AbstractRocksDBState.clear()</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5465</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I&apos;m using Flink 699f4b0.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;#
# A fatal error has been detected by the Java &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Environment:
#
#  SIGSEGV (0xb) at pc=0x00007f91a0d49b78, pid=26662, tid=140263356024576
#
# JRE version: Java(TM) SE &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Environment (7.0_67-b01) (build 1.7.0_67-b01)
# Java VM: Java HotSpot(TM) 64-Bit Server VM (24.65-b04 mixed mode linux-amd64 compressed oops)
# Problematic frame:
# C  [librocksdbjni-linux64.so+0x1aeb78]  rocksdb::GetColumnFamilyID(rocksdb::ColumnFamilyHandle*)+0x8
#
# Failed to write core dump. Core dumps have been disabled. To enable core dumping, &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;ulimit -c unlimited&quot;&lt;/span&gt; before starting Java again
#
# An error report file with more information is saved as:
# /yarn/nm/usercache/robert/appcache/application_1484132267957_0007/container_1484132267957_0007_01_000010/hs_err_pid26662.log
Compiled method (nm) 1869778  903     n       org.rocksdb.RocksDB::remove (&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;)
 total in heap  [0x00007f91b40b9dd0,0x00007f91b40ba150] = 896
 relocation     [0x00007f91b40b9ef0,0x00007f91b40b9f48] = 88
 main code      [0x00007f91b40b9f60,0x00007f91b40ba150] = 496
#
# If you would like to submit a bug report, please visit:
#   http:&lt;span class=&quot;code-comment&quot;&gt;//bugreport.sun.com/bugreport/crash.jsp
&lt;/span&gt;# The crash happened outside the Java Virtual Machine in &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; code.
# See problematic frame &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; where to report the bug.
#

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13033968">FLINK-5465</key>
            <summary>RocksDB fails with segfault while calling AbstractRocksDBState.clear()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Jan 2017 21:05:16 +0000</created>
                <updated>Wed, 2 Oct 2019 17:43:36 +0000</updated>
                            <resolved>Thu, 23 Nov 2017 14:32:53 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.4.0</fixVersion>
                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15819165" author="rmetzger" created="Wed, 11 Jan 2017 21:06:34 +0000"  >&lt;p&gt;I&apos;ve attached the error report file, containing the stack trace&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Stack: [0x00007f919b72c000,0x00007f919b82d000],  sp=0x00007f919b82b368,  free space=1020k
Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; code)
C  [librocksdbjni-linux64.so+0x1aeb78]  rocksdb::GetColumnFamilyID(rocksdb::ColumnFamilyHandle*)+0x8
C  [librocksdbjni-linux64.so+0x2009e1]  rocksdb::DB::Delete(rocksdb::WriteOptions &lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt;&amp;amp;, rocksdb::ColumnFamilyHandle*, rocksdb::Slice &lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt;&amp;amp;)+0x41
C  [librocksdbjni-linux64.so+0x200a41]  rocksdb::DBImpl::Delete(rocksdb::WriteOptions &lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt;&amp;amp;, rocksdb::ColumnFamilyHandle*, rocksdb::Slice &lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt;&amp;amp;)+0x11
C  [librocksdbjni-linux64.so+0x18e993]  rocksdb_remove_helper(JNIEnv_*, rocksdb::DB*, rocksdb::WriteOptions &lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt;&amp;amp;, rocksdb::ColumnFamilyHandle*, _jbyteArray*, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)+0x63
C  [librocksdbjni-linux64.so+0x18eee6]  Java_org_rocksdb_RocksDB_remove__JJ_3BIJ+0x26
J 903  org.rocksdb.RocksDB.remove(JJ[BIJ)V (0 bytes) @ 0x00007f91b40ba02d [0x00007f91b40b9f60+0xcd]

Java frames: (J=compiled Java code, j=interpreted, Vv=VM code)
J 903  org.rocksdb.RocksDB.remove(JJ[BIJ)V (0 bytes) @ 0x00007f91b40b9fb3 [0x00007f91b40b9f60+0x53]
J 900 C2 org.apache.flink.contrib.streaming.state.AbstractRocksDBState.clear()V (47 bytes) @ 0x00007f91b4143f18 [0x00007f91b4143c60+0x2b8]
J 1087 C2 org.apache.flink.streaming.runtime.operators.windowing.WindowOperator.cleanup(Lorg/apache/flink/streaming/api/windowing/windows/Window;Lorg/apache/flink/api/common/state/AppendingState;Lorg/apache/flink/streaming/runtime/operators/windowing/MergingWindowSet;)V (27 bytes) @ 0x00007f91b414dc64 [0x00007f91b414dc20+0x44]
J 925 C2 org.apache.flink.streaming.api.operators.HeapInternalTimerService.onProcessingTime(J)V (107 bytes) @ 0x00007f91b4194794 [0x00007f91b4194560+0x234]
j  org.apache.flink.streaming.runtime.tasks.SystemProcessingTimeService$TriggerTask.run()V+15
j  java.util.concurrent.Executors$RunnableAdapter.call()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;+4
j  java.util.concurrent.FutureTask.run()V+42
j  java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(Ljava/util/concurrent/ScheduledThreadPoolExecutor$ScheduledFutureTask;)V+1
j  java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run()V+30
j  java.util.concurrent.ThreadPoolExecutor.runWorker(Ljava/util/concurrent/ThreadPoolExecutor$Worker;)V+95
j  java.util.concurrent.ThreadPoolExecutor$Worker.run()V+5
j  java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run()V+11
v  ~StubRoutines::call_stub
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15819458" author="srichter" created="Wed, 11 Jan 2017 23:00:01 +0000"  >&lt;p&gt;Looks like cleanup function which calls to clear() is run in thread that is different from the operator&apos;s main thread. This is not allowed, because state accesses are not guarded against backend disposal for other threads. All manipulations to state must be done in the operators main thread (to one which also calls backend.dispose()). What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt;, can we somehow let this cleanup activity be performed in the operator thread (maybe before the next elements)?&lt;/p&gt;</comment>
                            <comment id="15821808" author="srichter" created="Fri, 13 Jan 2017 13:59:07 +0000"  >&lt;p&gt;After talking to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;, we came to the conclusion that this can be tolerated as known issue as it can only happen at the very end of a task&apos;s lifecycle and is very hard to change without potential problems for fast task cancelation or general state performance.&lt;/p&gt;

&lt;p&gt;Can I set this to won&apos;t fix?&lt;/p&gt;</comment>
                            <comment id="15821827" author="stephanewen" created="Fri, 13 Jan 2017 14:07:44 +0000"  >&lt;p&gt;+1 for setting it to won&apos;t fix for now and properly fixing it in the next release when we get rid of multi-threading in the StreamTask&lt;/p&gt;</comment>
                            <comment id="15821906" author="rmetzger" created="Fri, 13 Jan 2017 15:29:25 +0000"  >&lt;p&gt;Thank you guys for looking into it. I&apos;m closing the issue as won&apos;t fix.&lt;/p&gt;</comment>
                            <comment id="16262584" author="dernasherbrezon" created="Wed, 22 Nov 2017 14:19:19 +0000"  >&lt;p&gt;We were able to reproduce this issue on Flink 1.3.2. This is very critical bug, because failing job could bring whole flink cluster down. &lt;/p&gt;

&lt;p&gt;Failing job will amplify chances for rocksdb crash by constant start/cancel.&lt;/p&gt;</comment>
                            <comment id="16264061" author="srichter" created="Thu, 23 Nov 2017 09:39:56 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dernasherbrezon&quot; class=&quot;user-hover&quot; rel=&quot;dernasherbrezon&quot;&gt;dernasherbrezon&lt;/a&gt;, it is true that this problem still exists in the latest Flink releases. The source of this problem are pending timer threads that can access native resources after their disposal. The obvious fix is to wait until all timers are finished before disposing those resources, and the main reason why we did not change this is that (in theory) a the user code of a triggering timer can block forever and suppress or delay restarts in failover cases. However, the situation has changed a bit since this topic was discussed for the last time and there is now also a watchdog that ensures that tasks are terminated after some time of inactivity. I would propose a middle ground that probably catches close to all of those problems, while still ensuring a reasonable fast shutdown. I would suggest to wait for the termination of the threadpool that runs all timer events until a time limit. Typically, there is a very limited number of in-flight timers and they are usually short lived. A wait interval of a few seconds should basically fix this problem, even though there can still be very rare cases of very long running timers that also happen to still access the disposed resources. But the likelihood of this scenario should be reduced by orders of magnitude and in particular, the cascading effect should be mitigated. &lt;/p&gt;</comment>
                            <comment id="16264070" author="githubbot" created="Thu, 23 Nov 2017 09:47:59 +0000"  >&lt;p&gt;GitHub user StefanRRichter opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5465&quot; title=&quot;RocksDB fails with segfault while calling AbstractRocksDBState.clear()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5465&quot;&gt;&lt;del&gt;FLINK-5465&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Wait for pending timer threads to finish or &#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;to exceed a time limit in exceptional stream task shutdown&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    When stream tasks are going through their cleanup in the failover case, pending timer threads can still access native resources of a state backend after the backend&apos;s disposal. In some cases, this can crash the JVM. &lt;/p&gt;

&lt;p&gt;    The obvious fix is to wait until all timers are finished before disposing those resources, and the main reason why we did not change this is that (in theory) a the user code of a triggering timer can block forever and suppress or delay restarts in failover cases. However, the situation has changed a bit since this topic was discussed for the last time and there is now also a watchdog that ensures that tasks are terminated after some time of inactivity. I would propose a middle ground that probably catches close to all of those problems, while still ensuring a reasonable fast shutdown. I would suggest to wait for the termination of the threadpool that runs all timer events until a time limit. Typically, there is a very limited number of in-flight timers and they are usually short lived. A wait interval of a few seconds should basically fix this problem, even though there can still be very rare cases of very long running timers that also happen to still access the disposed resources. But the likelihood of this scenario should be reduced by orders of magnitude and in particular, the cascading effect should be mitigated.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*SteamTasks wait in their cleanup code for a certain time limit to give the timer service a chance to finish all pending timer threads. *&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change added tests to `SystemProcessingTimeServiceTest`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StefanRRichter/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StefanRRichter/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5465&quot; title=&quot;RocksDB fails with segfault while calling AbstractRocksDBState.clear()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5465&quot;&gt;&lt;del&gt;FLINK-5465&lt;/del&gt;&lt;/a&gt;-wait-timer-shutdown&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5058&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 3c6f0f3377abb35ed5b04fdcdb599705bc0af162&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-11-22T16:52:35Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5465&quot; title=&quot;RocksDB fails with segfault while calling AbstractRocksDBState.clear()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5465&quot;&gt;&lt;del&gt;FLINK-5465&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Wait for pending timer threads to finish or to exceed a time limit in exceptional stream task shutdown&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16264071" author="githubbot" created="Thu, 23 Nov 2017 09:48:18 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    CC @aljoscha &lt;/p&gt;</comment>
                            <comment id="16264091" author="githubbot" created="Thu, 23 Nov 2017 10:03:20 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058#discussion_r152759445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058#discussion_r152759445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/ProcessingTimeService.java &amp;#8212;&lt;br/&gt;
    @@ -93,4 +94,15 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;will result in a hard exception.&lt;br/&gt;
     	 */&lt;br/&gt;
     	public abstract void shutdownService();&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Shuts down and clean up the timer service provider hard and immediately. This does wait&lt;br/&gt;
    +	 * for all timer to complete or until the time limit is exceeded. Any call to
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: &quot;timers&quot;&lt;/p&gt;</comment>
                            <comment id="16264092" author="githubbot" created="Thu, 23 Nov 2017 10:03:20 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058#discussion_r152759896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058#discussion_r152759896&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java &amp;#8212;&lt;br/&gt;
    @@ -122,6 +123,8 @@&lt;br/&gt;
     	/** The logger used by the StreamTask and its subclasses. */&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(StreamTask.class);&lt;/p&gt;

&lt;p&gt;    +	private static final long TIMER_SERVICE_TERMINATION_AWAIT_MS = 7500L;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This could be a configuration setting.&lt;/p&gt;</comment>
                            <comment id="16264154" author="githubbot" created="Thu, 23 Nov 2017 10:44:03 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks good all in all.&lt;/p&gt;

&lt;p&gt;    I am torn between adding a configuration setting for the timer grace period and not having one. Seems like a setting that is unlikely to ever be used and just blows up the config space. On the other hand, magic numbers should be configurable...&lt;/p&gt;</comment>
                            <comment id="16264161" author="githubbot" created="Thu, 23 Nov 2017 10:50:44 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I am actually leaning towards not having a grace period, too. Reason is that actually there are more than one method in the same code path that could also (theoretically) block forever.&lt;/p&gt;

&lt;p&gt;    Should we remove the timeout?&lt;/p&gt;</comment>
                            <comment id="16264180" author="githubbot" created="Thu, 23 Nov 2017 11:07:03 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    So which way can we agree upon? I feel like this is a setting that is very specific and hard to understand for the user. On the other hand, it is nice if we can adjust it by configuration in case it causes any problems.&lt;/p&gt;</comment>
                            <comment id="16264207" author="githubbot" created="Thu, 23 Nov 2017 11:27:01 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Implemented the configurable timeout, so that we can chose between the two options.&lt;/p&gt;</comment>
                            <comment id="16264387" author="githubbot" created="Thu, 23 Nov 2017 14:20:30 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 This LGTM now. &lt;/p&gt;</comment>
                            <comment id="16264388" author="githubbot" created="Thu, 23 Nov 2017 14:21:37 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the reviews @aljoscha and @StephanEwen. Will merge this now.&lt;/p&gt;</comment>
                            <comment id="16264391" author="githubbot" created="Thu, 23 Nov 2017 14:25:48 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16264400" author="srichter" created="Thu, 23 Nov 2017 14:32:07 +0000"  >&lt;p&gt;Reconsidered for a better solution because JVM crashed can also heavily impact recovery times.&lt;/p&gt;</comment>
                            <comment id="16264402" author="srichter" created="Thu, 23 Nov 2017 14:32:53 +0000"  >&lt;p&gt;merged in d86c6b6bb3.&lt;/p&gt;</comment>
                            <comment id="16265138" author="githubbot" created="Fri, 24 Nov 2017 10:28:49 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I would like to make a few comments for followup:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think `TimerServiceOptions` should not be an own class, we are getting a crazy fragmentation of options into classes (that have sometimes, like here, only one option defined). Let&apos;s merge these into the `TaskManagerOptions`.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The config key does not reflect the scheme in which all other config keys are defined. It reads like a name where the dot &apos;.&apos; is a work separator. The scheme in which all other config keys are defined is hierarchical, like a path in a nested config group/object structure. Think that the configuration is one huge JSON object, and the key is the dot path to the entry. Hence a key like `taskmanager.timers.shutdown-timeout` (or `taskmanager.timers.shutdown.timeout`, if we view `shutdown` as a full config group/object) would be in line with the resulting style.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="16265143" author="githubbot" created="Fri, 24 Nov 2017 10:38:10 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I was thinking about where to put those options and after all it was a choice between fragmentation and inconsistency. I considered `TaskManagerOptions` but it sounds like a wrong place, if you look what the other options in this class are about and it also feels like saying `Task` == `StreamTask` because timers are something that currently belongs to `streaming` imo. There are classes for configurations all over the place, so if you think this is a problem, maybe we should fix it in general and not on a per-case basis?&lt;/p&gt;

&lt;p&gt;    I agree that we can change the key string.&lt;/p&gt;</comment>
                            <comment id="16577629" author="githubbot" created="Sun, 12 Aug 2018 15:36:23 +0000"  >&lt;p&gt;Aitozi commented on issue #5058: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5465&quot; title=&quot;RocksDB fails with segfault while calling AbstractRocksDBState.clear()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5465&quot;&gt;&lt;del&gt;FLINK-5465&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Wait for pending timer threads to finish or &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5058#issuecomment-412350899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058#issuecomment-412350899&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Can i ask a question here? Why the code below in `StreamTask` can not make sure the processingTimer task are all been finished before the backend has been disposed? And need this PR to guarantee.   I ran into the same bug in flink 1.3.2, but i cant quite understand does the `awaitPendingAfterQuiesce` don&apos;t work? @StefanRRichter &lt;/p&gt;

&lt;p&gt;   ```&lt;br/&gt;
   // make sure all timers finish&lt;br/&gt;
    timerService.awaitPendingAfterQuiesce();&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16577642" author="githubbot" created="Sun, 12 Aug 2018 16:17:07 +0000"  >&lt;p&gt;StefanRRichter commented on issue #5058: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5465&quot; title=&quot;RocksDB fails with segfault while calling AbstractRocksDBState.clear()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5465&quot;&gt;&lt;del&gt;FLINK-5465&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Wait for pending timer threads to finish or &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5058#issuecomment-412353501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058#issuecomment-412353501&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @Aitozi the problem with the code is that (at least in that version of Flink) thread could still become interrupted as part of an ongoing cancellation while waiting for the timer service to finish. It will then immediately unblock with `InterruptedException` and the bad things can still happen. The code needs to complete the shutdown even in the face of interruption or else you can still segault from time to time. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16577643" author="githubbot" created="Sun, 12 Aug 2018 16:17:23 +0000"  >&lt;p&gt;StefanRRichter edited a comment on issue #5058: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5465&quot; title=&quot;RocksDB fails with segfault while calling AbstractRocksDBState.clear()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5465&quot;&gt;&lt;del&gt;FLINK-5465&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Wait for pending timer threads to finish or &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5058#issuecomment-412353501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058#issuecomment-412353501&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @Aitozi the problem with the code is that (at least in that version of Flink) the thread could still become interrupted as part of an ongoing cancellation while waiting for the timer service to finish. It will then immediately unblock with `InterruptedException` and the bad things can still happen. The code needs to complete the shutdown even in the face of interruption or else you can still segault from time to time. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16577646" author="githubbot" created="Sun, 12 Aug 2018 16:21:24 +0000"  >&lt;p&gt;StefanRRichter edited a comment on issue #5058: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5465&quot; title=&quot;RocksDB fails with segfault while calling AbstractRocksDBState.clear()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5465&quot;&gt;&lt;del&gt;FLINK-5465&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Wait for pending timer threads to finish or &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5058#issuecomment-412353501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058#issuecomment-412353501&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @Aitozi the problem with the code is that (at least in that version of Flink) the thread could still become interrupted as part of an ongoing cancellation while waiting for the timer service to finish. It will then immediately unblock with `InterruptedException` and the bad things can still happen. The code needs to complete the shutdown even in the face of interruption or else you can still segault from time to time. &lt;/p&gt;

&lt;p&gt;   Edit: one more hint fyi, there is also still `&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9845&quot; title=&quot;Make InternalTimerService&amp;#39;s timer processing interruptible/abortable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9845&quot;&gt;FLINK-9845&lt;/a&gt;` pending, which will make the timer service manager collaborative with cancellation, so that the waiting phase can become a bit shorter for some cases. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16647154" author="githubbot" created="Thu, 11 Oct 2018 23:05:55 +0000"  >&lt;p&gt;zorro786 commented on issue #5058: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5465&quot; title=&quot;RocksDB fails with segfault while calling AbstractRocksDBState.clear()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5465&quot;&gt;&lt;del&gt;FLINK-5465&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Wait for pending timer threads to finish or &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5058#issuecomment-429150903&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058#issuecomment-429150903&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @StefanRRichter It is mentioned in Jira ticket that this affects versions 1.5.0, 1.4.2, 1.6.0.&lt;br/&gt;
   Could you please tell why it doesn&apos;t affect 1.4.0?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16647599" author="githubbot" created="Fri, 12 Oct 2018 08:12:53 +0000"  >&lt;p&gt;StefanRRichter commented on issue #5058: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5465&quot; title=&quot;RocksDB fails with segfault while calling AbstractRocksDBState.clear()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5465&quot;&gt;&lt;del&gt;FLINK-5465&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt; Wait for pending timer threads to finish or &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5058#issuecomment-429243331&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5058#issuecomment-429243331&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   It affects 1.4 as well.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12847077" name="hs-err-pid26662.log" size="88216" author="rmetzger" created="Wed, 11 Jan 2017 21:06:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38krz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>