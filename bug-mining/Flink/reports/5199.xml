<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:55:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21413] TtlMapState and TtlListState cannot be clean completely with Filesystem StateBackend</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21413</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Take the #TtlMapState as an example,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Map&amp;lt;UK, TtlValue&amp;lt;UV&amp;gt;&amp;gt; getUnexpiredOrNull(@Nonnull Map&amp;lt;UK, TtlValue&amp;lt;UV&amp;gt;&amp;gt; ttlValue) {
        Map&amp;lt;UK, TtlValue&amp;lt;UV&amp;gt;&amp;gt; unexpired = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
        TypeSerializer&amp;lt;TtlValue&amp;lt;UV&amp;gt;&amp;gt; valueSerializer =
                ((MapSerializer&amp;lt;UK, TtlValue&amp;lt;UV&amp;gt;&amp;gt;) original.getValueSerializer()).getValueSerializer();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;UK, TtlValue&amp;lt;UV&amp;gt;&amp;gt; e : ttlValue.entrySet()) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!expired(e.getValue())) {
                        &lt;span class=&quot;code-comment&quot;&gt;// we have to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; the defensive copy to update the value
&lt;/span&gt;                        unexpired.put(e.getKey(), valueSerializer.copy(e.getValue()));
                }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ttlValue.size() == unexpired.size() ? ttlValue : unexpired;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The returned value will never be null and the #StateEntry will exists forever, which leads to memory leak if the key&apos;s range of the stream is very large. Below we can see that 20+ millison uncleared TtlStateMap could take up several GB memory.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13020673/13020673_image-2021-02-19-11-13-58-672.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13359494">FLINK-21413</key>
            <summary>TtlMapState and TtlListState cannot be clean completely with Filesystem StateBackend</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wind_ljy">Jiayi Liao</assignee>
                                    <reporter username="wind_ljy">Jiayi Liao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 19 Feb 2021 03:13:45 +0000</created>
                <updated>Sat, 28 Aug 2021 11:11:40 +0000</updated>
                            <resolved>Wed, 31 Mar 2021 10:22:23 +0000</resolved>
                                    <version>1.9.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17287550" author="carp84" created="Sat, 20 Feb 2021 06:10:54 +0000"  >&lt;p&gt;Indeed, thanks for reporting the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt;. Would you like to work on this and supply a PR to fix it? Thanks.&lt;/p&gt;</comment>
                            <comment id="17287600" author="wind_ljy" created="Sat, 20 Feb 2021 08:59:49 +0000"  >&lt;p&gt;Sure. I&apos;m still thinking about the solution. I&apos;ve come up with two proposals:&lt;/p&gt;

&lt;p&gt;1. #TtlMapState#getUnexpiredOrNull returns null directly if the &lt;tt&gt;unexpired.size() == 0&lt;/tt&gt;, but this will also clean the empty map. &lt;br/&gt;
2. Add a lastAccessTimestamp(long) in #TtlMapState like what Flink does in TtlValue, and use the timestamp to check the map&apos;s lifecyle. But this may break the state compatibility.&lt;/p&gt;

&lt;p&gt;What do you think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liyu&quot; class=&quot;user-hover&quot; rel=&quot;liyu&quot;&gt;liyu&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17287862" author="carp84" created="Sun, 21 Feb 2021 07:33:01 +0000"  >&lt;p&gt;Checking the &lt;a href=&quot;https://cwiki.apache.org/confluence/display/FLINK/FLIP-25%3A+Support+User+State+TTL+Natively#FLIP25:SupportUserStateTTLNatively-TTLbehaviour&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;state TTL FLIP document&lt;/a&gt; I cannot find description on whether TTL for a whole map is supported for &lt;tt&gt;MapState&lt;/tt&gt;, but according to the current implementation the answer is no (TTL is only checked against value of each map entry). What&apos;s more, in &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/state/heap/HeapMapState.java#L130-L132&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HeapMapState#remove&lt;/a&gt; we could see the whole map will be removed if become empty, so I don&apos;t think &lt;tt&gt;TtlIncrementalCleanup&lt;/tt&gt; need to take care of the empty map case.&lt;/p&gt;

&lt;p&gt;Accordingly, I think we should have a fast path in &lt;tt&gt;TtlMapState#getUnexpiredOrNull&lt;/tt&gt; to check whether &lt;tt&gt;ttlValue&lt;/tt&gt; is empty and return it directly (instead of returning &lt;tt&gt;NULL&lt;/tt&gt;) if so, and returning &lt;tt&gt;NULL&lt;/tt&gt; iif &lt;tt&gt;ttlValue&lt;/tt&gt; is not empty but all values expired (&lt;tt&gt;unexpired.size()&lt;/tt&gt; is zero).&lt;/p&gt;

&lt;p&gt;And similar logic should be applied to &lt;tt&gt;TtlListState#getUnexpiredOrNull&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Please let me know your thoughts &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt;. Thanks.&lt;/p&gt;</comment>
                            <comment id="17288147" author="wind_ljy" created="Mon, 22 Feb 2021 03:11:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liyu&quot; class=&quot;user-hover&quot; rel=&quot;liyu&quot;&gt;liyu&lt;/a&gt; Oops... I didn&apos;t notice that the #remove(UK) method would clear the empty map. I think you&apos;re right, we can expire the &lt;tt&gt;StateEntry&lt;/tt&gt; once all &lt;tt&gt;ttlValue&lt;/tt&gt; are expired. &lt;/p&gt;</comment>
                            <comment id="17288229" author="carp84" created="Mon, 22 Feb 2021 07:57:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt; would you like to work on the PR following the above solution? I will assign this JIRA to you if so and help review the PR, or just feel free to let me know if you&apos;re not available at this moment.&lt;/p&gt;</comment>
                            <comment id="17288266" author="wind_ljy" created="Mon, 22 Feb 2021 09:03:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liyu&quot; class=&quot;user-hover&quot; rel=&quot;liyu&quot;&gt;liyu&lt;/a&gt; Yes. I&apos;ll submit a PR soon. &lt;/p&gt;</comment>
                            <comment id="17288416" author="carp84" created="Mon, 22 Feb 2021 14:57:11 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt;, JIRA assigned.&lt;/p&gt;</comment>
                            <comment id="17312257" author="carp84" created="Wed, 31 Mar 2021 10:22:23 +0000"  >&lt;p&gt;Merged into master via 1e17621e65bfa8f4f3aff379118654ed77a82bd2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13020673" name="image-2021-02-19-11-13-58-672.png" size="124078" author="wind_ljy" created="Fri, 19 Feb 2021 03:14:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ntsg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>