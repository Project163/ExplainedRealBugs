<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:48:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18821] Netty client retry mechanism may cause PartitionRequestClientFactory#createPartitionRequestClient to wait infinitely</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18821</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When running TPCDS 10T benchmark on Flink I found some of the task slots stuck. After some investigation there seems to be a bug in&#160;&lt;tt&gt;PartitionRequestClientFactory&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;When a task tries to require a partition of data from its upstream task but fails, &lt;tt&gt;PartitionRequestClientFactory#connect&lt;/tt&gt; will throw &lt;tt&gt;RemoteTransportException&lt;/tt&gt; and &lt;tt&gt;PartitionRequestClientFactory#connectWithRetries&lt;/tt&gt; will throw &lt;tt&gt;CompletionException&lt;/tt&gt;. However this exception is not caught by &lt;tt&gt;PartitionRequestClientFactory#connect&lt;/tt&gt; and it will eventually fail the task.&lt;/p&gt;

&lt;p&gt;But &lt;tt&gt;PartitionRequestClientFactory&lt;/tt&gt; lives in a task manager not in a task. In &lt;tt&gt;PartitionRequestClientFactory&lt;/tt&gt; a &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt; named &lt;tt&gt;clients&lt;/tt&gt; is maintained for reusing &lt;tt&gt;NettyPartitionRequestClient&lt;/tt&gt;. When the above exception happens, &lt;tt&gt;clients&lt;/tt&gt; is not cleaned up; When the next call to &lt;tt&gt;PartitionRequestClientFactory#connect&lt;/tt&gt; with the same connection id comes, it will use the invalid &lt;tt&gt;CompletableFuture&lt;/tt&gt; in &lt;tt&gt;clients&lt;/tt&gt; and this future will never complete, causing the task to stuck forever.&lt;/p&gt;

&lt;p&gt;Exception stack:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-08-05 03:37:07,539 ERROR org.apache.flink.runtime.io.network.netty.PartitionRequestClientFactory [] - Failed 1 times to connect to &amp;lt;host-name&amp;gt;/&amp;lt;ip&amp;gt;:&amp;lt;port&amp;gt;
org.apache.flink.runtime.io.network.netty.exception.RemoteTransportException: Connecting to remote task manager &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;host-name&amp;gt;/&amp;lt;ip&amp;gt;:&amp;lt;port&amp;gt;&apos;&lt;/span&gt; has failed. This might indicate that the remote task manager has been lost.
	at org.apache.flink.runtime.io.network.netty.PartitionRequestClientFactory.connect(PartitionRequestClientFactory.java:120) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.netty.PartitionRequestClientFactory.connectWithRetries(PartitionRequestClientFactory.java:99) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.netty.PartitionRequestClientFactory.createPartitionRequestClient(PartitionRequestClientFactory.java:76) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.netty.NettyConnectionManager.createPartitionRequestClient(NettyConnectionManager.java:67) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.RemoteInputChannel.requestSubpartition(RemoteInputChannel.java:146) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.internalRequestPartitions(SingleInputGate.java:329) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.requestPartitions(SingleInputGate.java:301) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.taskmanager.InputGateWithMetrics.requestPartitions(InputGateWithMetrics.java:95) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.requestPartitions(StreamTask.java:514) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.readRecoveredChannelState(StreamTask.java:484) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$beforeInvoke$0(StreamTask.java:475) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.runThrowing(StreamTaskActionExecutor.java:47) [flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.beforeInvoke(StreamTask.java:469) [flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:522) [flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:721) [flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:546) [flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834) [?:1.8.0_102]
Caused by: java.lang.NullPointerException
	at org.apache.flink.util.Preconditions.checkNotNull(Preconditions.java:58) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.netty.NettyPartitionRequestClient.&amp;lt;init&amp;gt;(NettyPartitionRequestClient.java:73) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	at org.apache.flink.runtime.io.network.netty.PartitionRequestClientFactory.connect(PartitionRequestClientFactory.java:114) ~[flink-dist_2.11-1.12-SNAPSHOT.jar:1.12-SNAPSHOT]
	... 16 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13321023">FLINK-18821</key>
            <summary>Netty client retry mechanism may cause PartitionRequestClientFactory#createPartitionRequestClient to wait infinitely</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="TsReaper">Caizhi Weng</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 5 Aug 2020 06:58:49 +0000</created>
                <updated>Thu, 13 Aug 2020 09:10:39 +0000</updated>
                            <resolved>Wed, 12 Aug 2020 08:30:20 +0000</resolved>
                                    <version>1.10.1</version>
                    <version>1.11.1</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.10.2</fixVersion>
                    <fixVersion>1.11.2</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17171301" author="tsreaper" created="Wed, 5 Aug 2020 07:02:33 +0000"  >&lt;p&gt;cc. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ZhenqiuHuang&quot; class=&quot;user-hover&quot; rel=&quot;ZhenqiuHuang&quot;&gt;ZhenqiuHuang&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17171307" author="kevin.cyj" created="Wed, 5 Aug 2020 07:28:30 +0000"  >&lt;p&gt;I also notice this bug, the issue occurs when tcp channel multiplexing exists&#160;and the connection setup fails.&lt;/p&gt;</comment>
                            <comment id="17171364" author="roman_khachatryan" created="Wed, 5 Aug 2020 09:15:30 +0000"  >&lt;p&gt;I&apos;m able to reproduce this issue with an older version too if the error occurs in&#160;nettyClient.connect (before adding ConnectingChannel listener).&lt;/p&gt;

&lt;p&gt;Added 1.10 and 1.11 to affected versions.&lt;/p&gt;</comment>
                            <comment id="17171378" author="roman_khachatryan" created="Wed, 5 Aug 2020 09:34:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TsReaper&quot; class=&quot;user-hover&quot; rel=&quot;TsReaper&quot;&gt;TsReaper&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;can you confirm that this issue is also present in 1.10?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I reproduced it using the following simple unit test and old&#160;PartitionRequestClientFactory:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test(expected = IOException.class)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testFailureReportedToSubsequentRequests() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
  PartitionRequestClientFactory factory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PartitionRequestClientFactory(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FailingNettyClient(), 2);
  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    factory.createPartitionRequestClient(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConnectionID(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InetSocketAddress(InetAddress.getLocalHost(), 8080), 0));
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
    &lt;span class=&quot;code-comment&quot;&gt;// expected
&lt;/span&gt;  }
  factory.createPartitionRequestClient(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConnectionID(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InetSocketAddress(InetAddress.getLocalHost(), 8080), 0));
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/e3ad391b48b7ffc4a5ebd3717e0f99808522cb28/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/PartitionRequestClientFactoryTest.java#L78&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/e3ad391b48b7ffc4a5ebd3717e0f99808522cb28/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/PartitionRequestClientFactoryTest.java#L78&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17171459" author="kevin.cyj" created="Wed, 5 Aug 2020 12:23:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&#160;I think you are right, the issue is also present in 1.10.&lt;/p&gt;</comment>
                            <comment id="17171514" author="roman_khachatryan" created="Wed, 5 Aug 2020 13:54:40 +0000"  >&lt;p&gt;Thanks for the confirmation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;&#160;and for reporting&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TsReaper&quot; class=&quot;user-hover&quot; rel=&quot;TsReaper&quot;&gt;TsReaper&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I created a&#160;&lt;a href=&quot;https://github.com/apache/flink/pull/13067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;, your feedback is welcomed.&lt;/p&gt;</comment>
                            <comment id="17176163" author="zjwang" created="Wed, 12 Aug 2020 08:30:20 +0000"  >&lt;p&gt;Merged in release-1.10: e581d7f8abeac8951735afeb8d3b90977bf10c0a&lt;br/&gt;
Merged in release-1.11: ded539e85444f9c8d34f88da31784775ed281aba&lt;br/&gt;
Merged in master: 33bdc978a059c50ec55b8f24d40039d13a6b78e7&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 13 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hhgg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>