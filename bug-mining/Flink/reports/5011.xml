<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:52:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20992] Checkpoint cleanup can kill JobMaster</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20992</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;A user reported that cancelling a job can lead to an uncaught exception which kills the &lt;tt&gt;JobMaster&lt;/tt&gt;. The problem seems to be that the &lt;tt&gt;CheckpointsCleaner&lt;/tt&gt; might trigger &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; actions after the job has reached a terminal state and, thus, is shut down. Apparently, we do not properly manage the lifecycles of &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; and checkpoint post clean up actions.&lt;/p&gt;

&lt;p&gt;The uncaught exception is &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask@41554407 rejected from java.util.concurrent.ScheduledThreadPoolExecutor@5d0ec6f7[Terminated, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 25977] at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2063
 at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:830
 at java.util.concurrent.ScheduledThreadPoolExecutor.delayedExecute(ScheduledThreadPoolExecutor.java:326
 at java.util.concurrent.ScheduledThreadPoolExecutor.schedule(ScheduledThreadPoolExecutor.java:533
 at java.util.concurrent.ScheduledThreadPoolExecutor.execute(ScheduledThreadPoolExecutor.java:622
 at java.util.concurrent.Executors$DelegatedExecutorService.execute(Executors.java:668
 at org.apache.flink.runtime.concurrent.ScheduledExecutorServiceAdapter.execute(ScheduledExecutorServiceAdapter.java:62
 at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.scheduleTriggerRequest(CheckpointCoordinator.java:1152
 at org.apache.flink.runtime.checkpoint.CheckpointsCleaner.lambda$cleanCheckpoint$0(CheckpointsCleaner.java:58
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624
 at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748 undefined)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://lists.apache.org/thread.html/r75901008d88163560aabb8ab6fc458cd9d4f19076e03ae85e00f9a3a%40%3Cuser.flink.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/r75901008d88163560aabb8ab6fc458cd9d4f19076e03ae85e00f9a3a%40%3Cuser.flink.apache.org%3E&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13352479">FLINK-20992</key>
            <summary>Checkpoint cleanup can kill JobMaster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 15 Jan 2021 13:07:16 +0000</created>
                <updated>Wed, 8 Sep 2021 07:33:28 +0000</updated>
                            <resolved>Wed, 20 Jan 2021 09:40:58 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.12.2</fixVersion>
                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17267188" author="roman_khachatryan" created="Mon, 18 Jan 2021 11:39:20 +0000"  >&lt;p&gt;I&apos;ve published a simple PR to address the issue directly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, this is not the first time we hit this RejectedExecutionException problem (e.g. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18290&quot; title=&quot;Tests are crashing with exit code 239&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18290&quot;&gt;&lt;del&gt;FLINK-18290&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I think the reason is that the executors used by coordinator aren&apos;t aware of it&apos;s lifecycle.&lt;/p&gt;

&lt;p&gt;So I propose to:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Create executors inside&#160;CheckpointCoordinator (both io &amp;amp; timer thread pools)&lt;/li&gt;
	&lt;li&gt;Check isShutdown() in their error handlers (if yes and it&apos;s&#160;RejectedExecutionException then just log; otherwise delegate to&#160;FatalExitExceptionHandler)&lt;/li&gt;
	&lt;li&gt;(this will allow to remove such RejectedExecutionException checks from coordinator code)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Additionally, I found that during the&#160;shutting down&#160;we don&apos;t wait for checkpoint cleanup to complete (or any other tasks submitted to executors):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
checkpointCoordinatorTimer.shutdownNow() &lt;span class=&quot;code-comment&quot;&gt;// in ExecutionGraph
&lt;/span&gt;scheduledExecutorService.shutdownNow(); &lt;span class=&quot;code-comment&quot;&gt;// in JobManagerSharedServices&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So only currently executing actions will complete, but not any queued.&lt;/p&gt;

&lt;p&gt;I think we SHOULD complete cleanup on shutdown and propose the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Replace shutdownNow with shutdown to allow cleanup to finish&lt;/li&gt;
	&lt;li&gt;Add awaitTermination (with timeout)&lt;/li&gt;
	&lt;li&gt;At least log the result of shutdownNow (list of runnables)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;I&apos;d create separate tickets for the latter two issues.&lt;/p&gt;</comment>
                            <comment id="17267436" author="till.rohrmann" created="Mon, 18 Jan 2021 17:49:31 +0000"  >&lt;p&gt;Thanks for creating this PR &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I agree that there is a lifecycle problem of the &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; and its services. However, I am not sure whether we should harden the exception handling logic or rather make the &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; no longer enqueuing something into the &lt;tt&gt;Executor&lt;/tt&gt; after it is shut down. To me it makes more sense that the &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; which knows about its state is responsible for making sure that we only execute a &lt;tt&gt;Runnable&lt;/tt&gt; if we are still running.&lt;/p&gt;

&lt;p&gt;I think you are also right that we currently don&apos;t wait for the checkpoint cleanup to complete. I think the component responsible for the clean up tasks should make sure that they are completed before shutting down or hand them over to a new owner who is responsible for them. Hence, if the &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; is responsible, then the &lt;tt&gt;CheckpointCoordinator.shutdown&lt;/tt&gt; method should make sure that all checkpoints are cleaned up. Alternatively, &lt;tt&gt;CheckpointCoordinator.shutdown&lt;/tt&gt; could return a &lt;tt&gt;CompletableFuture&lt;/tt&gt; which is completed once everything is cleaned up. Consequently, I wouldn&apos;t make it the responsibility of the exeuctors to make sure that all checkpoints are properly cleaned up by waiting on the completion of all enqueued tasks.&lt;/p&gt;

&lt;p&gt;Both things should be fixed imo.&lt;/p&gt;</comment>
                            <comment id="17267470" author="roman_khachatryan" created="Mon, 18 Jan 2021 19:17:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;To me it makes more sense that the&#160;CheckpointCoordinator&#160;which knows about its state is responsible for making sure that we only execute a&#160;Runnable&#160;if we are still running.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think the current issue can be solved this way by adding a check &lt;b&gt;and synchronized&lt;/b&gt; in&#160;scheduleTriggerRequest;&lt;br/&gt;
 But for cases like &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18290&quot; title=&quot;Tests are crashing with exit code 239&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18290&quot;&gt;&lt;del&gt;FLINK-18290&lt;/del&gt;&lt;/a&gt; it&apos;s not possible as scheduling a callback is done by j.u.c. (e.g. handleAsync).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21015&quot; title=&quot;Wait for checkpoint cleanup completion during shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21015&quot;&gt;FLINK-21015&lt;/a&gt; to implement waiting for cleanup completion (and added your comment there).&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17267775" author="till.rohrmann" created="Tue, 19 Jan 2021 09:25:53 +0000"  >&lt;p&gt;I don&apos;t think that &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18290&quot; title=&quot;Tests are crashing with exit code 239&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18290&quot;&gt;&lt;del&gt;FLINK-18290&lt;/del&gt;&lt;/a&gt; is impossible to solve differently &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;. For example, one could use a &lt;tt&gt;handle&lt;/tt&gt; call in which one first checks whether the &lt;tt&gt;CheckepointCoordinator&lt;/tt&gt; is still running before enqueuing a new runnable into the &lt;tt&gt;timer&lt;/tt&gt; &lt;tt&gt;Executor&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17267826" author="roman_khachatryan" created="Tue, 19 Jan 2021 10:59:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;one could use a&#160;handle&#160;call in which one first checks whether the&#160;CheckepointCoordinator&#160;is still running&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;But checking &lt;b&gt;inside&lt;/b&gt; handle(Async) means checking inside an already &lt;b&gt;submitted&lt;/b&gt; action - i.e. too late:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
coordinatorCheckpointsComplete.handleAsync(x -&amp;gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (executor.isShutdown()) { &lt;span class=&quot;code-comment&quot;&gt;// too late
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// ...
&lt;/span&gt;    }
} , timer);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;Or am I missing something?&lt;/p&gt;</comment>
                            <comment id="17267853" author="till.rohrmann" created="Tue, 19 Jan 2021 12:13:37 +0000"  >&lt;p&gt;If you call &lt;tt&gt;handleAsync&lt;/tt&gt;, then this is the case. However, if you use&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
coordinatorCheckpointsComplete.handle(x -&amp;gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (executor.isShutdown()) { &lt;span class=&quot;code-comment&quot;&gt;// too late
&lt;/span&gt;        timer.execute(() -&amp;gt; foobar());
    }
});
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then you are running in the thread which completed the &lt;tt&gt;coordinatorCheckpointsComplete&lt;/tt&gt;. That&apos;s what I meant with using &lt;tt&gt;handle&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Of course, this has to happen atomically.&lt;/p&gt;</comment>
                            <comment id="17267951" author="roman_khachatryan" created="Tue, 19 Jan 2021 15:01:17 +0000"  >&lt;p&gt;I see what you&apos;re saying. But the current code mostly uses async versions.&#160;For example, in CheckpointCoordinator.startTriggeringCheckpoint there are 4 submissions of future callbacks using timer.&lt;/p&gt;</comment>
                            <comment id="17268019" author="till.rohrmann" created="Tue, 19 Jan 2021 16:36:03 +0000"  >&lt;p&gt;Yes, I am also not saying that we should change it. I just wanted to document that there would also be a different solution approach.&lt;/p&gt;</comment>
                            <comment id="17268478" author="till.rohrmann" created="Wed, 20 Jan 2021 09:40:58 +0000"  >&lt;p&gt;Fixed via &lt;/p&gt;

&lt;p&gt;1.13.0: 2ccbaf35f8171c93ac3fffce1e3fa7607f1f7b78&lt;br/&gt;
1.12.2: 7cac1ab5646bb64c9e3bb00d0abdefc1c30ad4bd&lt;/p&gt;</comment>
                            <comment id="17268491" author="roman_khachatryan" created="Wed, 20 Jan 2021 09:57:52 +0000"  >&lt;p&gt;Thanks for clarifying and reviewing/merging!&lt;/p&gt;

&lt;p&gt;I&apos;ve created&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21053&quot; title=&quot;Prevent potential RejectedExecutionExceptions in CheckpointCoordinator failing JM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21053&quot;&gt;FLINK-21053&lt;/a&gt; where I described both approaches to prevent further such cases.&lt;/p&gt;</comment>
                            <comment id="17268495" author="dawidwys" created="Wed, 20 Jan 2021 10:16:29 +0000"  >&lt;p&gt;I&apos;m afraid this change broke the 1.12 branch: &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=12274&amp;amp;view=results&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=12274&amp;amp;view=results&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13352481">FLINK-20993</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13396087">FLINK-23874</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13297397">FLINK-17073</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13353497">FLINK-21053</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0mmiw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>