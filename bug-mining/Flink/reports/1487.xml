<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5652] Memory leak in AsyncDataStream</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5652</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When async operation timeout is &amp;gt; 0, the number of StreamRecordQueueEntry instances keeps growing.&lt;/p&gt;

&lt;p&gt;It can be easily reproduced with the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  val src: DataStream[Int] = env.fromCollection((1 to Int.MaxValue).iterator)
  
  val asyncFunction = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AsyncFunction[Int, Int] with Serializable {
    override def asyncInvoke(input: Int, collector: AsyncCollector[Int]): Unit = {
      collector.collect(List(input))
    }
  }
  
  AsyncDataStream.unorderedWait(src, asyncFunction, 1, TimeUnit.MINUTES, 1).print()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13038091">FLINK-5652</key>
            <summary>Memory leak in AsyncDataStream</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="dgolubets">Dmitry Golubets</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Jan 2017 11:56:16 +0000</created>
                <updated>Sun, 5 Feb 2017 20:59:46 +0000</updated>
                            <resolved>Sun, 5 Feb 2017 20:59:46 +0000</resolved>
                                    <version>1.3.0</version>
                                    <fixVersion>1.2.1</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15846945" author="stephanewen" created="Tue, 31 Jan 2017 15:11:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann@apache.org&quot;&gt;trohrmann@apache.org&lt;/a&gt; Is this a known issue?&lt;/p&gt;</comment>
                            <comment id="15847121" author="till.rohrmann" created="Tue, 31 Jan 2017 16:57:16 +0000"  >&lt;p&gt;No this is not known to me. Will investigate it. Thanks for reporting the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dgolubets&quot; class=&quot;user-hover&quot; rel=&quot;dgolubets&quot;&gt;dgolubets&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15847162" author="till.rohrmann" created="Tue, 31 Jan 2017 17:27:26 +0000"  >&lt;p&gt;The problem is the following: When defining a timeout the &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; registers a &lt;tt&gt;TriggerTask&lt;/tt&gt; at the &lt;tt&gt;ProcessingTimeService&lt;/tt&gt; which will complete the &lt;tt&gt;StreamRecordQueueEntry&lt;/tt&gt; with a &lt;tt&gt;TimeoutException&lt;/tt&gt;. Since this is a strong reference and there is currently no way to unregister timers, such a &lt;tt&gt;TriggerTask&lt;/tt&gt; can prevent a &lt;tt&gt;StreamRecordQueueEntry&lt;/tt&gt; from being garbage collected (until the &lt;tt&gt;TriggerTask&lt;/tt&gt; has been executed). If we have now a high throughput stream, where each element is quickly processed, and a large timeout (as it is the case with the example job), then we can amass a large number of &lt;tt&gt;TriggerTask&lt;/tt&gt; which refer to actually completed &lt;tt&gt;StreamRecordQueueEntries&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This problem can be mitigated by using &lt;tt&gt;WeakReferences&lt;/tt&gt; but the underlying problem of a potentially large set of useless timers remains. In order to properly solve the problem, I think it would be necessary to unregister timers for already completed &lt;tt&gt;StreamRecordQueueEntries&lt;/tt&gt;. Alternatively, we could register a period &lt;tt&gt;TriggerTask&lt;/tt&gt; which iterates over all &lt;tt&gt;StreamRecordQueueEntries&lt;/tt&gt; and checks which of those have been timed out. That way, we would avoid creating for each &lt;tt&gt;StreamRecordQueueEntry&lt;/tt&gt; a dedicated &lt;tt&gt;TriggerTask&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15851351" author="till.rohrmann" created="Fri, 3 Feb 2017 11:12:04 +0000"  >&lt;p&gt;Actually I think, we can simply register a completion callback on the &lt;tt&gt;StreamRecordQueueEntry&lt;/tt&gt; which cancels the &lt;tt&gt;ScheduledFuture&lt;/tt&gt; of the &lt;tt&gt;TriggerTask&lt;/tt&gt;. Given that the &lt;tt&gt;ProcessingTimeSerivce&lt;/tt&gt; removes the trigger tasks on cancelation, this should fix the problem.&lt;/p&gt;</comment>
                            <comment id="15851882" author="githubbot" created="Fri, 3 Feb 2017 18:32:09 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3264&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5652&quot; title=&quot;Memory leak in AsyncDataStream&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5652&quot;&gt;&lt;del&gt;FLINK-5652&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;asyncIO&amp;#93;&lt;/span&gt; Cancel timers when completing a StreamRecordQueueEntry&lt;/p&gt;

&lt;p&gt;    Whenever a StreamRecordQueueEntry has been completed we no longer need the registered timeout.&lt;br/&gt;
    Therefore, we have to cancel the corresponding ScheduledFuture so that the system knows that&lt;br/&gt;
    it can remove the associated TriggerTask. This is important since the TriggerTask contains a&lt;br/&gt;
    reference on the StreamRecordQueueEntry. Consequently, such a task will prevent the&lt;br/&gt;
    StreamRecordQueueEntry from being garbage collected.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; asyncIOFixTimers&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3264.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3264.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3264&lt;/p&gt;

&lt;hr /&gt;

&lt;hr /&gt;</comment>
                            <comment id="15853358" author="githubbot" created="Sun, 5 Feb 2017 20:55:18 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3264&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Travis passed. Merging this PR.&lt;/p&gt;</comment>
                            <comment id="15853362" author="githubbot" created="Sun, 5 Feb 2017 20:59:03 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3264&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15853363" author="till.rohrmann" created="Sun, 5 Feb 2017 20:59:46 +0000"  >&lt;p&gt;1.3.0: 215776b81a52cd380e8ccabd65da612f77da25e6&lt;br/&gt;
1.2.1: 36c7de1aef7b349b9d66c9d92398f50ebec9d186&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i398mf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>