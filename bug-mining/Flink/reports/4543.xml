<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:49:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19112] No access to metric group in ScalarFunction when optimizing</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19112</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Under some circumstances, I cannot access &lt;tt&gt;context.getMetricGroup()&lt;/tt&gt; in a &lt;tt&gt;ScalarFunction&lt;/tt&gt; like this (full job attached):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyUDF &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ScalarFunction {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void open(FunctionContext context) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.open(context);
      context.getMetricGroup();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; eval(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; id) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; id;
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which leads to this exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.UnsupportedOperationException: getMetricGroup is not supported when optimizing
	at org.apache.flink.table.planner.codegen.ConstantFunctionContext.getMetricGroup(ExpressionReducer.scala:249)
	at com.ververica.MetricsGroupBug$MyUDF.open(MetricsGroupBug.java:57)
	at ExpressionReducer$2.open(Unknown Source)
	at org.apache.flink.table.planner.codegen.ExpressionReducer.reduce(ExpressionReducer.scala:118)
	at org.apache.calcite.rel.rules.ReduceExpressionsRule.reduceExpressionsInternal(ReduceExpressionsRule.java:696)
	at org.apache.calcite.rel.rules.ReduceExpressionsRule.reduceExpressions(ReduceExpressionsRule.java:618)
	at org.apache.calcite.rel.rules.ReduceExpressionsRule$ProjectReduceExpressionsRule.onMatch(ReduceExpressionsRule.java:303)
	at org.apache.calcite.plan.AbstractRelOptPlanner.fireRule(AbstractRelOptPlanner.java:328)
	at org.apache.calcite.plan.hep.HepPlanner.applyRule(HepPlanner.java:562)
	at org.apache.calcite.plan.hep.HepPlanner.applyRules(HepPlanner.java:427)
	at org.apache.calcite.plan.hep.HepPlanner.executeInstruction(HepPlanner.java:264)
	at org.apache.calcite.plan.hep.HepInstruction$RuleInstance.execute(HepInstruction.java:127)
	at org.apache.calcite.plan.hep.HepPlanner.executeProgram(HepPlanner.java:223)
	at org.apache.calcite.plan.hep.HepPlanner.findBestExp(HepPlanner.java:210)
	at org.apache.flink.table.planner.plan.optimize.program.FlinkHepProgram.optimize(FlinkHepProgram.scala:69)
	at org.apache.flink.table.planner.plan.optimize.program.FlinkHepRuleSetProgram.optimize(FlinkHepRuleSetProgram.scala:87)
	at org.apache.flink.table.planner.plan.optimize.program.FlinkChainedProgram.$anonfun$optimize$1(FlinkChainedProgram.scala:62)
	at scala.collection.TraversableOnce.$anonfun$foldLeft$1(TraversableOnce.scala:156)
	at scala.collection.TraversableOnce.$anonfun$foldLeft$1$adapted(TraversableOnce.scala:156)
	at scala.collection.Iterator.foreach(Iterator.scala:937)
	at scala.collection.Iterator.foreach$(Iterator.scala:937)
	at scala.collection.AbstractIterator.foreach(Iterator.scala:1425)
	at scala.collection.IterableLike.foreach(IterableLike.scala:70)
	at scala.collection.IterableLike.foreach$(IterableLike.scala:69)
	at scala.collection.AbstractIterable.foreach(Iterable.scala:54)
	at scala.collection.TraversableOnce.foldLeft(TraversableOnce.scala:156)
	at scala.collection.TraversableOnce.foldLeft$(TraversableOnce.scala:154)
	at scala.collection.AbstractTraversable.foldLeft(Traversable.scala:104)
	at org.apache.flink.table.planner.plan.optimize.program.FlinkChainedProgram.optimize(FlinkChainedProgram.scala:58)
	at org.apache.flink.table.planner.plan.optimize.StreamCommonSubGraphBasedOptimizer.optimizeTree(StreamCommonSubGraphBasedOptimizer.scala:164)
	at org.apache.flink.table.planner.plan.optimize.StreamCommonSubGraphBasedOptimizer.doOptimize(StreamCommonSubGraphBasedOptimizer.scala:84)
	at org.apache.flink.table.planner.plan.optimize.CommonSubGraphBasedOptimizer.optimize(CommonSubGraphBasedOptimizer.scala:77)
	at org.apache.flink.table.planner.delegation.PlannerBase.optimize(PlannerBase.scala:279)
	at org.apache.flink.table.planner.delegation.PlannerBase.translate(PlannerBase.scala:164)
	at org.apache.flink.table.api.internal.TableEnvironmentImpl.translate(TableEnvironmentImpl.java:1264)
	at org.apache.flink.table.api.internal.TableEnvironmentImpl.executeInternal(TableEnvironmentImpl.java:700)
	at org.apache.flink.table.api.internal.TableImpl.executeInsert(TableImpl.java:565)
	at org.apache.flink.table.api.internal.TableImpl.executeInsert(TableImpl.java:549)
	at com.ververica.MetricsGroupBug.main(MetricsGroupBug.java:50)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I also tried to work around this with a try-catch, assuming that this method is called once during optimisation and another time at runtime. However, it seems as if &lt;tt&gt;open()&lt;/tt&gt; is actually only called once (during optimization) thus giving me no choice to access the metrics group.&lt;/p&gt;

&lt;p&gt;It seems that removing the where condition before my UDF call also fixes it but it shouldn&apos;t be that way...&lt;/p&gt;</description>
                <environment></environment>
        <key id="13325553">FLINK-19112</key>
            <summary>No access to metric group in ScalarFunction when optimizing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="twalthr">Timo Walther</assignee>
                                    <reporter username="nkruber">Nico Kruber</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 1 Sep 2020 16:26:51 +0000</created>
                <updated>Wed, 9 Sep 2020 07:26:30 +0000</updated>
                            <resolved>Wed, 9 Sep 2020 07:26:30 +0000</resolved>
                                    <version>1.11.1</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17188637" author="twalthr" created="Tue, 1 Sep 2020 16:50:45 +0000"  >&lt;p&gt;Can you check if the problem exists if you set `isDetermistic` to false?&lt;/p&gt;</comment>
                            <comment id="17188641" author="twalthr" created="Tue, 1 Sep 2020 16:56:32 +0000"  >&lt;p&gt;I guess the optimizer is smart and calls `function(0)` already during pre-flight phase. So the function will not be called anymore during runtime. Let&apos;s improve the documentation again to make this process clearer. I will assign this issue to me.&lt;/p&gt;</comment>
                            <comment id="17188643" author="nicok" created="Tue, 1 Sep 2020 16:57:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; that seems to work&lt;/p&gt;</comment>
                            <comment id="17188647" author="nicok" created="Tue, 1 Sep 2020 17:01:49 +0000"  >&lt;p&gt;oh, yes, I basically just need to use a field that is non-constant (I actually don&apos;t care about this field for my purpose). I definitely need to call the function for every element though (and need to access the metric group). In that case, my function is non-deterministic!&lt;/p&gt;

&lt;p&gt;I&apos;m not sure I would have looked into the docs after seeing that the exception explicitly stated this is not supported. Maybe extend the exception message instead?&lt;/p&gt;</comment>
                            <comment id="17189006" author="jark" created="Wed, 2 Sep 2020 05:57:05 +0000"  >&lt;p&gt;I think we can have a mock MetricGroup (maybe &lt;tt&gt;UnregisteredMetricsGroup&lt;/tt&gt;) to avoid this exception?&lt;/p&gt;</comment>
                            <comment id="17189037" author="twalthr" created="Wed, 2 Sep 2020 07:18:14 +0000"  >&lt;p&gt;I was thinking about giving a more helpful exception as well. But yes a mock MetricGroup sounds good to me as well. Together with better documentation about ExpressionReduction in the implementation guide&lt;/p&gt;</comment>
                            <comment id="17189047" author="dawidwys" created="Wed, 2 Sep 2020 07:49:19 +0000"  >&lt;p&gt;Just throwing in another idea.&lt;/p&gt;

&lt;p&gt;How about catching all exceptions in the expression reducer. If the UDF throws an exception consider it not reducible.&lt;/p&gt;</comment>
                            <comment id="17189137" author="nicok" created="Wed, 2 Sep 2020 10:27:31 +0000"  >&lt;p&gt;A mock MetricGroup has the disadvantage that the user doesn&apos;t immediately see that their optimised function doesn&apos;t actually produce any metrics anymore...but accompanied with a WARN in the logs, this should be fine as the function may have been optimised in some incarnations but not in others and both should just work.&lt;/p&gt;

&lt;p&gt;Catching the exception and then not optimising sounds compelling at first, but I&apos;m not sure it helps much in the general case: you&apos;d at least have to clean up after the failed &lt;tt&gt;open()&lt;/tt&gt; call, but then we don&apos;t actually know which state the UDF object is in. This may also hide other errors that were not expected / should be fixed (both in user code and framework code).&lt;/p&gt;</comment>
                            <comment id="17192695" author="twalthr" created="Wed, 9 Sep 2020 07:26:30 +0000"  >&lt;p&gt;Fixed in 1.12.0: 8a61d10433e26bdd9b044e29445e0f1d14b6df9c&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19112&quot; title=&quot;No access to metric group in ScalarFunction when optimizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19112&quot;&gt;&lt;del&gt;FLINK-19112&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Improve usability during constant expression reduction&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Throw more meaningful exceptions.&lt;/li&gt;
	&lt;li&gt;Make metrics a no-op instead of throwing an exception.&lt;/li&gt;
	&lt;li&gt;Use job parameters instead of entire configuration.&lt;/li&gt;
	&lt;li&gt;Give meaningful exception for getExternalResourceInfos instead of NPE&lt;/li&gt;
	&lt;li&gt;Add more documentation at various locations&lt;/li&gt;
	&lt;li&gt;Skip expression reduction in case of an exception&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="13010854" name="MetricsGroupBug.java" size="2189" author="nkruber" created="Tue, 1 Sep 2020 16:22:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 9 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0i9b4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>