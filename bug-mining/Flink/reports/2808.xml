<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:38:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9552] NPE in SpanningRecordSerializer during checkpoint with iterations</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9552</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We&apos;re encountering NPE intermittently&#160;inside SpanningRecordSerializer during checkpoint.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-06-08 08:31:35,741 [ka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-83] INFO  o.a.f.r.e.ExecutionGraph IterationSource-22 (44/120) (c1b94ef849db0e5fb9fb7b85c17073ce) switched from RUNNING to FAILED.
java.lang.RuntimeException
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:110)
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.collect(RecordWriterOutput.java:89)
	at org.apache.flink.streaming.runtime.tasks.StreamIterationHead.run(StreamIterationHead.java:91)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:306)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:703)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.NullPointerException
	at org.apache.flink.runtime.io.network.api.serialization.SpanningRecordSerializer.addRecord(SpanningRecordSerializer.java:98)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.sendToTarget(RecordWriter.java:129)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.emit(RecordWriter.java:105)
	at org.apache.flink.streaming.runtime.io.StreamRecordWriter.emit(StreamRecordWriter.java:81)
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:107)
	... 5 more
2018-06-08 08:31:35,746 [ka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-83] INFO  o.a.f.r.e.ExecutionGraph Job xxx (8a4eaf02c46dc21c7d6f3f70657dbb17) switched from state RUNNING to FAILING.
java.lang.RuntimeException
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:110)
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.collect(RecordWriterOutput.java:89)
	at org.apache.flink.streaming.runtime.tasks.StreamIterationHead.run(StreamIterationHead.java:91)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:306)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:703)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.NullPointerException
	at org.apache.flink.runtime.io.network.api.serialization.SpanningRecordSerializer.addRecord(SpanningRecordSerializer.java:98)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.sendToTarget(RecordWriter.java:129)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.emit(RecordWriter.java:105)
	at org.apache.flink.streaming.runtime.io.StreamRecordWriter.emit(StreamRecordWriter.java:81)
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:107)
	... 5 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This issue is probably concurrency related, because the revelant Flink code seems to have proper null checking&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/fa024726bb801fc71cec5cc303cac1d4a03f555e/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/serialization/SpanningRecordSerializer.java#L98&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/fa024726bb801fc71cec5cc303cac1d4a03f555e/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/serialization/SpanningRecordSerializer.java#L98&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Copy from intermediate buffers to current target memory segment
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (targetBuffer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    targetBuffer.append(lengthBuffer);
    targetBuffer.append(dataBuffer);
    targetBuffer.commit();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13164837">FLINK-9552</key>
            <summary>NPE in SpanningRecordSerializer during checkpoint with iterations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkruber">Nico Kruber</assignee>
                                    <reporter username="kien_truong">Truong Duc Kien</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 8 Jun 2018 02:13:23 +0000</created>
                <updated>Mon, 10 Dec 2018 15:02:39 +0000</updated>
                            <resolved>Mon, 10 Dec 2018 15:02:39 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.8.0</fixVersion>
                                    <component>API / Type Serialization System</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16513890" author="till.rohrmann" created="Fri, 15 Jun 2018 14:35:15 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kien_truong&quot; class=&quot;user-hover&quot; rel=&quot;kien_truong&quot;&gt;kien_truong&lt;/a&gt;, Flink currently does not fully support checkpointing of cyclic topologies. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3257&quot; title=&quot;Add Exactly-Once Processing Guarantees in Iterative DataStream Jobs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3257&quot;&gt;&lt;del&gt;FLINK-3257&lt;/del&gt;&lt;/a&gt; for more information. Part of it is that the streaming iteration tasks don&apos;t honour the checkpoint lock. That&apos;s why we see the NPE because a concurrent checkpointing operation can reset the &lt;tt&gt;targetBuffer&lt;/tt&gt; in &lt;tt&gt;SpanningRecordSerializer&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;Since this is a known limitation, I will unblock &lt;tt&gt;1.6.0&lt;/tt&gt; from this issue.&lt;/p&gt;</comment>
                            <comment id="16514674" author="kien_truong" created="Sat, 16 Jun 2018 04:26:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3257&quot; title=&quot;Add Exactly-Once Processing Guarantees in Iterative DataStream Jobs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3257&quot;&gt;&lt;del&gt;FLINK-3257&lt;/del&gt;&lt;/a&gt; seems to stall, is there any short term work-around to for this if we can tolerate lost messages ?&lt;/p&gt;</comment>
                            <comment id="16514698" author="till.rohrmann" created="Sat, 16 Jun 2018 06:25:59 +0000"  >&lt;p&gt;You could add the checkpoint lock around the &lt;tt&gt;collect&lt;/tt&gt; statement in the emission loop in &lt;tt&gt;StreamIterationHead&lt;/tt&gt;. But this would require that you have your own patched version of Flink.&lt;/p&gt;</comment>
                            <comment id="16669883" author="githubbot" created="Wed, 31 Oct 2018 10:18:10 +0000"  >&lt;p&gt;NicoK opened a new pull request #6971: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9552&quot; title=&quot;NPE in SpanningRecordSerializer during checkpoint with iterations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9552&quot;&gt;&lt;del&gt;FLINK-9552&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;iterations&amp;#93;&lt;/span&gt; fix not syncing on checkpoint lock before emitting records&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6971&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6971&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   We need to make sure that concurrent access to the `RecordWriter` is protected by a lock or otherwise if multiple threads access a `RecordWriter` instance at the same time, we may get into any type of data corruption which may not be recognised immediately.&lt;/p&gt;

&lt;p&gt;   It seems that everything but the `StreamIterationHead` was synchronizing on the checkpoint lock and hence we should sync here as well.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;adapt `StreamIterationHead` to synchronize on the checkpoint lock when emitting records, watermarks, etc.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change is already covered by existing tests, and was tested manually by adding a check that `RecordWriter` interactions hold the checkpoint lock (by default, the `RecordWriter` does not know about this lock).&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The serializers: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): *&lt;b&gt;yes&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? *&lt;b&gt;not applicable&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16714850" author="githubbot" created="Mon, 10 Dec 2018 15:02:27 +0000"  >&lt;p&gt;tillrohrmann closed pull request #6971: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9552&quot; title=&quot;NPE in SpanningRecordSerializer during checkpoint with iterations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9552&quot;&gt;&lt;del&gt;FLINK-9552&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;iterations&amp;#93;&lt;/span&gt; fix not syncing on checkpoint lock before emitting records&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6971&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6971&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamIterationHead.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamIterationHead.java&lt;br/&gt;
index c54235cc349..ecef7f0f207 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamIterationHead.java&lt;br/&gt;
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamIterationHead.java&lt;br/&gt;
@@ -76,8 +76,10 @@ protected void run() throws Exception {&lt;/p&gt;

&lt;p&gt; 			// If timestamps are enabled we make sure to remove cyclic watermark dependencies&lt;br/&gt;
 			if (isSerializingTimestamps()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (RecordWriterOutput&amp;lt;OUT&amp;gt; output : outputs) {&lt;/li&gt;
	&lt;li&gt;output.emitWatermark(new Watermark(Long.MAX_VALUE));&lt;br/&gt;
+				synchronized (getCheckpointLock()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+					for (RecordWriterOutput&amp;lt;OUT&amp;gt; output }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; 			}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -87,8 +89,10 @@ protected void run() throws Exception {&lt;br/&gt;
 					dataChannel.take();&lt;/p&gt;

&lt;p&gt; 				if (nextRecord != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (RecordWriterOutput&amp;lt;OUT&amp;gt; output : outputs) {&lt;/li&gt;
	&lt;li&gt;output.collect(nextRecord);&lt;br/&gt;
+					synchronized (getCheckpointLock()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+						for (RecordWriterOutput&amp;lt;OUT&amp;gt; output }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; 				}&lt;br/&gt;
 				else {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16714851" author="till.rohrmann" created="Mon, 10 Dec 2018 15:02:39 +0000"  >&lt;p&gt;Fixed via &lt;a href=&quot;https://github.com/apache/flink/commit/03828308e75a19a777b7c999bd5bc9b09388daa2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/03828308e75a19a777b7c999bd5bc9b09388daa2&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12932215">FLINK-3257</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3un8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>