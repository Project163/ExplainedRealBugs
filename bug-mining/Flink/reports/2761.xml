<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:36:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10842] Waiting loops are broken in e2e/common.sh</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10842</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;There are 3 loops in flink-end-to-end-tests/test-scripts/common.sh where the script waits for some event to happen (for i in {1..10}; do):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;wait_dispatcher_running&lt;/li&gt;
	&lt;li&gt;start_and_wait_for_tm&lt;/li&gt;
	&lt;li&gt;wait_job_running&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;All loops have 10 iterations and the loop breaks if the awaited&#160;event&#160;happens. If timeout occurs then&#160;the script does not fail&#160;and the function just continues after 10 iterations ignoring that the&#160;awaited&#160;event did not happen.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13197411">FLINK-10842</key>
            <summary>Waiting loops are broken in e2e/common.sh</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="azagrebin">Andrey Zagrebin</assignee>
                                    <reporter username="azagrebin">Andrey Zagrebin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 9 Nov 2018 13:49:33 +0000</created>
                <updated>Thu, 27 Mar 2025 06:26:09 +0000</updated>
                            <resolved>Mon, 3 Dec 2018 15:51:09 +0000</resolved>
                                    <version>1.7.0</version>
                                    <fixVersion>1.6.3</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Test Infrastructure</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16681462" author="githubbot" created="Fri, 9 Nov 2018 13:58:19 +0000"  >&lt;p&gt;azagrebin opened a new pull request #7073: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7073&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   There are 3 loops in flink-end-to-end-tests/test-scripts/common.sh where the script waits for some event to happen (for i in &lt;/p&gt;
{1..10}
&lt;p&gt;; do):&lt;/p&gt;

&lt;p&gt;   wait_dispatcher_running&lt;br/&gt;
   start_and_wait_for_tm&lt;br/&gt;
   wait_job_running&lt;/p&gt;

&lt;p&gt;   This PR changes them to fail if the expected event has not happened and to return from the loop if happened.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;change waiting loops in common.sh&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Run any relevant e2e tests&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16681463" author="githubbot" created="Fri, 9 Nov 2018 13:58:28 +0000"  >&lt;p&gt;azagrebin commented on issue #7073: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7073#issuecomment-437367164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7073#issuecomment-437367164&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   cc @zentol &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685178" author="githubbot" created="Tue, 13 Nov 2018 13:18:50 +0000"  >&lt;p&gt;twalthr commented on a change in pull request #7073: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7073#discussion_r233032145&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7073#discussion_r233032145&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -401,7 +406,7 @@ function wait_for_job_state_transition {&lt;br/&gt;
   echo &quot;Waiting for job ($job) to switch from state ${initial_state} to state ${next_state} ...&quot;&lt;/p&gt;

&lt;p&gt;   while : ; do&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;N=$(grep -o &quot;($job) switched from state ${initial_state} to ${next_state}&quot; $FLINK_DIR/log/&lt;b&gt;standalonesession&lt;/b&gt;.log | tail -1)&lt;br/&gt;
+    N=$(grep -o &quot;($job) switched from state ${initial_state} to wait_dispatcher_running${next_state}&quot; $FLINK_DIR/log/&lt;b&gt;standalonesession&lt;/b&gt;.log | tail -1)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Is this change intended?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16685179" author="githubbot" created="Tue, 13 Nov 2018 13:18:50 +0000"  >&lt;p&gt;twalthr commented on a change in pull request #7073: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7073#discussion_r233032688&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7073#discussion_r233032688&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -412,17 +417,20 @@ function wait_for_job_state_transition {&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt; function wait_job_running {&lt;br/&gt;
+  local TIMEOUT=10&lt;br/&gt;
   for i in &lt;/p&gt;
{1..10}
&lt;p&gt;; do&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Variable not used in loop.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16696053" author="githubbot" created="Thu, 22 Nov 2018 15:59:54 +0000"  >&lt;p&gt;twalthr commented on a change in pull request #7073: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7073#discussion_r235771819&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7073#discussion_r235771819&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -242,30 +245,45 @@ function start_taskmanagers {&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt; function start_and_wait_for_tm {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;local url=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;tm_query_result=$(curl ${CURL_SSL_ARGS} -s &quot;${url}&quot;)&lt;br/&gt;
-&lt;br/&gt;
+  tm_query_result=`query_running_tms`&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;we assume that the cluster is running&lt;br/&gt;
   if ! [[ ${tm_query_result} =~ {\&quot;taskmanagers\&quot;:[.*]} ]]; then&lt;br/&gt;
     echo &quot;Your cluster seems to be unresponsive at the moment: ${tm_query_result}&quot; 1&amp;gt;&amp;amp;2&lt;br/&gt;
     exit 1&lt;br/&gt;
   fi&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;running_tms=`curl ${CURL_SSL_ARGS} -s &quot;${url}&quot; | grep -o &quot;id&quot; | wc -l`&lt;br/&gt;
-&lt;br/&gt;
+  running_tms=`query_number_of_running_tms`&lt;br/&gt;
   ${FLINK_DIR}/bin/taskmanager.sh start&lt;br/&gt;
+  wait_for_number_of_running_tms $((running_tms+1))&lt;br/&gt;
+}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for i in 
{1..10}
&lt;p&gt;; do&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;local new_running_tms=`curl ${CURL_SSL_ARGS} -s &quot;${url}&quot; | grep -o &quot;id&quot; | wc -l`&lt;/li&gt;
	&lt;li&gt;if [ $((new_running_tms-running_tms)) -eq 0 ]; then&lt;/li&gt;
	&lt;li&gt;echo &quot;TaskManager is not yet up.&quot;&lt;br/&gt;
+function query_running_tms {&lt;br/&gt;
+  local url=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
+  curl ${CURL_SSL_ARGS} -s &quot;${url}&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Could it be possible that this requests fails and crashes a script that has `set -e` enabled? Should we put a `|| true` at the end?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16696054" author="githubbot" created="Thu, 22 Nov 2018 15:59:54 +0000"  >&lt;p&gt;twalthr commented on a change in pull request #7073: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7073#discussion_r235772194&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7073#discussion_r235772194&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -242,30 +245,45 @@ function start_taskmanagers {&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt; function start_and_wait_for_tm {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;local url=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;tm_query_result=$(curl ${CURL_SSL_ARGS} -s &quot;${url}&quot;)&lt;br/&gt;
-&lt;br/&gt;
+  tm_query_result=`query_running_tms`&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;we assume that the cluster is running&lt;br/&gt;
   if ! [[ ${tm_query_result} =~ {\&quot;taskmanagers\&quot;:[.*]} ]]; then&lt;br/&gt;
     echo &quot;Your cluster seems to be unresponsive at the moment: ${tm_query_result}&quot; 1&amp;gt;&amp;amp;2&lt;br/&gt;
     exit 1&lt;br/&gt;
   fi&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;running_tms=`curl ${CURL_SSL_ARGS} -s &quot;${url}&quot; | grep -o &quot;id&quot; | wc -l`&lt;br/&gt;
-&lt;br/&gt;
+  running_tms=`query_number_of_running_tms`&lt;br/&gt;
   ${FLINK_DIR}/bin/taskmanager.sh start&lt;br/&gt;
+  wait_for_number_of_running_tms $((running_tms+1))&lt;br/&gt;
+}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for i in 
{1..10}
&lt;p&gt;; do&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;local new_running_tms=`curl ${CURL_SSL_ARGS} -s &quot;${url}&quot; | grep -o &quot;id&quot; | wc -l`&lt;/li&gt;
	&lt;li&gt;if [ $((new_running_tms-running_tms)) -eq 0 ]; then&lt;/li&gt;
	&lt;li&gt;echo &quot;TaskManager is not yet up.&quot;&lt;br/&gt;
+function query_running_tms {&lt;br/&gt;
+  local url=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
+  curl ${CURL_SSL_ARGS} -s &quot;${url}&quot;&lt;br/&gt;
+}&lt;br/&gt;
+&lt;br/&gt;
+function query_number_of_running_tms {&lt;br/&gt;
+  query_running_tms | grep -o &quot;id&quot; | wc -l&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Same concern here. `grep -o` can throw an error that should be caught.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16696161" author="githubbot" created="Thu, 22 Nov 2018 17:49:40 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #7073: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7073#discussion_r235796341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7073#discussion_r235796341&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -242,30 +245,45 @@ function start_taskmanagers {&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt; function start_and_wait_for_tm {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;local url=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;tm_query_result=$(curl ${CURL_SSL_ARGS} -s &quot;${url}&quot;)&lt;br/&gt;
-&lt;br/&gt;
+  tm_query_result=`query_running_tms`&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;we assume that the cluster is running&lt;br/&gt;
   if ! [[ ${tm_query_result} =~ {\&quot;taskmanagers\&quot;:[.*]} ]]; then&lt;br/&gt;
     echo &quot;Your cluster seems to be unresponsive at the moment: ${tm_query_result}&quot; 1&amp;gt;&amp;amp;2&lt;br/&gt;
     exit 1&lt;br/&gt;
   fi&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;running_tms=`curl ${CURL_SSL_ARGS} -s &quot;${url}&quot; | grep -o &quot;id&quot; | wc -l`&lt;br/&gt;
-&lt;br/&gt;
+  running_tms=`query_number_of_running_tms`&lt;br/&gt;
   ${FLINK_DIR}/bin/taskmanager.sh start&lt;br/&gt;
+  wait_for_number_of_running_tms $((running_tms+1))&lt;br/&gt;
+}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for i in 
{1..10}
&lt;p&gt;; do&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;local new_running_tms=`curl ${CURL_SSL_ARGS} -s &quot;${url}&quot; | grep -o &quot;id&quot; | wc -l`&lt;/li&gt;
	&lt;li&gt;if [ $((new_running_tms-running_tms)) -eq 0 ]; then&lt;/li&gt;
	&lt;li&gt;echo &quot;TaskManager is not yet up.&quot;&lt;br/&gt;
+function query_running_tms {&lt;br/&gt;
+  local url=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
+  curl ${CURL_SSL_ARGS} -s &quot;${url}&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   We check before (line 250) that cluster is running and responses correctly.&lt;br/&gt;
   I would assume we do not expect this commands to fail.&lt;br/&gt;
   If something is wrong with querying cluster, the script should fail fast, wdyt?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16696615" author="githubbot" created="Fri, 23 Nov 2018 10:06:53 +0000"  >&lt;p&gt;twalthr commented on a change in pull request #7073: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7073#discussion_r235892506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7073#discussion_r235892506&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -242,30 +245,45 @@ function start_taskmanagers {&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt; function start_and_wait_for_tm {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;local url=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;tm_query_result=$(curl ${CURL_SSL_ARGS} -s &quot;${url}&quot;)&lt;br/&gt;
-&lt;br/&gt;
+  tm_query_result=`query_running_tms`&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;we assume that the cluster is running&lt;br/&gt;
   if ! [[ ${tm_query_result} =~ {\&quot;taskmanagers\&quot;:[.*]} ]]; then&lt;br/&gt;
     echo &quot;Your cluster seems to be unresponsive at the moment: ${tm_query_result}&quot; 1&amp;gt;&amp;amp;2&lt;br/&gt;
     exit 1&lt;br/&gt;
   fi&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;running_tms=`curl ${CURL_SSL_ARGS} -s &quot;${url}&quot; | grep -o &quot;id&quot; | wc -l`&lt;br/&gt;
-&lt;br/&gt;
+  running_tms=`query_number_of_running_tms`&lt;br/&gt;
   ${FLINK_DIR}/bin/taskmanager.sh start&lt;br/&gt;
+  wait_for_number_of_running_tms $((running_tms+1))&lt;br/&gt;
+}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for i in 
{1..10}
&lt;p&gt;; do&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;local new_running_tms=`curl ${CURL_SSL_ARGS} -s &quot;${url}&quot; | grep -o &quot;id&quot; | wc -l`&lt;/li&gt;
	&lt;li&gt;if [ $((new_running_tms-running_tms)) -eq 0 ]; then&lt;/li&gt;
	&lt;li&gt;echo &quot;TaskManager is not yet up.&quot;&lt;br/&gt;
+function query_running_tms {&lt;br/&gt;
+  local url=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
+  curl ${CURL_SSL_ARGS} -s &quot;${url}&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Yes, that makes sense to me. Thanks for the clarification.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16696617" author="githubbot" created="Fri, 23 Nov 2018 10:07:18 +0000"  >&lt;p&gt;twalthr commented on issue #7073: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7073#issuecomment-441199627&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7073#issuecomment-441199627&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for the update @azagrebin. I will merge this...&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16696646" author="githubbot" created="Fri, 23 Nov 2018 10:34:24 +0000"  >&lt;p&gt;asfgit closed pull request #7073: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7073&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-end-to-end-tests/test-scripts/common.sh b/flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
index 275d9c49f4b..645cf2a2f1e 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
@@ -212,19 +212,22 @@ function start_local_zk {&lt;br/&gt;
 function wait_dispatcher_running {&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;wait at most 10 seconds until the dispatcher is up&lt;br/&gt;
   local QUERY_URL=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for i in 
{1..10}; do&lt;br/&gt;
+  local TIMEOUT=10&lt;br/&gt;
+  for i in $(seq 1 ${TIMEOUT}); do&lt;br/&gt;
     # without the || true this would exit our script if the JobManager is not yet up&lt;br/&gt;
     QUERY_RESULT=$(curl ${CURL_SSL_ARGS} &quot;$QUERY_URL&quot; 2&amp;gt; /dev/null || true)&lt;br/&gt;
 &lt;br/&gt;
     # ensure the taskmanagers field is there at all and is not empty&lt;br/&gt;
     if [[ ${QUERY_RESULT} =~ {\&quot;taskmanagers\&quot;:[.+]} ]]; then&lt;br/&gt;
       echo &quot;Dispatcher REST endpoint is up.&quot;&lt;br/&gt;
-      break&lt;br/&gt;
+      return&lt;br/&gt;
     fi&lt;br/&gt;
 &lt;br/&gt;
     echo &quot;Waiting for dispatcher REST endpoint to come up...&quot;&lt;br/&gt;
     sleep 1&lt;br/&gt;
   done&lt;br/&gt;
+  echo &quot;Dispatcher REST endpoint has not started within a timeout of ${TIMEOUT} sec&quot;&lt;br/&gt;
+  exit 1&lt;br/&gt;
 }&lt;br/&gt;
 &lt;br/&gt;
 function start_cluster {&lt;br/&gt;
@@ -242,30 +245,45 @@ function start_taskmanagers {&lt;br/&gt;
 }&lt;br/&gt;
 &lt;br/&gt;
 function start_and_wait_for_tm {&lt;br/&gt;
-  local url=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
-&lt;br/&gt;
-  tm_query_result=$(curl ${CURL_SSL_ARGS} -s &quot;${url}&quot;)&lt;br/&gt;
-&lt;br/&gt;
+  tm_query_result=`query_running_tms`&lt;br/&gt;
   # we assume that the cluster is running&lt;br/&gt;
   if ! [[ ${tm_query_result} =~ {\&quot;taskmanagers\&quot;:[.*]} ]]; then&lt;br/&gt;
     echo &quot;Your cluster seems to be unresponsive at the moment: ${tm_query_result}&quot; 1&amp;gt;&amp;amp;2&lt;br/&gt;
     exit 1&lt;br/&gt;
   fi&lt;br/&gt;
 &lt;br/&gt;
-  running_tms=`curl ${CURL_SSL_ARGS} -s &quot;${url}&quot; | grep -o &quot;id&quot; | wc -l`&lt;br/&gt;
-&lt;br/&gt;
+  running_tms=`query_number_of_running_tms`&lt;br/&gt;
   ${FLINK_DIR}/bin/taskmanager.sh start&lt;br/&gt;
+  wait_for_number_of_running_tms $((running_tms+1))&lt;br/&gt;
+}&lt;br/&gt;
 &lt;br/&gt;
-  for i in {1..10}
&lt;p&gt;; do&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;local new_running_tms=`curl ${CURL_SSL_ARGS} -s &quot;${url}&quot; | grep -o &quot;id&quot; | wc -l`&lt;/li&gt;
	&lt;li&gt;if [ $((new_running_tms-running_tms)) -eq 0 ]; then&lt;/li&gt;
	&lt;li&gt;echo &quot;TaskManager is not yet up.&quot;&lt;br/&gt;
+function query_running_tms {&lt;br/&gt;
+  local url=&quot;${REST_PROTOCOL}://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
+  curl ${CURL_SSL_ARGS} -s &quot;${url}&quot;&lt;br/&gt;
+}&lt;br/&gt;
+&lt;br/&gt;
+function query_number_of_running_tms 
{
+  query_running_tms | grep -o &quot;id&quot; | wc -l
+}
&lt;p&gt;+&lt;br/&gt;
+function wait_for_number_of_running_tms {&lt;br/&gt;
+  local TM_NUM_TO_WAIT=${1}&lt;br/&gt;
+  local TIMEOUT_COUNTER=10&lt;br/&gt;
+  local TIMEOUT_INC=4&lt;br/&gt;
+  local TIMEOUT=$(( $TIMEOUT_COUNTER * $TIMEOUT_INC ))&lt;br/&gt;
+  local TM_NUM_TEXT=&quot;Number of running task managers&quot;&lt;br/&gt;
+  for i in $(seq 1 ${TIMEOUT_COUNTER}); do&lt;br/&gt;
+    local TM_NUM=`query_number_of_running_tms`&lt;br/&gt;
+    if [ $((TM_NUM - TM_NUM_TO_WAIT)) -eq 0 ]; then&lt;br/&gt;
+      echo &quot;${TM_NUM_TEXT} has reached ${TM_NUM_TO_WAIT}.&quot;&lt;br/&gt;
+      return&lt;br/&gt;
     else&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;echo &quot;TaskManager is up.&quot;&lt;/li&gt;
	&lt;li&gt;break&lt;br/&gt;
+      echo &quot;${TM_NUM_TEXT} ${TM_NUM} is not yet ${TM_NUM_TO_WAIT}.&quot;&lt;br/&gt;
     fi&lt;/li&gt;
	&lt;li&gt;sleep 4&lt;br/&gt;
+    sleep ${TIMEOUT_INC}&lt;br/&gt;
   done&lt;br/&gt;
+  echo &quot;${TM_NUM_TEXT} has not reached ${TM_NUM_TO_WAIT} within a timeout of ${TIMEOUT} sec&quot;&lt;br/&gt;
+  exit 1&lt;br/&gt;
 }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; function check_logs_for_errors {&lt;br/&gt;
@@ -376,17 +394,20 @@ function wait_for_job_state_transition {&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt; function wait_job_running {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for i in 
{1..10}
&lt;p&gt;; do&lt;br/&gt;
+  local TIMEOUT=10&lt;br/&gt;
+  for i in $(seq 1 ${TIMEOUT}); do&lt;br/&gt;
     JOB_LIST_RESULT=$(&quot;$FLINK_DIR&quot;/bin/flink list -r | grep &quot;$1&quot;)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     if [[ &quot;$JOB_LIST_RESULT&quot; == &quot;&quot; ]]; then&lt;br/&gt;
       echo &quot;Job ($1) is not yet running.&quot;&lt;br/&gt;
     else&lt;br/&gt;
       echo &quot;Job ($1) is running.&quot;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;break&lt;br/&gt;
+      return&lt;br/&gt;
     fi&lt;br/&gt;
     sleep 1&lt;br/&gt;
   done&lt;br/&gt;
+  echo &quot;Job ($1) has not started within a timeout of ${TIMEOUT} sec&quot;&lt;br/&gt;
+  exit 1&lt;br/&gt;
 }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; function wait_job_terminal_state {&lt;br/&gt;
diff --git a/flink-end-to-end-tests/test-scripts/test_queryable_state_restart_tm.sh b/flink-end-to-end-tests/test-scripts/test_queryable_state_restart_tm.sh&lt;br/&gt;
index 56d811e14a1..db0174a2160 100755&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/test-scripts/test_queryable_state_restart_tm.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/test_queryable_state_restart_tm.sh&lt;br/&gt;
@@ -86,6 +86,7 @@ function run_test() {&lt;br/&gt;
     fi&lt;/p&gt;

&lt;p&gt;     kill_random_taskmanager&lt;br/&gt;
+    wait_for_number_of_running_tms 0&lt;/p&gt;

&lt;p&gt;     latest_snapshot_count=$(cat $FLINK_DIR/log/&lt;b&gt;out&lt;/b&gt; | grep &quot;on snapshot&quot; | tail -n 1 | awk &apos;&lt;/p&gt;
{print $4}
&lt;p&gt;&apos;)&lt;br/&gt;
     echo &quot;Latest snapshot count was ${latest_snapshot_count}&quot;&lt;br/&gt;
diff --git a/flink-end-to-end-tests/test-scripts/test_resume_externalized_checkpoints.sh b/flink-end-to-end-tests/test-scripts/test_resume_externalized_checkpoints.sh&lt;br/&gt;
index 35fe30b6b25..48d68c98e9d 100755&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/test-scripts/test_resume_externalized_checkpoints.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/test_resume_externalized_checkpoints.sh&lt;br/&gt;
@@ -100,11 +100,10 @@ fi&lt;/p&gt;

&lt;p&gt; DATASTREAM_JOB=$($JOB_CMD | grep &quot;Job has been submitted with JobID&quot; | sed &apos;s/.* //g&apos;)&lt;/p&gt;

&lt;p&gt;-wait_job_running $DATASTREAM_JOB&lt;br/&gt;
-&lt;br/&gt;
 if [[ $SIMULATE_FAILURE == &quot;true&quot; ]]; then&lt;br/&gt;
   wait_job_terminal_state $DATASTREAM_JOB FAILED&lt;br/&gt;
 else&lt;br/&gt;
+  wait_job_running $DATASTREAM_JOB&lt;br/&gt;
   wait_num_checkpoints $DATASTREAM_JOB 1&lt;br/&gt;
   wait_oper_metric_num_in_records SemanticsCheckMapper.0 200&lt;/p&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16696650" author="twalthr" created="Fri, 23 Nov 2018 10:38:06 +0000"  >&lt;p&gt;Fixed in master: 76afc3193dac7057518f0a8e0481bca6e05c8ea2&lt;br/&gt;
Fixed in 1.7: 73b28a8540e9ba1d52669a7a4f8a2c4d7afbb428&lt;/p&gt;</comment>
                            <comment id="16702184" author="till.rohrmann" created="Wed, 28 Nov 2018 17:43:12 +0000"  >&lt;p&gt;Should we also back port this fix for &lt;tt&gt;release-1.6&lt;/tt&gt; and &lt;tt&gt;release-1.5&lt;/tt&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16707194" author="githubbot" created="Mon, 3 Dec 2018 13:31:29 +0000"  >&lt;p&gt;azagrebin opened a new pull request #7220: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7220&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7220&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   release 1.5 back porting of #7073&lt;br/&gt;
   cc @twalthr &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16707205" author="githubbot" created="Mon, 3 Dec 2018 13:33:16 +0000"  >&lt;p&gt;azagrebin opened a new pull request #7221: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7221&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   release 1.6 back porting of #7073&lt;br/&gt;
   cc @twalthr&lt;br/&gt;
   e2e travis: &lt;a href=&quot;https://travis-ci.org/azagrebin/flink/builds/461823649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/azagrebin/flink/builds/461823649&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16707367" author="githubbot" created="Mon, 3 Dec 2018 15:28:11 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7221: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7221#discussion_r238313039&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7221#discussion_r238313039&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -185,16 +186,19 @@ function set_conf_ssl {&lt;br/&gt;
     echo &quot;Using SAN ${SANSTRING}&quot;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;create certificates&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;keytool -genkeypair -alias ca -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -dname &quot;CN=Sample CA&quot; -storepass password -keypass password -keyalg RSA -ext bc=ca:true&lt;br/&gt;
+    keytool -genkeypair -alias ca -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -dname &quot;CN=Sample CA&quot; -storepass password -keypass password -keyalg RSA -ext bc=ca:true -storetype PKCS12&lt;br/&gt;
     keytool -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -storepass password -alias ca -exportcert &amp;gt; &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot;&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/ca.truststore&quot; -alias ca -storepass password -noprompt -file &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;keytool -genkeypair -alias node -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -dname &quot;CN=${NODENAME}&quot; -ext SAN=${SANSTRING} -storepass password -keypass password -keyalg RSA&lt;br/&gt;
+    keytool -genkeypair -alias node -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -dname &quot;CN=${NODENAME}&quot; -ext SAN=${SANSTRING} -storepass password -keypass password -keyalg RSA -storetype PKCS12&lt;br/&gt;
     keytool -certreq -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -alias node -file &quot;${TEST_DATA_DIR}/ssl/node.csr&quot;&lt;br/&gt;
     keytool -gencert -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -storepass password -alias ca -ext SAN=${SANSTRING} -infile &quot;${TEST_DATA_DIR}/ssl/node.csr&quot; -outfile &quot;${TEST_DATA_DIR}/ssl/node.cer&quot;&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -file &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot; -alias ca -noprompt&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -file &quot;${TEST_DATA_DIR}/ssl/node.cer&quot; -alias node -noprompt&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    # keystore is converted into a pem format to use it as node.pem with curl in Flink REST API queries, see also $CURL_SSL_ARGS&lt;br/&gt;
+    openssl pkcs12 -passin pass:password -in &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -out &quot;${TEST_DATA_DIR}/ssl/node.pem&quot; -nodes&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   This does not seem to be solely a backport of #7073. Why are these changes necessary?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16707380" author="githubbot" created="Mon, 3 Dec 2018 15:42:50 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #7221: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7221#discussion_r238319837&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7221#discussion_r238319837&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -185,16 +186,19 @@ function set_conf_ssl {&lt;br/&gt;
     echo &quot;Using SAN ${SANSTRING}&quot;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;create certificates&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;keytool -genkeypair -alias ca -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -dname &quot;CN=Sample CA&quot; -storepass password -keypass password -keyalg RSA -ext bc=ca:true&lt;br/&gt;
+    keytool -genkeypair -alias ca -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -dname &quot;CN=Sample CA&quot; -storepass password -keypass password -keyalg RSA -ext bc=ca:true -storetype PKCS12&lt;br/&gt;
     keytool -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -storepass password -alias ca -exportcert &amp;gt; &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot;&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/ca.truststore&quot; -alias ca -storepass password -noprompt -file &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;keytool -genkeypair -alias node -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -dname &quot;CN=${NODENAME}&quot; -ext SAN=${SANSTRING} -storepass password -keypass password -keyalg RSA&lt;br/&gt;
+    keytool -genkeypair -alias node -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -dname &quot;CN=${NODENAME}&quot; -ext SAN=${SANSTRING} -storepass password -keypass password -keyalg RSA -storetype PKCS12&lt;br/&gt;
     keytool -certreq -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -alias node -file &quot;${TEST_DATA_DIR}/ssl/node.csr&quot;&lt;br/&gt;
     keytool -gencert -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -storepass password -alias ca -ext SAN=${SANSTRING} -infile &quot;${TEST_DATA_DIR}/ssl/node.csr&quot; -outfile &quot;${TEST_DATA_DIR}/ssl/node.cer&quot;&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -file &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot; -alias ca -noprompt&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -file &quot;${TEST_DATA_DIR}/ssl/node.cer&quot; -alias node -noprompt&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    # keystore is converted into a pem format to use it as node.pem with curl in Flink REST API queries, see also $CURL_SSL_ARGS&lt;br/&gt;
+    openssl pkcs12 -passin pass:password -in &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -out &quot;${TEST_DATA_DIR}/ssl/node.pem&quot; -nodes&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   `start_cluster` uses `query_running_tms` in `common.sh`.&lt;br/&gt;
   `query_running_tms` has to use certs in `curl` command if SSL is enabled (previously it was not a problem because if `&quot;x$USE_SSL&quot; = &quot;xON&quot;` was wrong and used http url but failed curl was ignored in broken timeout&apos;ed waiting loop, I think along with cert exceptions in JM logs).&lt;br/&gt;
   `openssl` generates `node.pem` used with `curl` in `CURL_SSL_ARGS` to properly connect to SSL&apos;ed cluster.&lt;br/&gt;
   `keytool` uses by default deprecated `JKS`, this fact was also logged previously in test run.&lt;br/&gt;
   From what I found for 1.7, `openssl` uses another changed non-deprecated protocol to generate understandable `node.pem` for `curl`.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16707405" author="githubbot" created="Mon, 3 Dec 2018 15:49:31 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #7221: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7221#discussion_r238322811&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7221#discussion_r238322811&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -185,16 +186,19 @@ function set_conf_ssl {&lt;br/&gt;
     echo &quot;Using SAN ${SANSTRING}&quot;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;create certificates&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;keytool -genkeypair -alias ca -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -dname &quot;CN=Sample CA&quot; -storepass password -keypass password -keyalg RSA -ext bc=ca:true&lt;br/&gt;
+    keytool -genkeypair -alias ca -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -dname &quot;CN=Sample CA&quot; -storepass password -keypass password -keyalg RSA -ext bc=ca:true -storetype PKCS12&lt;br/&gt;
     keytool -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -storepass password -alias ca -exportcert &amp;gt; &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot;&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/ca.truststore&quot; -alias ca -storepass password -noprompt -file &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;keytool -genkeypair -alias node -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -dname &quot;CN=${NODENAME}&quot; -ext SAN=${SANSTRING} -storepass password -keypass password -keyalg RSA&lt;br/&gt;
+    keytool -genkeypair -alias node -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -dname &quot;CN=${NODENAME}&quot; -ext SAN=${SANSTRING} -storepass password -keypass password -keyalg RSA -storetype PKCS12&lt;br/&gt;
     keytool -certreq -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -alias node -file &quot;${TEST_DATA_DIR}/ssl/node.csr&quot;&lt;br/&gt;
     keytool -gencert -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -storepass password -alias ca -ext SAN=${SANSTRING} -infile &quot;${TEST_DATA_DIR}/ssl/node.csr&quot; -outfile &quot;${TEST_DATA_DIR}/ssl/node.cer&quot;&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -file &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot; -alias ca -noprompt&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -file &quot;${TEST_DATA_DIR}/ssl/node.cer&quot; -alias node -noprompt&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    # keystore is converted into a pem format to use it as node.pem with curl in Flink REST API queries, see also $CURL_SSL_ARGS&lt;br/&gt;
+    openssl pkcs12 -passin pass:password -in &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -out &quot;${TEST_DATA_DIR}/ssl/node.pem&quot; -nodes&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Alright, this makes sense. Thanks for the clarification @azagrebin.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16707406" author="githubbot" created="Mon, 3 Dec 2018 15:50:03 +0000"  >&lt;p&gt;tillrohrmann commented on issue #7221: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7221#issuecomment-443758049&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7221#issuecomment-443758049&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for the contribution @azagrebin. Merging this PR since the local Travis run is green.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16707407" author="githubbot" created="Mon, 3 Dec 2018 15:50:15 +0000"  >&lt;p&gt;tillrohrmann closed pull request #7221: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10842&quot; title=&quot;Waiting loops are broken in e2e/common.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10842&quot;&gt;&lt;del&gt;FLINK-10842&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;E2E tests&amp;#93;&lt;/span&gt; fix broken waiting loops in common.sh&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7221&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-end-to-end-tests/test-scripts/common.sh b/flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
index ffa7f439bbe..c9a174149dc 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/common.sh&lt;br/&gt;
@@ -38,6 +38,8 @@ echo &quot;Flink dist directory: $FLINK_DIR&quot;&lt;/p&gt;

&lt;p&gt; FLINK_VERSION=$(cat ${END_TO_END_DIR}/pom.xml | sed -n &apos;s/.&lt;b&gt;&amp;lt;version&amp;gt;&amp;#40;.&lt;/b&gt;&amp;#41;&amp;lt;\/version&amp;gt;/\1/p&apos;)&lt;/p&gt;

&lt;p&gt;+NODENAME=`hostname -f`&lt;br/&gt;
+&lt;br/&gt;
 USE_SSL=OFF # set via set_conf_ssl(), reset via revert_default_config()&lt;br/&gt;
 TEST_ROOT=`pwd -P`&lt;br/&gt;
 TEST_INFRA_DIR=&quot;$END_TO_END_DIR/test-scripts/&quot;&lt;br/&gt;
@@ -176,7 +178,6 @@ function set_conf_ssl {&lt;br/&gt;
     fi&lt;br/&gt;
     mkdir -p &quot;${TEST_DATA_DIR}/ssl&quot;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;NODENAME=`hostname -f`&lt;br/&gt;
     SANSTRING=&quot;dns:${NODENAME}&quot;&lt;br/&gt;
     for NODEIP in $(get_node_ip) ; do&lt;br/&gt;
         SANSTRING=&quot;${SANSTRING},ip:${NODEIP}&quot;&lt;br/&gt;
@@ -185,16 +186,19 @@ function set_conf_ssl {&lt;br/&gt;
     echo &quot;Using SAN ${SANSTRING}&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;create certificates&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;keytool -genkeypair -alias ca -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -dname &quot;CN=Sample CA&quot; -storepass password -keypass password -keyalg RSA -ext bc=ca:true&lt;br/&gt;
+    keytool -genkeypair -alias ca -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -dname &quot;CN=Sample CA&quot; -storepass password -keypass password -keyalg RSA -ext bc=ca:true -storetype PKCS12&lt;br/&gt;
     keytool -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -storepass password -alias ca -exportcert &amp;gt; &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot;&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/ca.truststore&quot; -alias ca -storepass password -noprompt -file &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;keytool -genkeypair -alias node -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -dname &quot;CN=${NODENAME}&quot; -ext SAN=${SANSTRING} -storepass password -keypass password -keyalg RSA&lt;br/&gt;
+    keytool -genkeypair -alias node -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -dname &quot;CN=${NODENAME}&quot; -ext SAN=${SANSTRING} -storepass password -keypass password -keyalg RSA -storetype PKCS12&lt;br/&gt;
     keytool -certreq -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -alias node -file &quot;${TEST_DATA_DIR}/ssl/node.csr&quot;&lt;br/&gt;
     keytool -gencert -keystore &quot;${TEST_DATA_DIR}/ssl/ca.keystore&quot; -storepass password -alias ca -ext SAN=${SANSTRING} -infile &quot;${TEST_DATA_DIR}/ssl/node.csr&quot; -outfile &quot;${TEST_DATA_DIR}/ssl/node.cer&quot;&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -file &quot;${TEST_DATA_DIR}/ssl/ca.cer&quot; -alias ca -noprompt&lt;br/&gt;
     keytool -importcert -keystore &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -storepass password -file &quot;${TEST_DATA_DIR}/ssl/node.cer&quot; -alias node -noprompt&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    # keystore is converted into a pem format to use it as node.pem with curl in Flink REST API queries, see also $CURL_SSL_ARGS&lt;br/&gt;
+    openssl pkcs12 -passin pass:password -in &quot;${TEST_DATA_DIR}/ssl/node.keystore&quot; -out &quot;${TEST_DATA_DIR}/ssl/node.pem&quot; -nodes&lt;br/&gt;
+&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;adapt config&lt;/li&gt;
	&lt;li&gt;(here we rely on security.ssl.enabled enabling SSL for all components and internal as well as&lt;/li&gt;
	&lt;li&gt;external communication channels)&lt;br/&gt;
@@ -242,26 +246,23 @@ function start_cluster {&lt;br/&gt;
   &quot;$FLINK_DIR&quot;/bin/start-cluster.sh&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;wait at most 10 seconds until the dispatcher is up&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;local QUERY_URL&lt;/li&gt;
	&lt;li&gt;if [ &quot;x$USE_SSL&quot; = &quot;xON&quot; ]; then&lt;/li&gt;
	&lt;li&gt;QUERY_URL=&quot;http://localhost:8081/taskmanagers&quot;&lt;/li&gt;
	&lt;li&gt;else&lt;/li&gt;
	&lt;li&gt;QUERY_URL=&quot;https://localhost:8081/taskmanagers&quot;&lt;/li&gt;
	&lt;li&gt;fi&lt;/li&gt;
	&lt;li&gt;for i in 
{1..10}; do&lt;br/&gt;
+  local TIMEOUT=10&lt;br/&gt;
+  for i in $(seq 1 ${TIMEOUT}); do&lt;br/&gt;
     # without the || true this would exit our script if the JobManager is not yet up&lt;br/&gt;
-    QUERY_RESULT=$(curl &quot;$QUERY_URL&quot; 2&amp;gt; /dev/null || true)&lt;br/&gt;
+    QUERY_RESULT=$(query_running_tms 2&amp;gt; /dev/null || true)&lt;br/&gt;
 &lt;br/&gt;
     # ensure the taskmanagers field is there at all and is not empty&lt;br/&gt;
     if [[ ${QUERY_RESULT} =~ {\&quot;taskmanagers\&quot;:[.+]} ]]; then&lt;br/&gt;
 &lt;br/&gt;
       echo &quot;Dispatcher REST endpoint is up.&quot;&lt;br/&gt;
-      break&lt;br/&gt;
+      return&lt;br/&gt;
     fi&lt;br/&gt;
 &lt;br/&gt;
     echo &quot;Waiting for dispatcher REST endpoint to come up...&quot;&lt;br/&gt;
     sleep 1&lt;br/&gt;
   done&lt;br/&gt;
+  echo &quot;Dispatcher REST endpoint has not started within a timeout of ${TIMEOUT} sec&quot;&lt;br/&gt;
+  exit 1&lt;br/&gt;
 }&lt;br/&gt;
 &lt;br/&gt;
 function start_taskmanagers {&lt;br/&gt;
@@ -274,31 +275,56 @@ function start_taskmanagers {&lt;br/&gt;
 }&lt;br/&gt;
 &lt;br/&gt;
 function start_and_wait_for_tm {&lt;br/&gt;
-&lt;br/&gt;
-  tm_query_result=$(curl -s &quot;http://localhost:8081/taskmanagers&quot;)&lt;br/&gt;
-&lt;br/&gt;
+  tm_query_result=`query_running_tms`&lt;br/&gt;
   # we assume that the cluster is running&lt;br/&gt;
   if ! [[ ${tm_query_result} =~ {\&quot;taskmanagers\&quot;:[.*]} ]]; then&lt;br/&gt;
     echo &quot;Your cluster seems to be unresponsive at the moment: ${tm_query_result}&quot; 1&amp;gt;&amp;amp;2&lt;br/&gt;
     exit 1&lt;br/&gt;
   fi&lt;br/&gt;
 &lt;br/&gt;
-  running_tms=`curl -s &quot;http://localhost:8081/taskmanagers&quot; | grep -o &quot;id&quot; | wc -l`&lt;br/&gt;
-&lt;br/&gt;
+  running_tms=`query_number_of_running_tms`&lt;br/&gt;
   ${FLINK_DIR}/bin/taskmanager.sh start&lt;br/&gt;
+  wait_for_number_of_running_tms $((running_tms+1))&lt;br/&gt;
+}&lt;br/&gt;
 &lt;br/&gt;
-  for i in {1..10}
&lt;p&gt;; do&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;local new_running_tms=`curl -s &quot;http://localhost:8081/taskmanagers&quot; | grep -o &quot;id&quot; | wc -l`&lt;/li&gt;
	&lt;li&gt;if [ $((new_running_tms-running_tms)) -eq 0 ]; then&lt;/li&gt;
	&lt;li&gt;echo &quot;TaskManager is not yet up.&quot;&lt;br/&gt;
+function query_running_tms {&lt;br/&gt;
+  local QUERY_URL&lt;br/&gt;
+  local CURL_SSL_ARGS&lt;br/&gt;
+  if [ &quot;x$USE_SSL&quot; = &quot;xON&quot; ]; then&lt;br/&gt;
+    QUERY_URL=&quot;https://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
+    CURL_SSL_ARGS=&quot;--cacert ${TEST_DATA_DIR}/ssl/node.pem&quot;&lt;br/&gt;
+  else&lt;br/&gt;
+    QUERY_URL=&quot;http://${NODENAME}:8081/taskmanagers&quot;&lt;br/&gt;
+    CURL_SSL_ARGS=&quot;&quot;&lt;br/&gt;
+  fi&lt;br/&gt;
+  curl ${CURL_SSL_ARGS} -s &quot;${QUERY_URL}&quot;&lt;br/&gt;
+}&lt;br/&gt;
+&lt;br/&gt;
+function query_number_of_running_tms 
{
+  query_running_tms | grep -o &quot;id&quot; | wc -l
+}
&lt;p&gt;+&lt;br/&gt;
+function wait_for_number_of_running_tms {&lt;br/&gt;
+  local TM_NUM_TO_WAIT=${1}&lt;br/&gt;
+  local TIMEOUT_COUNTER=10&lt;br/&gt;
+  local TIMEOUT_INC=4&lt;br/&gt;
+  local TIMEOUT=$(( $TIMEOUT_COUNTER * $TIMEOUT_INC ))&lt;br/&gt;
+  local TM_NUM_TEXT=&quot;Number of running task managers&quot;&lt;br/&gt;
+  for i in $(seq 1 ${TIMEOUT_COUNTER}); do&lt;br/&gt;
+    local TM_NUM=`query_number_of_running_tms`&lt;br/&gt;
+    if [ $((TM_NUM - TM_NUM_TO_WAIT)) -eq 0 ]; then&lt;br/&gt;
+      echo &quot;${TM_NUM_TEXT} has reached ${TM_NUM_TO_WAIT}.&quot;&lt;br/&gt;
+      return&lt;br/&gt;
     else&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;echo &quot;TaskManager is up.&quot;&lt;/li&gt;
	&lt;li&gt;break&lt;br/&gt;
+      echo &quot;${TM_NUM_TEXT} ${TM_NUM} is not yet ${TM_NUM_TO_WAIT}.&quot;&lt;br/&gt;
     fi&lt;/li&gt;
	&lt;li&gt;sleep 4&lt;br/&gt;
+    sleep ${TIMEOUT_INC}&lt;br/&gt;
   done&lt;br/&gt;
+  echo &quot;${TM_NUM_TEXT} has not reached ${TM_NUM_TO_WAIT} within a timeout of ${TIMEOUT} sec&quot;&lt;br/&gt;
+  exit 1&lt;br/&gt;
 }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+&lt;br/&gt;
 function check_logs_for_errors {&lt;br/&gt;
   error_count=$(grep -rv &quot;GroupCoordinatorNotAvailableException&quot; $FLINK_DIR/log \&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; grep -v &quot;RetriableCommitFailedException&quot; \&lt;br/&gt;
@@ -392,17 +418,20 @@ function wait_for_job_state_transition {&lt;br/&gt;
 }&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt; function wait_job_running {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for i in 
{1..10}
&lt;p&gt;; do&lt;br/&gt;
+  local TIMEOUT=10&lt;br/&gt;
+  for i in $(seq 1 ${TIMEOUT}); do&lt;br/&gt;
     JOB_LIST_RESULT=$(&quot;$FLINK_DIR&quot;/bin/flink list -r | grep &quot;$1&quot;)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     if [[ &quot;$JOB_LIST_RESULT&quot; == &quot;&quot; ]]; then&lt;br/&gt;
       echo &quot;Job ($1) is not yet running.&quot;&lt;br/&gt;
     else&lt;br/&gt;
       echo &quot;Job ($1) is running.&quot;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;break&lt;br/&gt;
+      return&lt;br/&gt;
     fi&lt;br/&gt;
     sleep 1&lt;br/&gt;
   done&lt;br/&gt;
+  echo &quot;Job ($1) has not started within a timeout of ${TIMEOUT} sec&quot;&lt;br/&gt;
+  exit 1&lt;br/&gt;
 }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; function wait_job_terminal_state {&lt;br/&gt;
diff --git a/flink-end-to-end-tests/test-scripts/test_queryable_state_restart_tm.sh b/flink-end-to-end-tests/test-scripts/test_queryable_state_restart_tm.sh&lt;br/&gt;
index 56d811e14a1..db0174a2160 100755&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/test-scripts/test_queryable_state_restart_tm.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/test_queryable_state_restart_tm.sh&lt;br/&gt;
@@ -86,6 +86,7 @@ function run_test() {&lt;br/&gt;
     fi&lt;/p&gt;

&lt;p&gt;     kill_random_taskmanager&lt;br/&gt;
+    wait_for_number_of_running_tms 0&lt;/p&gt;

&lt;p&gt;     latest_snapshot_count=$(cat $FLINK_DIR/log/&lt;b&gt;out&lt;/b&gt; | grep &quot;on snapshot&quot; | tail -n 1 | awk &apos;&lt;/p&gt;
{print $4}
&lt;p&gt;&apos;)&lt;br/&gt;
     echo &quot;Latest snapshot count was ${latest_snapshot_count}&quot;&lt;br/&gt;
diff --git a/flink-end-to-end-tests/test-scripts/test_resume_externalized_checkpoints.sh b/flink-end-to-end-tests/test-scripts/test_resume_externalized_checkpoints.sh&lt;br/&gt;
index 35fe30b6b25..48d68c98e9d 100755&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/test-scripts/test_resume_externalized_checkpoints.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/test_resume_externalized_checkpoints.sh&lt;br/&gt;
@@ -100,11 +100,10 @@ fi&lt;/p&gt;

&lt;p&gt; DATASTREAM_JOB=$($JOB_CMD | grep &quot;Job has been submitted with JobID&quot; | sed &apos;s/.* //g&apos;)&lt;/p&gt;

&lt;p&gt;-wait_job_running $DATASTREAM_JOB&lt;br/&gt;
-&lt;br/&gt;
 if [[ $SIMULATE_FAILURE == &quot;true&quot; ]]; then&lt;br/&gt;
   wait_job_terminal_state $DATASTREAM_JOB FAILED&lt;br/&gt;
 else&lt;br/&gt;
+  wait_job_running $DATASTREAM_JOB&lt;br/&gt;
   wait_num_checkpoints $DATASTREAM_JOB 1&lt;br/&gt;
   wait_oper_metric_num_in_records SemanticsCheckMapper.0 200&lt;/p&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16707409" author="till.rohrmann" created="Mon, 3 Dec 2018 15:51:09 +0000"  >&lt;p&gt;Fixed in 1.6.3: &lt;a href=&quot;https://github.com/apache/flink/commit/bf5f4be71fc950318a9c61ac4265087c87861cca&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/bf5f4be71fc950318a9c61ac4265087c87861cca&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00bpk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>