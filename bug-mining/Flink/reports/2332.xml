<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:32:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8943] Jobs will not recover if DFS is temporarily unavailable</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8943</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;&lt;br/&gt;
Job graphs will be recovered only once from the DFS. If the DFS is unavailable at the recovery attempt, the jobs will simply be not running until the master is restarted again.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Steps to reproduce&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Submit job on Flink Cluster with HDFS as HA storage dir.&lt;/li&gt;
	&lt;li&gt;Trigger job recovery by killing the master&lt;/li&gt;
	&lt;li&gt;Stop HDFS NameNode&lt;/li&gt;
	&lt;li&gt;Enable HDFS NameNode after job recovery is over&lt;/li&gt;
	&lt;li&gt;Verify that job is not running.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;Expected behavior&lt;/b&gt;&lt;br/&gt;
The new master should fail fast and exit. The new master should re-attempt the recovery.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Stacktrace&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018-03-14 14:01:37,704 ERROR org.apache.flink.runtime.dispatcher.StandaloneDispatcher      - Could not recover the job graph for a41d50b6f3ac16a730dd12792a847c97.
org.apache.flink.util.FlinkException: Could not retrieve submitted JobGraph from state handle under /a41d50b6f3ac16a730dd12792a847c97. This indicates that the retrieved state handle is broken. Try cleaning the state handle store.
	at org.apache.flink.runtime.jobmanager.ZooKeeperSubmittedJobGraphStore.recoverJobGraph(ZooKeeperSubmittedJobGraphStore.java:192)
	at org.apache.flink.runtime.dispatcher.Dispatcher.lambda$recoverJobs$5(Dispatcher.java:557)
	at akka.dispatch.TaskInvocation.run(AbstractDispatcher.scala:39)
	at akka.dispatch.ForkJoinExecutorConfigurator$AkkaForkJoinTask.exec(AbstractDispatcher.scala:415)
	at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
	at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
	at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
Caused by: java.net.ConnectException: Call From ip-172-31-43-54/172.31.43.54 to ip-172-31-32-118.eu-central-1.compute.internal:9000 failed on connection exception: java.net.ConnectException: Connection refused; For more details see:  http://wiki.apache.org/hadoop/ConnectionRefused
	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
	at org.apache.hadoop.net.NetUtils.wrapWithMessage(NetUtils.java:801)
	at org.apache.hadoop.net.NetUtils.wrapException(NetUtils.java:732)
	at org.apache.hadoop.ipc.Client.getRpcResponse(Client.java:1493)
	at org.apache.hadoop.ipc.Client.call(Client.java:1435)
	at org.apache.hadoop.ipc.Client.call(Client.java:1345)
	at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:227)
	at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:116)
	at com.sun.proxy.$Proxy10.getBlockLocations(Unknown Source)
	at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.getBlockLocations(ClientNamenodeProtocolTranslatorPB.java:259)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:409)
	at org.apache.hadoop.io.retry.RetryInvocationHandler$Call.invokeMethod(RetryInvocationHandler.java:163)
	at org.apache.hadoop.io.retry.RetryInvocationHandler$Call.invoke(RetryInvocationHandler.java:155)
	at org.apache.hadoop.io.retry.RetryInvocationHandler$Call.invokeOnce(RetryInvocationHandler.java:95)
	at org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:346)
	at com.sun.proxy.$Proxy11.getBlockLocations(Unknown Source)
	at org.apache.hadoop.hdfs.DFSClient.callGetBlockLocations(DFSClient.java:843)
	at org.apache.hadoop.hdfs.DFSClient.getLocatedBlocks(DFSClient.java:832)
	at org.apache.hadoop.hdfs.DFSClient.getLocatedBlocks(DFSClient.java:821)
	at org.apache.hadoop.hdfs.DFSInputStream.fetchLocatedBlocksAndGetLastBlockLength(DFSInputStream.java:325)
	at org.apache.hadoop.hdfs.DFSInputStream.openInfo(DFSInputStream.java:285)
	at org.apache.hadoop.hdfs.DFSInputStream.&amp;lt;init&amp;gt;(DFSInputStream.java:270)
	at org.apache.hadoop.hdfs.DFSClient.open(DFSClient.java:1132)
	at org.apache.hadoop.hdfs.DistributedFileSystem$4.doCall(DistributedFileSystem.java:325)
	at org.apache.hadoop.hdfs.DistributedFileSystem$4.doCall(DistributedFileSystem.java:322)
	at org.apache.hadoop.fs.FileSystemLinkResolver.resolve(FileSystemLinkResolver.java:81)
	at org.apache.hadoop.hdfs.DistributedFileSystem.open(DistributedFileSystem.java:322)
	at org.apache.hadoop.fs.FileSystem.open(FileSystem.java:787)
	at org.apache.flink.runtime.fs.hdfs.HadoopFileSystem.open(HadoopFileSystem.java:119)
	at org.apache.flink.runtime.fs.hdfs.HadoopFileSystem.open(HadoopFileSystem.java:36)
	at org.apache.flink.runtime.state.filesystem.FileStateHandle.openInputStream(FileStateHandle.java:68)
	at org.apache.flink.runtime.state.RetrievableStreamStateHandle.openInputStream(RetrievableStreamStateHandle.java:64)
	at org.apache.flink.runtime.state.RetrievableStreamStateHandle.retrieveState(RetrievableStreamStateHandle.java:57)
	at org.apache.flink.runtime.jobmanager.ZooKeeperSubmittedJobGraphStore.recoverJobGraph(ZooKeeperSubmittedJobGraphStore.java:186)
	... 7 more
Caused by: java.net.ConnectException: Connection refused
	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)
	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)
	at org.apache.hadoop.net.SocketIOWithTimeout.connect(SocketIOWithTimeout.java:206)
	at org.apache.hadoop.net.NetUtils.connect(NetUtils.java:531)
	at org.apache.hadoop.ipc.Client$Connection.setupConnection(Client.java:685)
	at org.apache.hadoop.ipc.Client$Connection.setupIOstreams(Client.java:788)
	at org.apache.hadoop.ipc.Client$Connection.access$3500(Client.java:410)
	at org.apache.hadoop.ipc.Client.getConnection(Client.java:1550)
	at org.apache.hadoop.ipc.Client.call(Client.java:1381)
	... 40 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13145042">FLINK-8943</key>
            <summary>Jobs will not recover if DFS is temporarily unavailable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="gjy">Gary Yao</reporter>
                        <labels>
                            <label>flip6</label>
                    </labels>
                <created>Wed, 14 Mar 2018 14:13:21 +0000</created>
                <updated>Wed, 28 Mar 2018 20:17:51 +0000</updated>
                            <resolved>Wed, 28 Mar 2018 20:17:51 +0000</resolved>
                                    <version>1.4.2</version>
                    <version>1.5.0</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16409316" author="githubbot" created="Thu, 22 Mar 2018 10:05:23 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8943&quot; title=&quot;Jobs will not recover if DFS is temporarily unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8943&quot;&gt;&lt;del&gt;FLINK-8943&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;ha&amp;#93;&lt;/span&gt; Fail Dispatcher if jobs cannot be recovered from HA store&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    In HA mode, the Dispatcher should fail if it cannot recover the persisted jobs. The idea&lt;br/&gt;
    is that another Dispatcher will be brought up and tries it again. This is better than&lt;br/&gt;
    simply dropping the not recovered jobs.&lt;/p&gt;

&lt;p&gt;    cc @GJL &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Fail the `Dispatcher`/`JobManager` in case that we cannot recover a persisted job&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added `DispatcherTest#testFatalErrorAfterJobIdRecoveryFailure` and `DispatcherTest#testFatalErrorAfterJobRecoveryFailure`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; failIfJobNotRecoverable&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5746&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d15e5a2897e5b17ee256cac1374bbcee24104fe2&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-03-22T09:46:04Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Extend TestingFatalErrorHandler to return an error future&lt;/p&gt;

&lt;p&gt;commit 50004f3cfcba112d0e7f05b9875931d25d102110&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-03-22T09:46:28Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Add BiFunctionWithException&lt;/p&gt;

&lt;p&gt;commit f6a6d2da064ff80125600a3a90e773684dc24715&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-03-21T21:36:33Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8943&quot; title=&quot;Jobs will not recover if DFS is temporarily unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8943&quot;&gt;&lt;del&gt;FLINK-8943&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;ha&amp;#93;&lt;/span&gt; Fail Dispatcher if jobs cannot be recovered from HA store&lt;/p&gt;

&lt;p&gt;    In HA mode, the Dispatcher should fail if it cannot recover the persisted jobs. The idea&lt;br/&gt;
    is that another Dispatcher will be brought up and tries it again. This is better than&lt;br/&gt;
    simply dropping the not recovered jobs.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16409888" author="githubbot" created="Thu, 22 Mar 2018 16:56:32 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @tillrohrmann there is one question I want ask about this PR, is it means that in HA mode we can&apos;t tolerant jobs partial broken?&lt;/p&gt;</comment>
                            <comment id="16409907" author="githubbot" created="Thu, 22 Mar 2018 17:03:14 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    please just ignore my question...&lt;/p&gt;</comment>
                            <comment id="16409908" author="githubbot" created="Thu, 22 Mar 2018 17:03:16 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yes @sihuazhou. In such a case the JM will terminate in order to let another JM try to recover the jobs.&lt;/p&gt;</comment>
                            <comment id="16409913" author="githubbot" created="Thu, 22 Mar 2018 17:04:17 +0000"  >&lt;p&gt;Github user sihuazhou commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for your reply &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16417235" author="githubbot" created="Wed, 28 Mar 2018 11:58:05 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177721959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177721959&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/util/TestingFatalErrorHandler.java &amp;#8212;&lt;br/&gt;
    @@ -19,45 +19,81 @@&lt;br/&gt;
     package org.apache.flink.runtime.util;&lt;/p&gt;

&lt;p&gt;     import org.apache.flink.runtime.rpc.FatalErrorHandler;&lt;br/&gt;
    +import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
    +import org.apache.flink.util.FlinkRuntimeException;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +&lt;br/&gt;
     import org.slf4j.Logger;&lt;br/&gt;
     import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;    -import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.concurrent.CompletableFuture;&lt;br/&gt;
    +import java.util.concurrent.ExecutionException;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Testing fatal error handler which records the occurred exceptions during the execution of the&lt;/li&gt;
	&lt;li&gt;tests. Captured exceptions are thrown as a 
{@link TestingException}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TestingFatalErrorHandler implements FatalErrorHandler {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(TestingFatalErrorHandler.class);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final AtomicReference&amp;lt;Throwable&amp;gt; atomicThrowable;&lt;br/&gt;
    +	private CompletableFuture&amp;lt;Throwable&amp;gt; errorFuture;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	public TestingFatalErrorHandler() &lt;/p&gt;
{
    -		atomicThrowable = new AtomicReference&amp;lt;&amp;gt;(null);
    +		errorFuture = new CompletableFuture&amp;lt;&amp;gt;();
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void rethrowError() throws TestingException {&lt;/li&gt;
	&lt;li&gt;Throwable throwable = atomicThrowable.get();&lt;br/&gt;
    +	public synchronized void rethrowError() throws TestingException {&lt;br/&gt;
    +		final Throwable throwable = getException();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (throwable != null) &lt;/p&gt;
{
    -			throw new TestingException(throwable);
    +            throw new TestingException(throwable);
    +        }
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public synchronized boolean hasExceptionOccurred() &lt;/p&gt;
{
    +		return errorFuture.isDone();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
    +	public synchronized Throwable getException() {&lt;br/&gt;
    +		if (errorFuture.isDone()) {&lt;br/&gt;
    +			Throwable throwable = null;&lt;br/&gt;
    +&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				throwable = errorFuture.get();
    +			}
&lt;p&gt; catch (InterruptedException ie) {&lt;br/&gt;
    +				Thread.interrupted();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    It does not make sense to call `Thread.interrupted()` here.&lt;br/&gt;
    &amp;gt;Tests whether the current thread has been interrupted. The interrupted status of the thread is cleared by this method. &lt;/p&gt;

&lt;p&gt;    However, the interrupted flag should be already cleared:&lt;/p&gt;

&lt;p&gt;    &amp;gt; By convention, any method that exits by throwing an InterruptedException clears interrupt status when it does so.&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://docs.oracle.com/javase/tutorial/essential/concurrency/interrupt.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/tutorial/essential/concurrency/interrupt.html&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="16417236" author="githubbot" created="Wed, 28 Mar 2018 11:58:05 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177722358&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177722358&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/util/TestingFatalErrorHandler.java &amp;#8212;&lt;br/&gt;
    @@ -19,45 +19,81 @@&lt;br/&gt;
     package org.apache.flink.runtime.util;&lt;/p&gt;

&lt;p&gt;     import org.apache.flink.runtime.rpc.FatalErrorHandler;&lt;br/&gt;
    +import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
    +import org.apache.flink.util.FlinkRuntimeException;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +&lt;br/&gt;
     import org.slf4j.Logger;&lt;br/&gt;
     import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;    -import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.concurrent.CompletableFuture;&lt;br/&gt;
    +import java.util.concurrent.ExecutionException;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Testing fatal error handler which records the occurred exceptions during the execution of the&lt;/li&gt;
	&lt;li&gt;tests. Captured exceptions are thrown as a 
{@link TestingException}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TestingFatalErrorHandler implements FatalErrorHandler {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(TestingFatalErrorHandler.class);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final AtomicReference&amp;lt;Throwable&amp;gt; atomicThrowable;&lt;br/&gt;
    +	private CompletableFuture&amp;lt;Throwable&amp;gt; errorFuture;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	public TestingFatalErrorHandler() &lt;/p&gt;
{
    -		atomicThrowable = new AtomicReference&amp;lt;&amp;gt;(null);
    +		errorFuture = new CompletableFuture&amp;lt;&amp;gt;();
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void rethrowError() throws TestingException {&lt;/li&gt;
	&lt;li&gt;Throwable throwable = atomicThrowable.get();&lt;br/&gt;
    +	public synchronized void rethrowError() throws TestingException {&lt;br/&gt;
    +		final Throwable throwable = getException();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (throwable != null) &lt;/p&gt;
{
    -			throw new TestingException(throwable);
    +            throw new TestingException(throwable);
    +        }
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public synchronized boolean hasExceptionOccurred() &lt;/p&gt;
{
    +		return errorFuture.isDone();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
    +	public synchronized Throwable getException() {&lt;br/&gt;
    +		if (errorFuture.isDone()) {&lt;br/&gt;
    +			Throwable throwable = null;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: redundant initialization to `null`&lt;/p&gt;</comment>
                            <comment id="16417237" author="githubbot" created="Wed, 28 Mar 2018 11:58:06 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177723226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177723226&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/jobmanager/JobManagerHARecoveryTest.java &amp;#8212;&lt;br/&gt;
    @@ -396,15 +398,22 @@ public void testFailingJobRecovery() throws Exception {&lt;/p&gt;

&lt;p&gt;     			jobManager = system.actorOf(jobManagerProps);&lt;/p&gt;

&lt;p&gt;    +			final TestProbe testProbe = new TestProbe(system);&lt;br/&gt;
    +&lt;br/&gt;
    +			testProbe.watch(jobManager);&lt;br/&gt;
    +&lt;br/&gt;
     			Future&amp;lt;Object&amp;gt; started = Patterns.ask(jobManager, new Identify(42), deadline.timeLeft().toMillis());&lt;/p&gt;

&lt;p&gt;     			Await.ready(started, deadline.timeLeft());&lt;/p&gt;

&lt;p&gt;     			// make the job manager the leader --&amp;gt; this triggers the recovery of all jobs&lt;br/&gt;
     			myLeaderElectionService.isLeader(leaderSessionID);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// check that we have successfully recovered the second job&lt;/li&gt;
	&lt;li&gt;assertThat(recoveredJobs, containsInAnyOrder(jobId2));&lt;br/&gt;
    +			// check that we did not recover any jobs&lt;br/&gt;
    +			assertThat(recoveredJobs, Matchers.is(empty()));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: there is a static import for `empty` but not for `is`&lt;/p&gt;</comment>
                            <comment id="16417239" author="githubbot" created="Wed, 28 Mar 2018 11:59:59 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177724449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177724449&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -344,6 +351,72 @@ public void testJobRecovery() throws Exception &lt;/p&gt;
{
     		assertThat(jobIds, contains(jobGraph.getJobID()));
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that the &lt;/p&gt;
{@link Dispatcher} terminates if it cannot recover jobs ids from&lt;br/&gt;
    +	 * the {@link SubmittedJobGraphStore}. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8943&quot; title=&quot;Jobs will not recover if DFS is temporarily unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8943&quot;&gt;&lt;del&gt;FLINK-8943&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testFatalErrorAfterJobIdRecoveryFailure() throws Exception {&lt;br/&gt;
    +		final FlinkException testException = new FlinkException(&quot;Test exception&quot;);&lt;br/&gt;
    +		submittedJobGraphStore.setJobIdsFunction(&lt;br/&gt;
    +			(Collection&amp;lt;JobID&amp;gt; jobIds) -&amp;gt; {
    +				throw testException;
    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +		UUID expectedLeaderSessionId = UUID.randomUUID();&lt;br/&gt;
    +&lt;br/&gt;
    +		assertNull(dispatcherLeaderElectionService.getConfirmationFuture());&lt;br/&gt;
    +&lt;br/&gt;
    +		dispatcherLeaderElectionService.isLeader(expectedLeaderSessionId);&lt;br/&gt;
    +&lt;br/&gt;
    +		UUID actualLeaderSessionId = dispatcherLeaderElectionService.getConfirmationFuture()&lt;br/&gt;
    +			.get(TIMEOUT.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(expectedLeaderSessionId, actualLeaderSessionId);&lt;br/&gt;
    +&lt;br/&gt;
    +		// we expect that a fatal error occurred&lt;br/&gt;
    +		final Throwable error = fatalErrorHandler.getErrorFuture().get(TIMEOUT.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertThat(ExceptionUtils.findThrowableWithMessage(error, testException.getMessage()).isPresent(), is(true));&lt;br/&gt;
    +&lt;br/&gt;
    +		fatalErrorHandler.clearError();&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that the {@link Dispatcher}
&lt;p&gt; terminates if it cannot recover jobs from&lt;br/&gt;
    +	 * the &lt;/p&gt;
{@link SubmittedJobGraphStore}
&lt;p&gt;. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8943&quot; title=&quot;Jobs will not recover if DFS is temporarily unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8943&quot;&gt;&lt;del&gt;FLINK-8943&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testFatalErrorAfterJobRecoveryFailure() throws Exception {&lt;br/&gt;
    +		final FlinkException testException = new FlinkException(&quot;Test exception&quot;);&lt;br/&gt;
    +&lt;br/&gt;
    +		final SubmittedJobGraph submittedJobGraph = new SubmittedJobGraph(jobGraph, null);&lt;br/&gt;
    +		submittedJobGraphStore.putJobGraph(submittedJobGraph);&lt;br/&gt;
    +&lt;br/&gt;
    +		submittedJobGraphStore.setRecoverJobGraphFunction(&lt;br/&gt;
    +			(JobID jobId, Map&amp;lt;JobID, SubmittedJobGraph&amp;gt; submittedJobs) -&amp;gt; &lt;/p&gt;
{
    +				throw testException;
    +			}
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +		UUID expectedLeaderSessionId = UUID.randomUUID();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Code looks duplicated from here on (`testFatalErrorAfterJobIdRecoveryFailure`)&lt;/p&gt;</comment>
                            <comment id="16417240" author="githubbot" created="Wed, 28 Mar 2018 12:00:51 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177724627&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177724627&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmanager/ZooKeeperSubmittedJobGraphStore.java &amp;#8212;&lt;br/&gt;
    @@ -177,7 +178,7 @@ public SubmittedJobGraph recoverJobGraph(JobID jobId) throws Exception &lt;/p&gt;
{
     					success = true;
     					return null;
     				}
&lt;p&gt; catch (Exception e) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;throw new Exception(&quot;Could not retrieve the submitted job graph state handle &quot; +&lt;br/&gt;
    +					throw new FlinkException(&quot;Could not retrieve the submitted job graph state handle &quot; +&lt;br/&gt;
     						&quot;for &quot; + path + &quot;from the submitted job graph store.&quot;, e);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: missing space, i.e., `&quot; from &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&quot;`&lt;/p&gt;</comment>
                            <comment id="16417267" author="githubbot" created="Wed, 28 Mar 2018 12:28:55 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177731188&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177731188&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/util/TestingFatalErrorHandler.java &amp;#8212;&lt;br/&gt;
    @@ -19,45 +19,81 @@&lt;br/&gt;
     package org.apache.flink.runtime.util;&lt;/p&gt;

&lt;p&gt;     import org.apache.flink.runtime.rpc.FatalErrorHandler;&lt;br/&gt;
    +import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
    +import org.apache.flink.util.FlinkRuntimeException;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +&lt;br/&gt;
     import org.slf4j.Logger;&lt;br/&gt;
     import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;    -import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.concurrent.CompletableFuture;&lt;br/&gt;
    +import java.util.concurrent.ExecutionException;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Testing fatal error handler which records the occurred exceptions during the execution of the&lt;/li&gt;
	&lt;li&gt;tests. Captured exceptions are thrown as a 
{@link TestingException}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TestingFatalErrorHandler implements FatalErrorHandler {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(TestingFatalErrorHandler.class);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final AtomicReference&amp;lt;Throwable&amp;gt; atomicThrowable;&lt;br/&gt;
    +	private CompletableFuture&amp;lt;Throwable&amp;gt; errorFuture;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	public TestingFatalErrorHandler() &lt;/p&gt;
{
    -		atomicThrowable = new AtomicReference&amp;lt;&amp;gt;(null);
    +		errorFuture = new CompletableFuture&amp;lt;&amp;gt;();
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void rethrowError() throws TestingException {&lt;/li&gt;
	&lt;li&gt;Throwable throwable = atomicThrowable.get();&lt;br/&gt;
    +	public synchronized void rethrowError() throws TestingException {&lt;br/&gt;
    +		final Throwable throwable = getException();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (throwable != null) &lt;/p&gt;
{
    -			throw new TestingException(throwable);
    +            throw new TestingException(throwable);
    +        }
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public synchronized boolean hasExceptionOccurred() &lt;/p&gt;
{
    +		return errorFuture.isDone();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
    +	public synchronized Throwable getException() {&lt;br/&gt;
    +		if (errorFuture.isDone()) {&lt;br/&gt;
    +			Throwable throwable = null;&lt;br/&gt;
    +&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				throwable = errorFuture.get();
    +			}
&lt;p&gt; catch (InterruptedException ie) {&lt;br/&gt;
    +				Thread.interrupted();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Given that we want to keep the interrupted flag set for the caller, I think we have to call `Thread.interrupted`. Otherwise, other components which are called later will miss the interruption. Actually it would be better to call `ExceptionUtils.checkInterrupted` which is a utility for this behaviour.&lt;/p&gt;</comment>
                            <comment id="16417269" author="githubbot" created="Wed, 28 Mar 2018 12:30:40 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177731653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177731653&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/util/TestingFatalErrorHandler.java &amp;#8212;&lt;br/&gt;
    @@ -19,45 +19,81 @@&lt;br/&gt;
     package org.apache.flink.runtime.util;&lt;/p&gt;

&lt;p&gt;     import org.apache.flink.runtime.rpc.FatalErrorHandler;&lt;br/&gt;
    +import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
    +import org.apache.flink.util.FlinkRuntimeException;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +&lt;br/&gt;
     import org.slf4j.Logger;&lt;br/&gt;
     import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;    -import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.concurrent.CompletableFuture;&lt;br/&gt;
    +import java.util.concurrent.ExecutionException;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Testing fatal error handler which records the occurred exceptions during the execution of the&lt;/li&gt;
	&lt;li&gt;tests. Captured exceptions are thrown as a 
{@link TestingException}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TestingFatalErrorHandler implements FatalErrorHandler {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(TestingFatalErrorHandler.class);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final AtomicReference&amp;lt;Throwable&amp;gt; atomicThrowable;&lt;br/&gt;
    +	private CompletableFuture&amp;lt;Throwable&amp;gt; errorFuture;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	public TestingFatalErrorHandler() &lt;/p&gt;
{
    -		atomicThrowable = new AtomicReference&amp;lt;&amp;gt;(null);
    +		errorFuture = new CompletableFuture&amp;lt;&amp;gt;();
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void rethrowError() throws TestingException {&lt;/li&gt;
	&lt;li&gt;Throwable throwable = atomicThrowable.get();&lt;br/&gt;
    +	public synchronized void rethrowError() throws TestingException {&lt;br/&gt;
    +		final Throwable throwable = getException();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (throwable != null) &lt;/p&gt;
{
    -			throw new TestingException(throwable);
    +            throw new TestingException(throwable);
    +        }
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public synchronized boolean hasExceptionOccurred() &lt;/p&gt;
{
    +		return errorFuture.isDone();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
    +	public synchronized Throwable getException() {&lt;br/&gt;
    +		if (errorFuture.isDone()) {&lt;br/&gt;
    +			Throwable throwable = null;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Will fix it.&lt;/p&gt;</comment>
                            <comment id="16417270" author="githubbot" created="Wed, 28 Mar 2018 12:30:53 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177731740&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177731740&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/jobmanager/JobManagerHARecoveryTest.java &amp;#8212;&lt;br/&gt;
    @@ -396,15 +398,22 @@ public void testFailingJobRecovery() throws Exception {&lt;/p&gt;

&lt;p&gt;     			jobManager = system.actorOf(jobManagerProps);&lt;/p&gt;

&lt;p&gt;    +			final TestProbe testProbe = new TestProbe(system);&lt;br/&gt;
    +&lt;br/&gt;
    +			testProbe.watch(jobManager);&lt;br/&gt;
    +&lt;br/&gt;
     			Future&amp;lt;Object&amp;gt; started = Patterns.ask(jobManager, new Identify(42), deadline.timeLeft().toMillis());&lt;/p&gt;

&lt;p&gt;     			Await.ready(started, deadline.timeLeft());&lt;/p&gt;

&lt;p&gt;     			// make the job manager the leader --&amp;gt; this triggers the recovery of all jobs&lt;br/&gt;
     			myLeaderElectionService.isLeader(leaderSessionID);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// check that we have successfully recovered the second job&lt;/li&gt;
	&lt;li&gt;assertThat(recoveredJobs, containsInAnyOrder(jobId2));&lt;br/&gt;
    +			// check that we did not recover any jobs&lt;br/&gt;
    +			assertThat(recoveredJobs, Matchers.is(empty()));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    True, will make it consistent.&lt;/p&gt;</comment>
                            <comment id="16417272" author="githubbot" created="Wed, 28 Mar 2018 12:33:53 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177732527&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177732527&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -344,6 +351,72 @@ public void testJobRecovery() throws Exception &lt;/p&gt;
{
     		assertThat(jobIds, contains(jobGraph.getJobID()));
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that the &lt;/p&gt;
{@link Dispatcher} terminates if it cannot recover jobs ids from&lt;br/&gt;
    +	 * the {@link SubmittedJobGraphStore}. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8943&quot; title=&quot;Jobs will not recover if DFS is temporarily unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8943&quot;&gt;&lt;del&gt;FLINK-8943&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testFatalErrorAfterJobIdRecoveryFailure() throws Exception {&lt;br/&gt;
    +		final FlinkException testException = new FlinkException(&quot;Test exception&quot;);&lt;br/&gt;
    +		submittedJobGraphStore.setJobIdsFunction(&lt;br/&gt;
    +			(Collection&amp;lt;JobID&amp;gt; jobIds) -&amp;gt; {
    +				throw testException;
    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +		UUID expectedLeaderSessionId = UUID.randomUUID();&lt;br/&gt;
    +&lt;br/&gt;
    +		assertNull(dispatcherLeaderElectionService.getConfirmationFuture());&lt;br/&gt;
    +&lt;br/&gt;
    +		dispatcherLeaderElectionService.isLeader(expectedLeaderSessionId);&lt;br/&gt;
    +&lt;br/&gt;
    +		UUID actualLeaderSessionId = dispatcherLeaderElectionService.getConfirmationFuture()&lt;br/&gt;
    +			.get(TIMEOUT.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(expectedLeaderSessionId, actualLeaderSessionId);&lt;br/&gt;
    +&lt;br/&gt;
    +		// we expect that a fatal error occurred&lt;br/&gt;
    +		final Throwable error = fatalErrorHandler.getErrorFuture().get(TIMEOUT.toMilliseconds(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertThat(ExceptionUtils.findThrowableWithMessage(error, testException.getMessage()).isPresent(), is(true));&lt;br/&gt;
    +&lt;br/&gt;
    +		fatalErrorHandler.clearError();&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that the {@link Dispatcher}
&lt;p&gt; terminates if it cannot recover jobs from&lt;br/&gt;
    +	 * the &lt;/p&gt;
{@link SubmittedJobGraphStore}
&lt;p&gt;. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8943&quot; title=&quot;Jobs will not recover if DFS is temporarily unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8943&quot;&gt;&lt;del&gt;FLINK-8943&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testFatalErrorAfterJobRecoveryFailure() throws Exception {&lt;br/&gt;
    +		final FlinkException testException = new FlinkException(&quot;Test exception&quot;);&lt;br/&gt;
    +&lt;br/&gt;
    +		final SubmittedJobGraph submittedJobGraph = new SubmittedJobGraph(jobGraph, null);&lt;br/&gt;
    +		submittedJobGraphStore.putJobGraph(submittedJobGraph);&lt;br/&gt;
    +&lt;br/&gt;
    +		submittedJobGraphStore.setRecoverJobGraphFunction(&lt;br/&gt;
    +			(JobID jobId, Map&amp;lt;JobID, SubmittedJobGraph&amp;gt; submittedJobs) -&amp;gt; &lt;/p&gt;
{
    +				throw testException;
    +			}
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +		UUID expectedLeaderSessionId = UUID.randomUUID();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think I fixed it in b83b280ce2fb493eb647ffa589613c0b0362f39a which is part of #5774 &lt;/p&gt;</comment>
                            <comment id="16417277" author="githubbot" created="Wed, 28 Mar 2018 12:37:01 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @GJL. I&apos;ve addressed your comments and rebased onto the soon to be master.&lt;/p&gt;</comment>
                            <comment id="16417295" author="githubbot" created="Wed, 28 Mar 2018 12:57:54 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177739371&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177739371&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/util/TestingFatalErrorHandler.java &amp;#8212;&lt;br/&gt;
    @@ -19,45 +19,81 @@&lt;br/&gt;
     package org.apache.flink.runtime.util;&lt;/p&gt;

&lt;p&gt;     import org.apache.flink.runtime.rpc.FatalErrorHandler;&lt;br/&gt;
    +import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
    +import org.apache.flink.util.FlinkRuntimeException;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +&lt;br/&gt;
     import org.slf4j.Logger;&lt;br/&gt;
     import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;    -import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.concurrent.CompletableFuture;&lt;br/&gt;
    +import java.util.concurrent.ExecutionException;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Testing fatal error handler which records the occurred exceptions during the execution of the&lt;/li&gt;
	&lt;li&gt;tests. Captured exceptions are thrown as a 
{@link TestingException}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TestingFatalErrorHandler implements FatalErrorHandler {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(TestingFatalErrorHandler.class);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final AtomicReference&amp;lt;Throwable&amp;gt; atomicThrowable;&lt;br/&gt;
    +	private CompletableFuture&amp;lt;Throwable&amp;gt; errorFuture;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	public TestingFatalErrorHandler() &lt;/p&gt;
{
    -		atomicThrowable = new AtomicReference&amp;lt;&amp;gt;(null);
    +		errorFuture = new CompletableFuture&amp;lt;&amp;gt;();
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void rethrowError() throws TestingException {&lt;/li&gt;
	&lt;li&gt;Throwable throwable = atomicThrowable.get();&lt;br/&gt;
    +	public synchronized void rethrowError() throws TestingException {&lt;br/&gt;
    +		final Throwable throwable = getException();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (throwable != null) &lt;/p&gt;
{
    -			throw new TestingException(throwable);
    +            throw new TestingException(throwable);
    +        }
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public synchronized boolean hasExceptionOccurred() &lt;/p&gt;
{
    +		return errorFuture.isDone();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
    +	public synchronized Throwable getException() {&lt;br/&gt;
    +		if (errorFuture.isDone()) {&lt;br/&gt;
    +			Throwable throwable = null;&lt;br/&gt;
    +&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				throwable = errorFuture.get();
    +			}
&lt;p&gt; catch (InterruptedException ie) {&lt;br/&gt;
    +				Thread.interrupted();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `interrupted()` clears the flag. You should use `interrupt()`.&lt;/p&gt;</comment>
                            <comment id="16417303" author="githubbot" created="Wed, 28 Mar 2018 13:09:23 +0000"  >&lt;p&gt;Github user GJL commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I had one more comment regarding `Thread.interrupted()`.&lt;/p&gt;</comment>
                            <comment id="16417358" author="githubbot" created="Wed, 28 Mar 2018 13:55:02 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746#discussion_r177757288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746#discussion_r177757288&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/util/TestingFatalErrorHandler.java &amp;#8212;&lt;br/&gt;
    @@ -19,45 +19,81 @@&lt;br/&gt;
     package org.apache.flink.runtime.util;&lt;/p&gt;

&lt;p&gt;     import org.apache.flink.runtime.rpc.FatalErrorHandler;&lt;br/&gt;
    +import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
    +import org.apache.flink.util.FlinkRuntimeException;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +&lt;br/&gt;
     import org.slf4j.Logger;&lt;br/&gt;
     import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;    -import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.concurrent.CompletableFuture;&lt;br/&gt;
    +import java.util.concurrent.ExecutionException;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Testing fatal error handler which records the occurred exceptions during the execution of the&lt;/li&gt;
	&lt;li&gt;tests. Captured exceptions are thrown as a 
{@link TestingException}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
     public class TestingFatalErrorHandler implements FatalErrorHandler {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(TestingFatalErrorHandler.class);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final AtomicReference&amp;lt;Throwable&amp;gt; atomicThrowable;&lt;br/&gt;
    +	private CompletableFuture&amp;lt;Throwable&amp;gt; errorFuture;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	public TestingFatalErrorHandler() &lt;/p&gt;
{
    -		atomicThrowable = new AtomicReference&amp;lt;&amp;gt;(null);
    +		errorFuture = new CompletableFuture&amp;lt;&amp;gt;();
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void rethrowError() throws TestingException {&lt;/li&gt;
	&lt;li&gt;Throwable throwable = atomicThrowable.get();&lt;br/&gt;
    +	public synchronized void rethrowError() throws TestingException {&lt;br/&gt;
    +		final Throwable throwable = getException();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (throwable != null) &lt;/p&gt;
{
    -			throw new TestingException(throwable);
    +            throw new TestingException(throwable);
    +        }
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public synchronized boolean hasExceptionOccurred() &lt;/p&gt;
{
    +		return errorFuture.isDone();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
    +	public synchronized Throwable getException() {&lt;br/&gt;
    +		if (errorFuture.isDone()) {&lt;br/&gt;
    +			Throwable throwable = null;&lt;br/&gt;
    +&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				throwable = errorFuture.get();
    +			}
&lt;p&gt; catch (InterruptedException ie) {&lt;br/&gt;
    +				Thread.interrupted();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Arg, very good comment. There is a reason why there are utils like `ExceptionUtils`... Will fix it right away.&lt;/p&gt;</comment>
                            <comment id="16417363" author="githubbot" created="Wed, 28 Mar 2018 13:56:51 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @GJL. I&apos;ve addressed your comments.&lt;/p&gt;</comment>
                            <comment id="16418045" author="githubbot" created="Wed, 28 Mar 2018 20:17:15 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5746&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16418047" author="till.rohrmann" created="Wed, 28 Mar 2018 20:17:51 +0000"  >&lt;p&gt;Fixed via &lt;br/&gt;
master: aa6cf3539bc895211a44476a50b30d70e1759ad1&lt;br/&gt;
1.5.0: cd9009d962fa2b56028da4d014c27fb3cb3d5a23&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3radr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>