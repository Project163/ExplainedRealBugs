<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:16:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-31293] Request memory segment from LocalBufferPool may hanging forever.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-31293</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In our TPC-DS test, we found that in the case of fierce competition in network memory, some tasks may hanging forever.&lt;/p&gt;

&lt;p&gt;From the thread dump information, we can see that the task is waiting for the &lt;tt&gt;LocalBufferPool&lt;/tt&gt; to become available. It is strange that other tasks have finished and released network memory already. Undoubtedly, this is an unexpected behavior, which implies that there must be a bug in the &lt;tt&gt;LocalBufferPool&lt;/tt&gt; or &lt;tt&gt;NetworkBufferPool&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13055956/13055956_image-2023-03-02-12-23-50-572.png&quot; height=&quot;153&quot; width=&quot;650&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;By dumping the heap memory, we can find a strange phenomenon that there are available buffers in the &lt;tt&gt;LocalBufferPool&lt;/tt&gt;, but it was considered to be un-available. Another thing to note is that it now holds an overdraft buffer.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13055957/13055957_image-2023-03-02-12-28-48-437.png&quot; height=&quot;200&quot; width=&quot;520&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13055958/13055958_image-2023-03-02-12-29-03-003.png&quot; height=&quot;84&quot; width=&quot;438&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;TL;DR: This problem occurred in multi-thread race related to the introduction of overdraft buffer.&lt;/p&gt;

&lt;p&gt;Suppose we have two threads, called A and B. For simplicity, &lt;tt&gt;LocalBufferPool&lt;/tt&gt; is called &lt;tt&gt;LocalPool&lt;/tt&gt; and &lt;tt&gt;NetworkBufferPool&lt;/tt&gt; is called &lt;tt&gt;GlobalPool&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Thread A continuously request buffers blocking from the &lt;tt&gt;LocalPool&lt;/tt&gt;.&lt;br/&gt;
Thread B continuously return buffers to &lt;tt&gt;GlobalPool&lt;/tt&gt;.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;If thread A takes the last available buffer of &lt;tt&gt;LocalPool&lt;/tt&gt;, but &lt;tt&gt;GlobalPool&lt;/tt&gt; does not have a buffer at this time, it will register a callback function with &lt;tt&gt;GlobalPool&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Thread B returns one buffer to &lt;tt&gt;GlobalPool&lt;/tt&gt;, but has not started to trigger the callback.&lt;/li&gt;
	&lt;li&gt;Thread A continues to request buffer. Because the &lt;tt&gt;availableMemorySegments&lt;/tt&gt; of &lt;tt&gt;LocalPool&lt;/tt&gt; is empty, it requests the overdraftBuffer instead. But there is already a buffer in the &lt;tt&gt;GlobalPool&lt;/tt&gt;, it successfully gets the buffer.&lt;/li&gt;
	&lt;li&gt;Thread B triggers the callback. Since there is no buffer in &lt;tt&gt;GlobalPool&lt;/tt&gt; now, the callback is re-registered.&lt;/li&gt;
	&lt;li&gt;Thread A continues to request buffer. Because there is no buffer in &lt;tt&gt;GlobalPool&lt;/tt&gt;, it will block on &lt;tt&gt;CompletableFuture#get&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Thread B continues to return a buffer and triggers the recently registered callback. As a result, &lt;tt&gt;LocalPool&lt;/tt&gt; puts the buffer into &lt;tt&gt;availableMemorySegments&lt;/tt&gt;. Unfortunately, the current logic of &lt;tt&gt;shouldBeAvailable&lt;/tt&gt; method is: if there is an overdraft buffer, &lt;tt&gt;LocalPool&lt;/tt&gt; is considered as un-available.&lt;/li&gt;
	&lt;li&gt;Thread A will keep blocking forever.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13526796">FLINK-31293</key>
            <summary>Request memory segment from LocalBufferPool may hanging forever.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Weijie Guo">Weijie Guo</assignee>
                                    <reporter username="Weijie Guo">Weijie Guo</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 2 Mar 2023 04:21:49 +0000</created>
                <updated>Tue, 4 Apr 2023 02:37:49 +0000</updated>
                            <resolved>Tue, 4 Apr 2023 02:36:37 +0000</resolved>
                                    <version>1.17.0</version>
                    <version>1.16.1</version>
                    <version>1.18.0</version>
                                    <fixVersion>1.16.2</fixVersion>
                    <fixVersion>1.18.0</fixVersion>
                    <fixVersion>1.17.1</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="17708190" author="weijie guo" created="Tue, 4 Apr 2023 02:36:37 +0000"  >&lt;p&gt;master(1.18) via fb6caee13710348a9b53284c2cabbdb2e7aa9739.&lt;br/&gt;
release-1.17 via 6a476bee5e452d1f172173ec018939c8a154886c.&lt;br/&gt;
release-1.16 via 9582727387d368d1b9e358aedb55c3f2eaae4371.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13524996">FLINK-31104</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13434830">FLINK-26762</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13055956" name="image-2023-03-02-12-23-50-572.png" size="906373" author="Weijie Guo" created="Thu, 2 Mar 2023 04:23:57 +0000"/>
                            <attachment id="13055957" name="image-2023-03-02-12-28-48-437.png" size="894191" author="Weijie Guo" created="Thu, 2 Mar 2023 04:28:51 +0000"/>
                            <attachment id="13055958" name="image-2023-03-02-12-29-03-003.png" size="150956" author="Weijie Guo" created="Thu, 2 Mar 2023 04:29:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1gafk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>