<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10263] User-defined function with LITERAL paramters yields CompileException</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10263</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When using a user-defined scalar function only with literal parameters, a &lt;tt&gt;CompileException&lt;/tt&gt; is thrown. For example&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SELECT myFunc(CAST(40.750444 AS FLOAT), CAST(-73.993475 AS FLOAT))

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyFunc &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ScalarFunction {

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; eval(&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; lon, &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; lat) {
		&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; something
&lt;/span&gt;	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;results in &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[ERROR] Could not execute SQL statement. Reason:
org.codehaus.commons.compiler.CompileException: Line 5, Column 10: Cannot determine simple type name &lt;span class=&quot;code-quote&quot;&gt;&quot;com&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is probably caused by the expression reducer because it disappears if a regular attribute is added to a parameter expression.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13182166">FLINK-10263</key>
            <summary>User-defined function with LITERAL paramters yields CompileException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="twalthr">Timo Walther</assignee>
                                    <reporter username="fhueske">Fabian Hueske</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 30 Aug 2018 15:56:30 +0000</created>
                <updated>Wed, 17 Oct 2018 08:47:49 +0000</updated>
                            <resolved>Wed, 26 Sep 2018 08:18:35 +0000</resolved>
                                    <version>1.6.1</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16622274" author="githubbot" created="Thu, 20 Sep 2018 16:14:09 +0000"  >&lt;p&gt;twalthr opened a new pull request #6725: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10263&quot; title=&quot;User-defined function with LITERAL paramters yields CompileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10263&quot;&gt;&lt;del&gt;FLINK-10263&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sql-client&amp;#93;&lt;/span&gt; Fix classloader issues in SQL Client&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6725&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Fixes classloading issues when using a UDF with constant parameters. Every&lt;br/&gt;
   optimization might need to compile code (i.e. for constant folding), thus,&lt;br/&gt;
   needs access to the user-code classloader.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Set SQL Client&apos;s execution context class loader as thread classloader and use it for constant folding.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   End-to-end test has been extended.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: no&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? not applicable&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16623191" author="githubbot" created="Fri, 21 Sep 2018 07:26:05 +0000"  >&lt;p&gt;dawidwys commented on a change in pull request #6725: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10263&quot; title=&quot;User-defined function with LITERAL paramters yields CompileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10263&quot;&gt;&lt;del&gt;FLINK-10263&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sql-client&amp;#93;&lt;/span&gt; Fix classloader issues in SQL Client&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6725#discussion_r219405018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6725#discussion_r219405018&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/ExecutionContext.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -183,6 +184,21 @@ public EnvironmentInstance createEnvironmentInstance() &lt;/p&gt;
{
 		return tableSinks;
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Executes the given supplier using the execution context&apos;s classloader as thread classloader.&lt;br/&gt;
+	 */&lt;br/&gt;
+	public &amp;lt;R&amp;gt; R wrapClassLoader(Supplier&amp;lt;R&amp;gt; supplier) {&lt;br/&gt;
+		final ClassLoader previousClassloader = Thread.currentThread().getContextClassLoader();&lt;br/&gt;
+		Thread.currentThread().setContextClassLoader(classLoader);&lt;br/&gt;
+		R returnValue;&lt;br/&gt;
+		try {&lt;br/&gt;
+			returnValue = supplier.get();&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Can&apos;t we just return it here?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16623381" author="githubbot" created="Fri, 21 Sep 2018 10:24:14 +0000"  >&lt;p&gt;twalthr commented on issue #6725: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10263&quot; title=&quot;User-defined function with LITERAL paramters yields CompileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10263&quot;&gt;&lt;del&gt;FLINK-10263&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sql-client&amp;#93;&lt;/span&gt; Fix classloader issues in SQL Client&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6725#issuecomment-423486904&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6725#issuecomment-423486904&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thank you @dawidwys. I simplified the code there.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16627711" author="githubbot" created="Tue, 25 Sep 2018 17:46:53 +0000"  >&lt;p&gt;asfgit closed pull request #6725: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10263&quot; title=&quot;User-defined function with LITERAL paramters yields CompileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10263&quot;&gt;&lt;del&gt;FLINK-10263&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sql-client&amp;#93;&lt;/span&gt; Fix classloader issues in SQL Client&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6725&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-end-to-end-tests/test-scripts/test_sql_client.sh b/flink-end-to-end-tests/test-scripts/test_sql_client.sh&lt;br/&gt;
index b5830725db1..ca0251365e6 100755&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/test-scripts/test_sql_client.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/test_sql_client.sh&lt;br/&gt;
@@ -212,6 +212,8 @@ tables:&lt;br/&gt;
         type: VARCHAR&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;name: duplicate_count&lt;br/&gt;
         type: BIGINT&lt;br/&gt;
+      - name: constant&lt;br/&gt;
+        type: VARCHAR&lt;br/&gt;
     connector:&lt;br/&gt;
       type: filesystem&lt;br/&gt;
       path: $RESULT&lt;br/&gt;
@@ -226,6 +228,8 @@ tables:&lt;br/&gt;
           type: VARCHAR&lt;/li&gt;
	&lt;li&gt;name: duplicate_count&lt;br/&gt;
           type: BIGINT&lt;br/&gt;
+        - name: constant&lt;br/&gt;
+          type: VARCHAR&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; functions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;name: RegReplace&lt;br/&gt;
@@ -261,7 +265,7 @@ $FLINK_DIR/bin/sql-client.sh embedded \&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; read -r -d &apos;&apos; SQL_STATEMENT_2 &amp;lt;&amp;lt; EOF&lt;br/&gt;
 INSERT INTO CsvSinkTable&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;SELECT *&lt;br/&gt;
+  SELECT AvroBothTable.*, RegReplace(&apos;Test constant folding.&apos;, &apos;Test&apos;, &apos;Success&apos;) AS constant&lt;br/&gt;
   FROM AvroBothTable&lt;br/&gt;
 EOF&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -285,4 +289,4 @@ for i in &lt;/p&gt;
{1..10}
&lt;p&gt;; do&lt;br/&gt;
   sleep 5&lt;br/&gt;
 done&lt;/p&gt;

&lt;p&gt;-check_result_hash &quot;SQLClient&quot; $RESULT &quot;dca08a82cc09f6b19950291dbbef16bb&quot;&lt;br/&gt;
+check_result_hash &quot;SQLClient&quot; $RESULT &quot;0a1bf8bf716069b7269f575f87a802c0&quot;&lt;br/&gt;
diff --git a/flink-libraries/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/ExecutionContext.java b/flink-libraries/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/ExecutionContext.java&lt;br/&gt;
index 85b3e9265a8..552d0b37dca 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/ExecutionContext.java&lt;br/&gt;
+++ b/flink-libraries/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/ExecutionContext.java&lt;br/&gt;
@@ -75,6 +75,7 @@&lt;br/&gt;
 import java.util.HashMap;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
+import java.util.function.Supplier;&lt;/p&gt;

&lt;p&gt; /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Context for executing table programs. This class caches everything that can be cached across&lt;br/&gt;
@@ -183,6 +184,19 @@ public EnvironmentInstance createEnvironmentInstance() 
{
 		return tableSinks;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+	/**&lt;br/&gt;
+	 * Executes the given supplier using the execution context&apos;s classloader as thread classloader.&lt;br/&gt;
+	 */&lt;br/&gt;
+	public &amp;lt;R&amp;gt; R wrapClassLoader(Supplier&amp;lt;R&amp;gt; supplier) {&lt;br/&gt;
+		final ClassLoader previousClassloader = Thread.currentThread().getContextClassLoader();&lt;br/&gt;
+		Thread.currentThread().setContextClassLoader(classLoader);&lt;br/&gt;
+		try &lt;/p&gt;
{
+			return supplier.get();
+		}
&lt;p&gt; finally &lt;/p&gt;
{
+			Thread.currentThread().setContextClassLoader(previousClassloader);
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
 	// --------------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt; 	private static CommandLine createCommandLine(Deployment deployment, Options commandLineOptions) {&lt;br/&gt;
diff --git a/flink-libraries/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/LocalExecutor.java b/flink-libraries/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/LocalExecutor.java&lt;br/&gt;
index 3b9e8e99b82..1318043faf1 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/LocalExecutor.java&lt;br/&gt;
+++ b/flink-libraries/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/LocalExecutor.java&lt;br/&gt;
@@ -219,14 +219,16 @@ public TableSchema getTableSchema(SessionContext session, String name) throws Sq&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public String explainStatement(SessionContext session, String statement) throws SqlExecutionException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final TableEnvironment tableEnv = getOrCreateExecutionContext(session)&lt;br/&gt;
+		final ExecutionContext&amp;lt;?&amp;gt; context = getOrCreateExecutionContext(session);&lt;br/&gt;
+		final TableEnvironment tableEnv = context&lt;br/&gt;
 			.createEnvironmentInstance()&lt;br/&gt;
 			.getTableEnvironment();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		// translate&lt;br/&gt;
 		try &lt;/p&gt;
{
 			final Table table = createTable(tableEnv, statement);
-			return tableEnv.explain(table);
+			// explanation requires an optimization step that might reference UDFs during code compilation
+			return context.wrapClassLoader(() -&amp;gt; tableEnv.explain(table));
 		}
&lt;p&gt; catch (Throwable t) {&lt;br/&gt;
 			// catch everything such that the query does not crash the executor&lt;br/&gt;
 			throw new SqlExecutionException(&quot;Invalid SQL statement.&quot;, t);&lt;br/&gt;
@@ -242,7 +244,7 @@ public ResultDescriptor executeQuery(SessionContext session, String query) throw&lt;br/&gt;
 	@Override&lt;br/&gt;
 	public TypedResult&amp;lt;List&amp;lt;Tuple2&amp;lt;Boolean, Row&amp;gt;&amp;gt;&amp;gt; retrieveResultChanges(SessionContext session,&lt;br/&gt;
 			String resultId) throws SqlExecutionException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final DynamicResult result = resultStore.getResult(resultId);&lt;br/&gt;
+		final DynamicResult&amp;lt;?&amp;gt; result = resultStore.getResult(resultId);&lt;br/&gt;
 		if (result == null) 
{
 			throw new SqlExecutionException(&quot;Could not find a result with result identifier &apos;&quot; + resultId + &quot;&apos;.&quot;);
 		}&lt;br/&gt;
@@ -254,7 +256,7 @@ public ResultDescriptor executeQuery(SessionContext session, String query) throw&lt;br/&gt;
 &lt;br/&gt;
 	@Override&lt;br/&gt;
 	public TypedResult&amp;lt;Integer&amp;gt; snapshotResult(SessionContext session, String resultId, int pageSize) throws SqlExecutionException {&lt;br/&gt;
-		final DynamicResult result = resultStore.getResult(resultId);&lt;br/&gt;
+		final DynamicResult&amp;lt;?&amp;gt; result = resultStore.getResult(resultId);&lt;br/&gt;
 		if (result == null) { 			throw new SqlExecutionException(&quot;Could not find a result with result identifier &apos;&quot; + resultId + &quot;&apos;.&quot;); 		}
&lt;p&gt;@@ -266,7 +268,7 @@ public ResultDescriptor executeQuery(SessionContext session, String query) throw&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Override&lt;br/&gt;
 	public List&amp;lt;Row&amp;gt; retrieveResultPage(String resultId, int page) throws SqlExecutionException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final DynamicResult result = resultStore.getResult(resultId);&lt;br/&gt;
+		final DynamicResult&amp;lt;?&amp;gt; result = resultStore.getResult(resultId);&lt;br/&gt;
 		if (result == null) 
{
 			throw new SqlExecutionException(&quot;Could not find a result with result identifier &apos;&quot; + resultId + &quot;&apos;.&quot;);
 		}
&lt;p&gt;@@ -350,7 +352,7 @@ public void stop(SessionContext session) {&lt;br/&gt;
 	private &amp;lt;C&amp;gt; ProgramTargetDescriptor executeUpdateInternal(ExecutionContext&amp;lt;C&amp;gt; context, String statement) {&lt;br/&gt;
 		final ExecutionContext.EnvironmentInstance envInst = context.createEnvironmentInstance();&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;applyUpdate(envInst.getTableEnvironment(), envInst.getQueryConfig(), statement);&lt;br/&gt;
+		applyUpdate(context, envInst.getTableEnvironment(), envInst.getQueryConfig(), statement);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		// create job graph with dependencies&lt;br/&gt;
 		final String jobName = context.getSessionContext().getName() + &quot;: &quot; + statement;&lt;br/&gt;
@@ -392,7 +394,11 @@ public void stop(SessionContext session) {&lt;br/&gt;
 		final String jobName = context.getSessionContext().getName() + &quot;: &quot; + query;&lt;br/&gt;
 		final JobGraph jobGraph;&lt;br/&gt;
 		try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;table.writeToSink(result.getTableSink(), envInst.getQueryConfig());&lt;br/&gt;
+			// writing to a sink requires an optimization step that might reference UDFs during code compilation&lt;br/&gt;
+			context.wrapClassLoader(() -&amp;gt; 
{
+				table.writeToSink(result.getTableSink(), envInst.getQueryConfig());
+				return null;
+			}
&lt;p&gt;);&lt;br/&gt;
 			jobGraph = envInst.createJobGraph(jobName);&lt;br/&gt;
 		} catch (Throwable t) {&lt;br/&gt;
 			// the result needs to be closed as long as&lt;br/&gt;
@@ -435,10 +441,14 @@ private Table createTable(TableEnvironment tableEnv, String selectQuery) {&lt;br/&gt;
 	/**&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;Applies the given update statement to the given table environment with query configuration.&lt;br/&gt;
 	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void applyUpdate(TableEnvironment tableEnv, QueryConfig queryConfig, String updateStatement) {&lt;br/&gt;
+	private &amp;lt;C&amp;gt; void applyUpdate(ExecutionContext&amp;lt;C&amp;gt; context, TableEnvironment tableEnv, QueryConfig queryConfig, String updateStatement) {&lt;br/&gt;
 		// parse and validate statement&lt;br/&gt;
 		try {&lt;/li&gt;
	&lt;li&gt;tableEnv.sqlUpdate(updateStatement, queryConfig);&lt;br/&gt;
+			// update statement requires an optimization step that might reference UDFs during code compilation&lt;br/&gt;
+			context.wrapClassLoader(() -&amp;gt; 
{
+				tableEnv.sqlUpdate(updateStatement, queryConfig);
+				return null;
+			}
&lt;p&gt;);&lt;br/&gt;
 		} catch (Throwable t) {&lt;br/&gt;
 			// catch everything such that the statement does not crash the executor&lt;br/&gt;
 			throw new SqlExecutionException(&quot;Invalid SQL update statement.&quot;, t);&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/codegen/ExpressionReducer.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/codegen/ExpressionReducer.scala&lt;br/&gt;
index f58e12cfea2..2b50bb92c9a 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/codegen/ExpressionReducer.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/codegen/ExpressionReducer.scala&lt;br/&gt;
@@ -23,7 +23,6 @@ import java.util&lt;br/&gt;
 import org.apache.calcite.plan.RelOptPlanner&lt;br/&gt;
 import org.apache.calcite.rex.
{RexBuilder, RexNode}
&lt;p&gt; import org.apache.calcite.sql.`type`.SqlTypeName&lt;br/&gt;
-import org.apache.commons.lang3.StringEscapeUtils&lt;br/&gt;
 import org.apache.flink.api.common.functions.MapFunction&lt;br/&gt;
 import org.apache.flink.api.common.typeinfo.BasicTypeInfo&lt;br/&gt;
 import org.apache.flink.api.java.typeutils.RowTypeInfo&lt;br/&gt;
@@ -101,7 +100,10 @@ class ExpressionReducer(config: TableConfig)&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&quot;&quot;&quot;.stripMargin,&lt;br/&gt;
       resultType)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val clazz = compile(getClass.getClassLoader, generatedFunction.name, generatedFunction.code)&lt;br/&gt;
+    val clazz = compile(&lt;br/&gt;
+      Thread.currentThread().getContextClassLoader,&lt;br/&gt;
+      generatedFunction.name,&lt;br/&gt;
+      generatedFunction.code)&lt;br/&gt;
     val function = clazz.newInstance()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     // execute&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16628402" author="twalthr" created="Wed, 26 Sep 2018 08:18:35 +0000"  >&lt;p&gt;Fixed in 1.7.0: 116347ea179bdcf0a8eb33581c744143374057a0&lt;br/&gt;
Fixed in 1.6.2: 4acb90474d18427e45ee0a274fd88cf963d9220c&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 7 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xlhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>