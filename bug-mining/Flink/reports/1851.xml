<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:29:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7231] SlotSharingGroups are not always released in time for new restarts</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7231</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In the case where there are not enough resources to schedule the streaming program, a race condition can lead to a sequence of the following errors:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalStateException: SlotSharingGroup cannot clear task assignment, group still has allocated resources.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This eventually recovers, but may involve many fast restart attempts before doing so.&lt;/p&gt;

&lt;p&gt;The root cause is that slots are not cleared before the next restart attempt.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13088457">FLINK-7231</key>
            <summary>SlotSharingGroups are not always released in time for new restarts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Jul 2017 16:15:45 +0000</created>
                <updated>Wed, 2 Oct 2019 17:44:13 +0000</updated>
                            <resolved>Wed, 8 Nov 2017 13:29:15 +0000</resolved>
                                    <version>1.3.1</version>
                                    <fixVersion>1.3.2</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16093378" author="githubbot" created="Wed, 19 Jul 2017 16:36:23 +0000"  >&lt;p&gt;GitHub user StephanEwen opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4370&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4370&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7231&quot; title=&quot;SlotSharingGroups are not always released in time for new restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7231&quot;&gt;&lt;del&gt;FLINK-7231&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;distr. coordination&amp;#93;&lt;/span&gt; Fix slot release affecting SlotSharingGroup cleanup&lt;/p&gt;

&lt;p&gt;    *&lt;b&gt;This is base on #4364 so only the last commit is relevant&lt;/b&gt;*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7231&quot; title=&quot;SlotSharingGroups are not always released in time for new restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7231&quot;&gt;&lt;del&gt;FLINK-7231&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7231&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-7231&lt;/a&gt;) - a bug making restarts unstable in the presence of certain combination of slot sharing, losses of TaskManagers, and restart strategies.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Minimal adjustment in `ExecutionGraph`: On failed resource acquisition, release slots (and with that sharing group assignments) before triggering the recovery. Before this change, both happened concurrently/asynchronously (and recovery may have overtaken slot release).&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change adds additional unit tests:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`ExecutionGraphRestartTest#testRestartWithEagerSchedulingAndSlotSharing()`&lt;/li&gt;
	&lt;li&gt;`ExecutionGraphRestartTest#testRestartWithSlotSharingAndNotEnoughResources()`&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The effect (and fix) can also be observed by repeatedly trying the following:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Create a streaming job with multiple JobVertices&lt;/li&gt;
	&lt;li&gt;Set the restart strategy to fixed-delay with zero delay&lt;/li&gt;
	&lt;li&gt;Run the job&lt;/li&gt;
	&lt;li&gt;Repeat: Kill TaskManager and bring up recovery TaskManager. There is a good chance that various restarts are affected by `java.lang.IllegalStateException: SlotSharingGroup cannot clear task assignment, group still has allocated resources.`, meaning they take long before actually recovering.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: *&lt;b&gt;(no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The serializers: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: *&lt;b&gt;yes&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? *&lt;b&gt;not applicable&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StephanEwen/incubator-flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StephanEwen/incubator-flink&lt;/a&gt; sharing_group_bug&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4370.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4370.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4370&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f055645b3d905ea212b11eb570926d46447f3f52&lt;br/&gt;
Author: zjureel &amp;lt;zjureel@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-18T17:27:56Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6665&quot; title=&quot;Pass a ScheduledExecutorService to the RestartStrategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6665&quot;&gt;&lt;del&gt;FLINK-6665&lt;/del&gt;&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6667&quot; title=&quot;Pass a callback type to the RestartStrategy, rather than the full ExecutionGraph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6667&quot;&gt;&lt;del&gt;FLINK-6667&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;distributed coordination&amp;#93;&lt;/span&gt; Use a callback and a ScheduledExecutor for ExecutionGraph restarts&lt;/p&gt;

&lt;p&gt;    Initial work by zjureel@gmail.com , improved by sewen@apache.org.&lt;/p&gt;

&lt;p&gt;commit 11e2144892a57c58ffe919ac228c702595f34025&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-07-18T17:49:56Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7216&quot; title=&quot;ExecutionGraph can perform concurrent global restarts to scheduling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7216&quot;&gt;&lt;del&gt;FLINK-7216&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;distr. coordination&amp;#93;&lt;/span&gt; Guard against concurrent global failover&lt;/p&gt;

&lt;p&gt;commit 16e9e133e0ed9dfba2d177c8f789f1b215a7759e&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-07-19T08:24:52Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7231&quot; title=&quot;SlotSharingGroups are not always released in time for new restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7231&quot;&gt;&lt;del&gt;FLINK-7231&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;distr. coordination&amp;#93;&lt;/span&gt; Fix slot release affecting SlotSharingGroup cleanup&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16093418" author="aljoscha" created="Wed, 19 Jul 2017 17:05:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; this is also a blocker? Asking because fixVersion is 1.3.2.&lt;/p&gt;</comment>
                            <comment id="16094599" author="githubbot" created="Thu, 20 Jul 2017 12:15:36 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4370#discussion_r128497552&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4370#discussion_r128497552&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/executiongraph/ExecutionGraphRestartTest.java &amp;#8212;&lt;br/&gt;
    @@ -661,10 +682,117 @@ public void testConcurrentGlobalFailAndRestarts() throws Exception {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	@Test&lt;br/&gt;
    +	public void testRestartWithEagerSchedulingAndSlotSharing() throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Does this test just further verify existing behaviour? I&apos;m asking because it doesn&apos;t fail when changing the order of slot release and restart back to the original order.&lt;/p&gt;</comment>
                            <comment id="16094688" author="githubbot" created="Thu, 20 Jul 2017 13:32:52 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4370#discussion_r128514948&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4370#discussion_r128514948&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/executiongraph/ExecutionGraphRestartTest.java &amp;#8212;&lt;br/&gt;
    @@ -661,10 +682,117 @@ public void testConcurrentGlobalFailAndRestarts() throws Exception {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	@Test&lt;br/&gt;
    +	public void testRestartWithEagerSchedulingAndSlotSharing() throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Exactly, it extends test coverage to possible related conditions.&lt;br/&gt;
    I realized that we had no test about the &quot;happy path&quot; of eager scheduling and slot sharing as well.&lt;/p&gt;</comment>
                            <comment id="16094693" author="githubbot" created="Thu, 20 Jul 2017 13:35:54 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4370&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4370&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review!&lt;br/&gt;
    Merging this...&lt;/p&gt;

&lt;p&gt;    The commit by Niko was probably because github was slightly out of sync with the apache git repo and thought that commit was part of the diff...&lt;/p&gt;</comment>
                            <comment id="16098091" author="githubbot" created="Mon, 24 Jul 2017 08:48:00 +0000"  >&lt;p&gt;Github user StephanEwen closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4370&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4370&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16243922" author="aljoscha" created="Wed, 8 Nov 2017 13:29:07 +0000"  >&lt;p&gt;Reopen to fix release note.&lt;/p&gt;</comment>
                            <comment id="16243923" author="aljoscha" created="Wed, 8 Nov 2017 13:29:15 +0000"  >&lt;p&gt;Fixed in&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1.4.0 via 605319b550aeba5612b0e32fa193521081b7adc5&lt;/li&gt;
	&lt;li&gt;1.3.2 via 39f5b1144167dcb80e8708f4cb5426e76f648026&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 1 week, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hqxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>