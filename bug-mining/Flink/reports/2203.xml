<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8484] Kinesis consumer re-reads closed shards on job restart</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8484</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We&#8217;re using the connector to subscribe to streams varying from 1 to a 100 shards, and used the kinesis-scaling-utils to dynamically scale the Kinesis stream up and down during peak times. What we&#8217;ve noticed is that, while we were having closed shards, any Flink job restart with check- or save-point would result in shards being re-read from the event horizon, duplicating our events.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We started checking the checkpoint state, and found that the shards were stored correctly with the proper sequence number (including for closed shards), but that upon restarts, the older closed shards would be read from the event horizon, as if their restored state would be ignored.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the end, we believe that we found the problem: in the FlinkKinesisConsumer&#8217;s run() method, we&#8217;re trying to find the shard returned from the KinesisDataFetcher against the shards&#8217; metadata from the restoration point, but we do this via a containsKey() call, which means we&#8217;ll use the StreamShardMetadata&#8217;s equals() method. However, this checks for all properties, including the endingSequenceNumber, which might have changed between the restored state&#8217;s checkpoint and our data fetch, thus failing the equality check, failing the containsKey() check, and resulting in the shard being re-read from the event horizon, even though it was present in the restored state.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We&#8217;ve created a workaround where we only check for the shardId and stream name to restore the state of the shards we&#8217;ve already seen, and this seems to work correctly.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13132805">FLINK-8484</key>
            <summary>Kinesis consumer re-reads closed shards on job restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pluppens">Philip Luppens</assignee>
                                    <reporter username="pluppens">Philip Luppens</reporter>
                        <labels>
                            <label>bug</label>
                            <label>flink</label>
                            <label>kinesis</label>
                    </labels>
                <created>Mon, 22 Jan 2018 17:15:20 +0000</created>
                <updated>Mon, 12 Mar 2018 15:28:05 +0000</updated>
                            <resolved>Mon, 12 Mar 2018 15:28:05 +0000</resolved>
                                    <version>1.3.2</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.3.4</fixVersion>
                    <fixVersion>1.4.1</fixVersion>
                    <fixVersion>1.5.0</fixVersion>
                                    <component>Connectors / Kinesis</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16335479" author="githubbot" created="Tue, 23 Jan 2018 08:10:55 +0000"  >&lt;p&gt;GitHub user pluppens opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8484&quot; title=&quot;Kinesis consumer re-reads closed shards on job restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8484&quot;&gt;&lt;del&gt;FLINK-8484&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flink-kinesis-connector&amp;#93;&lt;/span&gt; Ensure a Kinesis consumer snapshot restoration is able to handle recently closed shards&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8484&quot; title=&quot;Kinesis consumer re-reads closed shards on job restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8484&quot;&gt;&lt;del&gt;FLINK-8484&lt;/del&gt;&lt;/a&gt;: ensure that a state change in the StreamShardMetadata other than `StreamShardMetadata.shardId` or `StreamShardMetadata.streamName` does not result in the shard not being able to be restored. This handles the corner case where a shard might have been closed (ending sequence number set to not-null) since the last savepoint or checkpoint when a job is restarted from a snapshot state.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Created a new method to perform the sequence number lookup&lt;/li&gt;
	&lt;li&gt;Ensure that a lookup for a given existing Kinesis shard does not rely on equals(), but rather checks for equality on the stream name and shard id only&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change added tests and can be verified as follows:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;A new unit test was added in `FlinkKinesisConsumerTest` called `testFindSequenceNumberToRestoreFrom()` which tests the lookup mechanism&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: yes&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? not applicable&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/pluppens/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pluppens/flink&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5337&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 5c756390002a2e1c00c7368bea3e1135b7722a20&lt;br/&gt;
Author: Philip Luppens &amp;lt;philip.luppens@...&amp;gt;&lt;br/&gt;
Date:   2018-01-23T08:00:23Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8484&quot; title=&quot;Kinesis consumer re-reads closed shards on job restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8484&quot;&gt;&lt;del&gt;FLINK-8484&lt;/del&gt;&lt;/a&gt;: ensure that a state change in the StreamShardMetadata other than `StreamShardMetadata.shardId` or `StreamShardMetadata.streamName` does not result in the shard not being able to be restored. This handles the corner case where a shard might have been closed (ending sequence number set to not-null) since the last savepoint or checkpoint when a job is restarted from a snapshot state.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16335523" author="githubbot" created="Tue, 23 Jan 2018 08:56:51 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337#discussion_r163175172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337#discussion_r163175172&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kinesis/src/main/java/org/apache/flink/streaming/connectors/kinesis/FlinkKinesisConsumer.java &amp;#8212;&lt;br/&gt;
    @@ -210,16 +210,18 @@ public void run(SourceContext&amp;lt;T&amp;gt; sourceContext) throws Exception {&lt;br/&gt;
     		for (StreamShardHandle shard : allShards) {&lt;br/&gt;
     			StreamShardMetadata kinesisStreamShard = KinesisDataFetcher.convertToStreamShardMetadata(shard);&lt;br/&gt;
     			if (sequenceNumsToRestore != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (sequenceNumsToRestore.containsKey(kinesisStreamShard)) {&lt;br/&gt;
    +				// find the sequence number for the given converted kinesis shard in our restored state
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: Capital &apos;K&apos; for Kinesis&lt;/p&gt;</comment>
                            <comment id="16335524" author="githubbot" created="Tue, 23 Jan 2018 08:56:51 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337#discussion_r163176506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337#discussion_r163176506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kinesis/src/test/java/org/apache/flink/streaming/connectors/kinesis/FlinkKinesisConsumerTest.java &amp;#8212;&lt;br/&gt;
    @@ -515,6 +515,56 @@ public void testStreamShardMetadataSerializedUsingPojoSerializer() &lt;/p&gt;
{
     		assertTrue(typeInformation.createSerializer(new ExecutionConfig()) instanceof PojoSerializer);
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8484&quot; title=&quot;Kinesis consumer re-reads closed shards on job restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8484&quot;&gt;&lt;del&gt;FLINK-8484&lt;/del&gt;&lt;/a&gt;: ensure that a state change in the StreamShardMetadata other than &lt;/p&gt;
{@link StreamShardMetadata#shardId}
&lt;p&gt; or&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link StreamShardMetadata#streamName}
&lt;p&gt; does not result in the shard not being able to be restored.&lt;br/&gt;
    +	 * This handles the corner case where the stored shard metadata is open (no ending sequence number), but after the&lt;br/&gt;
    +	 * job restore, the shard has been closed (ending number set) due to re-sharding, and we can no longer rely on&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link StreamShardMetadata#equals(Object)}
&lt;p&gt; to find back the sequence number in the collection of restored shard metadata.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testFindSequenceNumberToRestoreFrom() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Nice that a unit test is added for the method!&lt;/p&gt;

&lt;p&gt;    However, I think it would be even better if we also include a test which uses the `AbstractStreamOperatorTestHarness` to test this restore. That utility class allows taking a snapshot of the wrapped operator&apos;s state, and restoring it again with the snapshot.&lt;/p&gt;</comment>
                            <comment id="16335525" author="githubbot" created="Tue, 23 Jan 2018 08:56:52 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337#discussion_r163175349&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337#discussion_r163175349&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kinesis/src/main/java/org/apache/flink/streaming/connectors/kinesis/FlinkKinesisConsumer.java &amp;#8212;&lt;br/&gt;
    @@ -267,6 +269,27 @@ public void run(SourceContext&amp;lt;T&amp;gt; sourceContext) throws Exception &lt;/p&gt;
{
     		sourceContext.close();
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tries to find the &lt;/p&gt;
{@link SequenceNumber}
&lt;p&gt; for a given &lt;/p&gt;
{@code kinesisStreamShard}
&lt;p&gt; in the list of the restored stream shards&apos; metadata,&lt;br/&gt;
    +	 * by comparing the stream name and shard id for equality.&lt;br/&gt;
    +	 * @param current				the current Kinesis shard we&apos;re trying to find the restored sequence number for&lt;br/&gt;
    +	 * @param sequenceNumsToRestore	the restored sequence numbers&lt;br/&gt;
    +	 * @return the sequence number, if any, or &lt;/p&gt;
{@code null}
&lt;p&gt; if no matching shard is found&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	SequenceNumber findSequenceNumberToRestoreFrom(StreamShardMetadata current, HashMap&amp;lt;StreamShardMetadata, SequenceNumber&amp;gt; sequenceNumsToRestore) {&lt;br/&gt;
    +		checkNotNull(current.getStreamName(), &quot;Stream name not set on the current metadata shard&quot;);&lt;br/&gt;
    +		checkNotNull(current.getShardId(), &quot;Shard id not set on the current metadata shard&quot;);&lt;br/&gt;
    +&lt;br/&gt;
    +		for (final Map.Entry&amp;lt;StreamShardMetadata, SequenceNumber&amp;gt; entry : sequenceNumsToRestore.entrySet()) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The `final` is redundant here.&lt;/p&gt;</comment>
                            <comment id="16335528" author="tzulitai" created="Tue, 23 Jan 2018 08:58:52 +0000"  >&lt;p&gt;I think we should make this a blocker for 1.4.1 &amp;amp; 1.5.0, also.&lt;br/&gt;
Updating.&lt;/p&gt;</comment>
                            <comment id="16335689" author="githubbot" created="Tue, 23 Jan 2018 12:20:31 +0000"  >&lt;p&gt;Github user pluppens commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337#discussion_r163226460&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337#discussion_r163226460&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-connectors/flink-connector-kinesis/src/test/java/org/apache/flink/streaming/connectors/kinesis/FlinkKinesisConsumerTest.java &amp;#8212;&lt;br/&gt;
    @@ -515,6 +515,56 @@ public void testStreamShardMetadataSerializedUsingPojoSerializer() &lt;/p&gt;
{
     		assertTrue(typeInformation.createSerializer(new ExecutionConfig()) instanceof PojoSerializer);
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8484&quot; title=&quot;Kinesis consumer re-reads closed shards on job restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8484&quot;&gt;&lt;del&gt;FLINK-8484&lt;/del&gt;&lt;/a&gt;: ensure that a state change in the StreamShardMetadata other than &lt;/p&gt;
{@link StreamShardMetadata#shardId}
&lt;p&gt; or&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link StreamShardMetadata#streamName}
&lt;p&gt; does not result in the shard not being able to be restored.&lt;br/&gt;
    +	 * This handles the corner case where the stored shard metadata is open (no ending sequence number), but after the&lt;br/&gt;
    +	 * job restore, the shard has been closed (ending number set) due to re-sharding, and we can no longer rely on&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link StreamShardMetadata#equals(Object)}
&lt;p&gt; to find back the sequence number in the collection of restored shard metadata.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testFindSequenceNumberToRestoreFrom() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Makes sense. I&apos;ll look into it and see if I can find a way to test it as a whole.&lt;/p&gt;</comment>
                            <comment id="16335691" author="githubbot" created="Tue, 23 Jan 2018 12:21:23 +0000"  >&lt;p&gt;Github user pluppens commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Ok, so you&apos;d prefer to synchronize the state of the retrieve shard against the stored shards by comparing its stream name and shard id, before doing the containsKey() check?&lt;/p&gt;</comment>
                            <comment id="16335703" author="githubbot" created="Tue, 23 Jan 2018 12:27:32 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @pluppens yes, I think that would be the proper solution here.&lt;/p&gt;</comment>
                            <comment id="16335726" author="githubbot" created="Tue, 23 Jan 2018 12:40:33 +0000"  >&lt;p&gt;Github user pluppens commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Ok, that makes sense to me. Give me a bit to cook up both the new test and the new approach, and I&apos;ll update the PR. Thank you very much for the comments!&lt;/p&gt;</comment>
                            <comment id="16335762" author="githubbot" created="Tue, 23 Jan 2018 13:19:03 +0000"  >&lt;p&gt;Github user pluppens commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Just a small remark - from what I understood, the only property that &lt;b&gt;can&lt;/b&gt; change is the endingSequenceNumber - all other state should be considered as &apos;set once&apos;, so there should be no point in comparing other properties and synchronizing them - or did I miss something?&lt;/p&gt;</comment>
                            <comment id="16335765" author="githubbot" created="Tue, 23 Jan 2018 13:22:02 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @pluppens yes, that sounds correct.&lt;/p&gt;

&lt;p&gt;    `parentShardId`&lt;br/&gt;
    `adjacentParentShardId`&lt;br/&gt;
    `startingHashKey`&lt;br/&gt;
    `endingHashKey`&lt;br/&gt;
    `startingSequenceNumber`&lt;br/&gt;
    these should all be fixed once the shard is created by Kinesis.&lt;/p&gt;</comment>
                            <comment id="16336041" author="githubbot" created="Tue, 23 Jan 2018 16:42:49 +0000"  >&lt;p&gt;Github user pluppens commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Alright, I&apos;ve given it a quick stab - but the whole &apos;remove/update/re-add&apos; cycle is kinda ugly due to the hashcode change. And I&apos;ve just copied the test from the other example rather than using the harness, and the tests are pretty messy.&lt;/p&gt;</comment>
                            <comment id="16336373" author="githubbot" created="Tue, 23 Jan 2018 21:08:39 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I am not deeply into the Kinesis Consumer logic, just writing here to double check that we do not build a solution where state grows infinitely.&lt;/p&gt;

&lt;p&gt;    For example, it would not be feasible to hold onto all shard info forever (state would always grow), but there would need to be a way track all closed shards via constant state (like a threshold timestamp, sequence number, etc).&lt;/p&gt;</comment>
                            <comment id="16336396" author="githubbot" created="Tue, 23 Jan 2018 21:26:01 +0000"  >&lt;p&gt;Github user bowenli86 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;m wondering if this is valid? My understanding is that, by default, flink-connector-kinesis will get kinesis metadata (#shard, shard id, etc) every 10s (defined by DEFAULT_SHARD_DISCOVERY_INTERVAL_MILLIS)&lt;/p&gt;</comment>
                            <comment id="16337248" author="githubbot" created="Wed, 24 Jan 2018 09:36:58 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    re @StephanEwen &lt;br/&gt;
    yes, currently, state is still kept indefinitely for closed shards. A special `SHARD_END` marker sequence number is stored as the sequence number for closed shards, so that the consumer does not attempt to read them on restore.&lt;/p&gt;

&lt;p&gt;    A threshold timestamp could work if AWS API provides shard creation times. A threshold sequence numbers would also work if sequence numbers are always monotonically increasing across shards. Will need some investigation to see if this is feasible.&lt;br/&gt;
    Either way, I think this is an improvement out-of-scope for the issue at hand, and would also require some migration path from the old state (where this constant threshold state doesn&apos;t exist).&lt;/p&gt;

&lt;p&gt;    For 1.4.1 bugfix, I think we should continue with the current approach.&lt;br/&gt;
    It might make sense though, to fix this via a constant threshold state in 1.5.0.&lt;/p&gt;</comment>
                            <comment id="16337274" author="githubbot" created="Wed, 24 Jan 2018 09:41:11 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    re @bowenli86 &lt;br/&gt;
    yes, Kinesis shard metadata is fetched every `DEFAULT_SHARD_DISCOVERY_INTERVAL_MILLIS` millis.&lt;/p&gt;

&lt;p&gt;    Could you describe a bit more which part you don&apos;t think is valid?&lt;br/&gt;
    There&apos;s also a more detailed explanation of the issue here: &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Flink-Kinesis-Consumer-re-reading-merged-shards-upon-restart-td17917.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Flink-Kinesis-Consumer-re-reading-merged-shards-upon-restart-td17917.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16337346" author="githubbot" created="Wed, 24 Jan 2018 10:38:00 +0000"  >&lt;p&gt;Github user pluppens commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @bowenli86 we&apos;re passing the last-seen shardId, and the Kinesis call returns only newer shards. Not sure if that answers your remark - because I didn&apos;t really understand the question either.&lt;/p&gt;</comment>
                            <comment id="16338292" author="githubbot" created="Wed, 24 Jan 2018 21:54:56 +0000"  >&lt;p&gt;Github user bowenli86 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    good to have the background info from the email thread. I didn&apos;t have a full picture before&lt;/p&gt;</comment>
                            <comment id="16338913" author="githubbot" created="Thu, 25 Jan 2018 08:25:13 +0000"  >&lt;p&gt;Github user pluppens commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @bowenli86 Makes sense - I&apos;ve updated the description to contain the initial email/issue. HTH.&lt;/p&gt;</comment>
                            <comment id="16342608" author="githubbot" created="Sun, 28 Jan 2018 15:38:14 +0000"  >&lt;p&gt;Github user pluppens commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tzulitai Is there anything more I can do from my side?&lt;/p&gt;</comment>
                            <comment id="16346809" author="githubbot" created="Wed, 31 Jan 2018 13:26:16 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @pluppens the changes look good to merge! Thanks a lot for working on this.&lt;br/&gt;
    Will merge this for `release-1.4`, `release-1.3`, and `master` ..&lt;/p&gt;</comment>
                            <comment id="16347085" author="githubbot" created="Wed, 31 Jan 2018 16:22:08 +0000"  >&lt;p&gt;Github user pluppens commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks - we&apos;ve been running it in production for the last 5 days without issues, so it seems to work fine. We&apos;ll be enabling autoscaling of the streams in the coming hours, so if anything is amiss, it should pop up on our radar in the coming days.&lt;/p&gt;</comment>
                            <comment id="16347093" author="githubbot" created="Wed, 31 Jan 2018 16:27:17 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Great, thanks for the update!&lt;/p&gt;

&lt;p&gt;    As a side note, I will be making some additional changes to the code regarding the not-so-nice iteration across the `sequenceNumsToRestore` map. It would make sense to have a &quot;equivalence wrapper&quot; class around `StreamShardMetadata`, that only checks equivalence of the stream name and shard id. That wrapper class can then be used as the key of the `sequenceNumsToRestore` map.&lt;/p&gt;

&lt;p&gt;    No tests you added would be touched, so I assume it&apos;ll work just as fine for you.&lt;/p&gt;</comment>
                            <comment id="16348367" author="githubbot" created="Thu, 1 Feb 2018 10:43:24 +0000"  >&lt;p&gt;Github user pluppens commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Regarding the remark from @StephanEwen: perhaps it would be ok to re-use the `KinesisProxy` to return a list of all shards and compare them to the `sequenceNumsToRestore` to prune any shards that no longer exist? It would delay the restoration, but you&apos;d be sure the state wouldn&apos;t grow indefinitely (we were looking at around a 1000 closed shards with a 24 hour retention period, so 365k per year - that&apos;s not going to end well). Another option would be to kick off another task periodically to prune them, but that is likely to run into race conditions, so doing it at the safe point of restoration would make more sense to me.&lt;/p&gt;</comment>
                            <comment id="16348374" author="githubbot" created="Thu, 1 Feb 2018 10:49:55 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @pluppens &lt;br/&gt;
    My only concern is that scanning the whole list of shards can be very limited to AWS Kinesis&apos;s API invoke rate limitations. Also, we would then only be cleaning up the state on restore, meaning we would kind of be encouraging (in a bad way) Kinesis users to snapshot and restore every once in a while.&lt;/p&gt;

&lt;p&gt;    I think the best solution for that is probably to use a threshold constant as Stephan suggested, but we will need to investigate whether the Kinesis API supports enough information to implement this.&lt;/p&gt;

&lt;p&gt;    I&apos;ll open a separate JIRA ticket forr this, so we can properly discuss the issues of pruning closed shard states there.&lt;/p&gt;</comment>
                            <comment id="16348395" author="githubbot" created="Thu, 1 Feb 2018 10:59:06 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Here it is: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8542&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-8542&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16348414" author="githubbot" created="Thu, 1 Feb 2018 11:10:26 +0000"  >&lt;p&gt;Github user pluppens commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Good point. An ugly workaround would be to store a timestamp when the ending number is being set on a shard, and provide a configurable/sufficiently enough (eg. 7 days) window. It would exclude the dependency on the Kinesis API.&lt;/p&gt;</comment>
                            <comment id="16354360" author="githubbot" created="Tue, 6 Feb 2018 19:04:05 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5337&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16354385" author="tzulitai" created="Tue, 6 Feb 2018 19:10:09 +0000"  >&lt;p&gt;Merged.&lt;/p&gt;

&lt;p&gt;1.5 -&#160;140bb0c66257d5d09d61845731aef1dbdb90a0bd&lt;br/&gt;
1.4 -&#160;7884a4f749b8e7ba7b831963cf2a3be12df877b7&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p7fr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>