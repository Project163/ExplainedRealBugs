<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:43:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14163] Execution#producedPartitions is possibly not assigned when used</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14163</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently &lt;tt&gt;Execution#producedPartitions&lt;/tt&gt; is assigned after the partitions have completed the registration to shuffle master in &lt;tt&gt;Execution#registerProducedPartitions(...)&lt;/tt&gt;.&lt;br/&gt;
The partition registration is an async interface (&lt;tt&gt;ShuffleMaster#registerPartitionWithProducer(...)&lt;/tt&gt;), so &lt;tt&gt;Execution#producedPartitions&lt;/tt&gt; is possible&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; not set when used. &lt;/p&gt;

&lt;p&gt;Usages includes:&lt;br/&gt;
1. deploying this task, so that the task may be deployed without its result partitions assigned, and the job would hang. (DefaultScheduler issue only, since legacy scheduler handled this case)&lt;br/&gt;
2. generating input descriptors for downstream tasks: &lt;br/&gt;
3. retrieve &lt;tt&gt;ResultPartitionID&lt;/tt&gt; for partition releasing: &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; If a user uses Flink default shuffle master &lt;tt&gt;NettyShuffleMaster&lt;/tt&gt;, it is not problematic at the moment since it returns a completed future on registration, so that it would be a synchronized process. However, if users implement their own shuffle service in which the &lt;tt&gt;ShuffleMaster#registerPartitionWithProducer&lt;/tt&gt; returns an pending future, it can be a problem. This is possible since customizable shuffle service is open to users since 1.9 (via config &quot;shuffle-service-factory.class&quot;).&lt;/p&gt;

&lt;p&gt;To avoid issues to happen, we may either &lt;br/&gt;
1. fix all the usages of &lt;tt&gt;Execution#producedPartitions&lt;/tt&gt; regarding the async assigning, or &lt;br/&gt;
2. change &lt;tt&gt;ShuffleMaster#registerPartitionWithProducer(...)&lt;/tt&gt; to a sync interface&lt;/p&gt;</description>
                <environment></environment>
        <key id="13258137">FLINK-14163</key>
            <summary>Execution#producedPartitions is possibly not assigned when used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ym">Yuan Mei</assignee>
                                    <reporter username="zhuzh">Zhu Zhu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 22 Sep 2019 08:49:16 +0000</created>
                <updated>Tue, 18 May 2021 07:01:06 +0000</updated>
                            <resolved>Fri, 17 Jan 2020 14:35:47 +0000</resolved>
                                    <version>1.9.0</version>
                    <version>1.10.0</version>
                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17008580" author="zjwang" created="Mon, 6 Jan 2020 06:53:10 +0000"  >&lt;p&gt;Thanks for reporting this potential issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;After double checking the related codes, this issue indeed exists only for&#160;DefaultScheduler. When the ShuffleMaster#registerPartitionWithProducer was firstly introduced before, we already considered the async behavior in the scheduler process (legacy now) at that time.&lt;/p&gt;

&lt;p&gt;The above mentioned three usages are mainly caused by the deployment process not considering the completed future of registering partition in new&#160;DefaultScheduler. If the new scheduler can also take the async way into account like the legacy scheduler did during deployment, I think we can solve all the existing concerns.&#160;&lt;/p&gt;

&lt;p&gt;I also feel that the current public method of Execution#getPartitionIds might bring potential risks to use in practice, because the returned partition might be an empty collection if the registration future was not completed yet, but the caller is not aware of this thing.&#160;&lt;/p&gt;

&lt;p&gt;From the shuffle aspect, it is indeed meaningful for providing the async way for registerPartitionWithProducer in a long term, which is flexible to satisfy different scenarios. But from the existing implementation and possible future extending implementations like yarn shuffle service etc, the sync way can also satisfy the requirements I guess. So if this way would bring more troubles for the scheduler and it is not easy to adjust for other components, it also makes sense to adjust the registerPartitionWithProducer as sync way instead on my side. We can make things easy.&#160;&lt;/p&gt;

&lt;p&gt;Are there any thoughts or inputs &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17008582" author="zjwang" created="Mon, 6 Jan 2020 06:54:29 +0000"  >&lt;p&gt;In addition, no matter which way we take to solve this issue, I think we can make it ready in release-1.11, not a blocker for release-1.10.&lt;/p&gt;</comment>
                            <comment id="17008606" author="zhuzh" created="Mon, 6 Jan 2020 08:04:57 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; for the feedbacks.&lt;br/&gt;
I think partition releasing could also be a problem for both legacy and DefaultScheduler. If a task is released before its partitions are successfully registered to shuffle master, JM will see no partition to release when cancelling the task, so that the partitions could be leaked in shuffle master.&lt;br/&gt;
And agree that making &lt;tt&gt;ShuffleMaster#registerPartitionWithProducer&lt;/tt&gt; a sync interface would be much easier to avoid such possible issues at the moment.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt; do you think we need to fix this in 1.10? The major problem (streaming job tasks get deployed without knowing its inputs) is only possible to happen with DefaultScheduler (with custom shuffle service). I&apos;d prefer to fix it in 1.10 if we can have an easy and low risk fix.&lt;/p&gt;</comment>
                            <comment id="17008929" author="gjy" created="Mon, 6 Jan 2020 14:58:34 +0000"  >&lt;p&gt;Since there is no issue when using the NettyShuffleMaster (the only implementation), I do not see immediate call for action in 1.10. I would welcome it, if we can simplify the&#160;&lt;tt&gt;ShuffleMaster#registerPartitionWithProducer()&lt;/tt&gt; interface but this is for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; to decide.&lt;/p&gt;</comment>
                            <comment id="17008965" author="azagrebin" created="Mon, 6 Jan 2020 15:59:30 +0000"  >&lt;p&gt;Thanks for analysis &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;. Indeed, this is a separate state whether we triggered registering of partitions or not. If task is just in scheduled state while being canceled we ignore partitions as we handle partitions only for deployed tasks (next state).&lt;/p&gt;

&lt;p&gt;I agree that this is not an immediate problem but we have to be honest with the API and at least use it consistently as synchronous API. The quickest fix could be to just call get on the partitions future immediately and document that it is not used&#160;asynchronously atm. Later, if we see that it is a problem for some implementations, we can fix it to correctly handle this&#160;asynchronous state of task/partitions lifecycle.&lt;/p&gt;

&lt;p&gt;Wdyt?&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17009452" author="ym" created="Tue, 7 Jan 2020 08:08:24 +0000"  >&lt;p&gt;Accidentally navigating here when digging into the ShuffleMaster interface, and learned a lot reading the comments! Thanks everyone.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I agree that keeping the interface and usage consistent is important. One thing worth to mention is that the&#160;ShuffleMaster/ShuffleService interface `might` be extended/reused to persist output for the purpose of single task failure recovery in the future. If that&apos;s the case, partition registration/release might be more complicated during recovery (and may take longer time). Keep the interface as it is provides more flexibility for shuffle services.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17009471" author="zhuzh" created="Tue, 7 Jan 2020 08:20:31 +0000"  >&lt;p&gt;+1 to the solution proposed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;. The fix should be simple enough and it&apos;s good that we do not need to change the shuffle interface back&amp;amp;forth. We can also easily improve the usage implementation of the returned completable future when needed in the future.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ym&quot; class=&quot;user-hover&quot; rel=&quot;ym&quot;&gt;ym&lt;/a&gt;, yes keeping the async interface is generally good in long term. So using the future in a sync way for now as proposed by Andrey is better than changing the shuffle interface to sync pattern.&lt;/p&gt;</comment>
                            <comment id="17009710" author="azagrebin" created="Tue, 7 Jan 2020 13:11:50 +0000"  >&lt;p&gt;One more thing to add after talking to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, we should fail if the partitions future is not done immediately (basically for true async implementations) because if scheduler does not support it properly (as now) then we risk to block main thread and fail heartbeat in a more vague way.&lt;/p&gt;</comment>
                            <comment id="17009799" author="zhuzh" created="Tue, 7 Jan 2020 14:56:47 +0000"  >&lt;p&gt;Makes sense. Unexpected blocked main thread can be hard to troubleshoot for users, and throwing explicit errors may be better.&lt;/p&gt;
</comment>
                            <comment id="17010280" author="ym" created="Wed, 8 Jan 2020 02:32:29 +0000"  >&lt;p&gt;That&apos;s a good point: fail loudly if acting in an unexpected way for easier trouble shooting. This makes the fix safe even if a developer accidentally neglects the documentation, since he/she can get notified explicitly.&lt;/p&gt;</comment>
                            <comment id="17011568" author="ym" created="Thu, 9 Jan 2020 08:57:20 +0000"  >&lt;p&gt;Thanks for assigning the task to me!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have written a first version based on the discussion, key changes:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;change Execution#producedPartitions to&#160;Execution#producedPartitionsFuture, and initiate it as an incomplete future&#160;&lt;/li&gt;
	&lt;li&gt;assign the producedPartitionsFuture in Execution#registerProducedPartitions&lt;/li&gt;
	&lt;li&gt;wrap any access to&#160;producedPartitions in a synchronous function. If later async registration is needed, callbacks can be added to substitute this method. The function is quite simple: fail if the&#160;producedPartitionsFuture is not done, otherwise return&#160;producedPartitionsFuture.get()&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Code Link:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/compare/master...curcur:shuffle_master_async_interface?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/compare/master...curcur:shuffle_master_async_interface?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This works fine if&#160;producedPartitions are not supposed to be accessed without registration, which is natural since we have to assign before using. Notice that `registration` and `registration finished` is different. The former refers to whether registration is always required (Execution#registerProducedPartitions is always called before accessed), and the latter refers to whether partitions are successfully registered.&lt;/p&gt;

&lt;p&gt;However, I find a lot of the unit tests fail because&#160;producedPartitions are accessed without Execution#registerProducedPartitions are called, for example&#160;&lt;/p&gt;

&lt;p&gt;ExecutionVertexDeploymentTest#testDeployCall()&lt;/p&gt;

&lt;p&gt;ExecutionGraphCheckpointCoordinatorTest#testShutdownCheckpointCoordinatorOnFailure()&lt;/p&gt;

&lt;p&gt;e.t.c.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the old version,&#160;producedPartitions is initiated as an empty map, and works well in cases&#160;the real value of producedPartitions are not necessary.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am wondering whether this is just a shortcut for tests or it is also used/allowed in some places in prod path?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If access without registration is possible in prod, we can make&#160;producedPartitionsFuture Optional to differentiate whether&#160;Execution#registerProducedPartitions is called or not, like this:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/compare/master...curcur:optional?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/compare/master...curcur:optional?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Or a safer and simpler change is to keep all interfaces and usages as it is, and directly check isDone() and call get() after registration of producedPartitions, like this:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/compare/master...curcur:simpler_way?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/compare/master...curcur:simpler_way?expand=1&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;What do you think?&#160;&lt;/p&gt;</comment>
                            <comment id="17011647" author="zhuzh" created="Thu, 9 Jan 2020 10:09:41 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ym&quot; class=&quot;user-hover&quot; rel=&quot;ym&quot;&gt;ym&lt;/a&gt; for trying out the solutions.&lt;br/&gt;
I&apos;d prefer option 3 which simply adds a check to ensure the registration future is done on return. &lt;br/&gt;
And I think we also need to update the java docs for &lt;tt&gt;ShuffleMaster#registerPartitionWithProducer&lt;/tt&gt; to ask users to only return completed future at the moment.&lt;br/&gt;
Feel free to open the PR.&lt;/p&gt;</comment>
                            <comment id="17011657" author="ym" created="Thu, 9 Jan 2020 10:15:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;&#160;Thank you sooo much. I prefer option 3 as well, will file a PR.&#160;&lt;/p&gt;</comment>
                            <comment id="17011689" author="zentol" created="Thu, 9 Jan 2020 10:51:30 +0000"  >&lt;p&gt;Can someone explain to me where exactly a task is being deployed (&lt;tt&gt;Execution#deploy&lt;/tt&gt;) without the futures for slots/partitions being completed? Both &lt;tt&gt;SchedulingUtils#schedulerEager&lt;/tt&gt; and &lt;tt&gt;Execution#scheduleForExecution&lt;/tt&gt; only call &lt;tt&gt;deploy&lt;/tt&gt; if the future has finished.&lt;/p&gt;

&lt;p&gt;I don&apos;t understand how there could be a pending partition registration during deployment.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The only I problem I see is that a partition could leak if one of the registration fail, since the combined future will never finish and hence the partitions will never reach the book-keeping.&lt;/p&gt;</comment>
                            <comment id="17011692" author="zhuzh" created="Thu, 9 Jan 2020 10:57:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; The deployment issue can happen with ng scheduler since it does not wait for the future to complete in &lt;tt&gt;DefaultScheduler#assignResourceOrHandleError&lt;/tt&gt;.&lt;br/&gt;
The calling chain of deployment is DefaultScheduler#deployTaskSafe(...) -&amp;gt; DefaultExecutionVertexOperations#deploy(...) -&amp;gt; ExecutionVertex#deploy() -&amp;gt; Execution#deploy().&lt;/p&gt;</comment>
                            <comment id="17011841" author="zentol" created="Thu, 9 Jan 2020 14:03:44 +0000"  >&lt;p&gt;Right.&lt;/p&gt;

&lt;p&gt;So &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; and me have had an offline discussion about this.&lt;/p&gt;

&lt;p&gt;Let me summarize our conclusion:&lt;/p&gt;

&lt;p&gt;The Problem:&lt;br/&gt;
The DefaultScheduler does not wait for the partition registration to complete before issuing the deploy call.&lt;br/&gt;
 As a result:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the TDD of the deployed task may be missing output descriptors since these are derived from the &lt;tt&gt;ResultPartitionDeploymentDescriptor&lt;/tt&gt; returned by the ShuffleMaster&lt;/li&gt;
	&lt;li&gt;if the job is cancelled or fails before the partition registration is complete we are&lt;br/&gt;
 a) not issuing release calls since nothing has been tracked yet&lt;br/&gt;
 b) leaking partition tracking entries since the registration process isn&apos;t canceled and may start tracking partitions after the execution was canceled&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The raised issue about input descriptors for downstreams tasks should not be a problem since the runtime handles this case via notifications about consumable partitions.&lt;/p&gt;

&lt;p&gt;The solution:&lt;br/&gt;
Ensuring that we wait for the registration to complete (in &lt;tt&gt;DefaultScheduler#assignResourceOrHandleError)&lt;/tt&gt;) should resolve the issue. The partition registration and deployment are then executed as a single scheduling unit, preventing issues with concurrent cancel calls, and it naturally ensures that partition descriptors are available during deployment.&lt;br/&gt;
We prefer this option as it should be relatively simple and does not require changes to the ShuffleMaster API.&lt;/p&gt;


&lt;p&gt;Another orthogonal issue we stumbled on is that if the registration of a single partition fails the remaining partitions are not cleaned up on the ShuffleMaster, since the cleanup only occurs after partitions have been tracked, and partitions are only tracked if all registrations succeed. This seems to be a separate issue entirely and I&apos;ll open a separate ticket.&lt;/p&gt;</comment>
                            <comment id="17011878" author="zhuzh" created="Thu, 9 Jan 2020 14:26:03 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; for the update! Then we are now taking the option to fix all the problematic usages of &lt;tt&gt;Execution#producedPartitions&lt;/tt&gt;.&lt;br/&gt;
I think the partition leak could also happen with the legacy scheduler if a task is cancelled/failed before its partition registration is completed. Shall we also fix it since legacy scheduler is the only scheduler in 1.9 and still available to users in 1.10?&lt;/p&gt;</comment>
                            <comment id="17011886" author="zentol" created="Thu, 9 Jan 2020 14:35:17 +0000"  >&lt;p&gt;Hold on; what I meant is that, for now, we&apos;ll just amend &lt;tt&gt;DefaultScheduler#assignResourceOrHandleError&lt;/tt&gt; to call &lt;tt&gt;get()&lt;/tt&gt; on the result from &lt;tt&gt;Execution#registerProducedPartitions&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;There are some follow-ups we will need to support &quot;true&quot; asynchronous scheduling, but this isn&apos;t a priority right now since neither netty nor yarn require it, and we are not aware of any other plans for possible implementations.&lt;/p&gt;

&lt;p&gt;Let me double-check quickly on the cancel/fail before registration complete issue.&lt;/p&gt;</comment>
                            <comment id="17011892" author="zentol" created="Thu, 9 Jan 2020 14:40:08 +0000"  >&lt;p&gt;Fair enough, if the task is cancelled/failed before the registration completes then yes, we may be leaking partitions in general.&lt;/p&gt;

&lt;p&gt;For this I would amend the lambda function in &lt;tt&gt;Execution#registerProducedPartitions&lt;/tt&gt; that starts tracking partitions to check the state of the execution after starting the tracking of partitions, and if the execution is not in a scheduled state to immediately untrack them again.&lt;/p&gt;</comment>
                            <comment id="17011944" author="zhuzh" created="Thu, 9 Jan 2020 15:22:45 +0000"  >&lt;p&gt;Oh I understand what your mean. &lt;br/&gt;
Previously &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; &amp;amp; Till had raised the concern that calling &lt;tt&gt;get()&lt;/tt&gt; on the partition registration future would block the main thread in a vague way. (see this &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14163?focusedCommentId=17009710&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17009710&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;comment&lt;/a&gt;). That&apos;s why we had decided to require all &lt;tt&gt;ShuffleMaster#registerPartitionWithProducer&lt;/tt&gt; implementations to return completed future only at the moment.&lt;br/&gt;
If we would allow to call &lt;tt&gt;get()&lt;/tt&gt; on the future, looks to me it&apos;s even simpler to call it in &lt;tt&gt;Execution#registerProducedPartitions(...)&lt;/tt&gt;, so that neither the deployment racing nor the partition leak would happen in this way.&lt;/p&gt;</comment>
                            <comment id="17012507" author="ym" created="Fri, 10 Jan 2020 06:57:27 +0000"  >&lt;p&gt;Hey,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;, thank you so much for the summary! It is&#160;thorough and clear. Learned a lot &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The fundamental problem of this issue is the assignment and access of `Execution#producedPartitions` mismatches. That is, assignment is through an asynchronous interface, but not all of the accesses are using callbacks. That is the reason why misuses are introduced in the first place.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Given the only implementation of `ShuffleMaster` is synchronous (`NettyShuffleMaster`), there is no immediate needs to clean up all the usage. Instead, the more important thing is to eliminate the risk to introduce more misuses or lead the system behave in an unexpected way.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Along with the discussion, I think everyone agrees to keep the async interface of `ShuffleMaster#registerPartitionWithProducer` for the purpose of flexibility, but enforce a&#160;synchronous registration underneath. Then the question is what is the best place to put the enforcement.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14163?focusedCommentId=17011568&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17011568&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;In my previous comment&lt;/a&gt;,&#160;&#160;&lt;/p&gt;

&lt;p&gt;Option1 changes all access to `Execution#producedPartitions` as a callback, hence the interfaces for both assignment and access are consistent. The synchronous registration is enforced and wrapped before accessing.&lt;/p&gt;

&lt;p&gt;But since there are different ways to access&#160;producedPartitions,&#160;Option1 has some limitations (discussed in the comment). This is also the reason I am a bit hesitate to fix the usage (access) of&#160;producedPartitions directly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Option2 is a refinement of Option1 but a bit ugly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Option3 enforces the&#160;synchronous registration from the registration side, and immediately fails if the registration is not synchronous. This is a much simpler and safe change for the purpose of&#160; `eliminating the risk to introduce more misuses and to lead the system behave in an unexpected way.`&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If asynchronous registration is needed in the future, we should fix the access part in no doubt.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17012601" author="azagrebin" created="Fri, 10 Jan 2020 09:13:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ym&quot; class=&quot;user-hover&quot; rel=&quot;ym&quot;&gt;ym&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think we should still not call get directly on Future returned from ShuffleMaster to protect from accidental usage of currently unsupported async shuffle API.&lt;/p&gt;

&lt;p&gt;If we immediately assert isDone on shuffle registration Future or any of its immediate derivatives to be true, it will be the same as calling get but we can judge about actual implementation of used shuffle implementation whether it is sync or async and fail fast for&#160;currently unsupported async shuffle API. After checking isDone, we can safely call get.&lt;/p&gt;</comment>
                            <comment id="17013353" author="ym" created="Sat, 11 Jan 2020 03:22:10 +0000"  >&lt;p&gt;PR:&#160;pull request #10832&lt;/p&gt;</comment>
                            <comment id="17014085" author="zjwang" created="Mon, 13 Jan 2020 07:40:10 +0000"  >&lt;p&gt;Thanks for the above good suggestions from you guys! Sorry for coming back this issue a bit late, especially for the PR already ready.&lt;/p&gt;

&lt;p&gt;My previous guessing was that the formal support of async way would bring big trouble for scheduler, or it may be conflict with new scheduler direction in long term. Also considering the shuffle async way a bit over design then and no real users atm, so I mentioned before that I can accept the way of adjusting into the sync way to stop loss early. Although I also thought in general it is not a good way to break compatibility for exposed public interface. If it is not a problem for scheduler for handling the async way in future, I am happy to retain the async shuffle way.&lt;/p&gt;

&lt;p&gt;If we decide to retain the async way and work around it in scheduler temporarily, it might be better to not fail directly after checking the future not completed. I mean we can step forward to bear a timeout before failing. This timeout is not only used for waiting future completion, also used for waiting for the future return by shuffle master while calling to avoid main thread stuck long time.&lt;/p&gt;</comment>
                            <comment id="17014147" author="ym" created="Mon, 13 Jan 2020 09:20:11 +0000"  >&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Synced up with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;&#160;offline.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In general, I would prefer not to change interfaces unless having to, since interface changes have more profound impact on users than implementation changes. Especially in this case, given the future design is not determined (both Shuffle and Scheduler), changing async -&amp;gt; sycn and then sync -&amp;gt; async again bring much more pain to users than keeping the asycn interfaces and enforces a sync implementation underneath.&#160;&lt;/p&gt;

&lt;p&gt;In the latter case, a user barely needs to do anything if we do want to support async implementation in the future, while in the first case, every single user that uses the interface has to make a new release to adjust to the updated interface.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I do not have strong preferences other than the point of keeping the interface. I think retain a timeout is a good compromise, but may introduce some inconsistent system behavior. Hence even if we decide to retain a timeout, I would prefer to document as `enforce a synchronous implementation under asynchronous interface`.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17014376" author="azagrebin" created="Mon, 13 Jan 2020 14:37:57 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ym&quot; class=&quot;user-hover&quot; rel=&quot;ym&quot;&gt;ym&lt;/a&gt; ! The question is&#160;how long should the timeout be? It probably depends on heartbeat timeouts.&#160;Not sure it is easy to come up with the reasonable value. I would rather go with the simple check and fix the scheduler problems before we decide to have a shuffle service which requires async behaviour.&lt;/p&gt;</comment>
                            <comment id="17014845" author="zhuzh" created="Tue, 14 Jan 2020 03:43:55 +0000"  >&lt;p&gt;+1 to fix it with a simple check first. As long as we are call `get()` on the future directly, a timeout may still lead to blocked main thread which we are trying to avoid. And of course finally we will need a timeout to support the async handling of the partition registration.&lt;/p&gt;</comment>
                            <comment id="17014886" author="ym" created="Tue, 14 Jan 2020 06:42:15 +0000"  >&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;! I do not have a strong&#160;opinion on whether to add a time-out or not. If I have to choose, I would probably prefer to going with a simple check because this makes system behavior consistent and easy to reason about.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I double checked with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;&#160;before he left (he is on vacation right now), and he is fine with either case as well.&lt;/p&gt;</comment>
                            <comment id="17018077" author="zentol" created="Fri, 17 Jan 2020 14:35:47 +0000"  >&lt;p&gt;master: 6fa1ea1caa0de4892e5942f760305422859585da&lt;br/&gt;
1.10: a16f7c7cf9c5e0d210591b93690784d593ff0910 &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13378702">FLINK-22677</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 43 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06w48:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>