<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:43:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14843] Streaming bucketing end-to-end test can fail with Output hash mismatch</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14843</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;&lt;br/&gt;
Streaming bucketing end-to-end test (&lt;tt&gt;test_streaming_bucketing.sh&lt;/tt&gt;) can fail with Output hash mismatch.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Number of running task managers has reached 4.
Job (e0b7a86e4d4111f3947baa3d004e083a) is running.
Waiting until all values have been produced
Truncating buckets
Number of produced values 26930/60000
Truncating buckets
Number of produced values 30890/60000
Truncating buckets
Number of produced values 37340/60000
Truncating buckets
Number of produced values 41290/60000
Truncating buckets
Number of produced values 46710/60000
Truncating buckets
Number of produced values 52120/60000
Truncating buckets
Number of produced values 57110/60000
Truncating buckets
Number of produced values 62530/60000
Cancelling job e0b7a86e4d4111f3947baa3d004e083a.
Cancelled job e0b7a86e4d4111f3947baa3d004e083a.
Waiting for job (e0b7a86e4d4111f3947baa3d004e083a) to reach terminal state CANCELED ...
Job (e0b7a86e4d4111f3947baa3d004e083a) reached terminal state CANCELED
Job e0b7a86e4d4111f3947baa3d004e083a was cancelled, time to verify
FAIL Bucketing Sink: Output hash mismatch.  Got 9e00429abfb30eea4f459eb812b470ad, expected 01aba5ff77a0ef5e5cf6a727c248bdc3.
head hexdump of actual:
0000000   (   2   ,   1   0   ,   0   ,   S   o   m   e       p   a   y
0000010   l   o   a   d   .   .   .   )  \n   (   2   ,   1   0   ,   1
0000020   ,   S   o   m   e       p   a   y   l   o   a   d   .   .   .
0000030   )  \n   (   2   ,   1   0   ,   2   ,   S   o   m   e       p
0000040   a   y   l   o   a   d   .   .   .   )  \n   (   2   ,   1   0
0000050   ,   3   ,   S   o   m   e       p   a   y   l   o   a   d   .
0000060   .   .   )  \n   (   2   ,   1   0   ,   4   ,   S   o   m   e
0000070       p   a   y   l   o   a   d   .   .   .   )  \n   (   2   ,
0000080   1   0   ,   5   ,   S   o   m   e       p   a   y   l   o   a
0000090   d   .   .   .   )  \n   (   2   ,   1   0   ,   6   ,   S   o
00000a0   m   e       p   a   y   l   o   a   d   .   .   .   )  \n   (
00000b0   2   ,   1   0   ,   7   ,   S   o   m   e       p   a   y   l
00000c0   o   a   d   .   .   .   )  \n   (   2   ,   1   0   ,   8   ,
00000d0   S   o   m   e       p   a   y   l   o   a   d   .   .   .   )
00000e0  \n   (   2   ,   1   0   ,   9   ,   S   o   m   e       p   a
00000f0   y   l   o   a   d   .   .   .   )  \n                        
00000fa
Stopping taskexecutor daemon (pid: 55164) on host gyao-desktop.
Stopping standalonesession daemon (pid: 51073) on host gyao-desktop.
Stopping taskexecutor daemon (pid: 51504) on host gyao-desktop.
Skipping taskexecutor daemon (pid: 52034), because it is not running anymore on gyao-desktop.
Skipping taskexecutor daemon (pid: 52472), because it is not running anymore on gyao-desktop.
Skipping taskexecutor daemon (pid: 52916), because it is not running anymore on gyao-desktop.
Stopping taskexecutor daemon (pid: 54121) on host gyao-desktop.
Stopping taskexecutor daemon (pid: 54726) on host gyao-desktop.
[FAIL] Test script contains errors.
Checking of logs skipped.

[FAIL] &apos;flink-end-to-end-tests/test-scripts/test_streaming_bucketing.sh&apos; failed after 2 minutes and 3 seconds! Test exited with exit code 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;b&gt;How to reproduce&lt;/b&gt;&lt;br/&gt;
Comment out the delay of 10s after the 1st TM is restarted to provoke the issue:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
echo &lt;span class=&quot;code-quote-red&quot;&gt;&quot;Restarting 1 TM&quot;&lt;/span&gt;
$FLINK_DIR/bin/taskmanager.sh start
wait_for_number_of_running_tms 4

&lt;span class=&quot;code-comment&quot;&gt;#sleep 10
&lt;/span&gt;
echo &lt;span class=&quot;code-quote-red&quot;&gt;&quot;Killing 2 TMs&quot;&lt;/span&gt;
kill_random_taskmanager
kill_random_taskmanager
wait_for_number_of_running_tms 2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Command to run the test:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;FLINK_DIR=build-target/ flink-end-to-end-tests/run-single-test.sh skip flink-end-to-end-tests/test-scripts/test_streaming_bucketing.sh
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</description>
                <environment>&lt;p&gt;rev: dcc1330375826b779e4902176bb2473704dabb11&lt;/p&gt;</environment>
        <key id="13269166">FLINK-14843</key>
            <summary>Streaming bucketing end-to-end test can fail with Output hash mismatch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="banmoy">PengFei Li</assignee>
                                    <reporter username="gjy">Gary Yao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Mon, 18 Nov 2019 21:20:51 +0000</created>
                <updated>Thu, 16 Jan 2020 09:43:06 +0000</updated>
                            <resolved>Thu, 16 Jan 2020 09:41:59 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Connectors / FileSystem</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17002690" author="banmoy" created="Tue, 24 Dec 2019 06:53:36 +0000"  >&lt;p&gt;I think it is not a bug, but how the test works. The output of test_streaming_bucketing.sh tells us that number of produced values is 62530, which is more than the expected 60000, so checksum fails. The duplicated data is from those pending files which isn&apos;t included in a checkpoint, and can&apos;t be truncated to remove duplicated data when job is restored. The meaning of &quot;sleep 10&quot; is waiting for at least one completed checkpoint before triggering another failover, so that pending files generated when job is closing are in the restored checkpoint. 10 seconds is enough because checkpoint interval is set to 4s in&#160;BucketingSinkTestProgram. Maybe we need to change the script to wait for a completed checkpoint explicitly . What do you think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkl0u&quot; class=&quot;user-hover&quot; rel=&quot;kkl0u&quot;&gt;kkl0u&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17002915" author="kkl0u" created="Tue, 24 Dec 2019 16:12:02 +0000"  >&lt;p&gt;The fact that the duplicates can be the result of non-truncated data from before the failure sounds correct. &lt;tt&gt;Truncate&lt;/tt&gt; is called upon recovery so we have to wait for all tasks to have successfully recovered before counting the valid records. &lt;/p&gt;

&lt;p&gt;I think the solution is to have &lt;b&gt;no&lt;/b&gt; size limit for the pending files and to wait after recovery so that we have a high chance of having called &lt;tt&gt;truncate()&lt;/tt&gt; after recovery. The no size requirement is due to the fact that pending files are never garbage collected, so if they are created and they do not belong to any checkpoint, then they will always affect the number of counted records.&lt;/p&gt;</comment>
                            <comment id="17003160" author="banmoy" created="Wed, 25 Dec 2019 08:59:36 +0000"  >&lt;p&gt;I think an alternative solution is&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;set&#160;inactiveBucketCheckInterval and&#160;inactiveBucketThreshold to a small value, such as 4 seconds&lt;/li&gt;
	&lt;li&gt;only count records in final state files with prefix of &quot;part-&quot;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;When source finish to send all records,&#160; inactive bucket check will ensure in-progress files are transferred to pending files finally, and those pending files will be transferred to part-* files after completed checkpoints. So part-* files will finally contain all records and there is no duplication, which is just the exactly-once semantics of bucketing sink. In this way, there is no need to care about failover, and make the test more stable and comprehensible. I create a PR to make it more clear&#160;&lt;a href=&quot;https://github.com/apache/flink/pull/10685&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/10685&lt;/a&gt;, and hope for your feedback&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkl0u&quot; class=&quot;user-hover&quot; rel=&quot;kkl0u&quot;&gt;kkl0u&lt;/a&gt;.&#160;Thanks.&lt;/p&gt;</comment>
                            <comment id="17003539" author="banmoy" created="Thu, 26 Dec 2019 09:22:42 +0000"  >&lt;p&gt;I think this is not a bug, but about the design of test, so I&#160;change the type and priority of this issue temporarily.&lt;/p&gt;</comment>
                            <comment id="17015623" author="carp84" created="Wed, 15 Jan 2020 04:38:51 +0000"  >&lt;p&gt;Another instance which fails release-1.10 nightly build: &lt;a href=&quot;https://api.travis-ci.org/v3/job/636999143/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/636999143/log.txt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17015624" author="carp84" created="Wed, 15 Jan 2020 04:40:10 +0000"  >&lt;p&gt;Upgrading to Critical since it reproduces in release-1.10 nightly build, and I suggest to fix it as soon as possible if the given PR looks good &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=banmoy&quot; class=&quot;user-hover&quot; rel=&quot;banmoy&quot;&gt;banmoy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;. Thanks.&lt;/p&gt;</comment>
                            <comment id="17015629" author="carp84" created="Wed, 15 Jan 2020 04:46:40 +0000"  >&lt;p&gt;Disclaimer: the latest release-1.10 nightly build fails at a different case: &apos;SQL Client end-to-end test for Kafka 0.10&apos;, but with the same error (Output hash mismatch). Please check it and feel free to open a new issue if turns out the root cause is different &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=banmoy&quot; class=&quot;user-hover&quot; rel=&quot;banmoy&quot;&gt;banmoy&lt;/a&gt;, thanks.&lt;/p&gt;

&lt;p&gt;Another instance: &lt;a href=&quot;https://api.travis-ci.org/v3/job/636999153/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/636999153/log.txt&lt;/a&gt;&lt;br/&gt;
in the same build: &lt;a href=&quot;https://travis-ci.org/apache/flink/builds/636999105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/flink/builds/636999105&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17015645" author="banmoy" created="Wed, 15 Jan 2020 05:51:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liyu&quot; class=&quot;user-hover&quot; rel=&quot;liyu&quot;&gt;liyu&lt;/a&gt; Output hash mismatch&#160;for SQL Client end-to-end test for Kafka 0.10 is not the same issue for Streaming bucketing end-to-end test, and is tracked in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14505&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;FLINK-14505&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17015648" author="carp84" created="Wed, 15 Jan 2020 06:04:05 +0000"  >&lt;p&gt;Thanks for the investigation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=banmoy&quot; class=&quot;user-hover&quot; rel=&quot;banmoy&quot;&gt;banmoy&lt;/a&gt;. Downgrading priority here and will track &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14505&quot; title=&quot;SQL Client end-to-end test for Kafka 0.10 nightly end-to-end test failed on travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14505&quot;&gt;&lt;del&gt;FLINK-14505&lt;/del&gt;&lt;/a&gt; instead.&lt;/p&gt;</comment>
                            <comment id="17016757" author="kkl0u" created="Thu, 16 Jan 2020 09:41:59 +0000"  >&lt;p&gt;Merged on master with 9a58dedebef57cddd6e325ae40edc74aff6c6248&lt;br/&gt;
and on release-1.10 with 6ddcacd0abf9eac1fc5b6e2bc9dda94e453ec969&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12986187" name="complete_result" size="1782468" author="gjy" created="Tue, 19 Nov 2019 06:45:00 +0000"/>
                            <attachment id="12986195" name="flink-gary-standalonesession-0-gyao-desktop.log" size="248291" author="gjy" created="Tue, 19 Nov 2019 06:44:24 +0000"/>
                            <attachment id="12986194" name="flink-gary-taskexecutor-0-gyao-desktop.log" size="246063" author="gjy" created="Tue, 19 Nov 2019 06:44:46 +0000"/>
                            <attachment id="12986193" name="flink-gary-taskexecutor-1-gyao-desktop.log" size="66023" author="gjy" created="Tue, 19 Nov 2019 06:44:46 +0000"/>
                            <attachment id="12986192" name="flink-gary-taskexecutor-2-gyao-desktop.log" size="55334" author="gjy" created="Tue, 19 Nov 2019 06:44:46 +0000"/>
                            <attachment id="12986191" name="flink-gary-taskexecutor-3-gyao-desktop.log" size="68108" author="gjy" created="Tue, 19 Nov 2019 06:44:46 +0000"/>
                            <attachment id="12986190" name="flink-gary-taskexecutor-4-gyao-desktop.log" size="105153" author="gjy" created="Tue, 19 Nov 2019 06:44:46 +0000"/>
                            <attachment id="12986189" name="flink-gary-taskexecutor-5-gyao-desktop.log" size="92854" author="gjy" created="Tue, 19 Nov 2019 06:44:46 +0000"/>
                            <attachment id="12986188" name="flink-gary-taskexecutor-6-gyao-desktop.log" size="103796" author="gjy" created="Tue, 19 Nov 2019 06:44:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z08rbc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>