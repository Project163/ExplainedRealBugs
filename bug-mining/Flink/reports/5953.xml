<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:07:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-23647] UnalignedCheckpointStressITCase crashed on azure</title>
                <link>https://issues.apache.org/jira/browse/FLINK-23647</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=21539&amp;amp;view=logs&amp;amp;j=5c8e7682-d68f-54d1-16a2-a09310218a49&amp;amp;t=86f654fa-ab48-5c1a-25f4-7e7f6afb9bba&amp;amp;l=4855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=21539&amp;amp;view=logs&amp;amp;j=5c8e7682-d68f-54d1-16a2-a09310218a49&amp;amp;t=86f654fa-ab48-5c1a-25f4-7e7f6afb9bba&amp;amp;l=4855&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When testing DFS changelog implementation in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23279&quot; title=&quot;Enable changelog backend in tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23279&quot;&gt;&lt;del&gt;FLINK-23279&lt;/del&gt;&lt;/a&gt; and enabling it for all tests,&lt;br/&gt;
UnalignedCheckpointStressITCase crashed with the following exception&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 18.433 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.flink.test.checkpointing.UnalignedCheckpointStressITCase
[ERROR] runStressTest(org.apache.flink.test.checkpointing.UnalignedCheckpointStressITCase)  Time elapsed: 17.663 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.io.UncheckedIOException: java.nio.file.NoSuchFileException: /tmp/junit7860347244680665820/435237 d57439f2ceadfedba74dadd6fa/chk-16
   at java.nio.file.FileTreeIterator.fetchNextIfNeeded(FileTreeIterator.java:88)
   at java.nio.file.FileTreeIterator.hasNext(FileTreeIterator.java:104)
   at java.util.Iterator.forEachRemaining(Iterator.java:115)
   at java.util.Spliterators$IteratorSpliterator.forEachRemaining(Spliterators.java:1801)
   at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
   at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
   at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)
   at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
   at java.util.stream.ReferencePipeline.reduce(ReferencePipeline.java:546)
   at org.apache.flink.test.checkpointing.UnalignedCheckpointStressITCase.discoverRetainedCheckpoint(UnalignedCheckpointStressITCase.java:288)
   at org.apache.flink.test.checkpointing.UnalignedCheckpointStressITCase.runAndTakeExternalCheckpoint(UnalignedCheckpointStressITCase.java:261)
   at org.apache.flink.test.checkpointing.UnalignedCheckpointStressITCase.runStressTest(UnalignedCheckpointStressITCase.java:157)
   at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
   at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
   at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
   at java.lang.reflect.Method.invoke(Method.java:498)
   at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)
   at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
   at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)
   at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
   at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
   at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
   at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:54)
   at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:54)
   at org.apache.flink.util.TestNameProvider$1.evaluate(TestNameProvider.java:45)
   at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:61)
   at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)
   at org.junit.runners.BlockJUnit4ClassRunner$1.evaluate(BlockJUnit4ClassRunner.java:100)
   at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:366)
   at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:103)
   at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:63)
   at org.junit.runners.ParentRunner$4.run(ParentRunner.java:331)
   at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79)
   at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329)
   at org.junit.runners.ParentRunner.access$100(ParentRunner.java:66)
   at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293)
   at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:54)
   at org.junit.rules.RunRules.evaluate(RunRules.java:20)
   at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)
   at org.junit.runners.ParentRunner.run(ParentRunner.java:413)
   at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:365)
   at org.apache.maven.surefire.junit4.JUnit4Provider.executeWithRerun(JUnit4Provider.java:273)
   at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:238)
   at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:159)
   at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java :384)
   at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:345)
   at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:126)
   at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:418)
Caused by: java.nio.file.NoSuchFileException: /tmp/junit7860347244680665820/435237d57439f2ceadfedba74 dadd6fa/chk-16
   at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)
   at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)
   at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)
   at sun.nio.fs.UnixFileAttributeViews$Basic.readAttributes(UnixFileAttributeViews.java:55)
   at sun.nio.fs.UnixFileSystemProvider.readAttributes(UnixFileSystemProvider.java:144)
   at sun.nio.fs.LinuxFileSystemProvider.readAttributes(LinuxFileSystemProvider.java:99)
   at java.nio.file.Files.readAttributes(Files.java:1737)
   at java.nio.file.FileTreeWalker.getAttributes(FileTreeWalker.java:219)
   at java.nio.file.FileTreeWalker.visit(FileTreeWalker.java:276)
   at java.nio.file.FileTreeWalker.next(FileTreeWalker.java:372)
   at java.nio.file.FileTreeIterator.fetchNextIfNeeded(FileTreeIterator.java:84)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The referred checkpoint 16 was aborted and scheduled for deletion.&lt;br/&gt;
But the test does not wait for it to complete and proceeds to file listing.&lt;/p&gt;

&lt;p&gt;I think this problem is also present in UnalignedCheckpointRescaleITCase (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22197&quot; title=&quot;UnalignedCheckpointRescaleITCase.shouldRescaleUnalignedCheckpoint fail due to NoSuchFileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22197&quot;&gt;FLINK-22197&lt;/a&gt;) and probably in CoordinatedSourceRescaleITCase(&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23577&quot; title=&quot;CoordinatedSourceRescaleITCase.testUpscaling fails with NoSuchFileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23577&quot;&gt;FLINK-23577&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Patch to demonstrate it: &lt;a href=&quot;https://github.com/rkhachatryan/flink/tree/f23647-demo&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rkhachatryan/flink/tree/f23647-demo&lt;/a&gt;&lt;br/&gt;
Corresponding &lt;a href=&quot;https://dev.azure.com/khachatryanroman/flink/_build/results?buildId=1039&amp;amp;view=logs&amp;amp;j=0a15d512-44ac-5ba5-97ab-13a5d066c22c&amp;amp;t=9a028d19-6c4b-5a4e-d378-03fca149d0b1&amp;amp;l=4870&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failure&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13393701">FLINK-23647</key>
            <summary>UnalignedCheckpointStressITCase crashed on azure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="roman">Roman Khachatryan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>stale-assigned</label>
                            <label>test-stability</label>
                    </labels>
                <created>Thu, 5 Aug 2021 12:20:16 +0000</created>
                <updated>Wed, 15 Dec 2021 01:44:16 +0000</updated>
                            <resolved>Thu, 28 Oct 2021 13:57:56 +0000</resolved>
                                    <version>1.14.0</version>
                                    <fixVersion>1.14.3</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / Network</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17394232" author="roman_khachatryan" created="Thu, 5 Aug 2021 17:58:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt; I remember you also encountered a similar issue.&lt;br/&gt;
Does the reasoning in the ticket make sense to you?&lt;br/&gt;
If so, do you have any idea of how to fix it?&lt;/p&gt;

&lt;p&gt;IMO, the desired behavior is to wait for all checkpoints to be discarded before reporting job termination to the client.&lt;/p&gt;

&lt;p&gt;However, CheckpointCleaner currently submits actions to JobManagerSharedServices.scheduledExecutorService; which is terminated with the last job (i.e. minicluster shutdown); and it still doesn&apos;t wait for all tasks termination on shutdown.&lt;br/&gt;
A simple workaround would be to wait in CheckpointsCleaner until numberOfCheckpointsToClean become 0 on termination. (and wait for executor tasks termination).&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann@apache.org&quot;&gt;trohrmann@apache.org&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17394256" author="arvid" created="Thu, 5 Aug 2021 18:27:03 +0000"  >&lt;p&gt;I&apos;m assuming it&apos;s more an implementation issue than a logic issue: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;we are looking for the latest &lt;tt&gt;chk&lt;/tt&gt; directory with a metadata file in it&lt;/li&gt;
	&lt;li&gt;concurrently a &lt;tt&gt;chk&lt;/tt&gt; directory is being deleted&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;since the directory under deletion will not contain a metadata file, it should be fine in theory. In practice, we need to use more atomic checks to avoid concurrency issues.&lt;br/&gt;
So rather than&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Files.find(checkpointDir.toPath(), 2, this::isCompletedCheckpoint)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;we should use the old-fashioned way that operators on snapshots&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Arrays.stream(checkpointDir.listFiles()).filter(this::isCompletedCheckpoint)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;isCompletedCheckpoint must deal with the given file being deleted at any time in-between.&lt;/p&gt;</comment>
                            <comment id="17394383" author="roman_khachatryan" created="Thu, 5 Aug 2021 23:09:01 +0000"  >&lt;p&gt;I think that&apos;s another way to look at it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;

&lt;p&gt;I still think Flink should wait for checkpoints to be discarded but maybe test instability can be improved too.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;isCompletedCheckpoint must deal with the given file being deleted at any time in-between.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Do you mean catching NoSuchFileException as well?&lt;/p&gt;

&lt;p&gt;And I&apos;m not sure that listFiles itself won&apos;t fail; I think it should list each folder attributes (to make sure &apos;x&apos; is set - where stream() fails currently); and then list files in a potentially deleted folder.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also listing the files while deleting may fail deletion; but that shouldn&apos;t be an issue as the folder will removed by Junit Rule.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17394534" author="arvid" created="Fri, 6 Aug 2021 05:53:11 +0000"  >&lt;p&gt;`listFiles` is an atomic operation afaik. The issue in your stacktrace shows that the error happens when the FileWalker assumes that the respective listed files can be queried for attributes. However, that doesn&apos;t hold in general (not sure why it&apos;s implemented in this way; it&apos;s a JDK bug in my book).&lt;/p&gt;

&lt;p&gt;Afaik the old File API is sufficient. &lt;tt&gt;isDirectory&lt;/tt&gt; doesn&apos;t seem to fail if the directory is deleted. In the same way, &lt;tt&gt;exists&lt;/tt&gt; does not as well.&lt;/p&gt;</comment>
                            <comment id="17394635" author="roman_khachatryan" created="Fri, 6 Aug 2021 08:52:08 +0000"  >&lt;p&gt;&amp;gt; `listFiles` is an atomic operation afaik.&lt;/p&gt;

&lt;p&gt;I doubt it as&#160;listFiles needs to traverse an arbitrate number of files and directories, e.g. in case&#160;listFiles(&quot;/&quot;). The OS would have to provide some lock to prevent any FS changes then.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;Afaik the old File API is sufficient.&#160;&lt;tt&gt;isDirectory&lt;/tt&gt;&#160;doesn&apos;t seem to fail if the directory is deleted.&lt;/p&gt;

&lt;p&gt;The first thing isCompletedCheckpoint does is checking the attributes which can fail (or do you mean something else?).&#160;&lt;/p&gt;

&lt;p&gt;And exists wouldn&apos;t help as exists+readAttr is not atomic.&lt;/p&gt;</comment>
                            <comment id="17394670" author="arvid" created="Fri, 6 Aug 2021 10:01:28 +0000"  >&lt;p&gt;Okay let us take the ticket, it takes too long to explain for a 5 min fix.&lt;/p&gt;</comment>
                            <comment id="17394682" author="roman_khachatryan" created="Fri, 6 Aug 2021 10:23:06 +0000"  >&lt;p&gt;Thanks. I would also be fine to provide a fix once we agree on it.&lt;/p&gt;

&lt;p&gt;The production code change is definetly not a 5 minute fix if we choose that way.&lt;/p&gt;</comment>
                            <comment id="17396658" author="till.rohrmann" created="Tue, 10 Aug 2021 12:54:48 +0000"  >&lt;p&gt;Conceptually it would be nice if Flink only reported a job result to the client after the artefacts Flink leaves behind have converged (differently said that Flink leaves an immutable set of artefacts). I think that this could improve Flink operations since users can rely on the available artefacts and don&apos;t have to fear that something gets deleted at a later point in time.&lt;/p&gt;</comment>
                            <comment id="17396845" author="arvid" created="Tue, 10 Aug 2021 19:11:35 +0000"  >&lt;p&gt;Yes, it would also avoid ugly hacks like &lt;a href=&quot;https://github.com/AHeise/flink/blob/master/flink-tests/src/test/java/org/apache/flink/test/checkpointing/UnalignedCheckpointTestBase.java#L212-L212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/AHeise/flink/blob/master/flink-tests/src/test/java/org/apache/flink/test/checkpointing/UnalignedCheckpointTestBase.java#L212-L212&lt;/a&gt; .&lt;br/&gt;
However, when I just waited for a proper shutdown of the minicluster, it added 1-2s to each ITCase. So we need to be aware that some ITCases take 3x the time then.&lt;/p&gt;</comment>
                            <comment id="17396853" author="arvid" created="Tue, 10 Aug 2021 19:21:43 +0000"  >&lt;p&gt;Here is my solution to solve the test instability in code &lt;a href=&quot;https://github.com/apache/flink/commit/08b29798548ed6ee915113b2e000923d5d275259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/08b29798548ed6ee915113b2e000923d5d275259&lt;/a&gt; with some explanations.&lt;/p&gt;</comment>
                            <comment id="17399860" author="roman_khachatryan" created="Mon, 16 Aug 2021 17:28:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;when I just waited for a proper shutdown of the minicluster, it added 1-2s to each ITCase.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;From the code, it seems the delay was caused by GC. But do we have to wait for it?&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;Here is my solution to solve the test instability in code&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt; I think it&apos;s still a bit fragile:&lt;br/&gt;
 1. It assumes that the latest folder with _metadata file won&apos;t be removed; but I think it can be removed if adding to checkpointStore fails&lt;br/&gt;
 2. The assumption is easy to violate - by reading attrs of some previous checkpoint (which can be subsumed concurrently)&lt;br/&gt;
 3. I couldn&apos;t find any docs about the atomicity of listFiles - could you list any reference? &lt;br/&gt;
 4. Reading the files while they are being deleted can prevent deletion&lt;/p&gt;</comment>
                            <comment id="17399936" author="arvid" created="Mon, 16 Aug 2021 18:39:32 +0000"  >&lt;p&gt;&amp;gt; I think it&apos;s still a bit fragile:&lt;br/&gt;
&amp;gt; 1. It assumes that the latest folder with _metadata file won&apos;t be removed; but I think it can be removed if adding to checkpointStore fails&lt;br/&gt;
I haven&apos;t thought about that one - or rather I didn&apos;t know it. When does it happen?&lt;br/&gt;
&amp;gt; 2. The assumption is easy to violate - by reading attrs of some previous checkpoint (which can be subsumed concurrently)&lt;br/&gt;
There is no harm in checking a file on existance - even if subsumed.&lt;br/&gt;
&amp;gt; 3. I couldn&apos;t find any docs about the atomicity of listFiles - could you list any reference?&lt;br/&gt;
The API is not allowing any exceptions at all. If you check the implementation, you can also see that no exceptions are thrown &lt;a href=&quot;http://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/java.base/unix/native/libjava/UnixFileSystem_md.c#l310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/java.base/unix/native/libjava/UnixFileSystem_md.c#l310&lt;/a&gt;&lt;br/&gt;
&amp;gt; 4. Reading the files while they are being deleted can prevent deletion&lt;br/&gt;
Good thing that we are not reading them then unless we are sure that this is the correct checkpoint directory.&lt;/p&gt;</comment>
                            <comment id="17399961" author="roman_khachatryan" created="Mon, 16 Aug 2021 19:12:10 +0000"  >&lt;p&gt;&amp;gt; 1.&#160;It assumes that the latest folder with _metadata file won&apos;t be removed; but I think it can be removed if adding to checkpointStore fails&lt;br/&gt;
 &amp;gt; I haven&apos;t thought about that one - or rather I didn&apos;t know it. When does it happen?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/d326b0574a373bd5eef63a44261f8762709265f8/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L1233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Here&lt;/a&gt;&#160;and (theorhetically) &lt;a href=&quot;https://github.com/apache/flink/blob/d326b0574a373bd5eef63a44261f8762709265f8/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L1207%C2%A0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&amp;gt; 2. The assumption is easy to violate - by reading attrs of some previous checkpoint (which can be subsumed concurrently)&lt;br/&gt;
 &amp;gt; There is no harm in checking a file on existance - even if subsumed.&lt;br/&gt;
 I meant that if it&apos;s checked, then subsumed, then accessed; then there will be an exception again&lt;br/&gt;
 &#160;&lt;br/&gt;
&amp;gt; 3.&lt;br/&gt;
 &amp;gt;&#160;The API is not allowing any exceptions at all.&lt;br/&gt;
 You&apos;re right...but it says in case of any I/O error it returns null. So we need to check for null and retry.&lt;br/&gt;
 &#160;&lt;br/&gt;
&amp;gt; 4. Reading the files while they are being deleted can prevent deletion&lt;br/&gt;
 &amp;gt;&#160;Good thing that we are not reading them then unless we are sure that this is the correct checkpoint directory.&lt;br/&gt;
 I agree.&lt;/p&gt;</comment>
                            <comment id="17420009" author="flink-jira-bot" created="Fri, 24 Sep 2021 22:37:16 +0000"  >&lt;p&gt;I am the &lt;a href=&quot;https://github.com/apache/flink-jira-bot/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Flink Jira Bot&lt;/a&gt; and I help the community manage its development. I see this issue is assigned but has not received an update in 30 days, so it has been labeled &quot;stale-assigned&quot;.&lt;br/&gt;
If you are still working on the issue, please remove the label and add a comment updating the community on your progress.  If this issue is waiting on feedback, please consider this a reminder to the committer/reviewer. Flink is a very active project, and so we appreciate your patience.&lt;br/&gt;
If you are no longer working on the issue, please unassign yourself so someone else may work on it.&lt;/p&gt;</comment>
                            <comment id="17430459" author="pnowojski" created="Tue, 19 Oct 2021 10:20:23 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt; for reporting and analysing this issue.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;IMO, the desired behavior is to wait for all checkpoints to be discarded before reporting job termination to the client.&lt;/p&gt;

&lt;p&gt;However, CheckpointCleaner currently submits actions to JobManagerSharedServices.scheduledExecutorService; which is terminated with the last job (i.e. minicluster shutdown); and it still doesn&apos;t wait for all tasks termination on shutdown.&lt;br/&gt;
A simple workaround would be to wait in CheckpointsCleaner until numberOfCheckpointsToClean become 0 on termination. (and wait for executor tasks termination).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree that there are two options to fix this&lt;br/&gt;
1. Wait for &lt;tt&gt;CheckpointCleaner&lt;/tt&gt; to finish before job reaching terminal state&lt;br/&gt;
2. Wait for &lt;tt&gt;CheckpointCleaner&lt;/tt&gt; to finish before shutting down &lt;tt&gt;AdaptiveScheduler&lt;/tt&gt; and &lt;tt&gt;DefaultScheduler&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The main advantage of 1. would be that files wouldn&apos;t be removed after reaching the terminal state, which would be still a possibility in the option 2. However I&apos;ve chatted about this offline with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, and we are not sure if this is an issue. After all we are aiming for a clear ownership of checkpoint/savepoint files, and checkpoint files would be owned by Flink, so users shouldn&apos;t be concerned what happens with those files. So for the time being we would go with the easier to implement option 2.&lt;/p&gt;</comment>
                            <comment id="17435431" author="pnowojski" created="Thu, 28 Oct 2021 13:57:56 +0000"  >&lt;p&gt;Merged to master as daa8ac9426e^..daa8ac9426e&lt;br/&gt;
Merged to release-1.14 as 1a33033000f^..1a33033000f&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13412215">FLINK-24938</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0tn4o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>