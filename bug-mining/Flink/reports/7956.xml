<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:23:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-33217] Flink SQL: UNNEST fails with on LEFT JOIN with NOT NULL type in array</title>
                <link>https://issues.apache.org/jira/browse/FLINK-33217</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;Take a column of type&#160;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
business_data ARRAY&amp;lt;STRING NOT NULL&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Take this query&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select bd_name from reproduce_unnest LEFT JOIN UNNEST(reproduce_unnest.business_data) AS exploded_bd(bd_name) ON &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And get this error&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.AssertionError: Type mismatch:
rowtype of rel before registration: RecordType(VARCHAR(2147483647) CHARACTER SET &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-16LE&quot;&lt;/span&gt; NOT NULL ARRAY business_data, VARCHAR(2147483647) CHARACTER SET &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-16LE&quot;&lt;/span&gt; bd_name) NOT NULL
rowtype of rel after registration: RecordType(VARCHAR(2147483647) CHARACTER SET &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-16LE&quot;&lt;/span&gt; NOT NULL ARRAY business_data, VARCHAR(2147483647) CHARACTER SET &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-16LE&quot;&lt;/span&gt; NOT NULL f0) NOT NULL
Difference:
bd_name: VARCHAR(2147483647) CHARACTER SET &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-16LE&quot;&lt;/span&gt; -&amp;gt; VARCHAR(2147483647) CHARACTER SET &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-16LE&quot;&lt;/span&gt; NOT NULL

	at org.apache.calcite.util.Litmus$1.fail(Litmus.java:32)
	at org.apache.calcite.plan.RelOptUtil.equal(RelOptUtil.java:2206)
	at org.apache.calcite.rel.AbstractRelNode.onRegister(AbstractRelNode.java:275)
	at org.apache.calcite.plan.volcano.VolcanoPlanner.registerImpl(VolcanoPlanner.java:1270)
	at org.apache.calcite.plan.volcano.VolcanoPlanner.register(VolcanoPlanner.java:598)
	at org.apache.calcite.plan.volcano.VolcanoPlanner.ensureRegistered(VolcanoPlanner.java:613)
	at org.apache.calcite.plan.volcano.VolcanoPlanner.changeTraits(VolcanoPlanner.java:498)
	at org.apache.calcite.tools.Programs$RuleSetProgram.run(Programs.java:315)
	at org.apache.flink.table.planner.plan.optimize.program.FlinkVolcanoProgram.optimize(FlinkVolcanoProgram.scala:62)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I have implemented a small test case, which fails against Flink 1.15, 1.8 and the latest master branch.&lt;/p&gt;

&lt;p&gt;Workarounds:&lt;br/&gt;
1. Drop &quot;NOT NULL&quot; in array type&lt;br/&gt;
2. Drop &quot;LEFT&quot; from &quot;LEFT JOIN&quot;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13553365">FLINK-33217</key>
            <summary>Flink SQL: UNNEST fails with on LEFT JOIN with NOT NULL type in array</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Sergey Nuyanzin">Sergey Nuyanzin</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 9 Oct 2023 09:36:11 +0000</created>
                <updated>Mon, 10 Nov 2025 17:18:24 +0000</updated>
                            <resolved>Mon, 10 Nov 2025 17:18:24 +0000</resolved>
                                    <version>1.15.3</version>
                    <version>1.18.0</version>
                    <version>1.19.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17773263" author="sergey nuyanzin" created="Mon, 9 Oct 2023 11:42:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt;&lt;br/&gt;
thanks for raising the issue&lt;/p&gt;

&lt;p&gt;It looks like the problem consists of several parts&lt;br/&gt;
1. there is an error in SQL provided in description&lt;br/&gt;
   it complains about type mismatch (in trace) like &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;RecordType:peek_no_expand(VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; NOT NULL name) NOT NULL ARRAY updateEvent) business_data, VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; ue_name) NOT NULL
RecordType:peek_no_expand(VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; NOT NULL name) NOT NULL ARRAY updateEvent) business_data, VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; NOT NULL name) NOT NULL
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the first discrepancy is naimng: in one column it is &lt;tt&gt;ue_name&lt;/tt&gt; while in another it is &lt;tt&gt;name&lt;/tt&gt;, &lt;br/&gt;
also keep in mind type &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
business_data &lt;span class=&quot;code-keyword&quot;&gt;ROW&lt;/span&gt;&amp;lt;`id` &lt;span class=&quot;code-keyword&quot;&gt;STRING&lt;/span&gt;, `updateEvent` &lt;span class=&quot;code-keyword&quot;&gt;ARRAY&lt;/span&gt;&amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;ROW&lt;/span&gt;&amp;lt;`&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;` &lt;span class=&quot;code-keyword&quot;&gt;STRING&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NULL&lt;/span&gt;&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NULL&lt;/span&gt;&amp;gt;&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;where it is called &lt;tt&gt;name&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;so the more correct SQL should look like &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; id, &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; reproduce_unnest &lt;span class=&quot;code-keyword&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;JOIN&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;UNNEST&lt;/span&gt;(reproduce_unnest.business_data.updateEvent) &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; exploded_ue(&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. However this will also fail with &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;set type is RecordType(RecordType:peek_no_expand(VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; id, RecordType:peek_no_expand(VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; NOT NULL name) NOT NULL ARRAY updateEvent) business_data, VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; name) NOT NULL
expression type is RecordType(RecordType:peek_no_expand(VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; id, RecordType:peek_no_expand(VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; NOT NULL name) NOT NULL ARRAY updateEvent) business_data, VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; NOT NULL name) NOT NULL
set is rel#104:LogicalCorrelate.NONE.any.None: 0.[NONE].[NONE](left=HepRelVertex#98,right=HepRelVertex#103,correlation=$cor0,joinType=left,requiredColumns={0})
expression is LogicalCorrelate(correlation=[$cor0], joinType=[left], requiredColumns=[{0}])
  LogicalTableScan(table=[[default_catalog, default_database, reproduce_unnest, source: [CollectionTableSource(business_data)]]])
  LogicalTableFunctionScan(invocation=[$UNNEST_ROWS$1($cor0.business_data.updateEvent)], rowType=[RecordType:peek_no_expand(VARCHAR(2147483647) name)])

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now if look at type comparison in trace&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;RecordType(RecordType:peek_no_expand(VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; id, RecordType:peek_no_expand(VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; NOT NULL name) NOT NULL ARRAY updateEvent) business_data, VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; name) NOT NULL
RecordType(RecordType:peek_no_expand(VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; id, RecordType:peek_no_expand(VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; NOT NULL name) NOT NULL ARRAY updateEvent) business_data, VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot; NOT NULL name) NOT NULL
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;we can see that the difference is that for the first type column &lt;tt&gt;name&lt;/tt&gt; is nullable and for the second is not and this is probably should be fixed (not sure whether it could be fixed with FLIP-154 or not, will try to double check it later)&lt;/p&gt;

&lt;p&gt;the WA is to ensure that there is the same type on both sides of the join e.g. nullable for both&lt;br/&gt;
like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; reproduce_unnest (
 business_data &lt;span class=&quot;code-keyword&quot;&gt;ROW&lt;/span&gt;&amp;lt;`id` &lt;span class=&quot;code-keyword&quot;&gt;STRING&lt;/span&gt;, `updateEvent` &lt;span class=&quot;code-keyword&quot;&gt;ARRAY&lt;/span&gt;&amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;ROW&lt;/span&gt;&amp;lt;`&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;` &lt;span class=&quot;code-keyword&quot;&gt;STRING&lt;/span&gt;&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NULL&lt;/span&gt;&amp;gt;&amp;gt;
) &lt;span class=&quot;code-keyword&quot;&gt;WITH&lt;/span&gt; (
 &lt;span class=&quot;code-quote&quot;&gt;&apos;connector&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;COLLECTION&apos;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;is&lt;/span&gt;-bounded&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&apos;&lt;/span&gt;
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; id, &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; reproduce_unnest &lt;span class=&quot;code-keyword&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;JOIN&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;UNNEST&lt;/span&gt;(reproduce_unnest.business_data.updateEvent) &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; exploded_ue(&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17773308" author="rmetzger" created="Mon, 9 Oct 2023 13:29:11 +0000"  >&lt;p&gt;Thanks a lot for your response. You are right that I made some mistakes in the original bug report. The reproducer was buggy and can be simplified. I&apos;ve just uploaded a new version which hopefully addresses your concerns. I&apos;ve also updated the original issue description to make it easier to understand.&lt;/p&gt;

&lt;p&gt;You can either use the workaround you&apos;ve provided or alternatively you can turn the &quot;LEFT JOIN&quot; into a &quot;JOIN&quot;, ofc the result will be wrong/different because of this, but you can at least get the query to compile for now.&lt;br/&gt;
In my case, I have a number of queries and an immutable input schema, so making the type nullable is not an option.&lt;/p&gt;

&lt;p&gt;I&apos;m pretty sure this is a bug in Calcite, as this is an internal assertion failing while planning the query. But I didn&apos;t want to open a ticket in Calcite right away, before having collected the opinion from folks with experience around Flink SQL.&lt;/p&gt;</comment>
                            <comment id="17773311" author="rmetzger" created="Mon, 9 Oct 2023 13:29:52 +0000"  >&lt;p&gt;Actually, you can make the reproducer even simpler:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;business_data ARRAY&amp;lt;STRING NOT NULL&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;also fails with the same error. I updated the code &amp;amp; description again.&lt;/p&gt;</comment>
                            <comment id="17775748" author="sergey nuyanzin" created="Mon, 16 Oct 2023 13:01:21 +0000"  >&lt;p&gt;after looking a bit deeper it looks like it is not Calcite issue&lt;br/&gt;
e.g.&lt;/p&gt;

&lt;p&gt;this query&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; Book &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; (
   &lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; *
     &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt;
          (
        &lt;span class=&quot;code-keyword&quot;&gt;VALUES&lt;/span&gt;
              &lt;span class=&quot;code-keyword&quot;&gt;ROW&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;array&lt;/span&gt;[1, 2])
            , &lt;span class=&quot;code-keyword&quot;&gt;ROW&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;array&lt;/span&gt;[11])
            , &lt;span class=&quot;code-keyword&quot;&gt;ROW&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;array&lt;/span&gt;[22])
        )  Book (authorId)
        )  &lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; Book b &lt;span class=&quot;code-keyword&quot;&gt;left&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;join&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;unnest&lt;/span&gt;(b.authorId) &lt;span class=&quot;code-keyword&quot;&gt;on&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;works ok with Calcite while is failing on Flink with similar issue.&lt;/p&gt;

&lt;p&gt;I think the reason is that  In Calcite there is a dedicated &lt;tt&gt;UNNEST&lt;/tt&gt; operator &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; which for some reason is not used in Flink... Instead there is LogicalUnnestRule &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; which tries to translates result of unnest as a table scan and this is the place where the error happens... &lt;br/&gt;
Based on the code of this rule &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
      relNode &lt;span class=&quot;code-keyword&quot;&gt;match&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; rs: HepRelVertex =&amp;gt;
          convert(getRel(rs))

          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; f: LogicalProject =&amp;gt;
           ...
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; f: LogicalFilter =&amp;gt;
           ...

          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; uc: Uncollect =&amp;gt;
          ...
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;there could be  4 different types of cases failing with same or similar error while join unnest.&lt;/p&gt;

&lt;p&gt;Current thoughts about how to fix it &lt;br/&gt;
1. Move to Calcite&apos;s Unnest operator (however that&apos;s still not clear what was the reason to not use it...)&lt;br/&gt;
2. Since while parsing and building AST and while also convertion Calcite converts &lt;tt&gt;LEFT JOIN&lt;/tt&gt; to something that has nullable type pn the left and this is also the reason, we could add convertion to not do it for &lt;tt&gt;LEFT JOIN UNNEST&lt;/tt&gt;&lt;br/&gt;
3. We could try handling this in &lt;tt&gt;LogicalUnnestRule&lt;/tt&gt; by making types broader like force nullables... however it could lead wrong final types (e.g. nullable instead of not nullable)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/calcite/blob/bf56743554ea27d250d41db2eb83806f9e626b55/core/src/main/java/org/apache/calcite/sql/SqlUnnestOperator.java#L34&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/calcite/blob/bf56743554ea27d250d41db2eb83806f9e626b55/core/src/main/java/org/apache/calcite/sql/SqlUnnestOperator.java#L34&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/flink/blob/91d81c427aa6312841ca868d54e8ce6ea721cd60/flink-table/flink-table-planner/src/main/scala/org/apache/flink/table/planner/plan/rules/logical/LogicalUnnestRule.scala#L52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/91d81c427aa6312841ca868d54e8ce6ea721cd60/flink-table/flink-table-planner/src/main/scala/org/apache/flink/table/planner/plan/rules/logical/LogicalUnnestRule.scala#L52&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17775751" author="xuyangzhong" created="Mon, 16 Oct 2023 13:06:06 +0000"  >&lt;p&gt;This may be caused by the specific struct type in Flink &apos;PEEK_FIELDS_NO_EXPAND&apos;. I&apos;ll try to find the way to fix it.&lt;/p&gt;</comment>
                            <comment id="17781259" author="xuyangzhong" created="Tue, 31 Oct 2023 07:57:45 +0000"  >&lt;p&gt;This issue is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31830&quot; title=&quot;Coalesce on nested fields with different nullabilities will get wrong plan&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31830&quot;&gt;FLINK-31830&lt;/a&gt;. The node &apos;unnest&apos; will be convert to LogicalTableFunctionScan in LogicalUnnestRule and its row type changes to `ROW(VARCHAR not null) not null`. Because the LEFT join, the type row is forced nullable, and the row type is changes to `ROW(VARCHAR not null)` by `FlinkTypeFactory#createTypeWithNullability` that overrides its super class. And the diff about nullable cases this failure.&lt;/p&gt;

&lt;p&gt;In the latest calcite version, if the ROW changes into nullable, the fields in ROW should also changes into nullable (&lt;a href=&quot;https://issues.apache.org/jira/browse/CALCITE-2464&quot; title=&quot;Allow to set nullability for columns of structured types&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CALCITE-2464&quot;&gt;&lt;del&gt;CALCITE-2464&lt;/del&gt;&lt;/a&gt;). If we also support that feature in Flink in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31830&quot; title=&quot;Coalesce on nested fields with different nullabilities will get wrong plan&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31830&quot;&gt;FLINK-31830&lt;/a&gt;, this bug will be fixed.&lt;/p&gt;</comment>
                            <comment id="17792868" author="rmetzger" created="Mon, 4 Dec 2023 14:19:14 +0000"  >&lt;p&gt;Thank you so much for analyzing the issue. I will keep a close eye on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31830&quot; title=&quot;Coalesce on nested fields with different nullabilities will get wrong plan&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31830&quot;&gt;FLINK-31830&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17799692" author="qingyue" created="Fri, 22 Dec 2023 07:42:36 +0000"  >&lt;p&gt;Sorry for being late.&lt;/p&gt;

&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuyangzhong&quot; class=&quot;user-hover&quot; rel=&quot;xuyangzhong&quot;&gt;xuyangzhong&lt;/a&gt;, thanks for the exploration. While you mentioned that&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Because the LEFT join, the type row is forced nullable, and the row type is changes to `ROW(VARCHAR not null)` by `FlinkTypeFactory#createTypeWithNullability` that overrides its super class. And the diff about nullable cases this failure.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Actually, the desired nullability change for the type`ROW(VARCHAR not null) not null` after a LEFT OUTER JOIN should be `ROW(VARCHAR)`, rather than `ROW(VARCHAR not null)`.&lt;/p&gt;</comment>
                            <comment id="18037214" author="sergey nuyanzin" created="Mon, 10 Nov 2025 17:18:11 +0000"  >&lt;p&gt;Merged as &lt;a href=&quot;https://github.com/apache/flink/commit/019a9f02d0a19bb1e7d80845e48d104ac60d2eb3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;019a9f02d0a19bb1e7d80845e48d104ac60d2eb3&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13532964">FLINK-31830</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13063441" name="UnnestNullErrorTest.scala" size="1604" author="rmetzger" created="Mon, 9 Oct 2023 13:31:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kths:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>