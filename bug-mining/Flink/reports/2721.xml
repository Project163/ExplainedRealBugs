<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10361] Elasticsearch (v6.3.1) sink end-to-end test instable</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10361</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The Elasticsearch (v6.3.1) sink end-to-end test is instable. Running it on an Amazon instance it failed with the following exception in the logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-09-17 20:46:04,856 INFO  org.apache.flink.runtime.taskmanager.Task                     - Source: Sequence Source -&amp;gt; Flat Map -&amp;gt; Sink: Unnamed (1/1) (cb23fdd9df0d4e09270b2ae9970efbac) switched from RUNNING to FAILED.
java.io.IOException: Connection refused
	at org.elasticsearch.client.RestClient$SyncResponseListener.get(RestClient.java:728)
	at org.elasticsearch.client.RestClient.performRequest(RestClient.java:235)
	at org.elasticsearch.client.RestClient.performRequest(RestClient.java:198)
	at org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:522)
	at org.elasticsearch.client.RestHighLevelClient.ping(RestHighLevelClient.java:275)
	at org.apache.flink.streaming.connectors.elasticsearch6.Elasticsearch6ApiCallBridge.createClient(Elasticsearch6ApiCallBridge.java:81)
	at org.apache.flink.streaming.connectors.elasticsearch6.Elasticsearch6ApiCallBridge.createClient(Elasticsearch6ApiCallBridge.java:47)
	at org.apache.flink.streaming.connectors.elasticsearch.ElasticsearchSinkBase.open(ElasticsearchSinkBase.java:296)
	at org.apache.flink.api.common.functions.util.FunctionUtils.openFunction(FunctionUtils.java:36)
	at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.open(AbstractUdfStreamOperator.java:102)
	at org.apache.flink.streaming.api.operators.StreamSink.open(StreamSink.java:48)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.openAllOperators(StreamTask.java:424)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:290)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:711)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.net.ConnectException: Connection refused
	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)
	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)
	at org.apache.http.impl.nio.reactor.DefaultConnectingIOReactor.processEvent(DefaultConnectingIOReactor.java:171)
	at org.apache.http.impl.nio.reactor.DefaultConnectingIOReactor.processEvents(DefaultConnectingIOReactor.java:145)
	at org.apache.http.impl.nio.reactor.AbstractMultiworkerIOReactor.execute(AbstractMultiworkerIOReactor.java:348)
	at org.apache.http.impl.nio.conn.PoolingNHttpClientConnectionManager.execute(PoolingNHttpClientConnectionManager.java:192)
	at org.apache.http.impl.nio.client.CloseableHttpAsyncClientBase$1.run(CloseableHttpAsyncClientBase.java:64)
	... 1 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I assume that we should harden the test against connection problems a little bit better.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13185742">FLINK-10361</key>
            <summary>Elasticsearch (v6.3.1) sink end-to-end test instable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Tue, 18 Sep 2018 08:48:06 +0000</created>
                <updated>Thu, 8 Nov 2018 12:59:42 +0000</updated>
                            <resolved>Thu, 8 Nov 2018 12:59:42 +0000</resolved>
                                    <version>1.6.0</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.7.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16631498" author="x1q1j1" created="Fri, 28 Sep 2018 07:59:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&#160;Has this bug been fixed in version 1.7?&lt;/p&gt;</comment>
                            <comment id="16641015" author="till.rohrmann" created="Sun, 7 Oct 2018 09:50:14 +0000"  >&lt;p&gt;No the issue has not been resolved yet &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=x1q1j1&quot; class=&quot;user-hover&quot; rel=&quot;x1q1j1&quot;&gt;x1q1j1&lt;/a&gt;. Do you wanna give it a try?&lt;/p&gt;</comment>
                            <comment id="16642969" author="sleepy" created="Tue, 9 Oct 2018 08:35:15 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&lt;br/&gt;
I have tested this end-to-end test case in my computer.&lt;br/&gt;
I think the reason is that the ElasticSearch service has not been ready when the sink is been opened.&lt;br/&gt;
In the test script &apos;elasticsearch-common.sh&apos;, we check the service is ready or not by checking is there a process named &apos;Elasticsearch&apos;. After testing in my mac, I found that there is a big gap between process is starting and the port is been listened. We should check the port instead of the process.&lt;/p&gt;</comment>
                            <comment id="16642975" author="till.rohrmann" created="Tue, 9 Oct 2018 08:41:22 +0000"  >&lt;p&gt;That&apos;s a very good idea &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;. Do you wanna take a stab at it?&lt;/p&gt;</comment>
                            <comment id="16643005" author="sleepy" created="Tue, 9 Oct 2018 08:59:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; Of course, I&apos;m working on this, will make a pull request later. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16643061" author="githubbot" created="Tue, 9 Oct 2018 09:50:58 +0000"  >&lt;p&gt;ifndef-SleePy opened a new pull request #6808: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10361&quot; title=&quot;Elasticsearch (v6.3.1) sink end-to-end test instable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10361&quot;&gt;&lt;del&gt;FLINK-10361&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;test&amp;#93;&lt;/span&gt; Harden instable elastic search end-to-end test case&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6808&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6808&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Try to harden the instable test case `test_streaming_elasticsearch.sh` in flink-end-to-end-test module&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Waiting the Elasticsearch ready by checking the port 9200 is listened or not&lt;/li&gt;
	&lt;li&gt;Waiting for 60s due to it sometimes costs more than 30s to be ready in my poor computer&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Tested this case manually&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The serializers: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? *&lt;b&gt;not applicable&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643063" author="githubbot" created="Tue, 9 Oct 2018 09:56:29 +0000"  >&lt;p&gt;tzulitai commented on issue #6808: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10361&quot; title=&quot;Elasticsearch (v6.3.1) sink end-to-end test instable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10361&quot;&gt;&lt;del&gt;FLINK-10361&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;test&amp;#93;&lt;/span&gt; Harden instable elastic search end-to-end test case&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6808#issuecomment-428132843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6808#issuecomment-428132843&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for the PR @ifndef-SleePy!&lt;br/&gt;
   I think the changes make sense. I&apos;ll give it a run locally, and will merge this if things work well.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16644536" author="githubbot" created="Wed, 10 Oct 2018 06:58:41 +0000"  >&lt;p&gt;ifndef-SleePy commented on issue #6808: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10361&quot; title=&quot;Elasticsearch (v6.3.1) sink end-to-end test instable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10361&quot;&gt;&lt;del&gt;FLINK-10361&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;test&amp;#93;&lt;/span&gt; Harden instable elastic search end-to-end test case&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6808#issuecomment-428459801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6808#issuecomment-428459801&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @tzulitai &lt;br/&gt;
   Thank you for reviewing.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16644671" author="tzulitai" created="Wed, 10 Oct 2018 09:05:50 +0000"  >&lt;p&gt;Merged.&lt;/p&gt;

&lt;p&gt;1.6.0:&#160;da03a2c49ecb60dc5d52a28ae0e59ccbc9247573&lt;br/&gt;
1.7.0:&#160;f071cd565846c63bddbe3a0c53738cbe50289825&lt;/p&gt;</comment>
                            <comment id="16644690" author="githubbot" created="Wed, 10 Oct 2018 09:12:24 +0000"  >&lt;p&gt;asfgit closed pull request #6808: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10361&quot; title=&quot;Elasticsearch (v6.3.1) sink end-to-end test instable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10361&quot;&gt;&lt;del&gt;FLINK-10361&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;test&amp;#93;&lt;/span&gt; Harden instable elastic search end-to-end test case&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6808&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6808&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh b/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh&lt;br/&gt;
index e5f1ec9ebe4..834e84528b3 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh&lt;br/&gt;
@@ -41,22 +41,22 @@ function setup_elasticsearch &lt;/p&gt;
{
     $elasticsearchDir/bin/elasticsearch &amp;amp;
 }

&lt;p&gt;-function verify_elasticsearch_process_exist {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for ((i=1;i&amp;lt;=10;i++)); do&lt;/li&gt;
	&lt;li&gt;local elasticsearchProcess=$(jps | grep Elasticsearch | awk &apos;
{print $2}
&lt;p&gt;&apos;)&lt;br/&gt;
+function wait_elasticsearch_working &lt;/p&gt;
{
+    echo &quot;Waiting for Elasticsearch node to work...&quot;
 
-        echo &quot;Waiting for Elasticsearch node to start ...&quot;
+    for ((i=1;i&amp;lt;=60;i++)); do
+        curl -XGET &apos;http://localhost:9200&apos;
 
-        # make sure the elasticsearch node is actually running
-        if [ &quot;$elasticsearchProcess&quot; != &quot;Elasticsearch&quot; ]; then
+        # make sure the elasticsearch node is actually working
+        if [ $? -ne 0 ]; then
             sleep 1
         else
-            echo &quot;Elasticsearch node is running.&quot;
+            echo &quot;Elasticsearch node is working.&quot;
             return
         fi
     done
 
-    echo &quot;Elasticsearch node did not start properly&quot;
+    echo &quot;Elasticsearch node is not working&quot;
     exit 1
 }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/flink-end-to-end-tests/test-scripts/test_quickstarts.sh b/flink-end-to-end-tests/test-scripts/test_quickstarts.sh&lt;br/&gt;
index 4eeddc11503..bf005e86495 100755&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/test-scripts/test_quickstarts.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/test_quickstarts.sh&lt;br/&gt;
@@ -95,7 +95,7 @@ else&lt;br/&gt;
 fi&lt;/p&gt;

&lt;p&gt; setup_elasticsearch &quot;https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.1.2.tar.gz&quot;&lt;br/&gt;
-verify_elasticsearch_process_exist&lt;br/&gt;
+wait_elasticsearch_working&lt;/p&gt;

&lt;p&gt; function shutdownAndCleanup {&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;don&apos;t call ourselves again for another signal interruption&lt;br/&gt;
diff --git a/flink-end-to-end-tests/test-scripts/test_sql_client.sh b/flink-end-to-end-tests/test-scripts/test_sql_client.sh&lt;br/&gt;
index 30833fbf211..ab71f751681 100755
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-end-to-end-tests/test-scripts/test_sql_client.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/test_sql_client.sh&lt;br/&gt;
@@ -109,7 +109,7 @@ ELASTICSEARCH_VERSION=6&lt;br/&gt;
 DOWNLOAD_URL=&apos;https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.1.tar.gz&apos;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt; setup_elasticsearch $DOWNLOAD_URL&lt;br/&gt;
-verify_elasticsearch_process_exist&lt;br/&gt;
+wait_elasticsearch_working&lt;/p&gt;

&lt;p&gt; ################################################################################&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Run a SQL statement&lt;br/&gt;
diff --git a/flink-end-to-end-tests/test-scripts/test_streaming_elasticsearch.sh b/flink-end-to-end-tests/test-scripts/test_streaming_elasticsearch.sh&lt;br/&gt;
index 36a38566707..179c5ffacc8 100755
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-end-to-end-tests/test-scripts/test_streaming_elasticsearch.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/test_streaming_elasticsearch.sh&lt;br/&gt;
@@ -26,7 +26,7 @@ DOWNLOAD_URL=$2&lt;br/&gt;
 mkdir -p $TEST_DATA_DIR&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt; setup_elasticsearch $DOWNLOAD_URL&lt;br/&gt;
-verify_elasticsearch_process_exist&lt;br/&gt;
+wait_elasticsearch_working&lt;/p&gt;

&lt;p&gt; start_cluster&lt;/p&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16678413" author="twalthr" created="Wed, 7 Nov 2018 15:44:48 +0000"  >&lt;p&gt;Apparently, this issue is not fixed entirely. I got the same exception in Travis today:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-11-07 15:19:03,440 INFO  org.apache.flink.runtime.taskmanager.Task                     - Source: Sequence Source -&amp;gt; Flat Map -&amp;gt; Sink: Unnamed (1/1) (4436f1f70cbac0f66173f75bf215d1d3) switched from RUNNING to FAILED.
java.io.IOException: Connection refused
	at org.elasticsearch.client.RestClient$SyncResponseListener.get(RestClient.java:728)
	at org.elasticsearch.client.RestClient.performRequest(RestClient.java:235)
	at org.elasticsearch.client.RestClient.performRequest(RestClient.java:198)
	at org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:522)
	at org.elasticsearch.client.RestHighLevelClient.ping(RestHighLevelClient.java:275)
	at org.apache.flink.streaming.connectors.elasticsearch6.Elasticsearch6ApiCallBridge.createClient(Elasticsearch6ApiCallBridge.java:81)
	at org.apache.flink.streaming.connectors.elasticsearch6.Elasticsearch6ApiCallBridge.createClient(Elasticsearch6ApiCallBridge.java:47)
	at org.apache.flink.streaming.connectors.elasticsearch.ElasticsearchSinkBase.open(ElasticsearchSinkBase.java:296)
	at org.apache.flink.api.common.functions.util.FunctionUtils.openFunction(FunctionUtils.java:36)
	at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.open(AbstractUdfStreamOperator.java:102)
	at org.apache.flink.streaming.api.operators.StreamSink.open(StreamSink.java:48)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.openAllOperators(StreamTask.java:424)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:290)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:704)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.net.ConnectException: Connection refused
	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)
	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)
	at org.apache.http.impl.nio.reactor.DefaultConnectingIOReactor.processEvent(DefaultConnectingIOReactor.java:171)
	at org.apache.http.impl.nio.reactor.DefaultConnectingIOReactor.processEvents(DefaultConnectingIOReactor.java:145)
	at org.apache.http.impl.nio.reactor.AbstractMultiworkerIOReactor.execute(AbstractMultiworkerIOReactor.java:348)
	at org.apache.http.impl.nio.conn.PoolingNHttpClientConnectionManager.execute(PoolingNHttpClientConnectionManager.java:192)
	at org.apache.http.impl.nio.client.CloseableHttpAsyncClientBase$1.run(CloseableHttpAsyncClientBase.java:64)
	... 1 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16679175" author="sleepy" created="Thu, 8 Nov 2018 02:00:11 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Could you offer more details?&lt;/p&gt;

&lt;p&gt;The stdout/stderr of test script would be very helpful.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16679395" author="twalthr" created="Thu, 8 Nov 2018 07:53:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt; see the following build: &lt;a href=&quot;https://travis-ci.org/twalthr/flink/builds/451790518&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/twalthr/flink/builds/451790518&lt;/a&gt;&lt;br/&gt;
All contain the same error: &lt;a href=&quot;https://api.travis-ci.org/v3/job/451790519/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/451790519/log.txt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16679637" author="zentol" created="Thu, 8 Nov 2018 11:35:17 +0000"  >&lt;p&gt;&lt;tt&gt;elasticsearch-common.sh#wait_elasticsearch_working&lt;/tt&gt; is not waiting properly for ES to start.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
function wait_elasticsearch_working {
    echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Elasticsearch node to work...&quot;&lt;/span&gt;

    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ((i=1;i&amp;lt;=60;i++)); &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
        curl -XGET &lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:9200&apos;&lt;/span&gt; || &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/span&gt;
        # make sure the elasticsearch node is actually working
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; [ $? -ne 0 ]; then
            sleep 1
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
            echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Elasticsearch node is working.&quot;&lt;/span&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;
        fi
    done

    echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Elasticsearch node is not working&quot;&lt;/span&gt;
    exit 1
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since &lt;tt&gt;curl -XGET &apos;http://localhost:9200&apos; || true&lt;/tt&gt; always returns 0 the loop always exits right away, even if ES isn&apos;t accessible.&lt;/p&gt;</comment>
                            <comment id="16679667" author="githubbot" created="Thu, 8 Nov 2018 12:13:38 +0000"  >&lt;p&gt;zentol opened a new pull request #7057: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10361&quot; title=&quot;Elasticsearch (v6.3.1) sink end-to-end test instable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10361&quot;&gt;&lt;del&gt;FLINK-10361&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;ES&amp;#93;&lt;/span&gt; Properly wait for ES to start&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7057&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7057&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This PR fixes `elasticsearch-common.sh#wait_elasticsearch_working` not actually waiting for ES to start up.&lt;br/&gt;
   In light of the recent move towards `set -e` we no longer rely on the return code and instead grep the curl output for expected contents (the returned JSON contains a cluster_name field).&lt;br/&gt;
   If not present we continue looping.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Locally verified by querying a bogus ports and ensuring that the test fails early.&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16679722" author="githubbot" created="Thu, 8 Nov 2018 12:58:48 +0000"  >&lt;p&gt;asfgit closed pull request #7057: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10361&quot; title=&quot;Elasticsearch (v6.3.1) sink end-to-end test instable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10361&quot;&gt;&lt;del&gt;FLINK-10361&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;ES&amp;#93;&lt;/span&gt; Properly wait for ES to start&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/7057&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/7057&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh b/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh&lt;br/&gt;
index 16689c8a3f8..8bb9c42ab69 100644&lt;br/&gt;
&amp;#8212; a/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh&lt;br/&gt;
+++ b/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh&lt;br/&gt;
@@ -43,10 +43,10 @@ function wait_elasticsearch_working {&lt;br/&gt;
     echo &quot;Waiting for Elasticsearch node to work...&quot;&lt;/p&gt;

&lt;p&gt;     for ((i=1;i&amp;lt;=60;i++)); do&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;curl -XGET &apos;http://localhost:9200&apos; || true&lt;br/&gt;
+        output=$(curl -XGET &apos;http://localhost:9200&apos; | grep &quot;cluster_name&quot; || true)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;make sure the elasticsearch node is actually working&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if [ $? -ne 0 ]; then&lt;br/&gt;
+        if [ &quot;${output}&quot; = &quot;&quot; ]; then&lt;br/&gt;
             sleep 1&lt;br/&gt;
         else&lt;br/&gt;
             echo &quot;Elasticsearch node is working.&quot;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16679726" author="twalthr" created="Thu, 8 Nov 2018 12:59:42 +0000"  >&lt;p&gt;Fixed in 1.8.0: d946ec5f130c4d3ffaa0e9b8d9abd35ba3224661&lt;br/&gt;
Fixed in 1.7.0: e34f8af3ef9502af6ece9d7c48e3bba249e55288&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12940164" name="flink-elasticsearch-logs.tgz" size="7931" author="trohrmann" created="Tue, 18 Sep 2018 08:47:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3y79r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>