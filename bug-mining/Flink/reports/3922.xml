<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:45:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-16626] Prevent REST handler from being closed more than once</title>
                <link>https://issues.apache.org/jira/browse/FLINK-16626</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In&#160;Flink&#160;1.10.0&#160;release,&#160;job&#160;cancellation&#160;can&#160;be&#160;problematic,&#160;as&#160;users&#160;frequently&#160;experience&#160;java.util.concurrent.TimeoutException&#160;at&#160;the&#160;client&#160;side,&#160;because&#160;the&#160;REST&#160;endpoint&#160;closes&#160;pre-maturely&#160;before&#160;sending&#160;out&#160;the&#160;response, this is because the jobCancellationHandler is incorrectly reused and closed twice.&lt;br/&gt;
&#160;&lt;br/&gt;
When executing the following command to stop a flink job with yarn per-job mode, the client keeps retrying untill timeout (1 minutes&#65289;and exit with failure. But the job stops successfully.&lt;br/&gt;
&#160;Command :&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;flink cancel $jobId yid appId
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;The exception on the client side is :&lt;br/&gt;
&lt;blockquote&gt;&lt;/blockquote&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;2020-03-17 12:32:13,709 DEBUG org.apache.flink.runtime.rest.RestClient - Sending request of class class org.apache.flink.runtime.rest.messages.EmptyRequestBody to ocdt31.aicloud.local:51231/v1/jobs/cc61033484d4c0e7a27a8a2a36f4de7a?mode=cancel&lt;br/&gt;
 ...&lt;br/&gt;
 2020-03-17 12:33:11,065 DEBUG org.apache.flink.runtime.rest.RestClient - Sending request of class class org.apache.flink.runtime.rest.messages.EmptyRequestBody to ocdt31.aicloud.local:51231/v1/jobs/cc61033484d4c0e7a27a8a2a36f4de7a?mode=cancel&lt;br/&gt;
 2020-03-17 12:33:14,070 DEBUG org.apache.flink.runtime.rest.RestClient - Shutting down rest endpoint.&lt;br/&gt;
 2020-03-17 12:33:14,070 DEBUG org.apache.flink.runtime.rest.RestClient - Sending request of class class org.apache.flink.runtime.rest.messages.EmptyRequestBody to ocdt31.aicloud.local:51231/v1/jobs/cc61033484d4c0e7a27a8a2a36f4de7a?mode=cancel&lt;br/&gt;
 2020-03-17 12:33:14,077 DEBUG org.apache.flink.shaded.netty4.io.netty.buffer.PoolThreadCache - Freed 2 thread-local buffer(s) from thread: flink-rest-client-netty-thread-1&lt;br/&gt;
 2020-03-17 12:33:14,080 DEBUG org.apache.flink.runtime.rest.RestClient - Rest endpoint shutdown complete.&lt;br/&gt;
 2020-03-17 12:33:14,083 ERROR org.apache.flink.client.cli.CliFrontend - Error while running the command.&lt;br/&gt;
 org.apache.flink.util.FlinkException: Could not cancel job cc61033484d4c0e7a27a8a2a36f4de7a.&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.lambda$cancel$7(CliFrontend.java:545)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.runClusterAction(CliFrontend.java:843)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.cancel(CliFrontend.java:538)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.parseParameters(CliFrontend.java:904)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.lambda$main$10(CliFrontend.java:968)&lt;br/&gt;
 at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
 at javax.security.auth.Subject.doAs(Subject.java:422)&lt;br/&gt;
 at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1754)&lt;br/&gt;
 at org.apache.flink.runtime.security.HadoopSecurityContext.runSecured(HadoopSecurityContext.java:41)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.main(CliFrontend.java:968)&lt;br/&gt;
 Caused by: java.util.concurrent.TimeoutException&lt;br/&gt;
 at java.util.concurrent.CompletableFuture.timedGet(CompletableFuture.java:1771)&lt;br/&gt;
 at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1915)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.lambda$cancel$7(CliFrontend.java:543)&lt;br/&gt;
 ... 9 more&lt;/p&gt;

&lt;p&gt;------------------------------------------------------------&lt;br/&gt;
 The program finished with the following exception:&lt;/p&gt;

&lt;p&gt;org.apache.flink.util.FlinkException: Could not cancel job cc61033484d4c0e7a27a8a2a36f4de7a.&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.lambda$cancel$7(CliFrontend.java:545)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.runClusterAction(CliFrontend.java:843)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.cancel(CliFrontend.java:538)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.parseParameters(CliFrontend.java:904)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.lambda$main$10(CliFrontend.java:968)&lt;br/&gt;
 at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
 at javax.security.auth.Subject.doAs(Subject.java:422)&lt;br/&gt;
 at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1754)&lt;br/&gt;
 at org.apache.flink.runtime.security.HadoopSecurityContext.runSecured(HadoopSecurityContext.java:41)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.main(CliFrontend.java:968)&lt;br/&gt;
 Caused by: java.util.concurrent.TimeoutException&lt;br/&gt;
 at java.util.concurrent.CompletableFuture.timedGet(CompletableFuture.java:1771)&lt;br/&gt;
 at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1915)&lt;br/&gt;
 at org.apache.flink.client.cli.CliFrontend.lambda$cancel$7(CliFrontend.java:543)&lt;br/&gt;
 ... 9 more&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Actually, the job was cancelled. But the server also prints some exception:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;2020-03-17 12:25:13,754 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;flink-akka.actor.default-dispatcher-17&amp;#93;&lt;/span&gt; org.apache.flink.shaded.netty4.io.netty.util.concurrent.DefaultPromise.safeExecute(DefaultPromise.java:766) - Failed to submit a listener notification task. Event loop shut down? java.util.concurrent.RejectedExecutionException: event executor terminated at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor.reject(SingleThreadEventExecutor.java:855) at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor.offerTask(SingleThreadEventExecutor.java:340) at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor.addTask(SingleThreadEventExecutor.java:333) at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor.execute(SingleThreadEventExecutor.java:766) at org.apache.flink.shaded.netty4.io.netty.util.concurrent.DefaultPromise.safeExecute(DefaultPromise.java:764) at org.apache.flink.shaded.netty4.io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:421) at org.apache.flink.shaded.netty4.io.netty.util.concurrent.DefaultPromise.addListener(DefaultPromise.java:149) at org.apache.flink.shaded.netty4.io.netty.channel.DefaultChannelPromise.addListener(DefaultChannelPromise.java:95) at org.apache.flink.shaded.netty4.io.netty.channel.DefaultChannelPromise.addListener(DefaultChannelPromise.java:30) at org.apache.flink.runtime.rest.handler.util.HandlerUtils.sendResponse(HandlerUtils.java:224) at org.apache.flink.runtime.rest.handler.util.HandlerUtils.sendResponse(HandlerUtils.java:176) at org.apache.flink.runtime.rest.handler.util.HandlerUtils.sendResponse(HandlerUtils.java:91) at org.apache.flink.runtime.rest.handler.AbstractRestHandler.lambda$respondToRequest$0(AbstractRestHandler.java:78) at java.util.concurrent.CompletableFuture.uniAccept(CompletableFuture.java:656) at java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:632) at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:474) at java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:1962) at org.apache.flink.runtime.concurrent.FutureUtils$1.onComplete(FutureUtils.java:874) at akka.dispatch.OnComplete.internal(Future.scala:264) at akka.dispatch.OnComplete.internal(Future.scala:261) at akka.dispatch.japi$CallbackBridge.apply(Future.scala:191) at akka.dispatch.japi$CallbackBridge.apply(Future.scala:188) at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:36) at org.apache.flink.runtime.concurrent.Executors$DirectExecutionContext.execute(Executors.java:74) at scala.concurrent.impl.CallbackRunnable.executeWithValue(Promise.scala:44) at scala.concurrent.impl.Promise$DefaultPromise.tryComplete(Promise.scala:252) at akka.pattern.PromiseActorRef.$bang(AskSupport.scala:572) at akka.pattern.PipeToSupport$PipeableFuture$$anonfun$pipeTo$1.applyOrElse(PipeToSupport.scala:22) at akka.pattern.PipeToSupport$PipeableFuture$$anonfun$pipeTo$1.applyOrElse(PipeToSupport.scala:21) at scala.concurrent.Future$$anonfun$andThen$1.apply(Future.scala:436) at scala.concurrent.Future$$anonfun$andThen$1.apply(Future.scala:435) at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:36) at akka.dispatch.BatchingExecutor$AbstractBatch.processBatch(BatchingExecutor.scala:55) at akka.dispatch.BatchingExecutor$BlockableBatch$$anonfun$run$1.apply$mcV$sp(BatchingExecutor.scala:91) at akka.dispatch.BatchingExecutor$BlockableBatch$$anonfun$run$1.apply(BatchingExecutor.scala:91) at akka.dispatch.BatchingExecutor$BlockableBatch$$anonfun$run$1.apply(BatchingExecutor.scala:91) at scala.concurrent.BlockContext$.withBlockContext(BlockContext.scala:72) at akka.dispatch.BatchingExecutor$BlockableBatch.run(BatchingExecutor.scala:90) at akka.dispatch.TaskInvocation.run(AbstractDispatcher.scala:40) at akka.dispatch.ForkJoinExecutorConfigurator$AkkaForkJoinTask.exec(ForkJoinExecutorConfigurator.scala:44) at akka.dispatch.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260) at akka.dispatch.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339) at akka.dispatch.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979) at akka.dispatch.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="13292106">FLINK-16626</key>
            <summary>Prevent REST handler from being closed more than once</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kyledong">Weike Dong</assignee>
                                    <reporter username="chaiyq">chaiyongqiang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 17 Mar 2020 05:01:13 +0000</created>
                <updated>Sun, 12 Apr 2020 10:28:49 +0000</updated>
                            <resolved>Sun, 12 Apr 2020 10:28:49 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.1</fixVersion>
                    <fixVersion>1.11.0</fixVersion>
                                    <component>Deployment / YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17060639" author="chaiyq" created="Tue, 17 Mar 2020 05:09:34 +0000"  >&lt;p&gt;In my opinion, when the client call an cancel command, the server will run into the following logic :&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;call the JobCancellationHandler to handle the request&lt;/li&gt;
	&lt;li&gt;response to the client&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Codes as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// @Override
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; CompletableFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; respondToRequest(ChannelHandlerContext ctx, HttpRequest httpRequest, HandlerRequest&amp;lt;R, M&amp;gt; handlerRequest, T gateway) {
   CompletableFuture&amp;lt;P&amp;gt; response;

   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      response = handleRequest(handlerRequest, gateway);
   } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RestHandlerException e) {
      response = FutureUtils.completedExceptionally(e);
   }

   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; response.thenAccept(resp -&amp;gt; HandlerUtils.sendResponse(ctx, httpRequest, resp, messageHeaders.getResponseStatusCode(), responseHeaders));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But in the handleRequest function of `JobCancellationHandler`, the cluster will stop and call to shutdown the RestServerEndpoint in which the&#160;EventLoopGroup also will be shutdown.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Then when calling `HandlerUtils.sendResponse`&#160; to response to the client,&#160; exception occurs.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17060706" author="fly_in_gis" created="Tue, 17 Mar 2020 08:18:41 +0000"  >&lt;p&gt;I think not only &lt;tt&gt;flink cancel&lt;/tt&gt;, other operations may come across the similar problems. Since the dispatcher may exit before the Flink client has received the response.&lt;/p&gt;</comment>
                            <comment id="17061326" author="chaiyq" created="Wed, 18 Mar 2020 02:23:01 +0000"  >&lt;p&gt;&#160;Maybe you&apos;ra right. As far as i see, &lt;b&gt;flink stop&lt;/b&gt; is going to be removed .Only &lt;b&gt;flink cancel&lt;/b&gt; comes into this logic. Also there could be some other situation i haven&apos;t noticed.&lt;/p&gt;</comment>
                            <comment id="17064690" author="tartarus" created="Mon, 23 Mar 2020 10:27:38 +0000"  >&lt;p&gt;We encountered the same problem.&#160;So I solved it temporarily and did not wait for the result of the cancel and returned directly.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//&#20195;&#30721;&#21344;&#20301;&#31526;
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; CompletableFuture.completedFuture(EmptyResponseBody.getInstance());
&lt;span class=&quot;code-comment&quot;&gt;//	&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; terminationFuture.handle(
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//		(Acknowledge ack, Throwable throwable) -&amp;gt; {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//			Throwable error = ExceptionUtils.stripCompletionException(throwable);
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (error &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; TimeoutException) {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//					&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompletionException(
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//						&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RestHandlerException(
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//							&lt;span class=&quot;code-quote&quot;&gt;&quot;Job cancellation timed out.&quot;&lt;/span&gt;,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//							HttpResponseStatus.REQUEST_TIMEOUT, error));
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//				} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (error &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; FlinkJobNotFoundException) {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//					&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompletionException(
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//						&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RestHandlerException(
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//							&lt;span class=&quot;code-quote&quot;&gt;&quot;Job could not be found.&quot;&lt;/span&gt;,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//							HttpResponseStatus.NOT_FOUND, error));
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//				} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//					&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompletionException(
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//						&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RestHandlerException(
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//							&lt;span class=&quot;code-quote&quot;&gt;&quot;Job cancellation failed: &quot;&lt;/span&gt; + error.getMessage(),
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//							HttpResponseStatus.INTERNAL_SERVER_ERROR, error));
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//				}
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; EmptyResponseBody.getInstance();
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//			}
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//		});&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But this is equivalent to changed the semantics of cancel!!!&lt;br/&gt;
Equivalent to just sending a signal to JM.&lt;br/&gt;
Do you have any good suggestions?&lt;/p&gt;</comment>
                            <comment id="17069163" author="tison" created="Sat, 28 Mar 2020 01:18:20 +0000"  >&lt;p&gt;Could you reproduce that issue and share TRACE level JM log?&lt;/p&gt;

&lt;p&gt;Some important trace of &lt;tt&gt;AbstractHandler&lt;/tt&gt; is required to locate the root cause.&lt;/p&gt;</comment>
                            <comment id="17069184" author="tison" created="Sat, 28 Mar 2020 02:20:23 +0000"  >&lt;p&gt;I&apos;ve submitted a local YARN testing log, which indicates that &quot;finalizeRequestProcessing&quot; happens after cluster shutdown. Will investigate further later.&lt;/p&gt;</comment>
                            <comment id="17069188" author="tison" created="Sat, 28 Mar 2020 02:26:09 +0000"  >&lt;p&gt;For coming developer: you can duplicate &lt;tt&gt;YARNITCase&lt;/tt&gt;, insert a cancel command, and add log for locally debugging.&lt;/p&gt;</comment>
                            <comment id="17069221" author="tison" created="Sat, 28 Mar 2020 04:19:03 +0000"  >&lt;p&gt;I found that &lt;tt&gt;org.apache.flink.runtime.rest.handler.InFlightRequestTracker#awaitAsync()&lt;/tt&gt; is called more than once which cause &lt;tt&gt;Phaser&lt;/tt&gt; synchronization meaningless. Further debugging...&lt;/p&gt;</comment>
                            <comment id="17069232" author="tison" created="Sat, 28 Mar 2020 05:01:38 +0000"  >&lt;p&gt;link to the analysis&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16637?focusedCommentId=17063164&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17063164&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-16637?focusedCommentId=17063164&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17063164&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16637?focusedCommentId=17069225&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17069225&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-16637?focusedCommentId=17069225&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17069225&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16637?focusedCommentId=17069226&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17069226&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-16637?focusedCommentId=17069226&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17069226&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16637?focusedCommentId=17069227&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17069227&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-16637?focusedCommentId=17069227&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17069227&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and closed &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16637&quot; title=&quot;Flink per job mode terminates before serving job cancellation result&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-16637&quot;&gt;&lt;del&gt;FLINK-16637&lt;/del&gt;&lt;/a&gt; as duplication&lt;/p&gt;</comment>
                            <comment id="17069357" author="tartarus" created="Sat, 28 Mar 2020 09:52:05 +0000"  >&lt;p&gt;This is  JM logs,but It&apos;s a surface phenomenon.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-03-22 17:16:14,770 ERROR org.apache.flink.shaded.netty4.io.netty.util.concurrent.DefaultPromise.rejectedExecution[flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-20]  - Failed to submit a listener notification task. Event loop shut down?
java.util.concurrent.RejectedExecutionException: event executor terminated
	at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor.reject(SingleThreadEventExecutor.java:855)
	at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor.offerTask(SingleThreadEventExecutor.java:340)
	at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor.addTask(SingleThreadEventExecutor.java:333)
	at org.apache.flink.shaded.netty4.io.netty.util.concurrent.SingleThreadEventExecutor.execute(SingleThreadEventExecutor.java:766)
	at org.apache.flink.shaded.netty4.io.netty.util.concurrent.DefaultPromise.safeExecute(DefaultPromise.java:764)
	at org.apache.flink.shaded.netty4.io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:421)
	at org.apache.flink.shaded.netty4.io.netty.util.concurrent.DefaultPromise.addListener(DefaultPromise.java:149)
	at org.apache.flink.shaded.netty4.io.netty.channel.DefaultChannelPromise.addListener(DefaultChannelPromise.java:95)
	at org.apache.flink.shaded.netty4.io.netty.channel.DefaultChannelPromise.addListener(DefaultChannelPromise.java:30)
	at org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.util.HandlerUtils.sendResponse(HandlerUtils.java:224)
	at org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.util.HandlerUtils.sendResponse(HandlerUtils.java:176)
	at org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.util.HandlerUtils.sendResponse(HandlerUtils.java:91)
	at org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.AbstractRestHandler.lambda$respondToRequest$0(AbstractRestHandler.java:78)
	at java.util.concurrent.CompletableFuture.uniAccept(CompletableFuture.java:656)
	at java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:632)
	at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:474)
	at java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:1962)
	at org.apache.flink.runtime.concurrent.FutureUtils$1.onComplete(FutureUtils.java:874)
	at akka.dispatch.OnComplete.internal(Future.scala:264)
	at akka.dispatch.OnComplete.internal(Future.scala:261)
	at akka.dispatch.japi$CallbackBridge.apply(Future.scala:191)
	at akka.dispatch.japi$CallbackBridge.apply(Future.scala:188)
	at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:36)
	at org.apache.flink.runtime.concurrent.Executors$DirectExecutionContext.execute(Executors.java:74)
	at scala.concurrent.impl.CallbackRunnable.executeWithValue(Promise.scala:44)
	at scala.concurrent.impl.Promise$DefaultPromise.tryComplete(Promise.scala:252)
	at akka.pattern.PromiseActorRef.$bang(AskSupport.scala:572)
	at akka.pattern.PipeToSupport$PipeableFuture$$anonfun$pipeTo$1.applyOrElse(PipeToSupport.scala:22)
	at akka.pattern.PipeToSupport$PipeableFuture$$anonfun$pipeTo$1.applyOrElse(PipeToSupport.scala:21)
	at scala.concurrent.Future$$anonfun$andThen$1.apply(Future.scala:436)
	at scala.concurrent.Future$$anonfun$andThen$1.apply(Future.scala:435)
	at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:36)
	at akka.dispatch.BatchingExecutor$AbstractBatch.processBatch(BatchingExecutor.scala:55)
	at akka.dispatch.BatchingExecutor$BlockableBatch$$anonfun$run$1.apply$mcV$sp(BatchingExecutor.scala:91)
	at akka.dispatch.BatchingExecutor$BlockableBatch$$anonfun$run$1.apply(BatchingExecutor.scala:91)
	at akka.dispatch.BatchingExecutor$BlockableBatch$$anonfun$run$1.apply(BatchingExecutor.scala:91)
	at scala.concurrent.BlockContext$.withBlockContext(BlockContext.scala:72)
	at akka.dispatch.BatchingExecutor$BlockableBatch.run(BatchingExecutor.scala:90)
	at akka.dispatch.TaskInvocation.run(AbstractDispatcher.scala:40)
	at akka.dispatch.ForkJoinExecutorConfigurator$AkkaForkJoinTask.exec(ForkJoinExecutorConfigurator.scala:44)
	at akka.dispatch.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
	at akka.dispatch.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
	at akka.dispatch.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
	at akka.dispatch.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17070720" author="fly_in_gis" created="Mon, 30 Mar 2020 06:38:16 +0000"  >&lt;p&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt;&#160;Thanks a lot for your analysis. I think you are right. However, i have checked the YARN code, even in the yarn-3.x, the proxy still could not support &lt;tt&gt;PATCH&lt;/tt&gt;&#160;request. And the hadoop community does not have a clear plan to fix it.&lt;/p&gt;

&lt;p&gt;Because of this, we still can not remove the &lt;tt&gt;YarnCancelJobTerminationHeaders&lt;/tt&gt;, i suggest to create a new &lt;tt&gt;JobCancellationHandler&lt;/tt&gt;&#160;object for yarn-cancel. It should fix this problem.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; Side output&lt;/p&gt;

&lt;p&gt;Currently, the &lt;tt&gt;YarnCancelJobTerminationHeaders&lt;/tt&gt; is only used via webui cancelation. The &lt;tt&gt;flink cancel&lt;/tt&gt; is using &lt;tt&gt;JobCancellationHeaders&lt;/tt&gt; and will directly talk to jobmanager(not using the YARN application proxy). For other deployment(standalone, K8s), they are also using &lt;tt&gt;YarnCancelJobTerminationHeaders&lt;/tt&gt; for the webui&#160;cancelation. It is maybe a small trick for the name.&lt;/p&gt;</comment>
                            <comment id="17070739" author="fly_in_gis" created="Mon, 30 Mar 2020 07:21:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt; The reason why &lt;tt&gt;InFlightRequestTracker#awaitAsync&lt;/tt&gt; is called twice in your analysis is that we are using a same &lt;tt&gt;jobCancelTerminationHandler&lt;/tt&gt; for two different handlers, &lt;tt&gt;JobCancelTerminationHandler&lt;/tt&gt; and &lt;tt&gt;YarnCancelJobTerminationHeaders&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17072311" author="kyledong" created="Wed, 1 Apr 2020 02:26:40 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt;, I am quite interested in solving this issue and have been following this for a while, so I guess I can help fix this bug : )&lt;/p&gt;</comment>
                            <comment id="17072315" author="tison" created="Wed, 1 Apr 2020 02:34:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kyledong&quot; class=&quot;user-hover&quot; rel=&quot;kyledong&quot;&gt;kyledong&lt;/a&gt; Thanks for your interest. I&apos;ve assigned to you.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liyu&quot; class=&quot;user-hover&quot; rel=&quot;liyu&quot;&gt;liyu&lt;/a&gt; I raise this issue as blocker for 1.10.1 since it broke user interface(&lt;tt&gt;flink cancel&lt;/tt&gt;) and it&apos;s hopeful we fix it in days. Comment if you have any concern.&lt;/p&gt;</comment>
                            <comment id="17072325" author="carp84" created="Wed, 1 Apr 2020 02:54:45 +0000"  >&lt;p&gt;Thanks for the note &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt;, will watch this one.&lt;/p&gt;

&lt;p&gt;And thanks for standing up &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kyledong&quot; class=&quot;user-hover&quot; rel=&quot;kyledong&quot;&gt;kyledong&lt;/a&gt;, no mean to push but hopefully we could get a thorough fix soon (smile).&lt;/p&gt;</comment>
                            <comment id="17072429" author="kyledong" created="Wed, 1 Apr 2020 06:27:39 +0000"  >&lt;p&gt;Thanks&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liyu&quot; class=&quot;user-hover&quot; rel=&quot;liyu&quot;&gt;liyu&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;tison&lt;/a&gt; for watching this issue, and I will try my best to fix and test it thoroughly : )&lt;/p&gt;</comment>
                            <comment id="17081736" author="zentol" created="Sun, 12 Apr 2020 10:28:49 +0000"  >&lt;p&gt;master: a882498f1dba79f34b329323c3faf0374b74bd82&lt;/p&gt;

&lt;p&gt;1.10: 593214993e07a939c96b6bc19e16c7daa110e39d&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13292218">FLINK-16637</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13292218">FLINK-16637</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12998058" name="jobmanager.log" size="421786" author="tison" created="Sat, 28 Mar 2020 04:45:14 +0000"/>
                            <attachment id="12998059" name="patch.diff" size="12585" author="tison" created="Sat, 28 Mar 2020 04:45:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 31 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0clj4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>