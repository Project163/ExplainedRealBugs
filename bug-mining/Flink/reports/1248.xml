<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:25:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4829] Accumulators are not thread safe</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4829</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Flink&apos;s &lt;tt&gt;Accumulators&lt;/tt&gt; are not thread safe. With the introduction of live accumulator snapshots which are sent to the &lt;tt&gt;JobManager&lt;/tt&gt;, we&apos;ve introduced a concurrent access to accumulators without properly guard them against concurrent modifications. So if an accumulator snapshot is taken for an accumulator which is at the same time modified, it can cause an &lt;tt&gt;ConcurrentModificationException&lt;/tt&gt; as it was reported by an user: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARN  org.apache.flink.runtime.accumulators.AccumulatorRegistry     - Failed to serialize accumulators &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task.
java.util.ConcurrentModificationException
        at java.util.TreeMap$PrivateEntryIterator.nextEntry(TreeMap.java:1211)
        at java.util.TreeMap$EntryIterator.next(TreeMap.java:1247)
        at java.util.TreeMap$EntryIterator.next(TreeMap.java:1242)
        at java.util.TreeMap.writeObject(TreeMap.java:2436)
        at sun.reflect.GeneratedMethodAccessor491.invoke(Unknown Source) 
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at java.io.ObjectStreamClass.invokeWriteObject(ObjectStreamClass.java:1028)
        at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1496)
        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1432)
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1178)
        at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1548)
        at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1509)
        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1432)
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1178)
        at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:348)
        at java.util.HashMap.internalWriteEntries(HashMap.java:1785)
        at java.util.HashMap.writeObject(HashMap.java:1362)
        at sun.reflect.GeneratedMethodAccessor189.invoke(Unknown Source) 
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at java.io.ObjectStreamClass.invokeWriteObject(ObjectStreamClass.java:1028)
        at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1496)
        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1432)
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1178)
        at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:348)
        at org.apache.flink.util.InstantiationUtil.serializeObject(InstantiationUtil.java:301)
        at org.apache.flink.util.SerializedValue.&amp;lt;init&amp;gt;(SerializedValue.java:52)
        at org.apache.flink.runtime.accumulators.AccumulatorSnapshot.&amp;lt;init&amp;gt;(AccumulatorSnapshot.java:58)
        at org.apache.flink.runtime.accumulators.AccumulatorRegistry.getSnapshot(AccumulatorRegistry.java:75)
        at org.apache.flink.runtime.taskmanager.TaskManager$$anonfun$sendHeartbeatToJobManager$2.apply(TaskManager.scala:1286)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13012312">FLINK-4829</key>
            <summary>Accumulators are not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mxm">Maximilian Michels</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Oct 2016 09:56:04 +0000</created>
                <updated>Mon, 23 Jan 2017 12:30:52 +0000</updated>
                            <resolved>Mon, 23 Jan 2017 12:30:52 +0000</resolved>
                                    <version>1.1.3</version>
                    <version>1.2.0</version>
                                    <fixVersion>1.1.4</fixVersion>
                    <fixVersion>1.2.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15574886" author="mxm" created="Fri, 14 Oct 2016 10:08:50 +0000"  >&lt;p&gt;Actually, they used to be a synchronized map when I did the initial implementation. That prevented concurrent modifications. In &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3880&quot; title=&quot;Improve performance of Accumulator map&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3880&quot;&gt;&lt;del&gt;FLINK-3880&lt;/del&gt;&lt;/a&gt; we removed the lock but forgot that the heartbeat could actually concurrently access the map.&lt;/p&gt;</comment>
                            <comment id="15575329" author="githubbot" created="Fri, 14 Oct 2016 13:25:51 +0000"  >&lt;p&gt;GitHub user mxm opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2634&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4829&quot; title=&quot;Accumulators are not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4829&quot;&gt;&lt;del&gt;FLINK-4829&lt;/del&gt;&lt;/a&gt; protect user accumulators against concurrent updates&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/mxm/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mxm/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4829&quot; title=&quot;Accumulators are not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4829&quot;&gt;&lt;del&gt;FLINK-4829&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2634.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2634.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2634&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 922e765f7a8f6870b79c6abb65d6ea681901e80a&lt;br/&gt;
Author: Maximilian Michels &amp;lt;mxm@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-10-14T13:15:50Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4829&quot; title=&quot;Accumulators are not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4829&quot;&gt;&lt;del&gt;FLINK-4829&lt;/del&gt;&lt;/a&gt; protect user accumulators against concurrent updates&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15575382" author="githubbot" created="Fri, 14 Oct 2016 13:48:23 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2634&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I don&apos;t think fixes the reported issue. The supplied stacktrace shows that the exception is thrown in a TreeMap, in the AccRegistry we however only deal with HashMaps. The histograms internally have a TreeMap however.&lt;/p&gt;</comment>
                            <comment id="15575423" author="githubbot" created="Fri, 14 Oct 2016 14:02:00 +0000"  >&lt;p&gt;Github user mxm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2634&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    That&apos;s correct. I guess it still makes sense to merge this PR.&lt;/p&gt;</comment>
                            <comment id="15575439" author="mxm" created="Fri, 14 Oct 2016 14:06:33 +0000"  >&lt;p&gt;To fix the problem, we will have to introduce a lock in the Accumulator base class which has to be acquired upon adding values. That seems to be the only way to make this work for custom accumulators.&lt;/p&gt;

&lt;p&gt;Note that this concerns only live accumulators. Accumulators will still be reported when the job is over. &lt;/p&gt;</comment>
                            <comment id="15581850" author="mxm" created="Mon, 17 Oct 2016 10:32:59 +0000"  >&lt;p&gt;Locking on a per-element basis in the Accumulator interface seems to be rather costly. I&apos;d propose to report the accumulators on a best-effort basis and refrain from any concurrency locks for now.&lt;/p&gt;</comment>
                            <comment id="15582133" author="githubbot" created="Mon, 17 Oct 2016 12:40:24 +0000"  >&lt;p&gt;Github user mxm closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2634&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15582140" author="githubbot" created="Mon, 17 Oct 2016 12:41:46 +0000"  >&lt;p&gt;GitHub user mxm opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2649&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4829&quot; title=&quot;Accumulators are not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4829&quot;&gt;&lt;del&gt;FLINK-4829&lt;/del&gt;&lt;/a&gt; snapshot accumulators on a best-effort basis&lt;/p&gt;

&lt;p&gt;    Heartbeats should not fail when accumulators could not be snapshotted. Instead, we should simply skip the reporting of the failed accumulator. Eventually, the accumulator will be reported; at the latest, when the job finishes.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/mxm/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mxm/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4829&quot; title=&quot;Accumulators are not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4829&quot;&gt;&lt;del&gt;FLINK-4829&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2649.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2649.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2649&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2a424a6120b7f1be8f357522a3fe964e77bd4cce&lt;br/&gt;
Author: Maximilian Michels &amp;lt;mxm@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-10-14T13:15:50Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4829&quot; title=&quot;Accumulators are not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4829&quot;&gt;&lt;del&gt;FLINK-4829&lt;/del&gt;&lt;/a&gt; protect user accumulators against concurrent updates&lt;/p&gt;

&lt;p&gt;commit f162142b1d274895e16712e42f0f32a43e187db9&lt;br/&gt;
Author: Maximilian Michels &amp;lt;mxm@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-10-17T12:19:00Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4829&quot; title=&quot;Accumulators are not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4829&quot;&gt;&lt;del&gt;FLINK-4829&lt;/del&gt;&lt;/a&gt; snapshot accumulators on a best-effort basis&lt;/p&gt;

&lt;p&gt;    Heartbeats should not fail when accumulators could not be snapshotted. Instead,&lt;br/&gt;
    we should simply skip the reporting of the failed accumulator. Eventually, the&lt;br/&gt;
    accumulator will be reported; at the latest, when the job finishes.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15582141" author="githubbot" created="Mon, 17 Oct 2016 12:42:07 +0000"  >&lt;p&gt;Github user mxm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2634&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Closed in favor of #2649.&lt;/p&gt;</comment>
                            <comment id="15582243" author="githubbot" created="Mon, 17 Oct 2016 13:21:25 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2649&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    LGTM&lt;br/&gt;
    +1 to merge this&lt;/p&gt;</comment>
                            <comment id="15585520" author="githubbot" created="Tue, 18 Oct 2016 13:58:48 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2649&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15585534" author="mxm" created="Tue, 18 Oct 2016 14:06:28 +0000"  >&lt;p&gt;To mitigate the problem, we have best-effort reporting for accumulators now.&lt;/p&gt;

&lt;p&gt;master: 783dca56eedc95f0a8974a9b50f2b532ca8cf849, d95929e0110b53f03452e1ad453de2522f79a6b8&lt;br/&gt;
release-1.1: c1d6b24600e40700fa06caa28bc81788d8e92386, 210230c4ab44b84c28b9a62ff461de0955e67f8f&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34w1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>