<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:41:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-13702] BaseMapSerializerTest.testDuplicate fails on Travis</title>
                <link>https://issues.apache.org/jira/browse/FLINK-13702</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;BaseMapSerializerTest.testDuplicate&lt;/tt&gt; fails on Travis with an &lt;tt&gt;java.lang.IndexOutOfBoundsException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://api.travis-ci.org/v3/job/570973199/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/570973199/log.txt&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13250499">FLINK-13702</key>
            <summary>BaseMapSerializerTest.testDuplicate fails on Travis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dwysakowicz">Dawid Wysakowicz</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Tue, 13 Aug 2019 10:09:17 +0000</created>
                <updated>Sat, 9 May 2020 01:45:10 +0000</updated>
                            <resolved>Thu, 7 Nov 2019 10:20:32 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16906807" author="jark" created="Wed, 14 Aug 2019 02:23:32 +0000"  >&lt;p&gt;Could you have a look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;? It might because of &lt;tt&gt;BaseMapSerializer&lt;/tt&gt; is not thread safe.&lt;/p&gt;</comment>
                            <comment id="16907007" author="lzljs3620320" created="Wed, 14 Aug 2019 08:08:10 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;, TypeSerializer can be not thread safe. CC: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TsReaper&quot; class=&quot;user-hover&quot; rel=&quot;TsReaper&quot;&gt;TsReaper&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16962906" author="dawidwys" created="Wed, 30 Oct 2019 10:29:37 +0000"  >&lt;p&gt;I had a look at this issue and I think the problem is not in the &lt;tt&gt;BaseMapSerializer&lt;/tt&gt; but in the &lt;tt&gt;LazyBinaryFormat&lt;/tt&gt; class.&lt;/p&gt;

&lt;p&gt;The method &lt;tt&gt;LazyBinaryFormat#ensureMaterialized&lt;/tt&gt; is not thread safe. Therefore e.g. when two threads call &lt;tt&gt;getSizeInBytes&lt;/tt&gt;, the first one starts materializing the &lt;tt&gt;BinaryString&lt;/tt&gt; and sets the &lt;tt&gt;segments&lt;/tt&gt; first, but before it updates the &lt;tt&gt;sizeInBytes&lt;/tt&gt; field the second thread calls &lt;tt&gt;getSizeInBytes&lt;/tt&gt; and assumes it has already been materialized (segments were set) so it just returns the sizeInBytes value which is equal to &lt;tt&gt;-1&lt;/tt&gt; as it was not yet updated.&lt;/p&gt;

&lt;p&gt;A potential solution to the problem would be to synchronize the &lt;tt&gt;LazyBinaryFormat#ensureMaterialized&lt;/tt&gt; method. Unfortunately, it has a potential performance penalty. Do you think the &lt;tt&gt;BinaryFormat&lt;/tt&gt; classes should be thread safe? I think they should. Or were they supposed to work only in a single threaded context? If it is the latter we need to update the &lt;tt&gt;BaseMapSerializerTest.testDuplicate&lt;/tt&gt; to perform a copy of the input item before serializing it (in &lt;tt&gt;SerializerTestBase.SerializerRunner#run&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt; WDYT about the changes to the &lt;tt&gt;SerializerTestBase&lt;/tt&gt;? Does it make sense to add the copy anyways?&lt;/p&gt;

&lt;p&gt;WDYT? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="16962929" author="lzljs3620320" created="Wed, 30 Oct 2019 11:04:48 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;, nice analysis, you are right.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;BinaryFormat&lt;/tt&gt;&#160;classes are not thread safe now. Like BinaryRow, it is a mutable class, mutable class is difficult to be thread safe. So at the beginning, the design was not thread safe.&lt;/p&gt;

&lt;p&gt;I think there is another solution: we can invoke BinaryString.ensureMaterialized to make BinaryString read thread safe (Or consider adding a fromStringAndMaterialize method to BinaryString) in&#160;BaseMapSerializerTest.getTestData.&lt;/p&gt;</comment>
                            <comment id="16962936" author="dawidwys" created="Wed, 30 Oct 2019 11:13:37 +0000"  >&lt;p&gt;What do you mean by &lt;cite&gt;invoke BinaryString.ensureMaterialized to make BinaryString read thread safe&lt;/cite&gt;.&lt;/p&gt;

&lt;p&gt;Actually I also spotted &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13740&quot; title=&quot;TableAggregateITCase.testNonkeyedFlatAggregate failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13740&quot;&gt;&lt;del&gt;FLINK-13740&lt;/del&gt;&lt;/a&gt;. After a bit longer analysis I think adding a &lt;tt&gt;copy&lt;/tt&gt; in the test is not enough. I am afraid the &lt;tt&gt;BinaryLazyFormat&lt;/tt&gt; is really flawed in the current state and effectively unusable. I think we should aim to fix it in 1.10.&lt;/p&gt;</comment>
                            <comment id="16962940" author="lzljs3620320" created="Wed, 30 Oct 2019 11:24:38 +0000"  >&lt;p&gt;BinaryLazyFormat is designed for single&#160;threaded context.&lt;/p&gt;

&lt;p&gt;If we add code like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; BaseMap[] getTestData() {
   Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; first = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
   BinaryString empty = BinaryString.fromString(&quot;&quot;);
   empty.ensureMaterialized();
   first.put(1, empty);
   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BaseMap[] {
         &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericMap(first)
   };
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This method generate&#160;GenericMap with BinaryString, the fields of this empty BinaryString are all be inited. All its methods(except pointTo method that re-assign fields) should be thread safe. So the remaining test should be safe.&lt;/p&gt;</comment>
                            <comment id="16962943" author="lzljs3620320" created="Wed, 30 Oct 2019 11:30:40 +0000"  >&lt;p&gt;I think this Jira is not production bug, it is a test bug.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13740&quot; title=&quot;TableAggregateITCase.testNonkeyedFlatAggregate failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13740&quot;&gt;&lt;del&gt;FLINK-13740&lt;/del&gt;&lt;/a&gt;&#160;is another problem, the copy of BinaryGeneric not consider the serializer.&#160;My idea is to get it out of the serializer. That will let BinaryGeneric not extend BinaryLazyFormat (The methods are unsuited).&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;I think we should aim to fix it in 1.10.&lt;/p&gt;

&lt;p&gt;Yes,&#160;In particular, &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13740&quot; title=&quot;TableAggregateITCase.testNonkeyedFlatAggregate failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13740&quot;&gt;&lt;del&gt;FLINK-13740&lt;/del&gt;&lt;/a&gt; is a production bug.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16962953" author="jark" created="Wed, 30 Oct 2019 11:47:44 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;, thanks for looking into this. However, I think they will be called by different threads. I think the root cause is the same with &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13740&quot; title=&quot;TableAggregateITCase.testNonkeyedFlatAggregate failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13740&quot;&gt;&lt;del&gt;FLINK-13740&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;The reason is that the async snapshot thread (e.g. snapshot the heap CopyOnWriteStateMap to disk) and the process element thread are concurrent. The former one will call &lt;tt&gt;TypeSerializer#serialize()&lt;/tt&gt;, and the latter one will call &lt;tt&gt;TypeSerializer#copy()&lt;/tt&gt; (when the state entry is in snapshoting)  on the same object. I think that&apos;s why &lt;tt&gt;SerializerTestBase#testDuplicate()&lt;/tt&gt; is added, and that&apos;s why &lt;tt&gt;LazyBinaryFormat#ensureMaterialized&lt;/tt&gt; will be called concurrently. &lt;/p&gt;

&lt;p&gt;So a simple way to fix this is adding synchronize to &lt;tt&gt;ensureMaterialized&lt;/tt&gt;, but I&apos;m not sure how much the performance impact is. &lt;/p&gt;</comment>
                            <comment id="16962956" author="jark" created="Wed, 30 Oct 2019 11:54:27 +0000"  >&lt;p&gt;Sorry didn&apos;t notice the discussion above. &lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;, I don&apos;t think this is a test bug as I said above. And I think BinaryString has the same problem in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13740&quot; title=&quot;TableAggregateITCase.testNonkeyedFlatAggregate failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13740&quot;&gt;&lt;del&gt;FLINK-13740&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&amp;gt; invoke BinaryString.ensureMaterialized to make BinaryString read thread safe&lt;br/&gt;
This is really hack and fragile. It is highly possible miss the invoking at somewhere. &lt;/p&gt;</comment>
                            <comment id="16963031" author="dawidwys" created="Wed, 30 Oct 2019 13:52:44 +0000"  >&lt;p&gt;I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;. If we ever keep the &lt;tt&gt;BinaryString/Generic&lt;/tt&gt; in state they will be accessed from different threads. That&apos;s why those classes should be thread safe.&lt;/p&gt;

&lt;p&gt;I agree, as I said in my first message, the easiest fix would be to make the &lt;tt&gt;ensureMaterialized&lt;/tt&gt; synchronized, but I share the concerns of performance degradation with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Honestly I&apos;m wondering right now if it would make sense to get rid of the &lt;tt&gt;LazyBinaryFormat&lt;/tt&gt; for now and revisit the problem of long udfs chain. I think correctness is more important than performance. This should also have a lower performance cost than synchronizing &lt;tt&gt;ensureMaterialized&lt;/tt&gt; as it would only affect long udfs chains (the original reason for introducing the &lt;tt&gt;LazyBinaryFormat&lt;/tt&gt;) without affecting every record path. One very broad idea of how can we solve the problem of multiple conversions between binary and java object, could be to add a reusable serialization/deserialization statements in the code generator if needed. Similar to &lt;tt&gt;reusableInputUnboxingExprs&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16963600" author="lzljs3620320" created="Thu, 31 Oct 2019 03:22:00 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&#160;&apos;s input.&#160;It&apos;s true that there are multiple threads to read in this new scenario. I think we can&#160;talk about this ticket thoroughly and then look at &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13740&quot; title=&quot;TableAggregateITCase.testNonkeyedFlatAggregate failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13740&quot;&gt;&lt;del&gt;FLINK-13740&lt;/del&gt;&lt;/a&gt;. Because even adding synchronize can&apos;t solve the problem of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13740&quot; title=&quot;TableAggregateITCase.testNonkeyedFlatAggregate failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13740&quot;&gt;&lt;del&gt;FLINK-13740&lt;/del&gt;&lt;/a&gt;, so I maintain my view that &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13740&quot; title=&quot;TableAggregateITCase.testNonkeyedFlatAggregate failed on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13740&quot;&gt;&lt;del&gt;FLINK-13740&lt;/del&gt;&lt;/a&gt; is another problem.&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;, I agree&#160;correctness is more important than performance. Not only long udfs chain, but also operator chain. Operator chain make thing more complex. We have tried to use CodeGen to solve the chain problem before, but the solution is very complex, and we can&apos;t solve the problem in a long time. We have also questioned whether it is worth introducing such a complex solution to solve this problem, which will lead to increased code complexity.&lt;/p&gt;

&lt;p&gt;Back to this problem, the essence of this problem is that we now introduce a set of &lt;em&gt;&lt;b&gt;thread unsafe lazy initialization&lt;/b&gt;&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;A simple solution is add&#160;synchronize to&#160;materialize.&lt;/p&gt;

&lt;p&gt;I&apos;ll consider the second solution:&lt;/p&gt;

&lt;p&gt;Consider our binary segments are&#160;&lt;em&gt;&lt;b&gt;immutable&lt;/b&gt;&lt;/em&gt; object and &lt;em&gt;&lt;b&gt;idempotent&lt;/b&gt;&lt;/em&gt;,&#160;The root cause of thread unsafe is that it has three fields:&#160;segments,&#160;offset,&#160;sizeInBytes. So if we introduce a Binary immutable object to represent it, we can do like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void ensureMaterialized() {
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (binary == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      binary = materialize();
   }
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Binary materialize() {
   &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = StringUtf8Utils.encodeUTF8(javaObject);
   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Binary(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MemorySegment[] {MemorySegmentFactory.wrap(bytes)}, 0, bytes.length);
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Binary {
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MemorySegment[] segments;
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; offset;
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; sizeInBytes;

   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Binary(MemorySegment[] segments, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; offset, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; sizeInBytes) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.segments = segments;
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.offset = offset;
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sizeInBytes = sizeInBytes;
   }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this case, binary is like the hash field of JDK String, which is a &lt;em&gt;&lt;b&gt;thread safe lazy initialization&lt;/b&gt;&lt;/em&gt; field. The cost is just a java object, it is small.&lt;/p&gt;

&lt;p&gt;What do you think?&#160;Does it address your concerns?&#160;&lt;/p&gt;</comment>
                            <comment id="16963812" author="jark" created="Thu, 31 Oct 2019 09:44:21 +0000"  >&lt;p&gt;Thanks for the approach. I think it can solve the problem of BinaryString.&lt;/p&gt;

&lt;p&gt;But I would like to figure out a solution for BinaryGeneric before we proceed this approach (to find out a generic solution). Do you have some ideas about BinaryGeneric? I think the root cause is the &lt;tt&gt;javaObjSer&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16963838" author="dawidwys" created="Thu, 31 Oct 2019 10:15:41 +0000"  >&lt;p&gt;I agree the solution suggested by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; should work, it is very fragile though. It is based on the assumption that &lt;tt&gt;MemorySegments&lt;/tt&gt; are immutable which in general case is not true. You can mutate MemorySegment via put methods. It is also possible that with this solution different code paths might work against different MemorySegments for the same &lt;tt&gt;LazyBinaryFormat&lt;/tt&gt; instances. It does improve the current situation, I agree. We can add that solution, but we should keep in mind it is basically a hack and add a proper documentation with the assumptions that we do there.&lt;/p&gt;

&lt;p&gt;I was also thinking if it would make sense to make &lt;tt&gt;MemorySegment[] getSegments&lt;/tt&gt; return &lt;tt&gt;UnmodifiableMemorySegment&lt;/tt&gt;. This would require more changes, as we would have to extract &lt;tt&gt;MemorySegment&lt;/tt&gt; interface. Still that would not make the &lt;tt&gt;MemorySegment&lt;/tt&gt; fully immutable as it still gives direct access to underlying memory array via &lt;tt&gt;getHeapMemory&lt;/tt&gt;.&lt;br/&gt;
I would keep mind open for a better solution in a long run though.&lt;/p&gt;

&lt;p&gt;As for the BinaryGeneric I think we could:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;remove the &lt;tt&gt;copy&lt;/tt&gt; method from the class and move it to the &lt;tt&gt;Serializer&lt;/tt&gt; as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; was suggesting&lt;/li&gt;
	&lt;li&gt;in the &lt;tt&gt;materialize&lt;/tt&gt; method call &lt;tt&gt;duplicate&lt;/tt&gt;. This would ensure that every caller thread uses its own copy of the serializer.&lt;/li&gt;
	&lt;li&gt;Moreover we can simply remove the getter for the serializer. There is no need to ever get it. The only place when it is called will actually never be reached. Because the &lt;tt&gt;if (input.getSegments() == null) {&lt;/tt&gt;} will materialize the segments and they will always be not null.&lt;/li&gt;
	&lt;li&gt;additionally we can think of keeping &lt;tt&gt;TypeSerializerSnapshot&lt;/tt&gt; instead of &lt;tt&gt;Serializer} and call {{restoreSerializer&lt;/tt&gt; in the &lt;tt&gt;materialize&lt;/tt&gt; method. Which should create a new copy of a Serializer. Unfortunately thats not the case for some of the {{Serializer}}s in Blink planner (this should be fixed independently anyway). To be on the safe side we would still call duplicate. What do you think?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16963894" author="jark" created="Thu, 31 Oct 2019 11:30:08 +0000"  >&lt;p&gt;I thought about call &lt;tt&gt;duplicate&lt;/tt&gt; too, but calling &lt;tt&gt;duplicate&lt;/tt&gt; for every BinaryGeneric &lt;tt&gt;materialize()&lt;/tt&gt; is a performance penalty (most of the cases the serializer is KryoSerializer). &lt;/p&gt;

&lt;p&gt;Another idea is exposing &lt;tt&gt;ensureMaterialized(TypeSerializer&amp;lt;T&amp;gt; javaObjectSer)&lt;/tt&gt; to BinaryGeneric, it will use the serializer parameter to materialize. And in &lt;tt&gt;BinaryGenericSerializer&lt;/tt&gt;, we should call &lt;tt&gt;generic.ensureMaterialized(ser)&lt;/tt&gt; before access segments of it. This can make sure one thread holds a serializer, and don&apos;t need to duplicate for every records. &lt;/p&gt;

&lt;p&gt;Some pseudo code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// BinaryGeneric
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void ensureMaterialized(TypeSerializer&amp;lt;T&amp;gt; serializer) {
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (binary == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      binary = materialize(serializer);
   }
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Binary materialize(TypeSerializer&amp;lt;T&amp;gt; serializer) {
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = InstantiationUtil.serializeToByteArray(serializer, javaObject);
   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Binary(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MemorySegment[] {MemorySegmentFactory.wrap(bytes)}, 0, bytes.length);
}

@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Binary materialize() {
   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; materialize(javaObjectSer.duplicate());
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What do you think?&lt;/p&gt;
</comment>
                            <comment id="16963897" author="lzljs3620320" created="Thu, 31 Oct 2019 11:38:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;&#160;, I think maybe we don&apos;t need to make it immutable. Consider org.apache.flink.types.Row and other data formats, they are not immutable, but it doesn&apos;t affect their read-only thread safety. In flink, maybe we just want read-only thread safety objects.&lt;/p&gt;</comment>
                            <comment id="16963903" author="lzljs3620320" created="Thu, 31 Oct 2019 11:45:05 +0000"  >&lt;p&gt;About&#160;BinaryGeneric:&lt;/p&gt;

&lt;p&gt;I have considered pass type serializer to BinaryGeneric instead of it contains serializer too.&#160;Further more, I think we can push down the methods(like ensureMaterialized, materialize and others) to BinaryString. So BinaryGeneric can have&#160;ensureMaterialized(TypeSerializer) and&#160;materialize(TypeSerializer).&lt;/p&gt;</comment>
                            <comment id="16963941" author="dawidwys" created="Thu, 31 Oct 2019 12:20:35 +0000"  >&lt;p&gt;There is one problem with entirely removing the serializer from &lt;tt&gt;BinaryGeneric }} that we can not implement {{equals/hashCode&lt;/tt&gt; as they require that both objects have the same representation available.&lt;/p&gt;</comment>
                            <comment id="16963949" author="jark" created="Thu, 31 Oct 2019 12:30:19 +0000"  >&lt;p&gt;Regarding removing serializer from BinaryGeneric entirely,&lt;br/&gt;
If we want to support &lt;tt&gt;LazyBinaryFormat&lt;/tt&gt; for &lt;tt&gt;BinaryMap&lt;/tt&gt; and &lt;tt&gt;BinaryArray&lt;/tt&gt; in the future, considering the BinaryGeneric is nested in BinaryMap, I think we still need the &lt;tt&gt;materialize()&lt;/tt&gt; method on &lt;tt&gt;BinaryGeneric&lt;/tt&gt;. Which mean, we can&apos;t remove serializer from BinaryGeneric entirely.&lt;/p&gt;</comment>
                            <comment id="16963955" author="lzljs3620320" created="Thu, 31 Oct 2019 12:40:36 +0000"  >&lt;p&gt;&amp;gt;&#160;There is one problem with entirely removing the serializer from&#160;&lt;tt&gt;BinaryGeneric that we can not implement equals/hashCode&lt;/tt&gt;&#160;as they require that both objects have the same representation available.&lt;/p&gt;

&lt;p&gt;Now consider JoinedRow, it can not equals and hashcode too, because&#160;we don&apos;t know what row is below and how to serialize it to be consistent. (the values serialized by GenericRow and BinaryRow are different)&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;If we want to support&#160;&lt;tt&gt;LazyBinaryFormat&lt;/tt&gt;&#160;for&#160;&lt;tt&gt;BinaryMap&lt;/tt&gt;&#160;and&#160;&lt;tt&gt;BinaryArray&lt;/tt&gt;&#160;in the future, considering the BinaryGeneric is nested in BinaryMap, I think we still need the&#160;&lt;tt&gt;materialize()&lt;/tt&gt;&#160;method on&#160;&lt;tt&gt;BinaryGeneric&lt;/tt&gt;. Which mean, we can&apos;t remove serializer from BinaryGeneric entirely.&lt;/p&gt;

&lt;p&gt;About the implementation of future BinaryMap, we need serializer to do these things, we have nested row, nested generic, it is&#160;necessary to do these conversion by serializer. So I think there is no need to keep&#160;&lt;tt&gt;materialize().&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16963982" author="dawidwys" created="Thu, 31 Oct 2019 13:12:22 +0000"  >&lt;p&gt;I don&apos;t know exactly how the &lt;tt&gt;JoinedRow&lt;/tt&gt; is used and therefore if the &lt;tt&gt;equals/hashCode&lt;/tt&gt; is needed. Correct me if I am wrong but if we remove the &lt;tt&gt;equals/hashCode&lt;/tt&gt; from &lt;tt&gt;BinaryGeneric&lt;/tt&gt;, doesn&apos;t it mean that we can no longer use generic objects in a &lt;tt&gt;GroupBy&lt;/tt&gt; clause, no? Isn&apos;t that a regression?&lt;/p&gt;

&lt;p&gt;Edit: Ok I think the answer is that the key selector always uses &lt;tt&gt;BinaryRow&lt;/tt&gt;, where the &lt;tt&gt;BinaryGeneric&lt;/tt&gt; is written as bytes. You never compare the objects.&lt;/p&gt;

&lt;p&gt;I would be in favor of removing the &lt;tt&gt;serializer&lt;/tt&gt; from the &lt;tt&gt;BinaryGeneric&lt;/tt&gt; then.&lt;/p&gt;</comment>
                            <comment id="16964605" author="lzljs3620320" created="Fri, 1 Nov 2019 05:20:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;&#160;yes, it depends on our CodeGen or runtime computation.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&#160;About&#160;removing&#160;the serializer from the BinaryGeneric, BinaryArray/BinaryMap should never be LazyBinaryFormat, because them have BaseArray to unify GenericArray and BinaryArray, so we don&apos;t need introduce lazy format for them.(Consider the methods of BaseArray, it is really hard to support LazyBinaryFormat). So this is not a problem. Is that look good to you?&lt;/p&gt;</comment>
                            <comment id="16964639" author="jark" created="Fri, 1 Nov 2019 06:35:56 +0000"  >&lt;p&gt;As discussed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; offline, we will not have lazy BinaryMap and lazy BinaryArray in the future (we already have an abstraction of BaseMap whose subclass could be BinaryMap or GenericMap). &lt;/p&gt;

&lt;p&gt;So I agree with removing the serizlier from BinaryGeneric, then BinaryGeneric shouldn&apos;t extends from &lt;tt&gt;LazyBinaryFormat&lt;/tt&gt; or we should move some methods of &lt;tt&gt;LazyBinaryFormat&lt;/tt&gt; to &lt;tt&gt;BinaryString&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16964662" author="lzljs3620320" created="Fri, 1 Nov 2019 06:56:14 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;, Let me summarize the current conclusions:&lt;/p&gt;

&lt;p&gt;For BinaryLazyFormat: the core issue is we need it read-only thread safe on lazy&#160;initialization. Consider our binary segments are idempotent, &lt;em&gt;&lt;b&gt;we introduce a Binary class to wrap&#160;segments and offset and sizeInBytes&lt;/b&gt;&lt;/em&gt;, &#160;to let the lazy field be a single field,&#160;In this way, even if different threads initialize different instances, there will be no conflict. It will become a read-only thread-safe&#160;lazy&#160;initialization.&lt;/p&gt;

&lt;p&gt;For BinaryGeneric: &lt;b&gt;&lt;em&gt;We need get it rid of serializer, equals and hashcode should throw unsupport exception&lt;/em&gt;.&lt;/b&gt; One implementation way is push down methods to BinaryString from LazyBinaryFormat,&#160; in this way, BinaryString and BinaryGeneric have different methods, methods of BinaryGeneric should have serializer argument.&lt;/p&gt;

&lt;p&gt;Correct me if I am wrong.&lt;/p&gt;</comment>
                            <comment id="16964797" author="jark" created="Fri, 1 Nov 2019 12:24:43 +0000"  >&lt;p&gt;Sounds good to me.&lt;/p&gt;</comment>
                            <comment id="16969132" author="dawidwys" created="Thu, 7 Nov 2019 10:20:32 +0000"  >&lt;p&gt;Fixed in &lt;br/&gt;
master: 0b28e830d7366126a91ca9faa38cb19a8f66a9b6&lt;br/&gt;
1.9.2: 814b5fd35fd0308f6edeedb8414623a43ba512a7&lt;/p&gt;</comment>
                            <comment id="17042879" author="wind_ljy" created="Sun, 23 Feb 2020 10:11:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The error still exists after I cherry-pick the commit in 1.9.2. Could you take a look at&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16242&quot; title=&quot;BinaryGeneric serialization error cause checkpoint failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-16242&quot;&gt;&lt;del&gt;FLINK-16242&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13262800">FLINK-14430</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13251071">FLINK-13740</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13287046">FLINK-16242</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13262800">FLINK-14430</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 38 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05m0g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>