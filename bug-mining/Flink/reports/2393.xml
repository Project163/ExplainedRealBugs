<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9169] NPE when restoring from old savepoint and state serializer could not be deserialized</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9169</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;A user reported to have observed the following exception when restoring a Flink job from a 1.3 savepoint with Flink 1.4.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-04-02 21:44:18,146 INFO  org.apache.flink.runtime.taskmanager.Task                     - ApplyAMUpdate (13/160) (7248adb0b85f4458ae4144963d65
6fa6) switched from RUNNING to FAILED.
java.lang.IllegalStateException: Could not initialize keyed state backend.
        at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initKeyedState(AbstractStreamOperator.java:293)
        at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:225)
        at org.apache.flink.streaming.runtime.tasks.StreamTask.initializeOperators(StreamTask.java:692)
        at org.apache.flink.streaming.runtime.tasks.StreamTask.initializeState(StreamTask.java:679)
        at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:253)
        at org.apache.flink.runtime.taskmanager.Task.run(Task.java:718)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.NullPointerException
        at org.apache.flink.util.Preconditions.checkNotNull(Preconditions.java:58)
        at org.apache.flink.runtime.state.RegisteredKeyedBackendStateMetaInfo.&amp;lt;init&amp;gt;(RegisteredKeyedBackendStateMetaInfo.java:53)
        at org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend$RocksDBFullRestoreOperation.restoreKVStateMetaData(RocksDBKeyedStateB
ackend.java:1216)
        at org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend$RocksDBFullRestoreOperation.restoreKeyGroupsInStateHandle(RocksDBKeye
dStateBackend.java:1153)
        at org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend$RocksDBFullRestoreOperation.doRestore(RocksDBKeyedStateBackend.java:1
139)
        at org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend.restore(RocksDBKeyedStateBackend.java:1034)
        at org.apache.flink.streaming.runtime.tasks.StreamTask.createKeyedStateBackend(StreamTask.java:773)
        at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initKeyedState(AbstractStreamOperator.java:283)
        ... 6 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at the &lt;tt&gt;KeyedBackendStateMetaInfoSnapshotReaderWriters&lt;/tt&gt;, we create &lt;tt&gt;RegisteredKeyedBackendStateMetaInfo.Snapshot&lt;/tt&gt; where the &lt;tt&gt;stateSerializer&lt;/tt&gt; can be &lt;tt&gt;null&lt;/tt&gt;. This is not the problem, however, in &lt;tt&gt;RocksDBKeyedStateBackend#restoreKVStateMetaData&lt;/tt&gt; we create a &lt;tt&gt;RegisteredKeyedBackendStateMetaInfo&lt;/tt&gt; from the deserialized &lt;tt&gt;Snapshot&lt;/tt&gt; where we null check the state serializer. This will then fail with an indescriptive NPE.&lt;/p&gt;

&lt;p&gt;I think the same should happen when resuming with Flink 1.5 from a 1.4 savepoint.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13152341">FLINK-9169</key>
            <summary>NPE when restoring from old savepoint and state serializer could not be deserialized</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tzulitai">Tzu-Li (Gordon) Tai</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Apr 2018 16:54:15 +0000</created>
                <updated>Mon, 7 May 2018 06:29:16 +0000</updated>
                            <resolved>Mon, 7 May 2018 06:29:16 +0000</resolved>
                                    <version>1.4.2</version>
                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16460706" author="githubbot" created="Wed, 2 May 2018 08:28:27 +0000"  >&lt;p&gt;GitHub user tzulitai opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5945&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9169&quot; title=&quot;NPE when restoring from old savepoint and state serializer could not be deserialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9169&quot;&gt;&lt;del&gt;FLINK-9169&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Allow KeyedBackendSerializationProxy to specify whether serializer presence is required&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Previously, in both the RocksDB and heap state backends, on restore of a savepoint if the previous state serializer can not be read, the restore will fail.&lt;/p&gt;

&lt;p&gt;    This is a must in the heap side, but not for RocksDB, since the restore can still proceed with the new serializer (given that the serializer is compatible).&lt;br/&gt;
    This PR relaxes the requirement of serializer presence at restore time for RocksDB.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Let `KeyedBackendSerializationProxy` allow specifying a flag whether or not serializer presence is strictly required when restoring the keyed backend. For heap backends, this flag would be `true`, while for RocksDB this flag is `false`.&lt;/li&gt;
	&lt;li&gt;`TypeSerializerSerializationUtil.tryReadSerializer(...)` now always returns a `UnloadableDummyTypeSerializer` if the `useDummyPlaceholder` is set to `true` and an exception occurred (regardless of what exception) while reading serializers. It only returns `null` if `useDummyPlaceholder` is `false`. This flag corresponds to the serializer presence flag mentioned above.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    There are already a few existing tests related to this issue:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`MemoryStateBackendTest.testKeyedStateRestoreFailsIfSerializerDeserializationFails`&lt;/li&gt;
	&lt;li&gt;`SerializationProxiesTest.testKeyedBackendSerializationProxyRoundtripWithSerializerSerializationFailures`&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    What may still be missing is an e2e test, that verifies RocksDB can restore correctly even if a previous serializer class is no longer in the classpath (i.e. is replaced by a new compatible serializer of a different class).&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tzulitai/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tzulitai/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9169&quot; title=&quot;NPE when restoring from old savepoint and state serializer could not be deserialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9169&quot;&gt;&lt;del&gt;FLINK-9169&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5945.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5945.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5945&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 0eb2918a7551094b712173e332df7f2663ecf0cc&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-05-02T05:37:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9169&quot; title=&quot;NPE when restoring from old savepoint and state serializer could not be deserialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9169&quot;&gt;&lt;del&gt;FLINK-9169&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Allow KeyedBackendSerializationProxy to specify whether serializer presence is required&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16462059" author="githubbot" created="Thu, 3 May 2018 07:42:19 +0000"  >&lt;p&gt;GitHub user tzulitai opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9169&quot; title=&quot;NPE when restoring from old savepoint and state serializer could not be deserialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9169&quot;&gt;&lt;del&gt;FLINK-9169&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;state-backend&amp;#93;&lt;/span&gt; Allow absence of old serializers when restoring RocksDBStateBackend&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR contains 2 commits that overall allows absence of old state serializers when restoring the RocksDB state backend. It also eliminates the possibility of confusing NPEs which comes with the fact that previously, restored serializers may be `null`.&lt;/p&gt;

&lt;p&gt;    Allowing old state serializers to be absent for the RocksDB state backend will allow for users to perform state evolutions that they couldn&apos;t before.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;2f9f0d9 Always use dummy serializer instead of null when old state serializer cannot be read&lt;br/&gt;
    Previously, the behaviour of `TypeSerializerSerializationUtil` read methods in the case when serializers cannot be read, is quite mixed up. For some exceptions (e.g. `ClassNotFoundException,&lt;br/&gt;
    InvalidClassException`), a dummy serializer will be used as a replacement. In other cases, `null` is used.&lt;br/&gt;
    This commit fixes this by always using dummy serializers if a `useDummyPlaceholder` flag is set to true. Otherwise, an `IOException` is thrown. This makes it clear that users should use dummy serializers if they want the deserialization to be tolerant to failures.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Another benefit of this is that there will no longer be `null` serializers after restore; they will either be an actual serializer, or a dummy if the old serializer cannot be restored.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;95223fc Adds a `isSerializerPresenceRequired` flag to the `KeyedBackendSerializationProxy`.&lt;br/&gt;
    If true, restored serializers cannot be the dummy serializer, otherwise an `IOException` will be thrown to fail the restore. Heap backends set this to true, while RocksDB sets this to false.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    There are two main test classes that already have coverage of this issue:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`SerializationProxiesTest`&lt;/li&gt;
	&lt;li&gt;`StateBackendTestBase`&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    A new test, `StateBackendTestBase#testSerializerPresenceOnRestore`, additionally verifies the restore behaviour of heap / rocksdb state backends when serializers are not present.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tzulitai/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tzulitai/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9169&quot; title=&quot;NPE when restoring from old savepoint and state serializer could not be deserialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9169&quot;&gt;&lt;del&gt;FLINK-9169&lt;/del&gt;&lt;/a&gt;-approach2&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5950&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2f9f0d9ab02c0c207e4ac887e958f8de9c057310&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-05-02T05:37:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9169&quot; title=&quot;NPE when restoring from old savepoint and state serializer could not be deserialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9169&quot;&gt;&lt;del&gt;FLINK-9169&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Always use dummy serializer instead of null when old state serializer cannot be read&lt;/p&gt;

&lt;p&gt;    Prreviously, the behaviour of TypeSerializerSerializationUtil read&lt;br/&gt;
    methods in the case when serializers cannot be read, is quite mixed up.&lt;br/&gt;
    For some exceptions (e.g. ClassNotFoundException,&lt;br/&gt;
    InvalidClassException), a dummy serializer will be used as a&lt;br/&gt;
    replacement. In other cases, null is used.&lt;/p&gt;

&lt;p&gt;    This commit fixes this by always using dummy serializers if a&lt;br/&gt;
    &apos;useDummyPlaceholder&apos; flag is set to true. Otherwise, an IOException is&lt;br/&gt;
    thrown. This makes it clear that users should use dummy serializers if&lt;br/&gt;
    they want the deserialization to be tolerant to failures.&lt;/p&gt;

&lt;p&gt;    Another benefit of this is that there will no longer be &apos;null&apos;&lt;br/&gt;
    serializers after restore; they will either be an actual serializer, or&lt;br/&gt;
    a dummy if the old serializer cannot be restored.&lt;/p&gt;

&lt;p&gt;commit 95223fc129ed0439b3f14636721cb72bc7560876&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@...&amp;gt;&lt;br/&gt;
Date:   2018-05-03T07:30:55Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9169&quot; title=&quot;NPE when restoring from old savepoint and state serializer could not be deserialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9169&quot;&gt;&lt;del&gt;FLINK-9169&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Allow specifiying serializer presence requirement in KeyedBackendSerializationProxy&lt;/p&gt;

&lt;p&gt;    This commit consolidates logic of whether old serializers are required&lt;br/&gt;
    to be present at restore time in the KeyedBackendSerializationProxy, via&lt;br/&gt;
    a isSerializerPresenceRequired flag.&lt;/p&gt;

&lt;p&gt;    Heap-based backends typically set this to true, while RocksDB state&lt;br/&gt;
    backend will set this to false. If set to true, restored serializers&lt;br/&gt;
    cannot be the UnloadableDummyTypeSerializer, otherwise an IOException&lt;br/&gt;
    will be thrown to fail the restore.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16462075" author="githubbot" created="Thu, 3 May 2018 07:58:43 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5945&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;ve opened a new PR #5950 which has a cleaner approach to this.&lt;br/&gt;
    That new PR subsumes this one.&lt;/p&gt;</comment>
                            <comment id="16462076" author="githubbot" created="Thu, 3 May 2018 07:58:43 +0000"  >&lt;p&gt;Github user tzulitai closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5945&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16462321" author="githubbot" created="Thu, 3 May 2018 11:50:18 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950#discussion_r185771830&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950#discussion_r185771830&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/typeutils/TypeSerializerSerializationUtil.java &amp;#8212;&lt;br/&gt;
    @@ -69,7 +69,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;written using 
{@link #writeSerializer(DataOutputView, TypeSerializer)}
&lt;p&gt;.&lt;br/&gt;
     	 *&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;If deserialization fails for any reason (corrupted serializer bytes, serializer class&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* no longer in classpath, serializer class no longer valid, etc.), 
{@code null}
&lt;p&gt; will&lt;br/&gt;
    +	 * no longer in classpath, serializer class no longer valid, etc.), an &lt;/p&gt;
{@link IOException}
&lt;p&gt; is thrown.&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Comment in the next line should be deleted, looks like leftover from the copy-paste.&lt;/p&gt;</comment>
                            <comment id="16462326" author="githubbot" created="Thu, 3 May 2018 11:53:47 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950#discussion_r185772501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950#discussion_r185772501&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/state/testutils/ArtificialCNFErrorThrowingClassLoader.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,42 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.state.testutils;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Utility classloader used in tests that allows simulating &lt;/p&gt;
{@link ClassNotFoundException}
&lt;p&gt;s for specific classes.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ArtificialCNFErrorThrowingClassLoader extends ClassLoader {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `ArtificialCNFExceptionThrowingClassLoader` might be a better fit&lt;/p&gt;</comment>
                            <comment id="16462341" author="githubbot" created="Thu, 3 May 2018 12:08:48 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950#discussion_r185775633&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950#discussion_r185775633&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBKeyedStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -589,7 +589,7 @@ private void restoreKeyGroupsInStateHandle()&lt;br/&gt;
     		private void restoreKVStateMetaData() throws IOException, StateMigrationException, RocksDBException {&lt;/p&gt;

&lt;p&gt;     			KeyedBackendSerializationProxy&amp;lt;K&amp;gt; serializationProxy =&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new KeyedBackendSerializationProxy&amp;lt;&amp;gt;(rocksDBKeyedStateBackend.userCodeClassLoader);&lt;br/&gt;
    +				new KeyedBackendSerializationProxy&amp;lt;&amp;gt;(rocksDBKeyedStateBackend.userCodeClassLoader, false);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Maybe a small comment on this line why we can tolerate the absence of the serializer is helpful for future maintenance. And a matching comment for the other option on the corresponding line in the heap backend.&lt;/p&gt;</comment>
                            <comment id="16462534" author="githubbot" created="Thu, 3 May 2018 14:38:48 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950#discussion_r185821296&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950#discussion_r185821296&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/typeutils/TypeSerializerSerializationUtil.java &amp;#8212;&lt;br/&gt;
    @@ -373,15 +370,14 @@ public void read(DataInputView in) throws IOException &lt;/p&gt;
{
     
     				Thread.currentThread().setContextClassLoader(userClassLoader);
     				typeSerializer = (TypeSerializer&amp;lt;T&amp;gt;) ois.readObject();
    -			}
&lt;p&gt; catch (ClassNotFoundException | InvalidClassException e) &lt;/p&gt;
{
    +			}
&lt;p&gt; catch (Exception e) {&lt;br/&gt;
     				if (useDummyPlaceholder) {&lt;br/&gt;
     					// we create a dummy so that all the information is not lost when we get a new checkpoint before receiving&lt;br/&gt;
     					// a proper typeserializer from the user&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;typeSerializer =&lt;/li&gt;
	&lt;li&gt;new UnloadableDummyTypeSerializer&amp;lt;&amp;gt;(buffer);&lt;/li&gt;
	&lt;li&gt;LOG.warn(&quot;Could not find requested TypeSerializer class in classpath. Created dummy.&quot;, e);&lt;br/&gt;
    +					typeSerializer = new UnloadableDummyTypeSerializer&amp;lt;&amp;gt;(buffer);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Some food for thought, even if it is not introduced by this PR: why can we not introduce a special `UnloadableSerializerException extends IOException` that holds a field  with the byte array in `buffer` and let it bubble up to a higher level component. If that component wants to introduce dummies, it can do some from the bytes in the caught exception, if not forward the exception. Then we would not have to hand down this flag but let the higher level component decide. What do you think?&lt;/p&gt;</comment>
                            <comment id="16462547" author="githubbot" created="Thu, 3 May 2018 14:50:10 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950#discussion_r185825767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950#discussion_r185825767&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/typeutils/TypeSerializerSerializationUtil.java &amp;#8212;&lt;br/&gt;
    @@ -200,7 +197,7 @@ public static void writeSerializersAndConfigsWithResilience(&lt;br/&gt;
     			for (int i = 0; i &amp;lt; numSerializersAndConfigSnapshots; i++) {&lt;/p&gt;

&lt;p&gt;     				bufferWithPos.setPosition(offsets&lt;span class=&quot;error&quot;&gt;&amp;#91;i * 2&amp;#93;&lt;/span&gt;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializer = tryReadSerializer(bufferWrapper, userCodeClassLoader);&lt;br/&gt;
    +				serializer = tryReadSerializer(bufferWrapper, userCodeClassLoader, true);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This could be the place where we catch a `UnloadableSerializerException`, but if we let the caller do the iteration from 0 to `numSerializersAndConfigSnapshots`, we can push it out even more. Why is it helpful to create a list here? Otherwise we can do the exception handling in the caller and more fine grained.&lt;/p&gt;</comment>
                            <comment id="16462554" author="githubbot" created="Thu, 3 May 2018 14:56:15 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950#discussion_r185828137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950#discussion_r185828137&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/typeutils/TypeSerializerSerializationUtil.java &amp;#8212;&lt;br/&gt;
    @@ -200,7 +197,7 @@ public static void writeSerializersAndConfigsWithResilience(&lt;br/&gt;
     			for (int i = 0; i &amp;lt; numSerializersAndConfigSnapshots; i++) {&lt;/p&gt;

&lt;p&gt;     				bufferWithPos.setPosition(offsets&lt;span class=&quot;error&quot;&gt;&amp;#91;i * 2&amp;#93;&lt;/span&gt;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializer = tryReadSerializer(bufferWrapper, userCodeClassLoader);&lt;br/&gt;
    +				serializer = tryReadSerializer(bufferWrapper, userCodeClassLoader, true);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The problem is that this method might mix too many things together, that is also again visible in the complex return type and e.g. many call sites are only interested in the first element of the list. Wonder if we should break this up in dedicated steps (serializer, config) and let the callers invoke them one by one, so that we can handle exceptions on a higher level and make decisions about if we need to have a serializer there.&lt;/p&gt;</comment>
                            <comment id="16462563" author="githubbot" created="Thu, 3 May 2018 15:03:19 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Please also check the travis build, some related tests seem to fail:&lt;br/&gt;
    Tests in error: &lt;br/&gt;
      TypeSerializerSerializationUtilTest.testSerializerAndConfigPairsSerializationWithSerializerDeserializationFailures:236 &#194;&#187; IO&lt;br/&gt;
      TypeSerializerSerializationUtilTest.testSerializerSerializationWithClassNotFound:109 &#194;&#187; IO&lt;br/&gt;
      TypeSerializerSerializationUtilTest.testSerializerSerializationWithInvalidClass:149 &#194;&#187; IO&lt;br/&gt;
      PojoSerializerTest.testSerializerSerializationFailureResilience:570 &#194;&#187; IO&lt;/p&gt;</comment>
                            <comment id="16463363" author="githubbot" created="Fri, 4 May 2018 04:51:55 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StefanRRichter yes, now that you mentioned it, the `isSerializerPresenceRequiredFlag` does seem a bit awkward to be in the serialization proxy. Essentially, what it is only doing is serving as a switch to decide whether or not to fail - something that could be done by the caller.&lt;/p&gt;

&lt;p&gt;    I&apos;ll quickly try your suggested approach and see how that turns out.&lt;/p&gt;</comment>
                            <comment id="16463384" author="githubbot" created="Fri, 4 May 2018 05:33:21 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think even with the `UnloadableTypeSerializerException` exception bubbling approach, we actually still need a flag in the serialization proxy to decide how to handle the exception.&lt;/p&gt;

&lt;p&gt;    The serialization proxy handles deserialization of all meta data of all registered key states, so that would be the highest level where we need to decide whether or not to use the dummy serializer.&lt;/p&gt;

&lt;p&gt;    If we want to hand out this control to an even higher level (i.e. the backend), we would then need to break up the deserialization logic from the serialization proxy, which IMO isn&apos;t appropriate.&lt;/p&gt;</comment>
                            <comment id="16463405" author="githubbot" created="Fri, 4 May 2018 06:12:28 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950#discussion_r185995278&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950#discussion_r185995278&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/typeutils/TypeSerializerSerializationUtil.java &amp;#8212;&lt;br/&gt;
    @@ -200,7 +197,7 @@ public static void writeSerializersAndConfigsWithResilience(&lt;br/&gt;
     			for (int i = 0; i &amp;lt; numSerializersAndConfigSnapshots; i++) {&lt;/p&gt;

&lt;p&gt;     				bufferWithPos.setPosition(offsets&lt;span class=&quot;error&quot;&gt;&amp;#91;i * 2&amp;#93;&lt;/span&gt;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializer = tryReadSerializer(bufferWrapper, userCodeClassLoader);&lt;br/&gt;
    +				serializer = tryReadSerializer(bufferWrapper, userCodeClassLoader, true);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    One other thing to keep in mind:&lt;br/&gt;
    The original intent of having the `readSerializersAndConfigSnapshotsWithResilience` method and why we added the complex indexing of offsets, is that so we can &lt;em&gt;always&lt;/em&gt; be fault tolerant when trying to read a bunch of serializers. So, essentially, there is no need to push out the exception further - the result of `readSerializersAndConfigSnapshotsWithResilience` should always be that there is some serializer, even if it is a dummy (hence the naming).&lt;/p&gt;</comment>
                            <comment id="16463406" author="githubbot" created="Fri, 4 May 2018 06:12:28 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950#discussion_r185994375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950#discussion_r185994375&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/typeutils/TypeSerializerSerializationUtil.java &amp;#8212;&lt;br/&gt;
    @@ -200,7 +197,7 @@ public static void writeSerializersAndConfigsWithResilience(&lt;br/&gt;
     			for (int i = 0; i &amp;lt; numSerializersAndConfigSnapshots; i++) {&lt;/p&gt;

&lt;p&gt;     				bufferWithPos.setPosition(offsets&lt;span class=&quot;error&quot;&gt;&amp;#91;i * 2&amp;#93;&lt;/span&gt;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializer = tryReadSerializer(bufferWrapper, userCodeClassLoader);&lt;br/&gt;
    +				serializer = tryReadSerializer(bufferWrapper, userCodeClassLoader, true);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The reason why this method is so complex, is because it handles indexing of the serializers&apos; and serializer config snapshots&apos; offsets within the byte stream. It does so to be able to read all serializers and their serializer config snapshots fault tolerantly, and to not leave the stream corrupt when some exception occurs.&lt;/p&gt;

&lt;p&gt;    I&apos;m not sure we can break this method up - doing so would just be moving a lot of duplicate code to the callers (due to the fact that we previously have the offset index reading / writing, if we remove that we still need to maintain backwards compatibility).&lt;/p&gt;</comment>
                            <comment id="16463407" author="githubbot" created="Fri, 4 May 2018 06:12:28 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950#discussion_r185994454&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950#discussion_r185994454&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/typeutils/TypeSerializerSerializationUtil.java &amp;#8212;&lt;br/&gt;
    @@ -200,7 +197,7 @@ public static void writeSerializersAndConfigsWithResilience(&lt;br/&gt;
     			for (int i = 0; i &amp;lt; numSerializersAndConfigSnapshots; i++) {&lt;/p&gt;

&lt;p&gt;     				bufferWithPos.setPosition(offsets&lt;span class=&quot;error&quot;&gt;&amp;#91;i * 2&amp;#93;&lt;/span&gt;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serializer = tryReadSerializer(bufferWrapper, userCodeClassLoader);&lt;br/&gt;
    +				serializer = tryReadSerializer(bufferWrapper, userCodeClassLoader, true);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Since we are already thinking about not writing serializers anymore in savepoints for 1.6, I&apos;m leaning towards not touching this method now.&lt;/p&gt;</comment>
                            <comment id="16463485" author="githubbot" created="Fri, 4 May 2018 07:24:21 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StefanRRichter I have updated the PR. Also had to do a rebase due to conflicts.&lt;/p&gt;

&lt;p&gt;    Regarding the thoughts you brought up:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Bubble up `UnloadableTypeSerializerException` approach:&lt;br/&gt;
    I introduced the exception, but only use it minimally. I think overall it is definitely an improvement, since we don&apos;t have to carry the dummy flag all the way down to the low-level serializer serialization proxy. However, I don&apos;t think there really is a need to handle it any level higher than the `TypeSerializerSerializationUtil.readSerializersAndConfigsWithResilience` method, since the original intent of that method was to always be fault tolerant when reading a bunch of serializers alongside other things. More details on that in my above comments.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Whether or not we really need to hand down the flag to `KeyedBackendSerializationProxy`:&lt;br/&gt;
    My gut feeling is that, even if in the future we bubble up the `UnloadableTypeSerializerException` to higher level components, the serialization proxy is still where we need to decide whether or not we handle it with a dummy serializer. The reason is that the serialization proxies handles deserialization of &lt;em&gt;all&lt;/em&gt; keyed state meta infos (and therefore their serializers); simply bubbling the exception further up without checking does not make sense.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16463867" author="githubbot" created="Fri, 4 May 2018 13:30:41 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yes, I think we can only remove the flag further when splitting up `readSerializersAndConfigsWithResilience`, but I guess it is ok to leave it if we change this soon anyways.&lt;/p&gt;</comment>
                            <comment id="16463869" author="githubbot" created="Fri, 4 May 2018 13:32:54 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950#discussion_r186082804&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950#discussion_r186082804&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/typeutils/TypeSerializerSerializationUtil.java &amp;#8212;&lt;br/&gt;
    @@ -102,17 +99,24 @@&lt;br/&gt;
     	 *&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@return the deserialized serializer.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public static &amp;lt;T&amp;gt; TypeSerializer&amp;lt;T&amp;gt; tryReadSerializer(DataInputView in, ClassLoader userCodeClassLoader, boolean useDummyPlaceholder) {&lt;br/&gt;
    +	public static &amp;lt;T&amp;gt; TypeSerializer&amp;lt;T&amp;gt; tryReadSerializer(&lt;br/&gt;
    +			DataInputView in,&lt;br/&gt;
    +			ClassLoader userCodeClassLoader,&lt;br/&gt;
    +			boolean useDummyPlaceholder) throws IOException {&lt;br/&gt;
    +&lt;br/&gt;
     		final TypeSerializerSerializationUtil.TypeSerializerSerializationProxy&amp;lt;T&amp;gt; proxy =&lt;/li&gt;
	&lt;li&gt;new TypeSerializerSerializationUtil.TypeSerializerSerializationProxy&amp;lt;&amp;gt;(userCodeClassLoader, useDummyPlaceholder);&lt;br/&gt;
    +			new TypeSerializerSerializationUtil.TypeSerializerSerializationProxy&amp;lt;&amp;gt;(userCodeClassLoader);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		try &lt;/p&gt;
{
     			proxy.read(in);
     			return proxy.getTypeSerializer();
    -		}
&lt;p&gt; catch (IOException e) &lt;/p&gt;
{
    -			LOG.warn(&quot;Deserialization of serializer errored; replacing with null.&quot;, e);
    -
    -			return null;
    +		}
&lt;p&gt; catch (UnloadableTypeSerializerException e) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I would let this bubble up one more level, remove the flag here and only catch `UnloadableTypeSerializerException ` in the case where this method is called with `true`.&lt;/p&gt;</comment>
                            <comment id="16463873" author="githubbot" created="Fri, 4 May 2018 13:35:11 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Overall, I think this looks good for me now &#128077; &lt;/p&gt;</comment>
                            <comment id="16465338" author="githubbot" created="Mon, 7 May 2018 01:28:35 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review Stefan! Will merge this now ..&lt;/p&gt;</comment>
                            <comment id="16465484" author="githubbot" created="Mon, 7 May 2018 06:28:48 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5950&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 28 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3sj8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>