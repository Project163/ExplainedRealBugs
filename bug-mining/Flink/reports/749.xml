<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:22:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-3166] The first program in ObjectReuseITCase has the wrong expected result, and it succeeds</title>
                <link>https://issues.apache.org/jira/browse/FLINK-3166</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The first program in ObjectReuseITCase has the following input:&lt;br/&gt;
a,1&lt;br/&gt;
a,2&lt;br/&gt;
a,3&lt;br/&gt;
a,4&lt;br/&gt;
a,50&lt;br/&gt;
There is a groupBy on field 0, and then a reduce, so the result should be 1+2+3+4+50 = 60. But the hardcoded expected result is 100, and running the Flink program also produces this.&lt;/p&gt;

&lt;p&gt;The problem is caused my mismatched assumptions between ReduceCombineDriver.sortAndCombine and the ReduceFunction in the test about object reuse rules of ReduceFunctions:&lt;/p&gt;

&lt;p&gt;ReduceCombineDriver.sortAndCombine has the following comment:&lt;br/&gt;
&quot;The user function is expected to return the first input as the result.&quot;&lt;br/&gt;
While the ReduceFunction in the test is modifying and returning the second input. (And the second program in the test also has the same problem.)&lt;/p&gt;

&lt;p&gt;I can&apos;t find the assumption that is stated in the comment in any documentation. For example, the javadoc of ReduceFunction should make the user aware of this. Or, alternatively, the code of the driver should be modified to not make this assumption. I&apos;m not sure which solution is better.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12921498">FLINK-3166</key>
            <summary>The first program in ObjectReuseITCase has the wrong expected result, and it succeeds</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="greghogan">Greg Hogan</assignee>
                                    <reporter username="ggevay">G&#225;bor G&#233;vay</reporter>
                        <labels>
                    </labels>
                <created>Sun, 13 Dec 2015 17:12:27 +0000</created>
                <updated>Sun, 27 Dec 2015 12:15:27 +0000</updated>
                            <resolved>Sun, 27 Dec 2015 12:15:09 +0000</resolved>
                                                    <fixVersion>1.0.0</fixVersion>
                                    <component>Documentation</component>
                    <component>Runtime / Coordination</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15060984" author="githubbot" created="Wed, 16 Dec 2015 22:09:41 +0000"  >&lt;p&gt;GitHub user greghogan opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3166&quot; title=&quot;The first program in ObjectReuseITCase has the wrong expected result, and it succeeds&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3166&quot;&gt;&lt;del&gt;FLINK-3166&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; The first program in ObjectReuseITCase has the wrong expected result, and it succeeds&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestEnvironment now honors configuration of object reuse&lt;/li&gt;
	&lt;li&gt;Fixed reduce transformations to allow the user to modify and return either input&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This is neither clean nor complete but I wanted to get some feedback before continuing.&lt;/p&gt;

&lt;p&gt;    ObjectReuseITCase was forcing object reuse, this was fixed by updating TestEnvironment.&lt;/p&gt;

&lt;p&gt;    ReduceCombineDriver and ReduceDriver both requests the next record and call the user&apos;s reduce() and so can handle whichever of the two inputs objects the user might write to.&lt;/p&gt;

&lt;p&gt;    In the second test case DataSourceTask (which requests the next record) calls ChainedAllReduceDriver.collect (which calls the user&apos;s reduce()). There is no feedback so DataSourceTask must cycle through `n`+1 reusable objects for unknown `n`.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/greghogan/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/greghogan/flink&lt;/a&gt; 3166_fix_objectreuseitcase&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1464&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 78dc073440ed8ecfec51fbe33ce665562786bf20&lt;br/&gt;
Author: Greg Hogan &amp;lt;code@greghogan.com&amp;gt;&lt;br/&gt;
Date:   2015-12-16T19:42:06Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3166&quot; title=&quot;The first program in ObjectReuseITCase has the wrong expected result, and it succeeds&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3166&quot;&gt;&lt;del&gt;FLINK-3166&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; The first program in ObjectReuseITCase has the wrong expected result, and it succeeds&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestEnvironment now honors configuration of object reuse&lt;/li&gt;
	&lt;li&gt;Fixed reduce transformations to allow the user to modify and return either input&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;</comment>
                            <comment id="15061837" author="githubbot" created="Thu, 17 Dec 2015 10:10:23 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464#issuecomment-165406987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464#issuecomment-165406987&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    A few comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the change to the TestEnvironment is unnecessary; ObjectReuse is enabled/disabled in the JavaProgramTestBase. it doesn&apos;t fix anything, removing the call to enabledObjectReuse in the test already did the trick.&lt;/li&gt;
	&lt;li&gt;The ObjectReuseITCase is supposed to verify that objects are reused. Now, the results are the same regardless of whether they are reused (except in case 3), making it little more then a reduce test. (There is also little point of running this test with ObjectReuse disabled, which is why it forced it)&lt;/li&gt;
	&lt;li&gt;A little bit above your changes in Reduce(Combine)Driver is a comment as to why we only need 2 objects when reusing objects, this will need to be adjusted.&lt;/li&gt;
	&lt;li&gt;I like the changes in DataSourceTask/Reduce(Combine)Driver. They are a seemingly simple solution for a common problem. In fact, But i am a bit apprehensive about them, because i have a hard time imagining that no one else could think of them; there might be a bigger issue with changes that i can&apos;t see at the moment.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15062259" author="githubbot" created="Thu, 17 Dec 2015 16:20:02 +0000"  >&lt;p&gt;Github user greghogan commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464#issuecomment-165499126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464#issuecomment-165499126&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I haven&apos;t found a prohibition on returning the second input to a user-defined reduce function. I think fixing this in code is preferable to documenting the problem or throwing an error, especially since the problem only exists with object reuse enabled.&lt;/p&gt;

&lt;p&gt;    Object reuse is configured in JavaProgramTestBase but must be set in the ExecutionEnvironmentFactory by TestEnvironment. I don&apos;t see that any of the many tests subclassing JavaProgramTestBase were testing with object reuse enabled.&lt;/p&gt;

&lt;p&gt;    It is rather difficult to test for object reuse. ObjectReuseITCase simply captured a few isolated instances of strange behavior (with the original tests 3 and 4 being perfect copies). I would look to duplicate the first two tests in the appropriate JavaProgramTestBase subclass and delete ObjectReuseITCase.&lt;/p&gt;</comment>
                            <comment id="15062276" author="githubbot" created="Thu, 17 Dec 2015 16:29:22 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464#issuecomment-165501540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464#issuecomment-165501540&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &quot;Object reuse is configured in JavaProgramTestBase but must be set in the ExecutionEnvironmentFactory by TestEnvironment. I don&apos;t see that any of the many tests subclassing JavaProgramTestBase were testing with object reuse enabled.&quot;&lt;/p&gt;

&lt;p&gt;    Does this (L.112 JavaProgramTestBase)&lt;br/&gt;
    ```&lt;br/&gt;
    // prepare the test environment&lt;br/&gt;
    TestEnvironment env = new TestEnvironment(this.executor, this.parallelism);&lt;br/&gt;
    env.getConfig().enableObjectReuse();&lt;br/&gt;
    env.setAsContext();&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    not enable (and as such force) object reuse for every test that extends JavaProgramTestBase?&lt;/p&gt;</comment>
                            <comment id="15062309" author="githubbot" created="Thu, 17 Dec 2015 16:45:43 +0000"  >&lt;p&gt;Github user greghogan commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464#issuecomment-165506005&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464#issuecomment-165506005&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    TestEnvironment was only setting the parallelism when creating and establishing the ExecutionEnvironmentFactory:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    	public void setAsContext() {&lt;br/&gt;
    		ExecutionEnvironmentFactory factory = new ExecutionEnvironmentFactory() {&lt;br/&gt;
    			@Override&lt;br/&gt;
    			public ExecutionEnvironment createExecutionEnvironment() &lt;/p&gt;
{
    				lastEnv = new TestEnvironment(executor, getParallelism());
    				return lastEnv;
    			}
&lt;p&gt;    		};&lt;/p&gt;

&lt;p&gt;    		initializeContextEnvironment(factory);&lt;br/&gt;
    	}&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="15062347" author="githubbot" created="Thu, 17 Dec 2015 17:08:11 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464#issuecomment-165516598&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464#issuecomment-165516598&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    ooohhh...that&apos;s a problem. alrighty, your solution for that looks good. actually, would you mind moving that into a separate PR so we can get it in faster? this should be fixed ASAP.&lt;/p&gt;</comment>
                            <comment id="15063853" author="githubbot" created="Fri, 18 Dec 2015 11:35:13 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464#issuecomment-165753852&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464#issuecomment-165753852&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Good catch. I think all of these changes look actually good.&lt;/p&gt;

&lt;p&gt;    Minor comment in-line, otherwise +1&lt;/p&gt;</comment>
                            <comment id="15063854" author="githubbot" created="Fri, 18 Dec 2015 11:36:27 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464#discussion_r48017305&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464#discussion_r48017305&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-tests/src/test/java/org/apache/flink/test/javaApiOperators/ObjectReuseITCase.java &amp;#8212;&lt;br/&gt;
    @@ -124,26 +125,30 @@ public static String runProgram(int progId, String resultPath) throws Exception&lt;br/&gt;
     				env.execute();&lt;/p&gt;

&lt;p&gt;     				// return expected result&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return &quot;a,100\n&quot;;&lt;br/&gt;
    +				return &quot;a,60\n&quot;;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			}&lt;/p&gt;

&lt;p&gt;     			case 2: {&lt;br/&gt;
    +				// Global reduce&lt;/p&gt;

&lt;p&gt;     				final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;env.getConfig().enableObjectReuse();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     				DataSet&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; input = env.readCsvFile(inReducePath).types(String.class, Integer.class).setParallelism(1);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;DataSet&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; result = input&lt;/li&gt;
	&lt;li&gt;.reduce(new ReduceFunction&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt;() {&lt;br/&gt;
    +				DataSet&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; result = input.reduce(new ReduceFunction&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt;() {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     							@Override&lt;br/&gt;
     							public Tuple2&amp;lt;String, Integer&amp;gt; reduce(&lt;br/&gt;
     									Tuple2&amp;lt;String, Integer&amp;gt; value1,&lt;br/&gt;
     									Tuple2&amp;lt;String, Integer&amp;gt; value2) throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;value2.f1 += value1.f1;&lt;/li&gt;
	&lt;li&gt;return value2;&lt;br/&gt;
    +								if (value1.f1 % 2 == 0) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    How about changing this to `% 3`, so that it does not &quot;accidentally&quot; work by perfectly following the rotation of the &quot;reuse1&quot; and &quot;reuse2&quot; variables in the driver?&lt;/p&gt;</comment>
                            <comment id="15071932" author="githubbot" created="Sat, 26 Dec 2015 18:03:24 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464#issuecomment-167351562&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464#issuecomment-167351562&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging this...&lt;/p&gt;</comment>
                            <comment id="15072132" author="githubbot" created="Sun, 27 Dec 2015 12:14:00 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1464&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1464&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15072135" author="stephanewen" created="Sun, 27 Dec 2015 12:15:09 +0000"  >&lt;p&gt;Fixed via c246ff2e4623b38f1b05c0b3c0c8cb6ba165a33f&lt;/p&gt;

&lt;p&gt;Thank you for the contribution!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 47 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ptv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>