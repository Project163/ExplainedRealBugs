<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6714] Operator state backend should set user classloader as context classloader when snapshotting</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6714</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Now that the operator state backend creates a deep copy of the state during the synchronous part of async checkpoints, it needs to set the user classloader as the thread context classloader, otherwise serializers that uses serialization for copying will use the wrong classloader when deserializing the copy.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13074765">FLINK-6714</key>
            <summary>Operator state backend should set user classloader as context classloader when snapshotting</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tzulitai">Tzu-Li (Gordon) Tai</assignee>
                                    <reporter username="tzulitai">Tzu-Li (Gordon) Tai</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 May 2017 07:23:49 +0000</created>
                <updated>Fri, 26 May 2017 08:43:57 +0000</updated>
                            <resolved>Fri, 26 May 2017 08:43:36 +0000</resolved>
                                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16024423" author="githubbot" created="Thu, 25 May 2017 09:00:16 +0000"  >&lt;p&gt;GitHub user tzulitai opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3987&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6714&quot; title=&quot;Operator state backend should set user classloader as context classloader when snapshotting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6714&quot;&gt;&lt;del&gt;FLINK-6714&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Use user classloader for operator state copying on snapshots&lt;/p&gt;

&lt;p&gt;    Now that the operator state backend creates a deep copy of the state during the synchronous part of async checkpoints, it needs to set the user classloader as the thread context classloader, otherwise serializers that uses serialization for copying will use the wrong classloader when deserializing the copy.&lt;/p&gt;

&lt;p&gt;    A test is added to &lt;tt&gt;OperatorStateBackendTest&lt;/tt&gt; to verify that the user classloader is properly used on copy.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tzulitai/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tzulitai/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6714&quot; title=&quot;Operator state backend should set user classloader as context classloader when snapshotting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6714&quot;&gt;&lt;del&gt;FLINK-6714&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3987.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3987.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3987&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 516fd085d640d56ea2ef7be7f0b11f6ad43e92f5&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-05-25T08:54:08Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6714&quot; title=&quot;Operator state backend should set user classloader as context classloader when snapshotting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6714&quot;&gt;&lt;del&gt;FLINK-6714&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Use user classloader for operator state copying on snapshots&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16024425" author="githubbot" created="Thu, 25 May 2017 09:01:44 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3987&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Manually verified that &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6515&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-6515&lt;/a&gt; should be properly fixed with this change.&lt;/p&gt;</comment>
                            <comment id="16024437" author="githubbot" created="Thu, 25 May 2017 09:13:35 +0000"  >&lt;p&gt;Github user rmetzger commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3987&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 to merge&lt;/p&gt;</comment>
                            <comment id="16024995" author="githubbot" created="Thu, 25 May 2017 16:52:30 +0000"  >&lt;p&gt;Github user EronWright commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3987#discussion_r118530090&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3987#discussion_r118530090&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/DefaultOperatorStateBackend.java &amp;#8212;&lt;br/&gt;
    @@ -185,13 +185,18 @@ public void dispose() {&lt;br/&gt;
     				new HashMap&amp;lt;&amp;gt;(registeredStates.size());&lt;/p&gt;

&lt;p&gt;     		// eagerly create deep copies of the list states in the sync phase, so that we can use them in the async writing&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (Map.Entry&amp;lt;String, PartitionableListState&amp;lt;?&amp;gt;&amp;gt; entry : this.registeredStates.entrySet()) {&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;PartitionableListState&amp;lt;?&amp;gt; listState = entry.getValue();&lt;/li&gt;
	&lt;li&gt;if (null != listState) {&lt;/li&gt;
	&lt;li&gt;listState = listState.deepCopy();&lt;br/&gt;
    +		ClassLoader snapshotClassLoader = Thread.currentThread().getContextClassLoader();&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			Thread.currentThread().setContextClassLoader(userClassloader);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    (nitpick) `Thread.currentThread().setContextClassLoader(userClassloader)` should occur before the `try` block is entered.   Setting the TCCL occurs in about a half-dozen places in Flink, and this is inconsistent with most of them.&lt;/p&gt;</comment>
                            <comment id="16025751" author="githubbot" created="Fri, 26 May 2017 03:28:42 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3987&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @rmetzger @EronWright.&lt;br/&gt;
    I&apos;ll address Eron&apos;s comment while merging.&lt;/p&gt;</comment>
                            <comment id="16025981" author="githubbot" created="Fri, 26 May 2017 08:28:58 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3987&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16026005" author="tzulitai" created="Fri, 26 May 2017 08:43:36 +0000"  >&lt;p&gt;Fixed for master via b2f5dab330c8803ab72e2bbf4e94d68fc760c467.&lt;br/&gt;
Fixed for 1.3 via e0454234748f838799f905e9271253dfa808a797.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3fg9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>