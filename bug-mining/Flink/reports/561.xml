<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:20:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2490] Remove unwanted boolean check in function SocketTextStreamFunction.streamFromSocket</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2490</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description></description>
                <environment></environment>
        <key id="12852507">FLINK-2490</key>
            <summary>Remove unwanted boolean check in function SocketTextStreamFunction.streamFromSocket</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="huangwei">Huang Wei</assignee>
                                    <reporter username="huangwei">Huang Wei</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Aug 2015 08:28:36 +0000</created>
                <updated>Thu, 28 Feb 2019 11:15:13 +0000</updated>
                            <resolved>Tue, 8 Sep 2015 16:03:07 +0000</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>0.10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="604800">168h</timeoriginalestimate>
                            <timeestimate seconds="604800">168h</timeestimate>
                                        <comments>
                            <comment id="14659712" author="githubbot" created="Thu, 6 Aug 2015 09:07:08 +0000"  >&lt;p&gt;GitHub user HuangWHWHW opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2490&quot; title=&quot;Remove unwanted boolean check in function SocketTextStreamFunction.streamFromSocket&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2490&quot;&gt;&lt;del&gt;FLINK-2490&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;FIX&amp;#93;&lt;/span&gt;Remove the retryForever check in function streamFrom&#8230;&lt;/p&gt;

&lt;p&gt;    In the class SocketTextStreamFunction, the var retryForever only  be set in  the line &quot;this.retryForever = maxRetry &amp;lt; 0;&quot;(SocketTextStreamFunction.java:54).&lt;br/&gt;
    When the program executes this &#8220;while (retry &amp;lt; maxRetry &amp;amp;&amp;amp; !success) &#8221; it means the maxRetry &amp;gt; 0 and the retryForever will always be false.&lt;br/&gt;
    So it`s unnecessary to judge whether retryForever be false.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/HuangWHWHW/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/HuangWHWHW/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2490&quot; title=&quot;Remove unwanted boolean check in function SocketTextStreamFunction.streamFromSocket&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2490&quot;&gt;&lt;del&gt;FLINK-2490&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #992&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 25a41d0f462add2f11c6830ec8db518702f8dbb5&lt;br/&gt;
Author: HuangWHWHW &amp;lt;404823056@qq.com&amp;gt;&lt;br/&gt;
Date:   2015-08-06T08:55:24Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2490&quot; title=&quot;Remove unwanted boolean check in function SocketTextStreamFunction.streamFromSocket&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2490&quot;&gt;&lt;del&gt;FLINK-2490&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;FIX&amp;#93;&lt;/span&gt;Remove the retryForever check in function streamFromSocket&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14659721" author="githubbot" created="Thu, 6 Aug 2015 09:12:31 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-128301542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-128301542&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    if you remove that check, retryForever is unused and can be removed completely.&lt;/p&gt;</comment>
                            <comment id="14659738" author="githubbot" created="Thu, 6 Aug 2015 09:29:47 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-128307751&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-128307751&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yes, I understand you.&lt;br/&gt;
    But I think the retryForever is necessary.&lt;br/&gt;
    Maybe there is a bug that make the retryForever not working.&lt;br/&gt;
    I`ll get another fix after the CI.&lt;/p&gt;</comment>
                            <comment id="14659747" author="githubbot" created="Thu, 6 Aug 2015 09:36:33 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-128309202&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-128309202&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    If you think it was necessary why was your first step to remove it&apos;s usage...&lt;/p&gt;</comment>
                            <comment id="14659821" author="githubbot" created="Thu, 6 Aug 2015 10:45:01 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-128322151&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-128322151&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hah....&lt;br/&gt;
    Sorry, this thought was generated after this PR.&lt;/p&gt;</comment>
                            <comment id="14680609" author="githubbot" created="Mon, 10 Aug 2015 19:20:49 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-129571942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-129571942&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This fix looks valid.&lt;/p&gt;

&lt;p&gt;    Can it be included in an extended test for the socket function? Something that validates that the function properly tries to reconnect?&lt;/p&gt;</comment>
                            <comment id="14681085" author="githubbot" created="Tue, 11 Aug 2015 01:40:24 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-129667322&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-129667322&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen &lt;br/&gt;
    Hi,yes,I plan to add a test for it.&lt;br/&gt;
    However, the test may be failed since the retryForever in the flink-master is also unworked currently.&lt;br/&gt;
    Will the test I`d add run together with this PR?&lt;/p&gt;
</comment>
                            <comment id="14681771" author="githubbot" created="Tue, 11 Aug 2015 13:05:28 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-129864531&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-129864531&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @HuangWHWHW `retryForever` is just a convenience variable for `maxRetry &amp;lt; 0`. Your fix is correct because the loop will only execute if `maxRetry &amp;gt; 0` and thus not execute at all if it should retry &quot;forever&quot;. It would be great if you added a test that checks for the correct number of retries. In case of infinite retries, just check up to a certain number (e.g. 100 retries).&lt;/p&gt;</comment>
                            <comment id="14681802" author="githubbot" created="Tue, 11 Aug 2015 13:35:05 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-129875331&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-129875331&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    Ok, I`ll add a test.&lt;br/&gt;
    There is a little difficult that I can`t get the retry times in test since the retry is a local variable.&lt;br/&gt;
    So can I add a function to get the retry times?&lt;/p&gt;</comment>
                            <comment id="14693076" author="githubbot" created="Wed, 12 Aug 2015 07:50:50 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130206658&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130206658&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    @StephanEwen &lt;br/&gt;
    Hi, I do a test for this today and I got another problem.&lt;br/&gt;
    The SocketTextStreamFunction use BufferedReader.read() to get the buffer which is sent by socket server.&lt;br/&gt;
    And whether this function BufferedReader.read() will never return -1 as the end of the sent message?&lt;br/&gt;
    If it was there should be another bug that code following will never be reachable:&lt;/p&gt;

&lt;p&gt;    if (data == -1) {&lt;br/&gt;
    					socket.close();&lt;br/&gt;
    					long retry = 0;&lt;br/&gt;
    					boolean success = false;&lt;br/&gt;
    					while ((retry &amp;lt; maxRetry || retryForever) &amp;amp;&amp;amp; !success) {&lt;br/&gt;
    						if (!retryForever) &lt;/p&gt;
{
    							retry++;
    						}
&lt;p&gt;    						LOG.warn(&quot;Lost connection to server socket. Retrying in &quot;&lt;br/&gt;
    								+ (CONNECTION_RETRY_SLEEP / 1000) + &quot; seconds...&quot;);&lt;br/&gt;
    						try &lt;/p&gt;
{
    							socket = new Socket();
    							socket.connect(new InetSocketAddress(hostname, port),
    									CONNECTION_TIMEOUT_TIME);
    							success = true;
    						}
&lt;p&gt; catch (ConnectException ce) &lt;/p&gt;
{
    							Thread.sleep(CONNECTION_RETRY_SLEEP);
    							socket.close();
    						}
&lt;p&gt;    					}&lt;/p&gt;

&lt;p&gt;    					if (success) &lt;/p&gt;
{
    						LOG.info(&quot;Server socket is reconnected.&quot;);
    					}
&lt;p&gt; else &lt;/p&gt;
{
    						LOG.error(&quot;Could not reconnect to server socket.&quot;);
    						break;
    					}
&lt;p&gt;    					reader = new BufferedReader(new InputStreamReader(socket.getInputStream()));&lt;br/&gt;
    					continue;&lt;br/&gt;
    				}&lt;/p&gt;</comment>
                            <comment id="14693104" author="githubbot" created="Wed, 12 Aug 2015 08:16:34 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130213092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130213092&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @HuangWHWHW `read()` method of the `BufferedReader` object returns `-1` in case the end of the stream has been reached.&lt;/p&gt;

&lt;p&gt;    A couple of things I noticed apart from the `retryForever` issue. I wonder if we can fix these with this pull request as well:&lt;/p&gt;

&lt;p&gt;    1. The control flow of the `streamFromSocket` function is hard to predict because there are many `while` loops with `break`, `continue`, or `throw` statements.&lt;br/&gt;
    2. We could use `StringBuilder` instead of `StringBuffer` in this class. `StringBuilder` is faster in the case of single-threaded access.&lt;br/&gt;
    3. The function reads a single character at a time from the socket. It is more efficient to use a buffer and read several characters at once.&lt;/p&gt;

&lt;p&gt;    @HuangWHWHW You asked how you could count the number of retries in a unit test. Typically, you would insert a `Mock` or a `Spy` into your test method. Unfortunately, this does not work here because the socket variables is overwritten in case of a retry. So for this test, I would recommend creating a local `ServerSocket` and let the function connect to this socket. You can then control the failures from your test socket. &lt;/p&gt;</comment>
                            <comment id="14693127" author="githubbot" created="Wed, 12 Aug 2015 08:37:09 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130217420&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130217420&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    Hi, thank you for suggestions.&lt;br/&gt;
    I will try to follow your suggestions and improve the test.&lt;br/&gt;
    I understand almost of yours and I also read the Class documentation of BufferedReader.read().&lt;br/&gt;
    When I was doing the test I found the BufferedReader.read() would never stop until it read next char from socket server or throw a Exception when socket is closed.&lt;br/&gt;
    Returning -1 in BufferedReader.read() seems to be only worked in text file instead socket message.&lt;br/&gt;
    And I looked for help in the net that some guys said you might add a method(Socket.setSoTimeout()) so the BufferedReader.read() would stop.&lt;br/&gt;
    But this way is not satisfied neither since it would throw a exception.&lt;/p&gt;

</comment>
                            <comment id="14693170" author="githubbot" created="Wed, 12 Aug 2015 08:59:32 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130222078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130222078&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Actually point 3 is not so bad because we&apos;re using a buffered reader that fills the buffer and does not read a character from the socket on every call to `read()`.&lt;/p&gt;

&lt;p&gt;    The `read()` method may throw an Exception or return -1. So we need to handle both of these cases. If closed properly, the socket should send the EOF event and the `read()` method returns -1.&lt;/p&gt;</comment>
                            <comment id="14693183" author="githubbot" created="Wed, 12 Aug 2015 09:11:51 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130228505&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130228505&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi, there are two more questions:&lt;br/&gt;
    1.In using StringBuilder, does it mean that we should use BufferedReader.readLine() instead of BufferedReader.read()?&lt;br/&gt;
    2.Could you tell me how to make the BufferedReader.read() return -1? I tried many ways that all filed.&lt;/p&gt;</comment>
                            <comment id="14693224" author="githubbot" created="Wed, 12 Aug 2015 09:39:07 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130237642&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130237642&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;gt; 1.In using StringBuilder, does it mean that we should use BufferedReader.readLine() instead of BufferedReader.read()?&lt;/p&gt;

&lt;p&gt;    Reading by character is the way to go if we use a custom `delimiter`. If our delimiter was `\n` then it would be ok to read entire lines.&lt;/p&gt;

&lt;p&gt;    &amp;gt;  Could you tell me how to make the BufferedReader.read() return -1? I tried many ways that all filed.&lt;/p&gt;

&lt;p&gt;    Ok &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Here is a minimal working example where `read()` returns `-1`:&lt;/p&gt;

&lt;p&gt;    ```java&lt;br/&gt;
    public static void main(String[] args) throws IOException {&lt;/p&gt;

&lt;p&gt;    	ServerSocket socket = new ServerSocket(12345);&lt;/p&gt;

&lt;p&gt;    	final SocketAddress socketAddress = socket.getLocalSocketAddress();&lt;/p&gt;

&lt;p&gt;    	new Thread(new Runnable() {&lt;br/&gt;
    		@Override&lt;br/&gt;
    		public void run() {&lt;br/&gt;
    			Socket socket = new Socket();&lt;/p&gt;

&lt;p&gt;    			try &lt;/p&gt;
{
    				socket.connect(socketAddress);
    			}
&lt;p&gt; catch (IOException e) &lt;/p&gt;
{
    				e.printStackTrace();
    			}&lt;br/&gt;
    &lt;br/&gt;
    			try {
    				BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(socket.getInputStream()));
    				System.out.println((bufferedReader.read()));
    			} catch (IOException e) {    				e.printStackTrace();    			}
&lt;p&gt;    		}&lt;br/&gt;
    	}).start();&lt;/p&gt;

&lt;p&gt;    	Socket channel = socket.accept();&lt;/p&gt;

&lt;p&gt;    	channel.close();&lt;br/&gt;
    }&lt;br/&gt;
    ```&lt;br/&gt;
    Output:&lt;br/&gt;
    ```&lt;br/&gt;
    -1&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="14693496" author="githubbot" created="Wed, 12 Aug 2015 13:46:45 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130311909&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130311909&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you!&lt;br/&gt;
    I`ll try again.&lt;/p&gt;</comment>
                            <comment id="14694658" author="githubbot" created="Thu, 13 Aug 2015 04:02:26 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130524804&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130524804&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    Hi, I fixed the StringBuffer and add the test.&lt;br/&gt;
    Take a look whether it`s correct.&lt;br/&gt;
    Thank you!&lt;/p&gt;</comment>
                            <comment id="14694932" author="githubbot" created="Thu, 13 Aug 2015 09:21:47 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130588652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130588652&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for your changes. I think we should use `read()` instead of `readLine()` because we are using a custom delimiter and not necessarily &quot;\n&quot; (newline symbol). The danger of reading an entire line is that the newline symbol might never arrive. So it might continue to read forever. And even if it manages to find a newline symbol, you have to truncate your input to find the custom delimiter. That&apos;s not very efficient. Can you change the code back to using the `read()` method? I think we had a misunderstanding.&lt;/p&gt;

&lt;p&gt;    For you test case: It&apos;s not considered good practice to mix production and test code. You&apos;re doing that by introducing the `isRetrying` flag and exposing it. Alternatively, you have two options:&lt;/p&gt;

&lt;p&gt;    1. Create a `ServerSocket` and pass its address to the `SocketTextStreamFunction`. Then control the connection to this socket and count how often the function reconnects (e.g. use the `accept()` method).&lt;br/&gt;
    2. Create your test in the same package as the `SocketTextStreamFunction` function (package is `org.apache.flink.streaming.api.functions.source`). Then you can access all field variables which are protected. So make your `retries` variable a protected field variable of the `SocketTextStreamFunction` class.&lt;/p&gt;

&lt;p&gt;    I hope that this helps you. If not, feel free to ask more questions.&lt;/p&gt;
</comment>
                            <comment id="14694934" author="githubbot" created="Thu, 13 Aug 2015 09:22:29 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r36955189&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r36955189&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -40,10 +37,12 @@&lt;br/&gt;
     	private char delimiter;&lt;br/&gt;
     	private long maxRetry;&lt;br/&gt;
     	private boolean retryForever;&lt;br/&gt;
    +	private boolean isRetrying = false;&lt;br/&gt;
     	private Socket socket;&lt;br/&gt;
     	private static final int CONNECTION_TIMEOUT_TIME = 0;&lt;br/&gt;
     	private static final int CONNECTION_RETRY_SLEEP = 1000;&lt;/p&gt;

&lt;p&gt;    +	private volatile boolean isExit = false;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Is this flag necessary? We have `isRunning` already.&lt;/p&gt;</comment>
                            <comment id="14694935" author="githubbot" created="Thu, 13 Aug 2015 09:22:55 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r36955221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r36955221&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -69,14 +68,14 @@ public void run(SourceContext&amp;lt;String&amp;gt; ctx) throws Exception {&lt;/p&gt;

&lt;p&gt;     	public void streamFromSocket(SourceContext&amp;lt;String&amp;gt; ctx, Socket socket) throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think this method should be private because it is not meant to be used outside this class.&lt;/p&gt;</comment>
                            <comment id="14694936" author="githubbot" created="Thu, 13 Aug 2015 09:23:21 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r36955259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r36955259&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -69,14 +68,14 @@ public void run(SourceContext&amp;lt;String&amp;gt; ctx) throws Exception {&lt;/p&gt;

&lt;p&gt;     	public void streamFromSocket(SourceContext&amp;lt;String&amp;gt; ctx, Socket socket) throws Exception {&lt;br/&gt;
     		try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuffer buffer = new StringBuffer();&lt;br/&gt;
    +			StringBuilder buffer = new StringBuilder();&lt;br/&gt;
     			BufferedReader reader = new BufferedReader(new InputStreamReader(&lt;br/&gt;
     					socket.getInputStream()));&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     			while (isRunning) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int data;&lt;br/&gt;
    +				String data;&lt;br/&gt;
     				try {&lt;/li&gt;
	&lt;li&gt;data = reader.read();&lt;br/&gt;
    +					data = reader.readLine();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Please use `read()` because of the custom delimiter.&lt;/p&gt;</comment>
                            <comment id="14694938" author="githubbot" created="Thu, 13 Aug 2015 09:23:56 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r36955316&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r36955316&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -85,11 +84,12 @@ public void streamFromSocket(SourceContext&amp;lt;String&amp;gt; ctx, Socket socket) throws Ex&lt;br/&gt;
     					}&lt;br/&gt;
     				}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (data == -1) {&lt;br/&gt;
    +				if (data == null) {&lt;br/&gt;
     					socket.close();&lt;br/&gt;
     					long retry = 0;&lt;br/&gt;
     					boolean success = false;&lt;/li&gt;
	&lt;li&gt;while (retry &amp;lt; maxRetry &amp;amp;&amp;amp; !success) {&lt;br/&gt;
    +					while ((retry &amp;lt; maxRetry || (retryForever &amp;amp;&amp;amp; !isExit)) &amp;amp;&amp;amp; !success) {&lt;br/&gt;
    +						isRetrying = true;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This flag is only necessary for your test and thus should be removed.&lt;/p&gt;</comment>
                            <comment id="14694939" author="githubbot" created="Thu, 13 Aug 2015 09:24:09 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r36955334&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r36955334&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -145,4 +152,8 @@ public void cancel() {&lt;br/&gt;
     			}&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public boolean getIsRetrying() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Please remove this getter.&lt;/p&gt;</comment>
                            <comment id="14695069" author="githubbot" created="Thu, 13 Aug 2015 11:20:01 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130626843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130626843&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi Max,&lt;br/&gt;
    I fixed all as your reviews.&lt;br/&gt;
    And I retained the change of StringBuffer to StringBuilder.&lt;br/&gt;
    There is a question that as I see the StringBuilder just do the same thing as StringBuffer currently.&lt;br/&gt;
    So what`s the real different the two type in the SocketTextStreamFunction?&lt;/p&gt;</comment>
                            <comment id="14695133" author="githubbot" created="Thu, 13 Aug 2015 12:10:02 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130644950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130644950&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    `StringBuilder` is only for single-threaded while `StringBuffer` enables multi-thread access. If you use `StringBuffer` in a single-threaded scenario it has worse performance than `StringBuilder`.&lt;/p&gt;

&lt;p&gt;    Thanks for you changes. In addition to the &quot;infinity&quot; test, can you add a test that checks for a certain number of retries (e.g. 10)? Also please add a check for 1 and 0 retries. It&apos;s always good to test corner cases &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14695192" author="githubbot" created="Thu, 13 Aug 2015 13:08:07 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130663511&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130663511&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Ok, I add two cases(retry 10 and 0) since I thought retry 1 time just same as 10.&lt;br/&gt;
    And would you please take a look with another two tests(&lt;a href=&quot;https://github.com/apache/flink/pull/991&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/991&lt;/a&gt;   and  &lt;a href=&quot;https://github.com/apache/flink/pull/977)?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/977)?&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14695196" author="githubbot" created="Thu, 13 Aug 2015 13:12:45 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130664351&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130664351&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    Otherwise, I found the SocketClientSink didn`t have the &quot;retry&quot;.&lt;br/&gt;
    Is it necessary to get a &quot;retry&quot;?&lt;/p&gt;</comment>
                            <comment id="14695210" author="githubbot" created="Thu, 13 Aug 2015 13:27:59 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r36973254&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r36973254&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,169 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retrys &amp;lt; 10);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You&apos;re &quot;busy waiting&quot; here which consumes a lot of CPU. You could check in regular intervals and sleep in between.&lt;/p&gt;</comment>
                            <comment id="14695211" author="githubbot" created="Thu, 13 Aug 2015 13:28:19 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r36973279&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r36973279&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,169 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retrys &amp;lt; 10);&lt;br/&gt;
    +		sleep(10000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You could check again if the retry count increased in the meantime.&lt;/p&gt;</comment>
                            <comment id="14695212" author="githubbot" created="Thu, 13 Aug 2015 13:29:18 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r36973377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r36973377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -43,6 +43,7 @@&lt;br/&gt;
     	private Socket socket;&lt;br/&gt;
     	private static final int CONNECTION_TIMEOUT_TIME = 0;&lt;br/&gt;
     	private static final int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    +	protected long retrys;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Sorry, minor thing but it should be `retries`.&lt;/p&gt;</comment>
                            <comment id="14695213" author="githubbot" created="Thu, 13 Aug 2015 13:30:00 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r36973430&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r36973430&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -43,6 +43,7 @@&lt;br/&gt;
     	private Socket socket;&lt;br/&gt;
     	private static final int CONNECTION_TIMEOUT_TIME = 0;&lt;br/&gt;
     	private static final int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    +	protected long retrys;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You should also initialize the variable with 0 in the `open()` method.&lt;/p&gt;</comment>
                            <comment id="14695215" author="githubbot" created="Thu, 13 Aug 2015 13:32:29 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130672880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130672880&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;gt; Otherwise, I found the SocketClientSink didn`t have the &quot;retry&quot;.&lt;br/&gt;
    Is it necessary to get a &quot;retry&quot;?&lt;/p&gt;

&lt;p&gt;    Yes, that might be an issue but let&apos;s keep it separate from our concern here. If you want, you can open a JIRA issue for the missing retry option in the `SocketClientSink`.&lt;/p&gt;</comment>
                            <comment id="14696283" author="githubbot" created="Fri, 14 Aug 2015 01:13:04 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37042816&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37042816&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -43,6 +43,7 @@&lt;br/&gt;
     	private Socket socket;&lt;br/&gt;
     	private static final int CONNECTION_TIMEOUT_TIME = 0;&lt;br/&gt;
     	private static final int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    +	protected long retrys;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    ....&lt;br/&gt;
    Sorry for my English. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14696610" author="githubbot" created="Fri, 14 Aug 2015 07:04:59 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-130999638&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-130999638&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi , I did a new change.&lt;/p&gt;</comment>
                            <comment id="14704711" author="githubbot" created="Thu, 20 Aug 2015 11:33:54 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-132982117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-132982117&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi Max,&lt;br/&gt;
    I am very sorry to bothered you.&lt;br/&gt;
    I fixed some of my PRs and was waiting for your reply for days.&lt;br/&gt;
    Otherwise, as your advice, I added a change about the sink retry and take tests for it.&lt;br/&gt;
    I would be very honored if you can spend a little time to take a look about these PRs.&lt;br/&gt;
    Thank you!&lt;/p&gt;
</comment>
                            <comment id="14704824" author="githubbot" created="Thu, 20 Aug 2015 12:57:02 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-132999197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-132999197&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @HuangWHWHW, Max is currently on vacations. He&apos;ll be back next week. I&apos;m sure that he&apos;ll get back to you then &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14706064" author="githubbot" created="Fri, 21 Aug 2015 01:29:09 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-133238272&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-133238272&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tillrohrmann &lt;br/&gt;
    Thank you for the info &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14709247" author="githubbot" created="Mon, 24 Aug 2015 13:11:55 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37748808&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37748808&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,176 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10)&lt;/p&gt;
{
    +			long lastRetry = source.socketSource.retries;
    +			sleep(10000);
    +			assertTrue(source.socketSource.retries &amp;gt; lastRetry);
    +		}
&lt;p&gt;;&lt;br/&gt;
    +		assertEquals(10, source.socketSource.retries);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(10, source.socketSource.retries);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceNeverRetry() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 0);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		sleep(10000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Did you have to add the sleep here to make the test pass? 10 seconds is quite long.&lt;/p&gt;</comment>
                            <comment id="14709248" author="githubbot" created="Mon, 24 Aug 2015 13:12:18 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37748844&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37748844&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,176 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(10000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Did you have to add the sleep here to make the test pass? 10 seconds is quite long.&lt;/p&gt;</comment>
                            <comment id="14709249" author="githubbot" created="Mon, 24 Aug 2015 13:12:34 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37748868&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37748868&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,176 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Did you have to add the sleep here to make the test pass? 10 seconds is quite long.&lt;/p&gt;</comment>
                            <comment id="14709257" author="githubbot" created="Mon, 24 Aug 2015 13:17:39 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37749287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37749287&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,176 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(10000);&lt;br/&gt;
    +			assertTrue(source.socketSource.retries &amp;gt; lastRetry);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Could you change this to `assertEquals(lastRetry+1, source.socketSource.retries)`?&lt;/p&gt;</comment>
                            <comment id="14709266" author="githubbot" created="Mon, 24 Aug 2015 13:20:52 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37749598&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37749598&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,176 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(10000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You might want to decrease the sleep time and do an `assertTrue(source.socketSource.retries &amp;gt;= lastRetry)`.&lt;/p&gt;</comment>
                            <comment id="14709269" author="githubbot" created="Mon, 24 Aug 2015 13:22:29 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-134199343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-134199343&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @HuangWHWHW Sorry for keeping you waiting. I&apos;ve made some more comments. Otherwise, I think this looks ready to be merged.&lt;/p&gt;</comment>
                            <comment id="14709434" author="githubbot" created="Mon, 24 Aug 2015 15:14:45 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37762121&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37762121&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,176 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) {&lt;br/&gt;
    +			Throwable t = error.get();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You should clear the error for subsequent test cases.&lt;/p&gt;</comment>
                            <comment id="14710678" author="githubbot" created="Tue, 25 Aug 2015 06:22:39 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-134493928&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-134493928&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    It doesn`t matter.&lt;br/&gt;
    I`ll take a new change.&lt;/p&gt;</comment>
                            <comment id="14710867" author="githubbot" created="Tue, 25 Aug 2015 08:28:04 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37843364&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37843364&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,176 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(10000);&lt;br/&gt;
    +			assertTrue(source.socketSource.retries &amp;gt; lastRetry);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Changing to assertEquals(lastRetry+1, source.socketSource.retries) may be some difficult.&lt;br/&gt;
    It`s hard to control the real value of source.socketSource.retries.&lt;/p&gt;</comment>
                            <comment id="14710895" author="githubbot" created="Tue, 25 Aug 2015 08:38:54 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37844142&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37844142&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,176 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(10000);&lt;br/&gt;
    +			assertTrue(source.socketSource.retries &amp;gt; lastRetry);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes, exactly. Please see my previous edit.&lt;/p&gt;</comment>
                            <comment id="14710906" author="githubbot" created="Tue, 25 Aug 2015 08:46:52 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-134526309&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-134526309&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi, I take a new change that decrease the sleep time and clear the error for each test cases.&lt;br/&gt;
    But I have no idea to control the value of retry to increase.&lt;/p&gt;</comment>
                            <comment id="14710917" author="githubbot" created="Tue, 25 Aug 2015 08:55:09 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37845490&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37845490&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,176 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +		}
&lt;p&gt;    +		sleep(10000);&lt;br/&gt;
    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(10000);&lt;br/&gt;
    +			assertTrue(source.socketSource.retries &amp;gt; lastRetry);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Ok, add a &quot;assert&quot; in testSocketSourceRetryForever.&lt;/p&gt;</comment>
                            <comment id="14711140" author="githubbot" created="Tue, 25 Aug 2015 12:00:39 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37856724&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37856724&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,179 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +			assertEquals(0, source.socketSource.retries);
    +		}
&lt;p&gt;    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think you can decrease the waiting time even further to 100 ms. Otherwise, the test case will take 10 seconds which is quite long for one test case.&lt;/p&gt;</comment>
                            <comment id="14711165" author="githubbot" created="Tue, 25 Aug 2015 12:18:34 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-134567337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-134567337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks good to merge if we further adjust the waiting time of the tests.&lt;/p&gt;</comment>
                            <comment id="14711172" author="githubbot" created="Tue, 25 Aug 2015 12:19:49 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37858063&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37858063&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,179 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +			assertEquals(0, source.socketSource.retries);
    +		}
&lt;p&gt;    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    So, may be I can decrease the retry times to 2?&lt;br/&gt;
    The 10 seconds is because of the &quot;Thread.sleep(CONNECTION_RETRY_SLEEP);&quot; in SocketTextStreamFunction.java.&lt;/p&gt;</comment>
                            <comment id="14711183" author="githubbot" created="Tue, 25 Aug 2015 12:29:08 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-134570319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-134570319&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi, I decreased both the waiting time and the retry times since it will still cost over 10 seconds if only the waiting time is decreased due to the &quot;Thread.sleep(CONNECTION_RETRY_SLEEP);&quot;.&lt;/p&gt;</comment>
                            <comment id="14711187" author="githubbot" created="Tue, 25 Aug 2015 12:32:48 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37859069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37859069&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,179 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +			assertEquals(0, source.socketSource.retries);
    +		}
&lt;p&gt;    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You might want to remove the private modifier from `CONNECTION_RETRY_SLEEP` and change it in the test.&lt;/p&gt;</comment>
                            <comment id="14711206" author="githubbot" created="Tue, 25 Aug 2015 12:50:17 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37860526&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37860526&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,179 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +			assertEquals(0, source.socketSource.retries);
    +		}
&lt;p&gt;    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You mean that change the &quot;private static final int CONNECTION_RETRY_SLEEP = 1000;&#8220; in my test?&lt;br/&gt;
    But how to do it?&lt;/p&gt;</comment>
                            <comment id="14711213" author="githubbot" created="Tue, 25 Aug 2015 12:53:33 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37860800&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37860800&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,179 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +			assertEquals(0, source.socketSource.retries);
    +		}
&lt;p&gt;    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Or take a forever change:&lt;br/&gt;
    Thread.sleep(CONNECTION_RETRY_SLEEP); to &lt;br/&gt;
    synchronized (lock)&lt;/p&gt;
{
    lock.wait(CONNECTION_RETRY_SLEEP);
    }
&lt;p&gt;    ?&lt;/p&gt;</comment>
                            <comment id="14711216" author="githubbot" created="Tue, 25 Aug 2015 12:54:51 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37860912&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37860912&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,179 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +			assertEquals(0, source.socketSource.retries);
    +		}
&lt;p&gt;    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Remove the private modifier in `SocketTextStreamFunction`: `static final int CONNECTION_RETRY_SLEEP = 1000;`. That way, the variable can be changed by other classes within the same Java package. In your test, set the sleep interval using e.g. `SocketTextStreamFunction.CONNECTION_RETRY_SLEEP = 200`.&lt;/p&gt;</comment>
                            <comment id="14711225" author="githubbot" created="Tue, 25 Aug 2015 13:04:57 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37861790&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37861790&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,179 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +			assertEquals(0, source.socketSource.retries);
    +		}
&lt;p&gt;    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Ah, I see.&lt;/p&gt;</comment>
                            <comment id="14711257" author="githubbot" created="Tue, 25 Aug 2015 13:28:54 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37864215&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37864215&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,179 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) &lt;/p&gt;
{
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				this.socketSource.open(new Configuration());
    +				this.socketSource.run(ctx);
    +			}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
    +				error.set(e);
    +			}
&lt;p&gt;    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void cancel()&lt;/p&gt;
{
    +			this.socketSource.cancel();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSocketSourceRetryForever() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, -1);&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		int count = 0;&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		while (count &amp;lt; 100) &lt;/p&gt;
{
    +			channel = serverSo.accept();
    +			count++;
    +			channel.close();
    +			assertEquals(0, source.socketSource.retries);
    +		}
&lt;p&gt;    +		source.cancel();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (error.get() != null) &lt;/p&gt;
{
    +			Throwable t = error.get();
    +			t.printStackTrace();
    +			fail(&quot;Error in spawned thread: &quot; + t.getMessage());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		assertEquals(100, count);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	 public void testSocketSourceRetryTenTimes() throws Exception{&lt;br/&gt;
    +		error.set(null);&lt;br/&gt;
    +		ServerSocket serverSo = new ServerSocket(0);&lt;br/&gt;
    +		SocketSource source = new SocketSource(serverSo, 10);&lt;br/&gt;
    +&lt;br/&gt;
    +		assertEquals(0, source.socketSource.retries);&lt;br/&gt;
    +&lt;br/&gt;
    +		source.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		Socket channel;&lt;br/&gt;
    +		channel = serverSo.accept();&lt;br/&gt;
    +		channel.close();&lt;br/&gt;
    +		serverSo.close();&lt;br/&gt;
    +		while(source.socketSource.retries &amp;lt; 10){&lt;br/&gt;
    +			long lastRetry = source.socketSource.retries;&lt;br/&gt;
    +			sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Hi, I changed it in my new commit.&lt;/p&gt;</comment>
                            <comment id="14711439" author="githubbot" created="Tue, 25 Aug 2015 15:29:13 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37879401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37879401&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -42,11 +42,13 @@&lt;br/&gt;
     	private boolean retryForever;&lt;br/&gt;
     	private Socket socket;&lt;br/&gt;
     	private static final int CONNECTION_TIMEOUT_TIME = 0;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    +	public static int CONNECTION_RETRY_SLEEP = 1000;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This shouldn&apos;t be modifiable by everyone. Please make it just package-visible by removing the `public` modifier. Also, please keep the `final` modifier because the current implementation just lets the number of retries be configurable with a fixed 1 second retry rate. This is also documented in the user-facing API methods on DataStream.&lt;/p&gt;</comment>
                            <comment id="14712278" author="githubbot" created="Wed, 26 Aug 2015 00:57:40 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37937505&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37937505&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -42,11 +42,13 @@&lt;br/&gt;
     	private boolean retryForever;&lt;br/&gt;
     	private Socket socket;&lt;br/&gt;
     	private static final int CONNECTION_TIMEOUT_TIME = 0;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    +	public static int CONNECTION_RETRY_SLEEP = 1000;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    But if I add the final, it will be a error in my test:&lt;br/&gt;
    Cannot assign a value to final variable &quot;CONNECTION_RETRY_SLEEP&quot;.&lt;/p&gt;
</comment>
                            <comment id="14712385" author="githubbot" created="Wed, 26 Aug 2015 02:37:11 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-134797100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-134797100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    Hi,I chage the CONNECTION_RETRY_SLEEP to static final int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    But I have no idea to straightly changing the CONNECTION_RETRY_SLEEP in my test using:&lt;br/&gt;
    SocketTextStreamFunction.CONNECTION_RETRY_SLEEP = 200.&lt;br/&gt;
    So, I add a reflection mechanism to resolve this.&lt;br/&gt;
    And now the CONNECTION_RETRY_SLEEP changes to 200 in my test.&lt;br/&gt;
    Would you please to take a look whether it is correct?&lt;/p&gt;</comment>
                            <comment id="14712723" author="githubbot" created="Wed, 26 Aug 2015 08:50:43 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37959211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37959211&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -42,11 +42,13 @@&lt;br/&gt;
     	private boolean retryForever;&lt;br/&gt;
     	private Socket socket;&lt;br/&gt;
     	private static final int CONNECTION_TIMEOUT_TIME = 0;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    +	public static int CONNECTION_RETRY_SLEEP = 1000;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Ok no problem. Then make the variable non-final but don&apos;t expose it. So just have it `static int CONNECTION_RETRY_SLEEP = 1000`.&lt;/p&gt;</comment>
                            <comment id="14712731" author="githubbot" created="Wed, 26 Aug 2015 08:52:26 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37959366&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37959366&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,189 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.lang.reflect.Field;&lt;br/&gt;
    +import java.lang.reflect.Modifier;&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) throws Exception {&lt;br/&gt;
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);&lt;br/&gt;
    +&lt;br/&gt;
    +			Field field = SocketTextStreamFunction.class.getDeclaredField(&quot;CONNECTION_RETRY_SLEEP&quot;);&lt;br/&gt;
    +			field.setAccessible(true);&lt;br/&gt;
    +			Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);&lt;br/&gt;
    +			modifiersField.setAccessible(true);&lt;br/&gt;
    +			modifiersField.setInt(field, field.getModifiers() &amp;amp; ~Modifier.FINAL);&lt;br/&gt;
    +			field.set(null, 200);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    That&apos;s quite a hack. I think it is ok to remove the `final` modifier and make the field variable package-local: `static int CONNECTION_RETRY_SLEEP = 1000`. Then you can set it directly here. &lt;/p&gt;</comment>
                            <comment id="14712736" author="githubbot" created="Wed, 26 Aug 2015 08:54:46 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-134902558&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-134902558&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @HuangWHWHW Thanks for your changes. Adding reflection calls to the testing codes is not good practice and makes the code hard to maintain.&lt;/p&gt;</comment>
                            <comment id="14712828" author="githubbot" created="Wed, 26 Aug 2015 09:40:35 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r37963338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r37963338&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,189 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.lang.reflect.Field;&lt;br/&gt;
    +import java.lang.reflect.Modifier;&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    +		public String result;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collect(String element) &lt;/p&gt;
{
    +			result = element;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String toString() &lt;/p&gt;
{
    +			return this.result;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void collectWithTimestamp(String element, long timestamp) &lt;/p&gt;
{
    +
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void emitWatermark(Watermark mark) {    +    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Object getCheckpointLock() &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() &lt;/p&gt;
{
    +
    +		}
&lt;p&gt;    +	};&lt;br/&gt;
    +&lt;br/&gt;
    +	public SocketTextStreamFunctionTest() &lt;/p&gt;
{
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	class SocketSource extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		SocketTextStreamFunction socketSource;&lt;br/&gt;
    +&lt;br/&gt;
    +		public SocketSource(ServerSocket serverSo, int maxRetry) throws Exception {&lt;br/&gt;
    +			this.socketSource =  new SocketTextStreamFunction(host, serverSo.getLocalPort(), &apos;\n&apos;, maxRetry);&lt;br/&gt;
    +&lt;br/&gt;
    +			Field field = SocketTextStreamFunction.class.getDeclaredField(&quot;CONNECTION_RETRY_SLEEP&quot;);&lt;br/&gt;
    +			field.setAccessible(true);&lt;br/&gt;
    +			Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);&lt;br/&gt;
    +			modifiersField.setAccessible(true);&lt;br/&gt;
    +			modifiersField.setInt(field, field.getModifiers() &amp;amp; ~Modifier.FINAL);&lt;br/&gt;
    +			field.set(null, 200);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    ...&lt;br/&gt;
    Sorry for that.&lt;br/&gt;
    I changed this in my new one.&lt;/p&gt;</comment>
                            <comment id="14715971" author="githubbot" created="Thu, 27 Aug 2015 02:40:01 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-135262313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-135262313&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi,@mxm&lt;br/&gt;
    any new comment?&lt;/p&gt;</comment>
                            <comment id="14716317" author="githubbot" created="Thu, 27 Aug 2015 09:05:13 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-135351424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-135351424&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    While merging your pull request I noticed that the `SocketTextStreamFunction` actually does not wait the time specified in `CONNCTION_RETRY_SLEEP` but immediately tries to reconnect in case of an EOF. It only waits in case of a `ConnectionError`. I&apos;m not sure whether this behavior is desired but this should also be reflected in your test cases. Could you add a test case where you first pass a Socket with an EOF and then let an `ConnectionError` occur?&lt;/p&gt;</comment>
                            <comment id="14716622" author="githubbot" created="Thu, 27 Aug 2015 13:08:58 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-135419765&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-135419765&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    Hi, &lt;br/&gt;
    my test just do the same thing that first pass the Socket&lt;br/&gt;
    when it calls SocketTextStreamFunction.open.&lt;br/&gt;
    Then close the Socket that means send nothing(EOF) to the SocketTextStreamFunction.&lt;br/&gt;
    And after this it will retry.&lt;br/&gt;
    And first time the retry happens immediately since SocketTextStreamFunction receives the end of the sent message.&lt;br/&gt;
    Then it will get retry second, third... times since I do not open the socket which means a ConnectionError occur.&lt;br/&gt;
    So can you describe more in detail?&lt;br/&gt;
    Thank you.&lt;/p&gt;</comment>
                            <comment id="14716661" author="githubbot" created="Thu, 27 Aug 2015 13:33:29 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-135429969&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-135429969&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    Hi,&lt;br/&gt;
    I add a test that first send a message to the SocketTextStreamFunction and this is success.&lt;br/&gt;
    Then I close the server let the SocketTextStreamFunction retry.&lt;br/&gt;
    Is it you need?&lt;/p&gt;</comment>
                            <comment id="14716666" author="githubbot" created="Thu, 27 Aug 2015 13:36:31 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-135431535&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-135431535&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    BTW:Could you help me to take a look of this CI:&lt;a href=&quot;https://github.com/apache/flink/pull/1030?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1030?&lt;/a&gt;&lt;br/&gt;
    Since I still can not watch the CI details currently.&lt;br/&gt;
    Thank you very much!&lt;/p&gt;</comment>
                            <comment id="14723065" author="githubbot" created="Mon, 31 Aug 2015 07:16:48 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-136285250&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-136285250&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm&lt;br/&gt;
    Hi, max.&lt;br/&gt;
    Any comment about my new changes?&lt;/p&gt;</comment>
                            <comment id="14725242" author="githubbot" created="Tue, 1 Sep 2015 11:39:52 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r38409485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r38409485&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -42,11 +42,13 @@&lt;br/&gt;
     	private boolean retryForever;&lt;br/&gt;
     	private Socket socket;&lt;br/&gt;
     	private static final int CONNECTION_TIMEOUT_TIME = 0;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    +	static int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    +	protected long retries;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	private volatile boolean isRunning;&lt;/p&gt;

&lt;p&gt;     	public SocketTextStreamFunction(String hostname, int port, char delimiter, long maxRetry) {&lt;br/&gt;
    +		this.retries = 0;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Initialization to `0` is not needed.&lt;/p&gt;</comment>
                            <comment id="14725336" author="githubbot" created="Tue, 1 Sep 2015 12:48:37 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r38414236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r38414236&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/main/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunction.java &amp;#8212;&lt;br/&gt;
    @@ -42,11 +42,13 @@&lt;br/&gt;
     	private boolean retryForever;&lt;br/&gt;
     	private Socket socket;&lt;br/&gt;
     	private static final int CONNECTION_TIMEOUT_TIME = 0;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    +	static int CONNECTION_RETRY_SLEEP = 1000;&lt;br/&gt;
    +	protected long retries;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	private volatile boolean isRunning;&lt;/p&gt;

&lt;p&gt;     	public SocketTextStreamFunction(String hostname, int port, char delimiter, long maxRetry) {&lt;br/&gt;
    +		this.retries = 0;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Hi,&lt;br/&gt;
    I removed this in my new commit.&lt;br/&gt;
    Otherwise why doesn`t the CI run?&lt;br/&gt;
    This happen in all of my new commits.&lt;/p&gt;</comment>
                            <comment id="14725469" author="githubbot" created="Tue, 1 Sep 2015 14:25:38 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-136739055&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-136739055&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I am not sure why the CI is not retesting this.&lt;/p&gt;

&lt;p&gt;    Can you try to squash your commits into one commit and force-push this branch? This always triggers CI for me...&lt;/p&gt;</comment>
                            <comment id="14725520" author="githubbot" created="Tue, 1 Sep 2015 15:06:45 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-136754340&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-136754340&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @HuangWHWHW Thank you for addressing my comments. Could you please squash your commits and force push to this branch again?&lt;/p&gt;</comment>
                            <comment id="14726554" author="githubbot" created="Wed, 2 Sep 2015 01:31:06 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-136910004&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-136910004&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm @StephanEwen &lt;br/&gt;
    Hi, I just update one commit yesterday.&lt;br/&gt;
    And I found that a few PRs got the same trouble yesterday.&lt;br/&gt;
    Is there any issue in CI?&lt;/p&gt;</comment>
                            <comment id="14728655" author="githubbot" created="Thu, 3 Sep 2015 08:06:11 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-137372443&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-137372443&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think there is an issue with Travis at the moment. Could you force push to this branch again?&lt;/p&gt;</comment>
                            <comment id="14730857" author="githubbot" created="Fri, 4 Sep 2015 14:00:59 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-137745160&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-137745160&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm&lt;br/&gt;
    Ok, I make the CI rerun.&lt;br/&gt;
    Any new comment?&lt;/p&gt;</comment>
                            <comment id="14733535" author="githubbot" created="Mon, 7 Sep 2015 10:48:56 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-138268476&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-138268476&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm &lt;br/&gt;
    @StephanEwen &lt;br/&gt;
    Hi, very sorry for bothering.&lt;br/&gt;
    I got the CI passed.&lt;br/&gt;
    Is there any new comment or this can be merged?&lt;/p&gt;
</comment>
                            <comment id="14734474" author="githubbot" created="Tue, 8 Sep 2015 09:11:17 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r38904579&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r38904579&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,216 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.DataOutputStream;&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Could you replace this with a simple Mock using Mockito? &lt;/p&gt;</comment>
                            <comment id="14734508" author="githubbot" created="Tue, 8 Sep 2015 09:29:46 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r38906129&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r38906129&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,216 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.DataOutputStream;&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The ctx is used to get the received msg from socket server.&lt;br/&gt;
    So I override the toString() method in ctx.&lt;br/&gt;
    I think it will be invalid if we use mockito to check the received msg is correct.&lt;br/&gt;
    Or is it unnecessary to check the msg since this test is for the retry times?&lt;/p&gt;</comment>
                            <comment id="14734559" author="githubbot" created="Tue, 8 Sep 2015 10:09:33 +0000"  >&lt;p&gt;Github user mxm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#discussion_r38909392&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#discussion_r38909392&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-staging/flink-streaming/flink-streaming-core/src/test/java/org/apache/flink/streaming/api/functions/source/SocketTextStreamFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,216 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.DataOutputStream;&lt;br/&gt;
    +import java.net.Socket;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.lang.Thread.sleep;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.net.ServerSocket;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for the &lt;/p&gt;
{@link org.apache.flink.streaming.api.functions.source.SocketTextStreamFunction}
&lt;p&gt;.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class SocketTextStreamFunctionTest{&lt;br/&gt;
    +&lt;br/&gt;
    +	final AtomicReference&amp;lt;Throwable&amp;gt; error = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;br/&gt;
    +	private final String host = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +	SourceFunction.SourceContext&amp;lt;String&amp;gt; ctx = new SourceFunction.SourceContext&amp;lt;String&amp;gt;() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You&apos;re right, you need to capture the input to the collect method. How about using an `ArgumentCaptor`? &lt;a href=&quot;http://mockito.googlecode.com/svn/tags/1.8.0/javadoc/org/mockito/ArgumentCaptor.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mockito.googlecode.com/svn/tags/1.8.0/javadoc/org/mockito/ArgumentCaptor.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14734628" author="githubbot" created="Tue, 8 Sep 2015 11:04:44 +0000"  >&lt;p&gt;Github user HuangWHWHW commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-138518846&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-138518846&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @mxm&lt;br/&gt;
    Hi, I added the ArgumentCaptor to the test and removed the unwanted code.&lt;/p&gt;</comment>
                            <comment id="14735041" author="githubbot" created="Tue, 8 Sep 2015 15:58:33 +0000"  >&lt;p&gt;Github user mxm commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992#issuecomment-138608134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992#issuecomment-138608134&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Nice &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Merging...&lt;/p&gt;</comment>
                            <comment id="14735050" author="githubbot" created="Tue, 8 Sep 2015 16:02:59 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/992&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14735051" author="mxm" created="Tue, 8 Sep 2015 16:03:07 +0000"  >&lt;p&gt;Fixed via 1800434.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2iepb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>