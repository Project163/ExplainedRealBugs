<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:52:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19970] State leak in CEP Operators (expired events/keys not removed from state)</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19970</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We have been observing instability in our production environment recently, seemingly related to state backends. We ended up building a load testing environment to isolate factors and have discovered that the CEP library appears to have some serious problems with state expiry.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;JobTopology&quot;&gt;&lt;/a&gt;Job Topology&lt;/h2&gt;

&lt;p&gt;Source: Kinesis (standard connector) -&amp;gt; keyBy() and forward to...&lt;br/&gt;
CEP: Array of simple Keyed CEP Pattern operators (details below) -&amp;gt; forward output to...&lt;br/&gt;
Sink: SQS (custom connector)&lt;/p&gt;

&lt;p&gt;The CEP Patterns in the test look like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Pattern.begin(SCANS_SEQUENCE, AfterMatchSkipStrategy.skipPastLastEvent())
    .times(20)
    .subtype(ScanEvent.class)
    .within(Duration.minutes(30));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h2&gt;&lt;a name=&quot;TaskmanagerConfig&quot;&gt;&lt;/a&gt;Taskmanager Config&lt;/h2&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
taskmanager.numberOfTaskSlots: $numberOfTaskSlots
taskmanager.data.port: 6121
taskmanager.rpc.port: 6122
taskmanager.exit-on-fatal-akka-error: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
taskmanager.memory.process.size: $memoryProcessSize
taskmanager.memory.jvm-metaspace.size: 256m
taskmanager.memory.managed.size: 0m
jobmanager.rpc.port: 6123
blob.server.port: 6130
&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.port: 8081
web.submit.enable: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
fs.s3a.connection.maximum: 50
fs.s3a.threads.max: 50
akka.framesize: 250m
akka.watch.threshold: 14

state.checkpoints.dir: s3:&lt;span class=&quot;code-comment&quot;&gt;//$savepointBucketName/checkpoints
&lt;/span&gt;state.savepoints.dir: s3:&lt;span class=&quot;code-comment&quot;&gt;//$savepointBucketName/savepoints
&lt;/span&gt;state.backend: filesystem
state.backend.async: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;

s3.access-key: $s3AccessKey
s3.secret-key: $s3SecretKey
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(the substitutions are controlled by terraform).&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Tests&quot;&gt;&lt;/a&gt;Tests&lt;/h2&gt;

&lt;h4&gt;&lt;a name=&quot;Test1%28Nokeyrotation%29&quot;&gt;&lt;/a&gt;Test 1 (No key rotation)&lt;/h4&gt;
&lt;p&gt;8192 actors (different keys) emitting 1 Scan Event every 10 minutes indefinitely. Actors (keys) never rotate in or out.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Test2%28Constantkeyrotation%29&quot;&gt;&lt;/a&gt;Test 2 (Constant key rotation)&lt;/h4&gt;
&lt;p&gt;8192 actors that produce 2 Scan events 10 minutes apart, then retire and never emit again. The setup creates new actors (keys) as soon as one finishes so we always have 8192. This test basically constantly rotates the key space.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Results&quot;&gt;&lt;/a&gt;Results&lt;/h2&gt;

&lt;p&gt;For both tests, the state size (checkpoint size) grows unbounded and linearly well past the 30 minute threshold that should have caused old keys or events to be discard from the state. In the chart below, the left (steep) half is the 24 hours we ran Test 1, the right (shallow) half is Test 2.  My understanding is that the checkpoint size should level off after ~45 minutes or so then stay constant.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13014703/13014703_image-2020-11-04-11-35-12-126.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;Could someone please assist us with this? Unless we have dramatically misunderstood how the CEP library is supposed to function this seems like a pretty severe bug.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Flink 1.11.2 run using the official docker containers in AWS ECS Fargate.&lt;/p&gt;

&lt;p&gt;1 Job Manager, 1 Taskmanager with 2vCPUs and 8GB memory&lt;/p&gt;</environment>
        <key id="13338818">FLINK-19970</key>
            <summary>State leak in CEP Operators (expired events/keys not removed from state)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dwysakowicz">Dawid Wysakowicz</assignee>
                                    <reporter username="Jamalarm">Thomas Wozniakowski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 4 Nov 2020 11:38:32 +0000</created>
                <updated>Wed, 24 Feb 2021 10:30:19 +0000</updated>
                            <resolved>Wed, 24 Feb 2021 10:30:19 +0000</resolved>
                                    <version>1.11.2</version>
                                    <fixVersion>1.13.0</fixVersion>
                                    <component>Library / CEP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17226012" author="dawidwys" created="Wed, 4 Nov 2020 12:00:27 +0000"  >&lt;p&gt;Do you look for patterns in event or processing time? If it is in event time, what is your Watermark strategy? The incoming elements are buffered for sorting until an appropriate Watermark comes in. The &lt;tt&gt;within&lt;/tt&gt; timeour is applied only after the events were sorted.&lt;/p&gt;</comment>
                            <comment id="17226022" author="jamalarm" created="Wed, 4 Nov 2020 12:34:44 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Sorry for not including that info in the original post.&lt;/p&gt;

&lt;p&gt;We are using event time with a custom watermarking strategy based on an average of the last 10 events&apos; timestamps + a  constant buffer of 15 minutes.&lt;/p&gt;

&lt;p&gt;The watermarking strategy is working just fine. Test #2 is actually still running and I can see the Low Watermark of the CEP operators is 1604492129185 (15 minutes ago) as expected.&lt;/p&gt;

&lt;p&gt;Note that this setup is also producing matches just fine (with increased frequency of event emission). If the watermarks weren&apos;t being correctly assigned then we would never see matches coming out the other end of the CEP operators, right?&lt;/p&gt;</comment>
                            <comment id="17226026" author="dawidwys" created="Wed, 4 Nov 2020 12:39:38 +0000"  >&lt;p&gt;Yes, you are right watermarking would affect the matches as well.&lt;/p&gt;</comment>
                            <comment id="17227329" author="jamalarm" created="Fri, 6 Nov 2020 11:01:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; Please give me a shout if there&apos;s any more diagnostic info I can attach to assist with debugging this. This one is blocking us quite severely so I&apos;m more than happy to help any way I can.&lt;/p&gt;</comment>
                            <comment id="17232849" author="dawidwys" created="Mon, 16 Nov 2020 15:55:03 +0000"  >&lt;p&gt;Sorry for not getting back earlier. I did some experiments and I was able to replicate the problem. Unfortunately, 1) I don&apos;t have a solution yet 2) because we are late in the 1.12 release cycle it won&apos;t make it into 1.12.0. I will get back to the problem once we are done with the 1.12.&lt;/p&gt;</comment>
                            <comment id="17232913" author="jamalarm" created="Mon, 16 Nov 2020 17:05:46 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; - thanks for the update. Please let us know if there&apos;s anything we can do to help.&lt;/p&gt;

&lt;p&gt;Happy to test out a branch version of Flink in our load test environment when it is available. The only issue is that we use the docker images so I&apos;d need some way to build a branch docker image.&lt;/p&gt;</comment>
                            <comment id="17241426" author="wind_ljy" created="Tue, 1 Dec 2020 10:32:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jamalarm&quot; class=&quot;user-hover&quot; rel=&quot;Jamalarm&quot;&gt;Jamalarm&lt;/a&gt;&#160; Do you figure out the root cause of the state leak?&#160; &#160;Maybe I can spare some time to look into this problem because we&apos;re also using CEP on production and this is actually very severe from our side.&lt;/p&gt;</comment>
                            <comment id="17241445" author="jamalarm" created="Tue, 1 Dec 2020 11:03:03 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;No, we didn&apos;t identify a fix. We&apos;re not really familiar with the Flink codebase and our team is pretty small, so our plan was to wait until &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; was finished with the 1.12.0 release and had some time to look at the issue.&lt;/p&gt;

&lt;p&gt;We would obviously be very grateful if you were able to spare some time to dig into this. Our production system is effectively a ticking time bomb at the moment with this issue.&lt;/p&gt;</comment>
                            <comment id="17242420" author="dawidwys" created="Wed, 2 Dec 2020 15:08:41 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jamalarm&quot; class=&quot;user-hover&quot; rel=&quot;Jamalarm&quot;&gt;Jamalarm&lt;/a&gt;,&lt;br/&gt;
I worked a little bit on the issue. I prepared a first approach for fixing the issue. I&apos;d appreciate if you could test it out. You can find it in my branch here: &lt;a href=&quot;https://github.com/dawidwys/flink/tree/flink-19970&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dawidwys/flink/tree/flink-19970&lt;/a&gt; Only the last commit is relevant. You should also be able to cherry-pick it on flink 1.11 if you cannot run your tests on flink 1.12.&lt;/p&gt;

&lt;p&gt;Unfortunately it requires changes in the state format, thus it is not ready to create a PR for the master. It would be nice though if you could verify that my suspicion for the cause is correct.&lt;/p&gt;</comment>
                            <comment id="17242433" author="jamalarm" created="Wed, 2 Dec 2020 15:20:02 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; - great to hear you have a candidate fix!&lt;/p&gt;

&lt;p&gt;In order for us to test it I would need to package your branch as a docker container. Our load testing environment runs exclusively on containers and it would be... a profound headache to try and make it run any other way.&lt;/p&gt;

&lt;p&gt;We can publish it to an internal ECR repo on our side, that shouldn&apos;t be too hard. Is there a relatively straightforward way to check your branch out and package it up as an image locally?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="17242437" author="dawidwys" created="Wed, 2 Dec 2020 15:24:46 +0000"  >&lt;p&gt;I think it should be rather easy to use this script (&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-end-to-end-tests/test-scripts/common_docker.sh&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-end-to-end-tests/test-scripts/common_docker.sh&lt;/a&gt;) from our e2e setup to create a docker image from a local build.&lt;/p&gt;</comment>
                            <comment id="17242459" author="jamalarm" created="Wed, 2 Dec 2020 15:53:42 +0000"  >&lt;p&gt;Do I need to rebuild our Job JAR using the CEP library from your branch? Or is this a TaskManager-side fix?&lt;/p&gt;</comment>
                            <comment id="17242463" author="dawidwys" created="Wed, 2 Dec 2020 15:58:18 +0000"  >&lt;p&gt;Yeah, you&apos;re actually right. It&apos;s enough to build only the CEP library from my branch and submit it with the job jar.&lt;/p&gt;</comment>
                            <comment id="17242478" author="jamalarm" created="Wed, 2 Dec 2020 16:18:11 +0000"  >&lt;p&gt;For some reason I can&apos;t compile your branch, I get:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[ERROR] COMPILATION ERROR : 
[INFO] -------------------------------------------------------------
[ERROR] /home/jamalarm/src/open/flink/flink-libraries/flink-cep/src/test/java/org/apache/flink/cep/nfa/NFAITCase.java:[39,19] &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; javafx.util does not exist
[INFO] 1 error
[INFO] -------------------------------------------------------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Any ideas?&lt;/p&gt;</comment>
                            <comment id="17242502" author="dawidwys" created="Wed, 2 Dec 2020 16:41:59 +0000"  >&lt;p&gt;Sorry, my bad. Please try again.&lt;/p&gt;</comment>
                            <comment id="17242914" author="wind_ljy" created="Thu, 3 Dec 2020 05:02:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;&#160;Does this bug affect all the patterns&#65311;&lt;/p&gt;</comment>
                            <comment id="17243202" author="jamalarm" created="Thu, 3 Dec 2020 14:11:24 +0000"  >&lt;p&gt;Ok, our load test is running now after a surprisingly painful setup process importing branch code. I&apos;m re-running scenario #1 above and will post the results after a few hours (it should be clear if the problem is fixed)&lt;/p&gt;</comment>
                            <comment id="17243327" author="jamalarm" created="Thu, 3 Dec 2020 16:37:58 +0000"  >&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13016430/13016430_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;Unfortunately it doesn&apos;t appear to have stopped the state leak. I haven&apos;t let the test run for the full period but you can see the size continue to grow past the 30-45 minute mark where it should start discarding events. I&apos;ll keep it running for the full 24 to be representative but I think we might need to keep digging.&lt;/p&gt;</comment>
                            <comment id="17243915" author="jamalarm" created="Fri, 4 Dec 2020 10:13:38 +0000"  >&lt;p&gt;Results over a longer period, state still growing linearly:&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13016487/13016487_screenshot-2.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17244007" author="dawidwys" created="Fri, 4 Dec 2020 13:32:12 +0000"  >&lt;p&gt;Could you please double check that you&apos;ve run my branch? If you are confident that you run my branch, I would need a program that I can run locally that can help me reproduce the problem. I&apos;ve tried preparing one myself, but I cannot reproduce the state leak with the fix from my branch (I could do it without the fix). You can see the program I tried below:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CepBug {
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
		env.enableCheckpointing(100);
		env.getCheckpointConfig().enableExternalizedCheckpoints(RETAIN_ON_CANCELLATION);

		Pattern&amp;lt;Event, ?&amp;gt; pattern = Pattern.&amp;lt;Event&amp;gt;begin(&lt;span class=&quot;code-quote&quot;&gt;&quot;start&quot;&lt;/span&gt;, AfterMatchSkipStrategy.skipPastLastEvent())
				.times(20)
				.within(Time.milliseconds(10));

		KeyedStream&amp;lt;Event, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; events = env.addSource(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RichParallelSourceFunction&amp;lt;Event&amp;gt;() {
			&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isRunning = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
			&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; currentTimestamp = 0;
			&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; currentId = 0;

			@Override
			&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run(SourceContext&amp;lt;Event&amp;gt; sourceContext) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
				&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (isRunning) {
					sourceContext.collectWithTimestamp(
							&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Event(
									currentId++,
									getRuntimeContext().getIndexOfThisSubtask(),
									currentTimestamp
							),
							currentTimestamp++
					);
					&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(10);
				}
			}

			@Override
			&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void cancel() {
				&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.isRunning = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
			}
		})
				.assignTimestampsAndWatermarks(
						WatermarkStrategy.forMonotonousTimestamps()
				)
				.keyBy(e -&amp;gt; e.key);

		SingleOutputStreamOperator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; start = CEP.pattern(events, pattern)
				.process(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PatternProcessFunction&amp;lt;Event, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;() {
					@Override
					&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void processMatch(
							Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, List&amp;lt;Event&amp;gt;&amp;gt; map,
							Context context,
							Collector&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; collector) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
						collector.collect(
								map.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;start&quot;&lt;/span&gt;)
										.stream()
										.map(e -&amp;gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;%s,%s&quot;&lt;/span&gt;, e.id, e.timestamp))
										.collect(Collectors.joining(&lt;span class=&quot;code-quote&quot;&gt;&quot;;&quot;&lt;/span&gt;))
						);
					}
				});

		start.print();
		env.execute();
	}

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Event {
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; id;
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; key;
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timestamp;

		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Event(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; id, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; key, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timestamp) {
			&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.id = id;
			&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.key = key;
			&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.timestamp = timestamp;
		}
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I am correct it follows your scenario and is actually even more aggressive. The checkpoint size of this program stays stable ~47kB for over 20 minutes.&lt;/p&gt;</comment>
                            <comment id="17244047" author="jamalarm" created="Fri, 4 Dec 2020 15:07:14 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Just to confirm, it&apos;s just the `flink-cep` module that needs to be replaced in my Job JAR? No other flink libraries need to be swapped out and it&apos;s ok to run the actual cluster on the release version?&lt;/p&gt;</comment>
                            <comment id="17244051" author="dawidwys" created="Fri, 4 Dec 2020 15:13:04 +0000"  >&lt;p&gt;The changes apply only to the flink-cep module yes. It&apos;s best to build the module against the version of your cluster.&lt;/p&gt;

&lt;p&gt;I don&apos;t know your setup, so can&apos;t tell if it is enough to replace it in the Job JAR. Generally it should be unless you e.g. put the flink-cep library into the lib folder of your cluster.&lt;/p&gt;</comment>
                            <comment id="17244083" author="jamalarm" created="Fri, 4 Dec 2020 16:04:05 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Am I correct in saying that your scenario above matches my scenario #2 from the original description? That is to say the &quot;constant key rotation&quot;  scenario, where keys only have one or two events before they go dormant and should be cleaned up?&lt;/p&gt;

&lt;p&gt;The test I ran above was scenario #1 which was the &quot;no key rotation&quot; one. Just the same keys emitting events over and over forever. The equivalent in your test would be to hold the `id` value in your generated events constant.&lt;/p&gt;

&lt;p&gt;I will rerun with the branch version on scenario #2 (to match your test setup) and see how it behaves.&lt;/p&gt;</comment>
                            <comment id="17244090" author="dawidwys" created="Fri, 4 Dec 2020 16:12:48 +0000"  >&lt;p&gt;No, my test case matches your scenario #1. In my test there is no key rotation. I am using the Event#key as a key, which I set equal to the index of the parallel instance of the source. I run the test with parallelism of 4 so there were 4 constant keys.&lt;/p&gt;

&lt;p&gt;Number of keys or keys becoming dormant should not play any role for the root cause. All keys are processed independently. &lt;/p&gt;

&lt;p&gt;The only difference in your two scenarios is how many events are assigned to a key and in turn into a pattern. The bug I fixed was that long chains of events were blocking past timed out events. Moreover the problem occured only if in such a chain there was a single event that was not timed-out. Then it was blocking all the past events. Have a look at an example:&lt;/p&gt;

&lt;p&gt;Imagine partial matches:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1. (t=1), (t=2), (t=3) ... (t=4)
2. (t=2), (t=3) ... (t=4) (t=5)
3. (t=3) ... (t=4)(t=5)(t=6)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Assume timeout happens after 3 units of time.&lt;br/&gt;
Let&apos;s advance time to t = 4, then the 1. partial match gets timed out. We could prune event (t=1) but it was not pruned because it was blocked by e.g. (t=2) event in partial match 2. After advancing to t=5 the match 2. gets timed out, we could prune (t=2) again it is blocked by (t=3) from match 3. etc...&lt;/p&gt;

&lt;p&gt;In your scenario #1 with much more events and basically never timing out all the events, the state was never pruned. That is why in scenario #1 it is more severe.&lt;/p&gt;</comment>
                            <comment id="17244094" author="jamalarm" created="Fri, 4 Dec 2020 16:19:43 +0000"  >&lt;p&gt;Ah sorry, I mixed up the `key` and `id` value when I was reading your code. &lt;/p&gt;

&lt;p&gt;This is a screenshot from IntelliJ of the imported libraries from my test JAR:&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13016502/13016502_screenshot-3.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;I pushed your branch to our internal artifactory under the snapshot version. I&apos;m going to try pushing again with a more specific version name to make sure I&apos;m not somehow pulling in snapshot versions from somewhere else, but getting this far was extremely painful already due to getting the maven build to work nice with our artifactory.&lt;/p&gt;

&lt;p&gt;Would it be possible to stick a temporary log line somewhere in an init function for one of the CEP operators that I could look out for to confirm 100% that it&apos;s running with the right branch version on my remote test cluster?&lt;/p&gt;</comment>
                            <comment id="17245327" author="jamalarm" created="Mon, 7 Dec 2020 16:28:34 +0000"  >&lt;p&gt;Ok, I&apos;ve built another version of our app this time using every artefact built from your branch (all parts of Flink). The bug is still visible (state still grows unbounded).&lt;/p&gt;

&lt;p&gt;I&apos;m going to try and get approval internally to send you a cut down version of our app that exhibits this behaviour. Do you just need a job JAR that you can start on a cluster and see the effect?&lt;/p&gt;

&lt;p&gt;Also it would be great if there is a slightly more confidential way I can send the code to you, it&apos;s not hyper sensitive or anything but I&apos;d rather not post it on a public JIRA ticket.&lt;/p&gt;</comment>
                            <comment id="17245737" author="dawidwys" created="Tue, 8 Dec 2020 08:28:11 +0000"  >&lt;p&gt;I&apos;d need the code of a job that I can reproduce the problem with. It would be best if I could reproduce the program locally on my machine. The most important part is though that it does not use any external systems. That it does not read or write from/to Kafka or any other queue or other systems.&lt;/p&gt;

&lt;p&gt;You can email me at dwysakowicz@apache.org&lt;/p&gt;</comment>
                            <comment id="17245902" author="jamalarm" created="Tue, 8 Dec 2020 14:06:14 +0000"  >&lt;p&gt;Ok, I am working on this now. It&apos;s going to take me a while to cut down everything to get it into one self-contained JAR but I&apos;ll send it over as soon as I&apos;m done.&lt;/p&gt;</comment>
                            <comment id="17247999" author="jamalarm" created="Fri, 11 Dec 2020 16:08:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; I&apos;ve emailed you over the code + JAR. Please give me a shout here or over email if you need anything else from me.&lt;/p&gt;</comment>
                            <comment id="17289837" author="dawidwys" created="Wed, 24 Feb 2021 10:30:19 +0000"  >&lt;p&gt;Fixed in fab2e55bddc5495353a443c808c99e9bdaac4209&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13328246">FLINK-19293</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13014703" name="image-2020-11-04-11-35-12-126.png" size="134905" author="Jamalarm" created="Wed, 4 Nov 2020 11:35:12 +0000"/>
                            <attachment id="13016430" name="screenshot-1.png" size="30863" author="Jamalarm" created="Thu, 3 Dec 2020 16:37:00 +0000"/>
                            <attachment id="13016487" name="screenshot-2.png" size="60729" author="Jamalarm" created="Fri, 4 Dec 2020 10:13:34 +0000"/>
                            <attachment id="13016502" name="screenshot-3.png" size="88078" author="Jamalarm" created="Fri, 4 Dec 2020 16:17:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ka4g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>