<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:39:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-12342] Yarn Resource Manager Acquires Too Many Containers</title>
                <link>https://issues.apache.org/jira/browse/FLINK-12342</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In currently implementation of YarnFlinkResourceManager, it starts to acquire new container one by one when get request from SlotManager. The mechanism works when job is still, say less than 32 containers. If the job has 256 container, containers can&apos;t be immediately allocated and appending requests in AMRMClient will be not removed accordingly. We observe the situation that AMRMClient ask for current pending request + 1 (the new request from slot manager) containers. In this way, during the start time of such job, it asked for 4000+ containers. If there is an external dependency issue happens, for example hdfs access is slow. Then, the whole job will be blocked without getting enough resource and finally killed with SlotManager request timeout.&lt;/p&gt;

&lt;p&gt;Thus, we should use the total number of container asked rather than pending request in AMRMClient as threshold to make decision whether we need to add one more resource request.&lt;/p&gt;


</description>
                <environment>&lt;p&gt;We runs job in Flink release 1.6.3. &lt;/p&gt;</environment>
        <key id="13230359">FLINK-12342</key>
            <summary>Yarn Resource Manager Acquires Too Many Containers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="ZhenqiuHuang">Zhenqiu Huang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 26 Apr 2019 17:39:46 +0000</created>
                <updated>Thu, 7 Nov 2019 10:31:15 +0000</updated>
                            <resolved>Wed, 6 Nov 2019 22:53:33 +0000</resolved>
                                    <version>1.6.4</version>
                    <version>1.7.2</version>
                    <version>1.8.0</version>
                                    <fixVersion>1.8.3</fixVersion>
                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Deployment / YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="16827956" author="till.rohrmann" created="Sun, 28 Apr 2019 11:52:28 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hpeter&quot; class=&quot;user-hover&quot; rel=&quot;hpeter&quot;&gt;hpeter&lt;/a&gt;. For my understanding, will the previous container requests be added up with every call to &lt;tt&gt;AMRMClientAsync#addContainerRequest&lt;/tt&gt; to the total number of container requests? So to say, the system would request 1 + 2 + 3 + 4 + 5 + ... + n if calling n times &lt;tt&gt;addContainerRequest&lt;/tt&gt; and if no container request could be fulfilled in the meantime? Or how does it happen that we add 4000+ container requests to the &lt;tt&gt;AMRMClient&lt;/tt&gt;? &lt;/p&gt;</comment>
                            <comment id="16827993" author="zhenqiuhuang" created="Sun, 28 Apr 2019 13:14:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&lt;br/&gt;
The job that has the issue tries to acquire 256 containers. At the same time it starts, hdfs that serves the jar is very relatively slow. You can image the sum of 1 + 2 + 3  +  ....  T. It stops to acquire new when 256  - T &amp;lt; the appending request in  AMRMClientAsync.&lt;/p&gt;</comment>
                            <comment id="16828949" author="till.rohrmann" created="Mon, 29 Apr 2019 06:42:48 +0000"  >&lt;p&gt;Before diving into the implementation, I would first like to fully understand the problem. Concretely a Yarn reference would be good which explains the behaviour. Otherwise we might simply fix a symptom or not the problem at all.&lt;/p&gt;</comment>
                            <comment id="16829009" author="zhenqiuhuang" created="Mon, 29 Apr 2019 08:10:45 +0000"  >&lt;p&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12967352/12967352_container.log&quot; title=&quot;container.log attached to FLINK-12342&quot;&gt;container.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&lt;br/&gt;
As the full log is too big. I copied the container allocation part for you to diagnosis.&lt;/p&gt;</comment>
                            <comment id="16829614" author="zhenqiuhuang" created="Mon, 29 Apr 2019 18:46:50 +0000"  >&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12967399/12967399_flink-1.4.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;  &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12967400/12967400_flink-1.6.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&lt;br/&gt;
This is the same job needs (256 containers). If runs on Flink 1.4, it only totally acquired 257 containers. But if run on Flink 1.6, it will acquire much large number of containers. The allocation of each container will goes to very slow, thus cause issue of deployment job with more than 10 minutes which is unacceptable for streaming job use cases.&lt;/p&gt;</comment>
                            <comment id="16830875" author="zhenqiuhuang" created="Wed, 1 May 2019 05:46:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&lt;br/&gt;
After reading the AMRMAsynclient, I just find the resource request is actually sent in each of heartbeat. If the existing pending request N is not removed yet, the new added request will be added as N +1 and be sent to RM. For the issue we observe, I think it is caused by  FAST_YARN_HEARTBEAT_INTERVAL_MS = 500 is set during the resource allocation triggered by SlotManager.  Somehow the number of container allocated is always less than pending request within 500 millisecond. So each of fast heartbeat will ask for extra number of containers. If we change FAST_YARN_HEARTBEAT_INTERVAL_MS to 2000 ms, and wait for more containers be returned before sending another heartbeat, we can definitely reduce the total number of requested containers.&lt;/p&gt;

&lt;p&gt;Thus, the solution I would like to propose is to make the FAST_YARN_HEARTBEAT_INTERVAL_MS as one of YarnConfigOptions. So that the parameter can be tuned according to the size of job/cluster. How do you think?&lt;/p&gt;


</comment>
                            <comment id="16831427" author="zhenqiuhuang" created="Thu, 2 May 2019 06:14:38 +0000"  >&lt;p&gt;As using the config and set it to 3000 milliseconds, the job with 256 containers can be successfully launched with only 1000+ total requested containers. The number can be further reduced by using larger number, such as 5000 or even higher. So, for small jobs with 32 containers, user should just default value for sending out request as soon as possible. For large jobs, user need to tune the parameter to trade-off the fast request and negative impact of repetitively as more containers.&lt;/p&gt;</comment>
                            <comment id="16831500" author="till.rohrmann" created="Thu, 2 May 2019 09:23:07 +0000"  >&lt;p&gt;Thanks for the investigation of this problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hpeter&quot; class=&quot;user-hover&quot; rel=&quot;hpeter&quot;&gt;hpeter&lt;/a&gt;. I think you are right that our aggressive &lt;tt&gt;FAST_YARN_HEARTBEAT_INTERVAL&lt;/tt&gt; plus this &lt;a href=&quot;https://issues.apache.org/jira/browse/YARN-1902&quot; title=&quot;Allocation of too many containers when a second request is done with the same resource capability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;YARN-1902&quot;&gt;YARN-1902&lt;/a&gt; bug are the cause for the problem. If &lt;a href=&quot;https://issues.apache.org/jira/browse/YARN-1902&quot; title=&quot;Allocation of too many containers when a second request is done with the same resource capability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;YARN-1902&quot;&gt;YARN-1902&lt;/a&gt; were properly resolved, then it wouldn&apos;t be a problem. Until this is the case, a way to mitigate the problem would be to make &lt;tt&gt;FAST_YARN_HEARTBEAT_INTERVAL&lt;/tt&gt; configurable as you&apos;ve suggested.&lt;/p&gt;</comment>
                            <comment id="16834874" author="till.rohrmann" created="Tue, 7 May 2019 15:27:40 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
1.9.0: 3871d4d2bf19d904252ed2fe8fe7cbad9af2c634&lt;br/&gt;
1.8.1: 1e25889796f1fb5e857b51158005e89d7a462595&lt;br/&gt;
1.7.3: f221542031a4725040c952c09a5c012b8fed2efb&lt;/p&gt;</comment>
                            <comment id="16967560" author="till.rohrmann" created="Tue, 5 Nov 2019 14:19:36 +0000"  >&lt;p&gt;The problem seems to be not entirely resolved: &lt;a href=&quot;https://lists.apache.org/thread.html/173a678c02246af6b6a7b3dcfac0d548f5be27496fb5b53145b853e5@%3Cuser.flink.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/173a678c02246af6b6a7b3dcfac0d548f5be27496fb5b53145b853e5@%3Cuser.flink.apache.org%3E&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16967589" author="till.rohrmann" created="Tue, 5 Nov 2019 15:05:40 +0000"  >&lt;p&gt;One problem seems to be that we remove the container request too slowly since we remove one request and then start a &lt;tt&gt;TaskExecutor&lt;/tt&gt; in the container. Start a &lt;tt&gt;TaskExecutor&lt;/tt&gt; can take some time since we upload files to HDFS. I propose to change the &lt;tt&gt;YarnResourceManager#onContainerAllocated&lt;/tt&gt; method to first remove all container requests and only then to start the &lt;tt&gt;TaskExecutors&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16968779" author="till.rohrmann" created="Wed, 6 Nov 2019 22:53:33 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.10.0: b8500691c6b1e23c61c9408b5562d67bb2fc2336&lt;br/&gt;
1.9.2: 5c9a013e5bc2f7f309b75eb6d4310d16d5585d90&lt;br/&gt;
1.8.3: cb319547268aa282bf413d1ed9a1cac8999ae80d&lt;/p&gt;</comment>
                            <comment id="16969146" author="till.rohrmann" created="Thu, 7 Nov 2019 10:30:38 +0000"  >&lt;p&gt;I fear that this issue has not been fully fixed with the latest commits but only mitigated as we are still blocking the main thread when starting the &lt;tt&gt;TaskExecutors&lt;/tt&gt;. This could lead to a delay of processing incoming &lt;tt&gt;YarnResourceManager#onContainersAllocated&lt;/tt&gt; messages. For more details see &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13184&quot; title=&quot;Starting a TaskExecutor blocks the YarnResourceManager&amp;#39;s main thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13184&quot;&gt;&lt;del&gt;FLINK-13184&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13244006">FLINK-13184</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13265473">FLINK-14582</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12967398" name="Screen Shot 2019-04-29 at 12.06.23 AM.png" size="215832" author="ZhenqiuHuang" created="Mon, 29 Apr 2019 18:41:15 +0000"/>
                            <attachment id="12967352" name="container.log" size="1104338" author="ZhenqiuHuang" created="Mon, 29 Apr 2019 08:09:48 +0000"/>
                            <attachment id="12967399" name="flink-1.4.png" size="215832" author="ZhenqiuHuang" created="Mon, 29 Apr 2019 18:42:37 +0000"/>
                            <attachment id="12967400" name="flink-1.6.png" size="237948" author="ZhenqiuHuang" created="Mon, 29 Apr 2019 18:42:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z026iw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>With Flink 1.9.0 the Yarn heartbeat configuration parameter has been renamed from `yarn.heartbeat-delay` to `yarn.heartbeat.interval`.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>