<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:42:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14951] State TTL backend end-to-end test fail when taskManager has multiple slot</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14951</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When I run flink end to end tests, the State TTL backend tests fail. The log of TaskManager show below:&lt;br/&gt;
2019-11-26 20:22:03,837 INFO  org.apache.flink.runtime.taskmanager.Task                     - TtlVerifyUpdateFunction -&amp;gt; Sink: PrintFailedVerifications (3/3) (23f969ddb3e13fcdd3ba9823f50b0eab) switched from RUNNING to FAILED.&lt;br/&gt;
java.lang.IllegalStateException: Timestamps before and after the update do not match.&lt;br/&gt;
	at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195)&lt;br/&gt;
	at org.apache.flink.streaming.tests.TtlVerifyUpdateFunction.performUpdate(TtlVerifyUpdateFunction.java:124)&lt;br/&gt;
	at org.apache.flink.streaming.tests.TtlVerifyUpdateFunction.generateUpdateAndVerificationContext(TtlVerifyUpdateFunction.java:101)&lt;br/&gt;
	at org.apache.flink.streaming.tests.TtlVerifyUpdateFunction.flatMap(TtlVerifyUpdateFunction.java:88)&lt;br/&gt;
	at org.apache.flink.streaming.tests.TtlVerifyUpdateFunction.flatMap(TtlVerifyUpdateFunction.java:67)&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.StreamFlatMap.processElement(StreamFlatMap.java:50)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.OneInputStreamTask$StreamTaskNetworkOutput.emitRecord(OneInputStreamTask.java:173)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.io.StreamTaskNetworkInput.processElement(StreamTaskNetworkInput.java:151)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.io.StreamTaskNetworkInput.emitNext(StreamTaskNetworkInput.java:128)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:69)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:284)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:155)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:445)&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:702)&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:527)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:834)&lt;/p&gt;

&lt;p&gt;It is cause by the MonotonicTTLTimeProvider:freeze and MonotonicTTLTimeProvider:unfreezeTime called by multithread when taskmanager.numberOfTaskSlots set greater than 1. We could set it to 1 in test_stream_state_ttl.sh. That will fix the problem.&lt;/p&gt;</description>
                <environment>&lt;p&gt;centos 7&lt;br/&gt;
java 8&lt;/p&gt;</environment>
        <key id="13270712">FLINK-14951</key>
            <summary>State TTL backend end-to-end test fail when taskManager has multiple slot</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guoyangze">Yangze Guo</assignee>
                                    <reporter username="guoyangze">Yangze Guo</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 26 Nov 2019 12:37:49 +0000</created>
                <updated>Tue, 30 Nov 2021 20:38:16 +0000</updated>
                            <resolved>Wed, 11 Dec 2019 09:21:56 +0000</resolved>
                                    <version>1.7.2</version>
                                    <fixVersion>1.8.4</fixVersion>
                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16982436" author="karmagyz" created="Tue, 26 Nov 2019 12:39:18 +0000"  >&lt;p&gt;Could someone kindly assign this issue to me? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16982556" author="azagrebin" created="Tue, 26 Nov 2019 14:47:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guoyangze&quot; class=&quot;user-hover&quot; rel=&quot;guoyangze&quot;&gt;guoyangze&lt;/a&gt; &lt;br/&gt;
Could we fix the underlying concurrency problem?&lt;br/&gt;
This should be doable if we substitute &lt;em&gt;freeze/unfreeze&lt;/em&gt; methods with e.g. this kind of method:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;T&amp;gt; MonotonicTTLTimeProvider#doWithFrozenTime(Function&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, T&amp;gt; action) {
&#160;&#160;&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (lock) {
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; action.accept(getCurrentTimestamp());
&#160; }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and use it in&#160;TtlVerifyUpdateFunction#performUpdate like:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MonotonicTTLTimeProvider.doWithFrozenTime(frozenTimestamp -&amp;gt; {
&#160; State state = states.get(verifier.getId());
&#160; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; valueBeforeUpdate = verifier.get(state);
&#160; verifier.update(state, update);
&#160; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; updatedValue = verifier.get(state);
&#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TtlUpdateContext&amp;lt;&amp;gt;(valueBeforeUpdate, update, updatedValue, frozenTimestamp);
});
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;wdyt?&lt;/p&gt;</comment>
                            <comment id="16982563" author="azagrebin" created="Tue, 26 Nov 2019 14:52:39 +0000"  >&lt;p&gt;btw,&#160;taskmanager.numberOfTaskSlots is already 1 by default, is it changed somewhere for the TTL e2e test?&lt;/p&gt;</comment>
                            <comment id="16983088" author="karmagyz" created="Wed, 27 Nov 2019 01:57:47 +0000"  >&lt;p&gt;Yes, it is changed by other e2e test and not be reverted after other test failed.&lt;/p&gt;</comment>
                            <comment id="16983096" author="karmagyz" created="Wed, 27 Nov 2019 02:16:30 +0000"  >&lt;p&gt;Agreed, that will prevent the multithread call issue. &lt;/p&gt;</comment>
                            <comment id="16983396" author="azagrebin" created="Wed, 27 Nov 2019 11:01:09 +0000"  >&lt;p&gt;would you like to work on the discussed fix? should I assign you?&lt;/p&gt;</comment>
                            <comment id="16983400" author="karmagyz" created="Wed, 27 Nov 2019 11:03:27 +0000"  >&lt;p&gt;Yes, please assign it to me.&lt;/p&gt;</comment>
                            <comment id="16991170" author="karmagyz" created="Mon, 9 Dec 2019 06:18:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; Hi, andrey. I notice the fix version of this issue is setted to 1.10. Do you think its a blocker for 1.10 release? If so, could you take a look at the PR? If not, we should edit this field.&lt;/p&gt;</comment>
                            <comment id="16991567" author="azagrebin" created="Mon, 9 Dec 2019 13:08:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guoyangze&quot; class=&quot;user-hover&quot; rel=&quot;guoyangze&quot;&gt;guoyangze&lt;/a&gt;&lt;br/&gt;
Hi yangze, I do not actually see this test failing in master cron e2e tests run.&lt;br/&gt;
Could you provide more details which test does not revert the default 1 slot option or how did you run it to get this failure scenario?&lt;/p&gt;

&lt;p&gt;For now, I change it to major but technically it was written originally under assumption of parallelism one so I would say we keep it for now as a nice to have and not blocking the release.&lt;/p&gt;</comment>
                            <comment id="16991629" author="karmagyz" created="Mon, 9 Dec 2019 14:21:07 +0000"  >&lt;p&gt;Actually, I execute it by run_singe_test.sh. Many tests will touch &quot;taskmanager.numberOfTaskSlots&quot; configuration, such as &quot;test_high_parallelism_iterations.sh&quot;. After it failure, the cleanup function will not be called to revert the configuration. Thus, I met this problem.&lt;/p&gt;

&lt;p&gt;Since the test case has thread safety issue, I think we should either set the &quot;taskmanager.numberOfTaskSlots&quot; explicitly to 1 or harden the test case. WDYT?&lt;/p&gt;

&lt;p&gt;Agreed that it should not block the 1.10 release. What about setting the fix version to 1.11?&lt;/p&gt;</comment>
                            <comment id="16991708" author="azagrebin" created="Mon, 9 Dec 2019 15:38:02 +0000"  >&lt;p&gt;True we could firstly set&#160;&quot;taskmanager.numberOfTaskSlots&quot; explicitly to 1 but let&apos;s see maybe we can merge it soon. I have reviewed the PR and the requested change should be easy to resolve.&lt;/p&gt;</comment>
                            <comment id="16993343" author="azagrebin" created="Wed, 11 Dec 2019 09:21:56 +0000"  >&lt;p&gt;merged into master by 2c11291fda7776baa0b2626311de97ea04393f65&lt;br/&gt;
merged into 1.9 by 8a73d680869da0d7bb4d543bfc197d01f3b0e068&lt;br/&gt;
merged into 1.8 by dfcbf68dbd792fc27c997078be7a59a594005d8b&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z090uo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>