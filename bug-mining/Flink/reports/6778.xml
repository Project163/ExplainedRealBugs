<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:15:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-29234] Dead lock in DefaultLeaderElectionService</title>
                <link>https://issues.apache.org/jira/browse/FLINK-29234</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Jobmanager stop working because the deadlock in DefaultLeaderElectionService.&lt;/p&gt;

&lt;p&gt;The log stopped at&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService [] - Stopping DefaultLeaderElectionService. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which may similar to this ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20008&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-20008&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here is the jstack info&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Found one Java-level deadlock: 
============================= 
&lt;span class=&quot;code-quote&quot;&gt;&quot;flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-18&quot;&lt;/span&gt;: waiting to lock monitor 0x00007f15c7eae3a8 (object 0x0000000678d395e8, a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;), which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;main-EventThread&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;main-EventThread&quot;&lt;/span&gt;: waiting to lock monitor 0x00007f15a3811258 (object 0x0000000678cf1be0, a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;), which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-18&quot;&lt;/span&gt; Java stack information &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the threads listed above: 
=================================================== 

&lt;span class=&quot;code-quote&quot;&gt;&quot;flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-18&quot;&lt;/span&gt;: 
 at org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService.stop(DefaultLeaderElectionService.java:104) - waiting to lock &amp;lt;0x0000000678d395e8&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
 at org.apache.flink.runtime.jobmaster.JobMasterServiceLeadershipRunner.lambda$closeAsync$0(JobMasterServiceLeadershipRunner.java:147)
 at org.apache.flink.runtime.jobmaster.JobMasterServiceLeadershipRunner$$Lambda$735/1742012752.run(Unknown Source)
 at org.apache.flink.runtime.concurrent.FutureUtils.lambda$runAfterwardsAsync$18(FutureUtils.java:687)
 at org.apache.flink.runtime.concurrent.FutureUtils$$Lambda$736/6716561.accept(Unknown Source)
 at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:774)
 at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:750)
 at java.util.concurrent.CompletableFuture$Completion.run(CompletableFuture.java:456)
 at org.apache.flink.runtime.concurrent.DirectExecutorService.execute(DirectExecutorService.java:217)
 at java.util.concurrent.CompletableFuture$UniCompletion.claim(CompletableFuture.java:543)
 at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:765)
 at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:750)
 at java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:795)
 at java.util.concurrent.CompletableFuture.whenCompleteAsync(CompletableFuture.java:2163)
 at org.apache.flink.runtime.concurrent.FutureUtils.runAfterwardsAsync(FutureUtils.java:684)
 at org.apache.flink.runtime.concurrent.FutureUtils.runAfterwards(FutureUtils.java:651)
 at org.apache.flink.runtime.jobmaster.JobMasterServiceLeadershipRunner.closeAsync(JobMasterServiceLeadershipRunner.java:143) - locked &amp;lt;0x0000000678cf1be0&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
 at org.apache.flink.runtime.dispatcher.Dispatcher.terminateJob(Dispatcher.java:807)
 at org.apache.flink.runtime.dispatcher.Dispatcher.terminateRunningJobs(Dispatcher.java:799)
 at org.apache.flink.runtime.dispatcher.Dispatcher.terminateRunningJobsAndGetTerminationFuture(Dispatcher.java:812)
 at org.apache.flink.runtime.dispatcher.Dispatcher.onStop(Dispatcher.java:268)
 at org.apache.flink.runtime.rpc.RpcEndpoint.internalCallOnStop(RpcEndpoint.java:214)
 at org.apache.flink.runtime.rpc.akka.AkkaRpcActor$StartedState.terminate(AkkaRpcActor.java:563)
 at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleControlMessage(AkkaRpcActor.java:186)
 at org.apache.flink.runtime.rpc.akka.AkkaRpcActor$$Lambda$444/1289054037.apply(Unknown Source)
 at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:26)
 at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:21)
 at scala.PartialFunction.applyOrElse(PartialFunction.scala:123)
 at scala.PartialFunction.applyOrElse$(PartialFunction.scala:122)
 at akka.japi.pf.UnitCaseStatement.applyOrElse(CaseStatements.scala:21)
 at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171)
 at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:172)
 at akka.actor.Actor.aroundReceive(Actor.scala:517)
 at akka.actor.Actor.aroundReceive$(Actor.scala:515)
 at akka.actor.AbstractActor.aroundReceive(AbstractActor.scala:225)
 at akka.actor.ActorCell.receiveMessage(ActorCell.scala:592)
 at akka.actor.ActorCell.invoke(ActorCell.scala:561)
 at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:258)
 at akka.dispatch.Mailbox.run(Mailbox.scala:225)
 at akka.dispatch.Mailbox.exec(Mailbox.scala:235)
 at akka.dispatch.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
 at akka.dispatch.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
 at akka.dispatch.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
 at akka.dispatch.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)


&lt;span class=&quot;code-quote&quot;&gt;&quot;main-EventThread&quot;&lt;/span&gt;:
 at org.apache.flink.runtime.jobmaster.JobMasterServiceLeadershipRunner.runIfStateRunning(JobMasterServiceLeadershipRunner.java:468) - waiting to lock &amp;lt;0x0000000678cf1be0&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
 at org.apache.flink.runtime.jobmaster.JobMasterServiceLeadershipRunner.grantLeadership(JobMasterServiceLeadershipRunner.java:248)
 at org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService.onGrantLeadership(DefaultLeaderElectionService.java:211) - locked &amp;lt;0x0000000678d395e8&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
 at org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionDriver.isLeader(ZooKeeperLeaderElectionDriver.java:166)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch$9.apply(LeaderLatch.java:693)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch$9.apply(LeaderLatch.java:689)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.listen.ListenerContainer$1.run(ListenerContainer.java:100)
 at org.apache.flink.shaded.curator4.org.apache.curator.shaded.com.google.common.util.concurrent.DirectExecutor.execute(DirectExecutor.java:30)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.listen.ListenerContainer.forEach(ListenerContainer.java:92)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.setLeadership(LeaderLatch.java:688) - locked &amp;lt;0x0000000678d39788&amp;gt; (a org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.checkLeadership(LeaderLatch.java:567)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.access$700(LeaderLatch.java:65)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch$7.processResult(LeaderLatch.java:618)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorFrameworkImpl.sendToBackgroundCallback(CuratorFrameworkImpl.java:883)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorFrameworkImpl.processBackgroundOperation(CuratorFrameworkImpl.java:653)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.WatcherRemovalFacade.processBackgroundOperation(WatcherRemovalFacade.java:152)
 at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.GetChildrenBuilderImpl$2.processResult(GetChildrenBuilderImpl.java:187)
 at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:601)
 at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:508)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13480686">FLINK-29234</key>
            <summary>Dead lock in DefaultLeaderElectionService</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Weijie Guo">Weijie Guo</assignee>
                                    <reporter username="LucentWong">Yu Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 8 Sep 2022 14:52:58 +0000</created>
                <updated>Fri, 18 Nov 2022 14:23:18 +0000</updated>
                            <resolved>Fri, 18 Nov 2022 14:22:06 +0000</resolved>
                                    <version>1.13.5</version>
                    <version>1.14.5</version>
                    <version>1.15.3</version>
                                    <fixVersion>1.17.0</fixVersion>
                    <fixVersion>1.16.1</fixVersion>
                    <fixVersion>1.15.4</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17602230" author="martijnvisser" created="Fri, 9 Sep 2022 09:31:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=LucentWong&quot; class=&quot;user-hover&quot; rel=&quot;LucentWong&quot;&gt;LucentWong&lt;/a&gt; Given that Flink 1.13 is not supported by the community anymore, could you verify that this still occurs in Flink 1.15? &lt;/p&gt;</comment>
                            <comment id="17602689" author="lucentwong" created="Sat, 10 Sep 2022 09:46:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; I think this issue still exists in the master branch. The issue is caused by the ordering of Flink to get the lock.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In this line, the class &lt;b&gt;DefaultLeaderElectionService&lt;/b&gt; will try to get the lock of itself, then invoke the method of&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;leaderContender(which is JobMasterServiceLeaderShipRunner in this case).&lt;/b&gt; &#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/leaderelection/DefaultLeaderElectionService.java#L204&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/leaderelection/DefaultLeaderElectionService.java#L204&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So the order of getting locks is&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;DefaultLeaderElectionService&lt;/li&gt;
	&lt;li&gt;JobMasterServiceLeaderShipRunner&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And in this line &lt;b&gt;JobMasterServiceLeaderShipRunner&lt;/b&gt;&#160;will try to get the lock of itself, then invoke the method of &lt;b&gt;leaderElectionService(which is&lt;/b&gt; &lt;b&gt;DefaultLeaderElectionService in this case&lt;/b&gt;&lt;b&gt;).&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMasterServiceLeadershipRunner.java#L148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMasterServiceLeadershipRunner.java#L148&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So the order of getting the locks is&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;JobMasterServiceLeaderShipRunner&lt;/li&gt;
	&lt;li&gt;DefaultLeaderElectionService&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So if these two functions are invoked nearly at the same time, it will cause the dead lock issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17620883" author="xintongsong" created="Thu, 20 Oct 2022 07:58:42 +0000"  >&lt;p&gt;Looks like a valid bug to me. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt;, could you please take a look?&lt;/p&gt;</comment>
                            <comment id="17620943" author="weijie guo" created="Thu, 20 Oct 2022 09:31:29 +0000"  >&lt;p&gt;Yes, I will take a look and fix this~&lt;/p&gt;</comment>
                            <comment id="17627692" author="fabian.paul" created="Wed, 2 Nov 2022 13:14:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt; can you give an estimate of when this will be fixed? I want to start the release process of 1.15.3 and include this change.&lt;/p&gt;</comment>
                            <comment id="17627706" author="weijie guo" created="Wed, 2 Nov 2022 13:29:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpaul&quot; class=&quot;user-hover&quot; rel=&quot;fpaul&quot;&gt;fpaul&lt;/a&gt; , The PR changes the production code very little, and it may take 1&#65374;2 days to complete the review.&lt;/p&gt;</comment>
                            <comment id="17635894" author="xintongsong" created="Fri, 18 Nov 2022 14:22:06 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;master (1.17): d745f5b3f7a64445854c735668afa9b72edb3fee&lt;/li&gt;
	&lt;li&gt;release-1.16: a5b9efec917c696a5836fd1779ed787d6e7a7108&lt;/li&gt;
	&lt;li&gt;release-1.15: 74097409e7a874584d28b84d10bf6bfe98a11af3&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 51 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18ey0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>