<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:42:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-15013] Flink (on YARN) sometimes needs too many slots</title>
                <link>https://issues.apache.org/jira/browse/FLINK-15013</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;THIS IS DIFFERENT FROM &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15007&quot; title=&quot;Flink on YARN does not request required TaskExecutors in some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15007&quot;&gt;&lt;del&gt;FLINK-15007&lt;/del&gt;&lt;/a&gt;, even though the text looks almost the same.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This was discovered while debugging &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14834&quot; title=&quot;Kerberized YARN on Docker test fails on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14834&quot;&gt;&lt;del&gt;FLINK-14834&lt;/del&gt;&lt;/a&gt;. In some cases a Flink needs needs more slots to execute than expected. You can see this in some of the logs attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14834&quot; title=&quot;Kerberized YARN on Docker test fails on Travis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14834&quot;&gt;&lt;del&gt;FLINK-14834&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;You can reproduce this using &lt;a href=&quot;https://github.com/aljoscha/docker-hadoop-cluster&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aljoscha/docker-hadoop-cluster&lt;/a&gt; to bring up a YARN cluster and then running a compiled Flink in there.&lt;/p&gt;

&lt;p&gt;When you run&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
bin/flink run -m yarn-cluster -p 3 -yjm 1224 -ytm 1224 /root/DualInputWordCount.jar --input hdfs:&lt;span class=&quot;code-comment&quot;&gt;///wc-in-1 --output hdfs:///wc-out &amp;amp;&amp;amp; hdfs dfs -rm -r /wc-out&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and check the logs afterwards you will sometimes see three &quot;Requesting new slot...&quot; statements and sometimes you will see four.&lt;/p&gt;

&lt;p&gt;This is the &lt;tt&gt;git bisect&lt;/tt&gt; log that identifies the first faulty commit (&lt;a href=&quot;https://github.com/apache/flink/commit/2ab8b61f2f22f1a1ce7f92cd6b8dd32d2c0c227d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/2ab8b61f2f22f1a1ce7f92cd6b8dd32d2c0c227d&lt;/a&gt;):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
git bisect start
# good: [09f2f43a1d73c76bf4d3f4a1205269eb860deb14] [FLINK-14154][ml] Add the &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; multivariate Gaussian Distribution.
git bisect good 09f2f43a1d73c76bf4d3f4a1205269eb860deb14
# bad: [01d6972ab267807b8afccb09a45c454fa76d6c4b] [hotfix] Refactor out slots creation from the TaskSlotTable constructor
git bisect bad 01d6972ab267807b8afccb09a45c454fa76d6c4b
# bad: [7a61c582c7213f123e10de4fd11a13d96425fd77] [hotfix] Fix wrong Java doc comment of BroadcastStateBootstrapFunction.Context
git bisect bad 7a61c582c7213f123e10de4fd11a13d96425fd77
# good: [edeec8d7420185d1c49b2739827bd921d2c2d485] [hotfix][runtime] Replace all occurrences of letter to mail to unify wording of variables and documentation.
git bisect good edeec8d7420185d1c49b2739827bd921d2c2d485
# bad: [1b4ebce86b71d56f44185f1cb83d9a3b51de13df] [FLINK-14262][table-planner-blink] support referencing function with fully/partially qualified names in blink
git bisect bad 1b4ebce86b71d56f44185f1cb83d9a3b51de13df
# good: [25a3d9138cd5e39fc786315682586b75d8ac86ea] [hotfix] Move TaskManagerSlot to o.a.f.runtime.resourcemanager.slotmanager
git bisect good 25a3d9138cd5e39fc786315682586b75d8ac86ea
# good: [362d7670593adc2e4b20650c8854398727d8102b] [FLINK-12122] Calculate TaskExecutorUtilization when listing available slots
git bisect good 362d7670593adc2e4b20650c8854398727d8102b
# bad: [7e8218515baf630e668348a68ff051dfa49c90c3] [FLINK-13969][Checkpointing] Do not allow trigger &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; checkpoitn after stop the coordinator
git bisect bad 7e8218515baf630e668348a68ff051dfa49c90c3
# bad: [269e7f007e855c2bdedf8bad64ef13f516a608a6] [FLINK-12122] Choose SlotSelectionStrategy based on ClusterOptions#EVENLY_SPREAD_OUT_SLOTS_STRATEGY
git bisect bad 269e7f007e855c2bdedf8bad64ef13f516a608a6
# bad: [2ab8b61f2f22f1a1ce7f92cd6b8dd32d2c0c227d] [FLINK-12122] Add EvenlySpreadOutLocationPreferenceSlotSelectionStrategy
git bisect bad 2ab8b61f2f22f1a1ce7f92cd6b8dd32d2c0c227d
# first bad commit: [2ab8b61f2f22f1a1ce7f92cd6b8dd32d2c0c227d] [FLINK-12122] Add EvenlySpreadOutLocationPreferenceSlotSelectionStrategy
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m using the streaming WordCount example that I modified to have two &quot;inputs&quot;, similar to how the WordCount example is used in the YARN/kerberos/Docker test. Instead of using the input once we use it like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
text = env.readTextFile(params.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;input&quot;&lt;/span&gt;)).union(env.readTextFile(params.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;input&quot;&lt;/span&gt;)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to create two inputs from the same path. A jar is attached.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13271708">FLINK-15013</key>
            <summary>Flink (on YARN) sometimes needs too many slots</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="aljoscha">Aljoscha Krettek</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 2 Dec 2019 13:54:32 +0000</created>
                <updated>Tue, 17 Dec 2019 17:08:20 +0000</updated>
                            <resolved>Fri, 13 Dec 2019 17:28:50 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16986656" author="zhuzh" created="Tue, 3 Dec 2019 06:37:44 +0000"  >&lt;p&gt;Thanks for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; to find out the faulty commit.&lt;br/&gt;
The root cause should be this change in the faulty commit:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-		&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; bestCandidateScore = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MIN_VALUE;
+		&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; bestCandidateScore = &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.MIN_VALUE;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since Integer.MIN_VALUE is negative but Double.MIN_VALUE is a very small positive value. So that slot with 0 score (Locality==NON_LOCAL) will fail to match the slot request.&lt;br/&gt;
&lt;b&gt;change it to &lt;tt&gt;&quot;double bestCandidateScore = -1.0;&quot;&lt;/tt&gt; should fix this issue.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;However, here comes another question: the &lt;tt&gt;NON_LOCAL&lt;/tt&gt; locality should not happen in this case. Theoretically it should be able to find a slot of its upstream node which is &lt;tt&gt;LOCAL&lt;/tt&gt;, since the task is scheduled when its upstream tasks are assigned slots, its parallelism is not larger, and all tasks are in the same slot sharing group. &lt;br/&gt;
I did some experiment and find the cause, it&apos;s a bit complicated to explain.&lt;br/&gt;
1. To be simple, the root cause is that a slot offer for a shared slot completes the location of inner tasks before making the shared slot resolved with location. (due to unexpected &lt;tt&gt;CompletableFuture&lt;/tt&gt; callback)&lt;br/&gt;
2. The task location completion triggers its downstream task scheduling, but the downstream task would fail to see resolved shared slot of its upstream task due to #1. So it make pick a random pending slot sharing group which is against the input locality constraint. (see  &lt;tt&gt;SchedulerImpl#allocateMultiTaskSlot&lt;/tt&gt;)&lt;br/&gt;
3. After #2 happened. A later scheduled task may find there is no pending slot sharing group, and the resolved slot sharing group cannot fulfill its locality constraint. Then it will request a new slot.&lt;/p&gt;

&lt;p&gt;Looks to me the most simple way to fix it would be: Resolve shared slot locations when it&apos;s assigned a physical slot, before completing the location futures of tasks. So that the tasks would always be possible to find a resolved slot.&lt;/p&gt;

&lt;p&gt;Not that this may not be a new issue since the problematic logics has been there for versions. Fixing it is not necessary to resolve this ticket, but can make the input locality constraint work as expected.&lt;/p&gt;</comment>
                            <comment id="16986786" author="gjy" created="Tue, 3 Dec 2019 10:45:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; Do you have capacities to work on this?&lt;/p&gt;</comment>
                            <comment id="16992439" author="till.rohrmann" created="Tue, 10 Dec 2019 11:04:13 +0000"  >&lt;p&gt;Thanks a lot for the analysis of the problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;. I have capacities for working on this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16993576" author="aljoscha" created="Wed, 11 Dec 2019 14:09:11 +0000"  >&lt;p&gt;The issue seems to be fixed on master. I&apos;m currently bisecting to identify the &quot;culprit&quot;.&lt;/p&gt;</comment>
                            <comment id="16993653" author="aljoscha" created="Wed, 11 Dec 2019 15:54:35 +0000"  >&lt;p&gt;Scratch that, it seems to happen in roughly 20 % of cases.&lt;/p&gt;</comment>
                            <comment id="16993682" author="till.rohrmann" created="Wed, 11 Dec 2019 16:23:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt; could you help me to understand the second problem. Are you saying that &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotSharingManager.java#L172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotSharingManager.java#L172&lt;/a&gt; will be executed after &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotSharingManager.java#L692&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotSharingManager.java#L692&lt;/a&gt; so that there can be the situation that a &lt;tt&gt;SingleTaskSlot&lt;/tt&gt; is completed and the underlying &lt;tt&gt;MultiTaskSlot&lt;/tt&gt; has not been moved to &lt;tt&gt;SlotSharingManager#resolvedRootSlots&lt;/tt&gt;? Maybe you could provide me with your test setup to reproduce the problem. I tried to write some tests but they passed so far.&lt;/p&gt;</comment>
                            <comment id="16994287" author="zhuzh" created="Thu, 12 Dec 2019 06:39:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; yes that&apos;s what I mean. And location preferences are not respected when fulfilling a slot request with &lt;tt&gt;unresolvedRootSlots&lt;/tt&gt;. &lt;br/&gt;
This &lt;a href=&quot;https://github.com/zhuzhurk/flink/commit/464396283b96b670998d11c88cd102855c19c385&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt; contains a test to reproduce the input locality issue.&lt;/p&gt;</comment>
                            <comment id="16994750" author="till.rohrmann" created="Thu, 12 Dec 2019 14:41:37 +0000"  >&lt;p&gt;All right, let me look into the test case to see whether I can find the culprit.&lt;/p&gt;

&lt;p&gt;I think it is ok to not respect input preferences if you falls back to using &lt;tt&gt;unresolvedRootSlots&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16994787" author="zhuzh" created="Thu, 12 Dec 2019 15:35:22 +0000"  >&lt;p&gt;Yes, it is ok to not respect input preferences if falling back to using unresolvedRootSlots.&lt;br/&gt;
In this case, what is unexpected is the falling back to unresolvedRootSlots. The cause, as discussed above, is that the slot offer first completes the SingleTaskSlot in a shared slot(MultiTaskSlot), before that shared slot is moved to resolvedRootSlots. The completed SingleTaskSlot also completes the input locality future, and triggers the scheduling and slot request of downstream tasks. The triggered slot request would not see the just fulfilled shared slot as resolved and so it would randomly pick an unresolved slot. In this way the input locality is broken.&lt;/p&gt;</comment>
                            <comment id="16995777" author="till.rohrmann" created="Fri, 13 Dec 2019 17:28:50 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;master:&lt;br/&gt;
632586f27487836d3b336aa90b1754f150359250&lt;br/&gt;
9493c3dbaab3d171ad6a478ec1e5280048143900&lt;/p&gt;

&lt;p&gt;1.10.0:&lt;br/&gt;
e3171032252c9cb63f4c4698c81a5a6114fb24a6&lt;br/&gt;
7f4dc2cf32178babfb812832b7fd43bfd7fd12ed&lt;/p&gt;

&lt;p&gt;1.9.2:&lt;br/&gt;
119b4e7089391a73b90cfc87ec5aa0c8fa7543a8&lt;br/&gt;
02755b973ccae3f9e756a6d82fe93435d1fb368c&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13268942">FLINK-14834</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13226655">FLINK-12122</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12987299" name="DualInputWordCount.jar" size="9784" author="aljoscha" created="Mon, 2 Dec 2019 13:53:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09700:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>