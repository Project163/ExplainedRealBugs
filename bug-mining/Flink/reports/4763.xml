<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20045] ZooKeeperLeaderElectionTest.testZooKeeperLeaderElectionRetrieval failed with &quot;TimeoutException: Contender was not elected as the leader within 200000ms&quot;</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20045</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=9251&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=05b74a19-4ee4-5036-c46f-ada307df6cf0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=9251&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=05b74a19-4ee4-5036-c46f-ada307df6cf0&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-11-07T10:34:07.5063203Z [ERROR] testZooKeeperLeaderElectionRetrieval(org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionTest)  Time elapsed: 202.445 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
2020-11-07T10:34:07.5064331Z java.util.concurrent.TimeoutException: Contender was not elected as the leader within 200000ms
2020-11-07T10:34:07.5064946Z 	at org.apache.flink.runtime.testutils.CommonTestUtils.waitUntilCondition(CommonTestUtils.java:153)
2020-11-07T10:34:07.5065762Z 	at org.apache.flink.runtime.testutils.CommonTestUtils.waitUntilCondition(CommonTestUtils.java:139)
2020-11-07T10:34:07.5066565Z 	at org.apache.flink.runtime.leaderelection.TestingLeaderBase.waitForLeader(TestingLeaderBase.java:48)
2020-11-07T10:34:07.5067185Z 	at org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionTest.testZooKeeperLeaderElectionRetrieval(ZooKeeperLeaderElectionTest.java:144)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13339353">FLINK-20045</key>
            <summary>ZooKeeperLeaderElectionTest.testZooKeeperLeaderElectionRetrieval failed with &quot;TimeoutException: Contender was not elected as the leader within 200000ms&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="dian.fu">Dian Fu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Sun, 8 Nov 2020 01:20:19 +0000</created>
                <updated>Tue, 10 Nov 2020 10:31:18 +0000</updated>
                            <resolved>Tue, 10 Nov 2020 10:31:18 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17227925" author="fly_in_gis" created="Sun, 8 Nov 2020 06:55:58 +0000"  >&lt;p&gt;I am having a look on this failed test.&lt;/p&gt;</comment>
                            <comment id="17228330" author="fly_in_gis" created="Mon, 9 Nov 2020 03:09:41 +0000"  >&lt;p&gt;I think the root cause is the leader was granted too fast and the &lt;tt&gt;TestingLeaderElectionEventHandler#init()&lt;/tt&gt; has not been called. So we could find the following exception in the maven log. This could not happen in the production code since we have a &lt;tt&gt;lock&lt;/tt&gt; in &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;How to fix the unstable tests?&lt;/p&gt;

&lt;p&gt;I suggest to add a &quot;wait-with-timeout&quot; in the &lt;tt&gt;TestingLeaderElectionEventHandler#onGrantLeadership, #onRevokeLeadership, #onLeaderInformationChange&lt;/tt&gt; so that we have enough time for creating &lt;tt&gt;LeaderElectionDriver&lt;/tt&gt; and then &lt;tt&gt;init&lt;/tt&gt; the &lt;tt&gt;TestingLeaderElectionEventHandler&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
10:30:37,419 [Curator-LeaderLatch-0] WARN&#160; org.apache.flink.shaded.curator4.org.apache.curator.utils.ZKPaths [] - The version of ZooKeeper being used doesn&lt;span class=&quot;code-quote&quot;&gt;&apos;t support Container nodes. CreateMode.PERSISTENT will be used instead.10:30:37,419 [Curator-LeaderLatch-0] WARN&#160; org.apache.flink.shaded.curator4.org.apache.curator.utils.ZKPaths [] - The version of ZooKeeper being used doesn&apos;&lt;/span&gt;t support Container nodes. CreateMode.PERSISTENT will be used instead.10:30:37,468 [&#160; &#160; main-EventThread] ERROR org.apache.flink.shaded.curator4.org.apache.curator.framework.listen.ListenerContainer [] - Listener (ZooKeeperLeaderElectionDriver{leaderPath=&lt;span class=&quot;code-quote&quot;&gt;&apos;/leader&apos;&lt;/span&gt;}) threw an exceptionorg.apache.flink.util.FlinkRuntimeException: init() should be called first. at org.apache.flink.runtime.leaderelection.TestingLeaderElectionEventHandler.onGrantLeadership(TestingLeaderElectionEventHandler.java:46) ~[test-classes/:?] at org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionDriver.isLeader(ZooKeeperLeaderElectionDriver.java:158) ~[classes/:?] at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch$9.apply(LeaderLatch.java:693) ~[flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch$9.apply(LeaderLatch.java:689) ~[flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.listen.ListenerContainer$1.run(ListenerContainer.java:100) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.shaded.com.google.common.util.concurrent.DirectExecutor.execute(DirectExecutor.java:30) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.listen.ListenerContainer.forEach(ListenerContainer.java:92) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.setLeadership(LeaderLatch.java:688) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.checkLeadership(LeaderLatch.java:567) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch.access$700(LeaderLatch.java:65) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.recipes.leader.LeaderLatch$7.processResult(LeaderLatch.java:618) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorFrameworkImpl.sendToBackgroundCallback(CuratorFrameworkImpl.java:883) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorFrameworkImpl.processBackgroundOperation(CuratorFrameworkImpl.java:653) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.WatcherRemovalFacade.processBackgroundOperation(WatcherRemovalFacade.java:152) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.GetChildrenBuilderImpl$2.processResult(GetChildrenBuilderImpl.java:187) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:601) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0] at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:508) [flink-shaded-zookeeper-3-3.4.14-12.0.jar:3.4.14-12.0]10:33:58,379 [&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; main] INFO&#160; org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionDriver [] - Closing ZooKeeperLeaderElectionDriver{leaderPath=&lt;span class=&quot;code-quote&quot;&gt;&apos;/leader&apos;&lt;/span&gt;}10:33:58,383 [&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; main] INFO&#160; org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalDriver [] - Closing ZookeeperLeaderRetrievalDriver{retrievalPath=&lt;span class=&quot;code-quote&quot;&gt;&apos;/leader&apos;&lt;/span&gt;}.10:33:58,385 [ Curator-Framework-0] INFO&#160; org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorFrameworkImpl [] - backgroundOperationsLoop exiting10:33:58,388 [&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; main] INFO&#160; org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ZooKeeper [] - Session: 0x102de7dc7fc0000 closed10:33:58,389 [&#160; &#160; main-EventThread] INFO&#160; org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn [] - EventThread shut down &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; session: 0x102de7dc7fc000010:33:58,392 [&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; main] ERROR org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionTest [] -&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17228448" author="till.rohrmann" created="Mon, 9 Nov 2020 09:27:11 +0000"  >&lt;p&gt;I think introducing sleeps is not a reliable way of fixing this problem.&lt;/p&gt;</comment>
                            <comment id="17228477" author="till.rohrmann" created="Mon, 9 Nov 2020 10:04:01 +0000"  >&lt;p&gt;I think the underlying problem is that the &lt;tt&gt;TestingLeaderElectionEventHandler&lt;/tt&gt; tries to do too much. Concretely, writing the leader information via the &lt;tt&gt;LeaderElectionDriver&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I see two ways to solve the problem. Either, we use the &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt; whose task it is to write the leader information back or we introduce a &lt;tt&gt;start&lt;/tt&gt; method which we can use to start the &lt;tt&gt;LeaderElectionDriver&lt;/tt&gt;. That way, could initialize the &lt;tt&gt;TestingLeaderElectionEventHandler&lt;/tt&gt; before starting the driver.&lt;/p&gt;</comment>
                            <comment id="17228543" author="fly_in_gis" created="Mon, 9 Nov 2020 12:09:17 +0000"  >&lt;p&gt;I agree with you that &lt;tt&gt;TestingLeaderElectionEventHandler&lt;/tt&gt; could not be responsible for writing the leader information back to external storage(e.g. ZooKeeper, K8s ConfigMap). Then in some driver tests, we need to manually call the &lt;tt&gt;LeaderElectionDriver#writeLeaderInformation&lt;/tt&gt; so that the &lt;tt&gt;LeaderRetrievalDriver&lt;/tt&gt; could get the leader information.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Does it make sense to you? Or you still believe that we need to use the &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt; which could write back the leader information to external storage automatically.&lt;/p&gt;</comment>
                            <comment id="17228585" author="till.rohrmann" created="Mon, 9 Nov 2020 13:38:57 +0000"  >&lt;p&gt;Maybe it is also fine to simply block the &lt;tt&gt;onGrantLeadership&lt;/tt&gt; and &lt;tt&gt;revokeLeadership&lt;/tt&gt; until &lt;tt&gt;init&lt;/tt&gt; has been called.&lt;/p&gt;</comment>
                            <comment id="17228646" author="fly_in_gis" created="Mon, 9 Nov 2020 15:02:13 +0000"  >&lt;p&gt;Make sense to me.&lt;/p&gt;</comment>
                            <comment id="17228928" author="dian.fu" created="Tue, 10 Nov 2020 02:27:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=9361&amp;amp;view=logs&amp;amp;j=6bfdaf55-0c08-5e3f-a2d2-2a0285fd41cf&amp;amp;t=fd9796c3-9ce8-5619-781c-42f873e126a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=9361&amp;amp;view=logs&amp;amp;j=6bfdaf55-0c08-5e3f-a2d2-2a0285fd41cf&amp;amp;t=fd9796c3-9ce8-5619-781c-42f873e126a6&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17229114" author="till.rohrmann" created="Tue, 10 Nov 2020 10:31:18 +0000"  >&lt;p&gt;Fixed via 8a63e642911031d8cead43841d6af227dd54d1e8&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kdf4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>