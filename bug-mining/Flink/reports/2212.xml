<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8559] Exceptions in RocksDBIncrementalSnapshotOperation#takeSnapshot cause job to get stuck</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8559</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In the &lt;tt&gt;RocksDBKeyedStatebackend#snapshotIncrementally&lt;/tt&gt; we can find this code&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; RocksDBIncrementalSnapshotOperation&amp;lt;K&amp;gt; snapshotOperation =
	&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RocksDBIncrementalSnapshotOperation&amp;lt;&amp;gt;(
		&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;,
		checkpointStreamFactory,
		checkpointId,
		checkpointTimestamp);

snapshotOperation.takeSnapshot();

&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FutureTask&amp;lt;KeyedStateHandle&amp;gt;(
	&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Callable&amp;lt;KeyedStateHandle&amp;gt;() {
		@Override
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; KeyedStateHandle call() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; snapshotOperation.materializeSnapshot();
		}
	}
) {
	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; cancel(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; mayInterruptIfRunning) {
		snapshotOperation.stop();
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.cancel(mayInterruptIfRunning);
	}

	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void done() {
		snapshotOperation.releaseResources(isCancelled());
	}
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the constructor of RocksDBIncrementalSnapshotOperation we call &lt;tt&gt;aquireResource()&lt;/tt&gt; on the RocksDB &lt;tt&gt;ResourceGuard&lt;/tt&gt;. If &lt;tt&gt;snapshotOperation.takeSnapshot()&lt;/tt&gt; fails with an exception these resources are never released. When the task is shutdown due to the exception it will get stuck on releasing RocksDB.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13136247">FLINK-8559</key>
            <summary>Exceptions in RocksDBIncrementalSnapshotOperation#takeSnapshot cause job to get stuck</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="chesnay">Chesnay Schepler</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Feb 2018 10:49:23 +0000</created>
                <updated>Tue, 6 Feb 2018 21:28:20 +0000</updated>
                            <resolved>Tue, 6 Feb 2018 21:28:20 +0000</resolved>
                                    <version>1.4.0</version>
                    <version>1.5.0</version>
                                    <fixVersion>1.4.1</fixVersion>
                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16352344" author="githubbot" created="Mon, 5 Feb 2018 13:01:22 +0000"  >&lt;p&gt;GitHub user zentol opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5412&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5412&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8559&quot; title=&quot;Exceptions in RocksDBIncrementalSnapshotOperation#takeSnapshot cause job to get stuck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8559&quot;&gt;&lt;del&gt;FLINK-8559&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;RocksDB&amp;#93;&lt;/span&gt; Release resources if snapshot operation fails&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR ensures that RocksDB resources are released if `RocksDBIncrementalSnapshotOperation#takeSnapshot` throws an Exception.&lt;/p&gt;

&lt;p&gt;    We now catch the exception, cancel the SnapshotOperation, and re-throw the original exception.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    I&apos;ve verified this manually by running `JobManagerHACheckpointRecoveryITCase` on Windows where `takeSnapshot` fails due to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8557&quot; title=&quot;OperatorSubtaskDescriptionText causes failures on Windows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8557&quot;&gt;&lt;del&gt;FLINK-8557&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;    I couldn&apos;t come up with proper test. The method hardly does anything in the first place and every solution i could think of would depend a lot on implementation details (like mocking `Checkpoint.create()` to throw an exception).&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    @StefanRRichter &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zentol/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/flink&lt;/a&gt; 8559&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5412.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5412.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5412&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 05f0ff5e353117894af4ba7dc096c3256d80450b&lt;br/&gt;
Author: zentol &amp;lt;chesnay@...&amp;gt;&lt;br/&gt;
Date:   2018-02-05T12:15:29Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8559&quot; title=&quot;Exceptions in RocksDBIncrementalSnapshotOperation#takeSnapshot cause job to get stuck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8559&quot;&gt;&lt;del&gt;FLINK-8559&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;RocksDB&amp;#93;&lt;/span&gt; Release resources if snapshot operation fails&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16352354" author="githubbot" created="Mon, 5 Feb 2018 13:09:41 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5412&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5412&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    LGTM&lt;/p&gt;</comment>
                            <comment id="16352419" author="githubbot" created="Mon, 5 Feb 2018 14:06:44 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5412&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5412&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    merging.&lt;/p&gt;</comment>
                            <comment id="16353860" author="zentol" created="Tue, 6 Feb 2018 13:14:27 +0000"  >&lt;p&gt;1.4: c9322661ea7770a2119f51f19bcfd58dc481b4d4&lt;/p&gt;</comment>
                            <comment id="16354552" author="githubbot" created="Tue, 6 Feb 2018 21:25:50 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5412&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5412&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16354561" author="zentol" created="Tue, 6 Feb 2018 21:28:20 +0000"  >&lt;p&gt;master: dbb81acb5a1d0f2a9521c6eef7eeb2436bb8004d&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3psmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>