<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:40:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-13421] Unexpected ConcurrentModificationException when RM notifies JM about allocation failure</title>
                <link>https://issues.apache.org/jira/browse/FLINK-13421</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When a TM lost and RM identified it first, it will&#160;notify JM about it through&#160;JobMaster#notifyAllocationFailure.&lt;/p&gt;

&lt;p&gt;We observed&#160;unexpected&#160;ConcurrentModificationException in this process, stack as below:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Caused by: java.util.ConcurrentModificationException&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at java.util.HashMap$HashIterator.nextNode(HashMap.java:1437)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at java.util.HashMap$ValueIterator.next(HashMap.java:1466)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.flink.runtime.jobmaster.slotpool.SlotSharingManager$MultiTaskSlot.release(SlotSharingManager.java:477)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.flink.runtime.jobmaster.slotpool.AllocatedSlot.releasePayload(AllocatedSlot.java:149)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl.tryFailingAllocatedSlot(SlotPoolImpl.java:712)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl.failAllocation(SlotPoolImpl.java:692)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.flink.runtime.jobmaster.JobMaster.internalFailAllocation(JobMaster.java:538)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.flink.runtime.jobmaster.JobMaster.notifyAllocationFailure(JobMaster.java:664)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; ... 26 more&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This can cause an allocated slot to be removed from&#160;SlotPool#allocatedSlots but not all of its payload tasks get failed. Tasks may hang in scheduled forever, not able to fail or timeout, as in the attached log.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13246991">FLINK-13421</key>
            <summary>Unexpected ConcurrentModificationException when RM notifies JM about allocation failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="zhuzh">Zhu Zhu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 25 Jul 2019 07:59:22 +0000</created>
                <updated>Fri, 2 Aug 2019 13:16:15 +0000</updated>
                            <resolved>Fri, 2 Aug 2019 08:00:37 +0000</resolved>
                                    <version>1.9.0</version>
                                    <fixVersion>1.9.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16892573" author="zhuzh" created="Thu, 25 Jul 2019 09:10:16 +0000"  >&lt;p&gt;All job modification is happening in the main thread.&lt;/p&gt;

&lt;p&gt;Therefore the&#160;ConcurrentModificationException&#160;seems to happen due to&#160;MultiTaskSlot children getting changed in&#160;the&#160;MultiTaskSlot&apos;s releasing iteration&#160;loop.&lt;/p&gt;</comment>
                            <comment id="16892776" author="zhuzh" created="Thu, 25 Jul 2019 13:58:26 +0000"  >&lt;p&gt;I think I find the cause.&lt;/p&gt;

&lt;p&gt;ConcurrentModificationException happened in the children release loop in &lt;em&gt;&lt;b&gt;MultiTaskSlot#release&lt;/b&gt;&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;It happened because new slot allocations happened, adding a new&#160;child to the&#160;MultiTaskSlot, thus modified the &lt;b&gt;&lt;em&gt;children&lt;/em&gt;&lt;/b&gt; field.&lt;/p&gt;

&lt;p&gt;New slot allocations happened because a task failover is caused by a child slot&apos;s payload releasing. The failover canceled tasks and returned allocated slots to SlotPool. The returned allocated slots were assigned to some tasks that&#160;were not canceled yet. The slot assignment satisfies the &lt;em&gt;&lt;b&gt;input location preference constraints&lt;/b&gt;&lt;/em&gt; of some downstream tasks, and triggered the slot allocation of these tasks.&lt;/p&gt;

&lt;p&gt;To fix this, I think we&#160;may change&#160;&lt;em&gt;&lt;b&gt;MultiTaskSlot&lt;/b&gt;&lt;/em&gt;&#160;to be not available for slot&#160;allocation(in SlotSharingManager#listResolvedRootSlotInfo and SlotSharingManager#getUnresolvedRootSlot) when it is in &lt;em&gt;&lt;b&gt;releasingChildren&lt;/b&gt;&lt;/em&gt; state. Besides,&#160;changing &lt;em&gt;&lt;b&gt;MultiTaskSlot#release&lt;/b&gt;&lt;/em&gt;&#160;to not iterate on its &lt;em&gt;&lt;b&gt;children&lt;/b&gt;&lt;/em&gt; field directly&#160;would be&#160;better to avoid&#160;ConcurrentModificationException to happen in any case.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;, do you have any suggestion for it?&lt;/p&gt;</comment>
                            <comment id="16893396" author="till.rohrmann" created="Fri, 26 Jul 2019 07:17:46 +0000"  >&lt;p&gt;That is a good finding &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;. I need to take a closer look to verify your solution proposal.&lt;/p&gt;</comment>
                            <comment id="16893397" author="till.rohrmann" created="Fri, 26 Jul 2019 07:19:05 +0000"  >&lt;p&gt;Did you observe this while testing Flink or was it a test which failed?&lt;/p&gt;</comment>
                            <comment id="16893402" author="zhuzh" created="Fri, 26 Jul 2019 07:26:40 +0000"  >&lt;p&gt;We observed it when running stability test on Flink 1.9. The log is attached.&lt;/p&gt;</comment>
                            <comment id="16893646" author="till.rohrmann" created="Fri, 26 Jul 2019 09:16:49 +0000"  >&lt;p&gt;Thanks a lot for the investigation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;. I&apos;ve assigned the ticket to you.&lt;/p&gt;</comment>
                            <comment id="16894968" author="zhuzh" created="Mon, 29 Jul 2019 06:05:48 +0000"  >&lt;p&gt;Work in progress.&lt;/p&gt;</comment>
                            <comment id="16895929" author="till.rohrmann" created="Tue, 30 Jul 2019 09:01:36 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;, what&apos;s the state of this issue?&lt;/p&gt;</comment>
                            <comment id="16896835" author="zhuzh" created="Wed, 31 Jul 2019 07:11:59 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;, the PR is opened.&lt;/p&gt;

&lt;p&gt;The solution is a bit different&#160;from what was proposed.&lt;/p&gt;

&lt;p&gt;Only the&#160;SlotSharingManager#listResolvedRootSlotInfo is changed.&#160;SlotSharingManager#getUnresolvedRootSlot&#160;and MultiTaskSlot#release are not changed as they are&#160;not necessary&#160;or may cause some other inconsistency issues.&lt;/p&gt;</comment>
                            <comment id="16898682" author="till.rohrmann" created="Fri, 2 Aug 2019 08:00:37 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.10.0: 38411298a2fa71194cd7d81405ee8f6b069f377f&lt;br/&gt;
1.9.0: ed38718a9b6b1fd55cf2107821813272083a4b63&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12975771" name="jm_concurrentmodification.log" size="455745" author="zhuzh" created="Thu, 25 Jul 2019 08:34:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 15 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04lwy:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>