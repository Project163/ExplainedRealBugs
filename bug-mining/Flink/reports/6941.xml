<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:16:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-29816] Fix the bug that StreamTask doesn&apos;t handle exception during restoring</title>
                <link>https://issues.apache.org/jira/browse/FLINK-29816</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;h4&gt;&lt;a name=&quot;1.Howtorepeat%C2%A0&quot;&gt;&lt;/a&gt;1. How to repeat&#160;&lt;/h4&gt;

&lt;p&gt;ProcessWindowFunction, and make some exception in process()&lt;br/&gt;
test code&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        env.setParallelism(1);
        env.enableCheckpointing(60 * 1000);
        env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);
        env.getCheckpointConfig().setCheckpointTimeout(60000);

        KafkaSource&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; kafkaConsumer = KafkaSource.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;builder()
                .setBootstrapServers(&lt;span class=&quot;code-quote&quot;&gt;&quot;****&quot;&lt;/span&gt;)
                .setTopics(&lt;span class=&quot;code-quote&quot;&gt;&quot;****&quot;&lt;/span&gt;)
                .setGroupId(&lt;span class=&quot;code-quote&quot;&gt;&quot;****&quot;&lt;/span&gt;)
                .setValueOnlyDeserializer(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleStringSchema())
                .setStartingOffsets(OffsetsInitializer.earliest())
                .build();

        DataStreamSource&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; kafkaSource = env.fromSource(kafkaConsumer, WatermarkStrategy.noWatermarks(), &lt;span class=&quot;code-quote&quot;&gt;&quot;Kafka Source&quot;&lt;/span&gt;);

        SingleOutputStreamOperator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; mapSourse = kafkaSource.keyBy(s -&amp;gt; s).window(TumblingProcessingTimeWindows.of(Time.seconds(15)))
                .process(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProcessWindowFunction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, TimeWindow&amp;gt;() {
                    @Override
                    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void process(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s, ProcessWindowFunction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, TimeWindow&amp;gt;.Context context, Iterable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; iterable, Collector&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; collector) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                        &lt;span class=&quot;code-comment&quot;&gt;//when process event:&lt;span class=&quot;code-quote&quot;&gt;&quot;abc&quot;&lt;/span&gt; .It causes java.lang.NumberFormatException
&lt;/span&gt;                        &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; intS = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.valueOf(s);
                        collector.collect(s);
                    }
                })
                .name(&lt;span class=&quot;code-quote&quot;&gt;&quot;name-process&quot;&lt;/span&gt;).uid(&lt;span class=&quot;code-quote&quot;&gt;&quot;uid-process&quot;&lt;/span&gt;);

        mapSourse.print();
        env.execute();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;kafka input event&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt;1
&amp;gt;1
&amp;gt;2
&amp;gt;2
&amp;gt;3
&amp;gt;3
&amp;gt;abc
&amp;gt;abc
&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h4&gt;&lt;a name=&quot;2.faultphenomena&quot;&gt;&lt;/a&gt;2. fault phenomena&lt;/h4&gt;

&lt;p&gt;when job process the event:&quot;abc&quot;,It will cause java.lang.NumberFormatException and failover ,Then attempt and failover continuously.&lt;br/&gt;
However, it only failover 2 times(attempt 0, attempt 1) and when attempt for third time, It work normally, and no exception&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13051641/13051641_image-2022-10-31-19-54-12-546.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;checkpoint 1&#160; complete in attempt 1,before failover exception 1&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-10-31 16:59:53,644 INFO org.apache.flink.runtime.checkpoint.CheckpointCoordinator [] - Triggering checkpoint 1 (type=CHECKPOINT) @ 1667206793605 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 7bca78a75b089d447bb4c99efcfd6527.2022-10-31 16:59:54,010 INFO org.apache.flink.runtime.checkpoint.CheckpointCoordinator [] - Completed checkpoint 1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 7bca78a75b089d447bb4c99efcfd6527 (21630 bytes, checkpointDuration=333 ms, finalizationTime=72 ms).  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;attempt 2 was restore from checkpoint&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-10-31 17:00:30,033 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Restoring job 7bca78a75b089d447bb4c99efcfd6527 from Checkpoint 1 @ 1667206793605 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 7bca78a75b089d447bb4c99efcfd6527 located at hdfs:&lt;span class=&quot;code-comment&quot;&gt;//eadhadoop/user/sloth/sloth-fs-checkpoints/meta/1_7/7bca78a75b089d447bb4c99efcfd6527/chk-1.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;3.possiblereasons&quot;&gt;&lt;/a&gt;3. possible reasons&lt;/h4&gt;

&lt;p&gt;during attempt 2 , task restore from checkpoint, userfunction in ProcessWindowFunction was called in SteamTask.restore and produce &quot;java.lang.NumberFormatException&quot;, However, SteamTask catch exception and didn&apos;t handle exception because subtask is not in RUNNING state.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;the stack trace in attempt 2&lt;/b&gt;&lt;br/&gt;
user function was called in SteamTask.restore(subtask state is INITIALIZING)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.getStackTrace(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1552)
com.youdao.analysis.KafkaCheckpointWindowProcessTest$1.process(KafkaCheckpointWindowProcessTest.java:45)
com.youdao.analysis.KafkaCheckpointWindowProcessTest$1.process(KafkaCheckpointWindowProcessTest.java:40)
org.apache.flink.streaming.runtime.operators.windowing.functions.InternalIterableProcessWindowFunction.process(InternalIterableProcessWindowFunction.java:57)
org.apache.flink.streaming.runtime.operators.windowing.functions.InternalIterableProcessWindowFunction.process(InternalIterableProcessWindowFunction.java:32)
org.apache.flink.streaming.runtime.operators.windowing.WindowOperator.emitWindowContents(WindowOperator.java:568)
org.apache.flink.streaming.runtime.operators.windowing.WindowOperator.onProcessingTime(WindowOperator.java:524)
org.apache.flink.streaming.api.operators.InternalTimerServiceImpl.onProcessingTime(InternalTimerServiceImpl.java:284)
org.apache.flink.streaming.runtime.tasks.StreamTask.invokeProcessingTimeCallback(StreamTask.java:1693)
org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$22(StreamTask.java:1684)
org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.runThrowing(StreamTaskActionExecutor.java:50)
org.apache.flink.streaming.runtime.tasks.mailbox.Mail.run(Mail.java:90)
org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.processMailsNonBlocking(MailboxProcessor.java:353)
org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.processMail(MailboxProcessor.java:317)
org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:201)
org.apache.flink.streaming.runtime.tasks.StreamTask.restoreInternal(StreamTask.java:690)
org.apache.flink.streaming.runtime.tasks.StreamTask.restore(StreamTask.java:654)
org.apache.flink.runtime.taskmanager.Task.runWithSystemExitMonitoring(Task.java:958)
org.apache.flink.runtime.taskmanager.Task.restoreAndInvoke(Task.java:927)
org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:766)
org.apache.flink.runtime.taskmanager.Task.run(Task.java:575)
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;stack trace(which cause failover) in attempt 0 and attempt 1&lt;br/&gt;
user function was called in SteamTask.invoke&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
com.youdao.analysis.KafkaCheckpointWindowProcessTest$1.process(KafkaCheckpointWindowProcessTest.java:45)
com.youdao.analysis.KafkaCheckpointWindowProcessTest$1.process(KafkaCheckpointWindowProcessTest.java:40)
org.apache.flink.streaming.runtime.operators.windowing.functions.InternalIterableProcessWindowFunction.process(InternalIterableProcessWindowFunction.java:57)
org.apache.flink.streaming.runtime.operators.windowing.functions.InternalIterableProcessWindowFunction.process(InternalIterableProcessWindowFunction.java:32)
org.apache.flink.streaming.runtime.operators.windowing.WindowOperator.emitWindowContents(WindowOperator.java:568)
org.apache.flink.streaming.runtime.operators.windowing.WindowOperator.onProcessingTime(WindowOperator.java:524)
org.apache.flink.streaming.api.operators.InternalTimerServiceImpl.onProcessingTime(InternalTimerServiceImpl.java:284)
org.apache.flink.streaming.runtime.tasks.StreamTask.invokeProcessingTimeCallback(StreamTask.java:1693)
org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$22(StreamTask.java:1684)
org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.runThrowing(StreamTaskActionExecutor.java:50)
org.apache.flink.streaming.runtime.tasks.mailbox.Mail.run(Mail.java:90)
org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.processMailsWhenDefaultActionUnavailable(MailboxProcessor.java:338)
org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.processMail(MailboxProcessor.java:324)
org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:201)
org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:809)
org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:761)
org.apache.flink.runtime.taskmanager.Task.runWithSystemExitMonitoring(Task.java:958)
org.apache.flink.runtime.taskmanager.Task.restoreAndInvoke(Task.java:937)
org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:766)
org.apache.flink.runtime.taskmanager.Task.run(Task.java:575)
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in org.apache.flink.streaming.runtime.tasks.StreamTask handleAsyncException&lt;br/&gt;
SteamTask only handleAsyncException when is Running==true&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L1540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L1540&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void handleAsyncException(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; message, Throwable exception) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isRunning) {
            &lt;span class=&quot;code-comment&quot;&gt;// only fail &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the task is still running
&lt;/span&gt;            asyncExceptionHandler.handleAsyncException(message, exception);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but during restore,isRunning==false&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L673&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L673&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So during Steam.restore, SteamTask skip exception in userfunction of ProcessWindowFunction.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;%C2%A0&quot;&gt;&lt;/a&gt;&#160;&lt;/h4&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13493754">FLINK-29816</key>
            <summary>Fix the bug that StreamTask doesn&apos;t handle exception during restoring</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="RocMarshal">RocMarshal</assignee>
                                    <reporter username="xieyi">Xie Yi</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 31 Oct 2022 12:52:57 +0000</created>
                <updated>Tue, 10 Oct 2023 08:11:20 +0000</updated>
                            <resolved>Mon, 27 Feb 2023 15:31:06 +0000</resolved>
                                    <version>1.17.0</version>
                    <version>1.15.3</version>
                    <version>1.16.1</version>
                                    <fixVersion>1.17.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17627061" author="weijie guo" created="Tue, 1 Nov 2022 10:18:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xieyi&quot; class=&quot;user-hover&quot; rel=&quot;xieyi&quot;&gt;xieyi&lt;/a&gt; Thanks for reporting this, which version of flink do you use when you encounter this problems? And did you use unalignCheckpoint?&lt;/p&gt;</comment>
                            <comment id="17627420" author="xieyi" created="Wed, 2 Nov 2022 02:23:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt;&#160; I didn&apos;t use unalignCheckpoint, I had test flink 1.14.0, 1.15.2, 1.16.0,&#160; All of the version can repeat the problem.&lt;/p&gt;</comment>
                            <comment id="17627428" author="xieyi" created="Wed, 2 Nov 2022 02:48:28 +0000"  >&lt;p&gt;I also found some phenomenon&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;1.userfunctionin%C2%A0%C2%A0ProcessWindowFunctionwascalledduringSteamTask.restore%2CbecauseMailboxProcessoreisdoingMail%28%22Timercallbackfororg.apache.flink.streaming.api.operators.InternalTimerServiceImpl%22%29&quot;&gt;&lt;/a&gt;1. userfunction in&#160; &#160;ProcessWindowFunction was called during SteamTask.restore, because MailboxProcessore is doing Mail(&quot;Timer callback for org.apache.flink.streaming.api.operators.InternalTimerServiceImpl&quot;)&lt;/h4&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;here is the Timer callback for &apos;1667358089999&apos;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13051692/13051692_image-2022-11-02-11-06-37-925.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;%C2%A02.The%C2%A0Mail%28%22Timercallbackfororg.apache.flink.streaming.api.operators.InternalTimerServiceImpl%22%29wasputinMailbioxduringrestoreGatesandinitializeStateAndOpenOperators&quot;&gt;&lt;/a&gt;&#160;2. The&#160; Mail (&quot;Timer callback for org.apache.flink.streaming.api.operators.InternalTimerServiceImpl&quot;) was put in Mailbiox during restoreGates and initializeStateAndOpenOperators&lt;/h4&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Timer callback for &apos;1667358089999&apos; was put in Mailbox, because during&#160;restoreGates and initializeStateAndOpenOperators, register timer &apos;1667358089999&apos;(it seems restored from state)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13051691/13051691_image-2022-11-02-11-10-25-508.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17627442" author="weijie guo" created="Wed, 2 Nov 2022 03:14:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xieyi&quot; class=&quot;user-hover&quot; rel=&quot;xieyi&quot;&gt;xieyi&lt;/a&gt; Yes,This phenomenon is normal. When restoring, the mailbox is working, which means that the recovered channel can process data normally . The key to the problem is that only after all channels are recovered, the StreamTask will become the running state, but all exceptions will be caught when the processFunction callback executes, and will only be thrown when the running state is reached.&lt;/p&gt;</comment>
                            <comment id="17627450" author="weijie guo" created="Wed, 2 Nov 2022 03:57:58 +0000"  >&lt;ol&gt;
	&lt;li&gt;Because the restored channel can work normally in this stage, and the registerTimer is part of the working logic of the windowOperator. If I remember correctly, the defaultAction of mailbox (the logic that the operator actually processes data) will not be run in the state recovery phase before the introduction of unaligned checkpoint. But the current implementation is that no matter whether unaligned checkpoint is enabled or not, it will undergo a transformation from recoveredInputChannel -&amp;gt;normal InputChannel, which brings some confusions.&lt;/li&gt;
	&lt;li&gt;This is exactly the workflow of window operator. We will register timers to trigger window calculation(including user function) when they are out of date. And we expect execute these callback in mailbox thread.&lt;/li&gt;
	&lt;li&gt;I still need to think about the solution to the problem that the error was swallowed in the recovery phase.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17635247" author="kevin.cyj" created="Thu, 17 Nov 2022 09:43:11 +0000"  >&lt;p&gt;Any update on this issue?&lt;/p&gt;</comment>
                            <comment id="17691132" author="rocmarshal" created="Mon, 20 Feb 2023 10:57:43 +0000"  >&lt;p&gt;hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt; Any process on this issue ?&#160;&lt;/p&gt;</comment>
                            <comment id="17691137" author="weijie guo" created="Mon, 20 Feb 2023 11:14:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=RocMarshal&quot; class=&quot;user-hover&quot; rel=&quot;RocMarshal&quot;&gt;RocMarshal&lt;/a&gt; Thanks for the reminder. TBH, I don&apos;t have time to do this asap, feel free to take over this if you want.&lt;/p&gt;</comment>
                            <comment id="17691339" author="rocmarshal" created="Tue, 21 Feb 2023 02:27:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt; thanks for the reply.&lt;br/&gt;
I&apos;m interested in it. May I get the ticket ?&lt;br/&gt;
IMO, before starting the process, we need sort out the `handleAsyncException` mechanism &amp;amp; state-switch of `SteamTask`&#160;&lt;/p&gt;</comment>
                            <comment id="17691341" author="weijie guo" created="Tue, 21 Feb 2023 02:37:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=RocMarshal&quot; class=&quot;user-hover&quot; rel=&quot;RocMarshal&quot;&gt;RocMarshal&lt;/a&gt; You are assigned.&lt;/p&gt;</comment>
                            <comment id="17692057" author="rocmarshal" created="Wed, 22 Feb 2023 09:31:31 +0000"  >&lt;p&gt;As described in the historical comments and description text,&lt;/p&gt;

&lt;p&gt;The exceptions happen to `StreamTask` during the `restore()` was ignored by `asyncExceptionHandler`.&lt;br/&gt;
At the `Execution` side, it is possible to enter the {@code FAILED} state from any other state described at `ExecutionState` class. However, here&apos;s no `isInitializing` flag or `Initializing` state in StreamTask.&lt;br/&gt;
We can deal the issue with the state rule of `ExecutionState`.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Introduce is `isInitializing` flag for `StreamTask` in order to help `asyncExceptionHandler` judge handle branch. &#160; It is worth noting that such an approach would result in two adjacent states where it is unsafe to change the value of the flags, and we can only rely on overlapping boundary conditions to ensure that exceptions can be handled&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13055722/13055722_image-2023-02-22-17-26-06-200.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;


&lt;ul&gt;
	&lt;li&gt;Or we can introduce a State Enum for `StreamTask` like `ExecutionState`, If so, we should ensure that the state introduced is simple and overrides the current StreamTask state transition as a basic standard, &#160;and the security of state transitions(thread-safe).&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Please let me know what&apos;s your opinon. Thanks so much~&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xieyi&quot; class=&quot;user-hover&quot; rel=&quot;xieyi&quot;&gt;xieyi&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17692108" author="weijie guo" created="Wed, 22 Feb 2023 10:32:12 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=RocMarshal&quot; class=&quot;user-hover&quot; rel=&quot;RocMarshal&quot;&gt;RocMarshal&lt;/a&gt; for your analysis. It is a good proposal to change the state of `StreamTask` to enumeration. I have a look at the recently active tickets and just found &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13871&quot; title=&quot;Consolidate isRunning, canceled, isFinished fields in StreamTask and SourceStreamTask&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13871&quot;&gt;FLINK-13871&lt;/a&gt; seems to be doing the same thing.&lt;/p&gt;</comment>
                            <comment id="17692203" author="fanrui" created="Wed, 22 Feb 2023 13:56:19 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=RocMarshal&quot; class=&quot;user-hover&quot; rel=&quot;RocMarshal&quot;&gt;RocMarshal&lt;/a&gt; , thanks for your analysis and PR.&lt;/p&gt;

&lt;p&gt;StreamTask should `handleAsyncException` during initializing, so introducing isInitializing can solve this bug. But it makes the state of StreamTask difficult to maintain.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akalashnikov&quot; class=&quot;user-hover&quot; rel=&quot;akalashnikov&quot;&gt;akalashnikov&lt;/a&gt; , nice to see TaskState introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13871&quot; title=&quot;Consolidate isRunning, canceled, isFinished fields in StreamTask and SourceStreamTask&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13871&quot;&gt;FLINK-13871&lt;/a&gt; to improve the state of StreamTask.&lt;/p&gt;

&lt;p&gt;I recommend fixing the bug before refactoring the state machine for two reasons:&lt;br/&gt;
1. After the introduction of initializing, the state of TaskState will become more complicated, and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13871&quot; title=&quot;Consolidate isRunning, canceled, isFinished fields in StreamTask and SourceStreamTask&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13871&quot;&gt;FLINK-13871&lt;/a&gt; will do more thought when designing TaskState. If we design TaskState first, not sure if it will be easily compatible with initializing in the future.&lt;br/&gt;
2. Fix bugs before refactoring the state machine, it will be easier to backport the bugfix to 1.16 and 1.17.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="17692227" author="weijie guo" created="Wed, 22 Feb 2023 14:56:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt; If we prefer to fix it in the first way (that is, without introducing state enumeration), I agree to fix it before refactoring. But before starting this work, we&apos;d better make sure that all participants in `&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-13871&quot; title=&quot;Consolidate isRunning, canceled, isFinished fields in StreamTask and SourceStreamTask&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-13871&quot;&gt;FLINK-13871&lt;/a&gt;` knows this in advance or even directly participates in the code review, which will be more conducive to their overall control of the state machine design.&lt;/p&gt;</comment>
                            <comment id="17692250" author="fanrui" created="Wed, 22 Feb 2023 15:39:53 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt; , thanks for your reminder. I have requested them, and I can go ahead after they agree.&#160;&lt;/p&gt;

&lt;p&gt;Anyway, I don&apos;t have strong opinion about which PR is merged first.&lt;/p&gt;</comment>
                            <comment id="17693756" author="fanrui" created="Mon, 27 Feb 2023 02:24:47 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=RocMarshal&quot; class=&quot;user-hover&quot; rel=&quot;RocMarshal&quot;&gt;RocMarshal&lt;/a&gt; for your contribution, and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akalashnikov&quot; class=&quot;user-hover&quot; rel=&quot;akalashnikov&quot;&gt;akalashnikov&lt;/a&gt; for the discussion and review&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Merged commit &lt;a href=&quot;https://github.com/apache/flink/commit/a98bb9a6c978d5458cf4cc11dc7b68034f4def4b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a98bb9a6c978d5458cf4cc11dc7b68034f4def4b&lt;/a&gt; into apache:master&lt;/p&gt;</comment>
                            <comment id="17694062" author="weijie guo" created="Mon, 27 Feb 2023 14:49:51 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt; for merging this to master.&lt;/p&gt;

&lt;p&gt;All the commits are as follows:&lt;br/&gt;
master 1.18 via a98bb9a6c978d5458cf4cc11dc7b68034f4def4b.&lt;br/&gt;
release 1.17 via 65e455189d2a88fd62be2e8a464feab4687ee088.&lt;br/&gt;
release 1.16 via 2f0df8076cff97b579f739b9605d32704c428213.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13515732">FLINK-30511</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13051642" name="image-2022-10-31-19-49-52-432.png" size="82710" author="xieyi" created="Mon, 31 Oct 2022 11:49:54 +0000"/>
                            <attachment id="13051641" name="image-2022-10-31-19-54-12-546.png" size="222599" author="xieyi" created="Mon, 31 Oct 2022 11:54:15 +0000"/>
                            <attachment id="13051687" name="image-2022-11-02-10-42-21-099.png" size="653795" author="xieyi" created="Wed, 2 Nov 2022 02:42:25 +0000"/>
                            <attachment id="13051688" name="image-2022-11-02-10-57-08-064.png" size="657459" author="xieyi" created="Wed, 2 Nov 2022 02:57:11 +0000"/>
                            <attachment id="13051692" name="image-2022-11-02-11-06-37-925.png" size="716104" author="xieyi" created="Wed, 2 Nov 2022 03:06:40 +0000"/>
                            <attachment id="13051691" name="image-2022-11-02-11-10-25-508.png" size="799515" author="xieyi" created="Wed, 2 Nov 2022 03:10:29 +0000"/>
                            <attachment id="13055722" name="image-2023-02-22-17-26-06-200.png" size="387882" author="RocMarshal" created="Wed, 22 Feb 2023 09:26:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 37 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1an60:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>