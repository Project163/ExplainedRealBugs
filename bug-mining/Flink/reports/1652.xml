<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6078] ZooKeeper based high availability services should not close the underlying CuratorFramework</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6078</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;ZooKeeper based high availability tools like &lt;tt&gt;ZooKeeperLeaderRetrievalService&lt;/tt&gt; and &lt;tt&gt;ZooKeeperLeaderElectionService&lt;/tt&gt; expect that every instance of the services have a dedicated &lt;tt&gt;CuratorFramework&lt;/tt&gt; instance assigned. Thus, they also close this &lt;tt&gt;CuratorFramework&lt;/tt&gt; when the service is closed. This does not play well along with the newly introduced &lt;tt&gt;HighAvailabilityServices&lt;/tt&gt; which caches a single &lt;tt&gt;CuratorFramework&lt;/tt&gt; and shares it among all created services. In order to make it work properly together I propose to change the behaviour such that we no longer close the &lt;tt&gt;CuratorFramework&lt;/tt&gt; clients in the ZooKeeper based services.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13056687">FLINK-6078</key>
            <summary>ZooKeeper based high availability services should not close the underlying CuratorFramework</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Mar 2017 14:50:28 +0000</created>
                <updated>Wed, 10 May 2017 13:52:54 +0000</updated>
                            <resolved>Fri, 5 May 2017 11:49:59 +0000</resolved>
                                    <version>1.3.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15984840" author="githubbot" created="Wed, 26 Apr 2017 13:49:40 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3781&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6078&quot; title=&quot;ZooKeeper based high availability services should not close the underlying CuratorFramework&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6078&quot;&gt;&lt;del&gt;FLINK-6078&lt;/del&gt;&lt;/a&gt; Remove CuratorFramework#close calls from ZooKeeper based HA services&lt;/p&gt;

&lt;p&gt;    This PR is based on #3622.&lt;/p&gt;

&lt;p&gt;    The main goal of this PR is to prevent the ZooKeeper based leader election and retrieval services from closing the underlying `CuratorFramework` instance when a election/retrieval service is closed. This will allow to share a single `CuratorFramework` instance among multiple election/retrieval services. This is a strict requirement for the Flip-6 work where all election/retrieval services are created by a `HighAvailabilityServices` implementation which shares the `CuratorFramework` among the created services. The respective changes can be found in the `ZooKeeperLeader&lt;span class=&quot;error&quot;&gt;&amp;#91;Election, Retrieval&amp;#93;&lt;/span&gt;Service` classes.&lt;/p&gt;

&lt;p&gt;    In the existing code we now use as well an instance of `HighAvailabilityServices` in order to create the election/retrieval services and to manage the `CuratorFramework` instances. The respective changes are contained in `JobManager.scala:2036`, `TaskManager.scala:1643`, `MesosApplicationMasterRunner.java:299` and `YarnApplicationMasterRunner.java:343`. &lt;/p&gt;

&lt;p&gt;    In order to create `Leader&lt;span class=&quot;error&quot;&gt;&amp;#91;Retrieval, Election&amp;#93;&lt;/span&gt;Services` for the `JobManager`, we need to provide a `JobID` to the `HighAvailabilityServices`. Since there is no such `JobID` defined a priori for a `JobManager`, we have introduced the `HighAvailabilityServices.DEFAULT_JOB_ID` which is to be used with the old distributed components.&lt;/p&gt;

&lt;p&gt;    We also changed the `FlinkMiniCluster` to use the `EmbeddedHaServices` or the `ZooKeeperHaServices` in case of HA. The former service has HA like capabilities which allow to dynamically elect new leaders and notify retrievers about these changes. This allows to write better integration tests. The downside is that we can no longer connect via a `RemoteExecutionEnvironment` to a `FlinkMiniCluster`, because there is no way to obtain the current leader session id remotely. In order to execute Flink jobs on the `FlinkMiniCluster`, we have extended the `TestEnvironment` and the `TestStreamEnvironment` to be used in combination with the changed `FlinkMiniCluster`.&lt;/p&gt;

&lt;p&gt;    Most of the remaining changes adapt test cases to use the `EmbeddedHaServices` or to work with the changed `FlinkMiniCluster` implementation.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; refactorZooKeeperServices&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3781.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3781.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3781&lt;/p&gt;

&lt;hr /&gt;

&lt;hr /&gt;</comment>
                            <comment id="15994715" author="githubbot" created="Wed, 3 May 2017 11:58:56 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3781&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Good set of changes. I looked more deeply over the non-test code and the Kafka test code. Both look good.&lt;/p&gt;

&lt;p&gt;    The remaining tests look like a pretty straightforward replacement of `RemoteEnvironment` by `TestEnvironment` and integration of `HaServices` into the ITCases.&lt;/p&gt;

&lt;p&gt;    +1 from my side&lt;/p&gt;
</comment>
                            <comment id="15994724" author="githubbot" created="Wed, 3 May 2017 12:05:51 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3781&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @StephanEwen. I will rebase the PR on the latest master and if Travis gives green light, then I&apos;ll merge it.&lt;/p&gt;</comment>
                            <comment id="15998214" author="githubbot" created="Fri, 5 May 2017 11:49:15 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3781&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15998221" author="till.rohrmann" created="Fri, 5 May 2017 11:49:59 +0000"  >&lt;p&gt;Fixed via ddd6a99a95b56c52ea5b5153b7270b578f5479bc&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13059309">FLINK-6192</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13059309">FLINK-6192</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3cde7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>