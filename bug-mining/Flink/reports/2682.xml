<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10491] Deadlock during spilling data in SpillableSubpartition </title>
                <link>https://issues.apache.org/jira/browse/FLINK-10491</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Originally reported here:&#160;&lt;a href=&quot;https://lists.apache.org/thread.html/472c8f4a2711c5e217fadd9a88f8c73670218e7432bb81ba3f5076db@%3Cuser.flink.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/472c8f4a2711c5e217fadd9a88f8c73670218e7432bb81ba3f5076db@%3Cuser.flink.apache.org%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thread dump (from 1.5.3 version) showing two deadlocked threads, because they are taking two locks in different order:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Thread-1
&quot;DataSink (DATA#HadoopFileOutputFormat ) (1/2)@11002&quot; prio=5 tid=0x3e2 nid=NA waiting for monitor entry
waiting for Map (Key Extractor) (1/10)@9967 to release lock on &amp;lt;0x2dfb&amp;gt; (a java.util.ArrayDeque)
at org.apache.flink.runtime.io.network.partition.SpillableSubpartition.releaseMemory(SpillableSubpartition.java:223)
at org.apache.flink.runtime.io.network.partition.ResultPartition.releaseMemory(ResultPartition.java:373)
at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.setNumBuffers(LocalBufferPool.java:355)
- locked &amp;lt;0x2dfd&amp;gt; (a java.util.ArrayDeque)
at org.apache.flink.runtime.io.network.buffer.NetworkBufferPool.redistributeBuffers(NetworkBufferPool.java:402)
at org.apache.flink.runtime.io.network.buffer.NetworkBufferPool.recycleMemorySegments(NetworkBufferPool.java:203)
- locked &amp;lt;0x2da5&amp;gt; (a java.lang.Object)
at org.apache.flink.runtime.io.network.buffer.NetworkBufferPool.recycleMemorySegments(NetworkBufferPool.java:193)
at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.returnExclusiveSegments(SingleInputGate.java:318)
at org.apache.flink.runtime.io.network.partition.consumer.RemoteInputChannel.releaseAllResources(RemoteInputChannel.java:259)
at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.getNextBufferOrEvent(SingleInputGate.java:578)
at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.pollNextBufferOrEvent(SingleInputGate.java:507)
at org.apache.flink.runtime.io.network.partition.consumer.UnionInputGate.waitAndGetNextInputGate(UnionInputGate.java:213)
at org.apache.flink.runtime.io.network.partition.consumer.UnionInputGate.getNextBufferOrEvent(UnionInputGate.java:163)
at org.apache.flink.runtime.io.network.api.reader.AbstractRecordReader.getNextRecord(AbstractRecordReader.java:86)
at org.apache.flink.runtime.io.network.api.reader.MutableRecordReader.next(MutableRecordReader.java:47)
at org.apache.flink.runtime.operators.util.ReaderIterator.next(ReaderIterator.java:73)
at org.apache.flink.runtime.operators.DataSinkTask.invoke(DataSinkTask.java:216)
at org.apache.flink.runtime.taskmanager.Task.run(Task.java:703)
at java.lang.Thread.run(Thread.java:745)


Thread-2
&quot;Map (Key Extractor) (1/10)@9967&quot; prio=5 tid=0xaab nid=NA waiting for monitor entry
java.lang.Thread.State: BLOCKED
blocks DataSink (DATA#HadoopFileOutputFormat ) (1/2)@11002
waiting for DataSink (DATA#HadoopFileOutputFormat ) (1/2)@11002 to release lock on &amp;lt;0x2dfd&amp;gt; (a java.util.ArrayDeque)
at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.recycle(LocalBufferPool.java:261)
at org.apache.flink.runtime.io.network.buffer.NetworkBuffer.deallocate(NetworkBuffer.java:171)
at org.apache.flink.shaded.netty4.io.netty.buffer.AbstractReferenceCountedByteBuf.release(AbstractReferenceCountedByteBuf.java:106)
at org.apache.flink.runtime.io.network.buffer.NetworkBuffer.recycleBuffer(NetworkBuffer.java:146)
at org.apache.flink.runtime.io.network.buffer.BufferConsumer.close(BufferConsumer.java:110)
at org.apache.flink.runtime.io.network.partition.SpillableSubpartition.spillFinishedBufferConsumers(SpillableSubpartition.java:271)
at org.apache.flink.runtime.io.network.partition.SpillableSubpartition.add(SpillableSubpartition.java:117)
- locked &amp;lt;0x2dfb&amp;gt; (a java.util.ArrayDeque)
at org.apache.flink.runtime.io.network.partition.SpillableSubpartition.add(SpillableSubpartition.java:96)
- locked &amp;lt;0x2dfc&amp;gt; (a org.apache.flink.runtime.io.network.partition.SpillableSubpartition)
at org.apache.flink.runtime.io.network.partition.ResultPartition.addBufferConsumer(ResultPartition.java:255)
at org.apache.flink.runtime.io.network.api.writer.RecordWriter.requestNewBufferBuilder(RecordWriter.java:211)
at org.apache.flink.runtime.io.network.api.writer.RecordWriter.sendToTarget(RecordWriter.java:142)
at org.apache.flink.runtime.io.network.api.writer.RecordWriter.emit(RecordWriter.java:105)
at org.apache.flink.runtime.operators.shipping.OutputCollector.collect(OutputCollector.java:65)
at org.apache.flink.runtime.operators.util.metrics.CountingCollector.collect(CountingCollector.java:35)
at org.apache.flink.runtime.operators.MapDriver.run(MapDriver.java:103)
at org.apache.flink.runtime.operators.BatchTask.run(BatchTask.java:503)
at org.apache.flink.runtime.operators.BatchTask.invoke(BatchTask.java:368)
at org.apache.flink.runtime.taskmanager.Task.run(Task.java:703)
at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The same pattern can occur on the master (but with slightly shifted line numbers)&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=NicoK&quot; class=&quot;user-hover&quot; rel=&quot;NicoK&quot;&gt;NicoK&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13189429">FLINK-10491</key>
            <summary>Deadlock during spilling data in SpillableSubpartition </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zjwang">Zhijiang</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 4 Oct 2018 13:40:05 +0000</created>
                <updated>Tue, 23 Oct 2018 13:57:02 +0000</updated>
                            <resolved>Tue, 23 Oct 2018 13:57:02 +0000</resolved>
                                    <version>1.5.4</version>
                    <version>1.6.1</version>
                                    <fixVersion>1.5.6</fixVersion>
                    <fixVersion>1.6.3</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16641481" author="zjwang" created="Mon, 8 Oct 2018 07:54:34 +0000"  >&lt;p&gt;I think we can set the &lt;tt&gt;BufferPoolOwner&lt;/tt&gt; in the construction of &lt;tt&gt;LocalBufferPool&lt;/tt&gt; and then remove the &lt;tt&gt;owner#releaseMemory&lt;/tt&gt; outside of&#160;the&#160;&lt;tt&gt;synchronized&lt;/tt&gt; part in &lt;tt&gt;LocalBufferPool#setNumBuffers&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Or we can make some improvements to narrow the lock zone in &lt;tt&gt;SpillableSubpartition#releaseMemory&lt;/tt&gt; to solve the deadlock issue.&lt;/p&gt;

&lt;p&gt;I can help to handle this issue if needed. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=NicoK&quot; class=&quot;user-hover&quot; rel=&quot;NicoK&quot;&gt;NicoK&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16643057" author="pnowojski" created="Tue, 9 Oct 2018 09:43:55 +0000"  >&lt;p&gt;&amp;gt;&#160;Or we can make some improvements to narrow the lock zone in&#160;&lt;tt&gt;SpillableSubpartition#releaseMemory&lt;/tt&gt;&#160;to solve the deadlock issue.&lt;/p&gt;

&lt;p&gt;Would narrowing the lock there solve anything? I think the issue would still remain. &lt;tt&gt;synchronized (buffers)&lt;/tt&gt; would have to be completely removed from there.&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;I think we can set the&#160;&lt;tt&gt;BufferPoolOwner&lt;/tt&gt;&#160;in the construction of&#160;&lt;tt&gt;LocalBufferPool&lt;/tt&gt;&#160;and then remove the&#160;&lt;tt&gt;owner#releaseMemory}}outside of&#160;the&#160;{{synchronized&lt;/tt&gt;&#160;part in&#160;&lt;tt&gt;LocalBufferPool#setNumBuffers&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This on the other hand would have to be carefully thought through. Moving &lt;tt&gt;owner.releaseMemory(...)&lt;/tt&gt; outside of the synchronized block would&#160;change the contract of &lt;tt&gt;LocalBufferPool#setNumBuffers&lt;/tt&gt;&#160;method. Now it&apos;s atomic and nothing will happen between&#160;it&apos;s call and the final act of releasing the memory. After moving out that would no longer be true. Requesting/releasing memory, subsequent &lt;tt&gt;setNumBuffers&lt;/tt&gt; calls and other methods that also synchronise on &lt;tt&gt;synchronized (availableMemorySegments)&lt;/tt&gt; would have to be carefully considered against potential race conditions.&lt;/p&gt;

&lt;p&gt;&#160;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16643077" author="zjwang" created="Tue, 9 Oct 2018 10:10:04 +0000"  >&lt;p&gt;For &lt;tt&gt;SpillableSubpartition#releaseMemory&lt;/tt&gt;, actually it has been called before to generate &lt;tt&gt;spillWriter&lt;/tt&gt;&#160;in this case, and when it is called again, it has to enter the &lt;tt&gt;syn&lt;/tt&gt;&#160;part to check the status. I think it needs carefully review which variables are needed to be protected by this&#160;&lt;tt&gt;syn&lt;/tt&gt; and adjust related processes to reduce overhead.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For &lt;tt&gt;LocalBufferPool#setNumBuffers&lt;/tt&gt;, I think it is feasible and reasonable to fix, because the &lt;tt&gt;syn&lt;/tt&gt; only protects &lt;tt&gt;numberOfRequestedMemorySegments&lt;/tt&gt; and &lt;tt&gt;currentPoolSize&lt;/tt&gt; in this method, then we can make &lt;tt&gt;int numReleased=numberOfRequestedMemorySegments-currentPoolSize&lt;/tt&gt; inside the &lt;tt&gt;syn&lt;/tt&gt; part, and call &lt;tt&gt;owner#releaseMemory(numReleased)&lt;/tt&gt; outside of the &lt;tt&gt;syn&lt;/tt&gt; to solve this issue. We should not occupy the lock too long during releasing memory in different owners. Another motivation is that I want to pass the owner in the constructor of &lt;tt&gt;LocalBufferPool&lt;/tt&gt;, then it can be easy to define final variable and no need to open a back door for &lt;tt&gt;setBufferPoolOwner&lt;/tt&gt;. I already realized this and would submit this PR soon. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16643097" author="githubbot" created="Tue, 9 Oct 2018 10:28:32 +0000"  >&lt;p&gt;zhijiangW opened a new pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   *The `BufferPoolOwner` can be passed in the constructor of `LocalBufferPool` instead of a separate method for setting it. To do so, we can make this variable as final to become easy and safe.&lt;/p&gt;

&lt;p&gt;   BTW, we can also reduce the synchronized zone in the method of `LocalBufferPool#setNumBuffers` which may cause deadlock in special cases.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Pass `BufferPoolOwner` in constructor of `LocalBufferPool` and remove the `setBufferPoolOwner` method&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Make `owner#releaseMemory` outside of syn part in `setNumBuffers`&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change is already covered by existing tests.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643133" author="pnowojski" created="Tue, 9 Oct 2018 11:13:39 +0000"  >&lt;p&gt;I will look into the PR.&lt;/p&gt;

&lt;p&gt;Yes passing the value in the constructor has benefits on it&apos;s own &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16643155" author="githubbot" created="Tue, 9 Oct 2018 11:30:11 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r223658727&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r223658727&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -86,7 +84,7 @@&lt;/p&gt;

&lt;p&gt; 	private boolean isDestroyed;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private BufferPoolOwner owner;&lt;br/&gt;
+	private final BufferPoolOwner owner;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   please change it to `private final Optional&amp;lt;BufferPoolOwner&amp;gt; owner`. This value is logically optional and should be marked as such (we can not use `@Nullable` because we are not enforcing nullable checks during compilation/checkstyle). &lt;/p&gt;

&lt;p&gt;   Ditto for the constructor and method parameters that are providing this value. Either overload them by providing both:&lt;br/&gt;
   ```&lt;br/&gt;
   BufferPool createBufferPool(int numRequiredBuffers, int maxUsedBuffers, BufferPoolOwner owner);&lt;/p&gt;

&lt;p&gt;   BufferPool createBufferPool(int numRequiredBuffers, int maxUsedBuffers);&lt;br/&gt;
   ```&lt;br/&gt;
   or if you are lazy provide one method:&lt;br/&gt;
   ```&lt;br/&gt;
   BufferPool createBufferPool(int numRequiredBuffers, int maxUsedBuffers, Optional&amp;lt;BufferPoolOwner&amp;gt; owner)&lt;br/&gt;
   ```&lt;br/&gt;
   but the first option is more clean.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643156" author="githubbot" created="Tue, 9 Oct 2018 11:30:11 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r223661469&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r223661469&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -349,11 +346,13 @@ public void setNumBuffers(int numBuffers) throws IOException {&lt;/p&gt;

&lt;p&gt; 			returnExcessMemorySegments();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// If there is a registered owner and we have still requested more buffers than our&lt;/li&gt;
	&lt;li&gt;// size, trigger a recycle via the owner.&lt;/li&gt;
	&lt;li&gt;if (owner != null &amp;amp;&amp;amp; numberOfRequestedMemorySegments &amp;gt; currentPoolSize) 
{
-				owner.releaseMemory(numberOfRequestedMemorySegments - currentPoolSize);
-			}
&lt;p&gt;+			numReleased = numberOfRequestedMemorySegments - currentPoolSize;&lt;br/&gt;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		// If there is a registered owner and we have still requested more buffers than our&lt;br/&gt;
+		// size, trigger a recycle via the owner.&lt;br/&gt;
+		if (owner != null &amp;amp;&amp;amp; numReleased &amp;gt; 0) {&lt;br/&gt;
+			owner.releaseMemory(numReleased);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Are you sure that doing this outside of the `synchronized` block will not cause some race conditions? After this change from the perspective of different threads interacting with this class, memory will not be release during `setNumBuffers` but at some random point time in the future. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643625" author="githubbot" created="Tue, 9 Oct 2018 15:23:46 +0000"  >&lt;p&gt;NicoK commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r223747964&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r223747964&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -349,11 +346,13 @@ public void setNumBuffers(int numBuffers) throws IOException {&lt;/p&gt;

&lt;p&gt; 			returnExcessMemorySegments();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// If there is a registered owner and we have still requested more buffers than our&lt;/li&gt;
	&lt;li&gt;// size, trigger a recycle via the owner.&lt;/li&gt;
	&lt;li&gt;if (owner != null &amp;amp;&amp;amp; numberOfRequestedMemorySegments &amp;gt; currentPoolSize) 
{
-				owner.releaseMemory(numberOfRequestedMemorySegments - currentPoolSize);
-			}
&lt;p&gt;+			numReleased = numberOfRequestedMemorySegments - currentPoolSize;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   That&apos;s actually not the number of released buffers, but the number of further excess buffers held by the owner.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643626" author="githubbot" created="Tue, 9 Oct 2018 15:23:46 +0000"  >&lt;p&gt;NicoK commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r223741773&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r223741773&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/NetworkEnvironment.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -209,8 +209,11 @@ public void setupPartition(ResultPartition partition) throws IOException {&lt;br/&gt;
 			int maxNumberOfMemorySegments = partition.getPartitionType().isBounded() ?&lt;br/&gt;
 				partition.getNumberOfSubpartitions() * networkBuffersPerChannel +&lt;br/&gt;
 					extraNetworkBuffersPerGate : Integer.MAX_VALUE;&lt;br/&gt;
+			// If the partition type is back pressure-free, we register with the buffer pool for&lt;br/&gt;
+			// callbacks to release memory.&lt;br/&gt;
 			bufferPool = networkBufferPool.createBufferPool(partition.getNumberOfSubpartitions(),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;maxNumberOfMemorySegments);&lt;br/&gt;
+				maxNumberOfMemorySegments, partition.getPartitionType().hasBackPressure() ? partition : null);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Actually, the comment above looks right but the code does not - it should resemble the old behaviour of:&lt;br/&gt;
   ```&lt;br/&gt;
   		if (!partitionType.hasBackPressure()) &lt;/p&gt;
{
   			bufferPool.setBufferPoolOwner(this);
   		}
&lt;p&gt;   ```&lt;br/&gt;
   If I&apos;m right, then this is apparently not covered by tests either (and should be added!)&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643627" author="githubbot" created="Tue, 9 Oct 2018 15:23:46 +0000"  >&lt;p&gt;NicoK commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r223748143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r223748143&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -349,11 +346,13 @@ public void setNumBuffers(int numBuffers) throws IOException {&lt;/p&gt;

&lt;p&gt; 			returnExcessMemorySegments();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// If there is a registered owner and we have still requested more buffers than our&lt;/li&gt;
	&lt;li&gt;// size, trigger a recycle via the owner.&lt;/li&gt;
	&lt;li&gt;if (owner != null &amp;amp;&amp;amp; numberOfRequestedMemorySegments &amp;gt; currentPoolSize) 
{
-				owner.releaseMemory(numberOfRequestedMemorySegments - currentPoolSize);
-			}
&lt;p&gt;+			numReleased = numberOfRequestedMemorySegments - currentPoolSize;&lt;br/&gt;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		// If there is a registered owner and we have still requested more buffers than our&lt;br/&gt;
+		// size, trigger a recycle via the owner.&lt;br/&gt;
+		if (owner != null &amp;amp;&amp;amp; numReleased &amp;gt; 0) {&lt;br/&gt;
+			owner.releaseMemory(numReleased);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I&apos;d say, this is safe.&lt;br/&gt;
   Since recycled memory segments will eventually become available, a blocking call by any other thread on getting a buffer will still wait until it is actually recycled. What other interactions were you thinking about?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16644401" author="githubbot" created="Wed, 10 Oct 2018 03:44:02 +0000"  >&lt;p&gt;zhijiangW commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r223929018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r223929018&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -349,11 +346,13 @@ public void setNumBuffers(int numBuffers) throws IOException {&lt;/p&gt;

&lt;p&gt; 			returnExcessMemorySegments();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// If there is a registered owner and we have still requested more buffers than our&lt;/li&gt;
	&lt;li&gt;// size, trigger a recycle via the owner.&lt;/li&gt;
	&lt;li&gt;if (owner != null &amp;amp;&amp;amp; numberOfRequestedMemorySegments &amp;gt; currentPoolSize) 
{
-				owner.releaseMemory(numberOfRequestedMemorySegments - currentPoolSize);
-			}
&lt;p&gt;+			numReleased = numberOfRequestedMemorySegments - currentPoolSize;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Yes, I will adjust this variable.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16644403" author="githubbot" created="Wed, 10 Oct 2018 03:44:54 +0000"  >&lt;p&gt;zhijiangW commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r223929096&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r223929096&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -86,7 +84,7 @@&lt;/p&gt;

&lt;p&gt; 	private boolean isDestroyed;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private BufferPoolOwner owner;&lt;br/&gt;
+	private final BufferPoolOwner owner;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Yes, the optional way is better, and I will take the first option as you suggested.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16644407" author="githubbot" created="Wed, 10 Oct 2018 03:49:40 +0000"  >&lt;p&gt;zhijiangW commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r223929542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r223929542&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/NetworkEnvironment.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -209,8 +209,11 @@ public void setupPartition(ResultPartition partition) throws IOException {&lt;br/&gt;
 			int maxNumberOfMemorySegments = partition.getPartitionType().isBounded() ?&lt;br/&gt;
 				partition.getNumberOfSubpartitions() * networkBuffersPerChannel +&lt;br/&gt;
 					extraNetworkBuffersPerGate : Integer.MAX_VALUE;&lt;br/&gt;
+			// If the partition type is back pressure-free, we register with the buffer pool for&lt;br/&gt;
+			// callbacks to release memory.&lt;br/&gt;
 			bufferPool = networkBufferPool.createBufferPool(partition.getNumberOfSubpartitions(),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;maxNumberOfMemorySegments);&lt;br/&gt;
+				maxNumberOfMemorySegments, partition.getPartitionType().hasBackPressure() ? partition : null);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   That is my careless, and find previous missing tests as a result. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
   I will add related test to cover it.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16644425" author="githubbot" created="Wed, 10 Oct 2018 04:07:33 +0000"  >&lt;p&gt;zhijiangW commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r223931343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r223931343&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -349,11 +346,13 @@ public void setNumBuffers(int numBuffers) throws IOException {&lt;/p&gt;

&lt;p&gt; 			returnExcessMemorySegments();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// If there is a registered owner and we have still requested more buffers than our&lt;/li&gt;
	&lt;li&gt;// size, trigger a recycle via the owner.&lt;/li&gt;
	&lt;li&gt;if (owner != null &amp;amp;&amp;amp; numberOfRequestedMemorySegments &amp;gt; currentPoolSize) 
{
-				owner.releaseMemory(numberOfRequestedMemorySegments - currentPoolSize);
-			}
&lt;p&gt;+			numReleased = numberOfRequestedMemorySegments - currentPoolSize;&lt;br/&gt;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		// If there is a registered owner and we have still requested more buffers than our&lt;br/&gt;
+		// size, trigger a recycle via the owner.&lt;br/&gt;
+		if (owner != null &amp;amp;&amp;amp; numReleased &amp;gt; 0) {&lt;br/&gt;
+			owner.releaseMemory(numReleased);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Yes, I also have not thought of any potential problems currently.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16644432" author="githubbot" created="Wed, 10 Oct 2018 04:19:28 +0000"  >&lt;p&gt;zhijiangW commented on issue #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#issuecomment-428432627&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#issuecomment-428432627&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for efficient reviews! @NicoK @pnowojski &lt;/p&gt;

&lt;p&gt;   I already updated the codes based on above comments except the additional missing tests. I find there only exists one test currently related with `BufferPoolOwner` whose behavior is throwing exception when calling release memory, so the normal behavior of `BufferPoolOwner` is also missing besides with different `ResultPartitionType`. &lt;/p&gt;

&lt;p&gt;   But I think it is another topic and I want to add more tests for it in a separate JIRA which I will create later. The motivation of this PR only moves the `BufferPoolOwner` into the constructor of `LocalBufferPool` and it does not effect the previous behaviors. What do you think?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16644714" author="githubbot" created="Wed, 10 Oct 2018 09:24:48 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r224000476&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r224000476&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -349,11 +346,13 @@ public void setNumBuffers(int numBuffers) throws IOException {&lt;/p&gt;

&lt;p&gt; 			returnExcessMemorySegments();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// If there is a registered owner and we have still requested more buffers than our&lt;/li&gt;
	&lt;li&gt;// size, trigger a recycle via the owner.&lt;/li&gt;
	&lt;li&gt;if (owner != null &amp;amp;&amp;amp; numberOfRequestedMemorySegments &amp;gt; currentPoolSize) 
{
-				owner.releaseMemory(numberOfRequestedMemorySegments - currentPoolSize);
-			}
&lt;p&gt;+			numReleased = numberOfRequestedMemorySegments - currentPoolSize;&lt;br/&gt;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		// If there is a registered owner and we have still requested more buffers than our&lt;br/&gt;
+		// size, trigger a recycle via the owner.&lt;br/&gt;
+		if (owner != null &amp;amp;&amp;amp; numReleased &amp;gt; 0) {&lt;br/&gt;
+			owner.releaseMemory(numReleased);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   @NicoK I do not have anything particular in mind, just that this change introduces more concurrency/potential races.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16644716" author="githubbot" created="Wed, 10 Oct 2018 09:26:45 +0000"  >&lt;p&gt;pnowojski commented on issue #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#issuecomment-428502689&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#issuecomment-428502689&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @zhijiangW I would add more test coverage (at least for the bugs that @NicoK has found) in this PR.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16645156" author="githubbot" created="Wed, 10 Oct 2018 15:32:47 +0000"  >&lt;p&gt;zhijiangW commented on issue #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#issuecomment-428619620&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#issuecomment-428619620&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @pnowojski , I will add the tests in this PR later.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16645198" author="githubbot" created="Wed, 10 Oct 2018 16:15:03 +0000"  >&lt;p&gt;zhijiangW commented on issue #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#issuecomment-428635281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#issuecomment-428635281&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @pnowojski @NicoK , I already submitted the tests covering the `BufferPoolOwner` with different `ResultPartitionType` in a separate commit. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16655182" author="githubbot" created="Thu, 18 Oct 2018 12:44:37 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r226285037&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r226285037&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -205,6 +216,66 @@ protected void testAddOnPartition(final ResultPartitionType pipelined)&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnBlockingPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.BLOCKING);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnPipelinedPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.PIPELINED);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Tests &lt;/p&gt;
{@link ResultPartition#releaseMemory(int)}
&lt;p&gt; on a working partition.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param resultPartitionType the result partition type to set up&lt;br/&gt;
+	 */&lt;br/&gt;
+	private void testReleaseMemory(final ResultPartitionType resultPartitionType) throws Exception {&lt;br/&gt;
+		final int numBuffers = 10;&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;br/&gt;
+			new NetworkBufferPool(numBuffers, 128),&lt;br/&gt;
+			new LocalConnectionManager(),&lt;br/&gt;
+			new ResultPartitionManager(),&lt;br/&gt;
+			new TaskEventDispatcher(),&lt;br/&gt;
+			new KvStateRegistry(),&lt;br/&gt;
+			null,&lt;br/&gt;
+			null,&lt;br/&gt;
+			IOManager.IOMode.SYNC,&lt;br/&gt;
+			0,&lt;br/&gt;
+			0,&lt;br/&gt;
+			2,&lt;br/&gt;
+			8,&lt;br/&gt;
+			true);&lt;br/&gt;
+		final ResultPartitionConsumableNotifier notifier = mock(ResultPartitionConsumableNotifier.class);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Please do not use mockito and do not duplicate the code. There are already two existing `NoOp` implementations of this class and you should use one of them here.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16655183" author="githubbot" created="Thu, 18 Oct 2018 12:44:37 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r226288887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r226288887&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -205,6 +216,66 @@ protected void testAddOnPartition(final ResultPartitionType pipelined)&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnBlockingPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.BLOCKING);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnPipelinedPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.PIPELINED);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Tests &lt;/p&gt;
{@link ResultPartition#releaseMemory(int)}
&lt;p&gt; on a working partition.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param resultPartitionType the result partition type to set up&lt;br/&gt;
+	 */&lt;br/&gt;
+	private void testReleaseMemory(final ResultPartitionType resultPartitionType) throws Exception {&lt;br/&gt;
+		final int numBuffers = 10;&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Could you deduplicate this constructor with other use cases? It is used in tests in 5 other places, 2 of them are almost exactly the same as this one and three others further duplicate this:&lt;br/&gt;
   ```&lt;br/&gt;
   			new LocalConnectionManager(),&lt;br/&gt;
   			new ResultPartitionManager(),&lt;br/&gt;
   			new TaskEventDispatcher(),&lt;br/&gt;
   			new KvStateRegistry(),&lt;br/&gt;
   			null,&lt;br/&gt;
   			null,&lt;br/&gt;
   			IOManager.IOMode.SYNC,&lt;br/&gt;
   ```&lt;br/&gt;
   block.&lt;/p&gt;

&lt;p&gt;   Please either provide some more constructors to deduplicate this or provide a `NetworkEnvironmentBuilder` (or `public static class Builder` nested in `NetworkEnvironment`) that would handle those default values. I would personally prefer the builder, since it&apos;s better for the future.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16655184" author="githubbot" created="Thu, 18 Oct 2018 12:44:37 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r226285789&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r226285789&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -205,6 +216,66 @@ protected void testAddOnPartition(final ResultPartitionType pipelined)&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnBlockingPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.BLOCKING);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnPipelinedPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.PIPELINED);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Tests &lt;/p&gt;
{@link ResultPartition#releaseMemory(int)}
&lt;p&gt; on a working partition.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param resultPartitionType the result partition type to set up&lt;br/&gt;
+	 */&lt;br/&gt;
+	private void testReleaseMemory(final ResultPartitionType resultPartitionType) throws Exception {&lt;br/&gt;
+		final int numBuffers = 10;&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;br/&gt;
+			new NetworkBufferPool(numBuffers, 128),&lt;br/&gt;
+			new LocalConnectionManager(),&lt;br/&gt;
+			new ResultPartitionManager(),&lt;br/&gt;
+			new TaskEventDispatcher(),&lt;br/&gt;
+			new KvStateRegistry(),&lt;br/&gt;
+			null,&lt;br/&gt;
+			null,&lt;br/&gt;
+			IOManager.IOMode.SYNC,&lt;br/&gt;
+			0,&lt;br/&gt;
+			0,&lt;br/&gt;
+			2,&lt;br/&gt;
+			8,&lt;br/&gt;
+			true);&lt;br/&gt;
+		final ResultPartitionConsumableNotifier notifier = mock(ResultPartitionConsumableNotifier.class);&lt;br/&gt;
+		final ResultPartition resultPartition = spy(createPartition(notifier, resultPartitionType, false));&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Same here. Do not use mockito for that kind of stuff. Instead of checking whether some exact method was called or not, and how many times with what arguments (those things can change while the code still remain valid while the mockito tests will start failing), check the state of the `NetworkBufferPool` - how many buffers are available after some kind of operation etc. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16656201" author="githubbot" created="Fri, 19 Oct 2018 02:37:17 +0000"  >&lt;p&gt;zhijiangW commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r226520720&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r226520720&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -205,6 +216,66 @@ protected void testAddOnPartition(final ResultPartitionType pipelined)&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnBlockingPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.BLOCKING);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnPipelinedPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.PIPELINED);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Tests &lt;/p&gt;
{@link ResultPartition#releaseMemory(int)}
&lt;p&gt; on a working partition.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param resultPartitionType the result partition type to set up&lt;br/&gt;
+	 */&lt;br/&gt;
+	private void testReleaseMemory(final ResultPartitionType resultPartitionType) throws Exception {&lt;br/&gt;
+		final int numBuffers = 10;&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Yes, I agree with the option of providing a `NetworkEnvironmentBuilder` nested in `NetworkEnvironment`. &lt;br/&gt;
   But I think it is worth opening a separate JIRA for unifying all the related history usages, because it is not caused by this PR, and this PR would be based on that new JIRA. What do you think?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16656215" author="githubbot" created="Fri, 19 Oct 2018 03:01:23 +0000"  >&lt;p&gt;zhijiangW commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r226523253&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r226523253&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -205,6 +216,66 @@ protected void testAddOnPartition(final ResultPartitionType pipelined)&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnBlockingPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.BLOCKING);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnPipelinedPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.PIPELINED);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Tests &lt;/p&gt;
{@link ResultPartition#releaseMemory(int)}
&lt;p&gt; on a working partition.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param resultPartitionType the result partition type to set up&lt;br/&gt;
+	 */&lt;br/&gt;
+	private void testReleaseMemory(final ResultPartitionType resultPartitionType) throws Exception {&lt;br/&gt;
+		final int numBuffers = 10;&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;br/&gt;
+			new NetworkBufferPool(numBuffers, 128),&lt;br/&gt;
+			new LocalConnectionManager(),&lt;br/&gt;
+			new ResultPartitionManager(),&lt;br/&gt;
+			new TaskEventDispatcher(),&lt;br/&gt;
+			new KvStateRegistry(),&lt;br/&gt;
+			null,&lt;br/&gt;
+			null,&lt;br/&gt;
+			IOManager.IOMode.SYNC,&lt;br/&gt;
+			0,&lt;br/&gt;
+			0,&lt;br/&gt;
+			2,&lt;br/&gt;
+			8,&lt;br/&gt;
+			true);&lt;br/&gt;
+		final ResultPartitionConsumableNotifier notifier = mock(ResultPartitionConsumableNotifier.class);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I checked these two implementations and they are exactly the same with empty operation, so I think we should open a separate JIRA for unifying current two existing implementations and make it public for outer usage.&lt;/p&gt;

&lt;p&gt;   Considering the mock issue, I have some concerns:&lt;/p&gt;

&lt;p&gt;   1. Do you think there are any differences between mock and empty operations in real class? &lt;/p&gt;

&lt;p&gt;   2. There are already many usages of mock in existing tests, do you think it is necessary to polish them in real classes? If so, I am willing to open JIRA for them. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;   3. I think the unit tests are mainly for verifying partial logics or processes, so if the behaviors of some classes are not cared about in the target test, we can mock these objects to make simple. Otherwise we can develop the ITCase for end-to-end verify with all real classes.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16656231" author="githubbot" created="Fri, 19 Oct 2018 03:27:38 +0000"  >&lt;p&gt;zhijiangW commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r226525858&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r226525858&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -205,6 +216,66 @@ protected void testAddOnPartition(final ResultPartitionType pipelined)&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnBlockingPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.BLOCKING);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnPipelinedPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.PIPELINED);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Tests &lt;/p&gt;
{@link ResultPartition#releaseMemory(int)}
&lt;p&gt; on a working partition.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param resultPartitionType the result partition type to set up&lt;br/&gt;
+	 */&lt;br/&gt;
+	private void testReleaseMemory(final ResultPartitionType resultPartitionType) throws Exception {&lt;br/&gt;
+		final int numBuffers = 10;&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;br/&gt;
+			new NetworkBufferPool(numBuffers, 128),&lt;br/&gt;
+			new LocalConnectionManager(),&lt;br/&gt;
+			new ResultPartitionManager(),&lt;br/&gt;
+			new TaskEventDispatcher(),&lt;br/&gt;
+			new KvStateRegistry(),&lt;br/&gt;
+			null,&lt;br/&gt;
+			null,&lt;br/&gt;
+			IOManager.IOMode.SYNC,&lt;br/&gt;
+			0,&lt;br/&gt;
+			0,&lt;br/&gt;
+			2,&lt;br/&gt;
+			8,&lt;br/&gt;
+			true);&lt;br/&gt;
+		final ResultPartitionConsumableNotifier notifier = mock(ResultPartitionConsumableNotifier.class);&lt;br/&gt;
+		final ResultPartition resultPartition = spy(createPartition(notifier, resultPartitionType, false));&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I also considered the `spy` usage here may bring some concerns and thought of the way you mentioned to avoid the `spy`. I should explain the reasons why using `spy` finally.&lt;/p&gt;

&lt;p&gt;   I think there should have two separate tests for verifying different logics in two dimessions:&lt;br/&gt;
   1. Whether the `ResultPartition` is assigned as `BufferPoolOwner` correctly during creating `BufferPool` for different types, and this test is for verifying this relationship.&lt;/p&gt;

&lt;p&gt;   2. Verify the logic of interface implementation for `BufferPoolOwner#releaseMemory` which is also missing currently, and I mentioned this in previous comments. But I think it is not the scope of this PR and I am willing to open a JIRA for it. At the beginning I also think the first verify actually does not belong to the scope of this PR, just because of the careless of migrating history codes to find history missing tests. &lt;/p&gt;

&lt;p&gt;   So if we want to check the state of `NetworkBufferPool` to avoid `spy` here, we have to touch the detail logic of `BufferPoolOwner#releaseMemory` mentioned in second part. And the first part is enough for this PR to avoid the mistake of assigning `BufferPoolOwner`. What do you think?&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16656242" author="githubbot" created="Fri, 19 Oct 2018 03:48:34 +0000"  >&lt;p&gt;zhijiangW commented on issue #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#issuecomment-431236371&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#issuecomment-431236371&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @pnowojski , thanks for reviews again! &lt;/p&gt;

&lt;p&gt;   I have mainly two concerns of tests from comments.&lt;br/&gt;
   1. How should we define the scope of this PR? I found another common issue that the new added tests may trigger some unreasonable history tests. If we solved all the related history tests in this PR, it may be not good for convergence for this PR.&lt;br/&gt;
   2. How to evaluate the usages of mock, spy, etc in test? I have some thoughts in the comments.&lt;/p&gt;

&lt;p&gt;   BTW, I learned some good ideas from your test reviews, then I think I would focus on polishing some existing history tests if have time. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16656358" author="githubbot" created="Fri, 19 Oct 2018 07:15:15 +0000"  >&lt;p&gt;zhijiangW commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r226552102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r226552102&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -205,6 +216,66 @@ protected void testAddOnPartition(final ResultPartitionType pipelined)&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnBlockingPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.BLOCKING);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnPipelinedPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.PIPELINED);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Tests &lt;/p&gt;
{@link ResultPartition#releaseMemory(int)}
&lt;p&gt; on a working partition.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param resultPartitionType the result partition type to set up&lt;br/&gt;
+	 */&lt;br/&gt;
+	private void testReleaseMemory(final ResultPartitionType resultPartitionType) throws Exception {&lt;br/&gt;
+		final int numBuffers = 10;&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Another option is we provide another simple constructor for `NetworkEnvironment` instead of `Builder`, which one do you prefer?&lt;/p&gt;

&lt;p&gt;   I reviewed all the current usages and the above deduplication can cover the existing usages in tests except for `StreamNetworkBenchmarkEnvironment` which provides additional `ConnectionManager`. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16656916" author="till.rohrmann" created="Fri, 19 Oct 2018 15:12:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;, is this something we want to change for Flink 1.7?&lt;/p&gt;</comment>
                            <comment id="16658496" author="zjwang" created="Mon, 22 Oct 2018 03:10:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;, I think it should be covered in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-1&quot; title=&quot;[GitHub] Hide auxiliary tasks for iterative data flows in visualization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-1&quot;&gt;&lt;del&gt;FLINK-1&lt;/del&gt;&lt;/a&gt;.7 if can catch up with the freeze deadline.&lt;/p&gt;</comment>
                            <comment id="16659274" author="githubbot" created="Mon, 22 Oct 2018 18:19:18 +0000"  >&lt;p&gt;zhijiangW commented on issue #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#issuecomment-431798720&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#issuecomment-431798720&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @pnowojski , I rebased the commits with #6892 #6891 , and submitted a new commit for addressing all three test issues.&lt;br/&gt;
   BTW, the github has some problems not to show the updates correctly.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16659275" author="githubbot" created="Mon, 22 Oct 2018 18:19:21 +0000"  >&lt;p&gt;zhijiangW commented on issue #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#issuecomment-431798781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#issuecomment-431798781&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @pnowojski , I rebased the commits with #6892 #6891 , and submitted a new commit for addressing all three test issues.&lt;br/&gt;
   BTW, the github has some problems not to show the updates correctly.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16659276" author="githubbot" created="Mon, 22 Oct 2018 18:19:25 +0000"  >&lt;p&gt;zhijiangW commented on issue #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#issuecomment-431798840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#issuecomment-431798840&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @pnowojski , I rebased the commits with #6892 #6891 , and submitted a new commit for addressing all three test issues.&lt;br/&gt;
   BTW, the github has some problems not to show the updates correctly.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16659311" author="githubbot" created="Mon, 22 Oct 2018 18:31:42 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809#discussion_r226945997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809#discussion_r226945997&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -205,6 +216,66 @@ protected void testAddOnPartition(final ResultPartitionType pipelined)&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnBlockingPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.BLOCKING);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnPipelinedPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.PIPELINED);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Tests &lt;/p&gt;
{@link ResultPartition#releaseMemory(int)}
&lt;p&gt; on a working partition.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param resultPartitionType the result partition type to set up&lt;br/&gt;
+	 */&lt;br/&gt;
+	private void testReleaseMemory(final ResultPartitionType resultPartitionType) throws Exception {&lt;br/&gt;
+		final int numBuffers = 10;&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;br/&gt;
+			new NetworkBufferPool(numBuffers, 128),&lt;br/&gt;
+			new LocalConnectionManager(),&lt;br/&gt;
+			new ResultPartitionManager(),&lt;br/&gt;
+			new TaskEventDispatcher(),&lt;br/&gt;
+			new KvStateRegistry(),&lt;br/&gt;
+			null,&lt;br/&gt;
+			null,&lt;br/&gt;
+			IOManager.IOMode.SYNC,&lt;br/&gt;
+			0,&lt;br/&gt;
+			0,&lt;br/&gt;
+			2,&lt;br/&gt;
+			8,&lt;br/&gt;
+			true);&lt;br/&gt;
+		final ResultPartitionConsumableNotifier notifier = mock(ResultPartitionConsumableNotifier.class);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   This would be a longer story to fully explained. There are multiple problems with mockito, some (most?) of them come from how it&apos;s being used:&lt;br/&gt;
   1. Whenever you write `mock(ResultPartitionConsumableNotifier.class);`, you basically define an empty, with default implementation of returning `nulls` and ignoring method calls.   If you use `mock(Something.class)` twice for the same class, you duplicate such naive implementation. Mockito makes it so easy that such declarations are duplicated many times around the code base. Now when something changes between the interactions with the mocked class, you have to fix it everywhere separately. &lt;br/&gt;
   2. Default implementation that ignores method calls/returns null is terrifying. Again, in case of refactoring/changing contract, this can result in irrelevant false positive test failures that are sometimes hard to track-down. For example if you add a new method `boolean isBlocked()` to the mocked interface. All of the mocks are silently broken after this. With proper code, after adding a method your code will not compile and it&apos;s also easy to find missing implementation because ...&lt;br/&gt;
   3. ... no Intellij support for refactoring/finding usages. Intellij doesn&apos;t rapport mocked methods as &quot;overloaded&quot; for example not it doesn&apos;t show up when you look for classes that are extending interface that you are mocking  &lt;br/&gt;
   4. Mockito tends to duplicate mock over and over again  around the code base. &lt;br/&gt;
   With proper mocks, people are automatically trying to re-use them.&lt;/p&gt;

&lt;p&gt;   Or saying other way around. Would you accept in code review, if someone was about to submit a real implementation of some class, that returns `null` for half of the methods (while the real classes are not nullable), ignores silently all of the current method calls (not only those that you intended to) and also any future ones (think about this: `mock(List.class)` and passing it to somewhere, that after refactoring will call `list.clear()`). And on top of all of that, such class would be duplicated 10 times around the code base?&lt;/p&gt;

&lt;p&gt;   I don&apos;t want to press you to change other places in which Mockito was being used extensively before, but generally speaking we are trying to avoid it and we shouldn&apos;t be making things worse - new tests should avoid mockito and whenever you touch something that&apos;s mockito tested, this might be a good reason to get rid of such mocks.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16660642" author="githubbot" created="Tue, 23 Oct 2018 13:26:41 +0000"  >&lt;p&gt;asfgit closed pull request #6809: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10491&quot; title=&quot;Deadlock during spilling data in SpillableSubpartition &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10491&quot;&gt;&lt;del&gt;FLINK-10491&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;network&amp;#93;&lt;/span&gt; Pass BufferPoolOwner in the constructor of LocalBufferPool&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6809&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6809&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/NetworkEnvironment.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/NetworkEnvironment.java&lt;br/&gt;
index f2547563872..d124456c213 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/NetworkEnvironment.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/NetworkEnvironment.java&lt;br/&gt;
@@ -43,6 +43,7 @@&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt; import java.io.IOException;&lt;br/&gt;
+import java.util.Optional;&lt;/p&gt;

&lt;p&gt; import static org.apache.flink.util.Preconditions.checkNotNull;&lt;/p&gt;

&lt;p&gt;@@ -90,19 +91,43 @@&lt;br/&gt;
 	private boolean isShutdown;&lt;/p&gt;

&lt;p&gt; 	public NetworkEnvironment(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;NetworkBufferPool networkBufferPool,&lt;/li&gt;
	&lt;li&gt;ConnectionManager connectionManager,&lt;/li&gt;
	&lt;li&gt;ResultPartitionManager resultPartitionManager,&lt;/li&gt;
	&lt;li&gt;TaskEventDispatcher taskEventDispatcher,&lt;/li&gt;
	&lt;li&gt;KvStateRegistry kvStateRegistry,&lt;/li&gt;
	&lt;li&gt;KvStateServer kvStateServer,&lt;/li&gt;
	&lt;li&gt;KvStateClientProxy kvStateClientProxy,&lt;/li&gt;
	&lt;li&gt;IOMode defaultIOMode,&lt;/li&gt;
	&lt;li&gt;int partitionRequestInitialBackoff,&lt;/li&gt;
	&lt;li&gt;int partitionRequestMaxBackoff,&lt;/li&gt;
	&lt;li&gt;int networkBuffersPerChannel,&lt;/li&gt;
	&lt;li&gt;int extraNetworkBuffersPerGate,&lt;/li&gt;
	&lt;li&gt;boolean enableCreditBased) {&lt;br/&gt;
+		int numBuffers,&lt;br/&gt;
+		int memorySegmentSize,&lt;br/&gt;
+		int partitionRequestInitialBackoff,&lt;br/&gt;
+		int partitionRequestMaxBackoff,&lt;br/&gt;
+		int networkBuffersPerChannel,&lt;br/&gt;
+		int extraNetworkBuffersPerGate,&lt;br/&gt;
+		boolean enableCreditBased) 
{
+		this(
+			new NetworkBufferPool(numBuffers, memorySegmentSize),
+			new LocalConnectionManager(),
+			new ResultPartitionManager(),
+			new TaskEventDispatcher(),
+			new KvStateRegistry(),
+			null,
+			null,
+			IOManager.IOMode.SYNC,
+			partitionRequestInitialBackoff,
+			partitionRequestMaxBackoff,
+			networkBuffersPerChannel,
+			extraNetworkBuffersPerGate,
+			enableCreditBased);
+	}
&lt;p&gt;+&lt;br/&gt;
+	public NetworkEnvironment(&lt;br/&gt;
+		NetworkBufferPool networkBufferPool,&lt;br/&gt;
+		ConnectionManager connectionManager,&lt;br/&gt;
+		ResultPartitionManager resultPartitionManager,&lt;br/&gt;
+		TaskEventDispatcher taskEventDispatcher,&lt;br/&gt;
+		KvStateRegistry kvStateRegistry,&lt;br/&gt;
+		KvStateServer kvStateServer,&lt;br/&gt;
+		KvStateClientProxy kvStateClientProxy,&lt;br/&gt;
+		IOMode defaultIOMode,&lt;br/&gt;
+		int partitionRequestInitialBackoff,&lt;br/&gt;
+		int partitionRequestMaxBackoff,&lt;br/&gt;
+		int networkBuffersPerChannel,&lt;br/&gt;
+		int extraNetworkBuffersPerGate,&lt;br/&gt;
+		boolean enableCreditBased) {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		this.networkBufferPool = checkNotNull(networkBufferPool);&lt;br/&gt;
 		this.connectionManager = checkNotNull(connectionManager);&lt;br/&gt;
@@ -209,8 +234,12 @@ public void setupPartition(ResultPartition partition) throws IOException {&lt;br/&gt;
 			int maxNumberOfMemorySegments = partition.getPartitionType().isBounded() ?&lt;br/&gt;
 				partition.getNumberOfSubpartitions() * networkBuffersPerChannel +&lt;br/&gt;
 					extraNetworkBuffersPerGate : Integer.MAX_VALUE;&lt;br/&gt;
+			// If the partition type is back pressure-free, we register with the buffer pool for&lt;br/&gt;
+			// callbacks to release memory.&lt;br/&gt;
 			bufferPool = networkBufferPool.createBufferPool(partition.getNumberOfSubpartitions(),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;maxNumberOfMemorySegments);&lt;br/&gt;
+				maxNumberOfMemorySegments,&lt;br/&gt;
+				partition.getPartitionType().hasBackPressure() ? Optional.empty() : Optional.of(partition));&lt;br/&gt;
+&lt;br/&gt;
 			partition.registerBufferPool(bufferPool);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			resultPartitionManager.registerResultPartition(partition);&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/BufferPool.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/BufferPool.java&lt;br/&gt;
index 2927fae1069..511eb65019e 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/BufferPool.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/BufferPool.java&lt;br/&gt;
@@ -25,12 +25,6 @@&lt;br/&gt;
  */&lt;br/&gt;
 public interface BufferPool extends BufferProvider, BufferRecycler {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* The owner of this buffer pool to be called when memory needs to be released to avoid back&lt;/li&gt;
	&lt;li&gt;* pressure.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;void setBufferPoolOwner(BufferPoolOwner owner);&lt;br/&gt;
-&lt;br/&gt;
 	/**&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;Destroys this buffer pool.&lt;br/&gt;
 	 *&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/BufferPoolFactory.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/BufferPoolFactory.java&lt;br/&gt;
index c90e3025237..de4c8e09e11 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/BufferPoolFactory.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/BufferPoolFactory.java&lt;br/&gt;
@@ -19,6 +19,7 @@&lt;br/&gt;
 package org.apache.flink.runtime.io.network.buffer;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import java.io.IOException;&lt;br/&gt;
+import java.util.Optional;&lt;/p&gt;

&lt;p&gt; /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A factory for buffer pools.&lt;br/&gt;
@@ -38,6 +39,21 @@&lt;br/&gt;
 	 */&lt;br/&gt;
 	BufferPool createBufferPool(int numRequiredBuffers, int maxUsedBuffers) throws IOException;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+	/**&lt;br/&gt;
+	 * Tries to create a buffer pool with an optional owner, which is guaranteed to provide at least the&lt;br/&gt;
+	 * number of required buffers.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * &amp;lt;p&amp;gt;The buffer pool is of dynamic size with at least &amp;lt;tt&amp;gt;numRequiredBuffers&amp;lt;/tt&amp;gt; buffers.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param numRequiredBuffers&lt;br/&gt;
+	 * 		minimum number of network buffers in this pool&lt;br/&gt;
+	 * @param maxUsedBuffers&lt;br/&gt;
+	 * 		maximum number of network buffers this pool offers&lt;br/&gt;
+	 * 	@param owner&lt;br/&gt;
+	 * 	    the optional owner of this buffer pool to release memory when needed&lt;br/&gt;
+	 */&lt;br/&gt;
+	BufferPool createBufferPool(int numRequiredBuffers, int maxUsedBuffers, Optional&amp;lt;BufferPoolOwner&amp;gt; owner) throws IOException;&lt;br/&gt;
+&lt;br/&gt;
 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Destroy callback for updating factory book keeping.&lt;br/&gt;
 	 */&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
index 1596fded6f3..d7bfb603eaf 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java&lt;br/&gt;
@@ -26,10 +26,9 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import java.io.IOException;&lt;br/&gt;
 import java.util.ArrayDeque;&lt;br/&gt;
+import java.util.Optional;&lt;/p&gt;

&lt;p&gt; import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
-import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
-import static org.apache.flink.util.Preconditions.checkState;&lt;/p&gt;

&lt;p&gt; /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A buffer pool used to manage a number of 
{@link Buffer}
&lt;p&gt; instances from the&lt;br/&gt;
@@ -86,7 +85,7 @@&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	private boolean isDestroyed;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private BufferPoolOwner owner;&lt;br/&gt;
+	private final Optional&amp;lt;BufferPoolOwner&amp;gt; owner;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Local buffer pool based on the given &amp;lt;tt&amp;gt;networkBufferPool&amp;lt;/tt&amp;gt; with a minimal number of&lt;br/&gt;
@@ -98,7 +97,7 @@&lt;/li&gt;
	&lt;li&gt;minimum number of network buffers&lt;br/&gt;
 	 */&lt;br/&gt;
 	LocalBufferPool(NetworkBufferPool networkBufferPool, int numberOfRequiredMemorySegments) 
{
-		this(networkBufferPool, numberOfRequiredMemorySegments, Integer.MAX_VALUE);
+		this(networkBufferPool, numberOfRequiredMemorySegments, Integer.MAX_VALUE, Optional.empty());
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;br/&gt;
@@ -114,6 +113,27 @@&lt;br/&gt;
 	 */&lt;br/&gt;
 	LocalBufferPool(NetworkBufferPool networkBufferPool, int numberOfRequiredMemorySegments,&lt;br/&gt;
 			int maxNumberOfMemorySegments) &lt;/p&gt;
{
+		this(networkBufferPool, numberOfRequiredMemorySegments, maxNumberOfMemorySegments, Optional.empty());
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Local buffer pool based on the given &amp;lt;tt&amp;gt;networkBufferPool&amp;lt;/tt&amp;gt; and &amp;lt;tt&amp;gt;bufferPoolOwner&amp;lt;/tt&amp;gt;&lt;br/&gt;
+	 * with a minimal and maximal number of network buffers being available.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param networkBufferPool&lt;br/&gt;
+	 * 		global network buffer pool to get buffers from&lt;br/&gt;
+	 * @param numberOfRequiredMemorySegments&lt;br/&gt;
+	 * 		minimum number of network buffers&lt;br/&gt;
+	 * @param maxNumberOfMemorySegments&lt;br/&gt;
+	 * 		maximum number of network buffers to allocate&lt;br/&gt;
+	 * 	@param owner&lt;br/&gt;
+	 * 		the optional owner of this buffer pool to release memory when needed&lt;br/&gt;
+	 */&lt;br/&gt;
+	LocalBufferPool(&lt;br/&gt;
+		NetworkBufferPool networkBufferPool,&lt;br/&gt;
+		int numberOfRequiredMemorySegments,&lt;br/&gt;
+		int maxNumberOfMemorySegments,&lt;br/&gt;
+		Optional&amp;lt;BufferPoolOwner&amp;gt; owner) &lt;/p&gt;
{
 		checkArgument(maxNumberOfMemorySegments &amp;gt;= numberOfRequiredMemorySegments,
 			&quot;Maximum number of memory segments (%s) should not be smaller than minimum (%s).&quot;,
 			maxNumberOfMemorySegments, numberOfRequiredMemorySegments);
@@ -129,6 +149,7 @@
 		this.numberOfRequiredMemorySegments = numberOfRequiredMemorySegments;
 		this.currentPoolSize = numberOfRequiredMemorySegments;
 		this.maxNumberOfMemorySegments = maxNumberOfMemorySegments;
+		this.owner = owner;
 	}

&lt;p&gt; 	// ------------------------------------------------------------------------&lt;br/&gt;
@@ -176,14 +197,6 @@ public int bestEffortGetNumOfUsedBuffers() &lt;/p&gt;
{
 		return Math.max(0, numberOfRequestedMemorySegments - availableMemorySegments.size());
 	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void setBufferPoolOwner(BufferPoolOwner owner) {&lt;/li&gt;
	&lt;li&gt;synchronized (availableMemorySegments) 
{
-			checkState(this.owner == null, &quot;Buffer pool owner has already been set.&quot;);
-			this.owner = checkNotNull(owner);
-		}&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
-&lt;br/&gt;
 	@Override&lt;br/&gt;
 	public Buffer requestBuffer() throws IOException {&lt;br/&gt;
 		try {&lt;br/&gt;
@@ -222,7 +235,7 @@ private MemorySegment requestMemorySegment(boolean isBlocking) throws Interrupte&lt;br/&gt;
 		synchronized (availableMemorySegments) {&lt;br/&gt;
 			returnExcessMemorySegments();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;boolean askToRecycle = owner != null;&lt;br/&gt;
+			boolean askToRecycle = owner.isPresent();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			// fill availableMemorySegments with at least one element, wait if required&lt;br/&gt;
 			while (availableMemorySegments.isEmpty()) &lt;/p&gt;
{
@@ -240,7 +253,7 @@ private MemorySegment requestMemorySegment(boolean isBlocking) throws Interrupte
 				}

&lt;p&gt; 				if (askToRecycle) &lt;/p&gt;
{
-					owner.releaseMemory(1);
+					owner.get().releaseMemory(1);
 				}

&lt;p&gt; 				if (isBlocking) {&lt;br/&gt;
@@ -336,6 +349,7 @@ public boolean addBufferListener(BufferListener listener) {&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public void setNumBuffers(int numBuffers) throws IOException {&lt;br/&gt;
+		int numExcessBuffers;&lt;br/&gt;
 		synchronized (availableMemorySegments) {&lt;br/&gt;
 			checkArgument(numBuffers &amp;gt;= numberOfRequiredMemorySegments,&lt;br/&gt;
 					&quot;Buffer pool needs at least %s buffers, but tried to set to %s&quot;,&lt;br/&gt;
@@ -349,11 +363,13 @@ public void setNumBuffers(int numBuffers) throws IOException {&lt;/p&gt;

&lt;p&gt; 			returnExcessMemorySegments();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// If there is a registered owner and we have still requested more buffers than our&lt;/li&gt;
	&lt;li&gt;// size, trigger a recycle via the owner.&lt;/li&gt;
	&lt;li&gt;if (owner != null &amp;amp;&amp;amp; numberOfRequestedMemorySegments &amp;gt; currentPoolSize) 
{
-				owner.releaseMemory(numberOfRequestedMemorySegments - currentPoolSize);
-			}
&lt;p&gt;+			numExcessBuffers = numberOfRequestedMemorySegments - currentPoolSize;&lt;br/&gt;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		// If there is a registered owner and we have still requested more buffers than our&lt;br/&gt;
+		// size, trigger a recycle via the owner.&lt;br/&gt;
+		if (owner.isPresent() &amp;amp;&amp;amp; numExcessBuffers &amp;gt; 0) &lt;/p&gt;
{
+			owner.get().releaseMemory(numExcessBuffers);
 		}
&lt;p&gt; 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPool.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPool.java&lt;br/&gt;
index 1fddb612781..48ce27e90b1 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPool.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPool.java&lt;br/&gt;
@@ -33,6 +33,7 @@&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
+import java.util.Optional;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.concurrent.ArrayBlockingQueue;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;br/&gt;
@@ -253,6 +254,11 @@ public int countBuffers() {&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public BufferPool createBufferPool(int numRequiredBuffers, int maxUsedBuffers) throws IOException &lt;/p&gt;
{
+		return createBufferPool(numRequiredBuffers, maxUsedBuffers, Optional.empty());
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public BufferPool createBufferPool(int numRequiredBuffers, int maxUsedBuffers, Optional&amp;lt;BufferPoolOwner&amp;gt; owner) throws IOException {&lt;br/&gt;
 		// It is necessary to use a separate lock from the one used for buffer&lt;br/&gt;
 		// requests to ensure deadlock freedom for failure cases.&lt;br/&gt;
 		synchronized (factoryLock) {&lt;br/&gt;
@@ -281,7 +287,7 @@ public BufferPool createBufferPool(int numRequiredBuffers, int maxUsedBuffers) t&lt;br/&gt;
 			// We are good to go, create a new buffer pool and redistribute&lt;br/&gt;
 			// non-fixed size buffers.&lt;br/&gt;
 			LocalBufferPool localBufferPool =&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new LocalBufferPool(this, numRequiredBuffers, maxUsedBuffers);&lt;br/&gt;
+				new LocalBufferPool(this, numRequiredBuffers, maxUsedBuffers, owner);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			allBufferPools.add(localBufferPool);&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultPartition.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultPartition.java&lt;br/&gt;
index b32f73f8bcc..85fc5602ef3 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultPartition.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultPartition.java&lt;br/&gt;
@@ -187,12 +187,6 @@ public void registerBufferPool(BufferPool bufferPool) {&lt;br/&gt;
 		checkState(this.bufferPool == null, &quot;Bug in result partition setup logic: Already registered buffer pool.&quot;);&lt;/p&gt;

&lt;p&gt; 		this.bufferPool = checkNotNull(bufferPool);&lt;br/&gt;
-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// If the partition type is back pressure-free, we register with the buffer pool for&lt;/li&gt;
	&lt;li&gt;// callbacks to release memory.&lt;/li&gt;
	&lt;li&gt;if (!partitionType.hasBackPressure()) 
{
-			bufferPool.setBufferPoolOwner(this);
-		}
&lt;p&gt; 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	public JobID getJobId() {&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/NetworkEnvironmentTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/NetworkEnvironmentTest.java&lt;br/&gt;
index f0f1926b008..8c2fb7a15f0 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/NetworkEnvironmentTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/NetworkEnvironmentTest.java&lt;br/&gt;
@@ -21,7 +21,6 @@&lt;br/&gt;
 import org.apache.flink.api.common.JobID;&lt;br/&gt;
 import org.apache.flink.configuration.TaskManagerOptions;&lt;br/&gt;
 import org.apache.flink.runtime.io.disk.iomanager.IOManager;&lt;br/&gt;
-import org.apache.flink.runtime.io.network.buffer.NetworkBufferPool;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.partition.NoOpResultPartitionConsumableNotifier;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.partition.ResultPartition;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.partition.ResultPartitionID;&lt;br/&gt;
@@ -31,7 +30,6 @@&lt;br/&gt;
 import org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate;&lt;br/&gt;
 import org.apache.flink.runtime.jobgraph.IntermediateDataSetID;&lt;br/&gt;
 import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
-import org.apache.flink.runtime.query.KvStateRegistry;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.Task;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.TaskActions;&lt;/p&gt;

&lt;p&gt;@@ -79,21 +77,8 @@&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testRegisterTaskUsesBoundedBuffers() throws Exception {&lt;br/&gt;
-&lt;br/&gt;
 		final NetworkEnvironment network = new NetworkEnvironment(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new NetworkBufferPool(numBuffers, memorySegmentSize),&lt;/li&gt;
	&lt;li&gt;new LocalConnectionManager(),&lt;/li&gt;
	&lt;li&gt;new ResultPartitionManager(),&lt;/li&gt;
	&lt;li&gt;new TaskEventDispatcher(),&lt;/li&gt;
	&lt;li&gt;new KvStateRegistry(),&lt;/li&gt;
	&lt;li&gt;null,&lt;/li&gt;
	&lt;li&gt;null,&lt;/li&gt;
	&lt;li&gt;IOManager.IOMode.SYNC,&lt;/li&gt;
	&lt;li&gt;0,&lt;/li&gt;
	&lt;li&gt;0,&lt;/li&gt;
	&lt;li&gt;2,&lt;/li&gt;
	&lt;li&gt;8,&lt;/li&gt;
	&lt;li&gt;enableCreditBasedFlowControl);&lt;br/&gt;
+			numBuffers, memorySegmentSize, 0, 0, 2, 8, enableCreditBasedFlowControl);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		// result partitions&lt;br/&gt;
 		ResultPartition rp1 = createResultPartition(ResultPartitionType.PIPELINED, 2);&lt;br/&gt;
@@ -197,19 +182,7 @@ public void testRegisterTaskWithInsufficientBuffers() throws Exception {&lt;/p&gt;

&lt;p&gt; 	private void testRegisterTaskWithLimitedBuffers(int bufferPoolSize) throws Exception {&lt;br/&gt;
 		final NetworkEnvironment network = new NetworkEnvironment(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new NetworkBufferPool(bufferPoolSize, memorySegmentSize),&lt;/li&gt;
	&lt;li&gt;new LocalConnectionManager(),&lt;/li&gt;
	&lt;li&gt;new ResultPartitionManager(),&lt;/li&gt;
	&lt;li&gt;new TaskEventDispatcher(),&lt;/li&gt;
	&lt;li&gt;new KvStateRegistry(),&lt;/li&gt;
	&lt;li&gt;null,&lt;/li&gt;
	&lt;li&gt;null,&lt;/li&gt;
	&lt;li&gt;IOManager.IOMode.SYNC,&lt;/li&gt;
	&lt;li&gt;0,&lt;/li&gt;
	&lt;li&gt;0,&lt;/li&gt;
	&lt;li&gt;2,&lt;/li&gt;
	&lt;li&gt;8,&lt;/li&gt;
	&lt;li&gt;enableCreditBasedFlowControl);&lt;br/&gt;
+			bufferPoolSize, memorySegmentSize, 0, 0, 2, 8, enableCreditBasedFlowControl);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		final ConnectionManager connManager = createDummyConnectionManager();&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPoolTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPoolTest.java&lt;br/&gt;
index 8d6be0c4ac8..4e8eec696fc 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPoolTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPoolTest.java&lt;br/&gt;
@@ -31,6 +31,7 @@&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
+import java.util.Optional;&lt;/p&gt;

&lt;p&gt; import static org.hamcrest.CoreMatchers.instanceOf;&lt;br/&gt;
 import static org.hamcrest.CoreMatchers.nullValue;&lt;br/&gt;
@@ -323,11 +324,11 @@ public void testRequestMemorySegmentsExceptionDuringBufferRedistribution() throw&lt;/p&gt;

&lt;p&gt; 		final List&amp;lt;Buffer&amp;gt; buffers = new ArrayList&amp;lt;&amp;gt;(numBuffers);&lt;br/&gt;
 		List&amp;lt;MemorySegment&amp;gt; memorySegments = Collections.emptyList();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;BufferPool bufferPool = networkBufferPool.createBufferPool(1, numBuffers);&lt;/li&gt;
	&lt;li&gt;// make releaseMemory calls always fail:&lt;/li&gt;
	&lt;li&gt;bufferPool.setBufferPoolOwner(numBuffersToRecycle -&amp;gt; 
{
-			throw new TestIOException();
-		}
&lt;p&gt;);&lt;br/&gt;
+		BufferPool bufferPool = networkBufferPool.createBufferPool(1, numBuffers,&lt;br/&gt;
+			// make releaseMemory calls always fail:&lt;br/&gt;
+			Optional.of(numBuffersToRecycle -&amp;gt; &lt;/p&gt;
{
+				throw new TestIOException();
+		}
&lt;p&gt;));&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		try {&lt;br/&gt;
 			// take all but one buffer&lt;br/&gt;
@@ -363,11 +364,10 @@ public void testCreateBufferPoolExceptionDuringBufferRedistribution() throws IOE&lt;br/&gt;
 		final NetworkBufferPool networkBufferPool = new NetworkBufferPool(numBuffers, 128);&lt;/p&gt;

&lt;p&gt; 		final List&amp;lt;Buffer&amp;gt; buffers = new ArrayList&amp;lt;&amp;gt;(numBuffers);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;BufferPool bufferPool = networkBufferPool.createBufferPool(1, numBuffers);&lt;/li&gt;
	&lt;li&gt;bufferPool.setBufferPoolOwner(&lt;/li&gt;
	&lt;li&gt;numBuffersToRecycle -&amp;gt; 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+		BufferPool bufferPool = networkBufferPool.createBufferPool(1, numBuffers,+			Optional.of(numBuffersToRecycle -&amp;gt; {
 				throw new TestIOException();
-			});+		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;));&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		try &lt;/p&gt;
{
 
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java
index 1f9bb6bc0e7..ad4cf8ecef5 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionTest.java
@@ -21,6 +21,8 @@
 import org.apache.flink.api.common.JobID;
 import org.apache.flink.runtime.io.disk.iomanager.IOManager;
 import org.apache.flink.runtime.io.disk.iomanager.IOManagerAsync;
+import org.apache.flink.runtime.io.network.NetworkEnvironment;
+import org.apache.flink.runtime.io.network.buffer.BufferBuilder;
 import org.apache.flink.runtime.io.network.buffer.BufferBuilderTestUtils;
 import org.apache.flink.runtime.io.network.buffer.BufferConsumer;
 import org.apache.flink.runtime.taskmanager.TaskActions;
@@ -30,6 +32,7 @@
 import org.junit.Test;
 
 import static org.apache.flink.runtime.io.network.buffer.BufferBuilderTestUtils.createFilledBufferConsumer;
+import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertFalse;
 import static org.mockito.Matchers.any;
 import static org.mockito.Matchers.eq;
@@ -205,6 +208,54 @@ protected void testAddOnPartition(final ResultPartitionType pipelined)
 		}
&lt;p&gt; 	}&lt;/p&gt;

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnBlockingPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.BLOCKING);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testReleaseMemoryOnPipelinedPartition() throws Exception &lt;/p&gt;
{
+		testReleaseMemory(ResultPartitionType.PIPELINED);
+	}
&lt;p&gt;+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Tests &lt;/p&gt;
{@link ResultPartition#releaseMemory(int)}
&lt;p&gt; on a working partition.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param resultPartitionType the result partition type to set up&lt;br/&gt;
+	 */&lt;br/&gt;
+	private void testReleaseMemory(final ResultPartitionType resultPartitionType) throws Exception {&lt;br/&gt;
+		final int numAllBuffers = 10;&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(numAllBuffers, 128, 0, 0, 2, 8, true);&lt;br/&gt;
+		final ResultPartitionConsumableNotifier notifier = new NoOpResultPartitionConsumableNotifier();&lt;br/&gt;
+		final ResultPartition resultPartition = createPartition(notifier, resultPartitionType, false);&lt;br/&gt;
+		try {&lt;br/&gt;
+			network.setupPartition(resultPartition);&lt;br/&gt;
+&lt;br/&gt;
+			// take all buffers (more than the minimum required)&lt;br/&gt;
+			for (int i = 0; i &amp;lt; numAllBuffers; ++i) &lt;/p&gt;
{
+				BufferBuilder bufferBuilder = resultPartition.getBufferPool().requestBufferBuilderBlocking();
+				resultPartition.addBufferConsumer(bufferBuilder.createBufferConsumer(), 0);
+			}
&lt;p&gt;+			resultPartition.finish();&lt;br/&gt;
+&lt;br/&gt;
+			assertEquals(0, resultPartition.getBufferPool().getNumberOfAvailableMemorySegments());&lt;br/&gt;
+&lt;br/&gt;
+			// reset the pool size less than the number of requested buffers&lt;br/&gt;
+			final int numLocalBuffers = 4;&lt;br/&gt;
+			resultPartition.getBufferPool().setNumBuffers(numLocalBuffers);&lt;br/&gt;
+&lt;br/&gt;
+			// partition with blocking type should release excess buffers&lt;br/&gt;
+			if (!resultPartitionType.hasBackPressure()) &lt;/p&gt;
{
+				assertEquals(numLocalBuffers, resultPartition.getBufferPool().getNumberOfAvailableMemorySegments());
+			}
&lt;p&gt; else &lt;/p&gt;
{
+				assertEquals(0, resultPartition.getBufferPool().getNumberOfAvailableMemorySegments());
+			}
&lt;p&gt;+		} finally &lt;/p&gt;
{
+			resultPartition.release();
+			network.shutdown();
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt; 	private static ResultPartition createPartition(&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java&lt;br/&gt;
index 4bf5b220be8..63f18551130 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java&lt;br/&gt;
@@ -25,7 +25,6 @@&lt;br/&gt;
 import org.apache.flink.runtime.deployment.ResultPartitionLocation;&lt;br/&gt;
 import org.apache.flink.runtime.event.TaskEvent;&lt;br/&gt;
 import org.apache.flink.runtime.executiongraph.ExecutionAttemptID;&lt;br/&gt;
-import org.apache.flink.runtime.io.disk.iomanager.IOManager;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.ConnectionID;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.ConnectionManager;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.LocalConnectionManager;&lt;br/&gt;
@@ -45,7 +44,6 @@&lt;br/&gt;
 import org.apache.flink.runtime.jobgraph.IntermediateDataSetID;&lt;br/&gt;
 import org.apache.flink.runtime.jobgraph.IntermediateResultPartitionID;&lt;br/&gt;
 import org.apache.flink.runtime.metrics.groups.UnregisteredMetricGroups;&lt;br/&gt;
-import org.apache.flink.runtime.query.KvStateRegistry;&lt;br/&gt;
 import org.apache.flink.runtime.taskmanager.TaskActions;&lt;/p&gt;

&lt;p&gt; import org.junit.Test;&lt;br/&gt;
@@ -71,7 +69,6 @@&lt;br/&gt;
 import static org.mockito.Matchers.anyInt;&lt;br/&gt;
 import static org.mockito.Mockito.mock;&lt;br/&gt;
 import static org.mockito.Mockito.never;&lt;br/&gt;
-import static org.mockito.Mockito.spy;&lt;br/&gt;
 import static org.mockito.Mockito.times;&lt;br/&gt;
 import static org.mockito.Mockito.verify;&lt;br/&gt;
 import static org.mockito.Mockito.when;&lt;br/&gt;
@@ -344,7 +341,8 @@ public void testRequestBackoffConfiguration() throws Exception {&lt;br/&gt;
 		int initialBackoff = 137;&lt;br/&gt;
 		int maxBackoff = 1001;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final NetworkEnvironment netEnv = createNetworkEnvironment(2, 8, initialBackoff, maxBackoff);&lt;br/&gt;
+		final NetworkEnvironment netEnv = new NetworkEnvironment(&lt;br/&gt;
+			100, 32, initialBackoff, maxBackoff, 2, 8, enableCreditBasedFlowControl);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		SingleInputGate gate = SingleInputGate.create(&lt;br/&gt;
 			&quot;TestTask&quot;,&lt;br/&gt;
@@ -403,8 +401,8 @@ public void testRequestBuffersWithRemoteInputChannel() throws Exception {&lt;br/&gt;
 		final SingleInputGate inputGate = createInputGate(1, ResultPartitionType.PIPELINED_BOUNDED);&lt;br/&gt;
 		int buffersPerChannel = 2;&lt;br/&gt;
 		int extraNetworkBuffersPerGate = 8;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final NetworkEnvironment network = createNetworkEnvironment(buffersPerChannel,&lt;/li&gt;
	&lt;li&gt;extraNetworkBuffersPerGate, 0, 0);&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;br/&gt;
+			100, 32, 0, 0, buffersPerChannel, extraNetworkBuffersPerGate, enableCreditBasedFlowControl);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		try {&lt;br/&gt;
 			final ResultPartitionID resultPartitionId = new ResultPartitionID();&lt;br/&gt;
@@ -415,8 +413,6 @@ public void testRequestBuffersWithRemoteInputChannel() throws Exception {&lt;/p&gt;

&lt;p&gt; 			NetworkBufferPool bufferPool = network.getNetworkBufferPool();&lt;br/&gt;
 			if (enableCreditBasedFlowControl) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;verify(bufferPool,&lt;/li&gt;
	&lt;li&gt;times(1)).requestMemorySegments(buffersPerChannel);&lt;br/&gt;
 				RemoteInputChannel remote = (RemoteInputChannel) inputGate.getInputChannels()&lt;br/&gt;
 					.get(resultPartitionId.getPartitionId());&lt;br/&gt;
 				// only the exclusive buffers should be assigned/available now&lt;br/&gt;
@@ -444,7 +440,8 @@ public void testRequestBuffersWithUnknownInputChannel() throws Exception {&lt;br/&gt;
 		final SingleInputGate inputGate = createInputGate(1, ResultPartitionType.PIPELINED_BOUNDED);&lt;br/&gt;
 		int buffersPerChannel = 2;&lt;br/&gt;
 		int extraNetworkBuffersPerGate = 8;&lt;/li&gt;
	&lt;li&gt;final NetworkEnvironment network = createNetworkEnvironment(buffersPerChannel, extraNetworkBuffersPerGate, 0, 0);&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;br/&gt;
+			100, 32, 0, 0, buffersPerChannel, extraNetworkBuffersPerGate, enableCreditBasedFlowControl);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		try {&lt;br/&gt;
 			final ResultPartitionID resultPartitionId = new ResultPartitionID();&lt;br/&gt;
@@ -454,8 +451,6 @@ public void testRequestBuffersWithUnknownInputChannel() throws Exception {&lt;br/&gt;
 			NetworkBufferPool bufferPool = network.getNetworkBufferPool();&lt;/p&gt;

&lt;p&gt; 			if (enableCreditBasedFlowControl) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;verify(bufferPool, times(0)).requestMemorySegments(buffersPerChannel);&lt;br/&gt;
-&lt;br/&gt;
 				assertEquals(bufferPool.getTotalNumberOfMemorySegments(),&lt;br/&gt;
 					bufferPool.getNumberOfAvailableMemorySegments());&lt;br/&gt;
 				// note: exclusive buffers are not handed out into LocalBufferPool and are thus not counted&lt;br/&gt;
@@ -471,8 +466,6 @@ public void testRequestBuffersWithUnknownInputChannel() throws Exception {&lt;br/&gt;
 				ResultPartitionLocation.createRemote(connectionId)));&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			if (enableCreditBasedFlowControl) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;verify(bufferPool,&lt;/li&gt;
	&lt;li&gt;times(1)).requestMemorySegments(buffersPerChannel);&lt;br/&gt;
 				RemoteInputChannel remote = (RemoteInputChannel) inputGate.getInputChannels()&lt;br/&gt;
 					.get(resultPartitionId.getPartitionId());&lt;br/&gt;
 				// only the exclusive buffers should be assigned/available now&lt;br/&gt;
@@ -499,7 +492,8 @@ public void testRequestBuffersWithUnknownInputChannel() throws Exception {&lt;br/&gt;
 	public void testUpdateUnknownInputChannel() throws Exception {&lt;br/&gt;
 		final SingleInputGate inputGate = createInputGate(2);&lt;br/&gt;
 		int buffersPerChannel = 2;&lt;/li&gt;
	&lt;li&gt;final NetworkEnvironment network = createNetworkEnvironment(buffersPerChannel, 8, 0, 0);&lt;br/&gt;
+		final NetworkEnvironment network = new NetworkEnvironment(&lt;br/&gt;
+			100, 32, 0, 0, buffersPerChannel, 8, enableCreditBasedFlowControl);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		try {&lt;br/&gt;
 			final ResultPartitionID localResultPartitionId = new ResultPartitionID();&lt;br/&gt;
@@ -543,27 +537,6 @@ public void testUpdateUnknownInputChannel() throws Exception {&lt;/p&gt;

&lt;p&gt; 	// ---------------------------------------------------------------------------------------------&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private NetworkEnvironment createNetworkEnvironment(&lt;/li&gt;
	&lt;li&gt;int buffersPerChannel,&lt;/li&gt;
	&lt;li&gt;int extraNetworkBuffersPerGate,&lt;/li&gt;
	&lt;li&gt;int initialBackoff,&lt;/li&gt;
	&lt;li&gt;int maxBackoff) 
{
-		return new NetworkEnvironment(
-			spy(new NetworkBufferPool(100, 32)),
-			new LocalConnectionManager(),
-			new ResultPartitionManager(),
-			new TaskEventDispatcher(),
-			new KvStateRegistry(),
-			null,
-			null,
-			IOManager.IOMode.SYNC,
-			initialBackoff,
-			maxBackoff,
-			buffersPerChannel,
-			extraNetworkBuffersPerGate,
-			enableCreditBasedFlowControl);
-	}
&lt;p&gt;-&lt;br/&gt;
 	private SingleInputGate createInputGate() &lt;/p&gt;
{
 		return createInputGate(2);
 	}
&lt;p&gt;diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/taskmanager/TaskManagerComponentsStartupShutdownTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/taskmanager/TaskManagerComponentsStartupShutdownTest.java&lt;br/&gt;
index 9669513a111..c3118c91f9d 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/taskmanager/TaskManagerComponentsStartupShutdownTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/taskmanager/TaskManagerComponentsStartupShutdownTest.java&lt;br/&gt;
@@ -33,11 +33,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedHaServices;&lt;br/&gt;
 import org.apache.flink.runtime.io.disk.iomanager.IOManager;&lt;br/&gt;
 import org.apache.flink.runtime.io.disk.iomanager.IOManagerAsync;&lt;br/&gt;
-import org.apache.flink.runtime.io.network.LocalConnectionManager;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.NetworkEnvironment;&lt;br/&gt;
-import org.apache.flink.runtime.io.network.TaskEventDispatcher;&lt;br/&gt;
-import org.apache.flink.runtime.io.network.buffer.NetworkBufferPool;&lt;br/&gt;
-import org.apache.flink.runtime.io.network.partition.ResultPartitionManager;&lt;br/&gt;
 import org.apache.flink.runtime.jobmanager.JobManager;&lt;br/&gt;
 import org.apache.flink.runtime.jobmanager.MemoryArchivist;&lt;br/&gt;
 import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
@@ -45,7 +41,6 @@&lt;br/&gt;
 import org.apache.flink.runtime.metrics.MetricRegistryConfiguration;&lt;br/&gt;
 import org.apache.flink.runtime.metrics.NoOpMetricRegistry;&lt;br/&gt;
 import org.apache.flink.runtime.metrics.groups.TaskManagerMetricGroup;&lt;br/&gt;
-import org.apache.flink.runtime.query.KvStateRegistry;&lt;br/&gt;
 import org.apache.flink.runtime.state.TaskExecutorLocalStateStoresManager;&lt;br/&gt;
 import org.apache.flink.runtime.taskexecutor.TaskManagerConfiguration;&lt;br/&gt;
 import org.apache.flink.runtime.testingUtils.TestingUtils;&lt;br/&gt;
@@ -146,14 +141,8 @@ public void testComponentsStartupShutdown() throws Exception {&lt;br/&gt;
 			final MemoryManager memManager = new MemoryManager(networkBufNum * BUFFER_SIZE, 1, BUFFER_SIZE, MemoryType.HEAP, false);&lt;br/&gt;
 			final IOManager ioManager = new IOManagerAsync(TMP_DIR);&lt;br/&gt;
 			final NetworkEnvironment network = new NetworkEnvironment(&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;new NetworkBufferPool(32, netConf.networkBufferSize()),&lt;/li&gt;
	&lt;li&gt;new LocalConnectionManager(),&lt;/li&gt;
	&lt;li&gt;new ResultPartitionManager(),&lt;/li&gt;
	&lt;li&gt;new TaskEventDispatcher(),&lt;/li&gt;
	&lt;li&gt;new KvStateRegistry(),&lt;/li&gt;
	&lt;li&gt;null,&lt;/li&gt;
	&lt;li&gt;null,&lt;/li&gt;
	&lt;li&gt;netConf.ioMode(),&lt;br/&gt;
+				32,&lt;br/&gt;
+				netConf.networkBufferSize(),&lt;br/&gt;
 				netConf.partitionRequestInitialBackoff(),&lt;br/&gt;
 				netConf.partitionRequestMaxBackoff(),&lt;br/&gt;
 				netConf.networkBuffersPerChannel(),&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16660686" author="pnowojski" created="Tue, 23 Oct 2018 13:57:02 +0000"  >&lt;p&gt;Merged to:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master/1.7.0 as ee6a4dead18348f72166f980b01868d896e1f88f..5953bb603b459d34a8b1df15ca5979dd23a2f52f&lt;/li&gt;
	&lt;li&gt;1.6.3 as c9e8bf8c496f2af85984d7f0c85b747c942a4742..56aed0b88d3069e8491128b46f2b52ce3767870f&lt;/li&gt;
	&lt;li&gt;1.5.6 as f1a01a7f7b1e324b81200a49a747ec4543bf5800..6373b59787969f06992982c7e38ce85c3094d58d&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ytxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>