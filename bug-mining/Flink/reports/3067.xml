<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:39:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-13063] AsyncWaitOperator shouldn&apos;t be releasing checkpointingLock</title>
                <link>https://issues.apache.org/jira/browse/FLINK-13063</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;1.&lt;/p&gt;

&lt;p&gt;For the following setup of chained operators:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SourceOperator -&amp;gt; FlatMap -&amp;gt; AsyncOperator&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Lets&#160;assume that input buffer of &lt;tt&gt;AsyncOperator&lt;/tt&gt; is full. We start processing a record from the &lt;tt&gt;SourceOperator&lt;/tt&gt;, we pass it to the &lt;tt&gt;FlatMap&lt;/tt&gt;, which&#160;fan it out (multiplies it 10 times). First multiplied record reaches &lt;tt&gt;AsyncOperator&lt;/tt&gt; and is special treated (stored in &lt;tt&gt;AsyncWaitOperator#pendingStreamElementQueueEntry&lt;/tt&gt; ) and then &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt;&#160;waits (and releases) on the checkpoint lock (in &lt;tt&gt;AsyncWaitOperator#addAsyncBufferEntry&lt;/tt&gt;&#160;. If a checkpoint is triggered now, both &lt;tt&gt;SourceOperator&lt;/tt&gt; and &lt;tt&gt;FlatMap&lt;/tt&gt; will be checkpointed assumed that all of those 10 multiplied records were processed, which is not true. Only the first one is&#160;checkpointed by the &lt;tt&gt;AsyncWatiOperator&lt;/tt&gt;. Remaining 9 are not. So if we ever restore state from this checkpoint, we have lost those 9 records.&lt;/p&gt;

&lt;p&gt;2.&lt;/p&gt;

&lt;p&gt;Similar issue (I think previously known) can happen if for example some upstream operator to the &lt;tt&gt;AsyncOperator&lt;/tt&gt; fires a processing time timer, that emits some data. But in that case, &lt;tt&gt;AsyncWaitOperator#pendingStreamElementQueueEntry&lt;/tt&gt;&#160;is being overwritten.&lt;/p&gt;

&lt;p&gt;3.&lt;/p&gt;

&lt;p&gt;If upstream operator has the following pseudo code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
stateA = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
output.collect(x)
stateB = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;one would assume that stateA and stateB access/writes will be atomic from the perspective of the checkpoints. But again, because &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; releases the checkpoint lock, they will not be.&lt;/p&gt;

&lt;p&gt;CC&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=StephanEwen&quot; class=&quot;user-hover&quot; rel=&quot;StephanEwen&quot;&gt;StephanEwen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13242792">FLINK-13063</key>
            <summary>AsyncWaitOperator shouldn&apos;t be releasing checkpointingLock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 2 Jul 2019 16:17:38 +0000</created>
                <updated>Mon, 27 Jun 2022 09:21:36 +0000</updated>
                            <resolved>Tue, 9 Jul 2019 12:09:38 +0000</resolved>
                                    <version>1.6.4</version>
                    <version>1.7.2</version>
                    <version>1.8.1</version>
                    <version>1.9.0</version>
                                    <fixVersion>1.9.0</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16877112" author="pnowojski" created="Tue, 2 Jul 2019 16:22:17 +0000"  >&lt;p&gt;Hot fix is to ensure that &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; is always a head of an operator chain.&lt;/p&gt;

&lt;p&gt;Proper solution might require a better/extended mailbox implementation (when &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; is full,&#160;yield only to down the stream operators), that&apos;s beyond our reach for 1.9 release.&lt;/p&gt;</comment>
                            <comment id="16878132" author="stephanewen" created="Wed, 3 Jul 2019 19:57:47 +0000"  >&lt;p&gt;+1 to fix this for now by forcing Async I/O operator to always be head-of-chain&lt;/p&gt;</comment>
                            <comment id="16878134" author="stephanewen" created="Wed, 3 Jul 2019 19:58:36 +0000"  >&lt;p&gt;As discussed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt; - a proper mailbox model can solve this consistently in the future without requiring to break the chain.&lt;/p&gt;</comment>
                            <comment id="16878497" author="1u0" created="Thu, 4 Jul 2019 09:39:48 +0000"  >&lt;p&gt;I have encountered another issue with &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; and how it interferes with checkpoints:&lt;/p&gt;

&lt;p&gt;if the async function finishes some &lt;tt&gt;ResultFuture&lt;/tt&gt; s with exception, some elements may be passed/emitted to downstream task(s) more than once.&lt;/p&gt;

&lt;p&gt;An example test Flink job, may look like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Source (1) -&amp;gt; AsyncOperator (1) -&amp;gt; Map (1) -&amp;gt; Sink (1)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;ve created an example Flink job (hopefully properly implementing exactly-once source and sink, and state management) in &lt;a href=&quot;https://github.com/1u0/flink/blob/bug-async-function-more-than-once/flink-streaming-java/src/test/java/org/apache/flink/MyTestIT.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/1u0/flink/blob/bug-async-function-more-than-once/flink-streaming-java/src/test/java/org/apache/flink/MyTestIT.java&lt;/a&gt;. In this test job, the operator after the &lt;tt&gt;AsyncFunction&lt;/tt&gt; just adds counter of seen events. In a test run, it&apos;s possible to see some committed events more than once with different counter values.&lt;/p&gt;</comment>
                            <comment id="16878508" author="pnowojski" created="Thu, 4 Jul 2019 09:55:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=1u0&quot; class=&quot;user-hover&quot; rel=&quot;1u0&quot;&gt;1u0&lt;/a&gt; could you write down why is it happening where is the bug?&lt;/p&gt;</comment>
                            <comment id="16879112" author="1u0" created="Fri, 5 Jul 2019 09:35:25 +0000"  >&lt;p&gt;I think the root cause is the same, that the &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt;&#160;releases the lock in &lt;tt&gt;processElement|Watermark()&lt;/tt&gt;. And can be addressed by not allowing the &lt;tt&gt;AsyncWaitOperator&lt;/tt&gt; to be after some other operator in a chain.&lt;/p&gt;

&lt;p&gt;The duplicates are happening due to:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the example source considers an element to be processed only after &lt;tt&gt;SourceContext.collect()&lt;/tt&gt; returns;&lt;/li&gt;
	&lt;li&gt;the second (duplicate) copy of the element happens to be the snapshotted &lt;tt&gt;AsyncWaitOperator.pendingStreamElementQueueEntry&lt;/tt&gt; that was passed in a &quot;pending&quot; &lt;tt&gt;processElement()&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16881177" author="srichter" created="Tue, 9 Jul 2019 12:09:38 +0000"  >&lt;p&gt;Merged in:&lt;br/&gt;
master: c773ce5&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13286803">FLINK-16219</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04b2w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>This changes the default chaining behavior of the AsyncWaitOperator. By default, we now break chains so that the AsyncWaitOperator is never chained after another operator.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>