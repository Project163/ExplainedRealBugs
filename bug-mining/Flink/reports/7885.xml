<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:22:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-38201] SinkUpsertMaterializer should not be inserted for retract sinks</title>
                <link>https://issues.apache.org/jira/browse/FLINK-38201</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently, the logic in FlinkChangelogModeInferenceProgram for enabling upsert materialize does not distinguish between retract and upsert. Thus, SinkUpsertMaterializer is added for retract sinks. The resulting changelog is incorrect as it misses -U. Retract is flexible enough to simply be passed to the sink without further changes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13625661">FLINK-38201</key>
            <summary>SinkUpsertMaterializer should not be inserted for retract sinks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="twalthr">Timo Walther</assignee>
                                    <reporter username="twalthr">Timo Walther</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 6 Aug 2025 14:37:35 +0000</created>
                <updated>Fri, 15 Aug 2025 07:47:33 +0000</updated>
                            <resolved>Mon, 11 Aug 2025 15:17:52 +0000</resolved>
                                    <version>2.1.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="18013244" author="twalthr" created="Mon, 11 Aug 2025 15:17:52 +0000"  >&lt;p&gt;Fixed in master: 00241a679f107d7bd7ef6c4925785fd5eda5292a&lt;/p&gt;</comment>
                            <comment id="18013666" author="xuyangzhong" created="Wed, 13 Aug 2025 11:46:39 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; I have some doubts about whether we can remove the sink materializer from the retract sink without loss. Assuming we have an upstream node with the upsert key `b`, writing to a sink where the primary key is column `a`, and the sink is a retract sink.&lt;/p&gt;

&lt;p&gt;If two subtasks on the upstream node produce the following data: subtask1 sends `+I(a1, b1)` and `-U(a1, b1)`; subtask2 sends `+U(a1, b2)`. What will be the final result?&lt;/p&gt;

&lt;p&gt;In fact, there will be several possible sequences of data that the sink can receive:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If the sink receives `+I(a1, b1)`, `-U(a1, b1)`, and `+U(a1, b2)` in that order, then regardless of whether there is a sink materializer node, we will ultimately get `a1, b2`.&lt;/li&gt;
	&lt;li&gt;If the sink receives `+I(a1, b1)`, `+U(a1, b2)`, and `-U(a1, b1)` in that order, and if there is a sink materializer, the result will be `a1, b2`. But what is the current result after removing the sink materializer?&lt;/li&gt;
	&lt;li&gt;If the sink receives `+U(a1, b2)`, `+I(a1, b1)`, and `-U(a1, b1)` in that order, and if there is a sink materializer, the result will be `a1, b2`. But what is the current result after removing the sink materializer?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="18014058" author="twalthr" created="Fri, 15 Aug 2025 07:43:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuyangzhong&quot; class=&quot;user-hover&quot; rel=&quot;xuyangzhong&quot;&gt;xuyangzhong&lt;/a&gt;, thanks for taking the time and diving deeper into this topic. Let me try to give some explanation:&lt;/p&gt;

&lt;p&gt;Retract sinks work different than upsert sinks. Usually they need to shuffle either on the entire row or a subset of columns. The subset of columns does not have to be related to the upsert key. In general, retract sinks do not have problems with changelog disorder as they can support duplicates. After materialization of these duplicates, the changelog disorder is resolved. But this materialization does not need to happen within Flink. In fact a retract source in Flink, can simplify consume these changes without any issues.&lt;/p&gt;

&lt;p&gt;Retract is actually more related to append than to upsert mode. Retract sinks should behave like append sinks. For the append case, we also just blindly accept the PRIMARY KEY declaration without checking with an upsert key. Take for example a `SELECT * FROM t1 UNION ALL SELECT * FROM t2` with both tables in append with PK. And this is fine because the key is marked as NOT ENFORCED. What the PR did is to just remove the SinkUpsertMaterializer, because it did not fit into the pipeline.&lt;/p&gt;

&lt;p&gt;In general, I would not advise users to set the primary key on retract sinks. But if they want, the behavior is as inconsistent as with append sinks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1x4tk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>