<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20097] Race conditions in InputChannel.ChannelStatePersister</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20097</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In InputChannel.ChannelStatePersister, stopPersisting() and checkForBarrier() always update pendingCheckpointBarrierId, potentially overwriting newer id (or BARRIER_RECEIVED value) with an old one.&lt;/p&gt;


&lt;p&gt;For stopPersisting(), consider a case:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Two consecutive UC barriers arrive at the same channel (1st being stale at some point)&lt;/li&gt;
	&lt;li&gt;In RemoteInputChannel.onBuffer, netty thread updates pendingCheckpointBarrierId to BARRIER_RECEIVED&lt;/li&gt;
	&lt;li&gt;Task thread processes the 1st barrier and triggers a checkpoint&lt;br/&gt;
Task thread processes the 2nd barrier and aborts 1st checkpoint, calling stopPersisting() from UC controller and setting pendingCheckpointBarrierId to CHECKPOINT_COMPLETED&lt;/li&gt;
	&lt;li&gt;Task thread starts 2nd checkpoint and calls startPersisting() setting pendingCheckpointBarrierId to 2&lt;/li&gt;
	&lt;li&gt;now new buffers have a chance to be included in the 2nd checkpoint (though they belong to the next one)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For pendingCheckpointBarrierId(), consider&#160;an input gate with two channels A and B and two barriers 1 and 2:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Channel A receives both barriers, channel B receives nothing yet&lt;/li&gt;
	&lt;li&gt;Task thread processes both barriers on A, eventually triggering 2nd checkpoint&lt;/li&gt;
	&lt;li&gt;Channel A state is now BARRIER_RECEIVED, channel B - pending (with id=2)&lt;/li&gt;
	&lt;li&gt;Channel B receives the 1st barrier and becomes BARRIER_RECEIVED&lt;/li&gt;
	&lt;li&gt;No buffers in B between barriers 1 and 2 will be included in the checkpoint&#160;&lt;/li&gt;
	&lt;li&gt;Channel B receives the 2nd barrier which will eventually conclude the checkpoint&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I see a solution in doing an action only if passed checkpointId &amp;gt;= pendingCheckpointId. For that, a separate field will be needed to hold the status (RECEIVED/COMPLETED/PENDING). The class isn&apos;t thread-safe so it shouldn&apos;t be a problem.&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13340030">FLINK-20097</key>
            <summary>Race conditions in InputChannel.ChannelStatePersister</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="roman">Roman Khachatryan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 11 Nov 2020 17:52:47 +0000</created>
                <updated>Tue, 22 Jun 2021 13:55:38 +0000</updated>
                            <resolved>Thu, 12 Nov 2020 13:47:18 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17230145" author="roman_khachatryan" created="Wed, 11 Nov 2020 18:08:40 +0000"  >&lt;p&gt;I&apos;ve &lt;a href=&quot;https://github.com/apache/flink/pull/14040/commits/a2495da394a27d4bd503bdd0c5cfd8b7a8e92c43&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;added&lt;/a&gt; a unit test for the 1st part.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AHeise&quot; class=&quot;user-hover&quot; rel=&quot;AHeise&quot;&gt;AHeise&lt;/a&gt;, can you confirm this?&lt;/p&gt;

&lt;p&gt;If this is an issue, I&apos;m wondering why it wasn&apos;t detected by the existing tests.&lt;/p&gt;</comment>
                            <comment id="17230183" author="roman_khachatryan" created="Wed, 11 Nov 2020 19:41:47 +0000"  >&lt;p&gt;OK, the tests fail with&#160;the increased checkpointing frequency plus some other settings updated.&lt;br/&gt;
 I don&apos;t know whether the root cause is what I described above.&lt;/p&gt;

&lt;p&gt;Changes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; minCheckpoints = 100;

env.enableCheckpointing(10);
env.getCheckpointConfig().setAlignmentTimeout(0);
env.getCheckpointConfig().setCheckpointTimeout(10); &lt;span class=&quot;code-comment&quot;&gt;// minimum allowed
&lt;/span&gt;env.getCheckpointConfig().setMaxConcurrentCheckpoints(1);
env.getCheckpointConfig().setMinPauseBetweenCheckpoints(0);
env.getCheckpointConfig().setTolerableCheckpointFailureNumber(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);

&lt;span class=&quot;code-comment&quot;&gt;// can be lower because of the high TolerableCheckpointFailureNumber
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// collector.checkThat(result.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;getAccumulatorResult(NUM_FAILURES), equalTo(EXPECTED_FAILURES));
&lt;/span&gt;
sink:
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (random.nextInt(100) == 42) {
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(7);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Failures:&lt;br/&gt;
 shouldPerformUnalignedCheckpointOnParallelRemoteChannel: NUM_DUPLICATES &amp;gt; 0 (2 out of 70 runs)&lt;/p&gt;

&lt;p&gt;With CheckpointTimeout 5, interval 1, sleep 1 &lt;br/&gt;
I also get: two out-of-order and one corrupted state on recovery:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.io.EOFException
	at org.apache.flink.core.memory.DataInputDeserializer.readByte(DataInputDeserializer.java:134)
	at org.apache.flink.streaming.runtime.streamrecord.StreamElementSerializer.deserialize(StreamElementSerializer.java:199)
	at org.apache.flink.streaming.runtime.streamrecord.StreamElementSerializer.deserialize(StreamElementSerializer.java:46)
	at org.apache.flink.runtime.plugable.NonReusingDeserializationDelegate.read(NonReusingDeserializationDelegate.java:55)
	at org.apache.flink.runtime.io.network.api.serialization.SpillingAdaptiveSpanningRecordDeserializer.getNextRecord(SpillingAdaptiveSpanningRecordDeserializer.java:92)
	at org.apache.flink.streaming.runtime.io.StreamTaskNetworkInput.emitNext(StreamTaskNetworkInput.java:145)
	at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:67)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:372)
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:186)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:574)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:538)
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:722)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:547)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Corrupted state is very similar to what I observed in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19681&quot; title=&quot;Passively timeout alignment on the inputs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19681&quot;&gt;&lt;del&gt;FLINK-19681&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17230189" author="roman_khachatryan" created="Wed, 11 Nov 2020 19:55:05 +0000"  >&lt;p&gt;And with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
env.enableCheckpointing(1);
env.getCheckpointConfig().setCheckpointTimeout(2); &lt;span class=&quot;code-comment&quot;&gt;// had to disable check
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1); &lt;span class=&quot;code-comment&quot;&gt;// in sink 42/100&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I got one&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.util.NoSuchElementException
	at java.util.ArrayDeque$DeqIterator.next(ArrayDeque.java:642)
	at org.apache.flink.runtime.io.network.partition.consumer.RemoteInputChannel.getInflightBuffers(RemoteInputChannel.java:537)
	at org.apache.flink.runtime.io.network.partition.consumer.RemoteInputChannel.checkpointStarted(RemoteInputChannel.java:509)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is probably &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20030&quot; title=&quot;Barrier announcement causes outdated RemoteInputChannel#numBuffersOvertaken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20030&quot;&gt;&lt;del&gt;FLINK-20030&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17230195" author="roman_khachatryan" created="Wed, 11 Nov 2020 20:09:20 +0000"  >&lt;p&gt;Just to clarify, &lt;br/&gt;
 I used shouldPerformUnalignedCheckpointOnParallelRemoteChannel (parallelism 5, slotsPerTaskManager 1, slotSharing false).&lt;/p&gt;

&lt;p&gt;In AC mode, it seems to always pass (didn&apos;t check all the combinations).&lt;/p&gt;</comment>
                            <comment id="17230202" author="roman_khachatryan" created="Wed, 11 Nov 2020 20:26:26 +0000"  >&lt;p&gt;Fixing the original issues with&#160;ChannelStatePersister (as described) seems to resolve the failures.&lt;/p&gt;</comment>
                            <comment id="17230235" author="arvid" created="Wed, 11 Nov 2020 21:22:38 +0000"  >&lt;p&gt;You are right that the code currently is not behaving well when you have two concurrent UC. I actually wanted to make it possible to process concurrent checkpoint in all 1.12 code, but it didn&apos;t make it through the review. I&apos;m assuming that as long as we don&apos;t know if we want to support concurrent UC, the code was not needed.&lt;/p&gt;

&lt;p&gt;I&apos;m unsure why stuff is failing with one checkpoint. It could be related to cancellation, such that actually two UC barriers arrive at some task instead.&lt;/p&gt;</comment>
                            <comment id="17230236" author="arvid" created="Wed, 11 Nov 2020 21:25:37 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.util.NoSuchElementException
	at java.util.ArrayDeque$DeqIterator.next(ArrayDeque.java:642)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This looks very much like &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20030&quot; title=&quot;Barrier announcement causes outdated RemoteInputChannel#numBuffersOvertaken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20030&quot;&gt;&lt;del&gt;FLINK-20030&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17230241" author="arvid" created="Wed, 11 Nov 2020 21:27:50 +0000"  >&lt;p&gt;&amp;gt; In AC mode, it seems to always pass (didn&apos;t check all the combinations).&lt;/p&gt;

&lt;p&gt;AC mode never touches ChannelPersister, so I&apos;m not suprised. Especially &lt;tt&gt;stopPersisting&lt;/tt&gt; is never called by &lt;tt&gt;AlignedController&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17230255" author="roman_khachatryan" created="Wed, 11 Nov 2020 21:58:53 +0000"  >&lt;p&gt;Please note, that even with a single checkpoint in flight, there can be a lot of older outdated barrier in the stream.&lt;/p&gt;

&lt;p&gt;This can happen if high backpressure and/or low timeout (that&apos;s why I setCheckpointTimeout to 10, plus minPause, plus interval).&lt;/p&gt;</comment>
                            <comment id="17230636" author="arvid" created="Thu, 12 Nov 2020 13:46:41 +0000"  >&lt;p&gt;Merged into master as 5256c210f5e0a27164c1f1e7c0916f0d6bbd5bb7.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13335769">FLINK-19681</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13340150">FLINK-20103</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13371252">FLINK-22232</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0khlk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>