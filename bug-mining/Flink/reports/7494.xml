<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:20:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-32828] Partition aware watermark not handled correctly shortly after job start up from checkpoint or savepoint</title>
                <link>https://issues.apache.org/jira/browse/FLINK-32828</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When using KafkaSource with partition aware watermarks. Watermarks are being emitted even when only one partition has some events just after job startup from savepoint/checkpoint. After it has some events on other partitions the watermark behaviour is correct and watermark is emited as a minimum watarmark from all partition.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Setup a Kafka cluster with a topic that has 2 or more partitions. (see attached docker-compose.yml)&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;&lt;tt&gt;./kafka-topics.sh --bootstrap-server localhost:9092 --create --topic test-2 --partitions 4&lt;/tt&gt;&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Create a job that (see attached `test-job.java`):
	&lt;ol&gt;
		&lt;li&gt;uses a KafkaSource with `WatermarkStrategy.forBoundedOutOfOrderness(Duration.ofSeconds(10L)`&lt;/li&gt;
		&lt;li&gt;has parallelism lower than number of partitions&lt;/li&gt;
		&lt;li&gt;stores checkpoint/savepoint&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Start job&lt;/li&gt;
	&lt;li&gt;Send events only on single partition
	&lt;ol&gt;
		&lt;li&gt;&lt;tt&gt;./kafka-console-producer.sh --bootstrap-server localhost:9092 --topic test-2 --property &quot;parse.key=true&quot; --property &quot;key.separator=:&quot;&lt;/tt&gt;&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;14:51:19,883 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/3: 1 -&amp;gt; a, timestamp 2023-08-10T12:51:18.849Z, watermark -292275055-05-16T16:47:04.192Z&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:51:32,484 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/3: 1 -&amp;gt; a, timestamp 2023-08-10T12:51:31.475Z, watermark -292275055-05-16T16:47:04.192Z&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:51:35,914 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/3: 1 -&amp;gt; a, timestamp 2023-08-10T12:51:34.909Z, watermark -292275055-05-16T16:47:04.192Z&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Expected: Watermark does not progress. Actual: Watermark does not progress.&lt;/p&gt;

&lt;p&gt;5. Stop the job&lt;/p&gt;

&lt;p&gt;6. Startup job from last checkpoint/savepoint&lt;/p&gt;

&lt;p&gt;7. Send events only on single partitions&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;14:53:41,693 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/3: 1 -&amp;gt; a, timestamp 2023-08-10T12:53:40.662Z, watermark -292275055-05-16T16:47:04.192Z&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:53:46,088 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/3: 1 -&amp;gt; a, timestamp 2023-08-10T12:53:45.078Z, watermark 2023-08-10T12:53:30.661Z&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:53:49,520 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/3: 1 -&amp;gt; a, timestamp 2023-08-10T12:53:48.511Z, watermark 2023-08-10T12:53:35.077Z&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Expected: Watermark does not progress. &lt;font color=&quot;#ff0000&quot;&gt;&lt;b&gt;Actual: Watermark has progress&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;To add bit more of context:&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;8. Send events on other partitions and then send events only on single partitions&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&lt;font color=&quot;#172b4d&quot;&gt;14:54:55,112 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/0: 2 -&amp;gt; a, timestamp 2023-08-10T12:54:54.104Z, watermark 2023-08-10T12:53:38.510Z&lt;br/&gt;
14:54:57,673 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/1: 4 -&amp;gt; a, timestamp 2023-08-10T12:54:56.665Z, watermark 2023-08-10T12:53:38.510Z&lt;br/&gt;
14:54:57,673 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/2: 5 -&amp;gt; a, timestamp 2023-08-10T12:54:57.554Z, watermark 2023-08-10T12:53:38.510Z&lt;br/&gt;
14:55:12,821 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/3: 1 -&amp;gt; a, timestamp 2023-08-10T12:55:11.814Z, watermark 2023-08-10T12:54:44.103Z&lt;br/&gt;
14:55:16,099 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/3: 1 -&amp;gt; a, timestamp 2023-08-10T12:55:15.091Z, watermark 2023-08-10T12:54:44.103Z&lt;br/&gt;
14:55:19,122 WARN &#160;com.example.TestJob6$InputSink2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [] - == Received: test-2/3: 1 -&amp;gt; a, timestamp 2023-08-10T12:55:18.114Z, watermark 2023-08-10T12:54:44.103Z&lt;/font&gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;Expected: Watermark should progress a bit and then should not progress when receiving events only on single partition. &lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;Actual: As expected&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;This behavior also shows as a burst of late events just after startup and then no more late events when job operates normally. &lt;/font&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Affected environments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Local MiniCluster + Confluent Kafka run in docker
	&lt;ul&gt;
		&lt;li&gt;See attached files&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Flink job run in Kubernetes using Flink Operator 1.15 + 3 node Kafka cluster run in Kubernetes cluster&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="13546843">FLINK-32828</key>
            <summary>Partition aware watermark not handled correctly shortly after job start up from checkpoint or savepoint</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="gliter">Grzegorz Liter</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 10 Aug 2023 14:37:11 +0000</created>
                <updated>Tue, 21 May 2024 07:54:03 +0000</updated>
                            <resolved>Fri, 17 May 2024 08:08:46 +0000</resolved>
                                    <version>1.17.1</version>
                    <version>1.19.0</version>
                    <version>1.18.1</version>
                                    <fixVersion>1.18.2</fixVersion>
                    <fixVersion>1.20.0</fixVersion>
                    <fixVersion>1.19.1</fixVersion>
                                    <component>API / DataStream</component>
                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17752901" author="mason6345" created="Thu, 10 Aug 2023 18:43:16 +0000"  >&lt;p&gt;From the logs, it looks like you have a key by and watermark is progressing because that one active partition is moving data to all other operators. I would start by setting and tuning the&#160; idleness (&lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-master/docs/dev/datastream/event-time/generating_watermarks/#dealing-with-idle-sources&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nightlies.apache.org/flink/flink-docs-master/docs/dev/datastream/event-time/generating_watermarks/#dealing-with-idle-sources)&lt;/a&gt; to account for the idle partitions&lt;/p&gt;</comment>
                            <comment id="17752905" author="JIRAUSER301498" created="Thu, 10 Aug 2023 18:59:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mason6345&quot; class=&quot;user-hover&quot; rel=&quot;mason6345&quot;&gt;mason6345&lt;/a&gt; its not about idle partitions, its about a quite opposite situation. During normal operation all partitions are active and more or less aligned with timestamp. Now imagine a situation during startup when one thread starts to consume some partitions faster than others. If it will progress through events from that single partition fast enough to consume events with timestamps that are bigger than some events in other partitions + watermark time, it will start dropping those events as late events.&#160;&lt;/p&gt;

&lt;p&gt;To mitigate this situation Kafka partition aware watermarks were implemented. There is a clear bug here where in case of running fresh job or after having job settled and having traffic on all partition works correctly. That means the watermark emitted by source is a minimal watermark of all partitions. But in in short window just after startup from checkpoint/savepoint watermark incorrectly progresses just based on traffic from single partitions, where it should wait until traffic on all partitions to take a minimal watermark of all partitions.&lt;/p&gt;

&lt;p&gt;Please not that the logs are from the minimal example I have created (attached to the tickets) and events are send by hand.&lt;/p&gt;

&lt;p&gt;In production restarting job causes around 1 - 10% of events be dropped at the very start of the job. Even thou in scope of single partition the out of ordness is well below allowed one.&#160;&lt;/p&gt;</comment>
                            <comment id="17846694" author="pnowojski" created="Wed, 15 May 2024 15:57:41 +0000"  >&lt;p&gt;We have just stumbled upon the same issue and I can confirm that it&apos;s quite critical bug that can leads to all kinds of incorrect results. &lt;/p&gt;

&lt;p&gt;The problem is that the initial splits recovered from state are initial are registered in the &lt;tt&gt;WatermarkOutputMultiplexer&lt;/tt&gt; only when first record from that split has been emitted. Resulting watermark was not properly combined from the initial splits, but only from the splits that have already emitted at least one record.&lt;/p&gt;

&lt;p&gt;I will publish a fix for that shortly.&lt;/p&gt;

&lt;p&gt;edit: Also the problem doesn&apos;t affect only Kafka, but all FLIP-27 sources (anything that uses &lt;tt&gt;SourceOperator&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17847198" author="pnowojski" created="Fri, 17 May 2024 08:08:46 +0000"  >&lt;p&gt;Merged to master as 7fd6c6da26c&lt;br/&gt;
Merged to release-1.19 as a160f8db1f7&lt;br/&gt;
Merged to release-1.18 as 4848a50d735&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13062033" name="docker-compose.yml" size="870" author="gliter" created="Thu, 10 Aug 2023 14:33:32 +0000"/>
                            <attachment id="13062034" name="test-job.java" size="4898" author="gliter" created="Thu, 10 Aug 2023 14:26:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jpn4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>