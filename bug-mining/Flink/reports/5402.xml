<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:57:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21181] Buffer pool is destroyed error when outputting data over a timer after cancellation.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21181</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;A &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/What-causes-a-buffer-pool-exception-How-can-I-mitigate-it-td40959.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;user reported&lt;/a&gt; the issue and provided some taskmanager log with the following relevant lines:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2021-01-26 04:37:43,280 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - Attempting to cancel task forward fill -&amp;gt; (Sink: tag db sink, Sink: back fill db sink, Sink: min max step db sink) (2/2) (8c1f256176fb89f112c27883350a02bc).
2021-01-26 04:37:43,280 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - forward fill -&amp;gt; (Sink: tag db sink, Sink: back fill db sink, Sink: min max step db sink) (2/2) (8c1f256176fb89f112c27883350a02bc) switched from RUNNING to CANCELING.
2021-01-26 04:37:43,280 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - Triggering cancellation of task code forward fill -&amp;gt; (Sink: tag db sink, Sink: back fill db sink, Sink: min max step db sink) (2/2) (8c1f256176fb89f112c27883350a02bc).
2021-01-26 04:37:43,282 ERROR xxxxxx.pipeline.stream.functions.process.ForwardFillKeyedProcessFunction [] - Error in timer.
java.lang.RuntimeException: Buffer pool is destroyed.
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:110) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.collect(RecordWriterOutput.java:89) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.collect(RecordWriterOutput.java:45) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.OperatorChain$BroadcastingOutputCollector.collect(OperatorChain.java:787) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.OperatorChain$BroadcastingOutputCollector.collect(OperatorChain.java:740) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:52) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:30) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.api.operators.TimestampedCollector.collect(TimestampedCollector.java:53) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at xxxxxx.pipeline.stream.functions.process.ForwardFillKeyedProcessFunction.collect(ForwardFillKeyedProcessFunction.java:452) ~[develop-17e9fd0e.jar:?]
	at xxxxxx.pipeline.stream.functions.process.ForwardFillKeyedProcessFunction.onTimer(ForwardFillKeyedProcessFunction.java:277) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.streaming.api.operators.KeyedProcessOperator.invokeUserFunction(KeyedProcessOperator.java:94) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.api.operators.KeyedProcessOperator.onProcessingTime(KeyedProcessOperator.java:78) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.api.operators.InternalTimerServiceImpl.onProcessingTime(InternalTimerServiceImpl.java:260) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invokeProcessingTimeCallback(StreamTask.java:1181) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$null$13(StreamTask.java:1172) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.runThrowing(StreamTaskActionExecutor.java:47) [flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.mailbox.Mail.run(Mail.java:78) [flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.processMail(MailboxProcessor.java:270) [flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxStep(MailboxProcessor.java:190) [flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:181) [flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:558) [flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:530) [flink-dist_2.12-1.11.0.jar:1.11.0]
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:721) [develop-17e9fd0e.jar:?]
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:546) [develop-17e9fd0e.jar:?]
	at java.lang.Thread.run(Thread.java:748) [?:1.8.0_252]
Caused by: java.lang.IllegalStateException: Buffer pool is destroyed.
	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestMemorySegmentFromGlobal(LocalBufferPool.java:339) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestMemorySegment(LocalBufferPool.java:309) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestMemorySegmentBlocking(LocalBufferPool.java:290) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestBufferBuilderBlocking(LocalBufferPool.java:266) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.runtime.io.network.partition.ResultPartition.getBufferBuilder(ResultPartition.java:213) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.requestNewBufferBuilder(RecordWriter.java:294) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.runtime.io.network.api.writer.ChannelSelectorRecordWriter.requestNewBufferBuilder(ChannelSelectorRecordWriter.java:103) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.copyFromSerializerToTargetChannel(RecordWriter.java:149) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.emit(RecordWriter.java:120) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.runtime.io.network.api.writer.ChannelSelectorRecordWriter.emit(ChannelSelectorRecordWriter.java:60) ~[develop-17e9fd0e.jar:?]
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:107) ~[flink-dist_2.12-1.11.0.jar:1.11.0]
	... 24 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13355112">FLINK-21181</key>
            <summary>Buffer pool is destroyed error when outputting data over a timer after cancellation.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="arvid">Arvid Heise</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 28 Jan 2021 08:43:44 +0000</created>
                <updated>Tue, 14 Sep 2021 09:48:00 +0000</updated>
                            <resolved>Mon, 10 May 2021 12:29:34 +0000</resolved>
                                    <version>1.11.0</version>
                    <version>1.13.0</version>
                    <version>1.14.0</version>
                    <version>1.12.3</version>
                                    <fixVersion>1.14.0</fixVersion>
                    <fixVersion>1.13.1</fixVersion>
                    <fixVersion>1.12.4</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17324938" author="roman_khachatryan" created="Mon, 19 Apr 2021 10:51:10 +0000"  >&lt;p&gt;I think this is what&apos;s happening:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Task Thread picks up a mail (or creates a batch of mails), starts execution and pauses&lt;/li&gt;
	&lt;li&gt;Task is cancelled (e.g. by RPC) - method&#160;Task.cancelExecution
	&lt;ol&gt;
		&lt;li&gt;Task state transitions from RUNNING to CANCELLING&lt;/li&gt;
		&lt;li&gt;TaskCanceler is created and started&lt;/li&gt;
		&lt;li&gt;TaskCanceler calls&#160;invokable.cancel(), which &lt;b&gt;schedules&lt;/b&gt;&#160;mailboxProcessor shutdown&lt;/li&gt;
		&lt;li&gt;TaskCanceler releases network resources (Task.closeNetworkResources()), which destroys LocalBufferPools&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Task Thread continues execution (of a prevously picked mail) and eventually hits destroyed buffer pool&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;From the comments in the code, I think (2.3) should not return until the task thread actually exits the mailbox loop:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;// Don&apos;t do this before cancelling the invokable. Otherwise we&lt;br/&gt;
 // will get misleading errors in the logs.&lt;br/&gt;
 networkResourcesCloser.run();&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;To fix, it I&apos;d propose TaskCanceller&#160; to wait for mailbox loop to be finished (introducing something like&#160;mailboxProcessor.getCompletionFuture().join() ).&lt;/p&gt;

&lt;p&gt;WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AHeise&quot; class=&quot;user-hover&quot; rel=&quot;AHeise&quot;&gt;AHeise&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17329201" author="pnowojski" created="Thu, 22 Apr 2021 15:24:10 +0000"  >&lt;p&gt;I think I&apos;ve found a related issue. I&apos;ve modified the code to not re-use the same memory segments, but on recycling always free up the segment. And what I have observed is a similar problem as reported in this ticket, but even more severe:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.RuntimeException: segment has been freed
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:109)
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.collect(RecordWriterOutput.java:93)
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.collect(RecordWriterOutput.java:44)
	at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:50)
	at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:28)
	at org.apache.flink.streaming.api.operators.TimestampedCollector.collect(TimestampedCollector.java:50)
	at org.apache.flink.test.checkpointing.UnalignedCheckpointStressITCase$ReEmitAll.process(UnalignedCheckpointStressITCase.java:477)
	at org.apache.flink.test.checkpointing.UnalignedCheckpointStressITCase$ReEmitAll.process(UnalignedCheckpointStressITCase.java:468)
	at org.apache.flink.streaming.runtime.operators.windowing.functions.InternalIterableProcessWindowFunction.process(InternalIterableProcessWindowFunction.java:57)
	at org.apache.flink.streaming.runtime.operators.windowing.functions.InternalIterableProcessWindowFunction.process(InternalIterableProcessWindowFunction.java:32)
	at org.apache.flink.streaming.runtime.operators.windowing.WindowOperator.emitWindowContents(WindowOperator.java:577)
	at org.apache.flink.streaming.runtime.operators.windowing.WindowOperator.onProcessingTime(WindowOperator.java:533)
	at org.apache.flink.streaming.api.operators.InternalTimerServiceImpl.onProcessingTime(InternalTimerServiceImpl.java:284)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invokeProcessingTimeCallback(StreamTask.java:1395)
	... 11 more
Caused by: java.lang.IllegalStateException: segment has been freed
	at org.apache.flink.core.memory.MemorySegment.put(MemorySegment.java:483)
	at org.apache.flink.core.memory.MemorySegment.put(MemorySegment.java:1398)
	at org.apache.flink.runtime.io.network.buffer.BufferBuilder.append(BufferBuilder.java:100)
	at org.apache.flink.runtime.io.network.buffer.BufferBuilder.appendAndCommit(BufferBuilder.java:82)
	at org.apache.flink.runtime.io.network.partition.BufferWritingResultPartition.appendUnicastDataForNewRecord(BufferWritingResultPartition.java:250)
	at org.apache.flink.runtime.io.network.partition.BufferWritingResultPartition.emitRecord(BufferWritingResultPartition.java:142)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.emit(RecordWriter.java:104)
	at org.apache.flink.runtime.io.network.api.writer.ChannelSelectorRecordWriter.emit(ChannelSelectorRecordWriter.java:54)
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:107)
	... 24 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That&apos;s happening also during cancellation/job failover. It looks to me, that in the case you have analysed, processing time timer tried to request a buffer from destroyed buffer pool.  My case looks identical, but it&apos;s failing when trying to write to already `free`&apos;ed up buffer. Without my changes, this code would silently write some data to a buffer that has already been recycled/returned to the pool. If someone else would pick up this buffer, it would easily lead to the data corruption.&lt;/p&gt;

&lt;p&gt;As far as I can tell, the exact reason behind my exception is a bit different. The buffer to which timer attempts to write to, has been released from `ResultSubpartition#onConsumedSubpartition`, causing `BufferConsumer` to be closed (which recycles/frees underlying memory segment ), while matching `BufferBuilder` is still being used...&lt;/p&gt;</comment>
                            <comment id="17330070" author="pnowojski" created="Fri, 23 Apr 2021 07:39:53 +0000"  >&lt;p&gt;I&apos;ve created a separate ticket for that: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22424&quot; title=&quot;Writing to already released buffers potentially causing data corruption during job failover/cancellation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22424&quot;&gt;&lt;del&gt;FLINK-22424&lt;/del&gt;&lt;/a&gt;. The solution might be still the same, or it might be a very different one.&lt;/p&gt;</comment>
                            <comment id="17341597" author="roman_khachatryan" created="Sun, 9 May 2021 19:37:17 +0000"  >&lt;p&gt;Merged into master as&#160;420eb6ec0276b208a628b535ca553d6d892a572f.&lt;/p&gt;

&lt;p&gt;Merged into 1.13 as ce7c78ca72ce86df0b4a28fbd3233b89da3238e1.&lt;/p&gt;

&lt;p&gt;Merged into 1.12 as 4fd134403d535e074edf3b6a82b540e88709f4ec.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17414846" author="pnowojski" created="Tue, 14 Sep 2021 09:48:00 +0000"  >&lt;p&gt;I have to basically revert this change and reimplement the fix differently as a result of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24182&quot; title=&quot;Tasks canceler should not immediately interrupt&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24182&quot;&gt;&lt;del&gt;FLINK-24182&lt;/del&gt;&lt;/a&gt;. Because on the clean cancellation path we don&apos;t want to issue interrupts, we have to close buffer pools to unblock back pressured tasks/threads/mailbox actions. To do so, as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24182&quot; title=&quot;Tasks canceler should not immediately interrupt&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24182&quot;&gt;&lt;del&gt;FLINK-24182&lt;/del&gt;&lt;/a&gt; I will re-implement fix for this (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21181&quot; title=&quot;Buffer pool is destroyed error when outputting data over a timer after cancellation.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21181&quot;&gt;&lt;del&gt;FLINK-21181&lt;/del&gt;&lt;/a&gt;) bug, so that access to closed/destroyed LocalBufferPool will result in &lt;tt&gt;CancelTaskException&lt;/tt&gt; being thrown.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13374581">FLINK-22424</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13399705">FLINK-24182</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0n2rk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>