<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:41:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14010] Dispatcher &amp; JobManagers don&apos;t give up leadership when AM is shut down</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14010</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In YARN deployment scenario, YARN RM possibly launches a new AM for the job even if the previous AM does not terminated, for example, when AMRM heartbeat timeout. This is a common case that RM will send a shutdown request to the previous AM and expect the AM shutdown properly.&lt;/p&gt;

&lt;p&gt;However, currently in &lt;tt&gt;YARNResourceManager&lt;/tt&gt;, we handle this request in &lt;tt&gt;onShutdownRequest&lt;/tt&gt; which simply close the &lt;tt&gt;YARNResourceManager&lt;/tt&gt; &lt;b&gt;but not Dispatcher and JobManagers&lt;/b&gt;. Thus, Dispatcher and JobManager launched in new AM cannot be granted leadership properly. Visually,&lt;/p&gt;

&lt;p&gt;on previous AM: Dispatcher leader, JM leaders&lt;br/&gt;
on new AM: ResourceManager leader&lt;/p&gt;

&lt;p&gt;since on client side or in per-job mode, JobManager address and port are configured as the new AM, the whole cluster goes into an unrecoverable inconsistent status: client all queries the dispatcher on new AM who is now the leader. Briefly, Dispatcher and JobManagers on previous AM do not give up their leadership properly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13255566">FLINK-14010</key>
            <summary>Dispatcher &amp; JobManagers don&apos;t give up leadership when AM is shut down</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tison">Zili Chen</assignee>
                                    <reporter username="tison">Zili Chen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 9 Sep 2019 08:14:57 +0000</created>
                <updated>Thu, 10 Oct 2019 16:06:48 +0000</updated>
                            <resolved>Tue, 24 Sep 2019 17:24:21 +0000</resolved>
                                    <version>1.7.2</version>
                    <version>1.8.2</version>
                    <version>1.9.0</version>
                    <version>1.10.0</version>
                                    <fixVersion>1.8.3</fixVersion>
                    <fixVersion>1.9.1</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Deployment / YARN</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16925460" author="tison" created="Mon, 9 Sep 2019 08:31:27 +0000"  >&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xiaogang.shi&quot; class=&quot;user-hover&quot; rel=&quot;xiaogang.shi&quot;&gt;xiaogang.shi&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here comes a high-level problem, do we explicitly constrain Dispatcher, ResourceManager and JobManagers run on one process?&lt;/p&gt;

&lt;p&gt;1. the usage of reference to &lt;tt&gt;JobManagerGateway&lt;/tt&gt; in Dispatcher already infers that we require this.&lt;br/&gt;
2. back to the design of FLIP-6, we have a global singleton of Dispatcher, and for each job, launch a JobManager and ResourceManager. The implementation diverges quite a lot. Could you please provide any background?&lt;br/&gt;
3. if we explicitly constrain as above, we actually need not to start leader election services per components, actually, we can use the abstraction and layout as below:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;start a leader election service per dispatcher-resource-manager component, in cluster entrypoint level. It will participant the election and all metadata commits are delegate to this service.&lt;/li&gt;
	&lt;li&gt;all cluster level components that need to publish their address, such as Dispatcher, ResourceManager and WebMonitor publish their address via this leader election service.&lt;/li&gt;
	&lt;li&gt;Actors can be started as &lt;tt&gt;PermanentlyFencedRpcEndpoint&lt;/tt&gt; and thus we survive from handling a lot of mutable shared state among leadership epoch. Specifically, cluster entrypoint acts as DispatcherRunner and so on, like JobManagerRunner to JobMaster. See also &lt;a href=&quot;https://github.com/tillrohrmann/flink/commits/removeSuspendFromJobMaster&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this branch&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;back to this issue, cluster entrypoint(&lt;tt&gt;YARNClusterEntrypoint&lt;/tt&gt; maybe) reacts to AMRM request and thus all components can be required to shutdown properly.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16925778" author="till.rohrmann" created="Mon, 9 Sep 2019 15:26:52 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;Tison&lt;/a&gt;. I think your analysis is correct that we currently do not react properly to &lt;tt&gt;onShutdownRequest&lt;/tt&gt; signals. What happens is that we only terminate the &lt;tt&gt;ResourceManager&lt;/tt&gt; but not the other Flink components (&lt;tt&gt;Dispatcher&lt;/tt&gt; and &lt;tt&gt;JobMasters&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;Before looking into a potential solutions let&apos;s answer your questions because they are important for understanding the bigger picture.&lt;/p&gt;

&lt;p&gt;The two components &lt;tt&gt;Dispatcher&lt;/tt&gt; and &lt;tt&gt;ResourceManager&lt;/tt&gt; have been designed to run independently of the other component, potentially also in a separate process. The current implementation couples the &lt;tt&gt;Dispatcher&lt;/tt&gt; with the &lt;tt&gt;JobMasters&lt;/tt&gt; but there should be nothing fundamental preventing from decoupling them. The main thing one needs to do is to add logic to start &lt;tt&gt;JobMaster&lt;/tt&gt; processes somewhere. So long story short, the idea is that all components can run independently (modulo the existing &lt;tt&gt;Dispatcher&lt;/tt&gt; implementation).&lt;/p&gt;

&lt;p&gt;At the moment we run all these components in one process because it was easier and less work to implement it this way. This is reflected in the &lt;tt&gt;DispatcherResourceManagerComponent&lt;/tt&gt;. Hence, for the current implementation we can assume that if the &lt;tt&gt;ResourceManager&lt;/tt&gt; terminates, then the other components should shut down as well. This could be implemented by registering in the &lt;tt&gt;DispatcherResourceManagerComponent&lt;/tt&gt; a callback on the &lt;tt&gt;ResourceManager&apos;s&lt;/tt&gt; termination future which triggers the closing of the &lt;tt&gt;DispatcherResourceManagerComponent&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Concerning using a single leader election service, I would say that this is not feasible if we still want to keep the option to deploy the components in separate processes eventually.&lt;/p&gt;

&lt;p&gt;Would you have time to work on the fix for this problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;Tison&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16931287" author="tison" created="Tue, 17 Sep 2019 10:47:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; Thanks to your explanation, I learn where the components layout comes from.&lt;/p&gt;

&lt;p&gt;Back to this issue, what if we call &lt;tt&gt;#onFatalError&lt;/tt&gt; in &lt;tt&gt;YarnResourceManager#onShutdownRequest&lt;/tt&gt;? &lt;tt&gt;#onShutdownRequest&lt;/tt&gt; is only called when AM exceptionally switched and we can regard it as a fatal error. For implementation details, it calls &lt;tt&gt;System.exit&lt;/tt&gt; that correctly shutdown the AM and release leadership.&lt;/p&gt;</comment>
                            <comment id="16931386" author="till.rohrmann" created="Tue, 17 Sep 2019 12:36:05 +0000"  >&lt;p&gt;&lt;tt&gt;#onFatalError&lt;/tt&gt; could also be an option but I would prefer to distinguish here. I would consider &lt;tt&gt;#onShutdownRequest&lt;/tt&gt; as request and not an error case. Hence, I would suggest to try to gracefully shut down. If this does not work, then we could fail fatally.&lt;/p&gt;</comment>
                            <comment id="16931490" author="tison" created="Tue, 17 Sep 2019 14:04:23 +0000"  >&lt;p&gt;Well, it&apos;s reasonable we try to gracefully shut down. I start to work on it but I&apos;m not sure about what the future should look like.&lt;/p&gt;

&lt;p&gt;There are two options in my mind, both of which introduce a &lt;tt&gt;shutdownFuture&lt;/tt&gt; in &lt;tt&gt;ResourceManager&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;1. &lt;tt&gt;ResourceManager#shutdownFuture&lt;/tt&gt; is completed on &lt;tt&gt;YarnResourceManager#onShutdownRequest&lt;/tt&gt; gets called. And we register callback in &lt;tt&gt;DispatcherResourceManagerComponent#registerShutDownFuture&lt;/tt&gt;, when &lt;tt&gt;ResourceManager#shutdownFuture&lt;/tt&gt; complete, we complete &lt;tt&gt;DispatcherResourceManagerComponent#shutDownFuture&lt;/tt&gt; exceptionally. Concern here is that &lt;tt&gt;ResourceManager#shutdownFuture&lt;/tt&gt; is never completed if &lt;tt&gt;YarnResourceManager#onShutdownRequest&lt;/tt&gt; never gets called. I&apos;m not sure if it is well.&lt;/p&gt;

&lt;p&gt;2. &lt;tt&gt;ResourceManager#shutdownFuture&lt;/tt&gt; is completed normally on &lt;tt&gt;ResourceManager#stopResourceManagerServices&lt;/tt&gt; gets called, while completed exceptionally on &lt;tt&gt;YarnResourceManager#onShutdownRequest&lt;/tt&gt; gets called. Also we register callback in &lt;tt&gt;DispatcherResourceManagerComponent#registerShutDownFuture&lt;/tt&gt;, when &lt;tt&gt;ResourceManager#shutdownFuture&lt;/tt&gt; complete exceptionally, we complete &lt;tt&gt;DispatcherResourceManagerComponent#shutDownFuture&lt;/tt&gt; exceptionally; when when &lt;tt&gt;ResourceManager#shutdownFuture&lt;/tt&gt; complete normally we do nothing. It might be a bit more complex than 1 and we should ensure that codepaths &lt;tt&gt;ResourceManager&lt;/tt&gt; exit are all covered.&lt;/p&gt;

&lt;p&gt;WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16932396" author="till.rohrmann" created="Wed, 18 Sep 2019 12:46:40 +0000"  >&lt;p&gt;Couldn&apos;t we simply use &lt;tt&gt;ResourceManager#getTerminationFuture&lt;/tt&gt; to trigger the shut down of the &lt;tt&gt;DispatcherResourceManagerComponent&lt;/tt&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;Tison&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16932423" author="tison" created="Wed, 18 Sep 2019 13:06:07 +0000"  >&lt;p&gt;I have thought of this. The problem is that when the situation described here happens, we actually complete &lt;tt&gt;ResourceManager#getTerminationFuture&lt;/tt&gt; normally, which cannot be sourced that it comes from &lt;tt&gt;YarnResourceManager#onShutdownRequest&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If we achieve the function by using &lt;tt&gt;ResourceManager#getTerminationFuture&lt;/tt&gt; to trigger the shut down of the &lt;tt&gt;DispatcherResourceManagerComponent&lt;/tt&gt;, the assumption is:&lt;/p&gt;

&lt;p&gt;If ResourceManager is closed first(since termination future completes normally in both cases, we cannot distinguish by &lt;tt&gt;whenComplete&lt;/tt&gt;), it infers an exceptionally status so that we should complete &lt;tt&gt;DispatcherResourceManagerComponent#getShutDownFuture&lt;/tt&gt; exceptionally. Otherwise ResourceManager closes normally by other triggers, and then either &lt;tt&gt;DispatcherResourceManagerComponent#getShutDownFuture&lt;/tt&gt; is already completed or &lt;tt&gt;ClusterEntrypoint#shutdownAsync&lt;/tt&gt; is guarded to be executed once.&lt;/p&gt;

&lt;p&gt;I think this assumption is counter-intuitive that ResourceManager terminates &quot;normally&quot; but we complete shutdownFuture exceptionally.&lt;/p&gt;</comment>
                            <comment id="16932676" author="till.rohrmann" created="Wed, 18 Sep 2019 17:06:22 +0000"  >&lt;p&gt;Can&apos;t we say that we always complete &lt;tt&gt;DispatcherResourceManagerComponent#shutDownFuture&lt;/tt&gt; exceptionally if &lt;tt&gt;ResourceManager.getTerminationFuture()&lt;/tt&gt; terminates while &lt;tt&gt;DispatcherResourceManagerComponent#isRunning&lt;/tt&gt; is &lt;tt&gt;true&lt;/tt&gt;? The contract could be that the &lt;tt&gt;ResourceManager&lt;/tt&gt; always needs to run and if it stops, then this is an indicator that something went wrong and we should stop the &lt;tt&gt;ClusterEntrypoint&lt;/tt&gt;. We could do this by completing &lt;tt&gt;DispatcherResourceManagerComponent#shutDownFuture&lt;/tt&gt; exceptionally if &lt;tt&gt;DispatcherResourceManagerComponent#isRunning&lt;/tt&gt; is &lt;tt&gt;true&lt;/tt&gt;. However, one could similarly also simply call &lt;tt&gt;onFatalError&lt;/tt&gt; from within the &lt;tt&gt;ResourceManager&lt;/tt&gt; as you&apos;ve initially proposed.&lt;/p&gt;</comment>
                            <comment id="16933030" author="tison" created="Thu, 19 Sep 2019 03:30:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; Technically I agree that it is a valid solution. Give it another look I think we can complete shutdown future exceptionally &quot;ResourceManager got closed when DispatcherResourceManagerComponent is running&quot;. It infers that the application goes into an UNKNOWN state so that the semantic is also correct.&lt;/p&gt;</comment>
                            <comment id="16933139" author="till.rohrmann" created="Thu, 19 Sep 2019 07:45:45 +0000"  >&lt;p&gt;Ok, then let&apos;s do it like this. Do you have to time to work on this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;Tison&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16933140" author="tison" created="Thu, 19 Sep 2019 07:48:16 +0000"  >&lt;p&gt;Will send a pull request in hours &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16937019" author="till.rohrmann" created="Tue, 24 Sep 2019 17:24:21 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.10.0: 67e73fad6cd80911377b2009e5e9c661f0324867&lt;br/&gt;
1.9.1: 4d70447f6daac7914dc3a8749a1d9963c61f8d4c&lt;br/&gt;
1.8.3: 42cb6ddb1018e734444943d5f23215e26a156ff4&lt;/p&gt;</comment>
                            <comment id="16948730" author="till.rohrmann" created="Thu, 10 Oct 2019 16:06:48 +0000"  >&lt;p&gt;I think we introduced a Yarn test instability with this fix. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14347&quot; title=&quot;YARNSessionFIFOITCase.checkForProhibitedLogContents found a log with prohibited string&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14347&quot;&gt;&lt;del&gt;FLINK-14347&lt;/del&gt;&lt;/a&gt; looks as if we are reacting to an &lt;tt&gt;onShutdownRequest&lt;/tt&gt; during the test clean up phase. Since we are calling the &lt;tt&gt;FatalExceptionHandler&lt;/tt&gt; we terminate the process and log a fatal error in the logs which fails the test.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13261227">FLINK-14347</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06ga0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>