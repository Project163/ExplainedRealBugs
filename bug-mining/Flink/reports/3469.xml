<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:42:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14949] Task cancellation can be stuck against out-of-thread error</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14949</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Task cancellation (&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/taskmanager/Task.java#L991&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;em&gt;cancelOrFailAndCancelInvokable&lt;/em&gt;&lt;/a&gt;) relies on multiple separate threads, which are &lt;em&gt;TaskCanceler&lt;/em&gt;, &lt;em&gt;TaskInterrupter&lt;/em&gt;, and &lt;em&gt;TaskCancelerWatchdog&lt;/em&gt;. While TaskCanceler performs cancellation itself, TaskInterrupter periodically interrupts a non-reacting task and TaskCancelerWatchdog kills JVM if cancellation has never been finished within a certain amount of time (by default 3 min). Those all ensure that cancellation can be done or either aborted transitioning to a terminal state in finite time (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4715&quot; title=&quot;TaskManager should commit suicide after cancellation failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4715&quot;&gt;&lt;del&gt;FLINK-4715&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;However, if any asynchronous thread creation is failed such as by out-of-thread (&lt;em&gt;java.lang.OutOfMemoryError: unable to create new native thread&lt;/em&gt;), the code transitions to CANCELING, but nothing could be performed for cancellation or watched by watchdog. Currently, jobmanager does &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/executiongraph/Execution.java#L1121&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;retry cancellation&lt;/a&gt; against any error returned, but a next retry &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/taskmanager/Task.java#L997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;returns success once it sees CANCELING&lt;/a&gt;, assuming that it is in progress. This leads to complete stuck in CANCELING, which is non-terminal, so state machine is stuck after that.&lt;/p&gt;

&lt;p&gt;One solution would be that if a task has transitioned to CANCELLING but it gets fatal error or OOM (i.e., &lt;em&gt;isJvmFatalOrOutOfMemoryError&lt;/em&gt; is true) indicating that it could not reach spawning TaskCancelerWatchdog, it could immediately consider that as fatal error (not safely cancellable) calling &lt;em&gt;notifyFatalError&lt;/em&gt;, just as TaskCancelerWatchdog does but eagerly and synchronously. That way, it can at least transition out of the non-terminal state and furthermore clear potentially leaked thread/memory by restarting JVM. The same method is also invoked by &lt;em&gt;failExternally&lt;/em&gt;, but transitioning to FAILED seems less critical as it&apos;s already terminal state.&lt;/p&gt;

&lt;p&gt;How to reproduce is straightforward by running an application that keeps creating threads, each of which never finishes in a loop, and has multiple tasks so that one task triggers failure and then the others are attempted to be cancelled by full fail-over. In web UI dashboard, some tasks from a task manager where any of cancellation-related threads failed to be spawned are stuck in CANCELLING for good.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13270646">FLINK-14949</key>
            <summary>Task cancellation can be stuck against out-of-thread error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hwanju">Hwanju Kim</assignee>
                                    <reporter username="hwanju">Hwanju Kim</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 26 Nov 2019 07:22:27 +0000</created>
                <updated>Tue, 10 Mar 2020 17:54:04 +0000</updated>
                            <resolved>Fri, 6 Dec 2019 13:47:30 +0000</resolved>
                                    <version>1.8.2</version>
                                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16982301" author="azagrebin" created="Tue, 26 Nov 2019 09:56:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hwanju&quot; class=&quot;user-hover&quot; rel=&quot;hwanju&quot;&gt;hwanju&lt;/a&gt;&lt;br/&gt;
Thanks for filing this problem. It looks like a bug in Flink. The proposed solution also looks good because if we are unable to spawn the cancelation threads we cannot do much about this except fatally terminating JVM. After talking to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;,&#160;we do not have plans to handle the cancelation differently at the moment so we have to introduce another try/catch surrounding spawning the cancelation threads.&lt;/p&gt;

&lt;p&gt;Do you have time to work on the suggested fix for this and want to be assigned to the issue?&lt;/p&gt;</comment>
                            <comment id="16982305" author="hwanju" created="Tue, 26 Nov 2019 10:05:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;, thanks for the quick answer and sure, I can work on this.&lt;/p&gt;</comment>
                            <comment id="16982319" author="rmetzger" created="Tue, 26 Nov 2019 10:21:39 +0000"  >&lt;p&gt;Thanks. I assigned you&lt;/p&gt;</comment>
                            <comment id="16989773" author="pnowojski" created="Fri, 6 Dec 2019 13:47:30 +0000"  >&lt;p&gt;merged commit 0f47614 to master branch and as&#160;9a9548948563e7778a465d76bc4319c06a29fe7b to release-1.9&lt;/p&gt;


&lt;p&gt;Back porting to 1.8 would require to rewrite the test.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13290632">FLINK-16511</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z090g0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>