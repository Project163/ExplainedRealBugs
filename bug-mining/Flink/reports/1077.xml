<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:24:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4096] Nested FileOutputStream is not closed in JarFileCreator</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4096</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; JarOutputStream jos = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JarOutputStream(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.outputFile), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Manifest());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When jos is closed, the FileOutputStream is not automatically closed.&lt;/p&gt;

&lt;p&gt;FileOutputStream should be closed explicitly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12981138">FLINK-4096</key>
            <summary>Nested FileOutputStream is not closed in JarFileCreator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ivan.mushketyk">Ivan Mushketyk</assignee>
                                    <reporter username="yuzhihong@gmail.com">Ted Yu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Jun 2016 23:32:30 +0000</created>
                <updated>Mon, 11 Jul 2016 09:44:13 +0000</updated>
                            <resolved>Mon, 11 Jul 2016 09:43:59 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15351801" author="ivan.mushketyk" created="Mon, 27 Jun 2016 20:58:29 +0000"  >&lt;p&gt;I&apos;ll work on this.&lt;/p&gt;</comment>
                            <comment id="15351835" author="ivan.mushketyk" created="Mon, 27 Jun 2016 21:17:35 +0000"  >&lt;p&gt;It seems that JarOutputStream closes the FileOutputStream.&lt;br/&gt;
JarOutputStream inherits DeflaterOutputStream that has the following close() methods:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/**
     * Writes remaining compressed data to the output stream and closes the
     * underlying stream.
     * @exception IOException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; an I/O error has occurred
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!closed) {
            finish();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (usesDefaultDeflater)
                def.end();
            out.close();
            closed = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Where out is an underlying OutputStream.&lt;/p&gt;</comment>
                            <comment id="15351881" author="githubbot" created="Mon, 27 Jun 2016 21:35:39 +0000"  >&lt;p&gt;GitHub user mushketyk opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2172&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4096&quot; title=&quot;Nested FileOutputStream is not closed in JarFileCreator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4096&quot;&gt;&lt;del&gt;FLINK-4096&lt;/del&gt;&lt;/a&gt; Ensure JarOutputStream is always closed&lt;/p&gt;

&lt;p&gt;    Thanks for contributing to Apache Flink. Before you open your pull request, please take the following check list into consideration.&lt;br/&gt;
    If your changes take all of the items into account, feel free to open your pull request. For more information and/or questions please refer to the &lt;span class=&quot;error&quot;&gt;&amp;#91;How To Contribute guide&amp;#93;&lt;/span&gt;(&lt;a href=&quot;http://flink.apache.org/how-to-contribute.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://flink.apache.org/how-to-contribute.html&lt;/a&gt;).&lt;br/&gt;
    In addition to going through the list, please provide a meaningful description of your changes.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; General&lt;/li&gt;
	&lt;li&gt;The pull request references the related JIRA issue (&quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;FLINK-XXX&amp;#93;&lt;/span&gt; Jira title text&quot;)&lt;/li&gt;
	&lt;li&gt;The pull request addresses only one issue&lt;/li&gt;
	&lt;li&gt;Each commit in the PR has a meaningful commit message (including the JIRA id)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; Documentation&lt;/li&gt;
	&lt;li&gt;Documentation has been added for new functionality&lt;/li&gt;
	&lt;li&gt;Old documentation affected by the pull request has been updated&lt;/li&gt;
	&lt;li&gt;JavaDoc for public methods has been added&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; Tests &amp;amp; Build&lt;/li&gt;
	&lt;li&gt;Functionality added by the pull request is covered by tests&lt;/li&gt;
	&lt;li&gt;`mvn clean verify` has been executed successfully locally or a Travis build has passed&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/mushketyk/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mushketyk/flink&lt;/a&gt; jar-file-close&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2172.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2172.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2172&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 33e05d9c5dd65bf99e376b6b788d6a8d0fe2d94a&lt;br/&gt;
Author: Ivan Mushketyk &amp;lt;ivan.mushketik@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-27T21:30:08Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4096&quot; title=&quot;Nested FileOutputStream is not closed in JarFileCreator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4096&quot;&gt;&lt;del&gt;FLINK-4096&lt;/del&gt;&lt;/a&gt; Ensure JarOutputStream is always closed&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15358915" author="githubbot" created="Fri, 1 Jul 2016 12:55:55 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2172#discussion_r69295166&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2172#discussion_r69295166&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/util/JarFileCreator.java &amp;#8212;&lt;br/&gt;
    @@ -189,33 +189,33 @@ public synchronized void createJarFile() throws IOException &lt;/p&gt;
{
     			this.outputFile.delete();
     		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JarOutputStream jos = new JarOutputStream(new FileOutputStream(this.outputFile), new Manifest());&lt;/li&gt;
	&lt;li&gt;final Iterator&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt; it = this.classSet.iterator();&lt;/li&gt;
	&lt;li&gt;while (it.hasNext()) {&lt;br/&gt;
    +		try ( JarOutputStream jos = new JarOutputStream(new FileOutputStream(this.outputFile), new Manifest())) {&lt;br/&gt;
    +			final Iterator&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt; it = this.classSet.iterator();&lt;br/&gt;
    +			while (it.hasNext()) {&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Class&amp;lt;?&amp;gt; clazz = it.next();&lt;/li&gt;
	&lt;li&gt;final String entry = clazz.getName().replace(&apos;.&apos;, &apos;/&apos;) + CLASS_EXTENSION;&lt;br/&gt;
    +				final Class&amp;lt;?&amp;gt; clazz = it.next();&lt;br/&gt;
    +				final String entry = clazz.getName().replace(&apos;.&apos;, &apos;/&apos;) + CLASS_EXTENSION;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;jos.putNextEntry(new JarEntry(entry));&lt;br/&gt;
    +				jos.putNextEntry(new JarEntry(entry));&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;String name = clazz.getName();&lt;/li&gt;
	&lt;li&gt;int n = name.lastIndexOf(&apos;.&apos;);&lt;/li&gt;
	&lt;li&gt;String className = null;&lt;/li&gt;
	&lt;li&gt;if (n &amp;gt; -1) 
{
    -				className = name.substring(n + 1, name.length());
    -			}&lt;/li&gt;
	&lt;li&gt;//Using the part after last dot instead of class.getSimpleName() could resolve the problem of inner class.&lt;/li&gt;
	&lt;li&gt;final InputStream classInputStream = clazz.getResourceAsStream(className + CLASS_EXTENSION);&lt;br/&gt;
    +				String name = clazz.getName();&lt;br/&gt;
    +				int n = name.lastIndexOf(&apos;.&apos;);&lt;br/&gt;
    +				String className = null;&lt;br/&gt;
    +				if (n &amp;gt; -1) 
{
    +					className = name.substring(n + 1, name.length());
    +				}
&lt;p&gt;    +				//Using the part after last dot instead of class.getSimpleName() could resolve the problem of inner class.&lt;br/&gt;
    +				final InputStream classInputStream = clazz.getResourceAsStream(className + CLASS_EXTENSION);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int num = classInputStream.read(buf);&lt;/li&gt;
	&lt;li&gt;while (num != -1) 
{
    -				jos.write(buf, 0, num);
    -				num = classInputStream.read(buf);
    -			}
&lt;p&gt;    +				int num = classInputStream.read(buf);&lt;br/&gt;
    +				while (num != -1) &lt;/p&gt;
{
    +					jos.write(buf, 0, num);
    +					num = classInputStream.read(buf);
    +				}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;classInputStream.close();&lt;/li&gt;
	&lt;li&gt;jos.closeEntry();&lt;br/&gt;
    +				classInputStream.close();&lt;br/&gt;
    +				jos.closeEntry();&lt;br/&gt;
    +			}&lt;br/&gt;
     		}&lt;/li&gt;
	&lt;li&gt;jos.close();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    close() is now never called.&lt;/p&gt;</comment>
                            <comment id="15369325" author="githubbot" created="Sat, 9 Jul 2016 22:25:28 +0000"  >&lt;p&gt;Github user mushketyk commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2172&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Since jos is now used in try-with-resource, I assume it will be called in any case:&lt;br/&gt;
    &lt;a href=&quot;https://github.com/apache/flink/pull/2172/files#diff-966966a476efb23e920314f9bf266539R192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2172/files#diff-966966a476efb23e920314f9bf266539R192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Am I missing something?&lt;/p&gt;</comment>
                            <comment id="15369443" author="githubbot" created="Sun, 10 Jul 2016 06:51:52 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2172&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    no, you are correct.&lt;/p&gt;</comment>
                            <comment id="15370280" author="githubbot" created="Mon, 11 Jul 2016 07:05:44 +0000"  >&lt;p&gt;Github user mushketyk commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2172&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @zentol Can you merge this PR if you find it useful?&lt;/p&gt;</comment>
                            <comment id="15370471" author="zentol" created="Mon, 11 Jul 2016 09:43:59 +0000"  >&lt;p&gt;Fixed in 8f6876218bb1335e95ab04fc608ce21959889e57&lt;/p&gt;</comment>
                            <comment id="15370472" author="githubbot" created="Mon, 11 Jul 2016 09:44:13 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2172&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 19 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zrxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>