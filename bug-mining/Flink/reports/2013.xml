<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7368] MetricStore makes cpu spin at 100%</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7368</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Flink&apos;s `MetricStore` is not thread-safe. multi-treads may acess java&apos; hashmap inside `MetricStore` and can tirgger hashmap&apos;s infinte loop. &lt;/p&gt;

&lt;p&gt;Recently I met the case that flink jobmanager consumed 100% cpu. A part of stacktrace is shown below. The full jstack is in the attachment.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;ForkJoinPool-1-worker-19&quot;&lt;/span&gt; daemon prio=10 tid=0x00007fbdacac9800 nid=0x64c1 runnable [0x00007fbd7d1c2000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
        at java.util.HashMap.put(HashMap.java:494)
        at org.apache.flink.runtime.webmonitor.metrics.MetricStore.addMetric(MetricStore.java:176)
        at org.apache.flink.runtime.webmonitor.metrics.MetricStore.add(MetricStore.java:121)
        at org.apache.flink.runtime.webmonitor.metrics.MetricFetcher.addMetrics(MetricFetcher.java:198)
        at org.apache.flink.runtime.webmonitor.metrics.MetricFetcher.access$500(MetricFetcher.java:58)
        at org.apache.flink.runtime.webmonitor.metrics.MetricFetcher$4.onSuccess(MetricFetcher.java:188)
        at akka.dispatch.OnSuccess.internal(Future.scala:212)
        at akka.dispatch.japi$CallbackBridge.apply(Future.scala:175)
        at akka.dispatch.japi$CallbackBridge.apply(Future.scala:172)
        at scala.PartialFunction$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;applyOrElse(PartialFunction.scala:123)
        at scala.runtime.AbstractPartialFunction.applyOrElse(AbstractPartialFunction.scala:28)
        at scala.concurrent.Future$$anonfun$onSuccess$1.apply(Future.scala:117)
        at scala.concurrent.Future$$anonfun$onSuccess$1.apply(Future.scala:115)
        at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:32)
        at java.util.concurrent.ForkJoinTask$AdaptedRunnable.exec(ForkJoinTask.java:1265)
        at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:334)
        at java.util.concurrent.ForkJoinWorkerThread.execTask(ForkJoinWorkerThread.java:604)
        at java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:784)
        at java.util.concurrent.ForkJoinPool.work(ForkJoinPool.java:646)
        at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:398)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are 24 threads show same stacktrace as above to indicate they are spining at HashMap.put(HashMap.java:494) (I am using Java 1.7.0_6). Many posts indicate multi-threads accessing hashmap cause this problem and I reproduce the case as well. The test code is attached. I only modify the HashMap.transfer() by adding concurrent barriers for different treads in order to simulate the timing of creation of cycles in hashmap&apos;s Entry.  My program&apos;s stacktrace shows it hangs at same line of HashMap(HashMap.put(HashMap.java:494)) as the stacktrace I post above.&lt;/p&gt;

&lt;p&gt; Even through `MetricFetcher` has a 10 seconds minimum inteverl between each metrics qurey, it still cannot guarntee query responses do not acess `MtricStore`&apos;s hashmap concurrently.  Thus I think it&apos;s a bug to fix.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="13092359">FLINK-7368</key>
            <summary>MetricStore makes cpu spin at 100%</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="nicochen2012">Nico Chen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Aug 2017 03:06:56 +0000</created>
                <updated>Wed, 2 Oct 2019 17:49:12 +0000</updated>
                            <resolved>Mon, 12 Mar 2018 15:18:14 +0000</resolved>
                                                    <fixVersion>1.3.4</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16113865" author="githubbot" created="Fri, 4 Aug 2017 03:26:15 +0000"  >&lt;p&gt;GitHub user nicochen opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4472&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4472&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7368&quot; title=&quot;MetricStore makes cpu spin at 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7368&quot;&gt;&lt;del&gt;FLINK-7368&lt;/del&gt;&lt;/a&gt;: MetricStore makes cpu spin at 100%&lt;/p&gt;

&lt;p&gt;    Flink&apos;s `MetricStore` is not thread-safe. multi-treads may acess java&apos; hashmap inside `MetricStore` and can tirgger hashmap&apos;s infinte loop. &lt;/p&gt;

&lt;p&gt;    Recently I met the case that flink jobmanager consumed 100% cpu. A part of stacktrace is shown below. The full jstack is in the attachment.&lt;/p&gt;
    &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-quote&quot;&gt;&quot;ForkJoinPool-1-worker-19&quot;&lt;/span&gt; daemon prio=10 tid=0x00007fbdacac9800 nid=0x64c1 runnable [0x00007fbd7d1c2000]
       java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
            at java.util.HashMap.put(HashMap.java:494)
            at org.apache.flink.runtime.webmonitor.metrics.MetricStore.addMetric(MetricStore.java:176)
            at org.apache.flink.runtime.webmonitor.metrics.MetricStore.add(MetricStore.java:121)
            at org.apache.flink.runtime.webmonitor.metrics.MetricFetcher.addMetrics(MetricFetcher.java:198)
            at org.apache.flink.runtime.webmonitor.metrics.MetricFetcher.access$500(MetricFetcher.java:58)
            at org.apache.flink.runtime.webmonitor.metrics.MetricFetcher$4.onSuccess(MetricFetcher.java:188)
            at akka.dispatch.OnSuccess.internal(Future.scala:212)
            at akka.dispatch.japi$CallbackBridge.apply(Future.scala:175)
            at akka.dispatch.japi$CallbackBridge.apply(Future.scala:172)
            at scala.PartialFunction$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;applyOrElse(PartialFunction.scala:123)
            at scala.runtime.AbstractPartialFunction.applyOrElse(AbstractPartialFunction.scala:28)
            at scala.concurrent.Future$$anonfun$onSuccess$1.apply(Future.scala:117)
            at scala.concurrent.Future$$anonfun$onSuccess$1.apply(Future.scala:115)
            at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:32)
            at java.util.concurrent.ForkJoinTask$AdaptedRunnable.exec(ForkJoinTask.java:1265)
            at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:334)
            at java.util.concurrent.ForkJoinWorkerThread.execTask(ForkJoinWorkerThread.java:604)
            at java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:784)
            at java.util.concurrent.ForkJoinPool.work(ForkJoinPool.java:646)
            at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:398)
    &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;    There are 24 threads show same stacktrace as above to indicate they are spining at HashMap.put(HashMap.java:494) (I am using Java 1.7.0_6). Many posts indicate multi-threads accessing hashmap cause this problem and I reproduce the case as well. Even through `MetricFetcher` has a 10 seconds minimum inteverl between each metrics qurey, it still cannot guarntee query responses do not acess `MtricStore`&apos;s hashmap concurrently. &lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/nicochen/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nicochen/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7368&quot; title=&quot;MetricStore makes cpu spin at 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7368&quot;&gt;&lt;del&gt;FLINK-7368&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4472.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4472.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4472&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit abfa571fbf99be4b98d8d690ed10df1440dd21d5&lt;br/&gt;
Author: nicochen2012 &amp;lt;16100223@cnsuning.com&amp;gt;&lt;br/&gt;
Date:   2017-08-04T03:21:49Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7368&quot; title=&quot;MetricStore makes cpu spin at 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7368&quot;&gt;&lt;del&gt;FLINK-7368&lt;/del&gt;&lt;/a&gt;: MetricStore makes cpu spin at 100%&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16113900" author="nicochen2012" created="Fri, 4 Aug 2017 03:51:46 +0000"  >&lt;p&gt;MyHashMap is a copy of Java HashMap but adding 2 concurrent barriers in tranfer() methd.&lt;br/&gt;
MyHashMapInfiniteLoop is for uint test.&lt;/p&gt;</comment>
                            <comment id="16114193" author="githubbot" created="Fri, 4 Aug 2017 09:57:14 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4472&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4472&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The problem is that the `MetricFetcher` isn&apos;t synchronizing on the `MetricStore&#180; object in `MetricFetcher#addMetrics()` as it should.&lt;/p&gt;</comment>
                            <comment id="16116034" author="githubbot" created="Mon, 7 Aug 2017 03:50:05 +0000"  >&lt;p&gt;Github user nicochen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4472&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4472&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @zentol Thanks for replying. Indeed, the problem is caused by MetricFetcher isn&apos;t synchronizing on the `MetricStore` object in MetricFetcher#addMetrics(). But in my opinion, synchronizing on the `MetricStore`  is less efficient. `MetricStore` wrapps more than one metric stores and they serves different components(e.g Jobmanager&#65292;Taskmangers)  individually. If synchronizing on the `MetricStore` , call of addMetrics() on Jobmanger&apos;s metric may wait for addMetrics() on another taskmananger&apos;s metric done as they both acquire the same lock, which is unnecessary.&lt;/p&gt;
</comment>
                            <comment id="16121011" author="githubbot" created="Thu, 10 Aug 2017 03:50:21 +0000"  >&lt;p&gt;Github user asdf2014 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4472#discussion_r132358492&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4472#discussion_r132358492&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime-web/src/main/java/org/apache/flink/runtime/webmonitor/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -24,8 +24,8 @@&lt;br/&gt;
     import org.slf4j.Logger;&lt;br/&gt;
     import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;    -import java.util.HashMap;&lt;br/&gt;
    -import java.util.HashSet;&lt;br/&gt;
    +import java.util.concurrent.ConcurrentHashMap;&lt;br/&gt;
    +import java.util.concurrent.ConcurrentSkipListSet;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Hi, @nicochen . Thank you for the `PR`. There is a import order problem, you should change the order of those import as the following code. Otherwise it will not pass the `checkstyle` system.&lt;br/&gt;
    ```java&lt;br/&gt;
    import java.util.Map;&lt;br/&gt;
    import java.util.Set;&lt;br/&gt;
    import java.util.concurrent.ConcurrentHashMap;&lt;br/&gt;
    import java.util.concurrent.ConcurrentSkipListSet;&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16121500" author="githubbot" created="Thu, 10 Aug 2017 11:31:50 +0000"  >&lt;p&gt;Github user greghogan commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4472#discussion_r132429138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4472#discussion_r132429138&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime-web/src/main/java/org/apache/flink/runtime/webmonitor/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -24,8 +24,8 @@&lt;br/&gt;
     import org.slf4j.Logger;&lt;br/&gt;
     import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;    -import java.util.HashMap;&lt;br/&gt;
    -import java.util.HashSet;&lt;br/&gt;
    +import java.util.concurrent.ConcurrentHashMap;&lt;br/&gt;
    +import java.util.concurrent.ConcurrentSkipListSet;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    To configure the checkstyle plugin: &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-release-1.3/internals/ide_setup.html#checkstyle&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-release-1.3/internals/ide_setup.html#checkstyle&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16154170" author="githubbot" created="Tue, 5 Sep 2017 19:36:32 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4472&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4472&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I do see the benefit of a more fine-grained synchronization. What I dislike about using plain ConcurrentHashMaps everywhere is that accesses to the metrics 99% of the time are done in batches, and I don&apos;t really want to pay the synchronization cost every time.&lt;/p&gt;

&lt;p&gt;    That said, the whole &quot;you have to synchronize manually&quot; is a rather big source of bugs so we may just have to bite the bullet.&lt;/p&gt;</comment>
                            <comment id="16198495" author="till.rohrmann" created="Tue, 10 Oct 2017 10:32:47 +0000"  >&lt;p&gt;I would actually be in favour of the &lt;tt&gt;ConcurrentHashMaps&lt;/tt&gt; approach. Most of the times, there should be only very little lock contention and thus, the lock acquisition should be cheap.&lt;/p&gt;

&lt;p&gt;Making the &lt;tt&gt;MetricStore&lt;/tt&gt; thread safe would also allow to get rid of the synchronization in the &lt;tt&gt;AbstractMetricsHandler&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Additionally, we could avoid having multiple threads writing to the &lt;tt&gt;MetricStore&lt;/tt&gt; if we only allow a single thread to do the update operation. Either we have a dedicated thread for that or we wait until the previous update operation has completed via a &lt;tt&gt;ConjunctFuture&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16205607" author="pnowojski" created="Mon, 16 Oct 2017 09:14:55 +0000"  >&lt;p&gt;I will take a look at this in this or the following week. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; could you confirm that this is a release blocker?&lt;/p&gt;</comment>
                            <comment id="16205633" author="aljoscha" created="Mon, 16 Oct 2017 09:45:06 +0000"  >&lt;p&gt;I think it&apos;s a blocker yes. But &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; is the expert here.&lt;/p&gt;</comment>
                            <comment id="16205876" author="pnowojski" created="Mon, 16 Oct 2017 13:24:01 +0000"  >&lt;p&gt;For 1.4 this was fixed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; as a part of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7381&quot; title=&quot;Decouple WebRuntimeMonitor from ActorGateway&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7381&quot;&gt;&lt;del&gt;FLINK-7381&lt;/del&gt;&lt;/a&gt;. Should we close this issue and ignore 1.3.3?&lt;/p&gt;

&lt;p&gt;As a side thing I will make some refactors to make this synchronisation less brittle. &lt;/p&gt;</comment>
                            <comment id="16205885" author="zentol" created="Mon, 16 Oct 2017 13:29:41 +0000"  >&lt;p&gt;We should be able to backport the synchronization changes to 1.3.3; I can&apos;t recall any change to related classes since 1.3.&lt;/p&gt;</comment>
                            <comment id="16206031" author="githubbot" created="Mon, 16 Oct 2017 15:01:03 +0000"  >&lt;p&gt;GitHub user pnowojski opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7368&quot; title=&quot;MetricStore makes cpu spin at 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7368&quot;&gt;&lt;del&gt;FLINK-7368&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Make MetricStore ThreadSafe class&lt;/p&gt;

&lt;p&gt;    Remove external synchronisation on MetricStore&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This is a refactor that makes `MetricStore` thread safe. It achieves it by pulling in all modifying methods and by returning immutable copies in getters.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change is already covered by existing tests, such as `MetricStoreTest` or `MetricFetcherTest`&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/pnowojski/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pnowojski/flink&lt;/a&gt; flink7368&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4840&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit e49438e76c1ffb92b24837d8b958ae491bb0f9ca&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-10-16T14:53:14Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7368&quot; title=&quot;MetricStore makes cpu spin at 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7368&quot;&gt;&lt;del&gt;FLINK-7368&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Make MetricStore ThreadSafe class&lt;/p&gt;

&lt;p&gt;    Remove external synchronization on MetricStore&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16206046" author="pnowojski" created="Mon, 16 Oct 2017 15:15:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; 1.3 branch doesn&apos;t have &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;&apos;s FLIP-6 changes that fixed this bug. &lt;del&gt;However I could backport synchronisation fix there.&lt;/del&gt; I have back-ported the simplest synchronisation fix to the release-1.3 branch.&lt;/p&gt;

&lt;p&gt;Btw, I&apos;m against using here ConcurrentMaps because they wouldn&apos;t guarantee a coherent view over the metrics if accessed in the middle of an update. That&apos;s why I implemented/propose a refactor using unmodifiable copies in accessors to the MetricStore&lt;/p&gt;</comment>
                            <comment id="16206057" author="githubbot" created="Mon, 16 Oct 2017 15:23:19 +0000"  >&lt;p&gt;GitHub user pnowojski opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4841&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7368&quot; title=&quot;MetricStore makes cpu spin at 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7368&quot;&gt;&lt;del&gt;FLINK-7368&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Backport synchronization fix for MetricStore&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This backports adding missing synchronization on MetricStore&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change is already covered by existing tests, such as &lt;b&gt;MetricFetcherTest&lt;/b&gt;.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/pnowojski/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pnowojski/flink&lt;/a&gt; flink7368-1.3&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4841.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4841.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4841&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4783633167b3008e66da97076b5e38e89e85e2bd&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-10-16T15:17:26Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7368&quot; title=&quot;MetricStore makes cpu spin at 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7368&quot;&gt;&lt;del&gt;FLINK-7368&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Backport synchronization fix for MetricStore&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16207130" author="till.rohrmann" created="Tue, 17 Oct 2017 07:43:00 +0000"  >&lt;p&gt;I&apos;m not entirely sure whether it is that important to have a consistent view on the metrics via the web ui. If we are accessing the &lt;tt&gt;MetricStore&lt;/tt&gt; just in the moment where it updates some values, then we might see for one moment a slightly wrong metric result but this should be quickly corrected when querying it the next time. &lt;/p&gt;

&lt;p&gt;Copying the &lt;tt&gt;MetricStore&lt;/tt&gt; values whenever we access the metrics can be quite costly because every access will have a complexity of &lt;tt&gt;O(n log( n ))&lt;/tt&gt; due to the copy operation. Moreover, the &lt;tt&gt;MetricStore&lt;/tt&gt; is still fully synchronized which does not allow multiple components to access it concurrently. This will effectively serialize the rest handlers&apos; access to them.&lt;/p&gt;</comment>
                            <comment id="16207223" author="zentol" created="Tue, 17 Oct 2017 09:29:53 +0000"  >&lt;p&gt;The view is not consistent in any case.&lt;/p&gt;

&lt;p&gt;The report from a TaskManager is not consistent as it is generated without pausing the world. This means that 2 subsequent operators can have conflicting metrics, e.g. the subsequent operator having read more records than the previous has emitted. Even if it were, the reports from different TaskManagers are not consistent as there is no synchronization as to when the report is being generated.&lt;/p&gt;</comment>
                            <comment id="16209096" author="till.rohrmann" created="Wed, 18 Oct 2017 10:00:53 +0000"  >&lt;p&gt;Piotr correctly pointed out to me that copying a &lt;tt&gt;HashMap&lt;/tt&gt; is of course on average &lt;tt&gt;O( n )&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16209106" author="pnowojski" created="Wed, 18 Oct 2017 10:14:32 +0000"  >&lt;p&gt;Ops my bad. I assumed that copying should be fast (one &lt;tt&gt;memcopy&lt;/tt&gt; of the underlying array of pointers), which even for thousands of the elements should be cheaper then any synchronisation done by &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt;. Unfortunately that&apos;s not how this copy works - it puts one element at a time. I tested it and indeed copying is couple of orders of magnitude slower compared to using &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt;. I will rewrite my PR to use &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16209173" author="githubbot" created="Wed, 18 Oct 2017 11:35:16 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4841&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @zentol indeed, thanks for pointing out. There was one more place `MutableIOMetrics.java`.&lt;/p&gt;</comment>
                            <comment id="16209202" author="githubbot" created="Wed, 18 Oct 2017 11:56:51 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4841&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    merging.&lt;/p&gt;</comment>
                            <comment id="16209358" author="zentol" created="Wed, 18 Oct 2017 13:49:53 +0000"  >&lt;p&gt;Missing synchronization was added for 1.3 in b896b4b65c58ebcdeb5b318960823b81015c3a0c&lt;/p&gt;</comment>
                            <comment id="16210236" author="githubbot" created="Wed, 18 Oct 2017 23:01:28 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r145565409&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r145565409&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -38,29 +43,136 @@&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_OPERATOR;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TASK;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TM;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Nested data-structure to store metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This structure is not thread-safe.&lt;br/&gt;
      */&lt;br/&gt;
    +@ThreadSafe&lt;br/&gt;
     public class MetricStore {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(MetricStore.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobManagerMetricStore jobManager = new JobManagerMetricStore();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final ComponentMetricStore jobManager = new ComponentMetricStore();&lt;br/&gt;
    +	private final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeTaskManagers to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainTaskManagers(List&amp;lt;String&amp;gt; activeTaskManagers) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Isn&apos;t the method synchronization unnecessary now?&lt;/p&gt;</comment>
                            <comment id="16210237" author="githubbot" created="Wed, 18 Oct 2017 23:02:25 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4841&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @pnowojski I&apos;ve merged the PR, could you close it?&lt;/p&gt;</comment>
                            <comment id="16210644" author="githubbot" created="Thu, 19 Oct 2017 06:23:27 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4841&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yes sure, thanks for merging&lt;/p&gt;</comment>
                            <comment id="16210645" author="githubbot" created="Thu, 19 Oct 2017 06:23:28 +0000"  >&lt;p&gt;Github user pnowojski closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4841&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16210661" author="githubbot" created="Thu, 19 Oct 2017 06:50:27 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r145611565&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r145611565&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -38,29 +43,136 @@&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_OPERATOR;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TASK;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TM;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Nested data-structure to store metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This structure is not thread-safe.&lt;br/&gt;
      */&lt;br/&gt;
    +@ThreadSafe&lt;br/&gt;
     public class MetricStore {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(MetricStore.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobManagerMetricStore jobManager = new JobManagerMetricStore();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final ComponentMetricStore jobManager = new ComponentMetricStore();&lt;br/&gt;
    +	private final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeTaskManagers to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainTaskManagers(List&amp;lt;String&amp;gt; activeTaskManagers) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Strictly speaking right now it isn&apos;t. However without synchronising those methods, implementing them is much harder. For example I made one mistake where I implemented:&lt;br/&gt;
    ```&lt;br/&gt;
    if (!jobs.containKey(jobID)) &lt;/p&gt;
{
      return null;
    }
&lt;p&gt;    return jobs.get(jobID).getTaskMetricStore(taskID)&lt;br/&gt;
    ```&lt;br/&gt;
    Also without synchronising it&apos;s harder to understand correctness of code, that&apos;s handling three separate fields (whether this is a correct access order; whether the state of variable is/should be coherent, like if existence of key in one map, should imply existence a key on another, etc). &lt;/p&gt;

&lt;p&gt;    Long story short, synchronising is not an issue here, but helps with reasoning about this code.&lt;/p&gt;</comment>
                            <comment id="16216849" author="aljoscha" created="Tue, 24 Oct 2017 12:55:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; What&apos;s the state of this? Is it still an issue? Will it be ready in time for feature freeze at the end of the month?&lt;/p&gt;</comment>
                            <comment id="16216859" author="pnowojski" created="Tue, 24 Oct 2017 13:05:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; it was fixed and merged for 1.3.3. For 1.4 it was fixed accidentally by other PR, there is only one pending refactoring PR, which is waiting for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; to review/merge.&lt;/p&gt;</comment>
                            <comment id="16216860" author="zentol" created="Tue, 24 Oct 2017 13:05:11 +0000"  >&lt;p&gt;Yes it will be ready.&lt;/p&gt;</comment>
                            <comment id="16216876" author="githubbot" created="Tue, 24 Oct 2017 13:10:46 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146553570&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146553570&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -260,50 +293,66 @@ public String getMetric(String name, String defaultValue) &lt;/p&gt;
{
     				? value
     				: defaultValue;
     		}
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Sub-structure containing metrics of the JobManager.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;public static class JobManagerMetricStore extends ComponentMetricStore {&lt;br/&gt;
    +		public static ComponentMetricStore unmodifiable(ComponentMetricStore source) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (source == null) {
    +				return null;
    +			}    +			return new ComponentMetricStore(unmodifiableMap(source.metrics));    +		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Sub-structure containing metrics of a single TaskManager.&lt;br/&gt;
     	 */&lt;br/&gt;
    +	@ThreadSafe&lt;br/&gt;
     	public static class TaskManagerMetricStore extends ComponentMetricStore {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public final Set&amp;lt;String&amp;gt; garbageCollectorNames = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +		public final Set&amp;lt;String&amp;gt; garbageCollectorNames;&lt;br/&gt;
    +&lt;br/&gt;
    +		public TaskManagerMetricStore() 
{
    +			this(new ConcurrentHashMap&amp;lt;&amp;gt;(), ConcurrentHashMap.newKeySet());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public TaskManagerMetricStore(Map&amp;lt;String, String&amp;gt; metrics, Set&amp;lt;String&amp;gt; garbageCollectorNames) &lt;/p&gt;
{
    +			super(metrics);
    +			this.garbageCollectorNames = checkNotNull(garbageCollectorNames);
    +		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public void addGarbageCollectorName(String name) &lt;/p&gt;
{
     			garbageCollectorNames.add(name);
     		}
&lt;p&gt;    +&lt;br/&gt;
    +		public static TaskManagerMetricStore unmodifiable(TaskManagerMetricStore source) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I&apos;m wondering whether we really need this unmodifiable business. Yes, it&apos;s technically a good idea, but the access to the MetricStore is limited and fully under our control; so we &lt;em&gt;know&lt;/em&gt; that we never try to modify the map.&lt;/p&gt;</comment>
                            <comment id="16216875" author="githubbot" created="Tue, 24 Oct 2017 13:10:46 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146552100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146552100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -38,29 +43,136 @@&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_OPERATOR;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TASK;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TM;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Nested data-structure to store metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This structure is not thread-safe.&lt;br/&gt;
      */&lt;br/&gt;
    +@ThreadSafe&lt;br/&gt;
     public class MetricStore {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(MetricStore.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobManagerMetricStore jobManager = new JobManagerMetricStore();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final ComponentMetricStore jobManager = new ComponentMetricStore();&lt;br/&gt;
    +	private final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeTaskManagers to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainTaskManagers(List&amp;lt;String&amp;gt; activeTaskManagers) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    but now we&apos;re paying the synchronization costs twice, once for the synchronized keyword and once again for every access to the map. If every method is synchronized the maps don&apos;t have to be concurrent hash maps.&lt;/p&gt;</comment>
                            <comment id="16216974" author="githubbot" created="Tue, 24 Oct 2017 14:18:23 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146574784&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146574784&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -38,29 +43,136 @@&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_OPERATOR;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TASK;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TM;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Nested data-structure to store metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This structure is not thread-safe.&lt;br/&gt;
      */&lt;br/&gt;
    +@ThreadSafe&lt;br/&gt;
     public class MetricStore {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(MetricStore.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobManagerMetricStore jobManager = new JobManagerMetricStore();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final ComponentMetricStore jobManager = new ComponentMetricStore();&lt;br/&gt;
    +	private final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeTaskManagers to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainTaskManagers(List&amp;lt;String&amp;gt; activeTaskManagers) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    1. performance here is not that big a deal, but code correctness is. With `synchronized` it is just easier to implement any changes here in a thread safe manner. Without it, any new developer coming here will have to understand much more assumptions about this code, like whether consistency matters here or nor? whether order of the operations/access to the fields is important or nor? etc...&lt;/p&gt;

&lt;p&gt;    2. even with `synchronized` we still need either concurrent hash maps, because we return and make them visible to the outside world by getters. So we either need concurrent hash maps or return copies of them.&lt;/p&gt;</comment>
                            <comment id="16216984" author="githubbot" created="Tue, 24 Oct 2017 14:23:31 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146576511&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146576511&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -260,50 +293,66 @@ public String getMetric(String name, String defaultValue) &lt;/p&gt;
{
     				? value
     				: defaultValue;
     		}
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Sub-structure containing metrics of the JobManager.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;public static class JobManagerMetricStore extends ComponentMetricStore {&lt;br/&gt;
    +		public static ComponentMetricStore unmodifiable(ComponentMetricStore source) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (source == null) {
    +				return null;
    +			}    +			return new ComponentMetricStore(unmodifiableMap(source.metrics));    +		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Sub-structure containing metrics of a single TaskManager.&lt;br/&gt;
     	 */&lt;br/&gt;
    +	@ThreadSafe&lt;br/&gt;
     	public static class TaskManagerMetricStore extends ComponentMetricStore {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public final Set&amp;lt;String&amp;gt; garbageCollectorNames = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +		public final Set&amp;lt;String&amp;gt; garbageCollectorNames;&lt;br/&gt;
    +&lt;br/&gt;
    +		public TaskManagerMetricStore() 
{
    +			this(new ConcurrentHashMap&amp;lt;&amp;gt;(), ConcurrentHashMap.newKeySet());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public TaskManagerMetricStore(Map&amp;lt;String, String&amp;gt; metrics, Set&amp;lt;String&amp;gt; garbageCollectorNames) &lt;/p&gt;
{
    +			super(metrics);
    +			this.garbageCollectorNames = checkNotNull(garbageCollectorNames);
    +		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public void addGarbageCollectorName(String name) &lt;/p&gt;
{
     			garbageCollectorNames.add(name);
     		}
&lt;p&gt;    +&lt;br/&gt;
    +		public static TaskManagerMetricStore unmodifiable(TaskManagerMetricStore source) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    It&apos;s a matter of clean design and maintaining it in the future. You only &lt;b&gt;know&lt;/b&gt; that we do not modify this map *&lt;b&gt;at the moment&lt;/b&gt;*. Are you sure that every committer reviewing changes in this parts of the code will always spot any such modifications without `unmodifiable` assertion?  On the other hand removing `unmodifiable` in a PR is big yellow warning light that&apos;s something is going on.&lt;/p&gt;

&lt;p&gt;    Following this logic, why don&apos;t we make all methods/fields `public`, since we know that we will never try to access supposed to be `private` fields?&lt;/p&gt;</comment>
                            <comment id="16217020" author="githubbot" created="Tue, 24 Oct 2017 14:41:24 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146582951&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146582951&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -260,50 +293,66 @@ public String getMetric(String name, String defaultValue) &lt;/p&gt;
{
     				? value
     				: defaultValue;
     		}
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Sub-structure containing metrics of the JobManager.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;public static class JobManagerMetricStore extends ComponentMetricStore {&lt;br/&gt;
    +		public static ComponentMetricStore unmodifiable(ComponentMetricStore source) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (source == null) {
    +				return null;
    +			}    +			return new ComponentMetricStore(unmodifiableMap(source.metrics));    +		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Sub-structure containing metrics of a single TaskManager.&lt;br/&gt;
     	 */&lt;br/&gt;
    +	@ThreadSafe&lt;br/&gt;
     	public static class TaskManagerMetricStore extends ComponentMetricStore {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public final Set&amp;lt;String&amp;gt; garbageCollectorNames = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +		public final Set&amp;lt;String&amp;gt; garbageCollectorNames;&lt;br/&gt;
    +&lt;br/&gt;
    +		public TaskManagerMetricStore() 
{
    +			this(new ConcurrentHashMap&amp;lt;&amp;gt;(), ConcurrentHashMap.newKeySet());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public TaskManagerMetricStore(Map&amp;lt;String, String&amp;gt; metrics, Set&amp;lt;String&amp;gt; garbageCollectorNames) &lt;/p&gt;
{
    +			super(metrics);
    +			this.garbageCollectorNames = checkNotNull(garbageCollectorNames);
    +		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public void addGarbageCollectorName(String name) &lt;/p&gt;
{
     			garbageCollectorNames.add(name);
     		}
&lt;p&gt;    +&lt;br/&gt;
    +		public static TaskManagerMetricStore unmodifiable(TaskManagerMetricStore source) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    In which case we should rather modify the store to not allow writes in the first place, instead of opting for unmodifiable collections that are pretty much a hack. &quot;here, have an object that fails for 50% of the defined methods&quot;; that&apos;s hardly good design is it.&lt;/p&gt;

&lt;p&gt;    Till suggested dedicated read methods that return metrics, something like `List&amp;lt;String&amp;gt; getMetrics(List&amp;lt;String&amp;gt; metricNames)` instead of exposing the metric maps.&lt;/p&gt;

&lt;p&gt;    This would make the interface cleaner and would allow us to simplify the synchronization.&lt;/p&gt;


</comment>
                            <comment id="16217086" author="githubbot" created="Tue, 24 Oct 2017 15:15:23 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146594528&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146594528&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -260,50 +293,66 @@ public String getMetric(String name, String defaultValue) &lt;/p&gt;
{
     				? value
     				: defaultValue;
     		}
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Sub-structure containing metrics of the JobManager.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;public static class JobManagerMetricStore extends ComponentMetricStore {&lt;br/&gt;
    +		public static ComponentMetricStore unmodifiable(ComponentMetricStore source) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (source == null) {
    +				return null;
    +			}    +			return new ComponentMetricStore(unmodifiableMap(source.metrics));    +		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Sub-structure containing metrics of a single TaskManager.&lt;br/&gt;
     	 */&lt;br/&gt;
    +	@ThreadSafe&lt;br/&gt;
     	public static class TaskManagerMetricStore extends ComponentMetricStore {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public final Set&amp;lt;String&amp;gt; garbageCollectorNames = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +		public final Set&amp;lt;String&amp;gt; garbageCollectorNames;&lt;br/&gt;
    +&lt;br/&gt;
    +		public TaskManagerMetricStore() 
{
    +			this(new ConcurrentHashMap&amp;lt;&amp;gt;(), ConcurrentHashMap.newKeySet());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public TaskManagerMetricStore(Map&amp;lt;String, String&amp;gt; metrics, Set&amp;lt;String&amp;gt; garbageCollectorNames) &lt;/p&gt;
{
    +			super(metrics);
    +			this.garbageCollectorNames = checkNotNull(garbageCollectorNames);
    +		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public void addGarbageCollectorName(String name) &lt;/p&gt;
{
     			garbageCollectorNames.add(name);
     		}
&lt;p&gt;    +&lt;br/&gt;
    +		public static TaskManagerMetricStore unmodifiable(TaskManagerMetricStore source) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Would you rather have a runtime error about illegal/unintended write access or none at all? Java sucks in this regard (missing const-correctness) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;    Exposing `List&amp;lt;...&amp;gt;` have the same issue.&lt;/p&gt;</comment>
                            <comment id="16217265" author="githubbot" created="Tue, 24 Oct 2017 17:03:02 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146627036&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146627036&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -260,50 +293,66 @@ public String getMetric(String name, String defaultValue) &lt;/p&gt;
{
     				? value
     				: defaultValue;
     		}
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Sub-structure containing metrics of the JobManager.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;public static class JobManagerMetricStore extends ComponentMetricStore {&lt;br/&gt;
    +		public static ComponentMetricStore unmodifiable(ComponentMetricStore source) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (source == null) {
    +				return null;
    +			}    +			return new ComponentMetricStore(unmodifiableMap(source.metrics));    +		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Sub-structure containing metrics of a single TaskManager.&lt;br/&gt;
     	 */&lt;br/&gt;
    +	@ThreadSafe&lt;br/&gt;
     	public static class TaskManagerMetricStore extends ComponentMetricStore {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public final Set&amp;lt;String&amp;gt; garbageCollectorNames = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +		public final Set&amp;lt;String&amp;gt; garbageCollectorNames;&lt;br/&gt;
    +&lt;br/&gt;
    +		public TaskManagerMetricStore() 
{
    +			this(new ConcurrentHashMap&amp;lt;&amp;gt;(), ConcurrentHashMap.newKeySet());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public TaskManagerMetricStore(Map&amp;lt;String, String&amp;gt; metrics, Set&amp;lt;String&amp;gt; garbageCollectorNames) &lt;/p&gt;
{
    +			super(metrics);
    +			this.garbageCollectorNames = checkNotNull(garbageCollectorNames);
    +		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public void addGarbageCollectorName(String name) &lt;/p&gt;
{
     			garbageCollectorNames.add(name);
     		}
&lt;p&gt;    +&lt;br/&gt;
    +		public static TaskManagerMetricStore unmodifiable(TaskManagerMetricStore source) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    If the returned list is a fresh copy independent of the map it can be modifiable; the user can do whatever he wants with it.&lt;/p&gt;</comment>
                            <comment id="16218388" author="githubbot" created="Wed, 25 Oct 2017 10:47:15 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146819586&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146819586&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -260,50 +293,66 @@ public String getMetric(String name, String defaultValue) &lt;/p&gt;
{
     				? value
     				: defaultValue;
     		}
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Sub-structure containing metrics of the JobManager.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;public static class JobManagerMetricStore extends ComponentMetricStore {&lt;br/&gt;
    +		public static ComponentMetricStore unmodifiable(ComponentMetricStore source) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (source == null) {
    +				return null;
    +			}    +			return new ComponentMetricStore(unmodifiableMap(source.metrics));    +		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Sub-structure containing metrics of a single TaskManager.&lt;br/&gt;
     	 */&lt;br/&gt;
    +	@ThreadSafe&lt;br/&gt;
     	public static class TaskManagerMetricStore extends ComponentMetricStore {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public final Set&amp;lt;String&amp;gt; garbageCollectorNames = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +		public final Set&amp;lt;String&amp;gt; garbageCollectorNames;&lt;br/&gt;
    +&lt;br/&gt;
    +		public TaskManagerMetricStore() 
{
    +			this(new ConcurrentHashMap&amp;lt;&amp;gt;(), ConcurrentHashMap.newKeySet());
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public TaskManagerMetricStore(Map&amp;lt;String, String&amp;gt; metrics, Set&amp;lt;String&amp;gt; garbageCollectorNames) &lt;/p&gt;
{
    +			super(metrics);
    +			this.garbageCollectorNames = checkNotNull(garbageCollectorNames);
    +		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		public void addGarbageCollectorName(String name) &lt;/p&gt;
{
     			garbageCollectorNames.add(name);
     		}
&lt;p&gt;    +&lt;br/&gt;
    +		public static TaskManagerMetricStore unmodifiable(TaskManagerMetricStore source) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Then you pay costs of copying all of the objects, which is much higher compared to the synchronisation. But yes, you can do that. In that case you don&apos;t need concurrent hash maps. &lt;/p&gt;

&lt;p&gt;    If you intend to go in other direction with this and leave the current code in the master as it is, please log the work in Jira for this after the release (I will close release blocker issue for which I started this PR). However I have an impression that any follow up work would be easier on top of this change and in the mean time this is still way better then current code on master branch with this external synchronisation.  &lt;/p&gt;</comment>
                            <comment id="16218406" author="githubbot" created="Wed, 25 Oct 2017 11:19:14 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146825012&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146825012&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -38,29 +43,136 @@&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_OPERATOR;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TASK;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TM;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Nested data-structure to store metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This structure is not thread-safe.&lt;br/&gt;
      */&lt;br/&gt;
    +@ThreadSafe&lt;br/&gt;
     public class MetricStore {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(MetricStore.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobManagerMetricStore jobManager = new JobManagerMetricStore();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final ComponentMetricStore jobManager = new ComponentMetricStore();&lt;br/&gt;
    +	private final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeTaskManagers to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainTaskManagers(List&amp;lt;String&amp;gt; activeTaskManagers) 
{
    +		taskManagers.keySet().retainAll(activeTaskManagers);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeJobs to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainJobs(List&amp;lt;String&amp;gt; activeJobs) &lt;/p&gt;
{
    +		jobs.keySet().retainAll(activeJobs);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Add metric dumps to the store.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param metricDumps to add.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void addAll(List&amp;lt;MetricDump&amp;gt; metricDumps) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		for (MetricDump metric }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	// -----------------------------------------------------------------------------------------------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Adding metrics&lt;br/&gt;
    +	// Accessors for sub MetricStores&lt;br/&gt;
     	// -----------------------------------------------------------------------------------------------------------------&lt;/li&gt;
	&lt;li&gt;public void add(MetricDump metric) {&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Returns the 
{@link ComponentMetricStore}
&lt;p&gt;.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return JobManagerMetricStore&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    outdated class reference&lt;/p&gt;</comment>
                            <comment id="16218407" author="githubbot" created="Wed, 25 Oct 2017 11:19:14 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146825384&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146825384&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -260,50 +293,66 @@ public String getMetric(String name, String defaultValue) &lt;/p&gt;
{
     				? value
     				: defaultValue;
     		}
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Sub-structure containing metrics of the JobManager.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;public static class JobManagerMetricStore extends ComponentMetricStore {&lt;br/&gt;
    +		public static ComponentMetricStore unmodifiable(ComponentMetricStore source) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    can be private&lt;/p&gt;</comment>
                            <comment id="16218408" author="githubbot" created="Wed, 25 Oct 2017 11:19:14 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146824968&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146824968&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -38,29 +43,136 @@&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_OPERATOR;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TASK;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TM;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Nested data-structure to store metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This structure is not thread-safe.&lt;br/&gt;
      */&lt;br/&gt;
    +@ThreadSafe&lt;br/&gt;
     public class MetricStore {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(MetricStore.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobManagerMetricStore jobManager = new JobManagerMetricStore();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final ComponentMetricStore jobManager = new ComponentMetricStore();&lt;br/&gt;
    +	private final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeTaskManagers to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainTaskManagers(List&amp;lt;String&amp;gt; activeTaskManagers) 
{
    +		taskManagers.keySet().retainAll(activeTaskManagers);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeJobs to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainJobs(List&amp;lt;String&amp;gt; activeJobs) &lt;/p&gt;
{
    +		jobs.keySet().retainAll(activeJobs);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Add metric dumps to the store.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param metricDumps to add.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void addAll(List&amp;lt;MetricDump&amp;gt; metricDumps) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		for (MetricDump metric }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	// -----------------------------------------------------------------------------------------------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Adding metrics&lt;br/&gt;
    +	// Accessors for sub MetricStores&lt;br/&gt;
     	// -----------------------------------------------------------------------------------------------------------------&lt;/li&gt;
	&lt;li&gt;public void add(MetricDump metric) {&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Returns the 
{@link ComponentMetricStore}
&lt;p&gt;.&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    javadoc is missing any mention of jobmanager&lt;/p&gt;</comment>
                            <comment id="16218409" author="githubbot" created="Wed, 25 Oct 2017 11:19:14 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146824632&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146824632&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -38,29 +43,136 @@&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_OPERATOR;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TASK;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TM;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Nested data-structure to store metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This structure is not thread-safe.&lt;br/&gt;
      */&lt;br/&gt;
    +@ThreadSafe&lt;br/&gt;
     public class MetricStore {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(MetricStore.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobManagerMetricStore jobManager = new JobManagerMetricStore();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final ComponentMetricStore jobManager = new ComponentMetricStore();&lt;br/&gt;
    +	private final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeTaskManagers to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainTaskManagers(List&amp;lt;String&amp;gt; activeTaskManagers) 
{
    +		taskManagers.keySet().retainAll(activeTaskManagers);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeJobs to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainJobs(List&amp;lt;String&amp;gt; activeJobs) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    can be package private&lt;/p&gt;</comment>
                            <comment id="16218410" author="githubbot" created="Wed, 25 Oct 2017 11:19:14 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146825517&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146825517&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStoreTest.java &amp;#8212;&lt;br/&gt;
    @@ -58,9 +59,9 @@ public void testMalformedNameHandling() {&lt;br/&gt;
     		store.add(cd);&lt;/p&gt;

&lt;p&gt;     		//-----verify that no side effects occur&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;assertEquals(0, store.jobManager.metrics.size());&lt;/li&gt;
	&lt;li&gt;assertEquals(0, store.taskManagers.size());&lt;/li&gt;
	&lt;li&gt;assertEquals(0, store.jobs.size());&lt;br/&gt;
    +		assertTrue(store.getTaskManagers().isEmpty());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    i actually prefer the previous version as it prints the actual value.&lt;/p&gt;</comment>
                            <comment id="16218411" author="githubbot" created="Wed, 25 Oct 2017 11:19:14 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146824504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146824504&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/util/MutableIOMetrics.java &amp;#8212;&lt;br/&gt;
    @@ -79,7 +79,7 @@ public void addIOMetrics(AccessExecution attempt, @Nullable MetricFetcher fetche&lt;br/&gt;
     				fetcher.update();&lt;br/&gt;
     				MetricStore metricStore = fetcher.getMetricStore();&lt;br/&gt;
     				synchronized (metricStore) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    leftover synchronization&lt;/p&gt;</comment>
                            <comment id="16218412" author="githubbot" created="Wed, 25 Oct 2017 11:19:14 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146824651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146824651&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -38,29 +43,136 @@&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_OPERATOR;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TASK;&lt;br/&gt;
     import static org.apache.flink.runtime.metrics.dump.QueryScopeInfo.INFO_CATEGORY_TM;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Nested data-structure to store metrics.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* &amp;lt;p&amp;gt;This structure is not thread-safe.&lt;br/&gt;
      */&lt;br/&gt;
    +@ThreadSafe&lt;br/&gt;
     public class MetricStore {&lt;br/&gt;
     	private static final Logger LOG = LoggerFactory.getLogger(MetricStore.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobManagerMetricStore jobManager = new JobManagerMetricStore();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final ComponentMetricStore jobManager = new ComponentMetricStore();&lt;br/&gt;
    +	private final Map&amp;lt;String, TaskManagerMetricStore&amp;gt; taskManagers = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +	private final Map&amp;lt;String, JobMetricStore&amp;gt; jobs = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeTaskManagers to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainTaskManagers(List&amp;lt;String&amp;gt; activeTaskManagers) 
{
    +		taskManagers.keySet().retainAll(activeTaskManagers);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Remove not active task managers.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param activeJobs to retain.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void retainJobs(List&amp;lt;String&amp;gt; activeJobs) &lt;/p&gt;
{
    +		jobs.keySet().retainAll(activeJobs);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Add metric dumps to the store.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param metricDumps to add.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public synchronized void addAll(List&amp;lt;MetricDump&amp;gt; metricDumps) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    package private&lt;/p&gt;</comment>
                            <comment id="16218413" author="githubbot" created="Wed, 25 Oct 2017 11:19:15 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146825259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146825259&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/legacy/metrics/MetricStore.java &amp;#8212;&lt;br/&gt;
    @@ -181,74 +265,23 @@ private void addMetric(Map&amp;lt;String, String&amp;gt; target, String name, MetricDump metri&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	// -----------------------------------------------------------------------------------------------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Accessors for sub MetricStores&lt;br/&gt;
    +	// sub MetricStore classes&lt;br/&gt;
     	// -----------------------------------------------------------------------------------------------------------------&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Returns the 
{@link JobManagerMetricStore}
&lt;p&gt;.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* @return JobManagerMetricStore&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;public JobManagerMetricStore getJobManagerMetricStore() 
{
    -		return jobManager;
    -	}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Returns the 
{@link TaskManagerMetricStore}
&lt;p&gt; for the given taskmanager ID.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* @param tmID taskmanager ID&lt;/li&gt;
	&lt;li&gt;* @return TaskManagerMetricStore for the given ID, or null if no store for the given argument exists&lt;br/&gt;
    +	 * Structure containing metrics of a single component.&lt;br/&gt;
     	 */&lt;/li&gt;
	&lt;li&gt;public TaskManagerMetricStore getTaskManagerMetricStore(String tmID) 
{
    -		return taskManagers.get(tmID);
    -	}
&lt;p&gt;    +	@ThreadSafe&lt;br/&gt;
    +	public static class ComponentMetricStore {&lt;br/&gt;
    +		public final Map&amp;lt;String, String&amp;gt; metrics;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Returns the 
{@link JobMetricStore}
&lt;p&gt; for the given job ID.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* @param jobID job ID&lt;/li&gt;
	&lt;li&gt;* @return JobMetricStore for the given ID, or null if no store for the given argument exists&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;public JobMetricStore getJobMetricStore(String jobID) 
{
    -		return jobs.get(jobID);
    -	}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Returns the 
{@link TaskMetricStore}
&lt;p&gt; for the given job/task ID.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* @param jobID  job ID&lt;/li&gt;
	&lt;li&gt;* @param taskID task ID&lt;/li&gt;
	&lt;li&gt;* @return TaskMetricStore for given IDs, or null if no store for the given arguments exists&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;public TaskMetricStore getTaskMetricStore(String jobID, String taskID) {&lt;/li&gt;
	&lt;li&gt;JobMetricStore job = getJobMetricStore(jobID);&lt;/li&gt;
	&lt;li&gt;if (job == null) {&lt;/li&gt;
	&lt;li&gt;return null;&lt;br/&gt;
    +		public ComponentMetricStore() {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    all constructors can be private&lt;/p&gt;</comment>
                            <comment id="16218447" author="githubbot" created="Wed, 25 Oct 2017 11:49:51 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840#discussion_r146831312&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840#discussion_r146831312&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/util/MutableIOMetrics.java &amp;#8212;&lt;br/&gt;
    @@ -79,7 +79,7 @@ public void addIOMetrics(AccessExecution attempt, @Nullable MetricFetcher fetche&lt;br/&gt;
     				fetcher.update();&lt;br/&gt;
     				MetricStore metricStore = fetcher.getMetricStore();&lt;br/&gt;
     				synchronized (metricStore) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Don&apos;t know why I have missed it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16218580" author="githubbot" created="Wed, 25 Oct 2017 13:05:26 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks!&lt;/p&gt;</comment>
                            <comment id="16218581" author="githubbot" created="Wed, 25 Oct 2017 13:05:27 +0000"  >&lt;p&gt;Github user pnowojski closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16218582" author="githubbot" created="Wed, 25 Oct 2017 13:05:33 +0000"  >&lt;p&gt;GitHub user pnowojski reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7368&quot; title=&quot;MetricStore makes cpu spin at 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7368&quot;&gt;&lt;del&gt;FLINK-7368&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Make MetricStore ThreadSafe class&lt;/p&gt;

&lt;p&gt;    Remove external synchronisation on MetricStore&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This is a refactor that makes `MetricStore` thread safe. It achieves it by pulling in all modifying methods and by returning immutable copies in getters.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change is already covered by existing tests, such as `MetricStoreTest` or `MetricFetcherTest`&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/pnowojski/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pnowojski/flink&lt;/a&gt; flink7368&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4840&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit b19077430808923e047b808f68efd47f4c9527e0&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-10-16T14:53:14Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7368&quot; title=&quot;MetricStore makes cpu spin at 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7368&quot;&gt;&lt;del&gt;FLINK-7368&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Make MetricStore ThreadSafe class&lt;/p&gt;

&lt;p&gt;    Remove external synchronization on MetricStore&lt;/p&gt;

&lt;p&gt;commit b6be2ce229ec3c97cd3bc3861f1989e971599fd7&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-10-25T11:53:16Z&lt;/p&gt;

&lt;p&gt;    fixup! &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7368&quot; title=&quot;MetricStore makes cpu spin at 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7368&quot;&gt;&lt;del&gt;FLINK-7368&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Make MetricStore ThreadSafe class&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16220549" author="zentol" created="Thu, 26 Oct 2017 14:43:46 +0000"  >&lt;p&gt;1.4: f622de3ecbc2ae17f2d15fe46828c48747c2b6ae&lt;/p&gt;</comment>
                            <comment id="16220553" author="githubbot" created="Thu, 26 Oct 2017 14:44:53 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4840&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16220554" author="githubbot" created="Thu, 26 Oct 2017 14:44:53 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4472&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4472&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13108745">FLINK-7818</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12880341" name="MyHashMap.java" size="38617" author="nicochen2012" created="Fri, 4 Aug 2017 03:43:41 +0000"/>
                            <attachment id="12880340" name="MyHashMapInfiniteLoopTest.java" size="1436" author="nicochen2012" created="Fri, 4 Aug 2017 03:51:06 +0000"/>
                            <attachment id="12880337" name="jm-jstack.log" size="200815" author="nicochen2012" created="Fri, 4 Aug 2017 03:08:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3iejr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>