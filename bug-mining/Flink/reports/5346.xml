<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:56:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-22345] CoordinatorEventsExactlyOnceITCase hangs on azure</title>
                <link>https://issues.apache.org/jira/browse/FLINK-22345</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16731&amp;amp;view=logs&amp;amp;j=02c4e775-43bf-5625-d1cc-542b5209e072&amp;amp;t=e5961b24-88d9-5c77-efd3-955422674c25&amp;amp;l=9896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16731&amp;amp;view=logs&amp;amp;j=02c4e775-43bf-5625-d1cc-542b5209e072&amp;amp;t=e5961b24-88d9-5c77-efd3-955422674c25&amp;amp;l=9896&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; #1 prio=5 os_prio=0 tid=0x00007fa8c800b800 nid=0x58b3 waiting on condition [0x00007fa8cfd1c000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x000000008147a7e8&amp;gt; (a java.util.concurrent.CompletableFuture$Signaller)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	at java.util.concurrent.CompletableFuture$Signaller.block(CompletableFuture.java:1707)
	at java.util.concurrent.ForkJoinPool.managedBlock(ForkJoinPool.java:3323)
	at java.util.concurrent.CompletableFuture.waitingGet(CompletableFuture.java:1742)
	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1908)
	at org.apache.flink.runtime.minicluster.MiniCluster.executeJobBlocking(MiniCluster.java:802)
	at org.apache.flink.runtime.operators.coordination.CoordinatorEventsExactlyOnceITCase.test(CoordinatorEventsExactlyOnceITCase.java:187)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.apache.flink.util.TestNameProvider$1.evaluate(TestNameProvider.java:45)
	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
	at org.junit.rules.RunRules.evaluate(RunRules.java:20)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
	at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:365)
	at org.apache.maven.surefire.junit4.JUnit4Provider.executeWithRerun(JUnit4Provider.java:273)
	at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:238)
	at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:159)
	at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:384)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:345)
	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:126)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:418)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13373489">FLINK-22345</key>
            <summary>CoordinatorEventsExactlyOnceITCase hangs on azure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="dwysakowicz">Dawid Wysakowicz</reporter>
                        <labels>
                            <label>test-stability</label>
                    </labels>
                <created>Mon, 19 Apr 2021 07:16:34 +0000</created>
                <updated>Fri, 23 Apr 2021 15:22:08 +0000</updated>
                            <resolved>Fri, 23 Apr 2021 15:22:08 +0000</resolved>
                                    <version>1.13.0</version>
                    <version>1.14.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                    <fixVersion>1.12.3</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17324770" author="dawidwys" created="Mon, 19 Apr 2021 07:17:29 +0000"  >&lt;p&gt;Could you have a look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;? &lt;/p&gt;</comment>
                            <comment id="17324771" author="dawidwys" created="Mon, 19 Apr 2021 07:18:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16731&amp;amp;view=logs&amp;amp;j=0e7be18f-84f2-53f0-a32d-4a5e4a174679&amp;amp;t=7030a106-e977-5851-a05e-535de648c9c9&amp;amp;l=11303&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16731&amp;amp;view=logs&amp;amp;j=0e7be18f-84f2-53f0-a32d-4a5e4a174679&amp;amp;t=7030a106-e977-5851-a05e-535de648c9c9&amp;amp;l=11303&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17324963" author="stephanewen" created="Mon, 19 Apr 2021 11:45:14 +0000"  >&lt;p&gt;I will take a look, thanks for pinging me.&lt;/p&gt;</comment>
                            <comment id="17325078" author="dawidwys" created="Mon, 19 Apr 2021 14:30:14 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="17325532" author="dawidwys" created="Tue, 20 Apr 2021 06:50:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16818&amp;amp;view=logs&amp;amp;j=0e7be18f-84f2-53f0-a32d-4a5e4a174679&amp;amp;t=7030a106-e977-5851-a05e-535de648c9c9&amp;amp;l=11494&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16818&amp;amp;view=logs&amp;amp;j=0e7be18f-84f2-53f0-a32d-4a5e4a174679&amp;amp;t=7030a106-e977-5851-a05e-535de648c9c9&amp;amp;l=11494&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17325594" author="mapohl" created="Tue, 20 Apr 2021 08:30:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=402&amp;amp;view=logs&amp;amp;j=cc649950-03e9-5fae-8326-2f1ad744b536&amp;amp;t=51cab6ca-669f-5dc0-221d-1e4f7dc4fc85&amp;amp;l=7561&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/mapohl/flink/_build/results?buildId=402&amp;amp;view=logs&amp;amp;j=cc649950-03e9-5fae-8326-2f1ad744b536&amp;amp;t=51cab6ca-669f-5dc0-221d-1e4f7dc4fc85&amp;amp;l=7561&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17326314" author="dawidwys" created="Wed, 21 Apr 2021 07:18:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16904&amp;amp;view=logs&amp;amp;j=0e7be18f-84f2-53f0-a32d-4a5e4a174679&amp;amp;t=7030a106-e977-5851-a05e-535de648c9c9&amp;amp;l=11673&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16904&amp;amp;view=logs&amp;amp;j=0e7be18f-84f2-53f0-a32d-4a5e4a174679&amp;amp;t=7030a106-e977-5851-a05e-535de648c9c9&amp;amp;l=11673&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17326636" author="mapohl" created="Wed, 21 Apr 2021 15:29:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/mapohl/flink/_build/results?buildId=404&amp;amp;view=logs&amp;amp;j=9dc1b5dc-bcfa-5f83-eaa7-0cb181ddc267&amp;amp;t=ab910030-93db-52a7-74a3-34a0addb481b&amp;amp;l=9874&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/mapohl/flink/_build/results?buildId=404&amp;amp;view=logs&amp;amp;j=9dc1b5dc-bcfa-5f83-eaa7-0cb181ddc267&amp;amp;t=ab910030-93db-52a7-74a3-34a0addb481b&amp;amp;l=9874&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17326915" author="stephanewen" created="Wed, 21 Apr 2021 21:02:50 +0000"  >&lt;p&gt;I think I found the reason. In all jobs, the scheduler gets lock up over this assertion:&lt;br/&gt;
(it has been there for a while)&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13024409/13024409_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;This causes the scheduler to get stuck in a loop continuously throwing this exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
22:44:02,804 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-3] INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Trying to recover from a global failure.
java.lang.AssertionError: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.flink.runtime.scheduler.SchedulerBase.restoreState(SchedulerBase.java:403) ~[classes/:?]
	at org.apache.flink.runtime.scheduler.DefaultScheduler.restartTasks(DefaultScheduler.java:290) ~[classes/:?]
	at org.apache.flink.runtime.scheduler.DefaultScheduler.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$1(DefaultScheduler.java:260) ~[classes/:?]
	at java.util.concurrent.CompletableFuture.uniRun(CompletableFuture.java:719) ~[?:1.8.0_282]
	at java.util.concurrent.CompletableFuture$UniRun.tryFire(CompletableFuture.java:701) ~[?:1.8.0_282]
	at java.util.concurrent.CompletableFuture$Completion.run(CompletableFuture.java:456) ~[?:1.8.0_282]
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRunAsync(AkkaRpcActor.java:440) ~[classes/:?]
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:208) ~[classes/:?]
	at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleRpcMessage(FencedAkkaRpcActor.java:77) ~[classes/:?]
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleMessage(AkkaRpcActor.java:158) ~[classes/:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think the assertion is incorrect, because the global failure doesn&apos;t always reset all vertices, if failures overlap, and some vertices have been reset before and not yet been deployed. Please &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;, if one of you could confirm this.&lt;/p&gt;

&lt;p&gt;So the fix is probably to simply remove that assertion.&lt;/p&gt;</comment>
                            <comment id="17326941" author="stephanewen" created="Wed, 21 Apr 2021 21:29:10 +0000"  >&lt;p&gt;I pushed a fix to remove this assertion (which in any case doesn&apos;t seem to hold) to have this fix in the 1.13 release.&lt;/p&gt;

&lt;p&gt;Still, a confirmation whether the diagnosis is correct would be good to make sure there isn&apos;t yet another issue at work.&lt;/p&gt;
</comment>
                            <comment id="17327014" author="stephanewen" created="Wed, 21 Apr 2021 23:54:12 +0000"  >&lt;p&gt;With that fix applied, the situation that would previously get the scheduler caught in the assertion failure loop now causes a strange situation:&lt;/p&gt;

&lt;p&gt;The scheduler calls &quot;restoreState()&quot; for recovery from a global failure in a case where not all tasks had new execution attempts created (here actually none of the tasks seem to have gotten new execution attempts). So the state is restored to the CANCELED executions, not the new executions.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
22:36:19,156 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-5] INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;-2 (1/1) (563c234c87f6e32c414755d47a9bca0a) switched from CANCELING to CANCELED.
22:36:19,160 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-6] INFO  org.apache.flink.runtime.resourcemanager.slotmanager.DeclarativeSlotManager [] - Received resource requirements from job 1deff4638a055a66c9a19fffcea6c44f: [ResourceRequirement{resourceProfile=ResourceProfile{UNKNOWN}, numberOfRequiredSlots=1}]
22:36:19,186 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-5] INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;-1 (1/1) (49a2e08ca4abb6aaf844475a0fbfdb21) switched from CANCELING to CANCELED.
22:36:19,194 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-6] INFO  org.apache.flink.runtime.resourcemanager.slotmanager.DeclarativeSlotManager [] - Clearing resource requirements of job 1deff4638a055a66c9a19fffcea6c44f
22:36:20,085 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-5] INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - No checkpoint found during restore.
22:36:20,085 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-5] INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Resetting the Operator Coordinators to an empty state.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That trips another assertion in the coordinator code (which could be removed), but I think it does indeed seem strange that this happens.&lt;br/&gt;
I am wondering if there isn&apos;t a bug in the scheduler that it gets inconsistent when dealing with multiple concurrent global failures. Or will it simply restore the state twice (once to the cancelled attempts, once again to the recovered attempts)?&lt;/p&gt;

&lt;p&gt;In this test run, the problem occurs in multiple profiles:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/sewen0794/Flink/_build/results?buildId=291&amp;amp;view=logs&amp;amp;j=9dc1b5dc-bcfa-5f83-eaa7-0cb181ddc267&amp;amp;t=ab910030-93db-52a7-74a3-34a0addb481b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/sewen0794/Flink/_build/results?buildId=291&amp;amp;view=logs&amp;amp;j=9dc1b5dc-bcfa-5f83-eaa7-0cb181ddc267&amp;amp;t=ab910030-93db-52a7-74a3-34a0addb481b&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17327220" author="dawidwys" created="Thu, 22 Apr 2021 09:50:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16996&amp;amp;view=logs&amp;amp;j=0e7be18f-84f2-53f0-a32d-4a5e4a174679&amp;amp;t=7030a106-e977-5851-a05e-535de648c9c9&amp;amp;l=11498&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16996&amp;amp;view=logs&amp;amp;j=0e7be18f-84f2-53f0-a32d-4a5e4a174679&amp;amp;t=7030a106-e977-5851-a05e-535de648c9c9&amp;amp;l=11498&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17327225" author="stephanewen" created="Thu, 22 Apr 2021 09:52:17 +0000"  >&lt;p&gt;Fixed in&lt;/p&gt;

&lt;p&gt;1.14.0 (master) via&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;02e7db875920b34099cfb570089da20da6a88cb1&lt;/li&gt;
	&lt;li&gt;e3cfa40bf67def24d4b528055bb479298241764d&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;1.13.0 (release-1.13) via&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;41f013db8605ce47cbc9b1e7b69c3cb0359873ef&lt;/li&gt;
	&lt;li&gt;9400f880699d38eb065917ba6e9f13ef5632654f&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;1.12.3 (release-1.12) via&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;13160bb001849bd4d487f024972bf4091e82a8e6&lt;/li&gt;
	&lt;li&gt;a555c396167118c5f3510a09dadb3540d9ab773f&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17327235" author="stephanewen" created="Thu, 22 Apr 2021 09:56:12 +0000"  >&lt;p&gt;After a discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, we concluded the following:&lt;/p&gt;

&lt;p&gt;The situation where restores happen to the old (canceled/failed) execution attempts can happen right now, in the presence of overlapping global failures.&lt;/p&gt;

&lt;p&gt;That is not ideal, but it is also not a big problem, because there will be another restore to the new execution attempts later.&lt;br/&gt;
So the effect of this corner case is mainly some extra work in the CheckpointCoordinator to assign state to tasks twice, and extra work in the OperatorCoordinator to execute the &lt;tt&gt;resetToCheckpoint()&lt;/tt&gt; twice.&lt;/p&gt;

&lt;p&gt;So we fix this for now by removing the assertions that guarded against this situation and catch the case in the &lt;tt&gt;OperatorCoordinatorHolder&lt;/tt&gt; to avoid calling &lt;tt&gt;subtaskReset()&lt;/tt&gt; on restore for outdated execution attempts. &lt;/p&gt;</comment>
                            <comment id="17329941" author="maguowei" created="Fri, 23 Apr 2021 02:52:56 +0000"  >&lt;p&gt;The case failed in the master branch after the fixes merged&lt;br/&gt;
&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=17077&amp;amp;view=logs&amp;amp;j=0e7be18f-84f2-53f0-a32d-4a5e4a174679&amp;amp;t=7030a106-e977-5851-a05e-535de648c9c9&amp;amp;l=11113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=17077&amp;amp;view=logs&amp;amp;j=0e7be18f-84f2-53f0-a32d-4a5e4a174679&amp;amp;t=7030a106-e977-5851-a05e-535de648c9c9&amp;amp;l=11113&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17330042" author="dawidwys" created="Fri, 23 Apr 2021 06:53:44 +0000"  >&lt;p&gt;I checked logs and it seems somehow the test goes into an infinite loop of restarts. A weird thing about it is that the job somehow gets cancelled...&lt;/p&gt;

&lt;p&gt;The job is always being cancelled right after triggering the first checkpoint..&lt;/p&gt;</comment>
                            <comment id="17330069" author="dawidwys" created="Fri, 23 Apr 2021 07:39:35 +0000"  >&lt;p&gt;I can actually reproduce this locally. This happens only when using the adaptive scheduler. You can reproduce the issue if you extend the MiniCluster configuration:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @BeforeClass
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void startMiniCluster() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Configuration config = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration();
        config.setString(RestOptions.BIND_PORT, &lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;);
        config.set(JobManagerOptions.SCHEDULER, JobManagerOptions.SchedulerType.Adaptive);
        config.set(ClusterOptions.ENABLE_DECLARATIVE_RESOURCE_MANAGEMENT, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17330129" author="till.rohrmann" created="Fri, 23 Apr 2021 08:14:03 +0000"  >&lt;p&gt;I will try to take a look at the problem.&lt;/p&gt;</comment>
                            <comment id="17330144" author="dawidwys" created="Fri, 23 Apr 2021 08:18:03 +0000"  >&lt;p&gt;I figured out the problem. Will give an update shortly.&lt;/p&gt;</comment>
                            <comment id="17330164" author="dawidwys" created="Fri, 23 Apr 2021 08:23:16 +0000"  >&lt;p&gt;The problem is in the test. The &lt;tt&gt;EventSendingCoordinator&lt;/tt&gt; uses a field &lt;tt&gt;failedBefore&lt;/tt&gt; to check if it should throw an exception or not. This works under the assumption that an instance of the coordinator is created only once and survives restarts. That is not the case for the &lt;tt&gt;AdaptiveScheduler&lt;/tt&gt;, which recreates the whole &lt;tt&gt;ExecutionGraph&lt;/tt&gt; and creates a new coordinator with the &lt;tt&gt;failedBefore&lt;/tt&gt; flag reset. Therefore we fail indefinitely.&lt;/p&gt;</comment>
                            <comment id="17330178" author="dawidwys" created="Fri, 23 Apr 2021 08:31:29 +0000"  >&lt;p&gt;Or is it actually a production grade problem? Is it the contract of the &lt;tt&gt;OperatorCoordinator&lt;/tt&gt; that it survives global failovers? Even with exceptions from the coordinator itself?&lt;/p&gt;</comment>
                            <comment id="17330393" author="stephanewen" created="Fri, 23 Apr 2021 11:16:51 +0000"  >&lt;p&gt;There is no contract that the coordinator needs to survives global failures. Master re-election for example also re-created the coordinator.&lt;/p&gt;

&lt;p&gt;This is just a specific behavior of this test, to cache the status to run the script of the testing scenario.&lt;br/&gt;
And indeed, such tests that test not contracts but script scenarios are sensitive to implementation changes, that&apos;s why they should be rare.&lt;/p&gt;

&lt;p&gt;I&apos;ll create a patch for the test...&lt;/p&gt;</comment>
                            <comment id="17330845" author="stephanewen" created="Fri, 23 Apr 2021 15:06:54 +0000"  >&lt;p&gt;Small Update: The fact that the job looked to be cancelling after the first checkpoint is missing logging. There is a global failure that triggers the cancellation, which is not logged. That issue is tracked in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22431&quot; title=&quot;AdaptiveScheduler does not log failure cause when recovering&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22431&quot;&gt;&lt;del&gt;FLINK-22431&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="17330854" author="stephanewen" created="Fri, 23 Apr 2021 15:20:00 +0000"  >&lt;p&gt;Tracking the new issue under &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22433&quot; title=&quot;CoordinatorEventsExactlyOnceITCase stalls on Adaptive Scheduler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22433&quot;&gt;&lt;del&gt;FLINK-22433&lt;/del&gt;&lt;/a&gt;, because it is a different problem.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13367996">FLINK-21996</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13024409" name="screenshot-1.png" size="18265" author="sewen" created="Wed, 21 Apr 2021 20:58:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0q6mo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>