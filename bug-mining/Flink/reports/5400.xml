<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:57:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-17170] Cannot stop streaming job with savepoint which uses kinesis consumer</title>
                <link>https://issues.apache.org/jira/browse/FLINK-17170</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I am encountering a very strange situation where I can&apos;t stop with savepoint a streaming job.&lt;/p&gt;

&lt;p&gt;The job reads from kinesis and sinks to S3, very simple job, no mapping function, no watermarks, just source-&amp;gt;sink.&#160;&lt;/p&gt;

&lt;p&gt;Source is using flink-kinesis-consumer, sink is using StreamingFileSink.&#160;&lt;/p&gt;

&lt;p&gt;Everything works fine, except stopping the job with savepoints.&lt;/p&gt;

&lt;p&gt;The behaviour happens only when multiple task managers are involved, having sub-tasks off the job spread across multiple task manager instances. When a single task manager has all the sub-tasks this issue never occurred.&lt;/p&gt;

&lt;p&gt;Using latest Flink 1.10.0 version, deployment done in HA mode (2 job managers), in EC2, savepoints and checkpoints written on S3.&lt;/p&gt;

&lt;p&gt;When trying to stop, the savepoint is created correctly and appears on S3, but not all sub-tasks are stopped. Some of them finished, but some just remain hanged. Sometimes, on the same task manager part of the sub-tasks are finished, part aren&apos;t.&lt;/p&gt;

&lt;p&gt;The logs don&apos;t show any errors. For the ones that succeed, the standard messages appear, with &quot;Source: &amp;lt;....&amp;gt;&#160;switched from RUNNING to FINISHED&quot;.&lt;/p&gt;

&lt;p&gt;For the sub-tasks hanged the last message is &quot;org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher - Shutting down the shard consumer threads of subtask 0 ...&quot; and that&apos;s it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I tried using the cli (flink stop &amp;lt;job_id&amp;gt;)&lt;/p&gt;

&lt;p&gt;Timeout Message:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
root@ec2-XX-XX-XX-XX:/opt/flink/current/bin# ./flink stop cf43cecd9339e8f02a12333e52966a25
root@ec2-XX-XX-XX-XX:/opt/flink/current/bin# ./flink stop cf43cecd9339e8f02a12333e52966a25Suspending job &lt;span class=&quot;code-quote&quot;&gt;&quot;cf43cecd9339e8f02a12333e52966a25&quot;&lt;/span&gt; with a savepoint. ------------------------------------------------------------&#160;The program finished with the following exception: org.apache.flink.util.FlinkException: Could not stop with a savepoint job &lt;span class=&quot;code-quote&quot;&gt;&quot;cf43cecd9339e8f02a12333e52966a25&quot;&lt;/span&gt;. at org.apache.flink.client.cli.CliFrontend.lambda$stop$5(CliFrontend.java:462) at org.apache.flink.client.cli.CliFrontend.runClusterAction(CliFrontend.java:843) at org.apache.flink.client.cli.CliFrontend.stop(CliFrontend.java:454) at org.apache.flink.client.cli.CliFrontend.parseParameters(CliFrontend.java:907) at org.apache.flink.client.cli.CliFrontend.lambda$main$10(CliFrontend.java:968) at java.security.AccessController.doPrivileged(Native Method) at javax.security.auth.Subject.doAs(Subject.java:422) at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1682) at org.apache.flink.runtime.security.HadoopSecurityContext.runSecured(HadoopSecurityContext.java:41) at org.apache.flink.client.cli.CliFrontend.main(CliFrontend.java:968)Caused by: java.util.concurrent.TimeoutException at java.util.concurrent.CompletableFuture.timedGet(CompletableFuture.java:1784) at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1928) at org.apache.flink.client.cli.CliFrontend.lambda$stop$5(CliFrontend.java:460) ... 9 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Using the monitoring api, I keep getting infinite message when querying based on the savepoint id, that the status id is still &quot;IN_PROGRESS&quot;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When performing a cancel instead of stop, it works. But cancel is deprecated, so I am a bit concerned that this might fail also, maybe I was just lucky.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I attached a screenshot with what the UI is showing when this happens&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13298599">FLINK-17170</key>
            <summary>Cannot stop streaming job with savepoint which uses kinesis consumer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arvid">Arvid Heise</assignee>
                                    <reporter username="cvasii">Vasii Cosmin Radu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>usability</label>
                    </labels>
                <created>Wed, 15 Apr 2020 15:25:01 +0000</created>
                <updated>Sat, 28 Aug 2021 11:18:53 +0000</updated>
                            <resolved>Sun, 9 May 2021 17:49:15 +0000</resolved>
                                    <version>1.10.0</version>
                    <version>1.11.3</version>
                    <version>1.12.2</version>
                                    <fixVersion>1.14.0</fixVersion>
                    <fixVersion>1.13.1</fixVersion>
                    <fixVersion>1.12.4</fixVersion>
                                    <component>API / DataStream</component>
                    <component>Connectors / Kinesis</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="17084230" author="yunta" created="Wed, 15 Apr 2020 16:33:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cvasii&quot; class=&quot;user-hover&quot; rel=&quot;cvasii&quot;&gt;cvasii&lt;/a&gt; Has the savepoint completed via the web UI? Did the sub-task checkpoint on those hanged task finished? (You could get the information via the web UI of checkpoint details). And the quickest solution to detect the root cause is using jstack to capture what the task thread is doing when it is hanged.&lt;/p&gt;</comment>
                            <comment id="17084235" author="cvasii" created="Wed, 15 Apr 2020 16:46:57 +0000"  >&lt;p&gt;I was doing that. And the shard consumer threads are blocked. Looks like it&apos;s the checkpointLock they are all waiting on.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here is a sample of one stack:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
shardConsumers-Source: source&amp;lt;my_name&amp;gt; -&amp;gt; Sink: sink-s3a:&lt;span class=&quot;code-comment&quot;&gt;//&amp;lt;my_path&amp;gt; (12/12)-thread-0priority:5 - threadId:0x00007f565c854000 - nativeId:0x49e0 - nativeId (decimal):18912 - state:BLOCKED
&lt;/span&gt;stackTrace:
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED (on object monitor)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher.emitRecordAndUpdateState(KinesisDataFetcher.java:774)
- waiting to lock &amp;lt;0x00000006a4d18620&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher.access$000(KinesisDataFetcher.java:92)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher$AsyncKinesisRecordEmitter.emit(KinesisDataFetcher.java:273)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher$SyncKinesisRecordEmitter$1.put(KinesisDataFetcher.java:288)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher$SyncKinesisRecordEmitter$1.put(KinesisDataFetcher.java:285)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher.emitRecordAndUpdateState(KinesisDataFetcher.java:760)
at org.apache.flink.streaming.connectors.kinesis.internals.ShardConsumer.deserializeRecordForCollectionAndUpdateState(ShardConsumer.java:371)
at org.apache.flink.streaming.connectors.kinesis.internals.ShardConsumer.run(ShardConsumer.java:258)
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
at java.util.concurrent.FutureTask.run(FutureTask.java:266)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17084238" author="cvasii" created="Wed, 15 Apr 2020 16:49:18 +0000"  >&lt;p&gt;And regarding the savepoint, yes it finished successfully on all sub-tasks.&lt;/p&gt;</comment>
                            <comment id="17084258" author="cvasii" created="Wed, 15 Apr 2020 17:20:41 +0000"  >&lt;p&gt;It&apos;s quite hard to debug, because I have multiple threads with the same name blocked on the same lock. A sub-tasks consumes multiple shards, so a fetcher per subtask is created, but the method KinesisDataFetcher#createShardConsumersThreadPool just allocates the same identifier for the threads (any ThreadFactory implementation is better there by the way, a thing to improve).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;There is also one blocked thread which is single, not competing with others for any lock.&#160;&lt;/p&gt;</comment>
                            <comment id="17084274" author="yunta" created="Wed, 15 Apr 2020 17:40:25 +0000"  >&lt;p&gt;If the savepoint could finally complete, I doubt the task stuck when notified checkpoint complete to &lt;a href=&quot;https://github.com/apache/flink/blob/9ed5f1b4b5e1c8a9f9421b91ac00960b63916ebd/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java#L930&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;finish&lt;/a&gt;. Could you share the information of source stream task or the whole jstack info of the hanged JVM? BTW, debug level info logs could also help to know more information.&lt;/p&gt;</comment>
                            <comment id="17084492" author="klion26" created="Thu, 16 Apr 2020 02:34:45 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cvasii&quot; class=&quot;user-hover&quot; rel=&quot;cvasii&quot;&gt;cvasii&lt;/a&gt;&#160;from the description, seems the savepoint successfully, and &quot;unfinished&quot; task was blocked by something.&lt;/p&gt;

&lt;p&gt;Currently, the lifetime of task logic is &quot;trigger savepoint&quot; -&amp;gt; &quot;savepoint complete&quot; -&amp;gt; &quot;savepoint complete&quot; -&amp;gt; &quot;finish task&quot;&lt;/p&gt;

&lt;p&gt;From the previous comments you given, seems the stack was waiting for some lock, could you please check what is it waiting for?&lt;/p&gt;

&lt;p&gt;or could you please share the whole jstack message about the &quot;unfinished&quot; task.&lt;/p&gt;</comment>
                            <comment id="17084591" author="cvasii" created="Thu, 16 Apr 2020 06:57:23 +0000"  >&lt;p&gt;Thanks guys for looking into this, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=klion26&quot; class=&quot;user-hover&quot; rel=&quot;klion26&quot;&gt;klion26&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;&#160;I&apos;ve attached a full thread dump from one of the task managers, file called &quot;threaddump_tm1&quot;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve seen that shard consumers are waiting for the checkpoint lock, but the checkpoint lock it&apos;s already taken by the thread which performs the stop.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Some relevant parts of the thread dump&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
shardConsumers-Source: source -&amp;gt; Sink: sink (12/12)-thread-0priority:5 - threadId:0x00007f7c7c298000 - nativeId:0x774c - nativeId (decimal):30540 - state:BLOCKED
stackTrace:
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED (on object monitor)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher.emitRecordAndUpdateState(KinesisDataFetcher.java:774)
- waiting to lock &amp;lt;0x00000007abe026c8&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher.access$000(KinesisDataFetcher.java:92)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher$AsyncKinesisRecordEmitter.emit(KinesisDataFetcher.java:273)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher$SyncKinesisRecordEmitter$1.put(KinesisDataFetcher.java:288)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher$SyncKinesisRecordEmitter$1.put(KinesisDataFetcher.java:285)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher.emitRecordAndUpdateState(KinesisDataFetcher.java:760)
at org.apache.flink.streaming.connectors.kinesis.internals.ShardConsumer.deserializeRecordForCollectionAndUpdateState(ShardConsumer.java:371)
at org.apache.flink.streaming.connectors.kinesis.internals.ShardConsumer.run(ShardConsumer.java:258)
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
at java.util.concurrent.FutureTask.run(FutureTask.java:266)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;but the lock&#160;0x00000007abe026c8 it&apos;s already taken here&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Source: source -&amp;gt; Sink: sink (12/12)priority:5 - threadId:0x00007f7c2c0cf000 - nativeId:0x76fe - nativeId (decimal):30462 - state:TIMED_WAITING
stackTrace:
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (parking)
at sun.misc.Unsafe.park(Native Method)
- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000007ac041158&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)
at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2078)
at java.util.concurrent.ThreadPoolExecutor.awaitTermination(ThreadPoolExecutor.java:1475)
at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher.awaitTermination(KinesisDataFetcher.java:637)
at org.apache.flink.streaming.connectors.kinesis.FlinkKinesisConsumer.cancel(FlinkKinesisConsumer.java:365)
at org.apache.flink.streaming.api.operators.StreamSource.cancel(StreamSource.java:147)
at org.apache.flink.streaming.runtime.tasks.SourceStreamTask.cancelTask(SourceStreamTask.java:136)
at org.apache.flink.streaming.runtime.tasks.SourceStreamTask.finishTask(SourceStreamTask.java:147)
at org.apache.flink.streaming.runtime.tasks.StreamTask.notifyCheckpointComplete(StreamTask.java:947)
at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$notifyCheckpointCompleteAsync$7(StreamTask.java:924)
at org.apache.flink.streaming.runtime.tasks.StreamTask$$Lambda$838/1354138988.run(Unknown Source)
at org.apache.flink.util.function.FunctionUtils.lambda$asCallable$5(FunctionUtils.java:125)
at org.apache.flink.util.function.FunctionUtils$$Lambda$839/1349808364.call(Unknown Source)
at java.util.concurrent.FutureTask.run(FutureTask.java:266)
at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$SynchronizedStreamTaskActionExecutor.run(StreamTaskActionExecutor.java:87)
- locked &amp;lt;0x00000007abe026c8&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
at org.apache.flink.streaming.runtime.tasks.mailbox.Mail.run(Mail.java:78)
at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.processMail(MailboxProcessor.java:261)
at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:186)
at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:487)
at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:470)
at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:707)
at org.apache.flink.runtime.taskmanager.Task.run(Task.java:532)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So, FlinkKinesisConsumer#close() method is called, which delegates to&#160;FlinkKinesisConsumer#cancel(), then KinesisDataFetcher#shutdownFetcher() is called and as it seems it executes successfully, cause I don&apos;t &#160;have any errrors in the logs. If there would have been an exception, the message from FlinkKinesisConsumer line 367&#160;&quot;Error while closing Kinesis data fetcher&quot; would have been in my logs. Then fetcher.awaitTermination() is called, and in KinesisDataFetcher#awaitTermination it waits, for 1 minute. But there isn&apos;t any Thread.&lt;em&gt;setDefaultUncaughtExceptionHandler&lt;/em&gt; set, so if there&apos;s an exception in the&#160;shardConsumersExecutor, I can&apos;t really see it. Side question: can I set the UncaughtExceptionHandler somehow?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For me it is quite obvious that the&#160;shardConsumersExecutor is not shutdown and based on my JDK knowledge, calling shutdownNow on an executor service does not guarantee that it will actually terminate. And since multiple threads are competing for the checkpoint lock, I guess the threads from the&#160;shardConsumersExecutor must be interrupted. How come it works when doing a cancel? Is there a forced interrupt being done?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17084770" author="yunta" created="Thu, 16 Apr 2020 11:06:36 +0000"  >&lt;p&gt;I could reproduce this with a batch lines of code. There existed a dead lock here: one thread is waiting to get the lock, while the other thread which holds the lock is waiting for the previous thread to terminate.&lt;/p&gt;

&lt;p&gt;I still need some time to investigate this to see whether there existed more possible dead locks there.&lt;/p&gt;</comment>
                            <comment id="17084872" author="yunta" created="Thu, 16 Apr 2020 13:32:55 +0000"  >&lt;p&gt;I think there might be three solutions:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Use new source operator API which introduced in FLIP-27 to avoid the checkpoint lock with mailbox when emitting records in source thread. However, I think new source operator API is not fully ready now.&lt;/li&gt;
	&lt;li&gt;Avoid the endless awaitTermination when &lt;tt&gt;shutdownFetcher&lt;/tt&gt;, I am not sure whether this could meet kinesis requests, cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Check whether this fetcher is running within &lt;tt&gt;emitRecordAndUpdateState&lt;/tt&gt; first before try to access the &lt;tt&gt;checkpointLock&lt;/tt&gt;. If not running, just return instead of access the  &lt;tt&gt;checkpointLock&lt;/tt&gt;. I think this could resolve this problem.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17085127" author="cvasii" created="Thu, 16 Apr 2020 17:53:42 +0000"  >&lt;p&gt;How come it works when I perform a cancel, instead of stop action?&lt;/p&gt;</comment>
                            <comment id="17085626" author="yunta" created="Fri, 17 Apr 2020 10:26:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cvasii&quot; class=&quot;user-hover&quot; rel=&quot;cvasii&quot;&gt;cvasii&lt;/a&gt; cancel job does not need to trigger a savepoint before shutdown. In other words, cancel would not trigger &quot;notifyCheckpoitComplete&quot; on task side once the checkpoint is completed on checkpoint coordinator side. When we call &quot;notifyCheckpoitComplete&quot;, it will grab the lock which would also be grabbed when await termination of kinesis fetcher.&lt;/p&gt;</comment>
                            <comment id="17138349" author="ubyyj" created="Wed, 17 Jun 2020 11:20:47 +0000"  >&lt;p&gt;any update on this?&lt;/p&gt;

&lt;p&gt;I hit the exactly same issue here, with 1.10.1.&lt;/p&gt;

&lt;p&gt;BTW, call the savepoint rest api can trigger savepoint and as well cancel the job.&lt;/p&gt;

&lt;p&gt;something like this:&lt;/p&gt;

&lt;p&gt;curl -d &apos;{&quot;target-directory&quot;: &quot;s3://dp-flink/savepoints/&quot;,&quot;cancel-job&quot;:true}&apos; :jobmanagerTracking-URL&lt;a href=&quot;http://ip-10-0-102-40.ap-northeast-1.compute.internal:41581/jobs/6b1f193a0a2e98a6eabf6fe6d876c3bc/savepoints&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;/jobs/:jobid/savepoints&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17233564" author="qinjunjerry" created="Tue, 17 Nov 2020 12:57:50 +0000"  >&lt;p&gt;I also see the exact same behavior happened to one customer with just one TM and parallelism=1. &#160;By &apos;exact&apos;, I mean&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the source thread is holding the checkpoint lock, and is waiting for the shardConsumers to finish,&#160;but the shardConsumers cannot finish because they are waiting to lock the checkpoint lock&lt;/li&gt;
	&lt;li&gt;the code line numbers in the stack trace is same as the one attached there.&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17235700" author="qinjunjerry" created="Thu, 19 Nov 2020 19:41:28 +0000"  >&lt;p&gt;The source thread holds the checkpoint lock and is waiting here forever for the shardConsumers thread to finish, while the&#160;shardConsumers can only finish once they get the checkpoint lock:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// From: KinesisDataFetcher.java
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void awaitTermination() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
   &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!shardConsumersExecutor.awaitTermination(1, TimeUnit.MINUTES)) {
      &lt;span class=&quot;code-comment&quot;&gt;// Keep waiting.
&lt;/span&gt;   }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17237081" author="yunta" created="Mon, 23 Nov 2020 03:03:52 +0000"  >&lt;p&gt;I think my previous suggestion of &quot;Check whether this fetcher is running within emitRecordAndUpdateState first before try to access the checkpointLock&quot; might not solve the problem fundamentally if &lt;tt&gt;running&lt;/tt&gt; has been set as false while &lt;tt&gt;checkpointLock&lt;/tt&gt; has been synchronized in the main thread. Shall the endless await termination is a must be for kinesis fetcher &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17281338" author="mapohl" created="Mon, 8 Feb 2021 20:04:21 +0000"  >&lt;p&gt;We&apos;re investigating a bug with stop-with-savepoint where the savepoint is successfully created but the job does not finish due to some failure after savepoint creation. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-21030&quot; title=&quot;Broken job restart for job with disjoint graph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-21030&quot;&gt;&lt;del&gt;FLINK-21030&lt;/del&gt;&lt;/a&gt; for further details. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17170&quot; title=&quot;Cannot stop streaming job with savepoint which uses kinesis consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17170&quot;&gt;&lt;del&gt;FLINK-17170&lt;/del&gt;&lt;/a&gt; might be related.&lt;/p&gt;</comment>
                            <comment id="17281491" author="kezhuw" created="Tue, 9 Feb 2021 02:40:52 +0000"  >&lt;p&gt;I think it is problem of &lt;tt&gt;FlinkKinesisConsumer.cancel&lt;/tt&gt;, it should not await fetcher to finished, it should do only signalling.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qinjunjerry&quot; class=&quot;user-hover&quot; rel=&quot;qinjunjerry&quot;&gt;qinjunjerry&lt;/a&gt; is correct about the deadlock. In stop-with-savepoint path, &lt;tt&gt;FlinkKinesisConsumer.cancel&lt;/tt&gt; is called with &lt;tt&gt;checkpointLock&lt;/tt&gt; hold.&lt;/p&gt;</comment>
                            <comment id="17281492" author="kezhuw" created="Tue, 9 Feb 2021 02:57:43 +0000"  >&lt;blockquote&gt;
&lt;p&gt;In stop-with-savepoint path, &lt;tt&gt;FlinkKinesisConsumer.cancel&lt;/tt&gt; is called with &lt;tt&gt;checkpointLock&lt;/tt&gt; hold.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This holds after 1.10, so this issue should exist in all versions after 1.10.&lt;/p&gt;</comment>
                            <comment id="17329045" author="flink-jira-bot" created="Thu, 22 Apr 2021 12:26:49 +0000"  >&lt;p&gt;This critical issue is unassigned and itself and all of its Sub-Tasks have not been updated for 7 days. So, it has been labeled &quot;stale-critical&quot;. If this ticket is indeed critical, please either assign yourself or give an update. Afterwards, please remove the label. In 7 days the issue will be deprioritized.&lt;/p&gt;</comment>
                            <comment id="17335794" author="dannycranmer" created="Thu, 29 Apr 2021 19:49:24 +0000"  >&lt;p&gt;I have taken a read through the issue/code and agree with the diagnosed deadlock. I agree that removing &lt;tt&gt;fetcher.awaitTermination()&lt;/tt&gt; from &lt;tt&gt;FlinkKinesisConsumer::cancel&lt;/tt&gt; will fix the deadlock. However this would potentially result in the job transitioning to finished with open resources. The expectation would be that the resources will terminate, but this could still result in temporary leak/dangling objects on the TM. &lt;/p&gt;

&lt;p&gt;I believe we can fix this by moving the &lt;tt&gt;fetcher.awaitTermination()&lt;/tt&gt; to the &lt;a href=&quot;https://github.com/apache/flink/blob/9ed5f1b4b5e1c8a9f9421b91ac00960b63916ebd/flink-connectors/flink-connector-kinesis/src/main/java/org/apache/flink/streaming/connectors/kinesis/FlinkKinesisConsumer.java#L373&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;close()&lt;/a&gt; method. I have taken a quick dive and it looks like this would be called outside of the checkpoint lock. However I am not 100% sure this would be ok for all Source lifecycle possibilities. Does anyone have any reason to believe this is not a good idea?&lt;/p&gt;</comment>
                            <comment id="17337132" author="arvid" created="Fri, 30 Apr 2021 06:19:48 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dannycranmer&quot; class=&quot;user-hover&quot; rel=&quot;dannycranmer&quot;&gt;dannycranmer&lt;/a&gt; , why do we need to have this{{ fetcher.awaitTermination()}} in cancel/close in the first place? Wouldn&apos;t it suffice to just rely on the await at the end of &lt;tt&gt;FlinkKinesisConsumer#run&lt;/tt&gt;? As far as I can see, the &lt;tt&gt;cancel&lt;/tt&gt; is shutting down the fetcher, so it should return in a graceful manner in &lt;tt&gt;run&lt;/tt&gt;. Going further, &lt;tt&gt;runFetcher&lt;/tt&gt; is already invoking&#160;&lt;tt&gt;awaitTermination&lt;/tt&gt; on its own, so we could clean this up even further.&lt;/p&gt;</comment>
                            <comment id="17337299" author="pnowojski" created="Fri, 30 Apr 2021 11:11:57 +0000"  >&lt;p&gt;I also think sources shouldn&apos;t be doing blocking waits on such conditions inside &lt;tt&gt;cancel()&lt;/tt&gt;. Basically what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dannycranmer&quot; class=&quot;user-hover&quot; rel=&quot;dannycranmer&quot;&gt;dannycranmer&lt;/a&gt; suggested makes sense.&lt;/p&gt;

&lt;p&gt;edit:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Hi Danny Cranmer , why do we need to have this{{ fetcher.awaitTermination()}} in cancel/close in the first place? Wouldn&apos;t it suffice to just rely on the await at the end of FlinkKinesisConsumer#run? As far as I can see, the cancel is shutting down the fetcher, so it should return in a graceful manner in run. Going further, runFetcher is already invoking awaitTermination on its own, so we could clean this up even further.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt; &lt;tt&gt;FlinkKinesisConsumer#run&lt;/tt&gt; can be interrupted, and that&apos;s expected behaviour. &lt;tt&gt;close&lt;/tt&gt; should guarantee that all resources are cleaned up. If resource cleaning up is not possible, it&apos;s better for &lt;tt&gt;close&lt;/tt&gt; to hang until task&apos;s cancellation times outs, and whole Task Manager is killed.&lt;/p&gt;</comment>
                            <comment id="17340239" author="arvid" created="Thu, 6 May 2021 14:14:06 +0000"  >&lt;p&gt;Merged into 1.12 as 1de3d6345a4132dda4b31f66275fb732afe3ef30.&lt;/p&gt;</comment>
                            <comment id="17340890" author="arvid" created="Fri, 7 May 2021 15:26:09 +0000"  >&lt;p&gt;Merged into 1.13 as a102549f08759e177074dad286fef2f56176d005..282f9a3d5505a5aa58d7d9cca466939610d41ed3.&lt;/p&gt;</comment>
                            <comment id="17341570" author="arvid" created="Sun, 9 May 2021 17:48:56 +0000"  >&lt;p&gt;Merged into master as 442dc76bc76b9a7628202b33b21126ef3d48a90c..49d9092b31d0a95d727b790ee04a4ed8d72924e3.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13353254">FLINK-21030</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13000028" name="Screenshot 2020-04-15 at 18.16.26.png" size="36017" author="cvasii" created="Wed, 15 Apr 2020 15:25:37 +0000"/>
                            <attachment id="13000099" name="threaddump_tm1" size="91358" author="cvasii" created="Thu, 16 Apr 2020 06:14:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 27 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0do60:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>