<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19741] InternalTimeServiceManager fails to restore due to corrupt reads if there are other users of raw keyed state streams</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19741</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Diagnosis&quot;&gt;&lt;/a&gt;&lt;b&gt;Diagnosis&lt;/b&gt;&lt;/h2&gt;

&lt;p&gt;Currently, when restoring a &lt;tt&gt;InternalTimeServiceManager&lt;/tt&gt;, we always attempt to read from the provided raw keyed state streams (using &lt;tt&gt;InternalTimerServiceSerializationProxy&lt;/tt&gt;):&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/InternalTimeServiceManagerImpl.java#L117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/InternalTimeServiceManagerImpl.java#L117&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is incorrect, since we don&apos;t write with the &lt;tt&gt;InternalTimerServiceSerializationProxy&lt;/tt&gt; if the timers do not require legacy synchronous snapshots:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/InternalTimeServiceManagerImpl.java#L192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/InternalTimeServiceManagerImpl.java#L192&lt;/a&gt;&lt;br/&gt;
(we currently only require that when users use RocksDB backend + heap timers).&lt;/p&gt;

&lt;p&gt;Therefore, the &lt;tt&gt;InternalTimeServiceManager&lt;/tt&gt; can fail to be created on restore due to corrupt reads in the case where:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;a checkpoint was taken where &lt;tt&gt;useLegacySynchronousSnapshots&lt;/tt&gt; is false (hence nothing was written, and the time service manager does not use the raw keyed stream)&lt;/li&gt;
	&lt;li&gt;the raw keyed stream is used elsewhere (e.g. in the Flink application&apos;s user code)&lt;/li&gt;
	&lt;li&gt;on restore from the checkpoint, &lt;tt&gt;InternalTimeServiceManagerImpl.create()&lt;/tt&gt; attempts to read from the raw keyed stream with the &lt;tt&gt;InternalTimerServiceSerializationProxy&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Full error stack trace (with Flink 1.11.1):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-10-21 13:16:51
java.lang.Exception: Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; creating StreamOperatorStateContext.
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:204)
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:247)
	at org.apache.flink.streaming.runtime.tasks.OperatorChain.initializeStateAndOpenOperators(OperatorChain.java:290)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$beforeInvoke$0(StreamTask.java:479)
	at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.runThrowing(StreamTaskActionExecutor.java:47)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.beforeInvoke(StreamTask.java:475)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:528)
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:721)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:546)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.io.EOFException
	at java.io.DataInputStream.readFully(DataInputStream.java:197)
	at java.io.DataInputStream.readUTF(DataInputStream.java:609)
	at java.io.DataInputStream.readUTF(DataInputStream.java:564)
	at org.apache.flink.streaming.api.operators.InternalTimerServiceSerializationProxy.read(InternalTimerServiceSerializationProxy.java:110)
	at org.apache.flink.core.io.PostVersionedIOReadableWritable.read(PostVersionedIOReadableWritable.java:76)
	at org.apache.flink.streaming.api.operators.InternalTimeServiceManager.restoreStateForKeyGroup(InternalTimeServiceManager.java:217)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.internalTimeServiceManager(StreamTaskStateInitializerImpl.java:234)
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:167)
	... 9 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h2&gt;&lt;a name=&quot;Reproducing&quot;&gt;&lt;/a&gt;&lt;b&gt;Reproducing&lt;/b&gt;&lt;/h2&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Have an application with any operator that uses and writes to raw keyed state streams&lt;/li&gt;
	&lt;li&gt;Use heap backend + any timer factory or RocksDB backend + RocksDB timers&lt;/li&gt;
	&lt;li&gt;Take a savepoint or wait for a checkpoint, and trigger a restore&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;&lt;a name=&quot;ProposedFix&quot;&gt;&lt;/a&gt;&lt;b&gt;Proposed Fix&lt;/b&gt;&lt;/h2&gt;

&lt;p&gt;The fix would be to also respect the &lt;tt&gt;useLegacySynchronousSnapshots&lt;/tt&gt; flag in:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/InternalTimeServiceManagerImpl.java#L231&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/operators/InternalTimeServiceManagerImpl.java#L231&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13336336">FLINK-19741</key>
            <summary>InternalTimeServiceManager fails to restore due to corrupt reads if there are other users of raw keyed state streams</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tzulitai">Tzu-Li (Gordon) Tai</assignee>
                                    <reporter username="tzulitai">Tzu-Li (Gordon) Tai</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 20 Oct 2020 16:29:41 +0000</created>
                <updated>Mon, 6 Sep 2021 09:55:01 +0000</updated>
                            <resolved>Sat, 7 Nov 2020 02:30:47 +0000</resolved>
                                    <version>1.9.3</version>
                    <version>1.10.2</version>
                    <version>1.11.2</version>
                                    <fixVersion>1.11.3</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17226791" author="rmetzger" created="Thu, 5 Nov 2020 16:00:25 +0000"  >&lt;p&gt;Is this blocker expected to be merged before the feature freeze on Sunday?&lt;br/&gt;
It seems that the PR got approval already?&lt;/p&gt;</comment>
                            <comment id="17227114" author="tzulitai" created="Fri, 6 Nov 2020 02:23:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt; yes, I&apos;m running some last tests against StateFun to ensure that this works properly.&lt;br/&gt;
I have on my backlog to make sure this gets merged by end of week. Same for &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19748&quot; title=&quot;KeyGroupRangeOffsets#KeyGroupOffsetsIterator should skip key groups that don&amp;#39;t have a defined offset&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19748&quot;&gt;&lt;del&gt;FLINK-19748&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17227364" author="rmetzger" created="Fri, 6 Nov 2020 12:19:48 +0000"  >&lt;p&gt;Great, thank you!&lt;/p&gt;</comment>
                            <comment id="17227696" author="tzulitai" created="Sat, 7 Nov 2020 02:30:47 +0000"  >&lt;p&gt;flink/master: c151abc5bd6b4b642100cf75f8981f08535c5936&lt;br/&gt;
flink/release-1.11: 6675979838ade22cd6e069950bee362ba52ef747&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13335913">FLINK-19692</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0juts:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>