<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:48:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-17769] Wrong order of log events on a task failure</title>
                <link>https://issues.apache.org/jira/browse/FLINK-17769</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In this example, errors from the &lt;tt&gt;close()&lt;/tt&gt; method call are logged before the &lt;tt&gt;switched from RUNNING to FAILED&lt;/tt&gt; log line with the actual exception (which is confusing, because the exceptions coming from &lt;tt&gt;close()&lt;/tt&gt; could be considered as the failure root cause, because they are first in the log)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-05-14 10:12:42,660 INFO  org.apache.flink.streaming.connectors.kinesis.FlinkKinesisProducer [] - Started Kinesis producer instance &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region &lt;span class=&quot;code-quote&quot;&gt;&apos;eu-central-1&apos;&lt;/span&gt;
2020-05-14 10:12:42,660 DEBUG org.apache.flink.streaming.api.operators.BackendRestorerProcedure [] - Creating &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; state backend &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; StreamSource_cbc357ccb763df2852fee8c4fc7d55f2_(1/1) with empty state.
2020-05-14 10:12:42,823 INFO  org.apache.flink.streaming.connectors.kinesis.FlinkKinesisProducer [] - Closing producer
2020-05-14 10:12:42,823 INFO  org.apache.flink.streaming.connectors.kinesis.FlinkKinesisProducer [] - Flushing outstanding 2 records
2020-05-14 10:12:42,826 ERROR org.apache.flink.streaming.runtime.tasks.StreamTask          [] - Error during disposal of stream &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.
org.apache.flink.kinesis.shaded.com.amazonaws.services.kinesis.producer.DaemonException: The child process has been shutdown and can no longer accept messages.
2020-05-14 10:12:42,834 WARN  org.apache.flink.runtime.taskmanager.Task                    [] - Source: Custom Source -&amp;gt; Sink: Unnamed (1/1) (4a49aea047aeb3e67cf79c788df0e558) switched from RUNNING to FAILED.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13305454">FLINK-17769</key>
            <summary>Wrong order of log events on a task failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ym">Yuan Mei</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 17 May 2020 07:04:46 +0000</created>
                <updated>Mon, 22 Jun 2020 15:46:28 +0000</updated>
                            <resolved>Mon, 22 Jun 2020 15:44:53 +0000</resolved>
                                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17126427" author="ym" created="Fri, 5 Jun 2020 06:18:43 +0000"  >&lt;p&gt;Originally, I was thinking this problem is introduced by&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17663&quot; title=&quot;CheckpointBarrierUnaligner.getFlattenedChannelIndex can throw ArrayIndexOutOfBoundsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17663&quot;&gt;&lt;del&gt;FLINK-17663&lt;/del&gt;&lt;/a&gt;, but the problem seems to be there before the change.&lt;/p&gt;

&lt;p&gt;The problem is caused in Exception handling of&#160;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
StreamTask.disposeAllOperators(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&#160; |- StreamTask.cleanUpInvoke
&#160; &#160; |- StreamTask.invoke
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In ``disposeAllOperators(true)&apos;&apos;, &quot;true&quot; means logging error only without throwing disposal exceptions. That&apos;s why the error during disposal is printed before the real root cause.&lt;/p&gt;

&lt;p&gt;I agree these are confusing, here are a couple of ways I am considering to solve this problem:&lt;/p&gt;

&lt;p&gt;1. Print the invoke error before ``cleanUpInvoke()&apos;&apos;, as shown below; The problem is it is likely the same error can be printed twice.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception invokeException) {
 LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Invoke Error&quot;&lt;/span&gt;, invokeException);
 &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
 cleanUpInvoke();
 }
 &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable cleanUpException) {
 &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; (Exception) ExceptionUtils.firstOrSuppressed(cleanUpException, invokeException);
 }
 &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; invokeException;
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;2. use disposeAllOperators(false) instead, that is throwing the disposal exception as well. Is there any specific reason why&#160;disposal error is expected to be swallowed in this case?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;3. Be specific in the log of&#160;disposeAllOperators(true) that &quot;this is not the real root cause, is a caused by some other errors&quot;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17126444" author="ym" created="Fri, 5 Jun 2020 06:30:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please let me know what do you think.&lt;/p&gt;</comment>
                            <comment id="17126505" author="pnowojski" created="Fri, 5 Jun 2020 07:55:21 +0000"  >&lt;p&gt;1.&lt;br/&gt;
I think as you wrote option is not a good one because of duplicated logging problems.&lt;br/&gt;
2.&lt;br/&gt;
problem will be that we do not clean up all of the resources. In this method we are supposed to clean up everything that we can, regardless of the errors.&lt;br/&gt;
3.&lt;br/&gt;
Maybe if there was no other way.&lt;/p&gt;

&lt;p&gt;One remark, I think the problem might a bit more common. There are other places that are logging errors in &lt;tt&gt;cleanUpInvoke&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;What about an option 4. Remember the first exception and suppress the later ones similar how &lt;tt&gt;TaskExecutor#stopTaskExecutorServices&lt;/tt&gt; is doing for example? Keep in mind that an exception thrown from &lt;tt&gt;cleanUpInvoke&lt;/tt&gt; is already subject to a similar logic in &lt;tt&gt;StreamTask#invoke&lt;/tt&gt; if &lt;tt&gt;runMailboxLoop&lt;/tt&gt; or &lt;tt&gt;afterInvoke&lt;/tt&gt; has thrown some exception. So if there was a previous exception thrown during normal execution, an error thrown from &lt;tt&gt;cleanUpInvoke&lt;/tt&gt; would be suppressed.&lt;/p&gt;</comment>
                            <comment id="17126514" author="roman_khachatryan" created="Fri, 5 Jun 2020 08:05:26 +0000"  >&lt;p&gt;Thanks for you analysis &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ym&quot; class=&quot;user-hover&quot; rel=&quot;ym&quot;&gt;ym&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think we could also collect disposal errors without logging on TM and send them as part of failure reason to JM. It would simplify some things. But I&apos;m thinking now that for large deployments it&apos;s impractical.&lt;/p&gt;

&lt;p&gt;I think we should log the reason before closing operators (something like the 1st option).&#160;I&apos;d also increase log level in&#160;afterInvoke for&#160;&quot;Finished task&quot;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I also see this simple bug:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} ({}) switched from {} to {}.&quot;&lt;/span&gt;, taskNameWithSubtask, executionId, currentState, newState, cause); LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} ({}) switched from {} to {}.&quot;&lt;/span&gt;, taskNameWithSubtask, executionId, currentState, newState, cause);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
The last line is intended to also print the cause.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Maybe if we print the reason before closing operators, we should fix this LOG.warn and replace cause with cause.getMessage.&lt;/p&gt;</comment>
                            <comment id="17126522" author="pnowojski" created="Fri, 5 Jun 2020 08:14:24 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I think we could also collect disposal errors without logging on TM and send them as part of failure reason to JM. It would simplify some things. But I&apos;m thinking now that for large deployments it&apos;s impractical.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is a tough call. If we add the secondary failures from disposal as suppressed exceptions, we are risking braking some things - like end to end tests that are filtering what are expected/allowed error messages. Also we could pollute the JM logs more. On the other hand, some of those failures might be important indicating resource leaks or other problems.&lt;/p&gt;</comment>
                            <comment id="17126570" author="ym" created="Fri, 5 Jun 2020 09:13:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;, Yes, I like option 4, definitely a better and simple solution!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;, yep, that&apos;s a good catch, I will fix that as well.&lt;/p&gt;</comment>
                            <comment id="17126603" author="roman_khachatryan" created="Fri, 5 Jun 2020 09:53:46 +0000"  >&lt;p&gt;How would (4) handle cases when&#160;cleanUpInvoke is called NOT from the catch block - when there is no invokeException?&lt;/p&gt;

&lt;p&gt;If we throw disposeException when invokeException is null then it will be even less clear in logs.&lt;/p&gt;

&lt;p&gt;If we preserve current behavior (only log) when invokeException is null then it&#160;will not solve the original issue.&lt;/p&gt;

&lt;p&gt;Right?&lt;/p&gt;

&lt;p&gt;So I think we have to log the reason of stopping&#160;in the very beginning (in addition to adding disposeExceptions as suppressed).&lt;/p&gt;</comment>
                            <comment id="17127923" author="ym" created="Mon, 8 Jun 2020 06:24:16 +0000"  >&lt;p&gt;&#8220;If we throw disposeException when invokeException is null then it will be even less clear in logs.&#8221;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Hmm, I was wondering why? If&#160;invokeException is null, it means invoke is successful. If anything wrong occurs during `cleanUpInvoke`,&#160;disposeException should be expected to be exposed?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Let me write a version of the option 4 to see whether we mean the same thing.&lt;/p&gt;</comment>
                            <comment id="17127971" author="roman_khachatryan" created="Mon, 8 Jun 2020 07:51:19 +0000"  >&lt;p&gt;Good idea &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17142198" author="pnowojski" created="Mon, 22 Jun 2020 15:44:53 +0000"  >&lt;p&gt;Merged to master as ec4d155101. &lt;/p&gt;

&lt;p&gt;I&apos;m not very keen of backporting it to 1.11, as it can in the past error handling logic was ending up more tricky and unstable then expected, so I would prefer to have at least couple of weeks for this to stabilise on the master branch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ets8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>