<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10570] State grows unbounded when &quot;within&quot; constraint not applied</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10570</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We have been running some failure monitoring using the CEP library. Simple stuff that should probably have been implemented with a window, rather than CEP, but we had already set the project up to use CEP elsewhere and it was trivial to add this.&lt;/p&gt;

&lt;p&gt;We ran the following pattern (on 1.4.2):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
begin(PURCHASE_SEQUENCE, AfterMatchSkipStrategy.skipPastLastEvent())
        .subtype(PurchaseEvent.class)
        .times(100)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and then flat selected the responses if the failure ratio was over a certain threshold.&lt;/p&gt;

&lt;p&gt;With 1.6.1, the state size of the CEP operator for this pattern grows unbounded, and eventually destroys the job with an OOM exception. We have many CEP operators in this job but all the rest use a &quot;within&quot; call.&lt;/p&gt;

&lt;p&gt;In 1.4.2, it seems events would be discarded once they were no longer in the 100 most recent, now it seems they are held onto indefinitely. &lt;/p&gt;

&lt;p&gt;We have a workaround (we&apos;re just going to add a &quot;within&quot; call to force the CEP operator to discard old events), but it would be useful if we could have the old behaviour back.&lt;/p&gt;

&lt;p&gt;Please let me know if I can provide any more information.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13191997">FLINK-10570</key>
            <summary>State grows unbounded when &quot;within&quot; constraint not applied</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dwysakowicz">Dawid Wysakowicz</assignee>
                                    <reporter username="Jamalarm">Thomas Wozniakowski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 16 Oct 2018 17:40:16 +0000</created>
                <updated>Tue, 1 Oct 2019 15:38:56 +0000</updated>
                            <resolved>Wed, 24 Oct 2018 16:18:48 +0000</resolved>
                                    <version>1.6.1</version>
                                    <fixVersion>1.6.3</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Library / CEP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16658902" author="dawidwys" created="Mon, 22 Oct 2018 11:35:38 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jamalarm&quot; class=&quot;user-hover&quot; rel=&quot;Jamalarm&quot;&gt;Jamalarm&lt;/a&gt;, thank you for the report.&lt;/p&gt;

&lt;p&gt;The fixed semantic in 1.6 is not the problem here, it still will discard matches that started before the last event of a match. The problem is that we haven&apos;t released some internal structures in the &lt;tt&gt;SharedBuffer&lt;/tt&gt;. I&apos;ve opened a PR to fix this. It would be helpful if you could try it out and see if this fixes your problem.&lt;/p&gt;</comment>
                            <comment id="16659287" author="githubbot" created="Mon, 22 Oct 2018 18:23:45 +0000"  >&lt;p&gt;dawidwys opened a new pull request #6896: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10570&quot; title=&quot;State grows unbounded when &amp;quot;within&amp;quot; constraint not applied&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10570&quot;&gt;&lt;del&gt;FLINK-10570&lt;/del&gt;&lt;/a&gt; Fixed clearing shared buffer nodes when using After match skip strategy&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6896&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This PR fixes releasing nodes for matches when after match skip strategy is applied.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change added tests and can be verified as follows:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;`org.apache.flink.cep.nfa.AfterMatchSkipITCase#testSharedBufferIsProperlyCleared`&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16659331" author="githubbot" created="Mon, 22 Oct 2018 18:36:16 +0000"  >&lt;p&gt;dawidwys commented on issue #6896: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10570&quot; title=&quot;State grows unbounded when &amp;quot;within&amp;quot; constraint not applied&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10570&quot;&gt;&lt;del&gt;FLINK-10570&lt;/del&gt;&lt;/a&gt; Fixed clearing shared buffer nodes when using After match skip strategy&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6896#issuecomment-431817080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6896#issuecomment-431817080&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Could you help reviewing it @kl0u?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16662266" author="githubbot" created="Wed, 24 Oct 2018 13:09:29 +0000"  >&lt;p&gt;dawidwys closed pull request #6896: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10570&quot; title=&quot;State grows unbounded when &amp;quot;within&amp;quot; constraint not applied&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10570&quot;&gt;&lt;del&gt;FLINK-10570&lt;/del&gt;&lt;/a&gt; Fixed clearing shared buffer nodes when using After match skip strategy&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6896&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-libraries/flink-cep/src/main/java/org/apache/flink/cep/nfa/NFA.java b/flink-libraries/flink-cep/src/main/java/org/apache/flink/cep/nfa/NFA.java&lt;br/&gt;
index f5e89d705b8..01dcfd97eb4 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-cep/src/main/java/org/apache/flink/cep/nfa/NFA.java&lt;br/&gt;
+++ b/flink-libraries/flink-cep/src/main/java/org/apache/flink/cep/nfa/NFA.java&lt;br/&gt;
@@ -389,6 +389,7 @@ private void processMatchesAccordingToSkipStrategy(&lt;br/&gt;
 					sharedBufferAccessor);&lt;/p&gt;

&lt;p&gt; 				result.add(sharedBufferAccessor.materializeMatch(matchedResult.get(0)));&lt;br/&gt;
+				sharedBufferAccessor.releaseNode(earliestMatch.getPreviousBufferEntry());&lt;br/&gt;
 				earliestMatch = nfaState.getCompletedMatches().peek();&lt;br/&gt;
 			}&lt;/p&gt;

&lt;p&gt;diff --git a/flink-libraries/flink-cep/src/test/java/org/apache/flink/cep/nfa/AfterMatchSkipITCase.java b/flink-libraries/flink-cep/src/test/java/org/apache/flink/cep/nfa/AfterMatchSkipITCase.java&lt;br/&gt;
index d42839e3071..239dd4f4857 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-cep/src/test/java/org/apache/flink/cep/nfa/AfterMatchSkipITCase.java&lt;br/&gt;
+++ b/flink-libraries/flink-cep/src/test/java/org/apache/flink/cep/nfa/AfterMatchSkipITCase.java&lt;br/&gt;
@@ -20,15 +20,20 @@&lt;/p&gt;

&lt;p&gt; import org.apache.flink.cep.Event;&lt;br/&gt;
 import org.apache.flink.cep.nfa.aftermatch.AfterMatchSkipStrategy;&lt;br/&gt;
+import org.apache.flink.cep.nfa.aftermatch.SkipPastLastStrategy;&lt;br/&gt;
+import org.apache.flink.cep.nfa.sharedbuffer.SharedBuffer;&lt;br/&gt;
+import org.apache.flink.cep.nfa.sharedbuffer.SharedBufferAccessor;&lt;br/&gt;
 import org.apache.flink.cep.pattern.Pattern;&lt;br/&gt;
 import org.apache.flink.cep.pattern.conditions.IterativeCondition;&lt;br/&gt;
 import org.apache.flink.cep.pattern.conditions.SimpleCondition;&lt;br/&gt;
+import org.apache.flink.cep.utils.TestSharedBuffer;&lt;br/&gt;
 import org.apache.flink.streaming.runtime.streamrecord.StreamRecord;&lt;br/&gt;
 import org.apache.flink.util.FlinkRuntimeException;&lt;br/&gt;
 import org.apache.flink.util.TestLogger;&lt;/p&gt;

&lt;p&gt; import org.apache.flink.shaded.guava18.com.google.common.collect.Lists;&lt;/p&gt;

&lt;p&gt;+import org.hamcrest.Matchers;&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt; import java.util.ArrayList;&lt;br/&gt;
@@ -38,6 +43,7 @@&lt;br/&gt;
 import static org.apache.flink.cep.nfa.NFATestUtilities.compareMaps;&lt;br/&gt;
 import static org.apache.flink.cep.nfa.NFATestUtilities.feedNFA;&lt;br/&gt;
 import static org.apache.flink.cep.utils.NFAUtils.compile;&lt;br/&gt;
+import static org.junit.Assert.assertThat;&lt;/p&gt;

&lt;p&gt; /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;IT tests covering 
{@link AfterMatchSkipStrategy}
&lt;p&gt;.&lt;br/&gt;
@@ -936,4 +942,43 @@ public boolean filter(Event value, Context&amp;lt;Event&amp;gt; ctx) throws Exception &lt;/p&gt;
{
 			Lists.newArrayList(a2, c2, b1)
 		));
 	}
&lt;p&gt;+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testSharedBufferIsProperlyCleared() throws Exception {&lt;br/&gt;
+		List&amp;lt;StreamRecord&amp;lt;Event&amp;gt;&amp;gt; inputEvents = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+		for (int i = 0; i &amp;lt; 4; i++) &lt;/p&gt;
{
+			inputEvents.add(new StreamRecord&amp;lt;&amp;gt;(new Event(1, &quot;a&quot;, 1.0), i));
+		}
&lt;p&gt;+&lt;br/&gt;
+		SkipPastLastStrategy matchSkipStrategy = AfterMatchSkipStrategy.skipPastLastEvent();&lt;br/&gt;
+		Pattern&amp;lt;Event, ?&amp;gt; pattern = Pattern.&amp;lt;Event&amp;gt;begin(&quot;start&quot;, matchSkipStrategy)&lt;br/&gt;
+			.where(new SimpleCondition&amp;lt;Event&amp;gt;() &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				private static final long serialVersionUID = 5726188262756267490L;++				@Override+				public boolean filter(Event value) throws Exception {
+					return true;
+				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;).times(2);&lt;br/&gt;
+&lt;br/&gt;
+		NFA&amp;lt;Event&amp;gt; nfa = compile(pattern, false);&lt;br/&gt;
+&lt;br/&gt;
+		SharedBuffer&amp;lt;Event&amp;gt; sharedBuffer = TestSharedBuffer.createTestBuffer(Event.createTypeSerializer());&lt;br/&gt;
+		NFAState nfaState = nfa.createInitialNFAState();&lt;br/&gt;
+&lt;br/&gt;
+		for (StreamRecord&amp;lt;Event&amp;gt; inputEvent : inputEvents) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+			try (SharedBufferAccessor&amp;lt;Event&amp;gt; sharedBufferAccessor = sharedBuffer.getAccessor()) {
+				nfa.advanceTime(sharedBufferAccessor, nfaState, inputEvent.getTimestamp());
+				nfa.process(
+					sharedBufferAccessor,
+					nfaState,
+					inputEvent.getValue(),
+					inputEvent.getTimestamp(),
+					matchSkipStrategy);
+			}+		}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+		assertThat(sharedBuffer.isEmpty(), Matchers.is(true));&lt;br/&gt;
+	}&lt;br/&gt;
 }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16662481" author="dawidwys" created="Wed, 24 Oct 2018 16:19:44 +0000"  >&lt;p&gt;Fixed in master: fa085699ee5a8a90492952ae05bfc78ded3d1ec3&lt;br/&gt;
Fixed in 1.6: 8b8422c86ae2ef8b657c395cf3a10fc5f2180b84&lt;/p&gt;</comment>
                            <comment id="16674424" author="jamalarm" created="Sun, 4 Nov 2018 15:03:34 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;, I notice this is scheduled for inclusion in 1.6.3, but it looks like the PR was merged several days before 1.6.2 was released. Just wanted to check if this fix might have snuck into 1.6.2 before it went out?&lt;/p&gt;

&lt;p&gt;Otherwise we&apos;re good to wait on 1.6.3, but it would be super handy if the fix was available now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16674913" author="dawidwys" created="Mon, 5 Nov 2018 10:15:12 +0000"  >&lt;p&gt;Unfortunately it didn&apos;t make it into the 1.6.2 release as it was already past voting period.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 2 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3z9nj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>