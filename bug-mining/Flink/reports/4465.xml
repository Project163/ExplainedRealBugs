<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:48:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10195] RabbitMQ Source With Checkpointing Doesn&apos;t Backpressure Correctly</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10195</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The connection between the RabbitMQ server and the client does not appropriately back pressure when auto acking is disabled. This becomes very problematic when a downstream process throttles the data processing to slower then RabbitMQ sends the data to the client.&lt;/p&gt;

&lt;p&gt;The difference in records ends up being stored in the flink&apos;s heap space, which&#160;grows indefinitely (or technically to &quot;Integer Max&quot; Deliveries). Looking at RabbitMQ&apos;s metrics the number of unacked messages looks like steadily rising saw tooth shape.&lt;/p&gt;

&lt;p&gt;Upon further&#160;invesitgation&#160;it looks like this is due to how the&#160;QueueingConsumer works, messages are added to the&#160;BlockingQueue faster then they are being removed and processed, resulting in the previously described behavior.&lt;/p&gt;

&lt;p&gt;This may be intended behavior, however this isn&apos;t explicitly obvious in the documentation or any of the examples I have seen.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13180353">FLINK-10195</key>
            <summary>RabbitMQ Source With Checkpointing Doesn&apos;t Backpressure Correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="austince">Austin Cawley-Edwards</assignee>
                                    <reporter username="lukaj">Luka Jurukovski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 22 Aug 2018 01:21:47 +0000</created>
                <updated>Thu, 30 Jul 2020 07:35:36 +0000</updated>
                            <resolved>Wed, 29 Jul 2020 18:24:28 +0000</resolved>
                                    <version>1.4.0</version>
                    <version>1.5.0</version>
                    <version>1.5.1</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Connectors/ RabbitMQ</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="16590591" author="stephanewen" created="Thu, 23 Aug 2018 17:45:46 +0000"  >&lt;p&gt;Is that something that can be configured on RabbitMQ, for example a capacity bound on the queue in the QueuingConsumer?&lt;/p&gt;</comment>
                            <comment id="16592182" author="lukaj" created="Fri, 24 Aug 2018 21:21:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;&lt;br/&gt;
For what I can tell no. Although this has been very much a crash course in RabbitMQ for me. Looking at forums it looks like the prefetch.count is the way that this is handled normally. Basically the consumer can tell RabbitMQ how many unacked messages to allow before stopping. Ie if the prefetch.count is set to 10,000 that is how many messages rabbitmq will allow before it needs acknowledgement, at which point it will send data until it hits this max.&lt;/p&gt;

&lt;p&gt;I would imagine that Flink would not want to use this mechanism due to the fact that it doesn&apos;t actually &quot;backpressure&quot; with how Checkpointing is tied to Acking. One would have to do a throughput calculation and hope that there isn&apos;t any variance in that number that results in Flink waiting on the next checkpoint. Additionally since sync checkpointing is a feature&#160;there is no guarantees that checkpointing will happen at a regular interval.&lt;/p&gt;

&lt;p&gt;Under the covers the Queueing consumer is using&#160;LinkedBlockingQueue and uses the &quot;add&quot; method to append to the queue.&lt;/p&gt;

&lt;p&gt;I tried changing it to use&#160;ArrayBlockingQueue with a set capacity and the blocking &quot;put&quot; method, however this results in another problem with RabbitMQ. Basically this results in RabbitMQ sometimes terminating the connection to Flink when Flink doesn&apos;t dequeue from the queue fast enough (noticing this usually happens only when sync checkpointing is on and it there is long running checkpoints). According to some of the forums this is due to Rabbit having some sort of timeout with regards to how long it is willing to wait when writing to a clients buffer.&lt;/p&gt;

&lt;p&gt;I have some ugly code that I am testing where I turn off the consumer when the buffer is full, and a monitoring thread that turns it back on when it is below a certain capacity. Don&apos;t know if this methodology will cause any other issues, and am testing more. I might be able to get rid of the monitoring thread but I&apos;ll look into that when I proved out this way of doing things.&lt;/p&gt;

&lt;p&gt;Welcoming any additional thoughts or comments here. Sorry for the wall of text&lt;/p&gt;</comment>
                            <comment id="16592595" author="stephanewen" created="Sat, 25 Aug 2018 14:03:11 +0000"  >&lt;p&gt;Thanks for the input. This seems to be a fundamental issue in the way that RabbitMQ consumer works, that the connection thread &quot;pushes&quot; messages unconditionally, rather than letting thread that processes them &quot;pull&quot; the messages, or at least having a flow control mechanism.&lt;/p&gt;

&lt;p&gt;I don&apos;t have a good suggestion here. Your approach seem to be one possible option. Another one would be to embed this in the RabbitMQ client: Have an ArrayBlockingQueue. Offer records, and turn off the consumer when the queue is full, turn it on again once it is half empty. Similar to your solution, but the connection thread does that itself, which is probably more robust.&lt;/p&gt;</comment>
                            <comment id="16592649" author="lukaj" created="Sat, 25 Aug 2018 16:37:04 +0000"  >&lt;p&gt;The option that you describe is the what my ugly code is doing, and it looks like it works without issue. I&apos;ll see if I can clean it up and make a PR out of it.&lt;br/&gt;
I did have another thought last night that I&apos;ll explore first. The RabbitMq client has a different methodology for receiving records where the client requests records. I discounted this early on due the overall throughput being very very slow, however I don&apos;t think I combined this with any sort of buffering mechanism. I&apos;ll take another look at this mechanism.&lt;/p&gt;</comment>
                            <comment id="16593585" author="lukaj" created="Mon, 27 Aug 2018 12:32:28 +0000"  >&lt;p&gt;Just tested using the &quot;basicGet&quot; and a buffer. It looks like There is a limit to the throughput using this methodology (I&apos;m seeing a hard cap at ~60 r/s even while multithreading the consumer and having a massive buffer).&lt;br/&gt;
I&apos;ll go with the original methodology of turning on and off the consumer. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;, I&apos;m new to open source contributions,&#160;should I self assign this ticket and make a PR? Or do I have to wait for this issue to be voted on first?&lt;/p&gt;</comment>
                            <comment id="16594098" author="stephanewen" created="Mon, 27 Aug 2018 18:53:13 +0000"  >&lt;p&gt;You can assign the issue to yourself, once we add you to the contributors JIRA group.&lt;/p&gt;

&lt;p&gt;Usually waiting for consensus on an issue is a good idea. For connectors we assume that the users can judge these issues quite well.&lt;br/&gt;
If you make this an optional add-on to the existing consumer (flag to turn it on), it is less sensitive (does not break existing setups) and should be fairly easy to merge. &lt;/p&gt;</comment>
                            <comment id="17121227" author="austince" created="Mon, 1 Jun 2020 18:19:50 +0000"  >&lt;p&gt;Hey all, just bringing this back up as I&apos;m trying to figure out if we could replace the consumer another way, but not looking like it. The only way I&apos;ve found client-side flow control to work with RabbitMQ is through setting the prefetch count on the channel. I think that in combination with the work done by Luka, we might a decent solution where we could adjust the &lt;a href=&quot;https://www.rabbitmq.com/confirms.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;channel&apos;s prefetch count&lt;/a&gt; based on the length of the blocking queue, which can be user-configurable.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This performs better than turning the consumer off/ on and is very simple to implement. I&apos;ve put together a small prototype/ playground in Node here (&lt;a href=&quot;https://github.com/austince/backpressured-consumer-prototype&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/austince/backpressured-consumer-prototype&lt;/a&gt;), along with some potential issues. The simplest implementation would be a static prefetch count, but if we want to tune that and have it update depending on the space left in the buffer I think that&apos;s possible too.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If we allow the buffer queue length to be user-configurable, I think it would handle the following tickets as well:&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#cc7832&quot;&gt;- &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6885&quot; title=&quot;RMQSource does not support qos, leading to oom&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6885&quot;&gt;&lt;del&gt;FLINK-6885&lt;/del&gt;&lt;/a&gt; &lt;/font&gt;RMQSource does not support QoS, leading to oom&lt;br/&gt;
 &lt;font color=&quot;#cc7832&quot;&gt;- &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17559&quot; title=&quot;Backpressure seems to be broken when not going through network&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17559&quot;&gt;&lt;del&gt;FLINK-17559&lt;/del&gt;&lt;/a&gt; &lt;/font&gt;Duplicate of &lt;font color=&quot;#808080&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6885&quot; title=&quot;RMQSource does not support qos, leading to oom&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6885&quot;&gt;&lt;del&gt;FLINK-6885&lt;/del&gt;&lt;/a&gt;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;What do you all think of this proposal?&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; &lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; &lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=senegalo&quot; class=&quot;user-hover&quot; rel=&quot;senegalo&quot;&gt;senegalo&lt;/a&gt; &lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17125225" author="lukaj" created="Wed, 3 Jun 2020 18:48:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=austince&quot; class=&quot;user-hover&quot; rel=&quot;austince&quot;&gt;austince&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Your example  did inform me to a feature I was unaware of in the AMQP protocol (&lt;a href=&quot;https://www.rabbitmq.com/consumer-prefetch.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;basic.qos global flag&lt;/a&gt;) that I wish I had known about at the time I was writing the ticket. Since each parallel consumer creates its own channel (from what I remember) I this would be set to work per channel.&lt;/p&gt;

&lt;p&gt;That being said while this does solve the OOM issue, but it does come at a potential cost of performance on high volume queues. Correctly me if I am wrong here, but I don&apos;t think this design fixes If there are infrequent checkpoints. Messages will not be sent by Rabbitmq even if they are dequeued from the client&apos;s buffer, until the next checkpoint occurs and the message are acked. So for example if a checkpoint occurs every 10 seconds, and it takes 1 seconds for the job to process the configured qos limit message, the other 9 seconds are spent doing nothing. One would have to balance checkpoint interval, time to checkpoint, processing rate and memory in order to not waste cycles.&lt;/p&gt;

&lt;p&gt;The only reason I have not contributed back the solution of doing a soft cancel on the connection (while maintaining the channel) is due to the fact that Rabbitmq&apos;s Java client doesn&apos;t (didn&apos;t?) have locking mechanisms on canceling, which resulted in no way of terminating the connection without causing an exception (as the auto recovery mechanism might be in play at the same time) that has no good ways of being handled.  My solution was sufficient for our internal use case, but not something that I think is acceptable for general solution.&lt;/p&gt;

&lt;p&gt;I&apos;ll revisit this, as I have not looked at this since my part of the compay has moved away from Rabbitmq. In googling to refresh myself on some of the details for this response, I see that the landscape may have changed since I last took a look at this problem, or I may have overlooked some options.&lt;/p&gt;</comment>
                            <comment id="17125362" author="austince" created="Wed, 3 Jun 2020 22:27:19 +0000"  >&lt;p&gt;Yes, that is correct, though I think it is still an improvement on what&apos;s here and allows the users to tune their job according to their needs, but I don&apos;t think the performance issue that you cite can be fixed with what Rabbit provides.&lt;/p&gt;

&lt;p&gt;EDIT: we might be able to handle this by updating prefetch counts dynamically if the buffer has space and there are many unacked messages waiting to be acked on checkpoint, though I think that might be too much for an initial implementation.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If the user has high volume queues and needs checkpointing for EXACTLY_ONCE/ AT_LEAST_ONCE guarantees, they&apos;ll need to tune their buffer length and checkpointing interval. This could also be an opt-in/ opt-out change if there are cases that need it disabled, and we should definitely update the docs&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;Our company still actively uses Rabbit &#8211; I&apos;m happy to build off your PR and test it out in our jobs.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;: &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-stable/dev/connectors/rabbitmq.html#rabbitmq-source&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-stable/dev/connectors/rabbitmq.html#rabbitmq-source&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17134180" author="aljoscha" created="Fri, 12 Jun 2020 12:36:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=austince&quot; class=&quot;user-hover&quot; rel=&quot;austince&quot;&gt;austince&lt;/a&gt; should I assign the issue to you?&lt;/p&gt;</comment>
                            <comment id="17134241" author="austince" created="Fri, 12 Jun 2020 14:00:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; that would be great, thank you. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lukaj&quot; class=&quot;user-hover&quot; rel=&quot;lukaj&quot;&gt;lukaj&lt;/a&gt;, I would love feedback from you when I finish a first cut if that sounds good to you.&lt;/p&gt;</comment>
                            <comment id="17167433" author="dawidwys" created="Wed, 29 Jul 2020 18:24:28 +0000"  >&lt;p&gt;Implemented in 3b6ca3c512f2742c84b3c623ac79c61a04af9ab1&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13303471">FLINK-17559</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13078870">FLINK-6885</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13320036">FLINK-18755</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xabz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>