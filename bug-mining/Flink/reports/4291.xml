<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:47:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18226] ResourceManager requests unnecessary new workers if previous workers are allocated but not registered.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18226</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Problem&quot;&gt;&lt;/a&gt;Problem&lt;/h2&gt;

&lt;p&gt;Currently on Kubernetes &amp;amp; Yarn deployment, the ResourceManager compares &lt;b&gt;pending workers requested from Kubernetes/Yarn&lt;/b&gt; against &lt;b&gt;pending workers required by SlotManager&lt;/b&gt;, for deciding whether new workers should be requested in case of a worker failure.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;KubernetesResourceManager#requestKubernetesPodIfRequired&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;YarnResourceManager#requestYarnContainerIfRequired&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Pending workers requested from Kubernetes/Yarn&lt;/b&gt; is decreased when the worker is allocated, &lt;b&gt;before the worker is actually started and registered&lt;/b&gt;.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Decreased in &lt;tt&gt;ActiveResourceManager#notifyNewWorkerAllocated&lt;/tt&gt;, which is called in&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;KubernetesResourceManager#onAdded&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;YarnResourceManager#onContainersOfResourceAllocated&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;On the other hand, &lt;b&gt;pending workers required by SlotManager&lt;/b&gt; is derived from the number of pending slots inside SlotManager, which is decreased &lt;b&gt;when the new workers/slots are registered&lt;/b&gt;.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;SlotManagerImpl#registerSlot&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Therefore, if a worker &lt;tt&gt;w1&lt;/tt&gt; is failed after another worker &lt;tt&gt;w2&lt;/tt&gt; is allocated but before &lt;tt&gt;w2&lt;/tt&gt; is registered, the ResourceManager will request an unnecessary new worker for &lt;tt&gt;w2&lt;/tt&gt;.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Impact&quot;&gt;&lt;/a&gt;Impact&lt;/h2&gt;

&lt;p&gt;Normally, the extra worker should be released soon after allocated. But in cases where the Kubernetes/Yarn cluster does not have enough resources, it might create more and more pending pods/containers.&lt;/p&gt;

&lt;p&gt;It&apos;s even more severe for Kubernetes, because &lt;tt&gt;KubernetesResourceManager#onAdded&lt;/tt&gt; only suggest that the pod spec has been successfully added to the cluster, but the pod may not actually been allocated due to lack of resources. Imagine there are &lt;tt&gt;N&lt;/tt&gt; pending pods, a failure of a running pod means requesting another &lt;tt&gt;N&lt;/tt&gt; new pods.&lt;/p&gt;

&lt;p&gt;In a session cluster, such pending pods could take long to be cleared even after all jobs in the session cluster have terminated.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13310534">FLINK-18226</key>
            <summary>ResourceManager requests unnecessary new workers if previous workers are allocated but not registered.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xtsong">Xintong Song</assignee>
                                    <reporter username="xtsong">Xintong Song</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 10 Jun 2020 03:30:24 +0000</created>
                <updated>Sun, 14 Jun 2020 00:26:00 +0000</updated>
                            <resolved>Sun, 14 Jun 2020 00:26:00 +0000</resolved>
                                    <version>1.11.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Deployment / Kubernetes</component>
                    <component>Deployment / YARN</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17130021" author="xintongsong" created="Wed, 10 Jun 2020 03:39:16 +0000"  >&lt;p&gt;Here are my proposal for solving this problem.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We should decrease &lt;b&gt;pending workers requested from Kubernetes/Yarn&lt;/b&gt; when the new worker is registered, rather than allocated.&lt;/li&gt;
	&lt;li&gt;We would need to match the registered workers with the pending ones, wrt their resource spec. To avoid passing &lt;tt&gt;WorkerResourceSpec&lt;/tt&gt; all the way to the &lt;tt&gt;TaskExecutor&lt;/tt&gt; and register it back, we can record the mapping between &lt;tt&gt;ResourceID&lt;/tt&gt; and &lt;tt&gt;WorkerResourceSpec&lt;/tt&gt; when the workers are allocated, and find out the &lt;tt&gt;WorkerResourceSpec&lt;/tt&gt; from the &lt;tt&gt;ResourceID&lt;/tt&gt; when the worker is registered.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17130022" author="xintongsong" created="Wed, 10 Jun 2020 03:39:46 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17130424" author="till.rohrmann" created="Wed, 10 Jun 2020 08:52:21 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xintongsong&quot; class=&quot;user-hover&quot; rel=&quot;xintongsong&quot;&gt;xintongsong&lt;/a&gt;. Your analysis and your solution proposal sound good to me. Please go ahead and provide a fix. I will review it. &lt;/p&gt;

&lt;p&gt;Since this issue should have existed before, I will decrease the priority of this issue to critical.&lt;/p&gt;</comment>
                            <comment id="17130616" author="xintongsong" created="Wed, 10 Jun 2020 12:28:14 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;. I&apos;ll try to open a PR asap. Still dealing with the test cases.&lt;/p&gt;

&lt;p&gt;Regarding the priority, it is true that this issue existed before. But I think our changes in 1.11.0 have made this worse. Previously, for each worker failure, we will request at most one more new worker. Now we are trying to request all the pending workers.&#160;&lt;/p&gt;</comment>
                            <comment id="17130653" author="till.rohrmann" created="Wed, 10 Jun 2020 13:04:55 +0000"  >&lt;p&gt;This is true, then let&apos;s try to fix it before the next RC is created. Then it doesn&apos;t matter whether it is a blocker or critical &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Increasing the severity to blocker for the time being.&lt;/p&gt;</comment>
                            <comment id="17133066" author="xintongsong" created="Thu, 11 Jun 2020 08:51:31 +0000"  >&lt;p&gt;Some updates on this ticket.&lt;/p&gt;

&lt;p&gt;I ran into some YARN test failures. Turns out we cannot simply move the decreasing of pending worker count from on-worker-allocated to on-worker-registered. The problem is that, &lt;tt&gt;YarnResourceManager&lt;/tt&gt; relies on this counter for deciding which worker to start.&lt;/p&gt;

&lt;p&gt;A yarn container resource &lt;tt&gt;c1&lt;/tt&gt; (e.g., &amp;lt;4GB&amp;gt;) might corresponds to multiple worker resource spec &lt;tt&gt;w1&lt;/tt&gt;, &lt;tt&gt;w2&lt;/tt&gt; (e.g., &amp;lt;1GB heap, 3GB off-heap&amp;gt; &amp;amp; &amp;lt;3GB heap, 1GB off-heap&amp;gt;). Say if the number of pending workers is &amp;lt;w1 : 1, w2 : 1&amp;gt;, that means the number of pending containers &amp;lt;c1 : 2&amp;gt;. When a container of resource &lt;tt&gt;c1&lt;/tt&gt; is allocated, YarnRM choose one from &lt;tt&gt;w1&lt;/tt&gt; and &lt;tt&gt;w2&lt;/tt&gt; and starts a TM accordingly. Let&apos;s say it picks &lt;tt&gt;w1&lt;/tt&gt;. Then the pending workers become &amp;lt;w1 : 0, w2 :1&amp;gt; &amp;amp; &amp;lt;c1 : 1&amp;gt;. In this way, when another container of &lt;tt&gt;c1&lt;/tt&gt; is allocated, YarnRM knows it should starts a TM with &lt;tt&gt;w2&lt;/tt&gt; rather than &lt;tt&gt;w1&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If we do not decrease the counter on worker registered rather than allocated, then YarnRM won&apos;t be able to know which worker resource spec should the TM be started with when the second container is allocated before the first one registered.&lt;/p&gt;</comment>
                            <comment id="17133070" author="xintongsong" created="Thu, 11 Jun 2020 09:01:38 +0000"  >&lt;p&gt;One way to solve the problem is to have two counters, for&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;pending workers not allocated&lt;/li&gt;
	&lt;li&gt;pending workers allocated not registered&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The former could be used for deciding which worker resource spec the TM should be start with on Yarn, while the latter could be used for deciding whether to request a new worker on a failure of exist worker.&lt;/p&gt;

&lt;p&gt;I think this might be a feasible fix for the 1.11.0 release. However, it relies on each deployment-specific RM to call &lt;tt&gt;notifyWorkerRequested/Allocated/Registered/AllocationFailed/Terminated&lt;/tt&gt; methods at proper timing, which is kind of crumbly. Ideally, we should have the common &lt;tt&gt;ActiveResourceManager&lt;/tt&gt; to decide common workflow, leaving interfaces like &lt;tt&gt;requestNewWorker&lt;/tt&gt; or &lt;tt&gt;onWorkerAllocated&lt;/tt&gt; for the deployment-specific RMs to fill in. Of course this requires more efforts and could be a follow up issue.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; WDYT?&lt;/p&gt;</comment>
                            <comment id="17133219" author="till.rohrmann" created="Thu, 11 Jun 2020 12:20:44 +0000"  >&lt;p&gt;Yes this sounds like a good plan &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xintongsong&quot; class=&quot;user-hover&quot; rel=&quot;xintongsong&quot;&gt;xintongsong&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Maybe we manage to allocate some time in the 1.12 release to clean the &lt;tt&gt;ResourceManager&lt;/tt&gt; up and put the right abstractions in place. I think you are right that we are running into many of these problems as often as we have different &lt;tt&gt;ResourceManager&lt;/tt&gt; implementations.&lt;/p&gt;

&lt;p&gt;For now a quick fix for the release would be good enough.&lt;/p&gt;</comment>
                            <comment id="17134982" author="xintongsong" created="Sun, 14 Jun 2020 00:26:00 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master: 4f333e54fdc54956f97f7ea5031a63a5239f2c8c&lt;/li&gt;
	&lt;li&gt;1.11.0: 2af0d4b001ef2e4ecd83eeb1abbfe920dc631977&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13307739">FLINK-17976</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 22 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fp20:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>