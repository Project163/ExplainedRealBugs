<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:22:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-36876] Operator Heap Memory Leak</title>
                <link>https://issues.apache.org/jira/browse/FLINK-36876</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When the amount of FlinkDeployment increasing, the heap memory used by Kubernetes Operator keep increasing.&lt;/p&gt;

&lt;p&gt;Eventhough after Old GC, the heap memory used can not be decreased as expected. &lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073358/13073358_image-2024-12-10-15-57-00-309.png&quot; height=&quot;541&quot; width=&quot;443&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Finally, the Kubernetes Operator was OOMKilled by OS;&lt;/p&gt;</description>
                <environment>&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Flink Operator Version:&#160; &#160;1.6.1 (I think the latest version 1.10 has the same problem)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;JDK:&#160; openjdk version &quot;11.0.24&quot;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;GC: G1&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;FlinkDeployment ammout:&#160; 3000+&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13601507">FLINK-36876</key>
            <summary>Operator Heap Memory Leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="stupid_pig">chenyuzhi</assignee>
                                    <reporter username="stupid_pig">chenyuzhi</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 10 Dec 2024 08:00:58 +0000</created>
                <updated>Wed, 2 Jul 2025 12:25:47 +0000</updated>
                                            <version>kubernetes-operator-1.6.1</version>
                    <version>kubernetes-operator-1.10.0</version>
                                                    <component>Kubernetes Operator</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17904403" author="stupid_pig" created="Tue, 10 Dec 2024 08:48:59 +0000"  >&lt;p&gt;I have analyzed the heap dump of Kubernetes Operator using MAT;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;One hint of LeakSuspect is memory of &lt;b&gt;java.lang.ref.Finalizer.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073359/13073359_image-2024-12-10-16-09-22-749.png&quot; height=&quot;193&quot; width=&quot;670&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The domiator_tree summary:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073360/13073360_image-2024-12-10-16-11-21-830.png&quot; height=&quot;188&quot; width=&quot;711&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Acccording to the domiator_tree summary, the main cause is the&#160; &lt;b&gt;PoolThreadCache.&lt;/b&gt; After some research and testing, I think the problem is the reconcile mechanism.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As shown below&#65292;in the every reconcile operatrion&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Kubernetes Operator will create a new RestClusterClient/RestClient for observerFlinkdeployment; &#160;&lt;/li&gt;
	&lt;li&gt;When creating RestClient, it will&#160; create&#160; NioEventLoopGroup/PoolThreadCache&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073361/13073361_screenshot-1.png&quot; height=&quot;175&quot; width=&quot;672&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;RootCause analysis:&lt;/p&gt;

&lt;p&gt;The PoolThreadCache has implemented the finalize() method.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thus the PoolThreadCache won&apos;t be released until&#160; the JVM finalizer thread&#65288;Single Thread&#65289;processed, but Kubernetes Operator would create a new&#160; RestClusterClient(create new PoolThreadCache at the sametime) for every flinkdeployment in a reconcile interval.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When the amount of flinkdeployment is increasing,&#160; the speed of creating PoolThreadCache would beyond the releasing PoolThreadCache.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Solution:&#160;&lt;/p&gt;

&lt;p&gt;One solution is make RestClient accepted a shared&#160; NioEventLoopGroup/PoolThreadCache passed by external.&lt;/p&gt;

&lt;p&gt;It has been tested&#160; in our env to solve this problem.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17904404" author="stupid_pig" created="Tue, 10 Dec 2024 08:49:29 +0000"  >&lt;p&gt;Hi,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gyfora&quot; class=&quot;user-hover&quot; rel=&quot;gyfora&quot;&gt;gyfora&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Could you help to have a glimse at this operator problem. And I would like to help fix this problem if need&lt;/p&gt;</comment>
                            <comment id="17904417" author="gyfora" created="Tue, 10 Dec 2024 09:25:24 +0000"  >&lt;p&gt;I think the analysis is good and passing a shared executor service is a good solution. Let&apos;s just make sure we have the capacity based on the reconciliation parallelism (or a bit more)&lt;/p&gt;</comment>
                            <comment id="17904764" author="gyfora" created="Wed, 11 Dec 2024 11:25:49 +0000"  >&lt;p&gt;I originally thought that the fix would involve simply passing an executor service but seems like it needs a core Flink change. Is there any operator only fix maybe?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17904777" author="stupid_pig" created="Wed, 11 Dec 2024 12:01:17 +0000"  >&lt;p&gt;&#160;There are two more ways to fix this:&lt;/p&gt;

&lt;p&gt;1 . Operator caches a restClient for each flinkdeployment; however, as the number of flinkdeployments increases, the memory occupied by operator will still increase;&lt;/p&gt;

&lt;p&gt;2. Operator rewrites the logic of accessing flink restAPI, such as implementing another set of RestClient/RestClusterClient, which is a bit reinventing the wheel.&lt;/p&gt;

&lt;p&gt;Passing an executor service should have relatively small changes to flink core. This method is also beneficial to external services using flink sdk to implement large-scale scheduled polling, which is also meaningful.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17904838" author="gyfora" created="Wed, 11 Dec 2024 15:59:33 +0000"  >&lt;p&gt;The problem with a Flink-core change is that it will be months before the operator can adopt it. It requires back porting to Flink 1.20 + a new release&lt;/p&gt;</comment>
                            <comment id="17904839" author="gyfora" created="Wed, 11 Dec 2024 16:00:03 +0000"  >&lt;p&gt;But in the long term I think the Flink-core change makes sense but maybe in the short term we should consider an operator side fix as well if this is important&lt;/p&gt;</comment>
                            <comment id="17905885" author="stupid_pig" created="Mon, 16 Dec 2024 04:06:53 +0000"  >&lt;p&gt;Well, how about rewrite a new RestClient/RestClusterClient(just the solution2 mentioned above) in Operator as a temporary solution before Flink-core change release.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17915892" author="stupid_pig" created="Wed, 22 Jan 2025 02:40:55 +0000"  >&lt;p&gt;Are there any further new ideas or discussions on this issue?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gyfora&quot; class=&quot;user-hover&quot; rel=&quot;gyfora&quot;&gt;gyfora&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17915946" author="gyfora" created="Wed, 22 Jan 2025 07:46:10 +0000"  >&lt;p&gt;You tell me &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stupid_pig&quot; class=&quot;user-hover&quot; rel=&quot;stupid_pig&quot;&gt;stupid_pig&lt;/a&gt; how you would like to proceed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17935122" author="stupid_pig" created="Thu, 13 Mar 2025 09:53:58 +0000"  >&lt;p&gt;I have submitted a &lt;a href=&quot;https://github.com/apache/flink-kubernetes-operator/pull/956&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;draft PR&lt;/a&gt; to try to fix this in operator side.&lt;/p&gt;

&lt;p&gt;Could you help to have a glance&#65311;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gyfora&quot; class=&quot;user-hover&quot; rel=&quot;gyfora&quot;&gt;gyfora&lt;/a&gt;&#160;&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17950501" author="gyfora" created="Fri, 9 May 2025 12:04:14 +0000"  >&lt;p&gt;Flink side PR merged to master: 4594f5e081defbd7e20d9d50c3d85e83c7dacc06&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13073358" name="image-2024-12-10-15-57-00-309.png" size="139631" author="stupid_pig" created="Tue, 10 Dec 2024 07:57:01 +0000"/>
                            <attachment id="13073359" name="image-2024-12-10-16-09-22-749.png" size="68512" author="stupid_pig" created="Tue, 10 Dec 2024 08:09:24 +0000"/>
                            <attachment id="13073360" name="image-2024-12-10-16-11-21-830.png" size="155824" author="stupid_pig" created="Tue, 10 Dec 2024 08:11:23 +0000"/>
                            <attachment id="13073361" name="screenshot-1.png" size="35535" author="stupid_pig" created="Tue, 10 Dec 2024 08:21:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            26 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1t0q8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>