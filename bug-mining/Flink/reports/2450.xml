<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9258] ConcurrentModificationException in ComponentMetricGroup.getAllVariables</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9258</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Seeing this exception at the job startup time. Looks like there is a race condition when the metrics variables are constructed.&lt;/p&gt;

&lt;p&gt;The error is&#160;intermittent.&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;main&quot; org.apache.flink.runtime.client.JobExecutionException: Job execution failed.&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.runtime.jobmanager.JobManager$$anonfun$handleMessage$1$$anonfun$applyOrElse$6.apply$mcV$sp(JobManager.scala:897)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.runtime.jobmanager.JobManager$$anonfun$handleMessage$1$$anonfun$applyOrElse$6.apply(JobManager.scala:840)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.runtime.jobmanager.JobManager$$anonfun$handleMessage$1$$anonfun$applyOrElse$6.apply(JobManager.scala:840)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.concurrent.impl.Future$PromiseCompletingRunnable.liftedTree1$1(Future.scala:24)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.concurrent.impl.Future$PromiseCompletingRunnable.run(Future.scala:24)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at akka.dispatch.TaskInvocation.run(AbstractDispatcher.scala:39)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at akka.dispatch.ForkJoinExecutorConfigurator$AkkaForkJoinTask.exec(AbstractDispatcher.scala:415)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)&lt;/p&gt;

&lt;p&gt;Caused by: java.util.ConcurrentModificationException&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at java.util.HashMap$HashIterator.nextNode(HashMap.java:1437)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at java.util.HashMap$EntryIterator.next(HashMap.java:1471)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at java.util.HashMap$EntryIterator.next(HashMap.java:1469)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at java.util.HashMap.putMapEntries(HashMap.java:511)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at java.util.HashMap.putAll(HashMap.java:784)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.runtime.metrics.groups.ComponentMetricGroup.getAllVariables(ComponentMetricGroup.java:63)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.runtime.metrics.groups.ComponentMetricGroup.getAllVariables(ComponentMetricGroup.java:63)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.netflix.spaas.metrics.MetricsReporterRegistry.getTags(MetricsReporterRegistry.java:147)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.netflix.spaas.metrics.MetricsReporterRegistry.mergeWithSourceAndSinkTags(MetricsReporterRegistry.java:170)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.netflix.spaas.metrics.MetricsReporterRegistry.addReporter(MetricsReporterRegistry.java:75)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.netflix.spaas.nfflink.connector.kafka.source.Kafka010Consumer.createFetcher(Kafka010Consumer.java:69)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumerBase.run(FlinkKafkaConsumerBase.java:549)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:86)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:55)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.streaming.runtime.tasks.SourceStreamTask.run(SourceStreamTask.java:94)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:264)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.flink.runtime.taskmanager.Task.run(Task.java:718)&lt;/p&gt;

&lt;p&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;at java.lang.Thread.run(Thread.java:748)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13155230">FLINK-9258</key>
            <summary>ConcurrentModificationException in ComponentMetricGroup.getAllVariables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="narayaruna">Narayanan Arunachalam</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Apr 2018 18:49:18 +0000</created>
                <updated>Tue, 29 May 2018 14:49:35 +0000</updated>
                            <resolved>Tue, 29 May 2018 11:20:51 +0000</resolved>
                                    <version>1.4.2</version>
                                    <fixVersion>1.4.3</fixVersion>
                    <fixVersion>1.5.1</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16453095" author="zentol" created="Wed, 25 Apr 2018 21:10:46 +0000"  >&lt;p&gt;This should only be possible if &lt;tt&gt;getAllVariables&lt;/tt&gt; is called concurrently by multiple threads. The problem is that the internal map is assigned to the field before it is populated with data, at which point it is already accessable by other threads.&lt;/p&gt;</comment>
                            <comment id="16465611" author="githubbot" created="Mon, 7 May 2018 08:09:20 +0000"  >&lt;p&gt;GitHub user zentol opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9258&quot; title=&quot;ConcurrentModificationException in ComponentMetricGroup.getAllVariables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9258&quot;&gt;&lt;del&gt;FLINK-9258&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Thread-safe initialization of variables map&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR fixes a thread-safety issue in `ComponentMetricGroup` where a map was assigned to the `variables` field in a synchronized block before it was populated.&lt;br/&gt;
    This meant that a modification could be made to the map that is already visible to other threads, leading to `ConcurrentModificationExceptions`.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zentol/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/flink&lt;/a&gt; 9258&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5959&lt;/p&gt;

&lt;hr /&gt;

&lt;hr /&gt;</comment>
                            <comment id="16466777" author="githubbot" created="Tue, 8 May 2018 02:39:46 +0000"  >&lt;p&gt;Github user yuqi1129 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959#discussion_r186603684&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959#discussion_r186603684&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/ComponentMetricGroup.java &amp;#8212;&lt;br/&gt;
    @@ -57,11 +57,12 @@ public ComponentMetricGroup(MetricRegistry registry, String[] scope, P parent) {&lt;br/&gt;
     		if (variables == null) { // avoid synchronization for common case&lt;br/&gt;
     			synchronized (this) {&lt;br/&gt;
     				if (variables == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;variables = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;putVariables(variables);&lt;br/&gt;
    +					Map&amp;lt;String, String&amp;gt; tmpVariables = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +					putVariables(tmpVariables);&lt;br/&gt;
     					if (parent != null) 
{ // not true for Job-/TaskManagerMetricGroup
    -						variables.putAll(parent.getAllVariables());
    +						tmpVariables.putAll(parent.getAllVariables());
     					}
&lt;p&gt;    +					variables = tmpVariables;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Do not need any test that verify this change ?&lt;/p&gt;</comment>
                            <comment id="16466963" author="githubbot" created="Tue, 8 May 2018 06:47:11 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959#discussion_r186630665&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959#discussion_r186630665&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/ComponentMetricGroup.java &amp;#8212;&lt;br/&gt;
    @@ -57,11 +57,12 @@ public ComponentMetricGroup(MetricRegistry registry, String[] scope, P parent) {&lt;br/&gt;
     		if (variables == null) { // avoid synchronization for common case&lt;br/&gt;
     			synchronized (this) {&lt;br/&gt;
     				if (variables == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;variables = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;putVariables(variables);&lt;br/&gt;
    +					Map&amp;lt;String, String&amp;gt; tmpVariables = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +					putVariables(tmpVariables);&lt;br/&gt;
     					if (parent != null) 
{ // not true for Job-/TaskManagerMetricGroup
    -						variables.putAll(parent.getAllVariables());
    +						tmpVariables.putAll(parent.getAllVariables());
     					}
&lt;p&gt;    +					variables = tmpVariables;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We &lt;em&gt;could&lt;/em&gt; write a test, but it would be heavily tied to the implementation and is thus a bit questionable.&lt;/p&gt;</comment>
                            <comment id="16486905" author="githubbot" created="Wed, 23 May 2018 08:37:49 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959#discussion_r190165058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959#discussion_r190165058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/ComponentMetricGroup.java &amp;#8212;&lt;br/&gt;
    @@ -57,11 +57,12 @@ public ComponentMetricGroup(MetricRegistry registry, String[] scope, P parent) {&lt;br/&gt;
     		if (variables == null) { // avoid synchronization for common case&lt;br/&gt;
     			synchronized (this) {&lt;br/&gt;
     				if (variables == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;variables = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;putVariables(variables);&lt;br/&gt;
    +					Map&amp;lt;String, String&amp;gt; tmpVariables = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +					putVariables(tmpVariables);&lt;br/&gt;
     					if (parent != null) 
{ // not true for Job-/TaskManagerMetricGroup
    -						variables.putAll(parent.getAllVariables());
    +						tmpVariables.putAll(parent.getAllVariables());
     					}
&lt;p&gt;    +					variables = tmpVariables;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This looks potentially still broken to me because it does double-checked locking, which is a defective anti-pattern.&lt;/p&gt;</comment>
                            <comment id="16486907" author="githubbot" created="Wed, 23 May 2018 08:39:33 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959#discussion_r190165634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959#discussion_r190165634&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/ComponentMetricGroup.java &amp;#8212;&lt;br/&gt;
    @@ -57,11 +57,12 @@ public ComponentMetricGroup(MetricRegistry registry, String[] scope, P parent) {&lt;br/&gt;
     		if (variables == null) { // avoid synchronization for common case&lt;br/&gt;
     			synchronized (this) {&lt;br/&gt;
     				if (variables == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;variables = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;putVariables(variables);&lt;br/&gt;
    +					Map&amp;lt;String, String&amp;gt; tmpVariables = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +					putVariables(tmpVariables);&lt;br/&gt;
     					if (parent != null) 
{ // not true for Job-/TaskManagerMetricGroup
    -						variables.putAll(parent.getAllVariables());
    +						tmpVariables.putAll(parent.getAllVariables());
     					}
&lt;p&gt;    +					variables = tmpVariables;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    To be clear, this is not exactly about the fixed lines, but the line that is commented with &quot;optimization for common case&quot; is the remaining problem.&lt;/p&gt;</comment>
                            <comment id="16486911" author="githubbot" created="Wed, 23 May 2018 08:48:48 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I have two quick questions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Why does `ComponentMetricGroup` even override the method `getAllVariables` from `AbstractMetricGroup` with essentially the exact same code?&lt;br/&gt;
    -Why is it only fixed in `ComponentMetricGroup`? Could it make sense to fix it in `AbstractMetricGroup` and remove the overriding method in the subclass?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16486917" author="githubbot" created="Wed, 23 May 2018 08:49:48 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959#discussion_r190168697&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959#discussion_r190168697&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/ComponentMetricGroup.java &amp;#8212;&lt;br/&gt;
    @@ -57,11 +57,12 @@ public ComponentMetricGroup(MetricRegistry registry, String[] scope, P parent) {&lt;br/&gt;
     		if (variables == null) { // avoid synchronization for common case&lt;br/&gt;
     			synchronized (this) {&lt;br/&gt;
     				if (variables == null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;variables = new HashMap&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;putVariables(variables);&lt;br/&gt;
    +					Map&amp;lt;String, String&amp;gt; tmpVariables = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +					putVariables(tmpVariables);&lt;br/&gt;
     					if (parent != null) 
{ // not true for Job-/TaskManagerMetricGroup
    -						variables.putAll(parent.getAllVariables());
    +						tmpVariables.putAll(parent.getAllVariables());
     					}
&lt;p&gt;    +					variables = tmpVariables;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    EDIT removed my previous comment about double-checked locking because I saw that the variable is `volatile`&lt;/p&gt;</comment>
                            <comment id="16486947" author="githubbot" created="Wed, 23 May 2018 09:10:30 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The methods have been identical since &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7692&quot; title=&quot;Support user-defined variables in Metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7692&quot;&gt;&lt;del&gt;FLINK-7692&lt;/del&gt;&lt;/a&gt;, but I didn&apos;t catch it in the review. Thus, `ComponentMetricGroup#getAllVariables()` should be removed, along with `ComponentMetricGroup#putVariables()`, and the fix applied to `AbstractMetricGroup#getAllVariables()`.&lt;/p&gt;

&lt;p&gt;    We try to construct as many things as possible lazily, to reduce the resource impact in case the metric system isn&apos;t used.&lt;/p&gt;</comment>
                            <comment id="16486950" author="githubbot" created="Wed, 23 May 2018 09:12:47 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Sounds good. After the mentioned changes this looks ready to merge for me &#128077; &lt;/p&gt;</comment>
                            <comment id="16487378" author="githubbot" created="Wed, 23 May 2018 14:40:54 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    LGTM &#128077; &lt;/p&gt;</comment>
                            <comment id="16492509" author="githubbot" created="Mon, 28 May 2018 10:30:04 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    merging.&lt;/p&gt;</comment>
                            <comment id="16493186" author="zentol" created="Tue, 29 May 2018 07:35:30 +0000"  >&lt;p&gt;1.5: 3cdba864e7c979125bb0460025f1a5bbe749cbaf&lt;br/&gt;
1.4: 89d021ae2fb0e0ea5b0edb003df5bd6c3f2180d7&lt;/p&gt;</comment>
                            <comment id="16493397" author="zentol" created="Tue, 29 May 2018 11:20:51 +0000"  >&lt;p&gt;master: 5669b12206c4e1376dabbc0d946f9aeee0f34795&lt;/p&gt;</comment>
                            <comment id="16493636" author="githubbot" created="Tue, 29 May 2018 14:49:35 +0000"  >&lt;p&gt;Github user zentol closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5959&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 25 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3t0zj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>