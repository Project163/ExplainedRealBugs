<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:29:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6964] Fix recovery for incremental checkpoints in StandaloneCompletedCheckpointStore</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6964</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;tt&gt;StandaloneCompletedCheckpointStore&lt;/tt&gt; does not register shared states ion resume. However, for externalized checkpoints, it register the checkpoint from which it resumed. This checkpoint gets added to the completed checkpoint store as part of resume.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13081369">FLINK-6964</key>
            <summary>Fix recovery for incremental checkpoints in StandaloneCompletedCheckpointStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="srichter">Stefan Richter</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Jun 2017 09:38:30 +0000</created>
                <updated>Thu, 20 Jul 2017 08:35:33 +0000</updated>
                            <resolved>Wed, 19 Jul 2017 09:46:10 +0000</resolved>
                                                    <fixVersion>1.3.2</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16060027" author="cresny@gmail.com" created="Thu, 22 Jun 2017 21:23:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt; I tried your fix. After resuming from a checkpoint, the first subsequent checkpoint got to 100% and hung, then expired several minutes later. The second one repeated this.  If logging will help you perhaps if you can add some TRACE level logs and let me know the scopes, and I&apos;ll create a gist.&lt;/p&gt;</comment>
                            <comment id="16060857" author="srichter" created="Fri, 23 Jun 2017 13:03:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cresny%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;cresny@gmail.com&quot;&gt;cresny@gmail.com&lt;/a&gt; Hanging means that you cannot find any exceptions in the log that indicate a cause?&lt;/p&gt;</comment>
                            <comment id="16061078" author="srichter" created="Fri, 23 Jun 2017 14:59:20 +0000"  >&lt;p&gt;Besides potential exceptions, the same logging information as you provided last time (e.g. interactions with the shared registry) could be helpful.&lt;/p&gt;</comment>
                            <comment id="16061088" author="cresny@gmail.com" created="Fri, 23 Jun 2017 15:07:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt; By hanging I mean that the checkpoint, though fully acknowledged, never completes. Looking at the UI I see 100% and a spinning arrow until the checkpoint time expires, apparently without an exception being thrown. I did not merge my added logs into your branch because, from what you described, the issue was with the &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;StandaloneCompletedCheckpointStore&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;, which I never added logging to anyway. However if the code as-is in your branch has sufficient logging I can reproduce the issue and create a gist.&lt;/p&gt;





</comment>
                            <comment id="16061092" author="cresny@gmail.com" created="Fri, 23 Jun 2017 15:12:23 +0000"  >&lt;p&gt;I&apos;ll merge and rerun. This is what I have for log scope. Should I add anything? &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.flink.contrib.streaming.state=TRACE
org.apache.flink.runtime.checkpoint=TRACE
org.apache.flink.runtime.state=TRACE
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16061143" author="srichter" created="Fri, 23 Jun 2017 15:49:23 +0000"  >&lt;p&gt;I have added a commit to my branch that introduces more logging. The log scope looks good, do you log all remaining packages on INFO?&lt;/p&gt;</comment>
                            <comment id="16061163" author="cresny@gmail.com" created="Fri, 23 Jun 2017 16:14:30 +0000"  >&lt;p&gt;Ha! I just started running. ok, will merge and rebuild&lt;br/&gt;
The logging scopes above are for a separate network appender, so I tend to keep it narrow. Should I broaden it to all of flink.runtime?&lt;/p&gt;</comment>
                            <comment id="16061164" author="srichter" created="Fri, 23 Jun 2017 16:17:00 +0000"  >&lt;p&gt;I suggest to log Flink runtime at INFO level, thanks! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

</comment>
                            <comment id="16061166" author="srichter" created="Fri, 23 Jun 2017 16:18:11 +0000"  >&lt;p&gt;In particular, JobManager logs are valuable.&lt;/p&gt;</comment>
                            <comment id="16061174" author="srichter" created="Fri, 23 Jun 2017 16:23:11 +0000"  >&lt;p&gt;I think I already found the problem. A stupid mistake: the precondition that I introduced in the fix was inverted &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16061178" author="cresny@gmail.com" created="Fri, 23 Jun 2017 16:24:37 +0000"  >&lt;p&gt;ok I&apos;ll wait on your push&lt;/p&gt;</comment>
                            <comment id="16061190" author="srichter" created="Fri, 23 Jun 2017 16:35:27 +0000"  >&lt;p&gt;Alright, it wasn&apos;t the precondition. I have pushed the version that runs as expected in my local testing. Log statements are included.&lt;/p&gt;</comment>
                            <comment id="16061216" author="cresny@gmail.com" created="Fri, 23 Jun 2017 16:52:45 +0000"  >&lt;p&gt;ok, will try that. meanwhile here is a run (and hang) from last push.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/cresny/8d0d24b1bd72031a515bd9a3822da189&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/cresny/8d0d24b1bd72031a515bd9a3822da189&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16061257" author="cresny@gmail.com" created="Fri, 23 Jun 2017 17:24:52 +0000"  >&lt;p&gt;I ran with your newer precondition. It actually succeeded once, but failed the next two runs, hung on org.apache.flink.runtime.state.SharedStateRegistry  - Attempt to register for key WindowOperator...  &lt;/p&gt;

&lt;p&gt;I tried with just a a single slot, but that also hung. The log above represents the hang condition.&lt;/p&gt;

&lt;p&gt;All the above logged here &lt;a href=&quot;https://gist.github.com/cresny/0e109f843730b64d3a330f8fb06bb8a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/cresny/0e109f843730b64d3a330f8fb06bb8a6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The good news is there was an exception around state registry&lt;/p&gt;</comment>
                            <comment id="16061270" author="cresny@gmail.com" created="Fri, 23 Jun 2017 17:37:07 +0000"  >&lt;p&gt;looks likes it&apos;s still trying to register a Placeholder?&lt;/p&gt;</comment>
                            <comment id="16061291" author="srichter" created="Fri, 23 Jun 2017 17:47:46 +0000"  >&lt;p&gt;Those placeholder messages look ok and expected, that happens when the placeholder is exchanged with the original state handle. The exception on unregistration looks promising. Will dig into this on monday. Thanks again for the logs!&lt;/p&gt;</comment>
                            <comment id="16063653" author="srichter" created="Mon, 26 Jun 2017 19:41:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cresny%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;cresny@gmail.com&quot;&gt;cresny@gmail.com&lt;/a&gt; I think I have figured out the second problem. Updated my branch.&lt;/p&gt;</comment>
                            <comment id="16063768" author="cresny@gmail.com" created="Mon, 26 Jun 2017 20:51:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt; So far, looks good! I need to leave early today but I&apos;ll hit it a few more times this evening just to be sure. &lt;/p&gt;</comment>
                            <comment id="16064079" author="cresny@gmail.com" created="Tue, 27 Jun 2017 01:22:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt; Looks good from this end, all tests passed. Thanks!&lt;/p&gt;</comment>
                            <comment id="16064532" author="githubbot" created="Tue, 27 Jun 2017 09:22:08 +0000"  >&lt;p&gt;GitHub user StefanRRichter opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6964&quot; title=&quot;Fix recovery for incremental checkpoints in StandaloneCompletedCheckpointStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6964&quot;&gt;&lt;del&gt;FLINK-6964&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;checkpoint&amp;#93;&lt;/span&gt; Fix externalized incremental checkpoints fo&#8230;&lt;/p&gt;

&lt;p&gt;    This PR fixes a problem that came up with incremental checkpoints and the `StandaloneCompletedCheckpointStore`. After restoring from an externalized incremental checkpoint, the following incremental checkpoints failed to pickup the existing incremental states in the registry that have been restored from the checkpoint. As a second problem, the used operator identifier in the backend could change across restores.&lt;/p&gt;

&lt;p&gt;    This PR:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;registeres restored state from externalized checkpoints/savepoint with the `SharedStateRegistry`&lt;/li&gt;
	&lt;li&gt;introduced artifical backend identifiers to isolate files from differen backends with the same file name in the 
{SharedStateRegistry}
&lt;p&gt;. In case of a (non-rescaled) restore, the identifier is picked up again from the previous state.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StefanRRichter/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StefanRRichter/flink&lt;/a&gt; fixRecoverStandaloneCompeltedCheckpointStore&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4192&lt;/p&gt;

&lt;hr /&gt;

&lt;hr /&gt;</comment>
                            <comment id="16082373" author="githubbot" created="Tue, 11 Jul 2017 15:21:14 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r126720581&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r126720581&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/savepoint/SavepointV2Serializer.java &amp;#8212;&lt;br/&gt;
    @@ -391,7 +392,7 @@ private static KeyedStateHandle deserializeKeyedStateHandle(DataInputStream dis)&lt;br/&gt;
     			Map&amp;lt;StateHandleID, StreamStateHandle&amp;gt; privateStates = deserializeStreamStateHandleMap(dis);&lt;/p&gt;

&lt;p&gt;     			return new IncrementalKeyedStateHandle(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;operatorId,&lt;br/&gt;
    +				UUID.fromString(operatorId),
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This is not an operator ID anymore, right? Probably the local variable name should change.&lt;/p&gt;</comment>
                            <comment id="16082374" author="githubbot" created="Tue, 11 Jul 2017 15:21:15 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r126721791&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r126721791&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/ZooKeeperCompletedCheckpointStoreTest.java &amp;#8212;&lt;br/&gt;
    @@ -160,9 +162,12 @@ public Void answer(InvocationOnMock invocation) throws Throwable {&lt;br/&gt;
     			stateStorage,&lt;br/&gt;
     			Executors.directExecutor());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;SharedStateRegistry sharedStateRegistry = new SharedStateRegistry();&lt;br/&gt;
    +		SharedStateRegistry sharedStateRegistry = spy(new SharedStateRegistry());&lt;br/&gt;
     		zooKeeperCompletedCheckpointStore.recover(sharedStateRegistry);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +		verify(retrievableStateHandle1.retrieveState(), times(1)).registerSharedStatesAfterRestored(sharedStateRegistry);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Was the bug in the zookeeper checkpoint store or the standalone checkpoint store? Should there also be a test for the standalone checkpoint store to verify that it works now?&lt;/p&gt;</comment>
                            <comment id="16082389" author="githubbot" created="Tue, 11 Jul 2017 15:31:59 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r126725439&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r126725439&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/ZooKeeperCompletedCheckpointStoreTest.java &amp;#8212;&lt;br/&gt;
    @@ -160,9 +162,12 @@ public Void answer(InvocationOnMock invocation) throws Throwable {&lt;br/&gt;
     			stateStorage,&lt;br/&gt;
     			Executors.directExecutor());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;SharedStateRegistry sharedStateRegistry = new SharedStateRegistry();&lt;br/&gt;
    +		SharedStateRegistry sharedStateRegistry = spy(new SharedStateRegistry());&lt;br/&gt;
     		zooKeeperCompletedCheckpointStore.recover(sharedStateRegistry);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +		verify(retrievableStateHandle1.retrieveState(), times(1)).registerSharedStatesAfterRestored(sharedStateRegistry);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The behaviour that is tested here is not strongly connected to the bug, I just noticed it might be also worth checking to avoid future problems. &lt;tt&gt;StandaloneCompletedCheckpointStore&lt;/tt&gt; is not expected to do this, so there is no need for a this particular test.&lt;/p&gt;

&lt;p&gt;    The question for a general test is valid. However, I noticed that externalized checkpoints in general are not tested at all, so this is not just a small addition but a whole new test (including some required test methods to trigger and restore from externalized checkpoints in the JM) that would almost justify a new planning task and PR.&lt;/p&gt;</comment>
                            <comment id="16082390" author="githubbot" created="Tue, 11 Jul 2017 15:32:48 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r126725696&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r126725696&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/savepoint/SavepointV2Serializer.java &amp;#8212;&lt;br/&gt;
    @@ -391,7 +392,7 @@ private static KeyedStateHandle deserializeKeyedStateHandle(DataInputStream dis)&lt;br/&gt;
     			Map&amp;lt;StateHandleID, StreamStateHandle&amp;gt; privateStates = deserializeStreamStateHandleMap(dis);&lt;/p&gt;

&lt;p&gt;     			return new IncrementalKeyedStateHandle(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;operatorId,&lt;br/&gt;
    +				UUID.fromString(operatorId),
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    That is correct.&lt;/p&gt;</comment>
                            <comment id="16083667" author="githubbot" created="Wed, 12 Jul 2017 08:57:46 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r126899001&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r126899001&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/ZooKeeperCompletedCheckpointStoreTest.java &amp;#8212;&lt;br/&gt;
    @@ -160,9 +162,12 @@ public Void answer(InvocationOnMock invocation) throws Throwable {&lt;br/&gt;
     			stateStorage,&lt;br/&gt;
     			Executors.directExecutor());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;SharedStateRegistry sharedStateRegistry = new SharedStateRegistry();&lt;br/&gt;
    +		SharedStateRegistry sharedStateRegistry = spy(new SharedStateRegistry());&lt;br/&gt;
     		zooKeeperCompletedCheckpointStore.recover(sharedStateRegistry);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +		verify(retrievableStateHandle1.retrieveState(), times(1)).registerSharedStatesAfterRestored(sharedStateRegistry);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Ok, then we have to do that before we can merge this with confidence.&lt;/p&gt;</comment>
                            <comment id="16085623" author="githubbot" created="Thu, 13 Jul 2017 12:19:34 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @aljoscha @StephanEwen I have added an IT case for this problem. It is testing a sequence externalized checkpoint recoveries, using full and incremental checkpoints on standalone and zookeeper completed checkpoint store.&lt;/p&gt;</comment>
                            <comment id="16085791" author="githubbot" created="Thu, 13 Jul 2017 14:47:33 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This looks super nice now! I tried it and disabled each of the two fixes (registering shared state after restore and backend UUIDs) and reverting either made the new integration test fail.&lt;/p&gt;

&lt;p&gt;    Let&apos;s give @StephanEwen some time to look over this as well but from my side this LGTM now.&lt;/p&gt;

&lt;p&gt;    When merging, the changes to `SharedStateRegistry` and `ZooKeeperCompletedCheckpointStoreTest` should be factored out into a separate commit. They are good changes but unrelated to the Jira issue and bug that this fixes.&lt;/p&gt;</comment>
                            <comment id="16087049" author="githubbot" created="Fri, 14 Jul 2017 08:53:42 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r127407687&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r127407687&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/state/IncrementalKeyedStateHandle.java &amp;#8212;&lt;br/&gt;
    @@ -57,9 +59,9 @@&lt;br/&gt;
     	private static final long serialVersionUID = -8328808513197388231L;&lt;/p&gt;

&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* The operator instance identifier for this handle&lt;br/&gt;
    +	 * UUID to identify the backend which created this state handle. This is used to
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The sentence here is incomplete&lt;/p&gt;</comment>
                            <comment id="16087050" author="githubbot" created="Fri, 14 Jul 2017 08:53:42 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r127406715&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r127406715&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/savepoint/SavepointV2Serializer.java &amp;#8212;&lt;br/&gt;
    @@ -391,7 +392,7 @@ private static KeyedStateHandle deserializeKeyedStateHandle(DataInputStream dis)&lt;br/&gt;
     			Map&amp;lt;StateHandleID, StreamStateHandle&amp;gt; privateStates = deserializeStreamStateHandleMap(dis);&lt;/p&gt;

&lt;p&gt;     			return new IncrementalKeyedStateHandle(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;operatorId,&lt;br/&gt;
    +				UUID.fromString(operatorId),
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +1&lt;/p&gt;</comment>
                            <comment id="16087051" author="githubbot" created="Fri, 14 Jul 2017 08:53:42 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r127407228&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r127407228&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/state/IncrementalKeyedStateHandleTest.java &amp;#8212;&lt;br/&gt;
    @@ -187,7 +188,7 @@ public void testSharedStateDeRegistration() throws Exception {&lt;/p&gt;

&lt;p&gt;     	private static IncrementalKeyedStateHandle create(Random rnd) {&lt;br/&gt;
     		return new IncrementalKeyedStateHandle(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;test&quot;,&lt;br/&gt;
    +			UUID.nameUUIDFromBytes(&quot;test&quot;.getBytes()),
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We need to always pass an explicit charset when converting between strings/bytes:&lt;br/&gt;
    ```java&lt;br/&gt;
    &quot;test&quot;.getBytes(StandardCharsets.UTF_8);&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16087167" author="githubbot" created="Fri, 14 Jul 2017 10:44:58 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r127431267&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r127431267&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/state/IncrementalKeyedStateHandleTest.java &amp;#8212;&lt;br/&gt;
    @@ -187,7 +188,7 @@ public void testSharedStateDeRegistration() throws Exception {&lt;/p&gt;

&lt;p&gt;     	private static IncrementalKeyedStateHandle create(Random rnd) {&lt;br/&gt;
     		return new IncrementalKeyedStateHandle(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;test&quot;,&lt;br/&gt;
    +			UUID.nameUUIDFromBytes(&quot;test&quot;.getBytes()),
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I know that this is true for real code, but for the test, it shouldn&apos;t matter?&lt;/p&gt;</comment>
                            <comment id="16087231" author="githubbot" created="Fri, 14 Jul 2017 12:08:23 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @aljoscha and @StephanEwen for the thorough review &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I will merge this once Travis is green.&lt;/p&gt;</comment>
                            <comment id="16087295" author="githubbot" created="Fri, 14 Jul 2017 13:13:41 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r127453095&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r127453095&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/state/IncrementalKeyedStateHandleTest.java &amp;#8212;&lt;br/&gt;
    @@ -187,7 +188,7 @@ public void testSharedStateDeRegistration() throws Exception {&lt;/p&gt;

&lt;p&gt;     	private static IncrementalKeyedStateHandle create(Random rnd) {&lt;br/&gt;
     		return new IncrementalKeyedStateHandle(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;test&quot;,&lt;br/&gt;
    +			UUID.nameUUIDFromBytes(&quot;test&quot;.getBytes()),
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Let&apos;s set the right example for everyone that &quot;learns by reading&quot; other code.&lt;br/&gt;
    Also, we have seen cases where tests were unstable when executed on an Italian Laptop because of different default locales and charsets &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16087298" author="githubbot" created="Fri, 14 Jul 2017 13:15:04 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192#discussion_r127453343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192#discussion_r127453343&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/state/IncrementalKeyedStateHandleTest.java &amp;#8212;&lt;br/&gt;
    @@ -187,7 +188,7 @@ public void testSharedStateDeRegistration() throws Exception {&lt;/p&gt;

&lt;p&gt;     	private static IncrementalKeyedStateHandle create(Random rnd) {&lt;br/&gt;
     		return new IncrementalKeyedStateHandle(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;test&quot;,&lt;br/&gt;
    +			UUID.nameUUIDFromBytes(&quot;test&quot;.getBytes()),
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Alright &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I already fixed it.&lt;/p&gt;</comment>
                            <comment id="16087460" author="githubbot" created="Fri, 14 Jul 2017 15:17:39 +0000"  >&lt;p&gt;Github user StefanRRichter closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4192&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16087464" author="srichter" created="Fri, 14 Jul 2017 15:19:08 +0000"  >&lt;p&gt;Merged in 8cff17fcc9.&lt;/p&gt;</comment>
                            <comment id="16088028" author="aljoscha" created="Fri, 14 Jul 2017 20:41:30 +0000"  >&lt;p&gt;Please only close once the fix is merged both on &lt;tt&gt;release-1.3&lt;/tt&gt; and master, so that we can accurately track the open blocker issues for Flink 1.3.2.&lt;/p&gt;</comment>
                            <comment id="16092872" author="aljoscha" created="Wed, 19 Jul 2017 09:46:10 +0000"  >&lt;p&gt;Implemented on release-1.3 in&lt;br/&gt;
4b003eafdeccf0179511f3cd4a6f3f5bc63cf921&lt;/p&gt;</comment>
                            <comment id="16093544" author="gyfora" created="Wed, 19 Jul 2017 18:06:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanrichter83%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;stefanrichter83@gmail.com&quot;&gt;stefanrichter83@gmail.com&lt;/a&gt; I am trying to restore with a checkpoint taken before this fix and I a get this error:&lt;/p&gt;

&lt;p&gt;Caused by: java.lang.IllegalArgumentException: Invalid UUID string: WindowOperator_26_0&lt;br/&gt;
	at java.util.UUID.fromString(UUID.java:194)&lt;br/&gt;
	at org.apache.flink.runtime.checkpoint.savepoint.SavepointV2Serializer.deserializeKeyedStateHandle(SavepointV2Serializer.java:395)&lt;br/&gt;
	at org.apache.flink.runtime.checkpoint.savepoint.SavepointV2Serializer.deserializeSubtaskState(SavepointV2Serializer.java:290)&lt;br/&gt;
	at org.apache.flink.runtime.checkpoint.savepoint.SavepointV2Serializer.deserialize(SavepointV2Serializer.java:173)&lt;br/&gt;
	at org.apache.flink.runtime.checkpoint.savepoint.SavepointV2Serializer.deserialize(SavepointV2Serializer.java:67)&lt;br/&gt;
	at org.apache.flink.runtime.checkpoint.savepoint.SavepointStore.loadSavepointWithHandle(SavepointStore.java:277)&lt;br/&gt;
	at org.apache.flink.runtime.checkpoint.savepoint.SavepointLoader.loadAndValidateSavepoint(SavepointLoader.java:69)&lt;br/&gt;
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.restoreSavepoint(CheckpointCoordinator.java:1132)&lt;/p&gt;

&lt;p&gt;Have you seen this before?&lt;/p&gt;</comment>
                            <comment id="16093626" author="gyfora" created="Wed, 19 Jul 2017 19:11:09 +0000"  >&lt;p&gt;I wonder if creating a new random backend UID for these incremental handles would just work.&lt;/p&gt;</comment>
                            <comment id="16094343" author="gyfora" created="Thu, 20 Jul 2017 08:20:18 +0000"  >&lt;p&gt;Something like: &lt;a href=&quot;https://github.com/gyfora/flink/commit/61dcde87fa3efd9c717d2eb4123fa27f09b2250c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/gyfora/flink/commit/61dcde87fa3efd9c717d2eb4123fa27f09b2250c&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16094362" author="srichter" created="Thu, 20 Jul 2017 08:35:33 +0000"  >&lt;p&gt;Yeah, originally I had just a string there and switched UUID to make it more typesafe. This is trivial to fix so if it helps people that try to migrate via externalized checkpoints, why not. I would extend the fix to catch &lt;tt&gt;Exception&lt;/tt&gt; in general, because more parsing problems than the one leading to &lt;tt&gt;IllegalArgumentException&lt;/tt&gt; can happen along the way. Thanks for reporting this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 17 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3gjcv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>