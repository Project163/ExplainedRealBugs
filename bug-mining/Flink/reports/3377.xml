<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:41:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14302] FlinkKafkaInternalProducer should not send `ADD_PARTITIONS_TO_TXN` request if `newPartitionsInTransaction` is empty when enable EoS</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14302</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;As the survey in this mailing list thread &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, kafka server will bind the error with topic-partition list when it handles `AddPartitionToTxnRequest`. So when the request body contains no topic-partition, the error won&apos;t be sent back to kafka producer client. Moreover, it producer internal api, it always check if `newPartitionsInTransaction` is empty before sending ADD_PARTITIONS_TO_TXN request to kafka cluster. We should apply it as well if you need to explicitly call it in the first commit phase of two-phase commit sink.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Kafka-producer-failed-with-InvalidTxnStateException-when-performing-commit-transaction-td29384.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Kafka-producer-failed-with-InvalidTxnStateException-when-performing-commit-transaction-td29384.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13259834">FLINK-14302</key>
            <summary>FlinkKafkaInternalProducer should not send `ADD_PARTITIONS_TO_TXN` request if `newPartitionsInTransaction` is empty when enable EoS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tonywei">Wei-Che Wei</assignee>
                                    <reporter username="tonywei">Wei-Che Wei</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 1 Oct 2019 08:04:39 +0000</created>
                <updated>Thu, 31 Oct 2019 10:27:55 +0000</updated>
                            <resolved>Thu, 31 Oct 2019 10:27:55 +0000</resolved>
                                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Connectors / Kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16941640" author="tonywei" created="Tue, 1 Oct 2019 08:44:34 +0000"  >&lt;p&gt;Sorry for that I didn&apos;t notice that the contribution flow has changed. And I already sent a PR for this issue, but couldn&apos;t assign it to myself.&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; &lt;br/&gt;
 If you have free time, please help me to verify if the issue in mailing list thread I mentioned is a bug, and should it be fix like I suggested?&lt;br/&gt;
 If this is a bug, and the solution is good to you, please assign this Jira issue to me. Thanks.&lt;/p&gt;</comment>
                            <comment id="16945485" author="becket_qin" created="Sun, 6 Oct 2019 23:47:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tonywei&quot; class=&quot;user-hover&quot; rel=&quot;tonywei&quot;&gt;tonywei&lt;/a&gt;&#160;Really sorry for the late response. I was on a business trip and just saw this ping. Thanks for keeping debugging this. The current way Flink constructs the KafkaProducer on recovery is indeed a little flaky. I am not sure if the NOT_COORDINATOR error code was caused by empty partition list in AddPartitionsToTxnRequest.&lt;/p&gt;

&lt;p&gt;More specifically, I am not sure why the following log was printed.&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;kafka-broker-1:&lt;/b&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;2019-09-20 02:31:46,182&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;TransactionCoordinator id=1&amp;#93;&lt;/span&gt; Initialized transactionalId map -&amp;gt; Sink: sink-2e588ce1c86a9d46e2e85186773ce4fd-3 with producerId 1008 and producer epoch 1 on partition __transaction_state-37 (kafka.coordinator.transaction.TransactionCoordinator)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2019-09-20 02:32:45,962&amp;#93;&lt;/span&gt; DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;TransactionCoordinator id=1&amp;#93;&lt;/span&gt; Returning NOT_COORDINATOR error code to client for map -&amp;gt; Sink: sink-2e588ce1c86a9d46e2e85186773ce4fd-3&apos;s AddPartitions request (kafka.coordinator.transaction.TransactionCoordinator)&lt;/b&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2019-09-20 02:32:46,453&amp;#93;&lt;/span&gt; DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;TransactionCoordinator id=1&amp;#93;&lt;/span&gt; Aborting append of COMMIT to transaction log with coordinator and returning NOT_COORDINATOR error to client for map -&amp;gt; Sink: sink-2e588ce1c86a9d46e2e85186773ce4fd-3&apos;s EndTransaction request (kafka.coordinator.transaction.TransactionCoordinator)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Can you double check the version of the Kafka broker? I&apos;d like to reproduce the problem if possible.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="16945515" author="tonywei" created="Mon, 7 Oct 2019 01:00:33 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;The root cause of NOT_COORDINATOR is not from empty&#160; partition list.&lt;/p&gt;

&lt;p&gt;It is due to that broker who host the original transaction coordinator was restarted. The error should be propagate to client to refetch new coordinator, but the error will be bind with each element of partition list. Since this list was empty, the error got lost in response message. And that lead to the following commit failed.&#160;&lt;/p&gt;

&lt;p&gt;For more information, you can refer to my replys in the mailing thread. Thanks.&#160;&lt;/p&gt;</comment>
                            <comment id="16947123" author="becket_qin" created="Tue, 8 Oct 2019 18:46:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tonywei&quot; class=&quot;user-hover&quot; rel=&quot;tonywei&quot;&gt;tonywei&lt;/a&gt;&#160;Thanks for the explanation. I am still a little confused. From the source code it looks the log I mentioned should be printed in &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, but it looks that this logging should never see NOT_COORDINATOR error code.&lt;/p&gt;

&lt;p&gt;In any case, I think it is a good idea to ensure on the Flink side we are not committing empty transactions. However, technically speaking, the Kafka brokers should not assume the behavior of the clients because there could be 3rd party Kafka clients implementations. So I think there should be a fix on the Kafka side as well. But that might be a protocol change to add an error field in &lt;tt&gt;AddPartitionsToTxnResponse&lt;/tt&gt;. We can leave it as is for now.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala#L268&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala#L268&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16947309" author="tonywei" created="Wed, 9 Oct 2019 01:51:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;I think the error was from `txnManager.getTransactionState(transactionalId)` &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;You are right. Maybe we can report this issue back to kafka community as well. For now, could we conclude the temporary solution that we should prevent from committing empty transaction? I have opened a pull request already. Could you help me review it and give me advice? I had a problem about how to add an integration test on it. Thanks.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&#160;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala#L239&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala#L239&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16947388" author="becket_qin" created="Wed, 9 Oct 2019 06:27:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tonywei&quot; class=&quot;user-hover&quot; rel=&quot;tonywei&quot;&gt;tonywei&lt;/a&gt;&#160;Ah, you are right. I apparently misunderstood the behavior of Scala Either here.&#160;&lt;/p&gt;

&lt;p&gt;I just left some ideas on how to test this case in the PR.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z076lk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>