<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:19:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-33541] RAND_INTEGER  can&apos;t be existed in a IF statement</title>
                <link>https://issues.apache.org/jira/browse/FLINK-33541</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The minimum produce steps:&lt;/p&gt;

&lt;p&gt;Flink SQL&amp;gt; select if(1=1, rand_integer(100), 0);&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; Could not execute SQL statement. Reason:&lt;br/&gt;
java.lang.Exception: Unsupported operand types: IF(boolean, INT, INT NOT NULL)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;But we do not see the exception reported in 1.14, not sure which version this bug was introduced.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13557861">FLINK-33541</key>
            <summary>RAND_INTEGER  can&apos;t be existed in a IF statement</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xuyangzhong">Xuyang Zhong</assignee>
                                    <reporter username="dianer17">Guojun Li</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 14 Nov 2023 10:45:45 +0000</created>
                <updated>Fri, 15 Dec 2023 15:24:43 +0000</updated>
                            <resolved>Fri, 15 Dec 2023 15:24:43 +0000</resolved>
                                    <version>1.17.0</version>
                    <version>1.18.0</version>
                                    <fixVersion>1.19.0</fixVersion>
                    <fixVersion>1.18.1</fixVersion>
                    <fixVersion>1.17.3</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17785864" author="martijnvisser" created="Tue, 14 Nov 2023 12:08:17 +0000"  >&lt;p&gt;Isn&apos;t this by design, per the 1.15 release notes? &lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-master/release-notes/flink-1.15/#table-api--sql&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nightlies.apache.org/flink/flink-docs-master/release-notes/flink-1.15/#table-api--sql&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17785940" author="libenchao" created="Tue, 14 Nov 2023 15:43:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; Could you point out the ticket number you are referring to? I didn&apos;t find one in the 1.15 release note.&lt;/p&gt;</comment>
                            <comment id="17788263" author="xuyangzhong" created="Tue, 21 Nov 2023 06:03:23 +0000"  >&lt;p&gt;The root cause is that in 1.14, the cast rule allow to cast from &apos;int&apos; to &apos;int nullable&apos;. However in 1.15, the new built-in cast rule has more strict restrictions on this situation. The difference about code can be found as follows.&lt;/p&gt;

&lt;p&gt;1.14:&#160;PlannerTypeUtils&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * Can the two types operate with each other. Such as: 1.CodeGen: equal, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;, assignment.
 * 2.Join keys.
 */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isInteroperable(LogicalType t1, LogicalType t2) {
    &lt;span class=&quot;code-comment&quot;&gt;// ......
&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t1.getTypeRoot() != t2.getTypeRoot()) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (t1.getTypeRoot()) {
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; ARRAY:
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; MAP:
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; MULTISET:
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; ROW:
            List&amp;lt;LogicalType&amp;gt; children1 = t1.getChildren();
            List&amp;lt;LogicalType&amp;gt; children2 = t2.getChildren();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (children1.size() != children2.size()) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; children1.size(); i++) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isInteroperable(children1.get(i), children2.get(i))) {
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
                }
            }
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;:
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; t1.copy(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).equals(t2.copy(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)); &lt;span class=&quot;code-comment&quot;&gt;// difference
&lt;/span&gt;    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;


&lt;p&gt;1.15: NumericPrimitiveCastRule&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; matches(LogicalType input, LogicalType target) {
    &lt;span class=&quot;code-comment&quot;&gt;// Exclude identity casting
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (input.is(target.getTypeRoot())) { &lt;span class=&quot;code-comment&quot;&gt;// difference
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    }

    &lt;span class=&quot;code-comment&quot;&gt;// Conversions between primitive numerics
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((input.is(INTEGER_NUMERIC) || input.is(APPROXIMATE_NUMERIC))
            &amp;amp;&amp;amp; (target.is(INTEGER_NUMERIC) || target.is(APPROXIMATE_NUMERIC))) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }

    &lt;span class=&quot;code-comment&quot;&gt;// ......    
&lt;/span&gt;} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17788266" author="xuyangzhong" created="Tue, 21 Nov 2023 06:11:14 +0000"  >&lt;p&gt;Maybe we should add the logic back in&#160;IfCallGen#generate. If we agree on this, l&#8216;ll try to fix this bug. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=libenchao&quot; class=&quot;user-hover&quot; rel=&quot;libenchao&quot;&gt;libenchao&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17788340" author="libenchao" created="Tue, 21 Nov 2023 09:37:02 +0000"  >&lt;p&gt;I haven&apos;t looked into the details yet. One general thought is, &lt;tt&gt;IF&lt;/tt&gt;&apos;s operand type checker should allow operands which can derive a common type, &lt;tt&gt;INT&lt;/tt&gt; and &lt;tt&gt;INT NOT NULL&lt;/tt&gt; are definitely have a common type &lt;tt&gt;INT&lt;/tt&gt;, so we should allow it. No matter how we transformed &lt;tt&gt;IF&lt;/tt&gt; into other forms, it should not break this assumption.&lt;/p&gt;

&lt;p&gt;Feel free to summit a PR to fix it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuyangzhong&quot; class=&quot;user-hover&quot; rel=&quot;xuyangzhong&quot;&gt;xuyangzhong&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="17788993" author="xuyangzhong" created="Thu, 23 Nov 2023 06:22:26 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=libenchao&quot; class=&quot;user-hover&quot; rel=&quot;libenchao&quot;&gt;libenchao&lt;/a&gt;&#160; when I try to fix it and add tests, I notice currently the CAST rule is correct. It forbids casting from not null to nullable.&#160; The root cause is not IF but is RAND_INTEGER. The details are added in the pr. Just copy it here.&lt;/p&gt;

&lt;p&gt;Currently RAND and RAND_INTEGER are always return type &quot;NOT NULL&quot; as built in functions in&#160;&lt;tt&gt;FlinkSqlOperatorTable&lt;/tt&gt; during validation. But when codegen, the result type is always nullable in &lt;tt&gt;RandCallGen&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Actually, the result type of RAND and RAND_INTEGER should depend on the types of arguments. For example, If the argument is nullable, the return type should be nullable.&lt;/p&gt;

&lt;p&gt;This bug causes the error with pattern &quot;IF(1 = 1, RAND(0), 0)&quot;, because the following logic:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the result type of RAND is always &quot;not null&quot; when validation in&#160;&lt;tt&gt;FlinkSqlOperatorTable&lt;/tt&gt;, and the third param is 0 that is always &quot;not null&quot;, so the return type of operator IF is always &quot;not null&quot;.&lt;/li&gt;
	&lt;li&gt;when codegen operator RAND, the return type of RAND(0) is always &quot;nullable&quot; in `&lt;tt&gt;RandCallGen&lt;/tt&gt;`.&lt;/li&gt;
	&lt;li&gt;when codegen operator IF, the CAST rule cannot cast from &quot;nullable&quot; (the second arg RAND) to &quot;not null&quot;(the result type), so the exception throws.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The pr is available, I&apos;m grateful if you can help review it.&lt;/p&gt;</comment>
                            <comment id="17789325" author="libenchao" created="Fri, 24 Nov 2023 05:14:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;I notice currently the CAST rule is correct. It forbids casting from not null to nullable. The root cause is not IF but is RAND_INTEGER&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t agree on this, casting not null to nullable should be valid. The opposite should be invalid.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Actually, the result type of RAND and RAND_INTEGER should depend on the types of arguments.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In this case, the argument is literal which is not null, so the result type is not null is ok. And I don&apos;t see many usages to pass in a nullable field as argument.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;when codegen operator RAND, the return type of RAND(0) is always &quot;nullable&quot; in `RandCallGen`.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Isn&apos;t this is the root cause?&lt;/p&gt;</comment>
                            <comment id="17789330" author="xuyangzhong" created="Fri, 24 Nov 2023 05:44:38 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=libenchao&quot; class=&quot;user-hover&quot; rel=&quot;libenchao&quot;&gt;libenchao&lt;/a&gt; , I checked the code again and sorry for this mistake. It forbids CAST from nullable to not null in `LogicalTypeCasts#defaultMethod` and I think this is reasonable.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13064656/13064656_image-2023-11-24-13-31-21-209.png&quot; height=&quot;325&quot; width=&quot;489&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In this case, the argument is literal which is not null, so the result type is not null is ok. And I don&apos;t see many usages to pass in a nullable field as argument.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;For example, we have a table with column &quot;a int not null&quot; and &quot;b int&quot;. I think the result type with RAND(a, 10) and RAND(b, 10) is different. The former is int not null and the latter is int. This difference will and should also affect the result type about its output.&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&#160;Isn&apos;t this is the root cause?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The inconsistence about the behavior for result type during validation and code generation in RAND and RAND_INTEGER causes this bug.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Look for your thoughts : )&lt;/p&gt;</comment>
                            <comment id="17789334" author="libenchao" created="Fri, 24 Nov 2023 06:05:40 +0000"  >&lt;p&gt;There is no such usage: &quot;RAND(a, 10) and RAND(b, 10) &quot;.&lt;/p&gt;

&lt;p&gt;The usages for RAND is &quot;RAND() and RAND(seed)&quot;&#160;&lt;/p&gt;</comment>
                            <comment id="17789383" author="xuyangzhong" created="Fri, 24 Nov 2023 08:58:20 +0000"  >&lt;p&gt;You&apos;re right, sorry about typo for it. What I want to express is that a column can be used as seed and bound in RAND_INTEGER or seed in RAND, and it may be nullable or not null.&lt;/p&gt;</comment>
                            <comment id="17789405" author="libenchao" created="Fri, 24 Nov 2023 09:37:36 +0000"  >&lt;p&gt;It&apos;s clear now~&lt;/p&gt;</comment>
                            <comment id="17797226" author="libenchao" created="Fri, 15 Dec 2023 15:24:43 +0000"  >&lt;p&gt;Fixed via:&lt;br/&gt;
master(1.19.0): 45f966e8c3c5e903b3843391874f7d2478122d8c&lt;br/&gt;
1.18.1: d60818150005661006a71e4155fc605d7543362b&lt;br/&gt;
1.17.3: 58f8162613d9f615e60fb0c9e23692d25469d6f0&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuyangzhong&quot; class=&quot;user-hover&quot; rel=&quot;xuyangzhong&quot;&gt;xuyangzhong&lt;/a&gt; for the fix and thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dianer17&quot; class=&quot;user-hover&quot; rel=&quot;dianer17&quot;&gt;dianer17&lt;/a&gt; for reporting the issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13064656" name="image-2023-11-24-13-31-21-209.png" size="816129" author="xuyangzhong" created="Fri, 24 Nov 2023 05:31:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 47 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ll80:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>