<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:58:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-22819] YARNFileReplicationITCase fails with &quot;The YARN application unexpectedly switched to state FAILED during deployment&quot;</title>
                <link>https://issues.apache.org/jira/browse/FLINK-22819</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=18467&amp;amp;view=logs&amp;amp;j=8fd975ef-f478-511d-4997-6f15fe8a1fd3&amp;amp;t=ac0fa443-5d45-5a6b-3597-0310ecc1d2ab&amp;amp;l=32007&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=18467&amp;amp;view=logs&amp;amp;j=8fd975ef-f478-511d-4997-6f15fe8a1fd3&amp;amp;t=ac0fa443-5d45-5a6b-3597-0310ecc1d2ab&amp;amp;l=32007&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
May 31 23:14:22 org.apache.flink.client.deployment.ClusterDeploymentException: Could not deploy Yarn job cluster.
May 31 23:14:22 	at org.apache.flink.yarn.YarnClusterDescriptor.deployJobCluster(YarnClusterDescriptor.java:481)
May 31 23:14:22 	at org.apache.flink.yarn.YARNFileReplicationITCase.deployPerJob(YARNFileReplicationITCase.java:106)
May 31 23:14:22 	at org.apache.flink.yarn.YARNFileReplicationITCase.lambda$testPerJobModeWithDefaultFileReplication$1(YARNFileReplicationITCase.java:78)
May 31 23:14:22 	at org.apache.flink.yarn.YarnTestBase.runTest(YarnTestBase.java:287)
May 31 23:14:22 	at org.apache.flink.yarn.YARNFileReplicationITCase.testPerJobModeWithDefaultFileReplication(YARNFileReplicationITCase.java:78)
May 31 23:14:22 	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
May 31 23:14:22 	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
May 31 23:14:22 	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
May 31 23:14:22 	at java.lang.reflect.Method.invoke(Method.java:498)
May 31 23:14:22 	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
May 31 23:14:22 	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
May 31 23:14:22 	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
May 31 23:14:22 	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
May 31 23:14:22 	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
May 31 23:14:22 	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
May 31 23:14:22 	at org.apache.flink.util.TestNameProvider$1.evaluate(TestNameProvider.java:45)
May 31 23:14:22 	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
May 31 23:14:22 	at org.junit.rules.RunRules.evaluate(RunRules.java:20)
May 31 23:14:22 	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
May 31 23:14:22 	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)
May 31 23:14:22 	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)
May 31 23:14:22 	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
May 31 23:14:22 	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
May 31 23:14:22 	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
May 31 23:14:22 	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
May 31 23:14:22 	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
May 31 23:14:22 	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
May 31 23:14:22 	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
May 31 23:14:22 	at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48)
May 31 23:14:22 	at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48)
May 31 23:14:22 	at org.junit.rules.RunRules.evaluate(RunRules.java:20)
May 31 23:14:22 	at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
May 31 23:14:22 	at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:365)
May 31 23:14:22 	at org.apache.maven.surefire.junit4.JUnit4Provider.executeWithRerun(JUnit4Provider.java:273)
May 31 23:14:22 	at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:238)
May 31 23:14:22 	at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:159)
May 31 23:14:22 	at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:384)
May 31 23:14:22 	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:345)
May 31 23:14:22 	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:126)
May 31 23:14:22 	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:418)
May 31 23:14:22 Caused by: org.apache.flink.yarn.YarnClusterDescriptor$YarnDeploymentException: The YARN application unexpectedly switched to state FAILED during deployment. 
May 31 23:14:22 Diagnostics from YARN: Application application_1622502732791_0001 failed 1 times (global limit =2; local limit is =1) due to ApplicationMaster &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; attempt appattempt_1622502732791_0001_000001 timed out. Failing the application.
May 31 23:14:22 If log aggregation is enabled on your cluster, use &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; command to further investigate the issue:
May 31 23:14:22 yarn logs -applicationId application_1622502732791_0001
May 31 23:14:22 	at org.apache.flink.yarn.YarnClusterDescriptor.startAppMaster(YarnClusterDescriptor.java:1201)
May 31 23:14:22 	at org.apache.flink.yarn.YarnClusterDescriptor.deployInternal(YarnClusterDescriptor.java:593)
May 31 23:14:22 	at org.apache.flink.yarn.YarnClusterDescriptor.deployJobCluster(YarnClusterDescriptor.java:474)
May 31 23:14:22 	... 39 more

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13381389">FLINK-22819</key>
            <summary>YARNFileReplicationITCase fails with &quot;The YARN application unexpectedly switched to state FAILED during deployment&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dmvk">David Mor&#225;vek</assignee>
                                    <reporter username="dwysakowicz">Dawid Wysakowicz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>stale-major</label>
                            <label>test-stability</label>
                    </labels>
                <created>Tue, 1 Jun 2021 07:17:09 +0000</created>
                <updated>Thu, 23 Sep 2021 18:01:11 +0000</updated>
                            <resolved>Fri, 9 Jul 2021 14:04:55 +0000</resolved>
                                    <version>1.13.1</version>
                                    <fixVersion>1.14.0</fixVersion>
                    <fixVersion>1.12.5</fixVersion>
                    <fixVersion>1.13.2</fixVersion>
                                    <component>Deployment / YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17356280" author="mapohl" created="Thu, 3 Jun 2021 08:19:45 +0000"  >&lt;p&gt;I couldn&apos;t get anything specific during my initial investigation (I attached the test&apos;s logs). We don&apos;t get any additional YARN logs due to the failure happening during application deployment. There is a timeout during deployment as stated in the error messages.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
23:13:00,816 [ContainersLauncher #0] INFO  org.apache.hadoop.yarn.server.nodemanager.DefaultContainerExecutor [] - launchContainer: [bash, /__w/3/s/flink-yarn-tests/target/flink-yarn-tests-per-job/flink-yarn-tests-per-job-localDir-nm-0_0/usercache/agent0
23:13:12,994 [        Ping Checker] INFO  org.apache.hadoop.yarn.util.AbstractLivelinessMonitor        [] - Expired:appattempt_1622502732791_0001_000001 Timed out after 20 secs
23:13:12,996 [AsyncDispatcher event handler] INFO  org.apache.hadoop.yarn.server.resourcemanager.rmapp.attempt.RMAppAttemptImpl [] - Updating application attempt appattempt_1622502732791_0001_000001 with &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; state: FAILED, and exit status: -1000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Comparing it to a successful test of the same build it appears that there is some time consumed (5 secs here) for authentication:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
23:15:52,955 [ContainersLauncher #0] INFO  org.apache.hadoop.yarn.server.nodemanager.DefaultContainerExecutor [] - launchContainer: [bash, /__w/3/s/flink-yarn-tests/target/flink-yarn-tests-capacityscheduler/flink-yarn-tests-capacityscheduler-localDir-nm-
1_0/usercache/agent03_azpcontainer/appcache/application_1622502943279_0001/container_1622502943279_0001_01_000001/default_container_executor.sh]
23:15:57,954 [Socket Reader #1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; port 44617] INFO  SecurityLogger.org.apache.hadoop.ipc.Server                  [] - Auth successful &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; appattempt_1622502943279_0001_000001 (auth:SIMPLE)
23:15:57,977 [IPC Server handler 0 on 44617] INFO  org.apache.hadoop.yarn.server.resourcemanager.ApplicationMasterService [] - AM registration appattempt_1622502943279_0001_000001
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17374142" author="flink-jira-bot" created="Sat, 3 Jul 2021 22:37:37 +0000"  >&lt;p&gt;I am the &lt;a href=&quot;https://github.com/apache/flink-jira-bot/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Flink Jira Bot&lt;/a&gt; and I help the community manage its development. I see this issues has been marked as Major but is unassigned and neither itself nor its Sub-Tasks have been updated for 30 days. I have gone ahead and added a &quot;stale-major&quot; to the issue&quot;. If this ticket is a Major, please either assign yourself or give an update. Afterwards, please remove the label or in 7 days the issue will be deprioritized.&lt;/p&gt;</comment>
                            <comment id="17376531" author="davidmoravek" created="Wed, 7 Jul 2021 12:33:18 +0000"  >&lt;p&gt;The issues is caused by `yarn.am.liveness-monitor.expiry-interval-ms`, that was lowered for yarn test cases. We can think of two reasons, why this options is lowered.&lt;/p&gt;

&lt;p&gt;A) In order to stress, that we&apos;re actually sending heartbeats from ApplicationMaster to YARN Resource Manager.&lt;br/&gt;
B) To make tests fail faster, if user-code that we&apos;re executing inside ApplicationMaster gets stuck for some reason.&lt;/p&gt;

&lt;p&gt;`expiry-interval-ms` for AM works as follows (simplified):&lt;br/&gt;
1) We start a YARN mini cluster + HDFS (where we upload flink jars)&lt;br/&gt;
2) We create a new YARN application and allocated a container for ApplicationMaster. This is the &lt;b&gt;actual startTime for AM expiration check&lt;/b&gt;.&lt;br/&gt;
3) User jars / entrypoints / configs get downloaded from HDFS into ApplicationMaster.&lt;br/&gt;
4) Entrypoint (shell script that starts `YarnJobClusterEntrypoint`) gets executed.&lt;br/&gt;
5) Inside java entrypoint, we construct a YARN Resource Manager Client (`AMRMClientAsync&amp;lt;?&amp;gt;`), which we use for operating YARN cluster. This client also &lt;b&gt;starts sending heartbeats&lt;/b&gt; (it&apos;s a side-effect, no explicit action needs to be taken for sending heartbeats).&lt;/p&gt;

&lt;p&gt;We can see there is a lot of work to be done between 2) and 5) and in resource limited environment, such as CI, 20s may not be enough for registering RM Client with Resource Manager.&lt;/p&gt;

&lt;p&gt;Anyway, I don&apos;t think there is a need for this timeout anymore, because if we wouldn&apos;t start RM Client, tests would fail anyway and by this timeout, we unnecessarily stress YARN&apos;s internal implementation.&lt;/p&gt;

&lt;p&gt;As for potentially long running tests, this should be already solved by timeouts in AZURE pipelines.&lt;/p&gt;

&lt;p&gt;As a fix, I propose to remove this override and use 5m default instead. IMO this option is actually meant just as a safeguard, when AM gets into an &quot;unhandled&quot; state - network failures / unable to shutdown.&lt;/p&gt;</comment>
                            <comment id="17378088" author="till.rohrmann" created="Fri, 9 Jul 2021 14:04:55 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.14.0: 9b4fc49a44920b6d94b8e69a98f3f725e6b63c22&lt;br/&gt;
1.13.2: 3708cc4cf9382f18e2f8e48b91d7c7dac74d607b&lt;br/&gt;
1.12.5: e280421bc1009e2462551e76f81c3ec980cf3f77&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13026301" name="FLINK-22819-YARNFileReplicationITCase-testPerJobModeWithDefaultFileReplication.log" size="182066" author="mapohl" created="Wed, 2 Jun 2021 13:49:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 18 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rj9s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>