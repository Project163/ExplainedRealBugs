<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:07:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19142] Local recovery can be broken if slot hijacking happened during a full restart</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19142</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The ticket originates from &lt;a href=&quot;https://github.com/apache/flink/pull/13181#discussion_r481087221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this PR discussion&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The&#160;previous AllocationIDs are used by&#160;PreviousAllocationSlotSelectionStrategy to schedule subtasks into the slot where they were previously executed before a failover. If the&#160;previous slot (AllocationID) is not available, we do not want subtasks to take previous slots (AllocationIDs) of other subtasks.&lt;/p&gt;

&lt;p&gt;The&#160;MergingSharedSlotProfileRetriever gets all previous AllocationIDs of the bulk from&#160;SlotSharingExecutionSlotAllocator but only from the current bulk. The&#160;previous AllocationIDs of other bulks stay unknown. Therefore, the current bulk can potentially&#160;hijack the&#160;previous slots from the preceding bulks. On the other hand the&#160;previous AllocationIDs of other tasks should be taken if the&#160;other tasks are not going to run at the same time, e.g. not enough resources after failover or other bulks are done.&lt;/p&gt;

&lt;p&gt;Local recovery can be broken due to this. e.g. when multiple regions of a streaming job are restarted at the same time(due to global failover, or task failover with `full` failover strategy).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13326074">FLINK-19142</key>
            <summary>Local recovery can be broken if slot hijacking happened during a full restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zhuzh">Zhu Zhu</assignee>
                                    <reporter username="azagrebin">Andrey Zagrebin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 4 Sep 2020 12:11:45 +0000</created>
                <updated>Wed, 15 Dec 2021 01:44:03 +0000</updated>
                            <resolved>Thu, 9 Dec 2021 02:46:12 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.14.3</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17291566" author="zentol" created="Fri, 26 Feb 2021 10:47:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt; Would you have time to investigate this?&lt;/p&gt;</comment>
                            <comment id="17291576" author="zhuzh" created="Fri, 26 Feb 2021 11:10:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; Yes I will look into it. &lt;/p&gt;</comment>
                            <comment id="17295945" author="zhuzh" created="Fri, 5 Mar 2021 10:13:32 +0000"  >&lt;p&gt;In my understanding, the problem is that &lt;tt&gt;MergingSharedSlotProfileRetriever&lt;/tt&gt; does not properly set the &lt;tt&gt;previousExecutionGraphAllocations&lt;/tt&gt; of a &lt;tt&gt;SlotProfile&lt;/tt&gt;. So that some restarted region may take the previous slots of other failed regions, and the state local recovery will be affected.&lt;/p&gt;

&lt;p&gt;To fix the problem, we need &lt;tt&gt;SlotProfile.previousExecutionGraphAllocations&lt;/tt&gt; to include previous allocationId of all the vertices which need to be restarted at that time.&lt;/p&gt;

&lt;p&gt;The suggestion from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt; to &quot;give to MergingSharedSlotProfileRetriever all previous AllocationIDs of bulks which are going to run at the same time.&quot; is theoretically correct. However, it is not easy for the scheduler to identify which bulks will run at the same time. A simpler solution I can think of is to find all the vertices which are &lt;b&gt;not&lt;/b&gt; DEPLOYING/RUNNING/FINISHED at that moment,  which indicates they may still want their previous slots,  and set their prior allocation IDs to &lt;tt&gt;MergingSharedSlotProfileRetriever&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;WDYT? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17296087" author="till.rohrmann" created="Fri, 5 Mar 2021 15:23:56 +0000"  >&lt;p&gt;How would the system behave if we lose two slots (a and b) which have been used for bulk_1 and bulk_2. Now with the decreased resources bulk_1 and bulk_2 cannot be run concurrently and we need to use slot b for bulk_1 to make it work. Would this also work with your proposal?&lt;/p&gt;</comment>
                            <comment id="17297082" author="zhuzh" created="Mon, 8 Mar 2021 05:43:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; do you mean a case like this? &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Previously bulk_1 uses 2 slot {a1, a2} and bulk_2 uses 2 slots {b1,b2} and there are only these 4 slots in JM slot pool. Later slot a1 and slot b1 get lost, bulk_1 and bulk_2 need to restart. And bulk_1 cannot use b2 and it will need to request one more new slot.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If so, I think it is not a problem for streaming jobs because the job is expected to acquire all required slots at the same time sooner or later.&lt;br/&gt;
For batch jobs, it is a problem that resource deadlocks can happen if newly slot requirements cannot be fulfilled. However, from what I know, local recovery, in which case PreviousAllocationSlotSelectionStrategy is used, is not expected for batch jobs. So maybe we can let the job use LocationPreferenceSlotSelectionStrategy if it is batch job even if local recover is enabled?&lt;/p&gt;</comment>
                            <comment id="17298654" author="till.rohrmann" created="Wed, 10 Mar 2021 08:59:48 +0000"  >&lt;p&gt;You are right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;, for batch jobs this is not required. Then I guess it is ok to do it as you proposed. Let us guard the assumption that we are running a streaming job when doing this, though. This helps to find the place if we should change for which type of jobs local recovery is supported for whatever reason in the future.&lt;/p&gt;</comment>
                            <comment id="17298779" author="zhuzh" created="Wed, 10 Mar 2021 11:58:57 +0000"  >&lt;p&gt;Thanks for the confirmation! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&lt;br/&gt;
Agreed to throw an exception if local recovery is enabled for batch jobs.&lt;br/&gt;
I will prepare a PR for it a bit later.&lt;/p&gt;</comment>
                            <comment id="17322966" author="flink-jira-bot" created="Fri, 16 Apr 2021 10:52:59 +0000"  >&lt;p&gt;This issue is assigned but has not received an update in 7 days so it has been labeled &quot;stale-assigned&quot;. If you are still working on the issue, please give an update and remove the label. If you are no longer working on the issue, please unassign so someone else may work on it. In 7 days the issue will be automatically unassigned.&lt;/p&gt;</comment>
                            <comment id="17324801" author="till.rohrmann" created="Mon, 19 Apr 2021 07:52:20 +0000"  >&lt;p&gt;Zhu Zhu has opened a PR for this issue which waits for review.&lt;/p&gt;</comment>
                            <comment id="17350930" author="till.rohrmann" created="Tue, 25 May 2021 09:21:54 +0000"  >&lt;p&gt;There is a PR available for fixing this problem.&lt;/p&gt;</comment>
                            <comment id="17438675" author="zhuzh" created="Thu, 4 Nov 2021 12:12:00 +0000"  >&lt;p&gt;Fixed in master(1.15):&lt;br/&gt;
4618b6a6e0584fc9054505035bb6a3b4e951c937&lt;br/&gt;
4d9de6c5b826ab482f47f33c8da957ac9b550c32&lt;/p&gt;</comment>
                            <comment id="17439118" author="zhuzh" created="Fri, 5 Nov 2021 09:24:33 +0000"  >&lt;p&gt;I would keep this ticket open for now and keep watching it.&lt;br/&gt;
If there is no problem reported against the fix after some time, I will back port it to 1.14.&lt;/p&gt;</comment>
                            <comment id="17455105" author="till.rohrmann" created="Wed, 8 Dec 2021 10:31:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt; shall we do the backport?&lt;/p&gt;</comment>
                            <comment id="17455181" author="zhuzh" created="Wed, 8 Dec 2021 11:35:19 +0000"  >&lt;p&gt;I think it&apos;s time to do the backport. I&apos;m now doing it. &lt;br/&gt;
I have also updated it in the release 1.14.1 ML.&lt;/p&gt;</comment>
                            <comment id="17456104" author="zhuzh" created="Thu, 9 Dec 2021 02:45:59 +0000"  >&lt;p&gt;1.14:&lt;br/&gt;
63cf221ca2d963aa1394fb0244a8702b9e8c3835&lt;br/&gt;
347becbe43209fb9c65bcc8ae3859a071469e587&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13318945">FLINK-18689</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13410225">FLINK-24793</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13289687">FLINK-16430</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0iciw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>