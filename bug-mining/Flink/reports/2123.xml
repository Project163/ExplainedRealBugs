<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8176] Dispatcher does not start SubmittedJobGraphStore</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8176</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;tt&gt;Dispatcher&lt;/tt&gt; never calls start on its &lt;tt&gt;SubmittedJobGraphStore&lt;/tt&gt; instance. Hence, when a Job is submitted (YARN session mode with HA enabled), an &lt;tt&gt;IllegalStateException&lt;/tt&gt; is thrown:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IllegalStateException: Not running. Forgot to call start()?
        at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195)
        at org.apache.flink.runtime.jobmanager.ZooKeeperSubmittedJobGraphStore.verifyIsRunning(ZooKeeperSubmittedJobGraphStore.java:411)
        at org.apache.flink.runtime.jobmanager.ZooKeeperSubmittedJobGraphStore.putJobGraph(ZooKeeperSubmittedJobGraphStore.java:222)
        at org.apache.flink.runtime.dispatcher.Dispatcher.submitJob(Dispatcher.java:202)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcInvocation(AkkaRpcActor.java:207)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleMessage(AkkaRpcActor.java:151)
        at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleMessage(FencedAkkaRpcActor.java:66)
        at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.lambda$onReceive$0(AkkaRpcActor.java:129)
        at akka.actor.ActorCell$$anonfun$become$1.applyOrElse(ActorCell.scala:544)
        at akka.actor.Actor$class.aroundReceive(Actor.scala:502)
        at akka.actor.UntypedActor.aroundReceive(UntypedActor.scala:95)
        at akka.actor.ActorCell.receiveMessage(ActorCell.scala:526)
        at akka.actor.ActorCell.invoke(ActorCell.scala:495)
        at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:257)
        at akka.dispatch.Mailbox.run(Mailbox.scala:224)
        at akka.dispatch.Mailbox.exec(Mailbox.scala:234)
        at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
        at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
        at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Expected Behavior&lt;/b&gt;&lt;br/&gt;
In &lt;tt&gt;start()&lt;/tt&gt; method, the submittedJobGraphStore should be started as so:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
submittedJobGraphStore.start(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To enable this, the &lt;tt&gt;Dispatcher&lt;/tt&gt; must implement the interface &lt;tt&gt;SubmittedJobGraphStore.SubmittedJobGraphListener&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13121858">FLINK-8176</key>
            <summary>Dispatcher does not start SubmittedJobGraphStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gjy">Gary Yao</assignee>
                                    <reporter username="gjy">Gary Yao</reporter>
                        <labels>
                            <label>flip-6</label>
                    </labels>
                <created>Thu, 30 Nov 2017 09:09:44 +0000</created>
                <updated>Thu, 28 Feb 2019 13:30:07 +0000</updated>
                            <resolved>Wed, 13 Dec 2017 13:27:26 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Deployment / YARN</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16272890" author="githubbot" created="Thu, 30 Nov 2017 16:23:27 +0000"  >&lt;p&gt;GitHub user GJL opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8176&quot; title=&quot;Dispatcher does not start SubmittedJobGraphStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8176&quot;&gt;&lt;del&gt;FLINK-8176&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Start SubmittedJobGraphStore in Dispatcher&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    The FLIP-6 dispatcher never calls `start()` on its SubmittedJobGraphStore instance. Hence, when a Job is submitted (YARN session mode with HA enabled), an IllegalStateException is thrown. This pull request adds the necessary changes so that jobs can be submitted.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Implement SubmittedJobGraphListener interface in Dispatcher&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Added unit tests for new methods in Dispatcher class&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Verified that jobs can be submitted in FLIP-6 YARN session mode with HA. Did not verify anything else.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    CC: @tillrohrmann &lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/GJL/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/GJL/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8176&quot; title=&quot;Dispatcher does not start SubmittedJobGraphStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8176&quot;&gt;&lt;del&gt;FLINK-8176&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5107&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d238ef0c23eea585974929eafdff33af916d19ba&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-11-30T14:37:30Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Extract SubmittedJobGraphStore implementation from JobManagerHARecoveryTest&lt;/p&gt;

&lt;p&gt;commit 33b9d2848c767088f43fed2d03e6402695827221&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-11-30T14:44:23Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8176&quot; title=&quot;Dispatcher does not start SubmittedJobGraphStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8176&quot;&gt;&lt;del&gt;FLINK-8176&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Implement SubmittedJobGraphListener interface in Dispatcher&lt;/p&gt;

&lt;p&gt;    Call start() on SubmittedJobGraphStore with Dispatcher as listener. To enable&lt;br/&gt;
    this, the dispatcher must implement the SubmittedJobGraphListener interface. Add&lt;br/&gt;
    simple unit tests for the new methods. Refactor DispatcherTest to remove&lt;br/&gt;
    redundancy.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16272898" author="githubbot" created="Thu, 30 Nov 2017 16:28:25 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r154128004&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r154128004&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -246,5 +258,11 @@ protected JobManagerRunner createJobManagerRunner(&lt;/p&gt;

&lt;p&gt;     			return jobManagerRunner;&lt;br/&gt;
     		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		protected void runAsync(final Runnable runnable) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think if I can set Akka&apos;s `CallingThreadDispatcher`, this is not needed.&lt;/p&gt;</comment>
                            <comment id="16274256" author="githubbot" created="Fri, 1 Dec 2017 11:07:10 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r154320903&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r154320903&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -117,84 +135,78 @@ public void testJobSubmission() throws Exception {&lt;br/&gt;
     			heartbeatServices,&lt;br/&gt;
     			mock(MetricRegistryImpl.class),&lt;br/&gt;
     			fatalErrorHandler,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;jobManagerRunner,&lt;/li&gt;
	&lt;li&gt;jobId);&lt;br/&gt;
    +			mockJobManagerRunner,&lt;br/&gt;
    +			TEST_JOB_ID);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			dispatcher.start();
    +		dispatcher.start();
    +	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());&lt;br/&gt;
    +	@After&lt;br/&gt;
    +	public void tearDown() throws Exception 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		try {
    +			fatalErrorHandler.rethrowError();
    +		} finally {
    +			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);
    +		}    +	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// wait for the leader to be elected&lt;/li&gt;
	&lt;li&gt;leaderFuture.get();&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that we can submit a job to the Dispatcher which then spawns a&lt;br/&gt;
    +	 * new JobManagerRunner.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testJobSubmission() throws Exception 
{
    +		CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());
     
    -			DispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);
    +		// wait for the leader to be elected
    +		leaderFuture.get();
     
    -			CompletableFuture&amp;lt;Acknowledge&amp;gt; acknowledgeFuture = dispatcherGateway.submitJob(jobGraph, timeout);
    +		DispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);
     
    -			acknowledgeFuture.get();
    +		CompletableFuture&amp;lt;Acknowledge&amp;gt; acknowledgeFuture = dispatcherGateway.submitJob(jobGraph, timeout);
     
    -			verify(jobManagerRunner, Mockito.timeout(timeout.toMilliseconds())).start();
    +		acknowledgeFuture.get();
     
    -			// check that no error has occurred
    -			fatalErrorHandler.rethrowError();
    -		}
&lt;p&gt; finally &lt;/p&gt;
{
    -			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);
    -		}&lt;br/&gt;
    +		verify(mockJobManagerRunner, Mockito.timeout(timeout.toMilliseconds())).start();&lt;br/&gt;
     	}&lt;br/&gt;
     &lt;br/&gt;
     	/**&lt;br/&gt;
     	 * Tests that the dispatcher takes part in the leader election.&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testLeaderElection() throws Exception {&lt;br/&gt;
    -		TestingFatalErrorHandler fatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    -		TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    -&lt;br/&gt;
     		UUID expectedLeaderSessionId = UUID.randomUUID();&lt;br/&gt;
    -		CompletableFuture&amp;lt;UUID&amp;gt; leaderSessionIdFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    -		SubmittedJobGraphStore mockSubmittedJobGraphStore = mock(SubmittedJobGraphStore.class);&lt;br/&gt;
    -		TestingLeaderElectionService testingLeaderElectionService = new TestingLeaderElectionService() {&lt;br/&gt;
    -			@Override&lt;br/&gt;
    -			public void confirmLeaderSessionID(UUID leaderSessionId) {
    -				super.confirmLeaderSessionID(leaderSessionId);
    -				leaderSessionIdFuture.complete(leaderSessionId);
    -			}&lt;br/&gt;
    -		};&lt;br/&gt;
    -&lt;br/&gt;
    -		haServices.setSubmittedJobGraphStore(mockSubmittedJobGraphStore);&lt;br/&gt;
    -		haServices.setDispatcherLeaderElectionService(testingLeaderElectionService);&lt;br/&gt;
    -		HeartbeatServices heartbeatServices = new HeartbeatServices(1000L, 1000L);&lt;br/&gt;
    -		final JobID jobId = new JobID();&lt;br/&gt;
    -&lt;br/&gt;
    -		final TestingDispatcher dispatcher = new TestingDispatcher(&lt;br/&gt;
    -			rpcService,&lt;br/&gt;
    -			Dispatcher.DISPATCHER_NAME + &apos;_&apos; + name.getMethodName(),&lt;br/&gt;
    -			new Configuration(),&lt;br/&gt;
    -			haServices,&lt;br/&gt;
    -			mock(ResourceManagerGateway.class),&lt;br/&gt;
    -			mock(BlobServer.class),&lt;br/&gt;
    -			heartbeatServices,&lt;br/&gt;
    -			mock(MetricRegistryImpl.class),&lt;br/&gt;
    -			fatalErrorHandler,&lt;br/&gt;
    -			mock(JobManagerRunner.class),&lt;br/&gt;
    -			jobId);&lt;br/&gt;
     &lt;br/&gt;
    -		try {
    -			dispatcher.start();
    +		assertNull(dispatcherLeaderElectionService.getConfirmationFuture());
     
    -			assertFalse(leaderSessionIdFuture.isDone());
    +		dispatcherLeaderElectionService.isLeader(expectedLeaderSessionId);
     
    -			testingLeaderElectionService.isLeader(expectedLeaderSessionId);
    +		UUID actualLeaderSessionId = dispatcherLeaderElectionService.getConfirmationFuture()
    +			.get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
     
    -			UUID actualLeaderSessionId = leaderSessionIdFuture.get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +		assertEquals(expectedLeaderSessionId, actualLeaderSessionId);
     
    -			assertEquals(expectedLeaderSessionId, actualLeaderSessionId);
    +		verify(submittedJobGraphStore, Mockito.timeout(timeout.toMilliseconds()).atLeast(1)).getJobIds();
    +	}&lt;br/&gt;
     &lt;br/&gt;
    -			verify(mockSubmittedJobGraphStore, Mockito.timeout(timeout.toMilliseconds()).atLeast(1)).getJobIds();&lt;br/&gt;
    -		} finally {    -			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);    -		}
&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Test callbacks from&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link org.apache.flink.runtime.jobmanager.SubmittedJobGraphStore.SubmittedJobGraphListener}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSubmittedJobGraphListener() throws Exception {&lt;br/&gt;
    +		CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());&lt;br/&gt;
    +		leaderFuture.get();&lt;br/&gt;
    +&lt;br/&gt;
    +		dispatcher.submitJob(jobGraph, timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +		// pretend that other Dispatcher has removed job from submittedJobGraphStore&lt;br/&gt;
    +		dispatcher.onRemovedJobGraph(TEST_JOB_ID);&lt;br/&gt;
    +		assertThat(dispatcher.listJobs(timeout).get(), hasSize(0));&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Test is not thread-safe.&lt;/p&gt;</comment>
                            <comment id="16274257" author="githubbot" created="Fri, 1 Dec 2017 11:07:27 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r154320952&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r154320952&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -117,84 +135,78 @@ public void testJobSubmission() throws Exception {&lt;br/&gt;
     			heartbeatServices,&lt;br/&gt;
     			mock(MetricRegistryImpl.class),&lt;br/&gt;
     			fatalErrorHandler,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;jobManagerRunner,&lt;/li&gt;
	&lt;li&gt;jobId);&lt;br/&gt;
    +			mockJobManagerRunner,&lt;br/&gt;
    +			TEST_JOB_ID);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			dispatcher.start();
    +		dispatcher.start();
    +	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());&lt;br/&gt;
    +	@After&lt;br/&gt;
    +	public void tearDown() throws Exception 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		try {
    +			fatalErrorHandler.rethrowError();
    +		} finally {
    +			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);
    +		}    +	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// wait for the leader to be elected&lt;/li&gt;
	&lt;li&gt;leaderFuture.get();&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that we can submit a job to the Dispatcher which then spawns a&lt;br/&gt;
    +	 * new JobManagerRunner.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testJobSubmission() throws Exception 
{
    +		CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());
     
    -			DispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);
    +		// wait for the leader to be elected
    +		leaderFuture.get();
     
    -			CompletableFuture&amp;lt;Acknowledge&amp;gt; acknowledgeFuture = dispatcherGateway.submitJob(jobGraph, timeout);
    +		DispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);
     
    -			acknowledgeFuture.get();
    +		CompletableFuture&amp;lt;Acknowledge&amp;gt; acknowledgeFuture = dispatcherGateway.submitJob(jobGraph, timeout);
     
    -			verify(jobManagerRunner, Mockito.timeout(timeout.toMilliseconds())).start();
    +		acknowledgeFuture.get();
     
    -			// check that no error has occurred
    -			fatalErrorHandler.rethrowError();
    -		}
&lt;p&gt; finally &lt;/p&gt;
{
    -			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);
    -		}&lt;br/&gt;
    +		verify(mockJobManagerRunner, Mockito.timeout(timeout.toMilliseconds())).start();&lt;br/&gt;
     	}&lt;br/&gt;
     &lt;br/&gt;
     	/**&lt;br/&gt;
     	 * Tests that the dispatcher takes part in the leader election.&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testLeaderElection() throws Exception {&lt;br/&gt;
    -		TestingFatalErrorHandler fatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    -		TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    -&lt;br/&gt;
     		UUID expectedLeaderSessionId = UUID.randomUUID();&lt;br/&gt;
    -		CompletableFuture&amp;lt;UUID&amp;gt; leaderSessionIdFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    -		SubmittedJobGraphStore mockSubmittedJobGraphStore = mock(SubmittedJobGraphStore.class);&lt;br/&gt;
    -		TestingLeaderElectionService testingLeaderElectionService = new TestingLeaderElectionService() {&lt;br/&gt;
    -			@Override&lt;br/&gt;
    -			public void confirmLeaderSessionID(UUID leaderSessionId) {
    -				super.confirmLeaderSessionID(leaderSessionId);
    -				leaderSessionIdFuture.complete(leaderSessionId);
    -			}&lt;br/&gt;
    -		};&lt;br/&gt;
    -&lt;br/&gt;
    -		haServices.setSubmittedJobGraphStore(mockSubmittedJobGraphStore);&lt;br/&gt;
    -		haServices.setDispatcherLeaderElectionService(testingLeaderElectionService);&lt;br/&gt;
    -		HeartbeatServices heartbeatServices = new HeartbeatServices(1000L, 1000L);&lt;br/&gt;
    -		final JobID jobId = new JobID();&lt;br/&gt;
    -&lt;br/&gt;
    -		final TestingDispatcher dispatcher = new TestingDispatcher(&lt;br/&gt;
    -			rpcService,&lt;br/&gt;
    -			Dispatcher.DISPATCHER_NAME + &apos;_&apos; + name.getMethodName(),&lt;br/&gt;
    -			new Configuration(),&lt;br/&gt;
    -			haServices,&lt;br/&gt;
    -			mock(ResourceManagerGateway.class),&lt;br/&gt;
    -			mock(BlobServer.class),&lt;br/&gt;
    -			heartbeatServices,&lt;br/&gt;
    -			mock(MetricRegistryImpl.class),&lt;br/&gt;
    -			fatalErrorHandler,&lt;br/&gt;
    -			mock(JobManagerRunner.class),&lt;br/&gt;
    -			jobId);&lt;br/&gt;
     &lt;br/&gt;
    -		try {
    -			dispatcher.start();
    +		assertNull(dispatcherLeaderElectionService.getConfirmationFuture());
     
    -			assertFalse(leaderSessionIdFuture.isDone());
    +		dispatcherLeaderElectionService.isLeader(expectedLeaderSessionId);
     
    -			testingLeaderElectionService.isLeader(expectedLeaderSessionId);
    +		UUID actualLeaderSessionId = dispatcherLeaderElectionService.getConfirmationFuture()
    +			.get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
     
    -			UUID actualLeaderSessionId = leaderSessionIdFuture.get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +		assertEquals(expectedLeaderSessionId, actualLeaderSessionId);
     
    -			assertEquals(expectedLeaderSessionId, actualLeaderSessionId);
    +		verify(submittedJobGraphStore, Mockito.timeout(timeout.toMilliseconds()).atLeast(1)).getJobIds();
    +	}&lt;br/&gt;
     &lt;br/&gt;
    -			verify(mockSubmittedJobGraphStore, Mockito.timeout(timeout.toMilliseconds()).atLeast(1)).getJobIds();&lt;br/&gt;
    -		} finally {    -			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);    -		}
&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Test callbacks from&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link org.apache.flink.runtime.jobmanager.SubmittedJobGraphStore.SubmittedJobGraphListener}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSubmittedJobGraphListener() throws Exception {&lt;br/&gt;
    +		CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());&lt;br/&gt;
    +		leaderFuture.get();&lt;br/&gt;
    +&lt;br/&gt;
    +		dispatcher.submitJob(jobGraph, timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +		// pretend that other Dispatcher has removed job from submittedJobGraphStore&lt;br/&gt;
    +		dispatcher.onRemovedJobGraph(TEST_JOB_ID);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Test is not thread-safe.&lt;/p&gt;</comment>
                            <comment id="16274278" author="githubbot" created="Fri, 1 Dec 2017 11:21:05 +0000"  >&lt;p&gt;Github user GJL closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16274468" author="githubbot" created="Fri, 1 Dec 2017 14:43:07 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r154359352&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r154359352&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -117,84 +135,78 @@ public void testJobSubmission() throws Exception {&lt;br/&gt;
     			heartbeatServices,&lt;br/&gt;
     			mock(MetricRegistryImpl.class),&lt;br/&gt;
     			fatalErrorHandler,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;jobManagerRunner,&lt;/li&gt;
	&lt;li&gt;jobId);&lt;br/&gt;
    +			mockJobManagerRunner,&lt;br/&gt;
    +			TEST_JOB_ID);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			dispatcher.start();
    +		dispatcher.start();
    +	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());&lt;br/&gt;
    +	@After&lt;br/&gt;
    +	public void tearDown() throws Exception 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		try {
    +			fatalErrorHandler.rethrowError();
    +		} finally {
    +			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);
    +		}    +	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// wait for the leader to be elected&lt;/li&gt;
	&lt;li&gt;leaderFuture.get();&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that we can submit a job to the Dispatcher which then spawns a&lt;br/&gt;
    +	 * new JobManagerRunner.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testJobSubmission() throws Exception 
{
    +		CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());
     
    -			DispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);
    +		// wait for the leader to be elected
    +		leaderFuture.get();
     
    -			CompletableFuture&amp;lt;Acknowledge&amp;gt; acknowledgeFuture = dispatcherGateway.submitJob(jobGraph, timeout);
    +		DispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);
     
    -			acknowledgeFuture.get();
    +		CompletableFuture&amp;lt;Acknowledge&amp;gt; acknowledgeFuture = dispatcherGateway.submitJob(jobGraph, timeout);
     
    -			verify(jobManagerRunner, Mockito.timeout(timeout.toMilliseconds())).start();
    +		acknowledgeFuture.get();
     
    -			// check that no error has occurred
    -			fatalErrorHandler.rethrowError();
    -		}
&lt;p&gt; finally &lt;/p&gt;
{
    -			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);
    -		}&lt;br/&gt;
    +		verify(mockJobManagerRunner, Mockito.timeout(timeout.toMilliseconds())).start();&lt;br/&gt;
     	}&lt;br/&gt;
     &lt;br/&gt;
     	/**&lt;br/&gt;
     	 * Tests that the dispatcher takes part in the leader election.&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testLeaderElection() throws Exception {&lt;br/&gt;
    -		TestingFatalErrorHandler fatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    -		TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    -&lt;br/&gt;
     		UUID expectedLeaderSessionId = UUID.randomUUID();&lt;br/&gt;
    -		CompletableFuture&amp;lt;UUID&amp;gt; leaderSessionIdFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    -		SubmittedJobGraphStore mockSubmittedJobGraphStore = mock(SubmittedJobGraphStore.class);&lt;br/&gt;
    -		TestingLeaderElectionService testingLeaderElectionService = new TestingLeaderElectionService() {&lt;br/&gt;
    -			@Override&lt;br/&gt;
    -			public void confirmLeaderSessionID(UUID leaderSessionId) {
    -				super.confirmLeaderSessionID(leaderSessionId);
    -				leaderSessionIdFuture.complete(leaderSessionId);
    -			}&lt;br/&gt;
    -		};&lt;br/&gt;
    -&lt;br/&gt;
    -		haServices.setSubmittedJobGraphStore(mockSubmittedJobGraphStore);&lt;br/&gt;
    -		haServices.setDispatcherLeaderElectionService(testingLeaderElectionService);&lt;br/&gt;
    -		HeartbeatServices heartbeatServices = new HeartbeatServices(1000L, 1000L);&lt;br/&gt;
    -		final JobID jobId = new JobID();&lt;br/&gt;
    -&lt;br/&gt;
    -		final TestingDispatcher dispatcher = new TestingDispatcher(&lt;br/&gt;
    -			rpcService,&lt;br/&gt;
    -			Dispatcher.DISPATCHER_NAME + &apos;_&apos; + name.getMethodName(),&lt;br/&gt;
    -			new Configuration(),&lt;br/&gt;
    -			haServices,&lt;br/&gt;
    -			mock(ResourceManagerGateway.class),&lt;br/&gt;
    -			mock(BlobServer.class),&lt;br/&gt;
    -			heartbeatServices,&lt;br/&gt;
    -			mock(MetricRegistryImpl.class),&lt;br/&gt;
    -			fatalErrorHandler,&lt;br/&gt;
    -			mock(JobManagerRunner.class),&lt;br/&gt;
    -			jobId);&lt;br/&gt;
     &lt;br/&gt;
    -		try {
    -			dispatcher.start();
    +		assertNull(dispatcherLeaderElectionService.getConfirmationFuture());
     
    -			assertFalse(leaderSessionIdFuture.isDone());
    +		dispatcherLeaderElectionService.isLeader(expectedLeaderSessionId);
     
    -			testingLeaderElectionService.isLeader(expectedLeaderSessionId);
    +		UUID actualLeaderSessionId = dispatcherLeaderElectionService.getConfirmationFuture()
    +			.get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
     
    -			UUID actualLeaderSessionId = leaderSessionIdFuture.get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
    +		assertEquals(expectedLeaderSessionId, actualLeaderSessionId);
     
    -			assertEquals(expectedLeaderSessionId, actualLeaderSessionId);
    +		verify(submittedJobGraphStore, Mockito.timeout(timeout.toMilliseconds()).atLeast(1)).getJobIds();
    +	}&lt;br/&gt;
     &lt;br/&gt;
    -			verify(mockSubmittedJobGraphStore, Mockito.timeout(timeout.toMilliseconds()).atLeast(1)).getJobIds();&lt;br/&gt;
    -		} finally {    -			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);    -		}
&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Test callbacks from&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link org.apache.flink.runtime.jobmanager.SubmittedJobGraphStore.SubmittedJobGraphListener}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSubmittedJobGraphListener() throws Exception {&lt;br/&gt;
    +		CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());&lt;br/&gt;
    +		leaderFuture.get();&lt;br/&gt;
    +&lt;br/&gt;
    +		dispatcher.submitJob(jobGraph, timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +		// pretend that other Dispatcher has removed job from submittedJobGraphStore&lt;br/&gt;
    +		dispatcher.onRemovedJobGraph(TEST_JOB_ID);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Interacting with the dispatcher via the self gateway should help.&lt;/p&gt;</comment>
                            <comment id="16274469" author="githubbot" created="Fri, 1 Dec 2017 14:43:07 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r154357254&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r154357254&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -534,6 +536,40 @@ public void handleError(final Exception exception) &lt;/p&gt;
{
     		onFatalError(new DispatcherException(&quot;Received an error from the LeaderElectionService.&quot;, exception));
     	}

&lt;p&gt;    +	//------------------------------------------------------&lt;br/&gt;
    +	// SubmittedJobGraphListener&lt;br/&gt;
    +	//------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public void onAddedJobGraph(final JobID jobId) {&lt;br/&gt;
    +		runAsync(() -&amp;gt; {&lt;br/&gt;
    +			final SubmittedJobGraph submittedJobGraph;&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				submittedJobGraph = submittedJobGraphStore.recoverJobGraph(jobId);
    +			}
&lt;p&gt; catch (final Exception e) {&lt;br/&gt;
    +				log.error(&quot;Could not submit job {}.&quot;, jobId, e);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Maybe &quot;could not recover job&quot;.&lt;/p&gt;</comment>
                            <comment id="16277296" author="githubbot" created="Mon, 4 Dec 2017 19:15:35 +0000"  >&lt;p&gt;GitHub user GJL reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8176&quot; title=&quot;Dispatcher does not start SubmittedJobGraphStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8176&quot;&gt;&lt;del&gt;FLINK-8176&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Start SubmittedJobGraphStore in Dispatcher&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    The FLIP-6 dispatcher never calls `start()` on its SubmittedJobGraphStore instance. Hence, when a Job is submitted (YARN session mode with HA enabled), an IllegalStateException is thrown. This pull request adds the necessary changes so that jobs can be submitted.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Implement SubmittedJobGraphListener interface in Dispatcher&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Added unit tests for new methods in Dispatcher class&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Verified that jobs can be submitted in FLIP-6 YARN session mode with HA. Did not verify anything else.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    CC: @tillrohrmann &lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/GJL/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/GJL/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8176&quot; title=&quot;Dispatcher does not start SubmittedJobGraphStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8176&quot;&gt;&lt;del&gt;FLINK-8176&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5107&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d238ef0c23eea585974929eafdff33af916d19ba&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-11-30T14:37:30Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Extract SubmittedJobGraphStore implementation from JobManagerHARecoveryTest&lt;/p&gt;

&lt;p&gt;commit 33b9d2848c767088f43fed2d03e6402695827221&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-11-30T14:44:23Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8176&quot; title=&quot;Dispatcher does not start SubmittedJobGraphStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8176&quot;&gt;&lt;del&gt;FLINK-8176&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Implement SubmittedJobGraphListener interface in Dispatcher&lt;/p&gt;

&lt;p&gt;    Call start() on SubmittedJobGraphStore with Dispatcher as listener. To enable&lt;br/&gt;
    this, the dispatcher must implement the SubmittedJobGraphListener interface. Add&lt;br/&gt;
    simple unit tests for the new methods. Refactor DispatcherTest to remove&lt;br/&gt;
    redundancy.&lt;/p&gt;

&lt;p&gt;commit 88359172e23413aa195177993551613349056b68&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-12-04T18:57:29Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8176&quot; title=&quot;Dispatcher does not start SubmittedJobGraphStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8176&quot;&gt;&lt;del&gt;FLINK-8176&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Make InMemorySubmittedJobGraphStore thread-safe&lt;/p&gt;

&lt;p&gt;commit 9cdb29604e9915c7d6ea60ed6fcee06c9bad57b9&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-12-04T18:58:26Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Javadoc&amp;#93;&lt;/span&gt; Make first sentence in JobSubmissionException Javadoc end with period&lt;/p&gt;

&lt;p&gt;commit 53ad1771e8bec063157d69c0f7a187ccb5fb340e&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-12-04T19:04:52Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8176&quot; title=&quot;Dispatcher does not start SubmittedJobGraphStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8176&quot;&gt;&lt;del&gt;FLINK-8176&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Add method isStarted() to TestingLeaderElectionService&lt;/p&gt;

&lt;p&gt;commit 0c030fb19d7b5b9dba4df5811a69086906e20ca0&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-12-04T19:05:47Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8176&quot; title=&quot;Dispatcher does not start SubmittedJobGraphStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8176&quot;&gt;&lt;del&gt;FLINK-8176&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Return same RunningJobsRegistry instance from TestingHighAvailabilityServices&lt;/p&gt;

&lt;p&gt;commit 7a04cbe54bcf380684c4e79a4f999b31b650570e&lt;br/&gt;
Author: gyao &amp;lt;gary@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-12-04T19:09:36Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8176&quot; title=&quot;Dispatcher does not start SubmittedJobGraphStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8176&quot;&gt;&lt;del&gt;FLINK-8176&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Fix race conditions in Dispatcher and DispatcherTest&lt;/p&gt;

&lt;p&gt;    Check if jobManagerRunner exists before submitting job.&lt;br/&gt;
    Replace JobManagerRunner mock used in tests with real instance.&lt;br/&gt;
    Do not run job graph recovery in actor main thread when job graph is recovered&lt;br/&gt;
    from SubmittedJobGraphListener#onAddedJobGraph(JobID).&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16277300" author="githubbot" created="Mon, 4 Dec 2017 19:16:50 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r154747386&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r154747386&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -534,6 +536,40 @@ public void handleError(final Exception exception) &lt;/p&gt;
{
     		onFatalError(new DispatcherException(&quot;Received an error from the LeaderElectionService.&quot;, exception));
     	}

&lt;p&gt;    +	//------------------------------------------------------&lt;br/&gt;
    +	// SubmittedJobGraphListener&lt;br/&gt;
    +	//------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public void onAddedJobGraph(final JobID jobId) {&lt;br/&gt;
    +		runAsync(() -&amp;gt; {&lt;br/&gt;
    +			final SubmittedJobGraph submittedJobGraph;&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				submittedJobGraph = submittedJobGraphStore.recoverJobGraph(jobId);
    +			}
&lt;p&gt; catch (final Exception e) {&lt;br/&gt;
    +				log.error(&quot;Could not submit job {}.&quot;, jobId, e);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Changed it.&lt;/p&gt;</comment>
                            <comment id="16277305" author="githubbot" created="Mon, 4 Dec 2017 19:20:24 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r154748301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r154748301&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -244,7 +302,32 @@ protected JobManagerRunner createJobManagerRunner(&lt;br/&gt;
     				FatalErrorHandler fatalErrorHandler) throws Exception &lt;/p&gt;
{
     			assertEquals(expectedJobId, jobGraph.getJobID());
     
    -			return jobManagerRunner;
    +			return new JobManagerRunner(resourceId, jobGraph, configuration, rpcService,
    +				highAvailabilityServices, heartbeatServices, jobManagerServices, metricRegistry,
    +				onCompleteActions, fatalErrorHandler);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public CompletableFuture&amp;lt;Acknowledge&amp;gt; submitJob(final JobGraph jobGraph, final Time timeout) {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Acknowledge&amp;gt; submitJobFuture = super.submitJob(jobGraph, timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				submitJobFuture.get();
    +			}
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
    +				Thread.currentThread().interrupt();
    +			}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +				throw new RuntimeException(e);
    +			}
&lt;p&gt;    +&lt;br/&gt;
    +			submitJobLatch.countDown();&lt;br/&gt;
    +			return submitJobFuture;&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		void recoverJobs() {&lt;br/&gt;
    +			if (recoverJobsEnabled.get()) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Without this I do not see how I can verify whether a job was submitted regularly or via `recoverJobs`.&lt;/p&gt;</comment>
                            <comment id="16280185" author="githubbot" created="Wed, 6 Dec 2017 13:39:47 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155225574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155225574&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -507,6 +514,41 @@ public void handleError(final Exception exception) &lt;/p&gt;
{
     		onFatalError(new DispatcherException(&quot;Received an error from the LeaderElectionService.&quot;, exception));
     	}

&lt;p&gt;    +	//------------------------------------------------------&lt;br/&gt;
    +	// SubmittedJobGraphListener&lt;br/&gt;
    +	//------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public void onAddedJobGraph(final JobID jobId) {&lt;br/&gt;
    +		getRpcService().execute(() -&amp;gt; {&lt;br/&gt;
    +			final SubmittedJobGraph submittedJobGraph;&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				submittedJobGraph = submittedJobGraphStore.recoverJobGraph(jobId);
    +			}
&lt;p&gt; catch (final Exception e) {&lt;br/&gt;
    +				log.error(&quot;Could not recover job graph for job {}.&quot;, jobId, e);&lt;br/&gt;
    +				return;&lt;br/&gt;
    +			}&lt;br/&gt;
    +			runAsync(() -&amp;gt; {&lt;br/&gt;
    +				if (!jobManagerRunners.containsKey(jobId)) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think this check is not strictly needed.&lt;/p&gt;</comment>
                            <comment id="16280186" author="githubbot" created="Wed, 6 Dec 2017 13:39:47 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155225461&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155225461&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -507,6 +514,41 @@ public void handleError(final Exception exception) &lt;/p&gt;
{
     		onFatalError(new DispatcherException(&quot;Received an error from the LeaderElectionService.&quot;, exception));
     	}

&lt;p&gt;    +	//------------------------------------------------------&lt;br/&gt;
    +	// SubmittedJobGraphListener&lt;br/&gt;
    +	//------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public void onAddedJobGraph(final JobID jobId) {&lt;br/&gt;
    +		getRpcService().execute(() -&amp;gt; {&lt;br/&gt;
    +			final SubmittedJobGraph submittedJobGraph;&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				submittedJobGraph = submittedJobGraphStore.recoverJobGraph(jobId);
    +			}
&lt;p&gt; catch (final Exception e) {&lt;br/&gt;
    +				log.error(&quot;Could not recover job graph for job {}.&quot;, jobId, e);&lt;br/&gt;
    +				return;&lt;br/&gt;
    +			}&lt;br/&gt;
    +			runAsync(() -&amp;gt; {&lt;br/&gt;
    +				if (!jobManagerRunners.containsKey(jobId)) &lt;/p&gt;
{
    +					submitJob(submittedJobGraph.getJobGraph(), RpcUtils.INF_TIMEOUT);
    +				}
&lt;p&gt;    +			});&lt;br/&gt;
    +		});&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public void onRemovedJobGraph(final JobID jobId) {&lt;br/&gt;
    +		runAsync(() -&amp;gt; {&lt;br/&gt;
    +			if (jobManagerRunners.containsKey(jobId)) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This check should be superfluous because it will be check in `removeJob` as well.&lt;/p&gt;</comment>
                            <comment id="16280187" author="githubbot" created="Wed, 6 Dec 2017 13:39:47 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155237910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155237910&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -86,122 +125,143 @@ public static void teardown() {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Tests that we can submit a job to the Dispatcher which then spawns a&lt;/li&gt;
	&lt;li&gt;* new JobManagerRunner.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;@Test&lt;/li&gt;
	&lt;li&gt;public void testJobSubmission() throws Exception {&lt;/li&gt;
	&lt;li&gt;TestingFatalErrorHandler fatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setUp() throws Exception {&lt;br/&gt;
    +		MockitoAnnotations.initMocks(this);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestingLeaderElectionService dispatcherLeaderElectionService = new TestingLeaderElectionService();&lt;/li&gt;
	&lt;li&gt;TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;/li&gt;
	&lt;li&gt;haServices.setDispatcherLeaderElectionService(dispatcherLeaderElectionService);&lt;/li&gt;
	&lt;li&gt;haServices.setSubmittedJobGraphStore(new StandaloneSubmittedJobGraphStore());&lt;br/&gt;
    +		final JobVertex testVertex = new JobVertex(&quot;testVertex&quot;);&lt;br/&gt;
    +		testVertex.setInvokableClass(NoOpInvokable.class);&lt;br/&gt;
    +		jobGraph = new JobGraph(TEST_JOB_ID, &quot;testJob&quot;, testVertex);&lt;br/&gt;
    +		jobGraph.setAllowQueuedScheduling(true);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;HeartbeatServices heartbeatServices = new HeartbeatServices(1000L, 10000L);&lt;/li&gt;
	&lt;li&gt;JobManagerRunner jobManagerRunner = mock(JobManagerRunner.class);&lt;br/&gt;
    +		fatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    +		final HeartbeatServices heartbeatServices = new HeartbeatServices(1000L, 10000L);&lt;br/&gt;
    +		submittedJobGraphStore = spy(new InMemorySubmittedJobGraphStore());&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobGraph jobGraph = mock(JobGraph.class);&lt;/li&gt;
	&lt;li&gt;final JobID jobId = new JobID();&lt;/li&gt;
	&lt;li&gt;when(jobGraph.getJobID()).thenReturn(jobId);&lt;br/&gt;
    +		dispatcherLeaderElectionService = new TestingLeaderElectionService();&lt;br/&gt;
    +		jobMasterLeaderElectionService = new TestingLeaderElectionService();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final TestingDispatcher dispatcher = new TestingDispatcher(&lt;br/&gt;
    +		final TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    +		haServices.setDispatcherLeaderElectionService(dispatcherLeaderElectionService);&lt;br/&gt;
    +		haServices.setSubmittedJobGraphStore(submittedJobGraphStore);&lt;br/&gt;
    +		haServices.setJobMasterLeaderElectionService(TEST_JOB_ID, jobMasterLeaderElectionService);&lt;br/&gt;
    +		haServices.setCheckpointRecoveryFactory(new StandaloneCheckpointRecoveryFactory());&lt;br/&gt;
    +		haServices.setResourceManagerLeaderRetriever(new TestingLeaderRetrievalService());&lt;br/&gt;
    +		runningJobsRegistry = haServices.getRunningJobsRegistry();&lt;br/&gt;
    +&lt;br/&gt;
    +		final Configuration blobServerConfig = new Configuration();&lt;br/&gt;
    +		blobServerConfig.setString(&lt;br/&gt;
    +			BlobServerOptions.STORAGE_DIRECTORY,&lt;br/&gt;
    +			temporaryFolder.newFolder().getAbsolutePath());&lt;br/&gt;
    +&lt;br/&gt;
    +		dispatcher = new TestingDispatcher(&lt;br/&gt;
     			rpcService,&lt;br/&gt;
     			Dispatcher.DISPATCHER_NAME + &apos;_&apos; + name.getMethodName(),&lt;br/&gt;
     			new Configuration(),&lt;br/&gt;
     			haServices,&lt;br/&gt;
     			mock(ResourceManagerGateway.class),&lt;/li&gt;
	&lt;li&gt;mock(BlobServer.class),&lt;br/&gt;
    +			new BlobServer(blobServerConfig, new VoidBlobStore()),&lt;br/&gt;
     			heartbeatServices,&lt;/li&gt;
	&lt;li&gt;mock(MetricRegistryImpl.class),&lt;br/&gt;
    +			new NoOpMetricRegistry(),&lt;br/&gt;
     			fatalErrorHandler,&lt;/li&gt;
	&lt;li&gt;jobManagerRunner,&lt;/li&gt;
	&lt;li&gt;jobId);&lt;br/&gt;
    +			TEST_JOB_ID);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			dispatcher.start();
    +		dispatcher.start();
    +	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());&lt;br/&gt;
    +	@After&lt;br/&gt;
    +	public void tearDown() throws Exception 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		try {
    +			fatalErrorHandler.rethrowError();
    +		} finally {
    +			RpcUtils.terminateRpcEndpoint(dispatcher, TIMEOUT);
    +		}    +	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// wait for the leader to be elected&lt;/li&gt;
	&lt;li&gt;leaderFuture.get();&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that we can submit a job to the Dispatcher which then spawns a&lt;br/&gt;
    +	 * new JobManagerRunner.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testJobSubmission() throws Exception 
{
    +		CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());
     
    -			DispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);
    +		// wait for the leader to be elected
    +		leaderFuture.get();
     
    -			CompletableFuture&amp;lt;Acknowledge&amp;gt; acknowledgeFuture = dispatcherGateway.submitJob(jobGraph, timeout);
    +		DispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);
     
    -			acknowledgeFuture.get();
    +		CompletableFuture&amp;lt;Acknowledge&amp;gt; acknowledgeFuture = dispatcherGateway.submitJob(jobGraph, TIMEOUT);
     
    -			verify(jobManagerRunner, Mockito.timeout(timeout.toMilliseconds())).start();
    +		acknowledgeFuture.get();
     
    -			// check that no error has occurred
    -			fatalErrorHandler.rethrowError();
    -		}
&lt;p&gt; finally &lt;/p&gt;
{
    -			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);
    -		}
&lt;p&gt;    +		assertTrue(&lt;br/&gt;
    +			&quot;jobManagerRunner was not started&quot;,&lt;br/&gt;
    +			dispatcherLeaderElectionService.isStarted());&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests that the dispatcher takes part in the leader election.&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testLeaderElection() throws Exception {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestingFatalErrorHandler fatalErrorHandler = new TestingFatalErrorHandler();&lt;/li&gt;
	&lt;li&gt;TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    -&lt;br/&gt;
     		UUID expectedLeaderSessionId = UUID.randomUUID();&lt;/li&gt;
	&lt;li&gt;CompletableFuture&amp;lt;UUID&amp;gt; leaderSessionIdFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;SubmittedJobGraphStore mockSubmittedJobGraphStore = mock(SubmittedJobGraphStore.class);&lt;/li&gt;
	&lt;li&gt;TestingLeaderElectionService testingLeaderElectionService = new TestingLeaderElectionService() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void confirmLeaderSessionID(UUID leaderSessionId) 
{
    -				super.confirmLeaderSessionID(leaderSessionId);
    -				leaderSessionIdFuture.complete(leaderSessionId);
    -			}&lt;/li&gt;
	&lt;li&gt;};&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;haServices.setSubmittedJobGraphStore(mockSubmittedJobGraphStore);&lt;/li&gt;
	&lt;li&gt;haServices.setDispatcherLeaderElectionService(testingLeaderElectionService);&lt;/li&gt;
	&lt;li&gt;HeartbeatServices heartbeatServices = new HeartbeatServices(1000L, 1000L);&lt;/li&gt;
	&lt;li&gt;final JobID jobId = new JobID();&lt;br/&gt;
    +		assertNull(dispatcherLeaderElectionService.getConfirmationFuture());&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final TestingDispatcher dispatcher = new TestingDispatcher(&lt;/li&gt;
	&lt;li&gt;rpcService,&lt;/li&gt;
	&lt;li&gt;Dispatcher.DISPATCHER_NAME + &apos;_&apos; + name.getMethodName(),&lt;/li&gt;
	&lt;li&gt;new Configuration(),&lt;/li&gt;
	&lt;li&gt;haServices,&lt;/li&gt;
	&lt;li&gt;mock(ResourceManagerGateway.class),&lt;/li&gt;
	&lt;li&gt;mock(BlobServer.class),&lt;/li&gt;
	&lt;li&gt;heartbeatServices,&lt;/li&gt;
	&lt;li&gt;mock(MetricRegistryImpl.class),&lt;/li&gt;
	&lt;li&gt;fatalErrorHandler,&lt;/li&gt;
	&lt;li&gt;mock(JobManagerRunner.class),&lt;/li&gt;
	&lt;li&gt;jobId);&lt;br/&gt;
    +		dispatcherLeaderElectionService.isLeader(expectedLeaderSessionId);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			dispatcher.start();
    +		UUID actualLeaderSessionId = dispatcherLeaderElectionService.getConfirmationFuture()
    +			.get(TIMEOUT.toMilliseconds(), TimeUnit.MILLISECONDS);
    +
    +		assertEquals(expectedLeaderSessionId, actualLeaderSessionId);
    +
    +		verify(submittedJobGraphStore, Mockito.timeout(TIMEOUT.toMilliseconds()).atLeast(1)).getJobIds();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Test callbacks from&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link org.apache.flink.runtime.jobmanager.SubmittedJobGraphStore.SubmittedJobGraphListener}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSubmittedJobGraphListener() throws Exception {&lt;br/&gt;
    +		dispatcher.recoverJobsEnabled.set(false);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why do we need this to be set to `false`? Recover all jobs should only be triggered in case of a leadership grant to the dispatcher which only happens at the very beginning of this test.&lt;/p&gt;</comment>
                            <comment id="16280188" author="githubbot" created="Wed, 6 Dec 2017 13:39:47 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155225963&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155225963&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -86,122 +125,143 @@ public static void teardown() {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Tests that we can submit a job to the Dispatcher which then spawns a&lt;/li&gt;
	&lt;li&gt;* new JobManagerRunner.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;@Test&lt;/li&gt;
	&lt;li&gt;public void testJobSubmission() throws Exception {&lt;/li&gt;
	&lt;li&gt;TestingFatalErrorHandler fatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setUp() throws Exception {&lt;br/&gt;
    +		MockitoAnnotations.initMocks(this);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    No longer needed.&lt;/p&gt;</comment>
                            <comment id="16280189" author="githubbot" created="Wed, 6 Dec 2017 13:39:47 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155229002&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155229002&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/testutils/InMemorySubmittedJobGraphStore.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,90 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.testutils;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.SubmittedJobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.SubmittedJobGraphStore;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.util.Objects.requireNonNull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * In-Memory implementation of &lt;/p&gt;
{@link SubmittedJobGraphStore}
&lt;p&gt; for testing purposes.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class InMemorySubmittedJobGraphStore implements SubmittedJobGraphStore {&lt;br/&gt;
    +&lt;br/&gt;
    +	private final Map&amp;lt;JobID, SubmittedJobGraph&amp;gt; storedJobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	private boolean started;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public synchronized void start(@Nullable SubmittedJobGraphListener jobGraphListener) throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think we should also trigger `SubmittedJobGraphListener` notifications when a job is added or removed from this store to make it behave similarly to the `ZooKeeperSubmittedJobGraphStore`.&lt;/p&gt;</comment>
                            <comment id="16280199" author="githubbot" created="Wed, 6 Dec 2017 13:48:19 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155240139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155240139&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/testutils/InMemorySubmittedJobGraphStore.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,90 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.testutils;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.SubmittedJobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.SubmittedJobGraphStore;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.util.Objects.requireNonNull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * In-Memory implementation of &lt;/p&gt;
{@link SubmittedJobGraphStore}
&lt;p&gt; for testing purposes.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class InMemorySubmittedJobGraphStore implements SubmittedJobGraphStore {&lt;br/&gt;
    +&lt;br/&gt;
    +	private final Map&amp;lt;JobID, SubmittedJobGraph&amp;gt; storedJobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	private boolean started;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public synchronized void start(@Nullable SubmittedJobGraphListener jobGraphListener) throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Good point.&lt;/p&gt;</comment>
                            <comment id="16280209" author="githubbot" created="Wed, 6 Dec 2017 13:56:21 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155242108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155242108&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/testutils/InMemorySubmittedJobGraphStore.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,90 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.testutils;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.SubmittedJobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.jobmanager.SubmittedJobGraphStore;&lt;br/&gt;
    +import org.apache.flink.util.Preconditions;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nullable;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +&lt;br/&gt;
    +import static java.util.Objects.requireNonNull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * In-Memory implementation of &lt;/p&gt;
{@link SubmittedJobGraphStore}
&lt;p&gt; for testing purposes.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class InMemorySubmittedJobGraphStore implements SubmittedJobGraphStore {&lt;br/&gt;
    +&lt;br/&gt;
    +	private final Map&amp;lt;JobID, SubmittedJobGraph&amp;gt; storedJobs = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	private boolean started;&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public synchronized void start(@Nullable SubmittedJobGraphListener jobGraphListener) throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Not sure if it is actually applicable. `onRemovedJobGraph` explicitly demands that the graph is removed by a different `SubmittedJobGraphStore` instance:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Callback for 
{@link SubmittedJobGraph}
&lt;p&gt; instances removed by a different &lt;/p&gt;
{@link
    		 * SubmittedJobGraphStore}
&lt;p&gt; instance.&lt;br/&gt;
    		 *&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;@param jobId The 
{@link JobID}
&lt;p&gt; of the removed job graph&lt;br/&gt;
    		 */&lt;br/&gt;
    		void onRemovedJobGraph(JobID jobId);&lt;br/&gt;
    ```&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16280210" author="githubbot" created="Wed, 6 Dec 2017 13:59:15 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155242826&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155242826&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -86,122 +125,143 @@ public static void teardown() {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Tests that we can submit a job to the Dispatcher which then spawns a&lt;/li&gt;
	&lt;li&gt;* new JobManagerRunner.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;@Test&lt;/li&gt;
	&lt;li&gt;public void testJobSubmission() throws Exception {&lt;/li&gt;
	&lt;li&gt;TestingFatalErrorHandler fatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setUp() throws Exception {&lt;br/&gt;
    +		MockitoAnnotations.initMocks(this);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestingLeaderElectionService dispatcherLeaderElectionService = new TestingLeaderElectionService();&lt;/li&gt;
	&lt;li&gt;TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;/li&gt;
	&lt;li&gt;haServices.setDispatcherLeaderElectionService(dispatcherLeaderElectionService);&lt;/li&gt;
	&lt;li&gt;haServices.setSubmittedJobGraphStore(new StandaloneSubmittedJobGraphStore());&lt;br/&gt;
    +		final JobVertex testVertex = new JobVertex(&quot;testVertex&quot;);&lt;br/&gt;
    +		testVertex.setInvokableClass(NoOpInvokable.class);&lt;br/&gt;
    +		jobGraph = new JobGraph(TEST_JOB_ID, &quot;testJob&quot;, testVertex);&lt;br/&gt;
    +		jobGraph.setAllowQueuedScheduling(true);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;HeartbeatServices heartbeatServices = new HeartbeatServices(1000L, 10000L);&lt;/li&gt;
	&lt;li&gt;JobManagerRunner jobManagerRunner = mock(JobManagerRunner.class);&lt;br/&gt;
    +		fatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    +		final HeartbeatServices heartbeatServices = new HeartbeatServices(1000L, 10000L);&lt;br/&gt;
    +		submittedJobGraphStore = spy(new InMemorySubmittedJobGraphStore());&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobGraph jobGraph = mock(JobGraph.class);&lt;/li&gt;
	&lt;li&gt;final JobID jobId = new JobID();&lt;/li&gt;
	&lt;li&gt;when(jobGraph.getJobID()).thenReturn(jobId);&lt;br/&gt;
    +		dispatcherLeaderElectionService = new TestingLeaderElectionService();&lt;br/&gt;
    +		jobMasterLeaderElectionService = new TestingLeaderElectionService();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final TestingDispatcher dispatcher = new TestingDispatcher(&lt;br/&gt;
    +		final TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    +		haServices.setDispatcherLeaderElectionService(dispatcherLeaderElectionService);&lt;br/&gt;
    +		haServices.setSubmittedJobGraphStore(submittedJobGraphStore);&lt;br/&gt;
    +		haServices.setJobMasterLeaderElectionService(TEST_JOB_ID, jobMasterLeaderElectionService);&lt;br/&gt;
    +		haServices.setCheckpointRecoveryFactory(new StandaloneCheckpointRecoveryFactory());&lt;br/&gt;
    +		haServices.setResourceManagerLeaderRetriever(new TestingLeaderRetrievalService());&lt;br/&gt;
    +		runningJobsRegistry = haServices.getRunningJobsRegistry();&lt;br/&gt;
    +&lt;br/&gt;
    +		final Configuration blobServerConfig = new Configuration();&lt;br/&gt;
    +		blobServerConfig.setString(&lt;br/&gt;
    +			BlobServerOptions.STORAGE_DIRECTORY,&lt;br/&gt;
    +			temporaryFolder.newFolder().getAbsolutePath());&lt;br/&gt;
    +&lt;br/&gt;
    +		dispatcher = new TestingDispatcher(&lt;br/&gt;
     			rpcService,&lt;br/&gt;
     			Dispatcher.DISPATCHER_NAME + &apos;_&apos; + name.getMethodName(),&lt;br/&gt;
     			new Configuration(),&lt;br/&gt;
     			haServices,&lt;br/&gt;
     			mock(ResourceManagerGateway.class),&lt;/li&gt;
	&lt;li&gt;mock(BlobServer.class),&lt;br/&gt;
    +			new BlobServer(blobServerConfig, new VoidBlobStore()),&lt;br/&gt;
     			heartbeatServices,&lt;/li&gt;
	&lt;li&gt;mock(MetricRegistryImpl.class),&lt;br/&gt;
    +			new NoOpMetricRegistry(),&lt;br/&gt;
     			fatalErrorHandler,&lt;/li&gt;
	&lt;li&gt;jobManagerRunner,&lt;/li&gt;
	&lt;li&gt;jobId);&lt;br/&gt;
    +			TEST_JOB_ID);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			dispatcher.start();
    +		dispatcher.start();
    +	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());&lt;br/&gt;
    +	@After&lt;br/&gt;
    +	public void tearDown() throws Exception 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +		try {
    +			fatalErrorHandler.rethrowError();
    +		} finally {
    +			RpcUtils.terminateRpcEndpoint(dispatcher, TIMEOUT);
    +		}    +	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// wait for the leader to be elected&lt;/li&gt;
	&lt;li&gt;leaderFuture.get();&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that we can submit a job to the Dispatcher which then spawns a&lt;br/&gt;
    +	 * new JobManagerRunner.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testJobSubmission() throws Exception 
{
    +		CompletableFuture&amp;lt;UUID&amp;gt; leaderFuture = dispatcherLeaderElectionService.isLeader(UUID.randomUUID());
     
    -			DispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);
    +		// wait for the leader to be elected
    +		leaderFuture.get();
     
    -			CompletableFuture&amp;lt;Acknowledge&amp;gt; acknowledgeFuture = dispatcherGateway.submitJob(jobGraph, timeout);
    +		DispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);
     
    -			acknowledgeFuture.get();
    +		CompletableFuture&amp;lt;Acknowledge&amp;gt; acknowledgeFuture = dispatcherGateway.submitJob(jobGraph, TIMEOUT);
     
    -			verify(jobManagerRunner, Mockito.timeout(timeout.toMilliseconds())).start();
    +		acknowledgeFuture.get();
     
    -			// check that no error has occurred
    -			fatalErrorHandler.rethrowError();
    -		}
&lt;p&gt; finally &lt;/p&gt;
{
    -			RpcUtils.terminateRpcEndpoint(dispatcher, timeout);
    -		}
&lt;p&gt;    +		assertTrue(&lt;br/&gt;
    +			&quot;jobManagerRunner was not started&quot;,&lt;br/&gt;
    +			dispatcherLeaderElectionService.isStarted());&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests that the dispatcher takes part in the leader election.&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testLeaderElection() throws Exception {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestingFatalErrorHandler fatalErrorHandler = new TestingFatalErrorHandler();&lt;/li&gt;
	&lt;li&gt;TestingHighAvailabilityServices haServices = new TestingHighAvailabilityServices();&lt;br/&gt;
    -&lt;br/&gt;
     		UUID expectedLeaderSessionId = UUID.randomUUID();&lt;/li&gt;
	&lt;li&gt;CompletableFuture&amp;lt;UUID&amp;gt; leaderSessionIdFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;SubmittedJobGraphStore mockSubmittedJobGraphStore = mock(SubmittedJobGraphStore.class);&lt;/li&gt;
	&lt;li&gt;TestingLeaderElectionService testingLeaderElectionService = new TestingLeaderElectionService() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void confirmLeaderSessionID(UUID leaderSessionId) 
{
    -				super.confirmLeaderSessionID(leaderSessionId);
    -				leaderSessionIdFuture.complete(leaderSessionId);
    -			}&lt;/li&gt;
	&lt;li&gt;};&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;haServices.setSubmittedJobGraphStore(mockSubmittedJobGraphStore);&lt;/li&gt;
	&lt;li&gt;haServices.setDispatcherLeaderElectionService(testingLeaderElectionService);&lt;/li&gt;
	&lt;li&gt;HeartbeatServices heartbeatServices = new HeartbeatServices(1000L, 1000L);&lt;/li&gt;
	&lt;li&gt;final JobID jobId = new JobID();&lt;br/&gt;
    +		assertNull(dispatcherLeaderElectionService.getConfirmationFuture());&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final TestingDispatcher dispatcher = new TestingDispatcher(&lt;/li&gt;
	&lt;li&gt;rpcService,&lt;/li&gt;
	&lt;li&gt;Dispatcher.DISPATCHER_NAME + &apos;_&apos; + name.getMethodName(),&lt;/li&gt;
	&lt;li&gt;new Configuration(),&lt;/li&gt;
	&lt;li&gt;haServices,&lt;/li&gt;
	&lt;li&gt;mock(ResourceManagerGateway.class),&lt;/li&gt;
	&lt;li&gt;mock(BlobServer.class),&lt;/li&gt;
	&lt;li&gt;heartbeatServices,&lt;/li&gt;
	&lt;li&gt;mock(MetricRegistryImpl.class),&lt;/li&gt;
	&lt;li&gt;fatalErrorHandler,&lt;/li&gt;
	&lt;li&gt;mock(JobManagerRunner.class),&lt;/li&gt;
	&lt;li&gt;jobId);&lt;br/&gt;
    +		dispatcherLeaderElectionService.isLeader(expectedLeaderSessionId);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			dispatcher.start();
    +		UUID actualLeaderSessionId = dispatcherLeaderElectionService.getConfirmationFuture()
    +			.get(TIMEOUT.toMilliseconds(), TimeUnit.MILLISECONDS);
    +
    +		assertEquals(expectedLeaderSessionId, actualLeaderSessionId);
    +
    +		verify(submittedJobGraphStore, Mockito.timeout(TIMEOUT.toMilliseconds()).atLeast(1)).getJobIds();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Test callbacks from&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link org.apache.flink.runtime.jobmanager.SubmittedJobGraphStore.SubmittedJobGraphListener}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSubmittedJobGraphListener() throws Exception {&lt;br/&gt;
    +		dispatcher.recoverJobsEnabled.set(false);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    It is not so predictable when the main logic of `recoverJobs()` is scheduled because it does not run in the main thread:&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Recovers all jobs persisted via the submitted job graph store.&lt;br/&gt;
    	 */&lt;br/&gt;
    	@VisibleForTesting&lt;br/&gt;
    	void recoverJobs() {&lt;br/&gt;
    		log.info(&quot;Recovering all persisted jobs.&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    		getRpcService().execute(&lt;br/&gt;
    			() -&amp;gt; {&lt;br/&gt;
    				final Collection&amp;lt;JobID&amp;gt; jobIds;&lt;/p&gt;

&lt;p&gt;    	...&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    When the test adds something to the job graph store, it could potentially be submitted by `recoverJobs`, which is something I need to avoid.&lt;/p&gt;</comment>
                            <comment id="16280212" author="githubbot" created="Wed, 6 Dec 2017 13:59:37 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155242900&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155242900&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java &amp;#8212;&lt;br/&gt;
    @@ -86,122 +125,143 @@ public static void teardown() {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Tests that we can submit a job to the Dispatcher which then spawns a&lt;/li&gt;
	&lt;li&gt;* new JobManagerRunner.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;@Test&lt;/li&gt;
	&lt;li&gt;public void testJobSubmission() throws Exception {&lt;/li&gt;
	&lt;li&gt;TestingFatalErrorHandler fatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setUp() throws Exception {&lt;br/&gt;
    +		MockitoAnnotations.initMocks(this);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Nice catch.&lt;/p&gt;</comment>
                            <comment id="16280221" author="githubbot" created="Wed, 6 Dec 2017 14:11:10 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155245759&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155245759&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -507,6 +514,41 @@ public void handleError(final Exception exception) &lt;/p&gt;
{
     		onFatalError(new DispatcherException(&quot;Received an error from the LeaderElectionService.&quot;, exception));
     	}

&lt;p&gt;    +	//------------------------------------------------------&lt;br/&gt;
    +	// SubmittedJobGraphListener&lt;br/&gt;
    +	//------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public void onAddedJobGraph(final JobID jobId) {&lt;br/&gt;
    +		getRpcService().execute(() -&amp;gt; {&lt;br/&gt;
    +			final SubmittedJobGraph submittedJobGraph;&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				submittedJobGraph = submittedJobGraphStore.recoverJobGraph(jobId);
    +			}
&lt;p&gt; catch (final Exception e) {&lt;br/&gt;
    +				log.error(&quot;Could not recover job graph for job {}.&quot;, jobId, e);&lt;br/&gt;
    +				return;&lt;br/&gt;
    +			}&lt;br/&gt;
    +			runAsync(() -&amp;gt; {&lt;br/&gt;
    +				if (!jobManagerRunners.containsKey(jobId)) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Removed.&lt;/p&gt;</comment>
                            <comment id="16280222" author="githubbot" created="Wed, 6 Dec 2017 14:11:13 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107#discussion_r155245771&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107#discussion_r155245771&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -507,6 +514,41 @@ public void handleError(final Exception exception) &lt;/p&gt;
{
     		onFatalError(new DispatcherException(&quot;Received an error from the LeaderElectionService.&quot;, exception));
     	}

&lt;p&gt;    +	//------------------------------------------------------&lt;br/&gt;
    +	// SubmittedJobGraphListener&lt;br/&gt;
    +	//------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public void onAddedJobGraph(final JobID jobId) {&lt;br/&gt;
    +		getRpcService().execute(() -&amp;gt; {&lt;br/&gt;
    +			final SubmittedJobGraph submittedJobGraph;&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				submittedJobGraph = submittedJobGraphStore.recoverJobGraph(jobId);
    +			}
&lt;p&gt; catch (final Exception e) {&lt;br/&gt;
    +				log.error(&quot;Could not recover job graph for job {}.&quot;, jobId, e);&lt;br/&gt;
    +				return;&lt;br/&gt;
    +			}&lt;br/&gt;
    +			runAsync(() -&amp;gt; {&lt;br/&gt;
    +				if (!jobManagerRunners.containsKey(jobId)) &lt;/p&gt;
{
    +					submitJob(submittedJobGraph.getJobGraph(), RpcUtils.INF_TIMEOUT);
    +				}
&lt;p&gt;    +			});&lt;br/&gt;
    +		});&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public void onRemovedJobGraph(final JobID jobId) {&lt;br/&gt;
    +		runAsync(() -&amp;gt; {&lt;br/&gt;
    +			if (jobManagerRunners.containsKey(jobId)) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Removed.&lt;/p&gt;</comment>
                            <comment id="16285632" author="githubbot" created="Mon, 11 Dec 2017 08:12:46 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Changes look good. Will merge this.&lt;/p&gt;</comment>
                            <comment id="16289250" author="till.rohrmann" created="Wed, 13 Dec 2017 13:27:26 +0000"  >&lt;p&gt;Fixed via 7ddb674cb17c35f17aa073d3bfd6897d7fc13b9e&lt;/p&gt;</comment>
                            <comment id="16289251" author="githubbot" created="Wed, 13 Dec 2017 13:28:03 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5107&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ndlr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>