<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:07:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20370] Result is wrong when sink primary key is not the same with query</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20370</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Both sources are upsert-kafka which synchronizes the changes from MySQL tables (source_city, source_customer). The sink is another MySQL table which is in upsert mode with &quot;city_name&quot; primary key. The join key is &quot;city_id&quot;. &lt;/p&gt;

&lt;p&gt;In this case, the result will be wrong when updating &lt;tt&gt;source_city.city_name&lt;/tt&gt; column in MySQL, as the UPDATE_BEFORE is ignored and the old city_name is retained in the sink table. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Sink(table=[default_catalog.default_database.sink_kafka_count_city], fields=[city_name, count_customer, sum_gender], changelogMode=[NONE])
+- Calc(select=[city_name, CAST(count_customer) AS count_customer, CAST(sum_gender) AS sum_gender], changelogMode=[I,UA,D])
   +- Join(joinType=[InnerJoin], where=[=(city_id, id)], select=[city_id, count_customer, sum_gender, id, city_name], leftInputSpec=[JoinKeyContainsUniqueKey], rightInputSpec=[JoinKeyContainsUniqueKey], changelogMode=[I,UA,D])
      :- Exchange(distribution=[hash[city_id]], changelogMode=[I,UA,D])
      :  +- GlobalGroupAggregate(groupBy=[city_id], select=[city_id, COUNT_RETRACT(count1$0) AS count_customer, SUM_RETRACT((sum$1, count$2)) AS sum_gender], changelogMode=[I,UA,D])
      :     +- Exchange(distribution=[hash[city_id]], changelogMode=[I])
      :        +- LocalGroupAggregate(groupBy=[city_id], select=[city_id, COUNT_RETRACT(*) AS count1$0, SUM_RETRACT(gender) AS (sum$1, count$2)], changelogMode=[I])
      :           +- Calc(select=[city_id, gender], changelogMode=[I,UB,UA,D])
      :              +- ChangelogNormalize(key=[customer_id], changelogMode=[I,UB,UA,D])
      :                 +- Exchange(distribution=[hash[customer_id]], changelogMode=[UA,D])
      :                    +- MiniBatchAssigner(interval=[3000ms], mode=[ProcTime], changelogMode=[UA,D])
      :                       +- TableSourceScan(table=[[default_catalog, default_database, source_customer]], fields=[customer_id, city_id, age, gender, update_time], changelogMode=[UA,D])
      +- Exchange(distribution=[hash[id]], changelogMode=[I,UA,D])
         +- ChangelogNormalize(key=[id], changelogMode=[I,UA,D])
            +- Exchange(distribution=[hash[id]], changelogMode=[UA,D])
               +- MiniBatchAssigner(interval=[3000ms], mode=[ProcTime], changelogMode=[UA,D])
                  +- TableSourceScan(table=[[default_catalog, default_database, source_city]], fields=[id, city_name], changelogMode=[UA,D])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We have suggested users to use the same key of the query as the primary key on sink in the documentation: &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-master/dev/table/sql/queries.html#deduplication&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-master/dev/table/sql/queries.html#deduplication&lt;/a&gt;. We should make this attention to be more highlight in CREATE TABLE page. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13342784">FLINK-20370</key>
            <summary>Result is wrong when sink primary key is not the same with query</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lincoln.86xy">lincoln lee</assignee>
                                    <reporter username="jark">Jark Wu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 26 Nov 2020 08:43:29 +0000</created>
                <updated>Thu, 13 Jan 2022 07:52:53 +0000</updated>
                            <resolved>Wed, 8 Dec 2021 09:04:18 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.13.6</fixVersion>
                    <fixVersion>1.14.3</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>17</watches>
                                                                                                                <comments>
                            <comment id="17239123" author="jark" created="Thu, 26 Nov 2020 08:47:23 +0000"  >&lt;p&gt;I think this is not a trivial work. And the problems are not only sit in Join, but also other operations (e.g. TopN, Aggregation). &lt;br/&gt;
We should figure out a comprehensive solution for this. For example, do not ignore UPDATE_BEFORE when PK is not equal ? &lt;/p&gt;</comment>
                            <comment id="17239139" author="fsk119" created="Thu, 26 Nov 2020 09:20:16 +0000"  >&lt;p&gt;I am not sure whether this Jira will take the example below into the consideration.&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE WordCountSource (
  word STRING,
  cnt INT,
  PRIMARY KEY (word) NOT ENFORCED
) WITH (
  ...
)

CREATE TABLE WordCountSink (
  word STRING,
  cnt INT,
  PRIMARY KEY (cnt) NOT ENFORCED
) WITH (
  ...
)

INSERT INTO WordCountSink SELECT * FROM  WordCountSource;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If we have two records &lt;tt&gt;(&apos;a&apos;, 1), (&apos;b&apos;, 1)&lt;/tt&gt;, the rowkind of the record &lt;tt&gt;(&apos;b&apos;, 1)&lt;/tt&gt; is insert for souce but it is update for sink.&lt;/p&gt;</comment>
                            <comment id="17239147" author="jark" created="Thu, 26 Nov 2020 09:32:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fsk119&quot; class=&quot;user-hover&quot; rel=&quot;fsk119&quot;&gt;fsk119&lt;/a&gt;, no, this will not be considered, because it has the same semantic with batch query. &lt;br/&gt;
You can run your above code in MySQL, and you will get the same result. &lt;br/&gt;
However, running the example of JIRA description in MySQL, will get a different result. &lt;/p&gt;</comment>
                            <comment id="17411971" author="twalthr" created="Wed, 8 Sep 2021 14:37:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; What is the current status of this issue? As far as I understand it, it can still occur that inferred unique key != primary key of the sink, right? Why don&apos;t we add a check that can be disabled with a flag?&lt;/p&gt;</comment>
                            <comment id="17412302" author="lzljs3620320" created="Thu, 9 Sep 2021 02:51:06 +0000"  >&lt;p&gt;Yes, it seems that the only solution is single parallelism.&lt;/p&gt;

&lt;p&gt;A upsert sink can accept inputs:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;primary key = unique key, it is OK, nothing needs to do.&lt;/li&gt;
	&lt;li&gt;input is append only, sometimes is OK, We can only assume that users can allow some degree of distributed disorder.&lt;/li&gt;
	&lt;li&gt;input is change log, primary key != unique key (unique key can be none), the most problematic situation&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17412317" author="jark" created="Thu, 9 Sep 2021 03:40:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; could UpsertMaterialize also solve this problem?&lt;/p&gt;</comment>
                            <comment id="17412318" author="jark" created="Thu, 9 Sep 2021 03:41:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; there is 4th case: input is changelog, but there is no unique key. &lt;/p&gt;</comment>
                            <comment id="17412323" author="lzljs3620320" created="Thu, 9 Sep 2021 03:59:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; I updated cases.&lt;br/&gt;
I think UpsertMaterialize can works. For the third case, we can add UpsertMaterialize, but sometimes it may be redundant.&lt;/p&gt;</comment>
                            <comment id="17412497" author="twalthr" created="Thu, 9 Sep 2021 10:23:02 +0000"  >&lt;p&gt;Even in case 2, if users declare a PRIMARY KEY for Kafka the same keys should end up in the same partition. Distributed disorder should only be allowed if the sink does not declare a PRIMARY KEY. We should aim for correctness and add a keyBy for case 2 and enable UpsertMaterialize for case 3. Of course, this can be disabled if necessary.&lt;/p&gt;

&lt;p&gt;I mentioned it in a different issue already, but we should also introduce hints that allow those important settings for sources and sinks fine-grained per INSERT INTO. I will open an issue for that if it doesn&apos;t exist yet.&lt;/p&gt;</comment>
                            <comment id="17412518" author="lzljs3620320" created="Thu, 9 Sep 2021 11:16:38 +0000"  >&lt;p&gt;hints +1&lt;/p&gt;</comment>
                            <comment id="17413207" author="twalthr" created="Fri, 10 Sep 2021 14:17:22 +0000"  >&lt;p&gt;I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24254&quot; title=&quot;Support configuration hints for table sources and sinks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24254&quot;&gt;FLINK-24254&lt;/a&gt;. Any opinion to my other suggestion above for the 3 use cases?&lt;/p&gt;</comment>
                            <comment id="17420489" author="lzljs3620320" created="Mon, 27 Sep 2021 05:50:27 +0000"  >&lt;p&gt;4.primary key contains unique key , in this case, we can just convert UPDATE_BEFORE/UPDATE_AFTER to DELETE/INSERT. This is a optimization for UpsertMaterialize.&lt;/p&gt;</comment>
                            <comment id="17439135" author="lincoln.86xy" created="Fri, 5 Nov 2021 10:00:18 +0000"  >&lt;p&gt;After discussed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; , we found that `upsertMaterialization` cannot solve this problem.&lt;br/&gt;
The root cause is `FlinkChangelogModeInferenceProgram` didn&apos;t consider&#160; the case when sink&apos;s primary key differs from input&apos;s upsert keys when infer required `ChangeLogMode` from sink node.&lt;br/&gt;
I&apos;ll update the pr later.&lt;/p&gt;</comment>
                            <comment id="17439220" author="wenlong.lwl" created="Fri, 5 Nov 2021 12:02:33 +0000"  >&lt;p&gt;hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt;, could you explain more about case 2, what should we guarantee semantically in this case? If the input of sink actually has the same    pk with sink, and is insert-only, I think there is no distribution disorder. If the input of sink doesn&apos;t have the same pk with sink, and is insert-only, I have no idea what guarantee can be provided by adding a key-by?&lt;/p&gt;</comment>
                            <comment id="17439361" author="twalthr" created="Fri, 5 Nov 2021 16:10:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wenlong.lwl&quot; class=&quot;user-hover&quot; rel=&quot;wenlong.lwl&quot;&gt;wenlong.lwl&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If the input of sink actually has the same pk with sink, and is insert-only, I think there is no distribution disorder.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That is correct.&lt;/p&gt;

&lt;p&gt;But let&apos;s assume the following schema:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE A (uid INT, name STRING)

CREATE TABLE B (uid INT, name STRING, PRIMARY KEY(uid))

INSERT INTO B SELECT * FROM A;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In databases this query is totally fine because partitions don&apos;t exist. Please correct me if I&apos;m wrong but in Flink it could cause issues, because we don&apos;t shuffle on uid here and different uid could end up in different Kafka partitions in the end.&lt;/p&gt;</comment>
                            <comment id="17440150" author="lzljs3620320" created="Mon, 8 Nov 2021 02:29:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; Kafka partitioning should be another matter, depending on the user&apos;s connector option, for example, using upsert-kafka or `sink.partitioner`.&lt;br/&gt;
In my opinion, if the parallelism changes, such as the parallelism of source and sink is different, the final result will be random, which may not meet the user&apos;s expectations. So the premise is to change parallelism.&lt;/p&gt;</comment>
                            <comment id="17440153" author="wenlong.lwl" created="Mon, 8 Nov 2021 02:41:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; thanks for the explanation. &lt;br/&gt;
However, I think when the sink is kafka with pk(I would assume that it is a upsert kafka with key format provided), the target Kafka partition of a record is decided by the key generated. event it is written at different subtask. &lt;br/&gt;
In such case, I think adding a key-by can help keep the order of record with the same uid, only when the input is already partitioned by uid. Is this case is what you want to solve?  &lt;/p&gt;</comment>
                            <comment id="17440534" author="twalthr" created="Mon, 8 Nov 2021 15:12:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wenlong.lwl&quot; class=&quot;user-hover&quot; rel=&quot;wenlong.lwl&quot;&gt;wenlong.lwl&lt;/a&gt; I guess for Kafka you are right. Kafka is doing the partitioning for us already with the default sink partitioner and given Kafka key. The only missing case is if you do a &lt;tt&gt;StreamTableEnvironment.toChangelogStream&lt;/tt&gt; with a declared primary key, the user needs to take case of the partitioning in this case. But that might be acceptable. &lt;/p&gt;</comment>
                            <comment id="17441679" author="lincoln.86xy" created="Wed, 10 Nov 2021 11:35:44 +0000"  >&lt;p&gt;Thanks for all your inputs!&lt;br/&gt;
Based on Jingson&apos;s summary and the discussion, let me try to summarize, please correct me if I&apos;m wrong&lt;/p&gt;

&lt;p&gt;An upsert sink can accept such inputs:&lt;br/&gt;
1. input is changelog stream&#160;&lt;br/&gt;
1.1 primary key = upsert key, it&apos;s already ok&#160;&lt;br/&gt;
1.2 primary key != upsert key (upsert key can be none), we should add upsertMaterialize&lt;br/&gt;
1.3 primary key contains upsert key, upsertMaterialize can be ommitted but sink requires update_before&lt;/p&gt;

&lt;p&gt;2. input is append stream&lt;br/&gt;
2.1 sink has same parallelism with the upstream operator, it&apos;s ok&lt;br/&gt;
2.2 sink&apos;s parallelism differs from the upstream operator, we should add a &apos;keyby&apos; for the primary key by default&lt;/p&gt;

&lt;p&gt;The current pr already addressed 1.2 &amp;amp; 1.3, so remaining the 2.2 to be done. The fix is simple, but for the sake of be configurable,&#160;&lt;br/&gt;
we should introduce another job level config option similar to &apos;table.exec.sink.upsert-materialize&apos; (since &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24254&quot; title=&quot;Support configuration hints for table sources and sinks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24254&quot;&gt;FLINK-24254&lt;/a&gt; fine-grained setting per INSERT INTO not ready now)&#160;&lt;br/&gt;
I temporally name it &apos;table.exec.sink.pk-shuffle&apos;,&#160; and updated the pr, welcome your suggestions.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wenlong.lwl&quot; class=&quot;user-hover&quot; rel=&quot;wenlong.lwl&quot;&gt;wenlong.lwl&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17447239" author="lincoln.86xy" created="Mon, 22 Nov 2021 08:10:55 +0000"  >&lt;p&gt;According to Jingsong&apos;s review comments, I&apos;ve split the change into two. The 1st part solve the 1.2 &amp;amp; 1.3 above, and a following one address the 2.2 which will introduce a config option &apos;table.exec.sink.pk-shuffle&apos;.&lt;/p&gt;</comment>
                            <comment id="17447367" author="wenlong.lwl" created="Mon, 22 Nov 2021 12:26:31 +0000"  >&lt;p&gt;hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lincoln.86xy&quot; class=&quot;user-hover&quot; rel=&quot;lincoln.86xy&quot;&gt;lincoln.86xy&lt;/a&gt;, what do you think we should provide when the sink is a DataStreamSinkProvider/TransformationSinkProvider? In such cases, we have no idea about the parallelism of sink, I think this is the case missed in the summary.&lt;/p&gt;</comment>
                            <comment id="17447729" author="lincoln.86xy" created="Tue, 23 Nov 2021 02:23:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wenlong.lwl&quot; class=&quot;user-hover&quot; rel=&quot;wenlong.lwl&quot;&gt;wenlong.lwl&lt;/a&gt; &#160;Good question!&#160; I think it&#8216;s safe adding &#8216;keyby&#8217; by default for the two kinds of sink if we can&apos;t get parallelism (users can choose to turn it off explicitly).&lt;/p&gt;

&lt;p&gt;What do you think? &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17450263" author="lincoln.86xy" created="Mon, 29 Nov 2021 08:48:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wenlong.lwl&quot; class=&quot;user-hover&quot; rel=&quot;wenlong.lwl&quot;&gt;wenlong.lwl&lt;/a&gt; &#160;After look into the `TransformationSinkProvider` and `DataStreamSinkProvider`, I found it&apos;s unnecessary to add `keyby` because&lt;br/&gt;
1. `DataStreamSinkProvider` implements the `ParallelismProvider` interface so that its parallelism can be detected.&lt;br/&gt;
2. the internal `TransformationSinkProvider` is used for `ExternalDynamicSink`, when convert to `datastream` it will apply the input&apos;s parallelism so it always the same as the input.&lt;/p&gt;

&lt;p&gt;pls correct me if I&apos;m wrong.&lt;/p&gt;</comment>
                            <comment id="17450880" author="wenlong.lwl" created="Tue, 30 Nov 2021 06:19:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lincoln.86xy&quot; class=&quot;user-hover&quot; rel=&quot;lincoln.86xy&quot;&gt;lincoln.86xy&lt;/a&gt; Even sink implements ParallelismProvider, parallelism can still be undefined, because it returns an optional value.&lt;/p&gt;</comment>
                            <comment id="17450999" author="lincoln.86xy" created="Tue, 30 Nov 2021 09:49:34 +0000"  >&lt;p&gt;After discussed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wenlong.lwl&quot; class=&quot;user-hover&quot; rel=&quot;wenlong.lwl&quot;&gt;wenlong.lwl&lt;/a&gt;&#160; offline and confirm the code, &#160;it is safe for TransformationSinkProvider.&lt;br/&gt;
For the DataStreamSinkProvider which is designed for advanced connector developers, it&apos;s necessary to pay attention to how changes are shuffled to not mess up the changelog per parallel subtask.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17453124" author="twalthr" created="Fri, 3 Dec 2021 16:18:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; are we planning to back port the change to 1.13 and 1.14? I know already one user that would benefit from a 1.14 back port.&lt;/p&gt;</comment>
                            <comment id="17453752" author="lzljs3620320" created="Mon, 6 Dec 2021 02:45:19 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;We have evaluated the impact of this fix and it does affect the compatibility of some correct plans. For example the plan:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;generates changes&lt;/li&gt;
	&lt;li&gt;No upsert keys&lt;/li&gt;
	&lt;li&gt;but it has no problems with the order&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This situation generates materialized node resulting in incompatibility.&lt;/p&gt;

&lt;p&gt;If we agree with the following assumptions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This incompatibility case is very rare&lt;/li&gt;
	&lt;li&gt;When this incompatibility occurs, the user can maintain compatibility by configuring option&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We can consider cherry-pick.&lt;/p&gt;

&lt;p&gt;What do you think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lincoln.86xy&quot; class=&quot;user-hover&quot; rel=&quot;lincoln.86xy&quot;&gt;lincoln.86xy&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17453964" author="twalthr" created="Mon, 6 Dec 2021 11:38:17 +0000"  >&lt;p&gt;Given that many people still wait for 1.14.1 and don&apos;t upgrade to a 1.XX.0 release. I think it is still reasonable to perform the change at least for the 1.14 branch. A user just needs to set `upsert-materialize` to `NONE`?&lt;/p&gt;</comment>
                            <comment id="17454329" author="lzljs3620320" created="Tue, 7 Dec 2021 01:58:46 +0000"  >&lt;p&gt;&amp;gt; A user just needs to set `upsert-materialize` to `NONE`?&lt;/p&gt;

&lt;p&gt;Yes. With the popularity of cdc and hudi, etc. I am +1 to back port.&lt;/p&gt;</comment>
                            <comment id="17454447" author="martijnvisser" created="Tue, 7 Dec 2021 07:57:13 +0000"  >&lt;p&gt;Given the impact, I think it makes sense to wait with the 1.14.1 release until this is backported, what do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; ? If so, it would be good to get a fix in for 1.14 asap given that we want to start releasing that soon. &lt;/p&gt;</comment>
                            <comment id="17454467" author="lzljs3620320" created="Tue, 7 Dec 2021 08:38:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=MartijnVisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;MartijnVisser&lt;/a&gt; Got it, I will do it asap.&lt;/p&gt;</comment>
                            <comment id="17454921" author="lincoln.86xy" created="Wed, 8 Dec 2021 01:29:40 +0000"  >&lt;p&gt;I&apos;ve created the cherry pick: &lt;a href=&quot;https://github.com/apache/flink/pull/18048&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/18048&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; would you help to check it?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17455065" author="lzljs3620320" created="Wed, 8 Dec 2021 09:07:42 +0000"  >&lt;p&gt;Fixed via:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;part1: Fix wrong results when sink primary key is not the same with query result&apos;s changelog upsert key&lt;/p&gt;

&lt;p&gt;master: f8f6935adc841529ecdc0636174650cffbf73719&lt;/p&gt;

&lt;p&gt;release-1.14: 7c5ddbd201005e55ab68b4db7ee74c7cbeb13400&lt;/p&gt;

&lt;p&gt;release-1.13: 54aaffc7d9b2b06726294cf636d1b9acf74c5d49&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;part2: introduce &apos;table.exec.sink.keyed-shuffle&apos; option to auto keyby on sink&apos;s pk if parallelism are not the same for insertOnly input&lt;/p&gt;

&lt;p&gt;master: 9e76585f1fa110288604913a73d86ac2f1542777&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;part2 does not cherry-pick to 1.14 because it may affect the normal plan and lead to incompatibility.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13421189">FLINK-25559</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kyk0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>