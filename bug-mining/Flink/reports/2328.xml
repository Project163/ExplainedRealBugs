<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:32:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8740] Job-level metrics lost during job re-submission in HA mode</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8740</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When Flink is running in High Availability&#160;and a leader re-election occurs to the same job manager, the job is unable to register the job-level metrics due to a name collision.&#160;&lt;/p&gt;

&lt;p&gt;This may occur even if a different Job Manager is elected, but as it is a local JobManagerMetricsGroup which spits out the error, that is unlikely the case.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Expected Behavior&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;When a job is forced to&#160;re-submit due to Job Manager re-election, job-level metrics should be available in the new instance of the job (uptime, checkpoints size, checkpoint duration, etc)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Actual Behavior&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;When job gets re-submitted, it is unable to register job-level metrics due to collision in the JobManagerMetricGroup, which leads to situation where even though job is running the metrics around checkpoints and uptime are not available&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Steps to reproduce&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Start up Flink in HA mode using ZooKeeper, single node is fine&lt;/li&gt;
	&lt;li&gt;Submit a job to the cluster&lt;/li&gt;
	&lt;li&gt;Stop and restart ZooKeeper&lt;/li&gt;
	&lt;li&gt;In Job Manager logs you will see the following errors:&lt;/li&gt;
	&lt;li&gt;&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;79043 2018-02-19 21:58:15,928 WARN org.apache.flink.metrics.MetricGroup - Name collision: Group already contains a Metric with the name &apos;totalNumberOfCheckpoints&apos;. Metric will not be reported....
79044 2018-02-19 21:58:15,928 WARN org.apache.flink.metrics.MetricGroup - Name collision: Group already contains a Metric with the name &apos;numberOfInProgressCheckpoints&apos;. Metric will not be reported....
79045 2018-02-19 21:58:15,928 WARN org.apache.flink.metrics.MetricGroup - Name collision: Group already contains a Metric with the name &apos;numberOfCompletedCheckpoints&apos;. Metric will not be reported....&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;Proposed Solution&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I suspect that there may be other related issues than just the metrics, but a code change that seems to fix the issue is that, during recovery, to remove the existing registered Job Metrics:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isRecovery) {
   log.info(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Removing metrics &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; $jobId, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; will be added during recover&quot;&lt;/span&gt;)
   jobManagerMetricGroup.removeJob(jobId)
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;d be happy to submit this in a PR if that is acceptable to open up the discussion, but I am not sure the consequences of not closing the previous JMMG or perhaps simply not re-registering job-level metrics during recovery. Doing this would seem to entail informing lower levels about the recovery.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13140045">FLINK-8740</key>
            <summary>Job-level metrics lost during job re-submission in HA mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="jdewald">Joshua DeWald</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Feb 2018 22:23:00 +0000</created>
                <updated>Thu, 28 Feb 2019 14:01:00 +0000</updated>
                            <resolved>Wed, 28 Mar 2018 15:27:59 +0000</resolved>
                                    <version>1.4.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16411511" author="githubbot" created="Fri, 23 Mar 2018 14:52:07 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8740&quot; title=&quot;Job-level metrics lost during job re-submission in HA mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8740&quot;&gt;&lt;del&gt;FLINK-8740&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Create new JobManagerJobMetricGroup when creating a new ExecutionGraph&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Closes the JobManagerJobMetricGroup when suspending the `JobManager`. This allows to reregister the job metrics when the `JobManager` regains its leadership.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Tested manually&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; jobLevelMetricsHA&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5755&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ef2de68bcad3c4715941a1e61d0a460b4c609520&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-03-23T13:08:49Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8740&quot; title=&quot;Job-level metrics lost during job re-submission in HA mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8740&quot;&gt;&lt;del&gt;FLINK-8740&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Create new JobManagerJobMetricGroup when creating a new ExecutionGraph&lt;/p&gt;

&lt;p&gt;commit 98a49cd032346a2b09641ee6d30baadf9a98855f&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-03-23T14:43:20Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Create ExecutionGraph when JobMaster is started&lt;/p&gt;

&lt;p&gt;    The ExecutionGraph is not a final resource in the JobMaster. For example, it is necessary&lt;br/&gt;
    to create a new ExecutionGraph when rescaling the job or when the JobMaster loses and&lt;br/&gt;
    regains its leadership.&lt;/p&gt;

&lt;p&gt;commit dcddfeb0b8883964505bed55d5b3730cae9abe60&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-03-23T14:46:29Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; Remove unused fields in JobMaster&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16413852" author="githubbot" created="Mon, 26 Mar 2018 13:32:36 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177090323&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177090323&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/factories/DefaultJobManagerJobMetricGroupFactory.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,46 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.jobmaster.factories;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerJobMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Implementation of &lt;/p&gt;
{@link JobManagerJobMetricGroupFactory}
&lt;p&gt; which makes sure that there is always&lt;br/&gt;
    + * at most one &lt;/p&gt;
{@link JobManagerJobMetricGroup}
&lt;p&gt; for a given &lt;/p&gt;
{@link JobID}
&lt;p&gt; registered.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class DefaultJobManagerJobMetricGroupFactory implements JobManagerJobMetricGroupFactory {&lt;br/&gt;
    +&lt;br/&gt;
    +	private final JobManagerMetricGroup jobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +	public DefaultJobManagerJobMetricGroupFactory(@Nonnull JobManagerMetricGroup jobManagerMetricGroup) &lt;/p&gt;
{
    +		this.jobManagerMetricGroup = jobManagerMetricGroup;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public JobManagerJobMetricGroup create(@Nonnull JobGraph jobGraph) {&lt;br/&gt;
    +		jobManagerMetricGroup.removeJob(jobGraph.getJobID());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This should only be necessary if the group wasn&apos;t properly cleaned up previously by the JobMaster, correct? If so I suggest for debugging purposes to modify `removeJob` to return a boolean indicating whether something was actually deleted and log that as a warning.&lt;/p&gt;</comment>
                            <comment id="16413853" author="githubbot" created="Mon, 26 Mar 2018 13:32:36 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177087225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177087225&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/factories/DefaultJobManagerJobMetricGroupFactory.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,46 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.jobmaster.factories;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerJobMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Implementation of &lt;/p&gt;
{@link JobManagerJobMetricGroupFactory}
&lt;p&gt; which makes sure that there is always&lt;br/&gt;
    + * at most one &lt;/p&gt;
{@link JobManagerJobMetricGroup}
&lt;p&gt; for a given &lt;/p&gt;
{@link JobID}
&lt;p&gt; registered.&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This comment is misleading as the `JobManagerMetricGroup` already ensures that at most one group is &lt;em&gt;registered&lt;/em&gt;.&lt;/p&gt;</comment>
                            <comment id="16415075" author="githubbot" created="Tue, 27 Mar 2018 06:11:55 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177317071&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177317071&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/factories/DefaultJobManagerJobMetricGroupFactory.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,46 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.jobmaster.factories;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerJobMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Implementation of &lt;/p&gt;
{@link JobManagerJobMetricGroupFactory}
&lt;p&gt; which makes sure that there is always&lt;br/&gt;
    + * at most one &lt;/p&gt;
{@link JobManagerJobMetricGroup}
&lt;p&gt; for a given &lt;/p&gt;
{@link JobID}
&lt;p&gt; registered.&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    True, will change it such that it says that it will remove previously registered `JobManagerJobMetricGroups`.&lt;/p&gt;</comment>
                            <comment id="16415076" author="githubbot" created="Tue, 27 Mar 2018 06:12:53 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177317210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177317210&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/factories/DefaultJobManagerJobMetricGroupFactory.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,46 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.jobmaster.factories;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerJobMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Implementation of &lt;/p&gt;
{@link JobManagerJobMetricGroupFactory}
&lt;p&gt; which makes sure that there is always&lt;br/&gt;
    + * at most one &lt;/p&gt;
{@link JobManagerJobMetricGroup}
&lt;p&gt; for a given &lt;/p&gt;
{@link JobID}
&lt;p&gt; registered.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class DefaultJobManagerJobMetricGroupFactory implements JobManagerJobMetricGroupFactory {&lt;br/&gt;
    +&lt;br/&gt;
    +	private final JobManagerMetricGroup jobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +	public DefaultJobManagerJobMetricGroupFactory(@Nonnull JobManagerMetricGroup jobManagerMetricGroup) &lt;/p&gt;
{
    +		this.jobManagerMetricGroup = jobManagerMetricGroup;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public JobManagerJobMetricGroup create(@Nonnull JobGraph jobGraph) {&lt;br/&gt;
    +		jobManagerMetricGroup.removeJob(jobGraph.getJobID());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes, but the `JobMaster` does not have access to the `JobManagerMetricGroup`. That&apos;s why it is necessary to remove it here. Can change the return type of `JobManagerMetricGroup#removeJob` but I think it is not strictly necessary.&lt;/p&gt;</comment>
                            <comment id="16415078" author="githubbot" created="Tue, 27 Mar 2018 06:17:45 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177317868&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177317868&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/factories/DefaultJobManagerJobMetricGroupFactory.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,46 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.jobmaster.factories;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerJobMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Implementation of &lt;/p&gt;
{@link JobManagerJobMetricGroupFactory}
&lt;p&gt; which makes sure that there is always&lt;br/&gt;
    + * at most one &lt;/p&gt;
{@link JobManagerJobMetricGroup}
&lt;p&gt; for a given &lt;/p&gt;
{@link JobID}
&lt;p&gt; registered.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class DefaultJobManagerJobMetricGroupFactory implements JobManagerJobMetricGroupFactory {&lt;br/&gt;
    +&lt;br/&gt;
    +	private final JobManagerMetricGroup jobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +	public DefaultJobManagerJobMetricGroupFactory(@Nonnull JobManagerMetricGroup jobManagerMetricGroup) &lt;/p&gt;
{
    +		this.jobManagerMetricGroup = jobManagerMetricGroup;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public JobManagerJobMetricGroup create(@Nonnull JobGraph jobGraph) {&lt;br/&gt;
    +		jobManagerMetricGroup.removeJob(jobGraph.getJobID());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    We could also pass in the `JobManagerMetricGroup` into the `JobMaster`, but I think by only exposing the `JobManagerJobMetricGroup` to it, gives a better separation of concerns.&lt;/p&gt;</comment>
                            <comment id="16415195" author="githubbot" created="Tue, 27 Mar 2018 08:10:17 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177340014&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177340014&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/factories/DefaultJobManagerJobMetricGroupFactory.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,46 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.jobmaster.factories;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerJobMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Implementation of &lt;/p&gt;
{@link JobManagerJobMetricGroupFactory}
&lt;p&gt; which makes sure that there is always&lt;br/&gt;
    + * at most one &lt;/p&gt;
{@link JobManagerJobMetricGroup}
&lt;p&gt; for a given &lt;/p&gt;
{@link JobID}
&lt;p&gt; registered.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class DefaultJobManagerJobMetricGroupFactory implements JobManagerJobMetricGroupFactory {&lt;br/&gt;
    +&lt;br/&gt;
    +	private final JobManagerMetricGroup jobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +	public DefaultJobManagerJobMetricGroupFactory(@Nonnull JobManagerMetricGroup jobManagerMetricGroup) &lt;/p&gt;
{
    +		this.jobManagerMetricGroup = jobManagerMetricGroup;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public JobManagerJobMetricGroup create(@Nonnull JobGraph jobGraph) {&lt;br/&gt;
    +		jobManagerMetricGroup.removeJob(jobGraph.getJobID());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    you could use the same pattern we use for `TaskMetricGroups`, which remove themselves from their parent `TaskManagerJobMetricGroup` when they are closed. That said I&apos;m not really fond of it.&lt;/p&gt;

&lt;p&gt;    You could also add a `reset` method to the `JobManagerJobMetricGroup` that removes all metrics. This may be more reasonable than replacing the group.&lt;/p&gt;</comment>
                            <comment id="16415655" author="githubbot" created="Tue, 27 Mar 2018 13:56:36 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177433332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177433332&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/factories/DefaultJobManagerJobMetricGroupFactory.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,46 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.jobmaster.factories;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerJobMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Implementation of &lt;/p&gt;
{@link JobManagerJobMetricGroupFactory}
&lt;p&gt; which makes sure that there is always&lt;br/&gt;
    + * at most one &lt;/p&gt;
{@link JobManagerJobMetricGroup}
&lt;p&gt; for a given &lt;/p&gt;
{@link JobID}
&lt;p&gt; registered.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class DefaultJobManagerJobMetricGroupFactory implements JobManagerJobMetricGroupFactory {&lt;br/&gt;
    +&lt;br/&gt;
    +	private final JobManagerMetricGroup jobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +	public DefaultJobManagerJobMetricGroupFactory(@Nonnull JobManagerMetricGroup jobManagerMetricGroup) &lt;/p&gt;
{
    +		this.jobManagerMetricGroup = jobManagerMetricGroup;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public JobManagerJobMetricGroup create(@Nonnull JobGraph jobGraph) {&lt;br/&gt;
    +		jobManagerMetricGroup.removeJob(jobGraph.getJobID());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think closing the `JobManagerJobMetricGroup` alone is not enough, because then we still have to create a fresh one.&lt;/p&gt;

&lt;p&gt;    I was a bit hesitant changing the `AbstractMetricGroup` because to me it looked as if you could only add metrics but never remove them (except when closing). So in order to be as little invasive as possible, I went for the approach where we create a fresh metrics group whenever we recreate the `ExecutionGraph`.&lt;/p&gt;

&lt;p&gt;    Given the factory, this could also be easily changed later because whether you create a fresh instance or reset it is an implementation detail.&lt;/p&gt;</comment>
                            <comment id="16415665" author="githubbot" created="Tue, 27 Mar 2018 14:06:34 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177436964&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177436964&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/factories/DefaultJobManagerJobMetricGroupFactory.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,46 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.jobmaster.factories;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerJobMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Implementation of &lt;/p&gt;
{@link JobManagerJobMetricGroupFactory}
&lt;p&gt; which makes sure that there is always&lt;br/&gt;
    + * at most one &lt;/p&gt;
{@link JobManagerJobMetricGroup}
&lt;p&gt; for a given &lt;/p&gt;
{@link JobID}
&lt;p&gt; registered.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class DefaultJobManagerJobMetricGroupFactory implements JobManagerJobMetricGroupFactory {&lt;br/&gt;
    +&lt;br/&gt;
    +	private final JobManagerMetricGroup jobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +	public DefaultJobManagerJobMetricGroupFactory(@Nonnull JobManagerMetricGroup jobManagerMetricGroup) &lt;/p&gt;
{
    +		this.jobManagerMetricGroup = jobManagerMetricGroup;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public JobManagerJobMetricGroup create(@Nonnull JobGraph jobGraph) {&lt;br/&gt;
    +		jobManagerMetricGroup.removeJob(jobGraph.getJobID());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    yes, you would still need the factory when using the `TaskMetricGroup`-like pattern, but then&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the factory wouldn&apos;t have that odd side-effect&lt;/li&gt;
	&lt;li&gt;there would be a single &lt;em&gt;expected&lt;/em&gt; path on which metrics are unregistered (currently, the last `JobManagerMetricGroup` is implicitly closed when the `JobManagerMetricGroup` is closed)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16415794" author="githubbot" created="Tue, 27 Mar 2018 15:22:18 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177466102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177466102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/factories/DefaultJobManagerJobMetricGroupFactory.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,46 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.runtime.jobmaster.factories;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.JobID;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.JobGraph;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerJobMetricGroup;&lt;br/&gt;
    +import org.apache.flink.runtime.metrics.groups.JobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.annotation.Nonnull;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Implementation of &lt;/p&gt;
{@link JobManagerJobMetricGroupFactory}
&lt;p&gt; which makes sure that there is always&lt;br/&gt;
    + * at most one &lt;/p&gt;
{@link JobManagerJobMetricGroup}
&lt;p&gt; for a given &lt;/p&gt;
{@link JobID}
&lt;p&gt; registered.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class DefaultJobManagerJobMetricGroupFactory implements JobManagerJobMetricGroupFactory {&lt;br/&gt;
    +&lt;br/&gt;
    +	private final JobManagerMetricGroup jobManagerMetricGroup;&lt;br/&gt;
    +&lt;br/&gt;
    +	public DefaultJobManagerJobMetricGroupFactory(@Nonnull JobManagerMetricGroup jobManagerMetricGroup) &lt;/p&gt;
{
    +		this.jobManagerMetricGroup = jobManagerMetricGroup;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Override&lt;br/&gt;
    +	public JobManagerJobMetricGroup create(@Nonnull JobGraph jobGraph) {&lt;br/&gt;
    +		jobManagerMetricGroup.removeJob(jobGraph.getJobID());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    You&apos;re right, I will change it like you&apos;ve described:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Call `JobManagerJobMetricGroup#close` explicitly&lt;/li&gt;
	&lt;li&gt;Remove `JobManagerMetricGroup#removeJob` from `DefaultJobManagerJobMetricGroupFactory`&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16415799" author="githubbot" created="Tue, 27 Mar 2018 15:22:54 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @zentol, I&apos;ve addressed your comments and updated the PR accordingly.&lt;/p&gt;</comment>
                            <comment id="16415934" author="githubbot" created="Tue, 27 Mar 2018 17:03:46 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177497889&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177497889&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java &amp;#8212;&lt;br/&gt;
    @@ -165,7 +166,7 @@&lt;br/&gt;
     	private final BlobServer blobServer;&lt;/p&gt;

&lt;p&gt;     	/** The metrics for the job. */&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    outdated comment&lt;/p&gt;</comment>
                            <comment id="16417106" author="githubbot" created="Wed, 28 Mar 2018 09:50:26 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755#discussion_r177695516&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755#discussion_r177695516&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/JobMaster.java &amp;#8212;&lt;br/&gt;
    @@ -165,7 +166,7 @@&lt;br/&gt;
     	private final BlobServer blobServer;&lt;/p&gt;

&lt;p&gt;     	/** The metrics for the job. */&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Will remove it.&lt;/p&gt;</comment>
                            <comment id="16417107" author="githubbot" created="Wed, 28 Mar 2018 09:50:31 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @zentol. Addressing your last comment while merging this PR.&lt;/p&gt;</comment>
                            <comment id="16417541" author="githubbot" created="Wed, 28 Mar 2018 15:26:20 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5755&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5755&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16417550" author="till.rohrmann" created="Wed, 28 Mar 2018 15:27:59 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
master: 9a31deae7ebdbda5a78f19ae8967e6b9d35834a4&lt;br/&gt;
1.5.0: 237563215fa9d8f51fc9387c217e0fafed095fca&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qg1b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>