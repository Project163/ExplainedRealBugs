<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8268] Test instability for &apos;TwoPhaseCommitSinkFunctionTest&apos;</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8268</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The following exception / failure message occurs.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Tests run: 5, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 1.824 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.flink.streaming.api.functions.sink.TwoPhaseCommitSinkFunctionTest
testIgnoreCommitExceptionDuringRecovery(org.apache.flink.streaming.api.functions.sink.TwoPhaseCommitSinkFunctionTest)  Time elapsed: 0.068 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.Exception: Could not complete snapshot 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; MockTask (1/1).
	at java.io.FileOutputStream.writeBytes(Native Method)
	at java.io.FileOutputStream.write(FileOutputStream.java:326)
	at sun.nio.cs.StreamEncoder.writeBytes(StreamEncoder.java:221)
	at sun.nio.cs.StreamEncoder.implFlushBuffer(StreamEncoder.java:291)
	at sun.nio.cs.StreamEncoder.implFlush(StreamEncoder.java:295)
	at sun.nio.cs.StreamEncoder.flush(StreamEncoder.java:141)
	at java.io.OutputStreamWriter.flush(OutputStreamWriter.java:229)
	at java.io.BufferedWriter.flush(BufferedWriter.java:254)
	at org.apache.flink.streaming.api.functions.sink.TwoPhaseCommitSinkFunctionTest$FileBasedSinkFunction.preCommit(TwoPhaseCommitSinkFunctionTest.java:313)
	at org.apache.flink.streaming.api.functions.sink.TwoPhaseCommitSinkFunctionTest$FileBasedSinkFunction.preCommit(TwoPhaseCommitSinkFunctionTest.java:288)
	at org.apache.flink.streaming.api.functions.sink.TwoPhaseCommitSinkFunction.snapshotState(TwoPhaseCommitSinkFunction.java:290)
	at org.apache.flink.streaming.util.functions.StreamingFunctionUtils.trySnapshotFunctionState(StreamingFunctionUtils.java:118)
	at org.apache.flink.streaming.util.functions.StreamingFunctionUtils.snapshotFunctionState(StreamingFunctionUtils.java:99)
	at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.snapshotState(AbstractUdfStreamOperator.java:90)
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.snapshotState(AbstractStreamOperator.java:357)
	at org.apache.flink.streaming.util.AbstractStreamOperatorTestHarness.snapshot(AbstractStreamOperatorTestHarness.java:459)
	at org.apache.flink.streaming.api.functions.sink.TwoPhaseCommitSinkFunctionTest.testIgnoreCommitExceptionDuringRecovery(TwoPhaseCommitSinkFunctionTest.java:208)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13125249">FLINK-8268</key>
            <summary>Test instability for &apos;TwoPhaseCommitSinkFunctionTest&apos;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                            <label>test-stability</label>
                    </labels>
                <created>Fri, 15 Dec 2017 14:42:30 +0000</created>
                <updated>Mon, 8 Jan 2018 12:37:29 +0000</updated>
                            <resolved>Sat, 6 Jan 2018 06:56:26 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16298389" author="githubbot" created="Wed, 20 Dec 2017 12:19:07 +0000"  >&lt;p&gt;GitHub user pnowojski opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8268&quot; title=&quot;Test instability for &amp;#39;TwoPhaseCommitSinkFunctionTest&amp;#39;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8268&quot;&gt;&lt;del&gt;FLINK-8268&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Improve tests stability&lt;/p&gt;

&lt;p&gt;    This is a walk-around an error reported in the issue: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8268&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-8268&lt;/a&gt; . Instead of writing files to disk, this PR creates a simple in memory &quot;file like&quot; abstraction.&lt;/p&gt;

&lt;p&gt;    Second commit is to further improve stability by cleaning up the resources from `MockEnvironment`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This is change in tests.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/pnowojski/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pnowojski/flink&lt;/a&gt; f8268&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5193&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 129382c7d3a0d87afd8163e57a48f21819e4134c&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@...&amp;gt;&lt;br/&gt;
Date:   2017-12-20T10:23:26Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8268&quot; title=&quot;Test instability for &amp;#39;TwoPhaseCommitSinkFunctionTest&amp;#39;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8268&quot;&gt;&lt;del&gt;FLINK-8268&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;streaming&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Improve TwoPhaseCommitSinkFunctionTest stability by using custom in memory storage&lt;/p&gt;

&lt;p&gt;commit 55d0f4b197a062801c0763b7aeaf5d0bc64eac77&lt;br/&gt;
Author: Piotr Nowojski &amp;lt;piotr.nowojski@...&amp;gt;&lt;br/&gt;
Date:   2017-12-20T11:27:56Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Properly shutdown MockEnvironment to release resources&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16300686" author="githubbot" created="Thu, 21 Dec 2017 22:51:24 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158391433&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158391433&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/ContentDump.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.sink;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkState;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Utility class to simulate in memory file like writes, flushes and closing.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ContentDump {&lt;br/&gt;
    +	private boolean writable = true;&lt;br/&gt;
    +	private Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt; filesContent = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	public Set&amp;lt;String&amp;gt; listFiles() &lt;/p&gt;
{
    +		return filesContent.keySet();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public void setWritable(boolean writable) &lt;/p&gt;
{
    +		this.writable = writable;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Creates an empty file.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public ContentWriter createWriter(String name) &lt;/p&gt;
{
    +		checkArgument(!filesContent.containsKey(name), &quot;File [%s] already exists&quot;, name);
    +		filesContent.put(name, new ArrayList&amp;lt;&amp;gt;());
    +		return new ContentWriter(name, this);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static void move(String name, ContentDump source, ContentDump target) {&lt;br/&gt;
    +		Collection&amp;lt;String&amp;gt; content = source.read(name);&lt;br/&gt;
    +		try (ContentWriter contentWriter = target.createWriter(name)) &lt;/p&gt;
{
    +			contentWriter.write(content).flush();
    +		}
&lt;p&gt;    +		source.delete(name);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public void delete(String name) &lt;/p&gt;
{
    +		filesContent.remove(name);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public Collection&amp;lt;String&amp;gt; read(String name) &lt;/p&gt;
{
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);
    +		checkState(content != null, &quot;Unknown file [%s]&quot;, name);
    +		List&amp;lt;String&amp;gt; result = new ArrayList&amp;lt;&amp;gt;(content);
    +		content.clear();
    +		return result;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void putContent(String name, List&amp;lt;String&amp;gt; values) {&lt;br/&gt;
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);&lt;br/&gt;
    +		checkState(content != null, &quot;Unknown file &lt;span class=&quot;error&quot;&gt;&amp;#91;%s&amp;#93;&lt;/span&gt;&quot;, name);&lt;br/&gt;
    +		if (!writable) &lt;/p&gt;
{
    +			throw new NotWritableException(name);
    +		}
&lt;p&gt;    +		content.addAll(values);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link ContentWriter}
&lt;p&gt; represents an abstraction that allows to putContent to the &lt;/p&gt;
{@link ContentDump}.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static class ContentWriter implements AutoCloseable {&lt;br/&gt;
    +		private final ContentDump contentDump;&lt;br/&gt;
    +		private final String name;&lt;br/&gt;
    +		private final List&amp;lt;String&amp;gt; buffer = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +		private boolean closed = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private ContentWriter(String name, ContentDump contentDump) {
    +			this.name = checkNotNull(name);
    +			this.contentDump = checkNotNull(contentDump);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public String getName() {
    +			return name;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public ContentWriter write(String value) {&lt;br/&gt;
    +			if (closed) {
    +				throw new IllegalStateException();
    +			}&lt;br/&gt;
    +			buffer.add(value);&lt;br/&gt;
    +			return this;&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public ContentWriter write(Collection&amp;lt;String&amp;gt; values) {
    +			values.forEach(this::write);
    +			return this;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public ContentWriter flush() {
    +			contentDump.putContent(name, buffer);
    +			return this;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void close() {
    +			buffer.clear();
    +			closed = true;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Exception thrown for an attempt to write into read-only {@link ContentDump}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public class NotWritableException extends RuntimeException {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This sounds like an `IOException` to me, though I guess it doesn&apos;t matter much for tests.&lt;/p&gt;</comment>
                            <comment id="16300687" author="githubbot" created="Thu, 21 Dec 2017 22:51:24 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158394743&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158394743&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/ContentDump.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.sink;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkState;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Utility class to simulate in memory file like writes, flushes and closing.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ContentDump {&lt;br/&gt;
    +	private boolean writable = true;&lt;br/&gt;
    +	private Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt; filesContent = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	public Set&amp;lt;String&amp;gt; listFiles() &lt;/p&gt;
{
    +		return filesContent.keySet();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public void setWritable(boolean writable) &lt;/p&gt;
{
    +		this.writable = writable;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Creates an empty file.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public ContentWriter createWriter(String name) &lt;/p&gt;
{
    +		checkArgument(!filesContent.containsKey(name), &quot;File [%s] already exists&quot;, name);
    +		filesContent.put(name, new ArrayList&amp;lt;&amp;gt;());
    +		return new ContentWriter(name, this);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static void move(String name, ContentDump source, ContentDump target) {&lt;br/&gt;
    +		Collection&amp;lt;String&amp;gt; content = source.read(name);&lt;br/&gt;
    +		try (ContentWriter contentWriter = target.createWriter(name)) &lt;/p&gt;
{
    +			contentWriter.write(content).flush();
    +		}
&lt;p&gt;    +		source.delete(name);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public void delete(String name) &lt;/p&gt;
{
    +		filesContent.remove(name);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public Collection&amp;lt;String&amp;gt; read(String name) &lt;/p&gt;
{
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);
    +		checkState(content != null, &quot;Unknown file [%s]&quot;, name);
    +		List&amp;lt;String&amp;gt; result = new ArrayList&amp;lt;&amp;gt;(content);
    +		content.clear();
    +		return result;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void putContent(String name, List&amp;lt;String&amp;gt; values) {&lt;br/&gt;
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);&lt;br/&gt;
    +		checkState(content != null, &quot;Unknown file &lt;span class=&quot;error&quot;&gt;&amp;#91;%s&amp;#93;&lt;/span&gt;&quot;, name);&lt;br/&gt;
    +		if (!writable) &lt;/p&gt;
{
    +			throw new NotWritableException(name);
    +		}
&lt;p&gt;    +		content.addAll(values);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link ContentWriter}
&lt;p&gt; represents an abstraction that allows to putContent to the &lt;/p&gt;
{@link ContentDump}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static class ContentWriter implements AutoCloseable {&lt;br/&gt;
    +		private final ContentDump contentDump;&lt;br/&gt;
    +		private final String name;&lt;br/&gt;
    +		private final List&amp;lt;String&amp;gt; buffer = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +		private boolean closed = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private ContentWriter(String name, ContentDump contentDump) &lt;/p&gt;
{
    +			this.name = checkNotNull(name);
    +			this.contentDump = checkNotNull(contentDump);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public String getName() &lt;/p&gt;
{
    +			return name;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public ContentWriter write(String value) {&lt;br/&gt;
    +			if (closed) &lt;/p&gt;
{
    +				throw new IllegalStateException();
    +			}
&lt;p&gt;    +			buffer.add(value);&lt;br/&gt;
    +			return this;&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public ContentWriter write(Collection&amp;lt;String&amp;gt; values) &lt;/p&gt;
{
    +			values.forEach(this::write);
    +			return this;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public ContentWriter flush() &lt;/p&gt;
{
    +			contentDump.putContent(name, buffer);
    +			return this;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void close() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Should we also simulate handling multiple closes here?&lt;/p&gt;</comment>
                            <comment id="16300688" author="githubbot" created="Thu, 21 Dec 2017 22:51:24 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158394094&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158394094&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -277,88 +263,67 @@ public void testLogTimeoutAlmostReachedWarningDuringRecovery() throws Exception&lt;/p&gt;

&lt;p&gt;     	private void assertExactlyOnce(List&amp;lt;String&amp;gt; expectedValues) throws IOException {&lt;br/&gt;
     		ArrayList&amp;lt;String&amp;gt; actualValues = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (File file : targetDirectory.listFiles()) {&lt;/li&gt;
	&lt;li&gt;actualValues.addAll(Files.readAllLines(file.toPath(), Charset.defaultCharset()));&lt;br/&gt;
    +		for (String name : targetDirectory.listFiles()) 
{
    +			actualValues.addAll(targetDirectory.read(name));
     		}
&lt;p&gt;     		Collections.sort(actualValues);&lt;br/&gt;
     		Collections.sort(expectedValues);&lt;br/&gt;
     		assertEquals(expectedValues, actualValues);&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private class FileBasedSinkFunction extends TwoPhaseCommitSinkFunction&amp;lt;String, FileTransaction, Void&amp;gt; {&lt;br/&gt;
    +	private class ContentDumpSinkFunction extends TwoPhaseCommitSinkFunction&amp;lt;String, ContentTransaction, Void&amp;gt; {&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public FileBasedSinkFunction() {&lt;br/&gt;
    +		public ContentDumpSinkFunction() {&lt;br/&gt;
     			super(&lt;/li&gt;
	&lt;li&gt;new KryoSerializer&amp;lt;&amp;gt;(FileTransaction.class, new ExecutionConfig()),&lt;br/&gt;
    +				new KryoSerializer&amp;lt;&amp;gt;(ContentTransaction.class, new ExecutionConfig()),&lt;br/&gt;
     				VoidSerializer.INSTANCE, clock);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (!tmpDirectory.isDirectory() || !targetDirectory.isDirectory()) 
{
    -				throw new IllegalArgumentException();
    -			}
&lt;p&gt;     		}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected void invoke(FileTransaction transaction, String value, Context context) throws Exception {&lt;/li&gt;
	&lt;li&gt;transaction.writer.write(value);&lt;br/&gt;
    +		protected void invoke(ContentTransaction transaction, String value, Context context) throws Exception 
{
    +			transaction.tmpContentWriter.write(value);
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected FileTransaction beginTransaction() throws Exception {&lt;/li&gt;
	&lt;li&gt;File tmpFile = new File(tmpDirectory, UUID.randomUUID().toString());&lt;/li&gt;
	&lt;li&gt;return new FileTransaction(tmpFile);&lt;br/&gt;
    +		protected ContentTransaction beginTransaction() throws Exception 
{
    +			return new ContentTransaction(tmpDirectory.createWriter(UUID.randomUUID().toString()));
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected void preCommit(FileTransaction transaction) throws Exception {&lt;/li&gt;
	&lt;li&gt;transaction.writer.flush();&lt;/li&gt;
	&lt;li&gt;transaction.writer.close();&lt;br/&gt;
    +		protected void preCommit(ContentTransaction transaction) throws Exception {&lt;br/&gt;
    +			transaction.tmpContentWriter.flush();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Should also call `transaction.tmpContentWriter.close()` after the precommit?&lt;/p&gt;</comment>
                            <comment id="16300689" author="githubbot" created="Thu, 21 Dec 2017 22:51:24 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158394946&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158394946&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/ContentDump.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.sink;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkState;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Utility class to simulate in memory file like writes, flushes and closing.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ContentDump {&lt;br/&gt;
    +	private boolean writable = true;&lt;br/&gt;
    +	private Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt; filesContent = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	public Set&amp;lt;String&amp;gt; listFiles() &lt;/p&gt;
{
    +		return filesContent.keySet();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public void setWritable(boolean writable) &lt;/p&gt;
{
    +		this.writable = writable;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Creates an empty file.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public ContentWriter createWriter(String name) &lt;/p&gt;
{
    +		checkArgument(!filesContent.containsKey(name), &quot;File [%s] already exists&quot;, name);
    +		filesContent.put(name, new ArrayList&amp;lt;&amp;gt;());
    +		return new ContentWriter(name, this);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static void move(String name, ContentDump source, ContentDump target) {&lt;br/&gt;
    +		Collection&amp;lt;String&amp;gt; content = source.read(name);&lt;br/&gt;
    +		try (ContentWriter contentWriter = target.createWriter(name)) &lt;/p&gt;
{
    +			contentWriter.write(content).flush();
    +		}
&lt;p&gt;    +		source.delete(name);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public void delete(String name) &lt;/p&gt;
{
    +		filesContent.remove(name);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public Collection&amp;lt;String&amp;gt; read(String name) &lt;/p&gt;
{
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);
    +		checkState(content != null, &quot;Unknown file [%s]&quot;, name);
    +		List&amp;lt;String&amp;gt; result = new ArrayList&amp;lt;&amp;gt;(content);
    +		content.clear();
    +		return result;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void putContent(String name, List&amp;lt;String&amp;gt; values) {&lt;br/&gt;
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);&lt;br/&gt;
    +		checkState(content != null, &quot;Unknown file &lt;span class=&quot;error&quot;&gt;&amp;#91;%s&amp;#93;&lt;/span&gt;&quot;, name);&lt;br/&gt;
    +		if (!writable) &lt;/p&gt;
{
    +			throw new NotWritableException(name);
    +		}
&lt;p&gt;    +		content.addAll(values);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link ContentWriter}
&lt;p&gt; represents an abstraction that allows to putContent to the &lt;/p&gt;
{@link ContentDump}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static class ContentWriter implements AutoCloseable {&lt;br/&gt;
    +		private final ContentDump contentDump;&lt;br/&gt;
    +		private final String name;&lt;br/&gt;
    +		private final List&amp;lt;String&amp;gt; buffer = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +		private boolean closed = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private ContentWriter(String name, ContentDump contentDump) &lt;/p&gt;
{
    +			this.name = checkNotNull(name);
    +			this.contentDump = checkNotNull(contentDump);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public String getName() &lt;/p&gt;
{
    +			return name;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public ContentWriter write(String value) {&lt;br/&gt;
    +			if (closed) &lt;/p&gt;
{
    +				throw new IllegalStateException();
    +			}
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: replace with `checkState(...)` with an error message, to be consistent with the rest of the class.&lt;/p&gt;</comment>
                            <comment id="16300690" author="githubbot" created="Thu, 21 Dec 2017 22:51:24 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158395271&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158395271&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/ContentDump.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.sink;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: Could also consider putting this under `org.apache.flink.streaming.util`. I have the feeling that we could consider using more of this class in other tests.&lt;/p&gt;</comment>
                            <comment id="16300691" author="githubbot" created="Thu, 21 Dec 2017 22:51:24 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158392202&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158392202&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/ContentDump.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.sink;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkState;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Utility class to simulate in memory file like writes, flushes and closing.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ContentDump {&lt;br/&gt;
    +	private boolean writable = true;&lt;br/&gt;
    +	private Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt; filesContent = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	public Set&amp;lt;String&amp;gt; listFiles() &lt;/p&gt;
{
    +		return filesContent.keySet();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public void setWritable(boolean writable) &lt;/p&gt;
{
    +		this.writable = writable;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Creates an empty file.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public ContentWriter createWriter(String name) &lt;/p&gt;
{
    +		checkArgument(!filesContent.containsKey(name), &quot;File [%s] already exists&quot;, name);
    +		filesContent.put(name, new ArrayList&amp;lt;&amp;gt;());
    +		return new ContentWriter(name, this);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static void move(String name, ContentDump source, ContentDump target) {&lt;br/&gt;
    +		Collection&amp;lt;String&amp;gt; content = source.read(name);&lt;br/&gt;
    +		try (ContentWriter contentWriter = target.createWriter(name)) &lt;/p&gt;
{
    +			contentWriter.write(content).flush();
    +		}
&lt;p&gt;    +		source.delete(name);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public void delete(String name) &lt;/p&gt;
{
    +		filesContent.remove(name);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public Collection&amp;lt;String&amp;gt; read(String name) {&lt;br/&gt;
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);&lt;br/&gt;
    +		checkState(content != null, &quot;Unknown file &lt;span class=&quot;error&quot;&gt;&amp;#91;%s&amp;#93;&lt;/span&gt;&quot;, name);&lt;br/&gt;
    +		List&amp;lt;String&amp;gt; result = new ArrayList&amp;lt;&amp;gt;(content);&lt;br/&gt;
    +		content.clear();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Why are we clearing the list here?&lt;/p&gt;</comment>
                            <comment id="16300723" author="githubbot" created="Thu, 21 Dec 2017 23:31:28 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158398663&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158398663&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperatorTest.java &amp;#8212;&lt;br/&gt;
    @@ -823,39 +839,44 @@ public void testPointSessions() throws Exception {&lt;br/&gt;
     				0,&lt;br/&gt;
     				null /* late data output tag */);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;OneInputStreamOperatorTestHarness&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;, Tuple3&amp;lt;String, Long, Long&amp;gt;&amp;gt; testHarness =&lt;/li&gt;
	&lt;li&gt;new KeyedOneInputStreamOperatorTestHarness&amp;lt;&amp;gt;(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);&lt;br/&gt;
    -&lt;br/&gt;
     		ConcurrentLinkedQueue&amp;lt;Object&amp;gt; expectedOutput = new ConcurrentLinkedQueue&amp;lt;&amp;gt;();&lt;br/&gt;
    +		OperatorStateHandles snapshot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;testHarness.open();&lt;br/&gt;
    +		try (OneInputStreamOperatorTestHarness&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;, Tuple3&amp;lt;String, Long, Long&amp;gt;&amp;gt; testHarness =&lt;br/&gt;
    +				createTestHarness(operator)) 
{
    +			testHarness.open();
     
    -		// add elements out-of-order
    -		testHarness.processElement(new StreamRecord&amp;lt;&amp;gt;(new Tuple2&amp;lt;&amp;gt;(&quot;key2&quot;, 1), 0));
    -		testHarness.processElement(new StreamRecord&amp;lt;&amp;gt;(new Tuple2&amp;lt;&amp;gt;(&quot;key2&quot;, 33), 1000));
    +			// add elements out-of-order
    +			testHarness.processElement(new StreamRecord&amp;lt;&amp;gt;(new Tuple2&amp;lt;&amp;gt;(&quot;key2&quot;, 1), 0));
    +			testHarness.processElement(new StreamRecord&amp;lt;&amp;gt;(new Tuple2&amp;lt;&amp;gt;(&quot;key2&quot;, 33), 1000));
     
    -		// do a snapshot, close and restore again
    -		OperatorStateHandles snapshot = testHarness.snapshot(0L, 0L);
    -		testHarness.close();
    -		testHarness.setup();
    -		testHarness.initializeState(snapshot);
    -		testHarness.open();
    +			// do a snapshot, close and restore again
    +			snapshot = testHarness.snapshot(0L, 0L);
    +		}
&lt;p&gt;    +		try (OneInputStreamOperatorTestHarness&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;, Tuple3&amp;lt;String, Long, Long&amp;gt;&amp;gt; testHarness =&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: empty line above here.&lt;/p&gt;</comment>
                            <comment id="16300724" author="githubbot" created="Thu, 21 Dec 2017 23:31:28 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158397131&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158397131&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/TaskTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -145,19 +145,7 @@ public MemoryManager getMemoryManager() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@After&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdownIOManager() throws Exception 
{
    -		this.mockEnv.getIOManager().shutdown();
    -		Assert.assertTrue(&quot;IO Manager has not properly shut down.&quot;, this.mockEnv.getIOManager().isProperlyShutDown());
    -	}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;@After&lt;/li&gt;
	&lt;li&gt;public void shutdownMemoryManager() throws Exception {&lt;/li&gt;
	&lt;li&gt;if (this.memorySize &amp;gt; 0) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This memory size pre-check was lost in translation after the refactoring. Not sure if that matters, though.&lt;/p&gt;</comment>
                            <comment id="16300725" author="githubbot" created="Thu, 21 Dec 2017 23:31:28 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158400189&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158400189&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/util/AbstractStreamOperatorTestHarness.java &amp;#8212;&lt;br/&gt;
    @@ -492,6 +503,10 @@ public void close() throws Exception &lt;/p&gt;
{
     			processingTimeService.shutdownService();
     		}
&lt;p&gt;     		setupCalled = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		if (internalEnvironment.isPresent()) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Or, another option, if we make sure the `MockEnvironment::close()` method is idempotent, we don&apos;t really need to differentiate whether or not the environment is internally created, and just always close the environment when closing the test harness.&lt;/p&gt;

&lt;p&gt;    That could probably make things even more safer?&lt;/p&gt;</comment>
                            <comment id="16300726" author="githubbot" created="Thu, 21 Dec 2017 23:31:28 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158401540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158401540&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/util/SourceFunctionUtil.java &amp;#8212;&lt;br/&gt;
    @@ -42,22 +41,32 @@&lt;br/&gt;
     public class SourceFunctionUtil {&lt;/p&gt;

&lt;p&gt;     	public static &amp;lt;T extends Serializable&amp;gt; List&amp;lt;T&amp;gt; runSourceFunction(SourceFunction&amp;lt;T&amp;gt; sourceFunction) throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final List&amp;lt;T&amp;gt; outputs = new ArrayList&amp;lt;T&amp;gt;();&lt;br/&gt;
    -&lt;br/&gt;
     		if (sourceFunction instanceof RichFunction) 
{
    +			return runRichSourceFunction(sourceFunction);
    +		}
&lt;p&gt;    +		else &lt;/p&gt;
{
    +			return runNonRichSourceFunction(sourceFunction);
    +		}
&lt;p&gt;    +	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +	private static &amp;lt;T extends Serializable&amp;gt; List&amp;lt;T&amp;gt; runRichSourceFunction(SourceFunction&amp;lt;T&amp;gt; sourceFunction) throws Exception {&lt;br/&gt;
    +		try (MockEnvironment environment = new MockEnvironment(&quot;MockTask&quot;, 3 * 1024 * 1024, new MockInputSplitProvider(), 1024)) {&lt;br/&gt;
     			AbstractStreamOperator&amp;lt;?&amp;gt; operator = mock(AbstractStreamOperator.class);&lt;br/&gt;
     			when(operator.getExecutionConfig()).thenReturn(new ExecutionConfig());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RuntimeContext runtimeContext =  new StreamingRuntimeContext(&lt;/li&gt;
	&lt;li&gt;operator,&lt;/li&gt;
	&lt;li&gt;new MockEnvironment(&quot;MockTask&quot;, 3 * 1024 * 1024, new MockInputSplitProvider(), 1024),&lt;/li&gt;
	&lt;li&gt;new HashMap&amp;lt;String, Accumulator&amp;lt;?, ?&amp;gt;&amp;gt;());&lt;br/&gt;
    -&lt;br/&gt;
    +			RuntimeContext runtimeContext = new StreamingRuntimeContext(&lt;br/&gt;
    +				operator,&lt;br/&gt;
    +				environment,&lt;br/&gt;
    +				new HashMap&amp;lt;&amp;gt;());&lt;br/&gt;
     			((RichFunction) sourceFunction).setRuntimeContext(runtimeContext);&lt;br/&gt;
    -&lt;br/&gt;
     			((RichFunction) sourceFunction).open(new Configuration());&lt;br/&gt;
    +&lt;br/&gt;
    +			return runNonRichSourceFunction(sourceFunction);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The fact that `runRichSourceFunction` ended with a `runNonRichSourceFunction` was a bit surprising for me.&lt;/p&gt;

&lt;p&gt;    It maybe can be read better if we simply had this:&lt;br/&gt;
    ```&lt;br/&gt;
    if (sourceFunction instanceof RichFunction) &lt;/p&gt;
{
        setupRichSourceFunction(sourceFunction);
    }
&lt;p&gt;    return runSourceFunction(sourceFunction);&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    where `setupUpSourceFunction` does all the operator / env / context mocking and invoking `setRuntimeContext`, `open` on the source function.&lt;/p&gt;

&lt;p&gt;    What do you think?&lt;/p&gt;</comment>
                            <comment id="16300727" author="githubbot" created="Thu, 21 Dec 2017 23:31:28 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158400738&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158400738&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperatorTest.java &amp;#8212;&lt;br/&gt;
    @@ -98,7 +99,13 @@&lt;br/&gt;
     	// late arriving event OutputTag&amp;lt;StreamRecord&amp;lt;IN&amp;gt;&amp;gt;&lt;br/&gt;
     	private static final OutputTag&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; lateOutputTag = new OutputTag&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt;(&quot;late-output&quot;) {};&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void testSlidingEventTimeWindows(OneInputStreamOperatorTestHarness&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;, Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; testHarness) throws Exception {&lt;br/&gt;
    +	private void testSlidingEventTimeWindows(OneInputStreamOperator&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;, Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; operator) throws Exception {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Just a clarification of all the refactoring in this class (please let me know if I got anything wrong):&lt;/p&gt;

&lt;p&gt;    The changes here had 2 major objectives -&lt;br/&gt;
    1. Always re-instantiate the test harness on the snapshot restore run.&lt;br/&gt;
    2. Always remember to close the test harness at the end of each test (and, therefore, closing the environment properly).&lt;/p&gt;

&lt;p&gt;    Correct?&lt;/p&gt;</comment>
                            <comment id="16300728" author="githubbot" created="Thu, 21 Dec 2017 23:31:28 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158399966&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158399966&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/util/AbstractStreamOperatorTestHarness.java &amp;#8212;&lt;br/&gt;
    @@ -492,6 +503,10 @@ public void close() throws Exception &lt;/p&gt;
{
     			processingTimeService.shutdownService();
     		}
&lt;p&gt;     		setupCalled = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		if (internalEnvironment.isPresent()) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Personal preference here, can ignore if you don&apos;t agree:&lt;/p&gt;

&lt;p&gt;    I somehow find it more intuitive to just say:&lt;br/&gt;
    ```&lt;br/&gt;
    if (environmentIsInternal) &lt;/p&gt;
{
        environment.close();
    }
&lt;p&gt;    ```&lt;br/&gt;
    i.e., we keep the boolean field `environmentIsInternal` instead of an optional field called `internalEnvironment`, which I personally got a bit confused with the other `environment` (while they are actually the same environment instance).&lt;/p&gt;</comment>
                            <comment id="16300729" author="githubbot" created="Thu, 21 Dec 2017 23:31:28 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r158401883&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r158401883&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -179,9 +179,6 @@ public void testFailBeforeNotify() throws Exception {&lt;br/&gt;
     		harness.initializeState(snapshot);&lt;/p&gt;

&lt;p&gt;     		assertExactlyOnce(Arrays.asList(&quot;42&quot;, &quot;43&quot;));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;closeTestHarness();&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;assertEquals(0, tmpDirectory.listFiles().size());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why are these lines removed?&lt;/p&gt;</comment>
                            <comment id="16307241" author="till.rohrmann" created="Sun, 31 Dec 2017 16:17:57 +0000"  >&lt;p&gt;Just for the record: Another test failure on Travis: &lt;a href=&quot;https://travis-ci.org/tillrohrmann/flink/jobs/322955365&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/tillrohrmann/flink/jobs/322955365&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16307425" author="githubbot" created="Mon, 1 Jan 2018 12:02:36 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159154132&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159154132&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/util/AbstractStreamOperatorTestHarness.java &amp;#8212;&lt;br/&gt;
    @@ -492,6 +503,10 @@ public void close() throws Exception &lt;/p&gt;
{
     			processingTimeService.shutdownService();
     		}
&lt;p&gt;     		setupCalled = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		if (internalEnvironment.isPresent()) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think to enable this `Environment` must implement `AutoCloseable` as well. Maybe an empty default `close()` method? &lt;br/&gt;
    If you decide to stick with `Optional`, maybe change this line to: `internalEnvironment.ifPresent(MockEnvironment::close);`&lt;/p&gt;</comment>
                            <comment id="16307426" author="githubbot" created="Mon, 1 Jan 2018 12:02:37 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159153854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159153854&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/ContentDump.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.sink;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkState;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Utility class to simulate in memory file like writes, flushes and closing.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ContentDump {&lt;br/&gt;
    +	private boolean writable = true;&lt;br/&gt;
    +	private Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt; filesContent = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	public Set&amp;lt;String&amp;gt; listFiles() {&lt;br/&gt;
    +		return filesContent.keySet();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Maybe return a copy here because the key set will reflect changes in the map.&lt;/p&gt;</comment>
                            <comment id="16308131" author="githubbot" created="Tue, 2 Jan 2018 14:33:25 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159224671&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159224671&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -179,9 +179,6 @@ public void testFailBeforeNotify() throws Exception {&lt;br/&gt;
     		harness.initializeState(snapshot);&lt;/p&gt;

&lt;p&gt;     		assertExactlyOnce(Arrays.asList(&quot;42&quot;, &quot;43&quot;));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;closeTestHarness();&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;assertEquals(0, tmpDirectory.listFiles().size());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    restored. &lt;/p&gt;</comment>
                            <comment id="16308132" author="githubbot" created="Tue, 2 Jan 2018 14:33:25 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159222250&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159222250&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/TaskTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -145,19 +145,7 @@ public MemoryManager getMemoryManager() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@After&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdownIOManager() throws Exception 
{
    -		this.mockEnv.getIOManager().shutdown();
    -		Assert.assertTrue(&quot;IO Manager has not properly shut down.&quot;, this.mockEnv.getIOManager().isProperlyShutDown());
    -	}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;@After&lt;/li&gt;
	&lt;li&gt;public void shutdownMemoryManager() throws Exception {&lt;/li&gt;
	&lt;li&gt;if (this.memorySize &amp;gt; 0) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    No, it didn&apos;t matter so I allowed myself to simplify this shutdown. But good catch. I was thinking about doing this simplification in separate commit so that there would be no need for &quot;catching&quot; this behaviour change. &lt;/p&gt;</comment>
                            <comment id="16308133" author="githubbot" created="Tue, 2 Jan 2018 14:33:25 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159229650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159229650&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/util/AbstractStreamOperatorTestHarness.java &amp;#8212;&lt;br/&gt;
    @@ -492,6 +503,10 @@ public void close() throws Exception &lt;/p&gt;
{
     			processingTimeService.shutdownService();
     		}
&lt;p&gt;     		setupCalled = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		if (internalEnvironment.isPresent()) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @tzulitai, @GJL is correct, `Environment` is not `Closeable`/`AutoCloseable`. Also I was afraid that someone might be reusing some external environment, but I think that&apos;s not the case.&lt;/p&gt;

&lt;p&gt;    Using `environmentIsInternal` flag would require some casting, that&apos;s why I have chosen `Optional`.&lt;/p&gt;

&lt;p&gt;    +1 for `internalEnvironment.ifPresent(MockEnvironment::close);`&lt;/p&gt;</comment>
                            <comment id="16308134" author="githubbot" created="Tue, 2 Jan 2018 14:33:25 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159221102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159221102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/ContentDump.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.sink;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkState;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Utility class to simulate in memory file like writes, flushes and closing.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ContentDump {&lt;br/&gt;
    +	private boolean writable = true;&lt;br/&gt;
    +	private Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt; filesContent = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	public Set&amp;lt;String&amp;gt; listFiles() &lt;/p&gt;
{
    +		return filesContent.keySet();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public void setWritable(boolean writable) &lt;/p&gt;
{
    +		this.writable = writable;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Creates an empty file.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public ContentWriter createWriter(String name) &lt;/p&gt;
{
    +		checkArgument(!filesContent.containsKey(name), &quot;File [%s] already exists&quot;, name);
    +		filesContent.put(name, new ArrayList&amp;lt;&amp;gt;());
    +		return new ContentWriter(name, this);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static void move(String name, ContentDump source, ContentDump target) {&lt;br/&gt;
    +		Collection&amp;lt;String&amp;gt; content = source.read(name);&lt;br/&gt;
    +		try (ContentWriter contentWriter = target.createWriter(name)) &lt;/p&gt;
{
    +			contentWriter.write(content).flush();
    +		}
&lt;p&gt;    +		source.delete(name);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public void delete(String name) &lt;/p&gt;
{
    +		filesContent.remove(name);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public Collection&amp;lt;String&amp;gt; read(String name) &lt;/p&gt;
{
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);
    +		checkState(content != null, &quot;Unknown file [%s]&quot;, name);
    +		List&amp;lt;String&amp;gt; result = new ArrayList&amp;lt;&amp;gt;(content);
    +		content.clear();
    +		return result;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void putContent(String name, List&amp;lt;String&amp;gt; values) {&lt;br/&gt;
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);&lt;br/&gt;
    +		checkState(content != null, &quot;Unknown file &lt;span class=&quot;error&quot;&gt;&amp;#91;%s&amp;#93;&lt;/span&gt;&quot;, name);&lt;br/&gt;
    +		if (!writable) &lt;/p&gt;
{
    +			throw new NotWritableException(name);
    +		}
&lt;p&gt;    +		content.addAll(values);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link ContentWriter}
&lt;p&gt; represents an abstraction that allows to putContent to the &lt;/p&gt;
{@link ContentDump}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static class ContentWriter implements AutoCloseable {&lt;br/&gt;
    +		private final ContentDump contentDump;&lt;br/&gt;
    +		private final String name;&lt;br/&gt;
    +		private final List&amp;lt;String&amp;gt; buffer = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +		private boolean closed = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private ContentWriter(String name, ContentDump contentDump) &lt;/p&gt;
{
    +			this.name = checkNotNull(name);
    +			this.contentDump = checkNotNull(contentDump);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public String getName() &lt;/p&gt;
{
    +			return name;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public ContentWriter write(String value) {&lt;br/&gt;
    +			if (closed) &lt;/p&gt;
{
    +				throw new IllegalStateException();
    +			}
&lt;p&gt;    +			buffer.add(value);&lt;br/&gt;
    +			return this;&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public ContentWriter write(Collection&amp;lt;String&amp;gt; values) &lt;/p&gt;
{
    +			values.forEach(this::write);
    +			return this;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public ContentWriter flush() &lt;/p&gt;
{
    +			contentDump.putContent(name, buffer);
    +			return this;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void close() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    What do you mean? Close is encouraged to be idempotent.&lt;/p&gt;</comment>
                            <comment id="16308135" author="githubbot" created="Tue, 2 Jan 2018 14:33:25 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159221837&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159221837&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/ContentDump.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.sink;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkState;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Utility class to simulate in memory file like writes, flushes and closing.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ContentDump {&lt;br/&gt;
    +	private boolean writable = true;&lt;br/&gt;
    +	private Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt; filesContent = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	public Set&amp;lt;String&amp;gt; listFiles() &lt;/p&gt;
{
    +		return filesContent.keySet();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public void setWritable(boolean writable) &lt;/p&gt;
{
    +		this.writable = writable;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Creates an empty file.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public ContentWriter createWriter(String name) &lt;/p&gt;
{
    +		checkArgument(!filesContent.containsKey(name), &quot;File [%s] already exists&quot;, name);
    +		filesContent.put(name, new ArrayList&amp;lt;&amp;gt;());
    +		return new ContentWriter(name, this);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static void move(String name, ContentDump source, ContentDump target) {&lt;br/&gt;
    +		Collection&amp;lt;String&amp;gt; content = source.read(name);&lt;br/&gt;
    +		try (ContentWriter contentWriter = target.createWriter(name)) &lt;/p&gt;
{
    +			contentWriter.write(content).flush();
    +		}
&lt;p&gt;    +		source.delete(name);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public void delete(String name) &lt;/p&gt;
{
    +		filesContent.remove(name);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public Collection&amp;lt;String&amp;gt; read(String name) &lt;/p&gt;
{
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);
    +		checkState(content != null, &quot;Unknown file [%s]&quot;, name);
    +		List&amp;lt;String&amp;gt; result = new ArrayList&amp;lt;&amp;gt;(content);
    +		content.clear();
    +		return result;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void putContent(String name, List&amp;lt;String&amp;gt; values) {&lt;br/&gt;
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);&lt;br/&gt;
    +		checkState(content != null, &quot;Unknown file &lt;span class=&quot;error&quot;&gt;&amp;#91;%s&amp;#93;&lt;/span&gt;&quot;, name);&lt;br/&gt;
    +		if (!writable) &lt;/p&gt;
{
    +			throw new NotWritableException(name);
    +		}
&lt;p&gt;    +		content.addAll(values);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * &lt;/p&gt;
{@link ContentWriter}
&lt;p&gt; represents an abstraction that allows to putContent to the &lt;/p&gt;
{@link ContentDump}.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static class ContentWriter implements AutoCloseable {&lt;br/&gt;
    +		private final ContentDump contentDump;&lt;br/&gt;
    +		private final String name;&lt;br/&gt;
    +		private final List&amp;lt;String&amp;gt; buffer = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +		private boolean closed = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private ContentWriter(String name, ContentDump contentDump) {
    +			this.name = checkNotNull(name);
    +			this.contentDump = checkNotNull(contentDump);
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public String getName() {
    +			return name;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public ContentWriter write(String value) {&lt;br/&gt;
    +			if (closed) {
    +				throw new IllegalStateException();
    +			}&lt;br/&gt;
    +			buffer.add(value);&lt;br/&gt;
    +			return this;&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public ContentWriter write(Collection&amp;lt;String&amp;gt; values) {
    +			values.forEach(this::write);
    +			return this;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public ContentWriter flush() {
    +			contentDump.putContent(name, buffer);
    +			return this;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		public void close() {
    +			buffer.clear();
    +			closed = true;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Exception thrown for an attempt to write into read-only {@link ContentDump}
&lt;p&gt;.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public class NotWritableException extends RuntimeException {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `IOException` is quite general and I need/want to catch/distinguish this specific scenario. Also this class is not doing any actual `IO` - those are the reasons why I thought custom exception to be better.&lt;/p&gt;</comment>
                            <comment id="16308136" author="githubbot" created="Tue, 2 Jan 2018 14:33:25 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159235730&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159235730&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/util/SourceFunctionUtil.java &amp;#8212;&lt;br/&gt;
    @@ -42,22 +41,32 @@&lt;br/&gt;
     public class SourceFunctionUtil {&lt;/p&gt;

&lt;p&gt;     	public static &amp;lt;T extends Serializable&amp;gt; List&amp;lt;T&amp;gt; runSourceFunction(SourceFunction&amp;lt;T&amp;gt; sourceFunction) throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final List&amp;lt;T&amp;gt; outputs = new ArrayList&amp;lt;T&amp;gt;();&lt;br/&gt;
    -&lt;br/&gt;
     		if (sourceFunction instanceof RichFunction) 
{
    +			return runRichSourceFunction(sourceFunction);
    +		}
&lt;p&gt;    +		else &lt;/p&gt;
{
    +			return runNonRichSourceFunction(sourceFunction);
    +		}
&lt;p&gt;    +	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +	private static &amp;lt;T extends Serializable&amp;gt; List&amp;lt;T&amp;gt; runRichSourceFunction(SourceFunction&amp;lt;T&amp;gt; sourceFunction) throws Exception {&lt;br/&gt;
    +		try (MockEnvironment environment = new MockEnvironment(&quot;MockTask&quot;, 3 * 1024 * 1024, new MockInputSplitProvider(), 1024)) {&lt;br/&gt;
     			AbstractStreamOperator&amp;lt;?&amp;gt; operator = mock(AbstractStreamOperator.class);&lt;br/&gt;
     			when(operator.getExecutionConfig()).thenReturn(new ExecutionConfig());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RuntimeContext runtimeContext =  new StreamingRuntimeContext(&lt;/li&gt;
	&lt;li&gt;operator,&lt;/li&gt;
	&lt;li&gt;new MockEnvironment(&quot;MockTask&quot;, 3 * 1024 * 1024, new MockInputSplitProvider(), 1024),&lt;/li&gt;
	&lt;li&gt;new HashMap&amp;lt;String, Accumulator&amp;lt;?, ?&amp;gt;&amp;gt;());&lt;br/&gt;
    -&lt;br/&gt;
    +			RuntimeContext runtimeContext = new StreamingRuntimeContext(&lt;br/&gt;
    +				operator,&lt;br/&gt;
    +				environment,&lt;br/&gt;
    +				new HashMap&amp;lt;&amp;gt;());&lt;br/&gt;
     			((RichFunction) sourceFunction).setRuntimeContext(runtimeContext);&lt;br/&gt;
    -&lt;br/&gt;
     			((RichFunction) sourceFunction).open(new Configuration());&lt;br/&gt;
    +&lt;br/&gt;
    +			return runNonRichSourceFunction(sourceFunction);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    It wouldn&apos;t suffice, because rich function&apos;s `MockEnvironment` must be closed. It would have to be something like:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    Optional&amp;lt;MockEnvironment&amp;gt; context = Optional.empty();&lt;br/&gt;
    try {&lt;br/&gt;
        if (sourceFunction instanceof RichFunction) &lt;/p&gt;
{
            context = setupRichSourceFunction(sourceFunction);
        }
&lt;p&gt;        return runSourceFunction(sourceFunction);&lt;br/&gt;
    }&lt;br/&gt;
    finally &lt;/p&gt;
{
        context.ifPresent(MockEnvironment::close);
    }
&lt;p&gt;    ```&lt;/p&gt;

&lt;p&gt;    Which in my opinion is uglier &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16308137" author="githubbot" created="Tue, 2 Jan 2018 14:33:25 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159220879&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159220879&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/ContentDump.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
    + * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
    + * this work for additional information regarding copyright ownership.&lt;br/&gt;
    + * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
    + * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
    + * the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.sink;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Collection;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkArgument;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkNotNull;&lt;br/&gt;
    +import static org.apache.flink.util.Preconditions.checkState;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Utility class to simulate in memory file like writes, flushes and closing.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ContentDump {&lt;br/&gt;
    +	private boolean writable = true;&lt;br/&gt;
    +	private Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt; filesContent = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +	public Set&amp;lt;String&amp;gt; listFiles() &lt;/p&gt;
{
    +		return filesContent.keySet();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public void setWritable(boolean writable) &lt;/p&gt;
{
    +		this.writable = writable;
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Creates an empty file.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public ContentWriter createWriter(String name) &lt;/p&gt;
{
    +		checkArgument(!filesContent.containsKey(name), &quot;File [%s] already exists&quot;, name);
    +		filesContent.put(name, new ArrayList&amp;lt;&amp;gt;());
    +		return new ContentWriter(name, this);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public static void move(String name, ContentDump source, ContentDump target) {&lt;br/&gt;
    +		Collection&amp;lt;String&amp;gt; content = source.read(name);&lt;br/&gt;
    +		try (ContentWriter contentWriter = target.createWriter(name)) &lt;/p&gt;
{
    +			contentWriter.write(content).flush();
    +		}
&lt;p&gt;    +		source.delete(name);&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	public void delete(String name) &lt;/p&gt;
{
    +		filesContent.remove(name);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	public Collection&amp;lt;String&amp;gt; read(String name) {&lt;br/&gt;
    +		List&amp;lt;String&amp;gt; content = filesContent.get(name);&lt;br/&gt;
    +		checkState(content != null, &quot;Unknown file &lt;span class=&quot;error&quot;&gt;&amp;#91;%s&amp;#93;&lt;/span&gt;&quot;, name);&lt;br/&gt;
    +		List&amp;lt;String&amp;gt; result = new ArrayList&amp;lt;&amp;gt;(content);&lt;br/&gt;
    +		content.clear();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Hmm, I was thinking more in a manner of reading from a file descriptor, where subsequent reads return only new data. But now when I think about it, that would be more expected behaviour for some `ContentReader` class and dropping `content.clear()` here makes more sense.&lt;/p&gt;</comment>
                            <comment id="16308151" author="githubbot" created="Tue, 2 Jan 2018 14:42:59 +0000"  >&lt;p&gt;Github user pnowojski commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159238089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159238089&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperatorTest.java &amp;#8212;&lt;br/&gt;
    @@ -98,7 +99,13 @@&lt;br/&gt;
     	// late arriving event OutputTag&amp;lt;StreamRecord&amp;lt;IN&amp;gt;&amp;gt;&lt;br/&gt;
     	private static final OutputTag&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; lateOutputTag = new OutputTag&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt;(&quot;late-output&quot;) {};&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void testSlidingEventTimeWindows(OneInputStreamOperatorTestHarness&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;, Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; testHarness) throws Exception {&lt;br/&gt;
    +	private void testSlidingEventTimeWindows(OneInputStreamOperator&amp;lt;Tuple2&amp;lt;String, Integer&amp;gt;, Tuple2&amp;lt;String, Integer&amp;gt;&amp;gt; operator) throws Exception {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes. Previously restoring tests were working on `closed` harness, which was working only because test harness it self wasn&apos;t properly closing itself &#128580; &lt;/p&gt;</comment>
                            <comment id="16311815" author="githubbot" created="Thu, 4 Jan 2018 18:29:23 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159722857&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159722857&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/util/AbstractStreamOperatorTestHarness.java &amp;#8212;&lt;br/&gt;
    @@ -492,6 +503,10 @@ public void close() throws Exception &lt;/p&gt;
{
     			processingTimeService.shutdownService();
     		}
&lt;p&gt;     		setupCalled = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		if (internalEnvironment.isPresent()) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    &#128077; Agreed.&lt;/p&gt;</comment>
                            <comment id="16311821" author="githubbot" created="Thu, 4 Jan 2018 18:32:41 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159723523&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159723523&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/util/SourceFunctionUtil.java &amp;#8212;&lt;br/&gt;
    @@ -42,22 +41,32 @@&lt;br/&gt;
     public class SourceFunctionUtil {&lt;/p&gt;

&lt;p&gt;     	public static &amp;lt;T extends Serializable&amp;gt; List&amp;lt;T&amp;gt; runSourceFunction(SourceFunction&amp;lt;T&amp;gt; sourceFunction) throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final List&amp;lt;T&amp;gt; outputs = new ArrayList&amp;lt;T&amp;gt;();&lt;br/&gt;
    -&lt;br/&gt;
     		if (sourceFunction instanceof RichFunction) 
{
    +			return runRichSourceFunction(sourceFunction);
    +		}
&lt;p&gt;    +		else &lt;/p&gt;
{
    +			return runNonRichSourceFunction(sourceFunction);
    +		}
&lt;p&gt;    +	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +	private static &amp;lt;T extends Serializable&amp;gt; List&amp;lt;T&amp;gt; runRichSourceFunction(SourceFunction&amp;lt;T&amp;gt; sourceFunction) throws Exception {&lt;br/&gt;
    +		try (MockEnvironment environment = new MockEnvironment(&quot;MockTask&quot;, 3 * 1024 * 1024, new MockInputSplitProvider(), 1024)) {&lt;br/&gt;
     			AbstractStreamOperator&amp;lt;?&amp;gt; operator = mock(AbstractStreamOperator.class);&lt;br/&gt;
     			when(operator.getExecutionConfig()).thenReturn(new ExecutionConfig());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RuntimeContext runtimeContext =  new StreamingRuntimeContext(&lt;/li&gt;
	&lt;li&gt;operator,&lt;/li&gt;
	&lt;li&gt;new MockEnvironment(&quot;MockTask&quot;, 3 * 1024 * 1024, new MockInputSplitProvider(), 1024),&lt;/li&gt;
	&lt;li&gt;new HashMap&amp;lt;String, Accumulator&amp;lt;?, ?&amp;gt;&amp;gt;());&lt;br/&gt;
    -&lt;br/&gt;
    +			RuntimeContext runtimeContext = new StreamingRuntimeContext(&lt;br/&gt;
    +				operator,&lt;br/&gt;
    +				environment,&lt;br/&gt;
    +				new HashMap&amp;lt;&amp;gt;());&lt;br/&gt;
     			((RichFunction) sourceFunction).setRuntimeContext(runtimeContext);&lt;br/&gt;
    -&lt;br/&gt;
     			((RichFunction) sourceFunction).open(new Configuration());&lt;br/&gt;
    +&lt;br/&gt;
    +			return runNonRichSourceFunction(sourceFunction);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Ah, I see. Thanks for the clarification, I didn&apos;t pay enough attention here.&lt;br/&gt;
    Yes, it wouldn&apos;t make sense to refactor this any more if the environment needs to be closed.&lt;/p&gt;</comment>
                            <comment id="16311833" author="githubbot" created="Thu, 4 Jan 2018 18:40:23 +0000"  >&lt;p&gt;Github user tzulitai commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193#discussion_r159724744&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193#discussion_r159724744&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java &amp;#8212;&lt;br/&gt;
    @@ -383,7 +383,10 @@ public void failExternally(Throwable cause) {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void close() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;checkState(memManager.verifyEmpty(), &quot;Memory Manager managed memory was not completely freed.&quot;);&lt;br/&gt;
    +		// close() method should be idempotent and calling memManager.verifyEmpty() will thow after it was shutdown.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: typo &quot;throw&quot;&lt;/p&gt;</comment>
                            <comment id="16312740" author="githubbot" created="Fri, 5 Jan 2018 09:02:15 +0000"  >&lt;p&gt;Github user pnowojski commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review! Fixed typo, rebased and squashed commits.&lt;/p&gt;</comment>
                            <comment id="16314362" author="githubbot" created="Sat, 6 Jan 2018 04:20:18 +0000"  >&lt;p&gt;Github user tzulitai commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging to `master` ..&lt;/p&gt;</comment>
                            <comment id="16314388" author="githubbot" created="Sat, 6 Jan 2018 05:53:36 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5193&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16314413" author="tzulitai" created="Sat, 6 Jan 2018 06:56:15 +0000"  >&lt;p&gt;Merged for 1.5.0: e8d1aa57a8246de0b78e799a02c08f4007fb3a92&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 45 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nyef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>