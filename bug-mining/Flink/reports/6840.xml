<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:15:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-30637] In linux-aarch64 environment, using &#8220;is&#8221; judgment to match the window type of overwindow have returned incorrect matching results</title>
                <link>https://issues.apache.org/jira/browse/FLINK-30637</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In &#160;linux-arch64 environment, &#8220;window_type is OverWindow.ROW_UNBOUNDED_FOLLOWING&#8221; in &#160;in the PandasBatchOverWindowAggregateFunctionOperation class of the pyflink source code has returned the wrong result.&lt;/p&gt;

&lt;p&gt;For example, when window_type is 6, it represents the window type of &#8216;ROW_UNBOUNDED_FOLLOWING&#8217;, but &#8220;window_type is OverWindow.ROW_UNBOUNDED_FOLLOWING&#8221; return false because the memory address of window_type has changed. It will lead to the wrong type of window, such as row sliding window, so, the wrong input data of python udf have been assembled and wrong results of that have appeared.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Specifically, the pyflink unit testcase is &#8216;test_over_window_aggregate_function&#8217; in &#8216;pyflink\table\tests\test_pandas_udaf.py&#8217;. It performance incorrectly when I execute it by pytest on linux-aarch64 system. I cut this unit use case to the following code and executed it in the flink standalone mode of aarch64 system, and got the same error result:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; unittest
from pyflink.table &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; DataTypes, TableEnvironment, EnvironmentSettings
from pyflink.table.udf &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; udaf, AggregateFunction


&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MaxAdd(AggregateFunction, unittest.TestCase):

    def open(self, function_context):
        mg = function_context.get_metric_group()
        self.counter = mg.add_group(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;).counter(&lt;span class=&quot;code-quote&quot;&gt;&quot;my_counter&quot;&lt;/span&gt;)
        self.counter_sum = 0

    def get_value(self, accumulator):
        # counter
        self.counter.inc(10)
        self.counter_sum += 10
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; accumulator[0]

    def create_accumulator(self):
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; []

    def accumulate(self, accumulator, *args):
        result = 0
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; arg in args:
            result += arg.max()
        accumulator.append(result)


@udaf(result_type=DataTypes.FLOAT(), func_type=&lt;span class=&quot;code-quote&quot;&gt;&quot;pandas&quot;&lt;/span&gt;)
def mean_udaf(v):
    &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; logging
    logging.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt;)
    logging.error(v)
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; v.mean()


t_env = TableEnvironment.create(
    EnvironmentSettings.new_instance().in_batch_mode().use_blink_planner().build())
t_env.get_config().get_configuration().set_string(&lt;span class=&quot;code-quote&quot;&gt;&quot;parallelism.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;)
t_env.get_config().get_configuration().set_string(
    &lt;span class=&quot;code-quote&quot;&gt;&quot;python.fn-execution.bundle.size&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;)

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; datetime

t = t_env.from_elements(
    [
        (1, 2, 3, datetime.datetime(2018, 3, 11, 3, 10, 0, 0)),
        (1, 3, 1, datetime.datetime(2018, 3, 11, 3, 10, 0, 0)),
        (1, 8, 5, datetime.datetime(2018, 3, 11, 4, 20, 0, 0))
    ],
    DataTypes.ROW(
        [DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, DataTypes.TINYINT()),
         DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, DataTypes.SMALLINT()),
         DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, DataTypes.INT()),
         DataTypes.FIELD(&lt;span class=&quot;code-quote&quot;&gt;&quot;rowtime&quot;&lt;/span&gt;, DataTypes.TIMESTAMP(3))]))

# sink
t_env.execute_sql(&quot;&quot;&quot;
        CREATE TABLE mySink (
          c INT,
          d FLOAT 
        ) WITH (
          &lt;span class=&quot;code-quote&quot;&gt;&apos;connector&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;print&apos;&lt;/span&gt;
        )
    &quot;&quot;&quot;)

t_env.create_temporary_system_function(&lt;span class=&quot;code-quote&quot;&gt;&quot;mean_udaf&quot;&lt;/span&gt;, mean_udaf)
t_env.register_function(&lt;span class=&quot;code-quote&quot;&gt;&quot;max_add&quot;&lt;/span&gt;, udaf(MaxAdd(),
                                        result_type=DataTypes.INT(),
                                        func_type=&lt;span class=&quot;code-quote&quot;&gt;&quot;pandas&quot;&lt;/span&gt;))
t_env.register_table(&lt;span class=&quot;code-quote&quot;&gt;&quot;T&quot;&lt;/span&gt;, t)
t_env.execute_sql(&quot;&quot;&quot;
        insert into mySink
        select
         max_add(b, c)
         over (PARTITION BY a ORDER BY rowtime
         ROWS BETWEEN UNBOUNDED preceding AND 0 FOLLOWING),
         mean_udaf(b)
         over (PARTITION BY a ORDER BY rowtime
         ROWS BETWEEN 1 PRECEDING AND UNBOUNDED FOLLOWING)
        from T
    &quot;&quot;&quot;).wait()
&apos;&apos;&apos;
assert_equals(actual,
              [&lt;span class=&quot;code-quote&quot;&gt;&quot;5,4.3333335&quot;&lt;/span&gt;,
               &lt;span class=&quot;code-quote&quot;&gt;&quot;13,5.5&quot;&lt;/span&gt;,
               &lt;span class=&quot;code-quote&quot;&gt;&quot;6,4.3333335&quot;&lt;/span&gt;])
&apos;&apos;&apos;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The expected results are &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;5,4.3333335&amp;quot;, &amp;quot;13,5.5&amp;quot;, &amp;quot;6,4.3333335&amp;quot;&amp;#93;&lt;/span&gt;, but actual results are List(5,2.0, 13,5.5, 4,2.5). For &#8216;mean_udaf&#8217; and &#8216;OverWindow.UNBOUNDED FOLLOWING&#8217; in the code, by adding the error log, I found that when window_type is 6 and &apos;OverWindow.ROW_UNBOUNDED_FOLLOWING&apos; also represents 6, the following code from pyflink source code returned false.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// pyflink\fn_execution\operations.py (line 273)
&lt;/span&gt;elif window_type is OverWindow.ROW_UNBOUNDED_FOLLOWING:
    # row unbounded following window
    window_start = window.lower_boundary
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; j in range(input_cnt):
        start = max(j + window_start, 0)
        series_slices = [s.iloc[start: input_cnt] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; s in input_series]
        result.append(func(series_slices))&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And it It finally chose row sliding window to assemble input data of mean_udaf:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// pyflink\fn_execution\operations.py (line 280) 
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;:
    # row sliding window
    window_start = window.lower_boundary
    window_end = window.upper_boundary
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; j in range(input_cnt):
        start = max(j + window_start, 0)
        end = min(j + window_end + 1, input_cnt)
        series_slices = [s.iloc[start: end] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; s in input_series]
        result.append(func(series_slices))&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Obviously, that&apos;s not right. The right choice will be made in x86 environment.&lt;/p&gt;

&lt;p&gt;The reason is window_ type&#8216;s memory address&#160; is different from &#8216;OverWindow.ROW_ UNBOUNDED_ FOLLOWING&#8217; in linux-aarch64 environment. On the contrary, they are the same in the linux-x86 environment. The reason why the memory address is different is unknown yet. But I observed that window_type comes from&#160;&apos;serialized_fn.windows&apos;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
def __init__(self, spec): 
&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(PandasBatchOverWindowAggregateFunctionOperation, self).__init__(spec) 
self.windows = [window &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; window in self.spec.serialized_fn.windows]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Perhaps grpc, protobuf dependencies or serialization operations in the arrch environment have affected the memory address of the int variables, I&apos;ll explore the underlying reasons later.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Solution and suggestion:&lt;/p&gt;

&lt;p&gt;Since the window selections need to compare the values of two integer variables(window_type, OverWindow.ROW_ UNBOUNDED_ FOLLOWING), I recommend replacing &#8216;is&#8217; with &#8216;==&#8217; at the window type matching. That can also prevents erroneous results caused by python small integer object pool failure which may also affects the memory address. And this modification has been verified to perform correctly on both x86 and aarch64 environments, either this unit test case or the case I cut.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux version 5.10.0-60.18.0.50.oe2203.aarch64&lt;/p&gt;

&lt;p&gt;(abuild@obs-worker-002) (gcc_old (GCC) 10.3.1, GNU ld (GNU Binutils) 2.37) #1 SMP Wed Mar 30 02:43:08 UTC 2022&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;pyflink-version&#65306;1.13.6&lt;/p&gt;</environment>
        <key id="13517615">FLINK-30637</key>
            <summary>In linux-aarch64 environment, using &#8220;is&#8221; judgment to match the window type of overwindow have returned incorrect matching results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xinchen147">Xin Chen</assignee>
                                    <reporter username="xinchen147">Xin Chen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 11 Jan 2023 12:55:51 +0000</created>
                <updated>Sun, 29 Jan 2023 01:54:45 +0000</updated>
                            <resolved>Tue, 17 Jan 2023 07:13:29 +0000</resolved>
                                    <version>1.13.6</version>
                                    <fixVersion>1.17.0</fixVersion>
                    <fixVersion>1.16.1</fixVersion>
                    <fixVersion>1.15.4</fixVersion>
                                    <component>API / Python</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17675563" author="martijnvisser" created="Wed, 11 Jan 2023 13:16:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xinchen147&quot; class=&quot;user-hover&quot; rel=&quot;xinchen147&quot;&gt;xinchen147&lt;/a&gt; Can you please verify this in Flink 1.16, since Flink 1.13 is no longer supported in the community?&lt;/p&gt;</comment>
                            <comment id="17675577" author="JIRAUSER298666" created="Wed, 11 Jan 2023 13:43:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; Thank you for your reply. Maybe I can have a try in Flink 1.16, but the same part of Pyflink&#8216;s source code has not changed yet in Flink 1.16. And I&apos;ll provide a detailed description of the problem and suggested solutions to this section later. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hxbks2ks&quot; class=&quot;user-hover&quot; rel=&quot;hxbks2ks&quot;&gt;hxbks2ks&lt;/a&gt; also knows the problem because I have consulted him earlier.&lt;/p&gt;</comment>
                            <comment id="17675586" author="martijnvisser" created="Wed, 11 Jan 2023 14:07:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xinchen147&quot; class=&quot;user-hover&quot; rel=&quot;xinchen147&quot;&gt;xinchen147&lt;/a&gt; I can imagine, but there have been a number of dependency updates in later versions which is why I thought it could have a different outcome on a later version&lt;/p&gt;</comment>
                            <comment id="17675993" author="JIRAUSER298666" created="Thu, 12 Jan 2023 12:52:32 +0000"  >&lt;p&gt;Why the window_type&apos;s memory address from serialized_fn.windows is diffrent from &#8216;OverWindow.ROW_ UNBOUNDED_ FOLLOWING&#8217;?&lt;/p&gt;

&lt;p&gt;I learned that python uses the small integer object pool to control. When a represents 5 and b also represents 5, they are the same object, &#8216;a is b&#8217; will return &#8216;True&#8216;. But this is not the case here. And I do experiments in linux-aarch64 system as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
a = 5 
logging.error(a is window_type)  # Window_type represents 5, but the result is False.
logging.error(a is OverWindow.ROW_UNBOUNDED_FOLLOWING) # OverWindow.ROW_UNBOUNDED_FOLLOWING represents 5, the result is True

##### test &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; small integer object pool
b = 5
c = 5 
logging.error(b is c) # The result is True.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It seems that the python small integer pool is not invalid, so I think it may be necessary to trace the source of window_type. I hope someone can give some suggestions and ideas. Thank you very much.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17677639" author="hxbks2ks" created="Tue, 17 Jan 2023 07:13:29 +0000"  >&lt;p&gt;Merged into master via d053867fb5c0fc647ea9266aab35598d7f3fc5c4&lt;br/&gt;
Merged into release-1.16 via eca940c5bf9e17c90dbb6f35e4ba370027137368&lt;br/&gt;
Merged into release-1.15 via 4035d61a2756ec16046fb687f533be0501fbbd35&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>Python</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1eq0w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>