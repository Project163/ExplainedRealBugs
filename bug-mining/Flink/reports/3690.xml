<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:43:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14894] HybridOffHeapUnsafeMemorySegmentTest#testByteBufferWrap failed on Travis</title>
                <link>https://issues.apache.org/jira/browse/FLINK-14894</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;HybridOffHeapUnsafeMemorySegmentTest&amp;gt;MemorySegmentTestBase.testByteBufferWrapping:2465 expected:&amp;lt;992288337&amp;gt; but was:&amp;lt;196608&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://api.travis-ci.com/v3/job/258950527/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.com/v3/job/258950527/log.txt&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13269832">FLINK-14894</key>
            <summary>HybridOffHeapUnsafeMemorySegmentTest#testByteBufferWrap failed on Travis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="azagrebin">Andrey Zagrebin</assignee>
                                    <reporter username="gjy">Gary Yao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Thu, 21 Nov 2019 12:54:43 +0000</created>
                <updated>Wed, 20 May 2020 14:55:07 +0000</updated>
                            <resolved>Wed, 20 May 2020 14:55:07 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.2</fixVersion>
                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Network</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16982499" author="azagrebin" created="Tue, 26 Nov 2019 13:56:04 +0000"  >&lt;p&gt;I think this is due to&#160;&lt;a href=&quot;https://jira.apache.org/jira/browse/FLINK-13985&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FLINK-13985&lt;/a&gt;, where we decided that we will explicitly release underlying unsafe memory in&#160;HybridMemorySegment#free for new unsafe allocations. It looks like&#160;&lt;/p&gt;

&lt;p&gt;MemorySegmentTestBase#testByteBufferWrapping explicitly tests the contract that the underlying memory wrapped into a nio&#160;ByteBuffer is usable after the segment freeing. This is true for the nio&#160;DirectByteBuffer as the wrapping&#160;ByteBuffer keeps a strong link to it. So the original memory is not released both explicitly and during GC in this case but this does not hold for the new unsafe allocation after the explicit release.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;&#160;do you remember why would we need the wraps to be valid after freeing the main segment? do we still need this?&lt;/p&gt;</comment>
                            <comment id="16985035" author="tison" created="Fri, 29 Nov 2019 13:55:20 +0000"  >&lt;p&gt;another instance &lt;a href=&quot;https://api.travis-ci.com/v3/job/261580360/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.com/v3/job/261580360/log.txt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17008602" author="yunta" created="Mon, 6 Jan 2020 07:57:01 +0000"  >&lt;p&gt;Another instance &lt;a href=&quot;https://api.travis-ci.com/v3/job/272484106/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.com/v3/job/272484106/log.txt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17023015" author="azagrebin" created="Fri, 24 Jan 2020 15:17:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;and me had an offline discussion.&lt;/p&gt;

&lt;p&gt;The conclusion at the moment is that release unsafe memory, while potentially having link on it in Java code, is dangerous. We revert this to rely only on GC when there are no links in Java code. The problem can happen e.g. if task thread exits w/o joining with IO threads (e.g. spilling in batch job) then the unsafe memory is released but it can be written w/o segfault by IO thread. At the same time, other task can allocate interleaving memory which can be spoiled by that IO thread. We still keep it unsafe to allocate it outside of JVM direct memory limit to not interfere with direct allocations, also it does not make sense for RocksDB native memory (also accounted in MemoryManager) to be part of&#160;direct memory limit.&lt;/p&gt;

&lt;p&gt;The potential downside can be that over-allocating of unsafe memory will not hit the direct limit and will not cause GC immediately which will be the only way to release it. In this case, it can cause out-of-memory failures w/o triggering GC to release a lot of potentially already unused memory.&lt;/p&gt;

&lt;p&gt;If we see the delayed release as a problem then we can investigate further optimisations (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15758&quot; title=&quot;Investigate potential out-of-memory problems due to managed unsafe memory allocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15758&quot;&gt;&lt;del&gt;FLINK-15758&lt;/del&gt;&lt;/a&gt;), like:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;directly monitoring phantom reference queue of the cleaner (if JVM detects quickly that there are no more reference to the memory) and explicitly release memory ready for GC asap, e.g. after Task exit&lt;/li&gt;
	&lt;li&gt;monitor allocated memory amount and block allocation until GC releases occupied memory instead of failing with&#160;out-of-memory&#160;immediately&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17023131" author="till.rohrmann" created="Fri, 24 Jan 2020 17:31:51 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;master: 6dcaae0e403a8d7322d5c63e82b01ed24340d984&lt;br/&gt;
1.10.0: 2c7dac62e10a8a2aa567281f10c18340303f4f17&lt;/p&gt;</comment>
                            <comment id="17024394" author="till.rohrmann" created="Mon, 27 Jan 2020 14:56:48 +0000"  >&lt;p&gt;Reverting the commits of this issue because they are causing higher memory pressure. Due to this, our Travis builds are failing because we don&apos;t release the unsafely allocated memory blocks fast enough:&lt;/p&gt;

&lt;p&gt;master: 676b53fe799374aa9e86ce65a12bc788a5b42f2f&lt;br/&gt;
1.10.0: 1c57e8ec31b0dd6fe873ee17f2437f091364744a&lt;/p&gt;

&lt;p&gt;I guess this means that we should monitor the unsafe memory usage and try to recycle freed segments when requesting new segments. This will prevent the accumulation of unused memory segments which causes memory pressure.&lt;/p&gt;</comment>
                            <comment id="17112313" author="azagrebin" created="Wed, 20 May 2020 14:55:07 +0000"  >&lt;p&gt;should be fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15758&quot; title=&quot;Investigate potential out-of-memory problems due to managed unsafe memory allocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15758&quot;&gt;&lt;del&gt;FLINK-15758&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="13281453">FLINK-15758</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13255135">FLINK-13985</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13255129">FLINK-13980</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 25 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z08vf4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>