<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:49:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18832] BoundedBlockingSubpartition does not work with StreamTask</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18832</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;BoundedBlockingSubpartition&lt;/tt&gt; does not work with a &lt;tt&gt;StreamTask&lt;/tt&gt; because the &lt;tt&gt;StreamTask&lt;/tt&gt; instantiates an &lt;tt&gt;OutputFlusher&lt;/tt&gt; which concurrently accesses the &lt;tt&gt;BoundedBlockingSubpartition&lt;/tt&gt;. This concurrency can lead to a double closing of the underlying &lt;tt&gt;BufferConsumer&lt;/tt&gt; which manifests in this stack trace:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[9:15 PM] Caused by: org.apache.flink.shaded.netty4.io.netty.util.IllegalReferenceCountException: refCnt: 0, increment: 1
	at org.apache.flink.shaded.netty4.io.netty.util.internal.ReferenceCountUpdater.retain0(ReferenceCountUpdater.java:123)
	at org.apache.flink.shaded.netty4.io.netty.util.internal.ReferenceCountUpdater.retain(ReferenceCountUpdater.java:110)
	at org.apache.flink.shaded.netty4.io.netty.buffer.AbstractReferenceCountedByteBuf.retain(AbstractReferenceCountedByteBuf.java:80)
	at org.apache.flink.runtime.io.network.buffer.NetworkBuffer.retainBuffer(NetworkBuffer.java:174)
	at org.apache.flink.runtime.io.network.buffer.NetworkBuffer.retainBuffer(NetworkBuffer.java:47)
	at org.apache.flink.runtime.io.network.buffer.ReadOnlySlicedNetworkBuffer.retainBuffer(ReadOnlySlicedNetworkBuffer.java:127)
	at org.apache.flink.runtime.io.network.buffer.ReadOnlySlicedNetworkBuffer.retainBuffer(ReadOnlySlicedNetworkBuffer.java:41)
	at org.apache.flink.runtime.io.network.buffer.BufferConsumer.build(BufferConsumer.java:108)
	at org.apache.flink.runtime.io.network.partition.BoundedBlockingSubpartition.writeAndCloseBufferConsumer(BoundedBlockingSubpartition.java:156)
	at org.apache.flink.runtime.io.network.partition.BoundedBlockingSubpartition.flushCurrentBuffer(BoundedBlockingSubpartition.java:144)
	at org.apache.flink.runtime.io.network.partition.BoundedBlockingSubpartition.flush(BoundedBlockingSubpartition.java:135)
	at org.apache.flink.runtime.io.network.partition.ResultPartition.flushAll(ResultPartition.java:245)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.flushAll(RecordWriter.java:183)
	at org.apache.flink.streaming.runtime.io.RecordWriterOutput.flush(RecordWriterOutput.java:156)
	at org.apache.flink.streaming.runtime.tasks.OperatorChain.flushOutputs(OperatorChain.java:344)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.afterInvoke(StreamTask.java:602)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:544)
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:721)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:546)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13321107">FLINK-18832</key>
            <summary>BoundedBlockingSubpartition does not work with StreamTask</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zjwang">Zhijiang</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 5 Aug 2020 13:56:44 +0000</created>
                <updated>Tue, 8 Sep 2020 08:10:49 +0000</updated>
                            <resolved>Mon, 7 Sep 2020 15:02:34 +0000</resolved>
                                    <version>1.10.1</version>
                    <version>1.11.1</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.10.3</fixVersion>
                    <fixVersion>1.11.2</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Network</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="17171516" author="till.rohrmann" created="Wed, 5 Aug 2020 13:57:16 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17171894" author="zjwang" created="Thu, 6 Aug 2020 04:14:37 +0000"  >&lt;p&gt;Thanks for reporting this bug &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;By design I guess the BoundedBlockingSubpartition assumes no concurrent issue for `#flushCurrentBuffer` method. But actually the task thread and flusher thread can touch this method concurrently. I can think of some options for resolving it:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Disable flusher thread for batch jobs, because it has no benefits for latency concern as the downstream will only request partition after upstream finishes based on current schedule way. Even it would bring harm for upstream writer to spill partial buffer after flush triggered.&lt;/li&gt;
	&lt;li&gt;From long term goal, the flusher thread should be delegated by mailbox model, so we can avoid concurrent issue even if the flusher timeout valid for batch jobs.&lt;/li&gt;
	&lt;li&gt;Breaks the previous assumption to allow concurrent access of  `BoundedBlockingSubpartition#flushCurrentBuffer`.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If we can realize the second option soon, then we can bypass this bug. I remembered &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;already submitted the PR for it before, but have not merged yet. If this way can not be realized in short time, then i prefer the first option to work around. WDYT?&lt;/p&gt;</comment>
                            <comment id="17172083" author="pnowojski" created="Thu, 6 Aug 2020 07:18:59 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; for reminding about this older PR of mine (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15750&quot; title=&quot;Execute network flushing actions in the mailbox instead of OutputFlusher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15750&quot;&gt;&lt;del&gt;FLINK-15750&lt;/del&gt;&lt;/a&gt;). There were some issues that I didn&apos;t have time to resolve (it was my side project). I can dig out this PR tomorrow, try to rebase it on the latest master and check what issues are remaining to be addressed.&lt;/p&gt;

&lt;p&gt;Either way, option number one also sounds fine to me - at least until we have some mixed streaming/batch workloads inside one job - so let&apos;s give it a try if I won&apos;t make a progress with &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15750&quot; title=&quot;Execute network flushing actions in the mailbox instead of OutputFlusher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15750&quot;&gt;&lt;del&gt;FLINK-15750&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17174422" author="pnowojski" created="Mon, 10 Aug 2020 16:11:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; why has this bug appeared, in what scenario? What are the use cases? Do we need to support flusher for the batch jobs?&lt;/p&gt;</comment>
                            <comment id="17175495" author="till.rohrmann" created="Tue, 11 Aug 2020 11:56:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; reported this issue when running a &lt;tt&gt;DataStream&lt;/tt&gt; job with lazy scheduling and blocking data exchanges. Not sure whether this configuration can actually occur atm.&lt;/p&gt;</comment>
                            <comment id="17175504" author="dawidwys" created="Tue, 11 Aug 2020 12:06:13 +0000"  >&lt;p&gt;As far as I can tell currently that can not occur. The Blink batch planner, which is the only user of the lazy scheduling with blocking data exchanges disables the output flashers by setting: &lt;tt&gt;execEnv.setBufferTimeout(-1);&lt;/tt&gt;. I am working on exposing the &quot;&lt;tt&gt;BATCH&lt;/tt&gt;&quot; behaviour in the DataStream as well but I did not set this parameter, as I was not aware of the consequences. I think it is not a pressing issue if we say it is an illegal combination.&lt;/p&gt;</comment>
                            <comment id="17175960" author="zjwang" created="Wed, 12 Aug 2020 03:30:17 +0000"  >&lt;p&gt;Thanks for the explanation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;If so, I think we can bypass this issue if in future we want to unify the DataStream API to simulate batch job with explicitly setBufferTimeout(-1). ATM, the blink planner and BatchTask from DataSet API already explicitly setBufferTimeout(-1) as well.&lt;/p&gt;

&lt;p&gt;If nobody has other concerns, I will close this ticket now. And if we want to support buffer timeout for batch job in future, we can focus on it then.&lt;/p&gt;</comment>
                            <comment id="17176116" author="pnowojski" created="Wed, 12 Aug 2020 07:40:21 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; should we maybe add a check state somewhere in the code, to fail early with a nice error message &quot;buffer timeout can not be used with blocking subpartition&quot;? Ideally somewhere in the &lt;tt&gt;BoundedSubpartitionXXX&lt;/tt&gt; constructor, but I&apos;m not sure if we have there an easy access to the task&apos;s configuration.&lt;/p&gt;</comment>
                            <comment id="17176817" author="zjwang" created="Thu, 13 Aug 2020 07:39:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Agree with you proposal. It would be nice to give some friendly message for the current limitation. I would submit the PR for it.&lt;/p&gt;</comment>
                            <comment id="17191748" author="zjwang" created="Mon, 7 Sep 2020 15:02:34 +0000"  >&lt;p&gt;Merged in master: 13e0b355d1d9ba513671de1638d3c35edb6b96a3&lt;br/&gt;
Merged in release-1.11: 11edb3dd47999bcad94c93a204cd20fdd5360b41&lt;br/&gt;
Merged in release-1.10: 85c181745855db4396f28c53eb6b478040c902cb&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13281364">FLINK-15750</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hhz4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>