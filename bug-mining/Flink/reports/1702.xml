<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6583] Enable QueryConfig in count base GroupWindow</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6583</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Enable QueryConfig in count base GroupWindow by Add a custom Trigger `CountTriggerWithCleanupState`. See more in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6491&quot; title=&quot;Add QueryConfig to specify state retention time for streaming queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6491&quot;&gt;&lt;del&gt;FLINK-6491&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13071933">FLINK-6583</key>
            <summary>Enable QueryConfig in count base GroupWindow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sunjincheng121">sunjincheng</assignee>
                                    <reporter username="sunjincheng121">sunjincheng</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 May 2017 09:24:11 +0000</created>
                <updated>Thu, 18 May 2017 08:07:27 +0000</updated>
                            <resolved>Wed, 17 May 2017 13:46:29 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16012043" author="githubbot" created="Tue, 16 May 2017 09:15:20 +0000"  >&lt;p&gt;GitHub user sunjincheng121 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6583&quot; title=&quot;Enable QueryConfig in count base GroupWindow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6583&quot;&gt;&lt;del&gt;FLINK-6583&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;talbe&amp;#93;&lt;/span&gt;Enable QueryConfig in count base GroupWindow&lt;/p&gt;

&lt;p&gt;    In this PR. Enabled the `QueryConfig` for count base `GroupWindow`.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; General&lt;/li&gt;
	&lt;li&gt;The pull request references the related JIRA issue (&quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6583&quot; title=&quot;Enable QueryConfig in count base GroupWindow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6583&quot;&gt;&lt;del&gt;FLINK-6583&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;talbe&amp;#93;&lt;/span&gt;Enable QueryConfig in count base GroupWindow&quot;)&lt;/li&gt;
	&lt;li&gt;The pull request addresses only one issue&lt;/li&gt;
	&lt;li&gt;Each commit in the PR has a meaningful commit message (including the JIRA id)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Documentation&lt;/li&gt;
	&lt;li&gt;Documentation has been added for new functionality&lt;/li&gt;
	&lt;li&gt;Old documentation affected by the pull request has been updated&lt;/li&gt;
	&lt;li&gt;JavaDoc for public methods has been added&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; Tests &amp;amp; Build&lt;/li&gt;
	&lt;li&gt;Functionality added by the pull request is covered by tests&lt;/li&gt;
	&lt;li&gt;`mvn clean verify` has been executed successfully locally or a Travis build has passed&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/sunjincheng121/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sunjincheng121/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6583&quot; title=&quot;Enable QueryConfig in count base GroupWindow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6583&quot;&gt;&lt;del&gt;FLINK-6583&lt;/del&gt;&lt;/a&gt;-PR&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3919&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 8f54635006b8caa2770d552209e7ad7fe2475f96&lt;br/&gt;
Author: sunjincheng121 &amp;lt;sunjincheng121@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-05-16T03:58:37Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6583&quot; title=&quot;Enable QueryConfig in count base GroupWindow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6583&quot;&gt;&lt;del&gt;FLINK-6583&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;talbe&amp;#93;&lt;/span&gt;Enable QueryConfig in count base GroupWindow&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16012382" author="githubbot" created="Tue, 16 May 2017 13:34:03 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116727812&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116727812&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/datastream/DataStreamGroupWindowAggregate.scala &amp;#8212;&lt;br/&gt;
    @@ -296,6 +322,8 @@ object DataStreamGroupWindowAggregate {&lt;br/&gt;
         case SlidingGroupWindow(_, timeField, size, slide)&lt;br/&gt;
             if isProctimeAttribute(timeField) &amp;amp;&amp;amp; isRowCountLiteral(size)=&amp;gt;&lt;br/&gt;
           stream.countWindowAll(toLong(size), toLong(slide))&lt;br/&gt;
    +      .evictor(CountEvictor.of(toLong(size)))&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    same as above&lt;/p&gt;</comment>
                            <comment id="16012383" author="githubbot" created="Tue, 16 May 2017 13:34:03 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116727685&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116727685&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/datastream/DataStreamGroupWindowAggregate.scala &amp;#8212;&lt;br/&gt;
    @@ -245,6 +266,8 @@ object DataStreamGroupWindowAggregate {&lt;br/&gt;
         case SlidingGroupWindow(_, timeField, size, slide)&lt;br/&gt;
             if isProctimeAttribute(timeField) &amp;amp;&amp;amp; isRowCountLiteral(size) =&amp;gt;&lt;br/&gt;
           stream.countWindow(toLong(size), toLong(slide))&lt;br/&gt;
    +      .evictor(CountEvictor.of(toLong(size)))&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Do we need to override the evictor as well? &lt;br/&gt;
    I think it should not be changed if we add a custom trigger.&lt;/p&gt;</comment>
                            <comment id="16012384" author="githubbot" created="Tue, 16 May 2017 13:34:03 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116733901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116733901&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/triggers/CountTriggerWithCleanupState.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,146 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.runtime.triggers&lt;br/&gt;
    +&lt;br/&gt;
    +import java.lang.&lt;/p&gt;
{Long =&amp;gt; JLong}
&lt;p&gt;    +&lt;br/&gt;
    +import org.apache.flink.api.common.functions.ReduceFunction&lt;br/&gt;
    +import org.apache.flink.api.common.state._&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.Trigger.TriggerContext&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.&lt;/p&gt;
{Trigger, TriggerResult}
&lt;p&gt;    +import org.apache.flink.streaming.api.windowing.windows.Window&lt;br/&gt;
    +import org.apache.flink.table.api.&lt;/p&gt;
{StreamQueryConfig, Types}
&lt;p&gt;    +import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState.Sum&lt;br/&gt;
    +&lt;br/&gt;
    +class CountTriggerWithCleanupState&lt;span class=&quot;error&quot;&gt;&amp;#91;W &amp;lt;: Window&amp;#93;&lt;/span&gt;(queryConfig: StreamQueryConfig, maxCount: Long)&lt;br/&gt;
    +  extends Trigger&lt;span class=&quot;error&quot;&gt;&amp;#91;Any, W&amp;#93;&lt;/span&gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +  private val serialVersionUID: Long = 1L&lt;br/&gt;
    +&lt;br/&gt;
    +  protected val minRetentionTime: Long = queryConfig.getMinIdleStateRetentionTime&lt;br/&gt;
    +  protected val maxRetentionTime: Long = queryConfig.getMaxIdleStateRetentionTime&lt;br/&gt;
    +  protected val stateCleaningEnabled: Boolean = minRetentionTime &amp;gt; 1&lt;br/&gt;
    +&lt;br/&gt;
    +  private val stateDesc: ReducingStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt; =&lt;br/&gt;
    +    new ReducingStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt;(&quot;count&quot;, new Sum, Types.LONG)&lt;br/&gt;
    +&lt;br/&gt;
    +  private val cleanupStateDesc: ValueStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt; =&lt;br/&gt;
    +    new ValueStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt;(&quot;countCleanup&quot;, Types.LONG)&lt;br/&gt;
    +&lt;br/&gt;
    +  override def canMerge: Boolean = true&lt;br/&gt;
    +&lt;br/&gt;
    +  override def onMerge(window: W, ctx: Trigger.OnMergeContext) {&lt;br/&gt;
    +    ctx.mergePartitionedState(stateDesc)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This will fail because `ValueState` is not a `MergingState`. We could implement the `cleanupStateDesc` as a `ReducingState` with a `max` `ReduceFunction`. That would allow the Flink to merge the state.&lt;/p&gt;

&lt;p&gt;    On the other hand, we won&apos;t use the Trigger in merging windows anyways, to it would also be fine to not support merging at all (`canMerge = false`). I&apos;d actually go for this option because it simplifies the trigger.&lt;/p&gt;</comment>
                            <comment id="16012385" author="githubbot" created="Tue, 16 May 2017 13:34:03 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116739961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116739961&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/harness/CountTriggerWithCleanupStateHarnessTest.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,305 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.runtime.harness&lt;br/&gt;
    +&lt;br/&gt;
    +import com.google.common.collect.Lists&lt;br/&gt;
    +import org.apache.flink.api.common.time.Time&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.TriggerResult&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.windows.TimeWindow&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.operators.windowing.TriggerTestHarness&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.streamrecord.StreamRecord&lt;br/&gt;
    +import org.apache.flink.table.api.StreamQueryConfig&lt;br/&gt;
    +import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState&lt;br/&gt;
    +import org.junit.Assert.assertEquals&lt;br/&gt;
    +import org.junit.Test&lt;br/&gt;
    +&lt;br/&gt;
    +class CountTriggerWithCleanupStateHarnessTest {&lt;br/&gt;
    +  protected var queryConfig =&lt;br/&gt;
    +    new StreamQueryConfig().withIdleStateRetentionTime(Time.seconds(2), Time.seconds(3))&lt;br/&gt;
    +&lt;br/&gt;
    +  @Test&lt;br/&gt;
    +  def testFiringAndFireingWithPurging(): Unit = {&lt;br/&gt;
    +    val testHarness = new TriggerTestHarness&lt;span class=&quot;error&quot;&gt;&amp;#91;Any, TimeWindow&amp;#93;&lt;/span&gt;(&lt;br/&gt;
    +      CountTriggerWithCleanupState.of&lt;span class=&quot;error&quot;&gt;&amp;#91;TimeWindow&amp;#93;&lt;/span&gt;(queryConfig, 10), new TimeWindow.Serializer)&lt;br/&gt;
    +&lt;br/&gt;
    +    // try to trigger onProcessingTime method via 1, but there is non timer is triggered&lt;br/&gt;
    +    assertEquals(0, testHarness.advanceProcessingTime(1).size())&lt;br/&gt;
    +&lt;br/&gt;
    +    // register cleanup timer with 3001&lt;br/&gt;
    +    assertEquals(&lt;br/&gt;
    +      TriggerResult.CONTINUE,&lt;br/&gt;
    +      testHarness.processElement(new StreamRecord&lt;span class=&quot;error&quot;&gt;&amp;#91;Any&amp;#93;&lt;/span&gt;(1), new TimeWindow(0, 9)))&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    use same `StreamRecord` and `GlobalWindow` object to keep the code more concise?&lt;/p&gt;</comment>
                            <comment id="16012386" author="githubbot" created="Tue, 16 May 2017 13:34:03 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116740788&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116740788&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/triggers/CountTriggerWithCleanupState.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,146 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.runtime.triggers&lt;br/&gt;
    +&lt;br/&gt;
    +import java.lang.&lt;/p&gt;
{Long =&amp;gt; JLong}
&lt;p&gt;    +&lt;br/&gt;
    +import org.apache.flink.api.common.functions.ReduceFunction&lt;br/&gt;
    +import org.apache.flink.api.common.state._&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.Trigger.TriggerContext&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.&lt;/p&gt;
{Trigger, TriggerResult}
&lt;p&gt;    +import org.apache.flink.streaming.api.windowing.windows.Window&lt;br/&gt;
    +import org.apache.flink.table.api.&lt;/p&gt;
{StreamQueryConfig, Types}
&lt;p&gt;    +import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState.Sum&lt;br/&gt;
    +&lt;br/&gt;
    +class CountTriggerWithCleanupState&lt;span class=&quot;error&quot;&gt;&amp;#91;W &amp;lt;: Window&amp;#93;&lt;/span&gt;(queryConfig: StreamQueryConfig, maxCount: Long)&lt;br/&gt;
    +  extends Trigger&lt;span class=&quot;error&quot;&gt;&amp;#91;Any, W&amp;#93;&lt;/span&gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +  private val serialVersionUID: Long = 1L&lt;br/&gt;
    +&lt;br/&gt;
    +  protected val minRetentionTime: Long = queryConfig.getMinIdleStateRetentionTime&lt;br/&gt;
    +  protected val maxRetentionTime: Long = queryConfig.getMaxIdleStateRetentionTime&lt;br/&gt;
    +  protected val stateCleaningEnabled: Boolean = minRetentionTime &amp;gt; 1&lt;br/&gt;
    +&lt;br/&gt;
    +  private val stateDesc: ReducingStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt; =&lt;br/&gt;
    +    new ReducingStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt;(&quot;count&quot;, new Sum, Types.LONG)&lt;br/&gt;
    +&lt;br/&gt;
    +  private val cleanupStateDesc: ValueStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt; =&lt;br/&gt;
    +    new ValueStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt;(&quot;countCleanup&quot;, Types.LONG)&lt;br/&gt;
    +&lt;br/&gt;
    +  override def canMerge: Boolean = true&lt;br/&gt;
    +&lt;br/&gt;
    +  override def onMerge(window: W, ctx: Trigger.OnMergeContext) &lt;/p&gt;
{
    +    ctx.mergePartitionedState(stateDesc)
    +  }
&lt;p&gt;    +&lt;br/&gt;
    +  override def toString: String = &quot;CountTriggerWithCleanupState(&quot; +&lt;br/&gt;
    +    &quot;minIdleStateRetentionTime=&quot; + queryConfig.getMinIdleStateRetentionTime + &quot;, &quot; +&lt;br/&gt;
    +    &quot;maxIdleStateRetentionTime=&quot; + queryConfig.getMaxIdleStateRetentionTime + &quot;, &quot; +&lt;br/&gt;
    +    &quot;maxCount=&quot; + maxCount + &quot;)&quot;&lt;br/&gt;
    +&lt;br/&gt;
    +  override def onElement(&lt;br/&gt;
    +      element: Any,&lt;br/&gt;
    +      timestamp: Long,&lt;br/&gt;
    +      window: W,&lt;br/&gt;
    +      ctx: TriggerContext): TriggerResult = {&lt;br/&gt;
    +&lt;br/&gt;
    +    val currentTime = ctx.getCurrentProcessingTime&lt;br/&gt;
    +&lt;br/&gt;
    +    // register cleanup timer&lt;br/&gt;
    +    if (stateCleaningEnabled) {&lt;br/&gt;
    +      // last registered timer&lt;br/&gt;
    +      val curCleanupTime = ctx.getPartitionedState(cleanupStateDesc).value()&lt;br/&gt;
    +&lt;br/&gt;
    +      // check if a cleanup timer is registered and&lt;br/&gt;
    +      // that the current cleanup timer won&apos;t delete state we need to keep&lt;br/&gt;
    +      if (curCleanupTime == null || (currentTime + minRetentionTime) &amp;gt; curCleanupTime) {&lt;br/&gt;
    +        // we need to register a new (later) timer&lt;br/&gt;
    +        val cleanupTime = currentTime + maxRetentionTime&lt;br/&gt;
    +        // register timer and remember clean-up time&lt;br/&gt;
    +        ctx.registerProcessingTimeTimer(cleanupTime)&lt;br/&gt;
    +&lt;br/&gt;
    +        if (null != curCleanupTime) &lt;/p&gt;
{
    +          ctx.deleteProcessingTimeTimer(curCleanupTime)
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        ctx.getPartitionedState(cleanupStateDesc).update(cleanupTime)&lt;br/&gt;
    +      }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    val count: ReducingState&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt; = ctx.getPartitionedState(stateDesc)&lt;br/&gt;
    +    count.add(1L)&lt;br/&gt;
    +&lt;br/&gt;
    +    if (count.get &amp;gt;= maxCount) &lt;/p&gt;
{
    +      count.clear()
    +      return TriggerResult.FIRE
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    return TriggerResult.CONTINUE&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    remove `return`&lt;/p&gt;</comment>
                            <comment id="16012387" author="githubbot" created="Tue, 16 May 2017 13:34:03 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116740271&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116740271&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/triggers/CountTriggerWithCleanupState.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,146 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.runtime.triggers&lt;br/&gt;
    +&lt;br/&gt;
    +import java.lang.&lt;/p&gt;
{Long =&amp;gt; JLong}
&lt;p&gt;    +&lt;br/&gt;
    +import org.apache.flink.api.common.functions.ReduceFunction&lt;br/&gt;
    +import org.apache.flink.api.common.state._&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.Trigger.TriggerContext&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.&lt;/p&gt;
{Trigger, TriggerResult}
&lt;p&gt;    +import org.apache.flink.streaming.api.windowing.windows.Window&lt;br/&gt;
    +import org.apache.flink.table.api.&lt;/p&gt;
{StreamQueryConfig, Types}
&lt;p&gt;    +import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState.Sum&lt;br/&gt;
    +&lt;br/&gt;
    +class CountTriggerWithCleanupState&lt;span class=&quot;error&quot;&gt;&amp;#91;W &amp;lt;: Window&amp;#93;&lt;/span&gt;(queryConfig: StreamQueryConfig, maxCount: Long)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    We can type the trigger to `GlobalWindow`&lt;/p&gt;</comment>
                            <comment id="16012388" author="githubbot" created="Tue, 16 May 2017 13:34:04 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116740828&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116740828&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/triggers/CountTriggerWithCleanupState.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,146 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.runtime.triggers&lt;br/&gt;
    +&lt;br/&gt;
    +import java.lang.&lt;/p&gt;
{Long =&amp;gt; JLong}
&lt;p&gt;    +&lt;br/&gt;
    +import org.apache.flink.api.common.functions.ReduceFunction&lt;br/&gt;
    +import org.apache.flink.api.common.state._&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.Trigger.TriggerContext&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.&lt;/p&gt;
{Trigger, TriggerResult}
&lt;p&gt;    +import org.apache.flink.streaming.api.windowing.windows.Window&lt;br/&gt;
    +import org.apache.flink.table.api.&lt;/p&gt;
{StreamQueryConfig, Types}
&lt;p&gt;    +import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState.Sum&lt;br/&gt;
    +&lt;br/&gt;
    +class CountTriggerWithCleanupState&lt;span class=&quot;error&quot;&gt;&amp;#91;W &amp;lt;: Window&amp;#93;&lt;/span&gt;(queryConfig: StreamQueryConfig, maxCount: Long)&lt;br/&gt;
    +  extends Trigger&lt;span class=&quot;error&quot;&gt;&amp;#91;Any, W&amp;#93;&lt;/span&gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +  private val serialVersionUID: Long = 1L&lt;br/&gt;
    +&lt;br/&gt;
    +  protected val minRetentionTime: Long = queryConfig.getMinIdleStateRetentionTime&lt;br/&gt;
    +  protected val maxRetentionTime: Long = queryConfig.getMaxIdleStateRetentionTime&lt;br/&gt;
    +  protected val stateCleaningEnabled: Boolean = minRetentionTime &amp;gt; 1&lt;br/&gt;
    +&lt;br/&gt;
    +  private val stateDesc: ReducingStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt; =&lt;br/&gt;
    +    new ReducingStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt;(&quot;count&quot;, new Sum, Types.LONG)&lt;br/&gt;
    +&lt;br/&gt;
    +  private val cleanupStateDesc: ValueStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt; =&lt;br/&gt;
    +    new ValueStateDescriptor&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt;(&quot;countCleanup&quot;, Types.LONG)&lt;br/&gt;
    +&lt;br/&gt;
    +  override def canMerge: Boolean = true&lt;br/&gt;
    +&lt;br/&gt;
    +  override def onMerge(window: W, ctx: Trigger.OnMergeContext) &lt;/p&gt;
{
    +    ctx.mergePartitionedState(stateDesc)
    +  }
&lt;p&gt;    +&lt;br/&gt;
    +  override def toString: String = &quot;CountTriggerWithCleanupState(&quot; +&lt;br/&gt;
    +    &quot;minIdleStateRetentionTime=&quot; + queryConfig.getMinIdleStateRetentionTime + &quot;, &quot; +&lt;br/&gt;
    +    &quot;maxIdleStateRetentionTime=&quot; + queryConfig.getMaxIdleStateRetentionTime + &quot;, &quot; +&lt;br/&gt;
    +    &quot;maxCount=&quot; + maxCount + &quot;)&quot;&lt;br/&gt;
    +&lt;br/&gt;
    +  override def onElement(&lt;br/&gt;
    +      element: Any,&lt;br/&gt;
    +      timestamp: Long,&lt;br/&gt;
    +      window: W,&lt;br/&gt;
    +      ctx: TriggerContext): TriggerResult = {&lt;br/&gt;
    +&lt;br/&gt;
    +    val currentTime = ctx.getCurrentProcessingTime&lt;br/&gt;
    +&lt;br/&gt;
    +    // register cleanup timer&lt;br/&gt;
    +    if (stateCleaningEnabled) {&lt;br/&gt;
    +      // last registered timer&lt;br/&gt;
    +      val curCleanupTime = ctx.getPartitionedState(cleanupStateDesc).value()&lt;br/&gt;
    +&lt;br/&gt;
    +      // check if a cleanup timer is registered and&lt;br/&gt;
    +      // that the current cleanup timer won&apos;t delete state we need to keep&lt;br/&gt;
    +      if (curCleanupTime == null || (currentTime + minRetentionTime) &amp;gt; curCleanupTime) {&lt;br/&gt;
    +        // we need to register a new (later) timer&lt;br/&gt;
    +        val cleanupTime = currentTime + maxRetentionTime&lt;br/&gt;
    +        // register timer and remember clean-up time&lt;br/&gt;
    +        ctx.registerProcessingTimeTimer(cleanupTime)&lt;br/&gt;
    +&lt;br/&gt;
    +        if (null != curCleanupTime) &lt;/p&gt;
{
    +          ctx.deleteProcessingTimeTimer(curCleanupTime)
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        ctx.getPartitionedState(cleanupStateDesc).update(cleanupTime)&lt;br/&gt;
    +      }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    val count: ReducingState&lt;span class=&quot;error&quot;&gt;&amp;#91;JLong&amp;#93;&lt;/span&gt; = ctx.getPartitionedState(stateDesc)&lt;br/&gt;
    +    count.add(1L)&lt;br/&gt;
    +&lt;br/&gt;
    +    if (count.get &amp;gt;= maxCount) &lt;/p&gt;
{
    +      count.clear()
    +      return TriggerResult.FIRE
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    return TriggerResult.CONTINUE&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  override def onProcessingTime(&lt;br/&gt;
    +      time: Long,&lt;br/&gt;
    +      window: W,&lt;br/&gt;
    +      ctx: TriggerContext): TriggerResult = {&lt;br/&gt;
    +&lt;br/&gt;
    +    if (stateCleaningEnabled) {&lt;br/&gt;
    +      val cleanupTime = ctx.getPartitionedState(cleanupStateDesc).value()&lt;br/&gt;
    +      // check that the triggered timer is the last registered processing time timer.&lt;br/&gt;
    +      if (null != cleanupTime &amp;amp;&amp;amp; time == cleanupTime) &lt;/p&gt;
{
    +        clear(window, ctx)
    +        return TriggerResult.FIRE_AND_PURGE
    +      }
&lt;p&gt;    +    }&lt;br/&gt;
    +    return TriggerResult.CONTINUE&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    remove `return`&lt;/p&gt;</comment>
                            <comment id="16012389" author="githubbot" created="Tue, 16 May 2017 13:34:04 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116729795&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116729795&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/triggers/CountTriggerWithCleanupState.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,146 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.runtime.triggers&lt;br/&gt;
    +&lt;br/&gt;
    +import java.lang.&lt;/p&gt;
{Long =&amp;gt; JLong}
&lt;p&gt;    +&lt;br/&gt;
    +import org.apache.flink.api.common.functions.ReduceFunction&lt;br/&gt;
    +import org.apache.flink.api.common.state._&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.Trigger.TriggerContext&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.&lt;/p&gt;
{Trigger, TriggerResult}
&lt;p&gt;    +import org.apache.flink.streaming.api.windowing.windows.Window&lt;br/&gt;
    +import org.apache.flink.table.api.&lt;/p&gt;
{StreamQueryConfig, Types}
&lt;p&gt;    +import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState.Sum&lt;br/&gt;
    +&lt;br/&gt;
    +class CountTriggerWithCleanupState&lt;span class=&quot;error&quot;&gt;&amp;#91;W &amp;lt;: Window&amp;#93;&lt;/span&gt;(queryConfig: StreamQueryConfig, maxCount: Long)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Rename to `StateCleaningCountTrigger`?&lt;/p&gt;</comment>
                            <comment id="16012390" author="githubbot" created="Tue, 16 May 2017 13:34:04 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116738258&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116738258&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/harness/CountTriggerWithCleanupStateHarnessTest.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,305 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.runtime.harness&lt;br/&gt;
    +&lt;br/&gt;
    +import com.google.common.collect.Lists&lt;br/&gt;
    +import org.apache.flink.api.common.time.Time&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.TriggerResult&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.windows.TimeWindow&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.operators.windowing.TriggerTestHarness&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.streamrecord.StreamRecord&lt;br/&gt;
    +import org.apache.flink.table.api.StreamQueryConfig&lt;br/&gt;
    +import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState&lt;br/&gt;
    +import org.junit.Assert.assertEquals&lt;br/&gt;
    +import org.junit.Test&lt;br/&gt;
    +&lt;br/&gt;
    +class CountTriggerWithCleanupStateHarnessTest {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    rename to `StateCleaningCountTrigger`?&lt;/p&gt;</comment>
                            <comment id="16012391" author="githubbot" created="Tue, 16 May 2017 13:34:04 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116740173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116740173&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/harness/CountTriggerWithCleanupStateHarnessTest.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,305 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.runtime.harness&lt;br/&gt;
    +&lt;br/&gt;
    +import com.google.common.collect.Lists&lt;br/&gt;
    +import org.apache.flink.api.common.time.Time&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.TriggerResult&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.windows.TimeWindow&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.operators.windowing.TriggerTestHarness&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.streamrecord.StreamRecord&lt;br/&gt;
    +import org.apache.flink.table.api.StreamQueryConfig&lt;br/&gt;
    +import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState&lt;br/&gt;
    +import org.junit.Assert.assertEquals&lt;br/&gt;
    +import org.junit.Test&lt;br/&gt;
    +&lt;br/&gt;
    +class CountTriggerWithCleanupStateHarnessTest {&lt;br/&gt;
    +  protected var queryConfig =&lt;br/&gt;
    +    new StreamQueryConfig().withIdleStateRetentionTime(Time.seconds(2), Time.seconds(3))&lt;br/&gt;
    +&lt;br/&gt;
    +  @Test&lt;br/&gt;
    +  def testFiringAndFireingWithPurging(): Unit = {&lt;br/&gt;
    +    val testHarness = new TriggerTestHarness&lt;span class=&quot;error&quot;&gt;&amp;#91;Any, TimeWindow&amp;#93;&lt;/span&gt;(&lt;br/&gt;
    +      CountTriggerWithCleanupState.of&lt;span class=&quot;error&quot;&gt;&amp;#91;TimeWindow&amp;#93;&lt;/span&gt;(queryConfig, 10), new TimeWindow.Serializer)&lt;br/&gt;
    +&lt;br/&gt;
    +    // try to trigger onProcessingTime method via 1, but there is non timer is triggered&lt;br/&gt;
    +    assertEquals(0, testHarness.advanceProcessingTime(1).size())&lt;br/&gt;
    +&lt;br/&gt;
    +    // register cleanup timer with 3001&lt;br/&gt;
    +    assertEquals(&lt;br/&gt;
    +      TriggerResult.CONTINUE,&lt;br/&gt;
    +      testHarness.processElement(new StreamRecord&lt;span class=&quot;error&quot;&gt;&amp;#91;Any&amp;#93;&lt;/span&gt;(1), new TimeWindow(0, 9)))&lt;br/&gt;
    +&lt;br/&gt;
    +    // try to trigger onProcessingTime method via 1000, but there is non timer is triggered&lt;br/&gt;
    +    assertEquals(0, testHarness.advanceProcessingTime(1000).size())&lt;br/&gt;
    +&lt;br/&gt;
    +    // 1000 + 2000 &amp;lt;= 3001 reuse timer 3001&lt;br/&gt;
    +    assertEquals(&lt;br/&gt;
    +      TriggerResult.CONTINUE,&lt;br/&gt;
    +      testHarness.processElement(new StreamRecord&lt;span class=&quot;error&quot;&gt;&amp;#91;Any&amp;#93;&lt;/span&gt;(1), new TimeWindow(0, 9)))&lt;br/&gt;
    +&lt;br/&gt;
    +    // there are two state entries, one is timer(3001) another is counter(2)&lt;br/&gt;
    +    assertEquals(2, testHarness.numStateEntries)&lt;br/&gt;
    +&lt;br/&gt;
    +    // try to trigger onProcessingTime method via 3001, and timer(3001) is triggered&lt;br/&gt;
    +    assertEquals(&lt;br/&gt;
    +      TriggerResult.FIRE_AND_PURGE,&lt;br/&gt;
    +      testHarness.advanceProcessingTime(3001).iterator().next().f1)&lt;br/&gt;
    +&lt;br/&gt;
    +    assertEquals(0, testHarness.numStateEntries)&lt;br/&gt;
    +&lt;br/&gt;
    +    // 3001 + 2000 &amp;gt;= 3001 register cleanup timer with 6001, and remove timer 3001&lt;br/&gt;
    +    assertEquals(&lt;br/&gt;
    +      TriggerResult.CONTINUE,&lt;br/&gt;
    +      testHarness.processElement(new StreamRecord&lt;span class=&quot;error&quot;&gt;&amp;#91;Any&amp;#93;&lt;/span&gt;(1), new TimeWindow(0, 9)))&lt;br/&gt;
    +&lt;br/&gt;
    +    // try to trigger onProcessingTime method via 4002, but there is non timer is triggered&lt;br/&gt;
    +    assertEquals(0, testHarness.advanceProcessingTime(4002).size())&lt;br/&gt;
    +&lt;br/&gt;
    +    // 4002 + 2000 &amp;gt;= 6001 register cleanup timer via 7002, and remove timer 6001&lt;br/&gt;
    +    assertEquals(&lt;br/&gt;
    +      TriggerResult.CONTINUE,&lt;br/&gt;
    +      testHarness.processElement(new StreamRecord&lt;span class=&quot;error&quot;&gt;&amp;#91;Any&amp;#93;&lt;/span&gt;(1), new TimeWindow(0, 9)))&lt;br/&gt;
    +&lt;br/&gt;
    +    // 4002 + 2000 &amp;lt;= 7002 reuse timer 7002&lt;br/&gt;
    +    assertEquals(&lt;br/&gt;
    +      TriggerResult.CONTINUE,&lt;br/&gt;
    +      testHarness.processElement(new StreamRecord&lt;span class=&quot;error&quot;&gt;&amp;#91;Any&amp;#93;&lt;/span&gt;(1), new TimeWindow(0, 9)))&lt;br/&gt;
    +&lt;br/&gt;
    +    // have one timer 7002&lt;br/&gt;
    +    assertEquals(1, testHarness.numProcessingTimeTimers)&lt;br/&gt;
    +    assertEquals(0, testHarness.numEventTimeTimers)&lt;br/&gt;
    +    assertEquals(2, testHarness.numStateEntries)&lt;br/&gt;
    +    assertEquals(2, testHarness.numStateEntries(new TimeWindow(0, 9)))&lt;br/&gt;
    +    assertEquals(0, testHarness.numStateEntries(new TimeWindow(9, 18)))&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    There is only a single global window. So, we do not need to test for different windows, IMO.&lt;/p&gt;</comment>
                            <comment id="16012392" author="githubbot" created="Tue, 16 May 2017 13:34:04 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116739074&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116739074&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/harness/CountTriggerWithCleanupStateHarnessTest.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,305 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.runtime.harness&lt;br/&gt;
    +&lt;br/&gt;
    +import com.google.common.collect.Lists&lt;br/&gt;
    +import org.apache.flink.api.common.time.Time&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.TriggerResult&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.windows.TimeWindow&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.operators.windowing.TriggerTestHarness&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.streamrecord.StreamRecord&lt;br/&gt;
    +import org.apache.flink.table.api.StreamQueryConfig&lt;br/&gt;
    +import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState&lt;br/&gt;
    +import org.junit.Assert.assertEquals&lt;br/&gt;
    +import org.junit.Test&lt;br/&gt;
    +&lt;br/&gt;
    +class CountTriggerWithCleanupStateHarnessTest {&lt;br/&gt;
    +  protected var queryConfig =&lt;br/&gt;
    +    new StreamQueryConfig().withIdleStateRetentionTime(Time.seconds(2), Time.seconds(3))&lt;br/&gt;
    +&lt;br/&gt;
    +  @Test&lt;br/&gt;
    +  def testFiringAndFireingWithPurging(): Unit = {&lt;br/&gt;
    +    val testHarness = new TriggerTestHarness&lt;span class=&quot;error&quot;&gt;&amp;#91;Any, TimeWindow&amp;#93;&lt;/span&gt;(&lt;br/&gt;
    +      CountTriggerWithCleanupState.of&lt;span class=&quot;error&quot;&gt;&amp;#91;TimeWindow&amp;#93;&lt;/span&gt;(queryConfig, 10), new TimeWindow.Serializer)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Count windows are based on `GlobalWindow`. Use a `GlobalWindow` instead of a `TimeWindow`. &lt;/p&gt;</comment>
                            <comment id="16012393" author="githubbot" created="Tue, 16 May 2017 13:34:04 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116741416&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116741416&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/harness/CountTriggerWithCleanupStateHarnessTest.scala &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,305 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.flink.table.runtime.harness&lt;br/&gt;
    +&lt;br/&gt;
    +import com.google.common.collect.Lists&lt;br/&gt;
    +import org.apache.flink.api.common.time.Time&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.triggers.TriggerResult&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.windows.TimeWindow&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.operators.windowing.TriggerTestHarness&lt;br/&gt;
    +import org.apache.flink.streaming.runtime.streamrecord.StreamRecord&lt;br/&gt;
    +import org.apache.flink.table.api.StreamQueryConfig&lt;br/&gt;
    +import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState&lt;br/&gt;
    +import org.junit.Assert.assertEquals&lt;br/&gt;
    +import org.junit.Test&lt;br/&gt;
    +&lt;br/&gt;
    +class CountTriggerWithCleanupStateHarnessTest {&lt;br/&gt;
    +  protected var queryConfig =&lt;br/&gt;
    +    new StreamQueryConfig().withIdleStateRetentionTime(Time.seconds(2), Time.seconds(3))&lt;br/&gt;
    +&lt;br/&gt;
    +  @Test&lt;br/&gt;
    +  def testFiringAndFireingWithPurging(): Unit = &lt;/p&gt;
{
    +    val testHarness = new TriggerTestHarness[Any, TimeWindow](
    +      CountTriggerWithCleanupState.of[TimeWindow](queryConfig, 10), new TimeWindow.Serializer)
    +
    +    // try to trigger onProcessingTime method via 1, but there is non timer is triggered
    +    assertEquals(0, testHarness.advanceProcessingTime(1).size())
    +
    +    // register cleanup timer with 3001
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +
    +    // try to trigger onProcessingTime method via 1000, but there is non timer is triggered
    +    assertEquals(0, testHarness.advanceProcessingTime(1000).size())
    +
    +    // 1000 + 2000 &amp;lt;= 3001 reuse timer 3001
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +
    +    // there are two state entries, one is timer(3001) another is counter(2)
    +    assertEquals(2, testHarness.numStateEntries)
    +
    +    // try to trigger onProcessingTime method via 3001, and timer(3001) is triggered
    +    assertEquals(
    +      TriggerResult.FIRE_AND_PURGE,
    +      testHarness.advanceProcessingTime(3001).iterator().next().f1)
    +
    +    assertEquals(0, testHarness.numStateEntries)
    +
    +    // 3001 + 2000 &amp;gt;= 3001 register cleanup timer with 6001, and remove timer 3001
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +
    +    // try to trigger onProcessingTime method via 4002, but there is non timer is triggered
    +    assertEquals(0, testHarness.advanceProcessingTime(4002).size())
    +
    +    // 4002 + 2000 &amp;gt;= 6001 register cleanup timer via 7002, and remove timer 6001
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +
    +    // 4002 + 2000 &amp;lt;= 7002 reuse timer 7002
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +
    +    // have one timer 7002
    +    assertEquals(1, testHarness.numProcessingTimeTimers)
    +    assertEquals(0, testHarness.numEventTimeTimers)
    +    assertEquals(2, testHarness.numStateEntries)
    +    assertEquals(2, testHarness.numStateEntries(new TimeWindow(0, 9)))
    +    assertEquals(0, testHarness.numStateEntries(new TimeWindow(9, 18)))
    +
    +    // 4002 + 2000 &amp;lt;= 7002 reuse timer 7002
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +
    +    // register cleanup timer via 7002 for window (9, 18)
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(9, 18)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(9, 18)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(9, 18)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(9, 18)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(9, 18)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(9, 18)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(9, 18)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(9, 18)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(9, 18)))
    +
    +    // there are four state entries
    +    assertEquals(4, testHarness.numStateEntries)
    +    assertEquals(2, testHarness.numStateEntries(new TimeWindow(0, 9)))
    +    assertEquals(2, testHarness.numStateEntries(new TimeWindow(9, 18)))
    +
    +    // the window counter triggered, count &amp;gt;= 10
    +    assertEquals(
    +      TriggerResult.FIRE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(9, 18)))
    +
    +    // counter of window(9, 18) is cleared
    +    assertEquals(3, testHarness.numStateEntries)
    +
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +    assertEquals(
    +      TriggerResult.FIRE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 9)))
    +
    +    // counter of window(0, 9) is cleared
    +    assertEquals(2, testHarness.numStateEntries)
    +    assertEquals(1, testHarness.numStateEntries(new TimeWindow(0, 9)))
    +    assertEquals(1, testHarness.numStateEntries(new TimeWindow(9, 18)))
    +
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(18, 27)))
    +
    +    assertEquals(4, testHarness.numStateEntries)
    +
    +    // try to trigger onProcessingTime method via 7002, and all states are cleared
    +    assertEquals(
    +      TriggerResult.FIRE_AND_PURGE,
    +      testHarness.advanceProcessingTime(7002).iterator().next().f1)
    +
    +    assertEquals(0, testHarness.numStateEntries)
    +  }
&lt;p&gt;    +&lt;br/&gt;
    +  /**&lt;br/&gt;
    +    * Verify that clear() does not leak across windows.&lt;br/&gt;
    +    */&lt;br/&gt;
    +  @Test&lt;br/&gt;
    +  def testClear() &lt;/p&gt;
{
    +    val testHarness = new TriggerTestHarness[Any, TimeWindow](
    +      CountTriggerWithCleanupState.of[TimeWindow](queryConfig, 3),
    +      new TimeWindow.Serializer)
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(0, 2)))
    +    assertEquals(
    +      TriggerResult.CONTINUE,
    +      testHarness.processElement(new StreamRecord[Any](1), new TimeWindow(2, 4)))
    +    // have 2 timers
    +    assertEquals(2, testHarness.numProcessingTimeTimers)
    +    assertEquals(0, testHarness.numEventTimeTimers)
    +    assertEquals(4, testHarness.numStateEntries)
    +    assertEquals(2, testHarness.numStateEntries(new TimeWindow(0, 2)))
    +    assertEquals(2, testHarness.numStateEntries(new TimeWindow(2, 4)))
    +    testHarness.clearTriggerState(new TimeWindow(2, 4))
    +    assertEquals(2, testHarness.numStateEntries)
    +    assertEquals(2, testHarness.numStateEntries(new TimeWindow(0, 2)))
    +    assertEquals(0, testHarness.numStateEntries(new TimeWindow(2, 4)))
    +    testHarness.clearTriggerState(new TimeWindow(0, 2))
    +    assertEquals(0, testHarness.numStateEntries)
    +    assertEquals(0, testHarness.numStateEntries(new TimeWindow(0, 2)))
    +    assertEquals(0, testHarness.numStateEntries(new TimeWindow(2, 4)))
    +  }
&lt;p&gt;    +&lt;br/&gt;
    +  @Test&lt;br/&gt;
    +  def testMergingWindows() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    If the trigger does not support merging we can drop the next two tests.&lt;/p&gt;</comment>
                            <comment id="16013369" author="githubbot" created="Wed, 17 May 2017 01:45:28 +0000"  >&lt;p&gt;Github user sunjincheng121 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @fhueske Thanks a lot for your suggestions.I had updated the PR. according the comments.&lt;/p&gt;

&lt;p&gt;    Best,&lt;br/&gt;
    SunJincheng&lt;/p&gt;</comment>
                            <comment id="16013705" author="githubbot" created="Wed, 17 May 2017 08:14:27 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r116932844&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r116932844&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/triggers/StateCleaningCountTrigger.scala &amp;#8212;&lt;br/&gt;
    @@ -19,44 +19,46 @@ package org.apache.flink.table.runtime.triggers&lt;/p&gt;

&lt;p&gt;     import java.lang.&lt;/p&gt;
{Long =&amp;gt; JLong}

&lt;p&gt;    +import org.apache.flink.annotation.PublicEvolving&lt;br/&gt;
     import org.apache.flink.api.common.functions.ReduceFunction&lt;br/&gt;
     import org.apache.flink.api.common.state._&lt;br/&gt;
     import org.apache.flink.streaming.api.windowing.triggers.Trigger.TriggerContext&lt;br/&gt;
     import org.apache.flink.streaming.api.windowing.triggers.&lt;/p&gt;
{Trigger, TriggerResult}
&lt;p&gt;    -import org.apache.flink.streaming.api.windowing.windows.Window&lt;br/&gt;
    +import org.apache.flink.streaming.api.windowing.windows.GlobalWindow&lt;br/&gt;
     import org.apache.flink.table.api.&lt;/p&gt;
{StreamQueryConfig, Types}
&lt;p&gt;    -import org.apache.flink.table.runtime.triggers.CountTriggerWithCleanupState.Sum&lt;br/&gt;
    +import org.apache.flink.table.runtime.triggers.StateCleaningCountTrigger.Sum&lt;/p&gt;

&lt;p&gt;    -class CountTriggerWithCleanupState&lt;span class=&quot;error&quot;&gt;&amp;#91;W &amp;lt;: Window&amp;#93;&lt;/span&gt;(queryConfig: StreamQueryConfig, maxCount: Long)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;extends Trigger&lt;span class=&quot;error&quot;&gt;&amp;#91;Any, W&amp;#93;&lt;/span&gt; {&lt;br/&gt;
    +/**&lt;br/&gt;
    +  * A 
{@link Trigger}
&lt;p&gt; that fires once the count of elements in a pane reaches the given count&lt;br/&gt;
    +  * or the cleanup timer is triggered.&lt;br/&gt;
    +  */&lt;br/&gt;
    +@PublicEvolving&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We only annotate classes the core, DataSet and DataStream APIs with stability annotations.&lt;br/&gt;
    `@PublicEvolving` should be removed.&lt;/p&gt;</comment>
                            <comment id="16014029" author="githubbot" created="Wed, 17 May 2017 13:25:41 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16014071" author="fhueske" created="Wed, 17 May 2017 13:46:29 +0000"  >&lt;p&gt;Fixed for 1.3.0 with 36cac0fb64ade6debc66f06e00d4184cdc0fba5f&lt;br/&gt;
Fixed for 1.4.0 with d85d969334e89d83aec60f9bb3d2c69a4701eb54&lt;/p&gt;</comment>
                            <comment id="16014839" author="githubbot" created="Wed, 17 May 2017 22:05:47 +0000"  >&lt;p&gt;Github user tedyu commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r117121382&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r117121382&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/datastream/DataStreamGroupWindowAggregate.scala &amp;#8212;&lt;br/&gt;
    @@ -245,6 +264,7 @@ object DataStreamGroupWindowAggregate {&lt;br/&gt;
         case SlidingGroupWindow(_, timeField, size, slide)&lt;br/&gt;
             if isProctimeAttribute(timeField) &amp;amp;&amp;amp; isRowCountLiteral(size) =&amp;gt;&lt;br/&gt;
           stream.countWindow(toLong(size), toLong(slide))&lt;br/&gt;
    +      .trigger(StateCleaningCountTrigger.of(queryConfig, toLong(slide)));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Should this be toLong(size) ?&lt;/p&gt;</comment>
                            <comment id="16014847" author="githubbot" created="Wed, 17 May 2017 22:11:11 +0000"  >&lt;p&gt;Github user tedyu commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r117122323&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r117122323&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/datastream/DataStreamGroupWindowAggregate.scala &amp;#8212;&lt;br/&gt;
    @@ -131,6 +135,19 @@ class DataStreamGroupWindowAggregate(&lt;br/&gt;
               &quot;non-windowed GroupBy aggregation.&quot;)&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;    +    val isCountWindow = window match &lt;/p&gt;
{
    +      case TumblingGroupWindow(_, _, size) if isRowCountLiteral(size) =&amp;gt; true
    +      case SlidingGroupWindow(_, _, size, _) if isRowCountLiteral(size) =&amp;gt; true
    +      case _ =&amp;gt; false
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    if (isCountWindow &amp;amp;&amp;amp; grouping.length &amp;gt; 0 &amp;amp;&amp;amp; queryConfig.getMinIdleStateRetentionTime &amp;lt; 0) {&lt;br/&gt;
    +      LOG.warn(&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Should this be error() ?&lt;/p&gt;</comment>
                            <comment id="16015387" author="githubbot" created="Thu, 18 May 2017 08:05:28 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r117183206&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r117183206&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/datastream/DataStreamGroupWindowAggregate.scala &amp;#8212;&lt;br/&gt;
    @@ -245,6 +264,7 @@ object DataStreamGroupWindowAggregate {&lt;br/&gt;
         case SlidingGroupWindow(_, timeField, size, slide)&lt;br/&gt;
             if isProctimeAttribute(timeField) &amp;amp;&amp;amp; isRowCountLiteral(size) =&amp;gt;&lt;br/&gt;
           stream.countWindow(toLong(size), toLong(slide))&lt;br/&gt;
    +      .trigger(StateCleaningCountTrigger.of(queryConfig, toLong(slide)));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `slide` is correct here (check `KeyedStream.countWindow(long, long)`).&lt;/p&gt;

&lt;p&gt;    The default trigger is replaced by a trigger that additional registers a clean up timer. The trigger policy based on counts is still the same.&lt;/p&gt;</comment>
                            <comment id="16015389" author="githubbot" created="Thu, 18 May 2017 08:07:27 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3919#discussion_r117183489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3919#discussion_r117183489&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/nodes/datastream/DataStreamGroupWindowAggregate.scala &amp;#8212;&lt;br/&gt;
    @@ -131,6 +135,19 @@ class DataStreamGroupWindowAggregate(&lt;br/&gt;
               &quot;non-windowed GroupBy aggregation.&quot;)&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;    +    val isCountWindow = window match &lt;/p&gt;
{
    +      case TumblingGroupWindow(_, _, size) if isRowCountLiteral(size) =&amp;gt; true
    +      case SlidingGroupWindow(_, _, size, _) if isRowCountLiteral(size) =&amp;gt; true
    +      case _ =&amp;gt; false
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    if (isCountWindow &amp;amp;&amp;amp; grouping.length &amp;gt; 0 &amp;amp;&amp;amp; queryConfig.getMinIdleStateRetentionTime &amp;lt; 0) {&lt;br/&gt;
    +      LOG.warn(&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think this can be argued in both ways. If we log an error message could also throw an exception and prevent the program to be executed. However, there are also other strategies to deal with state cleanup, e.g., by configuring RocksDB.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 26 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3eytj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>