<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:46:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-17928] Incorrect state size reported when using unaligned checkpoints </title>
                <link>https://issues.apache.org/jira/browse/FLINK-17928</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Even when checkpoints on HDFS are between 100-300MBs, the reported state size is in orders of magnitude larger with values like:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;1GiB  1.5TiB  2.0TiB  2.1TiB  2.1TiB
148GiB  148GiB  148GiB  148GiB  148GiB  148GiB
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;it&apos;s probably because we have multiple &lt;tt&gt;Collection&amp;lt;InputChannelStateHandle&amp;gt;&lt;/tt&gt;, and each of the individual handle returns the same value from &lt;tt&gt;AbstractChannelStateHandle#getStateSize&lt;/tt&gt; - the full size of the spilled data, ignoring that only small portion of those data belong to a single input channel/result subpartition. In other words {{&lt;br/&gt;
org.apache.flink.runtime.state.AbstractChannelStateHandle#getStateSize}} should be taking the offsets into account and return only the size of the data that belong exclusively to this handle.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13307237">FLINK-17928</key>
            <summary>Incorrect state size reported when using unaligned checkpoints </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 25 May 2020 13:29:48 +0000</created>
                <updated>Thu, 28 May 2020 06:15:22 +0000</updated>
                            <resolved>Thu, 28 May 2020 06:15:22 +0000</resolved>
                                    <version>1.11.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17116021" author="roman_khachatryan" created="Mon, 25 May 2020 13:31:42 +0000"  >&lt;p&gt;The numbers were obtained using:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
writtenBytes() {
        rest_url=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//`hostname`:20888/proxy/`get_aid`&quot;&lt;/span&gt;
&lt;/span&gt;        job_id=`curl $rest_url/jobs/ | jq -r &lt;span class=&quot;code-quote&quot;&gt;&apos;.jobs[0].id&apos;&lt;/span&gt;`
        vertex_ids=( `curl $rest_url/jobs/$job_id/ | jq -r &lt;span class=&quot;code-quote&quot;&gt;&apos;.vertices[].id&apos;&lt;/span&gt;` )
        writtenBytes=0
        &amp;gt;&amp;amp;2 echo &lt;span class=&quot;code-quote&quot;&gt;&quot;job_id $job_id; vertex_ids: ${vertex_ids[@]}&quot;&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; vertex in &lt;span class=&quot;code-quote&quot;&gt;&quot;${vertex_ids[@]}&quot;&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
                stats=`curl $rest_url/jobs/$job_id/vertices/$vertex/subtasks/metrics\?get=writtenBytes_input,writtenBytes_output\&amp;amp;agg=sum`
                stats2=`curl $rest_url/jobs/$job_id/vertices/$vertex/subtasks/metrics\?get=writtenBytes\&amp;amp;agg=sum`
                &amp;gt;&amp;amp;2 echo &lt;span class=&quot;code-quote&quot;&gt;&quot;vertex $vertex $stats $stats2&quot;&lt;/span&gt;
                writtenBytes=$(($writtenBytes + `echo $stats $stats2 | jq -s &lt;span class=&quot;code-quote&quot;&gt;&apos;[add | .[] | select(.id | test(&lt;span class=&quot;code-quote&quot;&gt;&quot;writtenBytes.*&quot;&lt;/span&gt;)).sum] | add &lt;span class=&quot;code-comment&quot;&gt;// 0&apos;&lt;/span&gt; `))
&lt;/span&gt;        done
        echo &lt;span class=&quot;code-quote&quot;&gt;&quot;$writtenBytes&quot;&lt;/span&gt; | numfmt --to=iec-i --suffix=B --padding=7
}


transferredBytes() {
 rest_url=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//`hostname`:20888/proxy/`get_aid`&quot;&lt;/span&gt;
&lt;/span&gt; job_id=`curl $rest_url/jobs/ | jq -r &lt;span class=&quot;code-quote&quot;&gt;&apos;.jobs[0].id&apos;&lt;/span&gt;`
 vertex_ids=( `curl $rest_url/jobs/$job_id/ | jq -r &lt;span class=&quot;code-quote&quot;&gt;&apos;.vertices[].id&apos;&lt;/span&gt;` )
 numBytesOut=0
 &amp;gt;&amp;amp;2 echo &lt;span class=&quot;code-quote&quot;&gt;&quot;job_id $job_id; vertex_ids: ${vertex_ids[@]}&quot;&lt;/span&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; vertex in &lt;span class=&quot;code-quote&quot;&gt;&quot;${vertex_ids[@]}&quot;&lt;/span&gt;;
 &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
 stats=`curl $rest_url/jobs/$job_id/vertices/$vertex/subtasks/metrics\?get=numBytesOut\&amp;amp;agg=sum`
 &amp;gt;&amp;amp;2 echo &lt;span class=&quot;code-quote&quot;&gt;&quot;vertex $vertex $stats&quot;&lt;/span&gt;
 numBytesOut=$(($numBytesOut + `echo $stats | jq -s &lt;span class=&quot;code-quote&quot;&gt;&apos;[add | .[].sum] | add &lt;span class=&quot;code-comment&quot;&gt;// 0&apos;&lt;/span&gt; `))
&lt;/span&gt; done
 echo &lt;span class=&quot;code-quote&quot;&gt;&quot;$numBytesOut&quot;&lt;/span&gt; | numfmt --to=iec-i --suffix=B --padding=7
}&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is how it&apos;s called:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
function experiment() {
 name=$1
 nodes=$2
 slots=$3
 dur=$4
 start_job ${nodes} ${slots}
 duration ${dur}
# writtenBytes=&lt;span class=&quot;code-quote&quot;&gt;&quot;`writtenBytes` `writtenBytes` `writtenBytes` `writtenBytes` `writtenBytes` `writtenBytes` `writtenBytes`&quot;&lt;/span&gt;
 transferredBytes=&lt;span class=&quot;code-quote&quot;&gt;&quot;`transferredBytes` `transferredBytes` `transferredBytes` `transferredBytes` `transferredBytes` `transferredBytes` `transferredBytes`&quot;&lt;/span&gt;
 APPID=`kill_on_yarn`
getLogsFor ${name} ${APPID}
 analyzeLogs ${name} ${APPID}
 truncate -s -1 ${LOG}
 echo &lt;span class=&quot;code-quote&quot;&gt;&quot;;$transferredBytes&quot;&lt;/span&gt; &amp;gt;&amp;gt; ${LOG}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That is, those are transferred bytes, not written bytes (see commented line in&#160;experiment()).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17116939" author="pnowojski" created="Tue, 26 May 2020 17:57:48 +0000"  >&lt;p&gt;Maybe, but the problem is still there:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[hadoop@ip-172-31-35-50 logs]$ zcat master17-hdfs-unaligned-throughput2-application_1589453804748_0116.gz | grep INFO | grep -i complet
2020-05-17 09:33:08,854 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 1 for job 7f2de1d00cc862534746985f4c021098 (25766077793 bytes in 38316 ms).
2020-05-17 09:34:23,546 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 2 for job 7f2de1d00cc862534746985f4c021098 (42803408024 bytes in 35183 ms).
2020-05-17 09:35:33,974 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 3 for job 7f2de1d00cc862534746985f4c021098 (42037807324 bytes in 33832 ms).
2020-05-17 09:36:47,447 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 4 for job 7f2de1d00cc862534746985f4c021098 (38890649497 bytes in 34755 ms).
2020-05-17 09:38:00,182 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 5 for job 7f2de1d00cc862534746985f4c021098 (41471661012 bytes in 34806 ms).
2020-05-17 09:39:09,803 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 6 for job 7f2de1d00cc862534746985f4c021098 (40503930228 bytes in 34256 ms).
2020-05-17 09:40:23,162 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 7 for job 7f2de1d00cc862534746985f4c021098 (41961537883 bytes in 35310 ms).
2020-05-17 09:41:35,483 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 8 for job 7f2de1d00cc862534746985f4c021098 (41942565096 bytes in 35262 ms).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It&apos;s reported as tens of GBs, while single checkpoint is ~hundreds of MBs:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[hadoop@ip-172-31-35-50 logs]$ hdfs dfs -du -h unaligned/20192aeea3043ae6211c786744837988
175.8 M  unaligned/20192aeea3043ae6211c786744837988/chk-6
183.4 M  unaligned/20192aeea3043ae6211c786744837988/chk-7
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17118356" author="pnowojski" created="Thu, 28 May 2020 06:15:22 +0000"  >&lt;p&gt;merged to release-1.11 as a9782a2483&lt;br/&gt;
merged to master as f89c606f12&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0f4sg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>