<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:32:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7804] YarnResourceManager does not execute AMRMClientAsync callbacks in main thread</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7804</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;YarnResourceManager&lt;/tt&gt; registers callbacks at a &lt;tt&gt;AMRMClientAsync&lt;/tt&gt; which it uses to react to Yarn container allocations. These callbacks (e.g. &lt;tt&gt;onContainersAllocated&lt;/tt&gt; modify the internal state of the &lt;tt&gt;YarnResourceManager&lt;/tt&gt;. This can lead to race conditions with the &lt;tt&gt;requestYarnContainer&lt;/tt&gt; method.&lt;/p&gt;

&lt;p&gt;In order to solve this problem we have to execute the state changing operations in the main thread of the &lt;tt&gt;YarnResourceManager&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13108528">FLINK-7804</key>
            <summary>YarnResourceManager does not execute AMRMClientAsync callbacks in main thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gjy">Gary Yao</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>flip-6</label>
                    </labels>
                <created>Wed, 11 Oct 2017 08:30:12 +0000</created>
                <updated>Sun, 18 Mar 2018 18:01:28 +0000</updated>
                            <resolved>Sun, 18 Mar 2018 18:01:28 +0000</resolved>
                                    <version>1.4.0</version>
                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Deployment / YARN</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16392891" author="githubbot" created="Fri, 9 Mar 2018 13:37:09 +0000"  >&lt;p&gt;GitHub user GJL opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5675&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5675&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7804&quot; title=&quot;YarnResourceManager does not execute AMRMClientAsync callbacks in main thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7804&quot;&gt;&lt;del&gt;FLINK-7804&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; YarnResourceManager does not execute AMRMClientAsync callbacks in main thread&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    &lt;b&gt;The `YarnResourceManager` registers callbacks at a `AMRMClientAsync` which it uses to react to Yarn container allocations. These callbacks, e.g., `onContainersAllocated`, modify the internal state of the YarnResourceManager. This can lead to race conditions with the `requestYarnContainer` method. To solve this problem we have to execute the state changing operations in the main thread of the `YarnResourceManager`.&lt;/b&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Run AMRMClientAsync callbacks in main thread&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Fix `YarnResourceManagerTest`&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change is already covered by existing tests, such as `YarnResourceManagerTest`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/GJL/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/GJL/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7804&quot; title=&quot;YarnResourceManager does not execute AMRMClientAsync callbacks in main thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7804&quot;&gt;&lt;del&gt;FLINK-7804&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5675.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5675.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5675&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f6c61e0c7989d6d67f784818aa94cd112f600bff&lt;br/&gt;
Author: gyao &amp;lt;gary@...&amp;gt;&lt;br/&gt;
Date:   2018-03-09T13:36:33Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7804&quot; title=&quot;YarnResourceManager does not execute AMRMClientAsync callbacks in main thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7804&quot;&gt;&lt;del&gt;FLINK-7804&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip6&amp;#93;&lt;/span&gt; Run AMRMClientAsync callbacks in main thread&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16400613" author="githubbot" created="Thu, 15 Mar 2018 15:55:16 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5675#discussion_r174834772&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5675#discussion_r174834772&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -395,10 +405,13 @@ public void onNodesUpdated(List&amp;lt;NodeReport&amp;gt; list) {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void onError(Throwable error) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;onFatalError(error);&lt;br/&gt;
    +		runAsync(() -&amp;gt; onFatalError(error));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think it would be good to let the error propagate directly. In case of an OOM exception we want to quickly shut down the JVM.&lt;/p&gt;</comment>
                            <comment id="16400614" author="githubbot" created="Thu, 15 Mar 2018 15:55:16 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5675#discussion_r174834515&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5675#discussion_r174834515&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -325,67 +328,74 @@ public float getProgress() {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void onContainersCompleted(List&amp;lt;ContainerStatus&amp;gt; list) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (ContainerStatus container : list) {&lt;/li&gt;
	&lt;li&gt;if (container.getExitStatus() &amp;lt; 0) {&lt;/li&gt;
	&lt;li&gt;closeTaskManagerConnection(new ResourceID(&lt;/li&gt;
	&lt;li&gt;container.getContainerId().toString()), new Exception(container.getDiagnostics()));&lt;br/&gt;
    +		runAsync(() -&amp;gt; {&lt;br/&gt;
    +				for (ContainerStatus container : list) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (container.getExitStatus() &amp;lt; 0) {
    +						closeTaskManagerConnection(new ResourceID(
    +							container.getContainerId().toString()), new Exception(container.getDiagnostics()));
    +					}    +					workerNodeMap.remove(new ResourceID(container.getContainerId().toString()));    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;workerNodeMap.remove(new ResourceID(container.getContainerId().toString()));&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
    +		);&lt;br/&gt;
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	@Override&lt;br/&gt;
     	public void onContainersAllocated(List&amp;lt;Container&amp;gt; containers) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (Container container : containers) {&lt;/li&gt;
	&lt;li&gt;log.info(&lt;/li&gt;
	&lt;li&gt;&quot;Received new container: {} - Remaining pending container requests: {}&quot;,&lt;/li&gt;
	&lt;li&gt;container.getId(),&lt;/li&gt;
	&lt;li&gt;numPendingContainerRequests);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (numPendingContainerRequests &amp;gt; 0) {&lt;/li&gt;
	&lt;li&gt;numPendingContainerRequests--;&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;final String containerIdStr = container.getId().toString();&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;workerNodeMap.put(new ResourceID(containerIdStr), new YarnWorkerNode(container));&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;try 
{
    -					// Context information used to start a TaskExecutor Java process
    -					ContainerLaunchContext taskExecutorLaunchContext = createTaskExecutorLaunchContext(
    -						container.getResource(),
    -						containerIdStr,
    -						container.getNodeId().getHost());
    -
    -					nodeManagerClient.startContainer(container, taskExecutorLaunchContext);
    -				}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;log.error(&quot;Could not start TaskManager in container {}.&quot;, container.getId(), t);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;// release the failed container&lt;br/&gt;
    +		runAsync(() -&amp;gt; {&lt;br/&gt;
    +			for (Container container : containers) {&lt;br/&gt;
    +				log.info(&lt;br/&gt;
    +					&quot;Received new container: {} - Remaining pending container requests: {}&quot;,&lt;br/&gt;
    +					container.getId(),&lt;br/&gt;
    +					numPendingContainerRequests);&lt;br/&gt;
    +&lt;br/&gt;
    +				if (numPendingContainerRequests &amp;gt; 0) {&lt;br/&gt;
    +					numPendingContainerRequests--;&lt;br/&gt;
    +&lt;br/&gt;
    +					final String containerIdStr = container.getId().toString();&lt;br/&gt;
    +&lt;br/&gt;
    +					workerNodeMap.put(new ResourceID(containerIdStr), new YarnWorkerNode(container));&lt;br/&gt;
    +&lt;br/&gt;
    +					try 
{
    +						// Context information used to start a TaskExecutor Java process
    +						ContainerLaunchContext taskExecutorLaunchContext = createTaskExecutorLaunchContext(
    +							container.getResource(),
    +							containerIdStr,
    +							container.getNodeId().getHost());
    +
    +						nodeManagerClient.startContainer(container, taskExecutorLaunchContext);
    +					}
&lt;p&gt; catch (Throwable t) {&lt;br/&gt;
    +						log.error(&quot;Could not start TaskManager in container {}.&quot;, container.getId(), t);&lt;br/&gt;
    +&lt;br/&gt;
    +						// release the failed container&lt;br/&gt;
    +						resourceManagerClient.releaseAssignedContainer(container.getId());&lt;br/&gt;
    +						// and ask for a new one&lt;br/&gt;
    +						requestYarnContainer(container.getResource(), container.getPriority());&lt;br/&gt;
    +					}&lt;br/&gt;
    +				} else {&lt;br/&gt;
    +					// return the excessive containers&lt;br/&gt;
    +					log.info(&quot;Returning excess container {}.&quot;, container.getId());&lt;br/&gt;
     					resourceManagerClient.releaseAssignedContainer(container.getId());&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;// and ask for a new one&lt;/li&gt;
	&lt;li&gt;requestYarnContainer(container.getResource(), container.getPriority());&lt;br/&gt;
     				}&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;// return the excessive containers&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Returning excess container {}.&quot;, container.getId());&lt;/li&gt;
	&lt;li&gt;resourceManagerClient.releaseAssignedContainer(container.getId());&lt;br/&gt;
     			}&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// if we are waiting for no further containers, we can go to the&lt;/li&gt;
	&lt;li&gt;// regular heartbeat interval&lt;/li&gt;
	&lt;li&gt;if (numPendingContainerRequests &amp;lt;= 0) 
{
    -			resourceManagerClient.setHeartbeatInterval(yarnHeartbeatIntervalMillis);
    -		}
&lt;p&gt;    +			// if we are waiting for no further containers, we can go to the&lt;br/&gt;
    +			// regular heartbeat interval&lt;br/&gt;
    +			if (numPendingContainerRequests &amp;lt;= 0) &lt;/p&gt;
{
    +				resourceManagerClient.setHeartbeatInterval(yarnHeartbeatIntervalMillis);
    +			}
&lt;p&gt;    +		});&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	@Override&lt;br/&gt;
     	public void onShutdownRequest() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			shutDown();
    -		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    -			log.warn(&quot;Fail to shutdown the YARN resource manager.&quot;, e);
    -		}
&lt;p&gt;    +		runAsync(() -&amp;gt; {&lt;br/&gt;
    +			try {&lt;br/&gt;
    +				shutDown();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    `shutDown` can be directly called&lt;/p&gt;</comment>
                            <comment id="16401579" author="githubbot" created="Fri, 16 Mar 2018 08:18:16 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5675#discussion_r175020983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5675#discussion_r175020983&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -395,10 +405,13 @@ public void onNodesUpdated(List&amp;lt;NodeReport&amp;gt; list) {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void onError(Throwable error) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;onFatalError(error);&lt;br/&gt;
    +		runAsync(() -&amp;gt; onFatalError(error));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    done&lt;/p&gt;</comment>
                            <comment id="16401580" author="githubbot" created="Fri, 16 Mar 2018 08:18:19 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5675#discussion_r175020997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5675#discussion_r175020997&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -325,67 +328,74 @@ public float getProgress() {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void onContainersCompleted(List&amp;lt;ContainerStatus&amp;gt; list) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (ContainerStatus container : list) {&lt;/li&gt;
	&lt;li&gt;if (container.getExitStatus() &amp;lt; 0) {&lt;/li&gt;
	&lt;li&gt;closeTaskManagerConnection(new ResourceID(&lt;/li&gt;
	&lt;li&gt;container.getContainerId().toString()), new Exception(container.getDiagnostics()));&lt;br/&gt;
    +		runAsync(() -&amp;gt; {&lt;br/&gt;
    +				for (ContainerStatus container : list) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (container.getExitStatus() &amp;lt; 0) {
    +						closeTaskManagerConnection(new ResourceID(
    +							container.getContainerId().toString()), new Exception(container.getDiagnostics()));
    +					}    +					workerNodeMap.remove(new ResourceID(container.getContainerId().toString()));    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     			}&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;workerNodeMap.remove(new ResourceID(container.getContainerId().toString()));&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
    +		);&lt;br/&gt;
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	@Override&lt;br/&gt;
     	public void onContainersAllocated(List&amp;lt;Container&amp;gt; containers) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (Container container : containers) {&lt;/li&gt;
	&lt;li&gt;log.info(&lt;/li&gt;
	&lt;li&gt;&quot;Received new container: {} - Remaining pending container requests: {}&quot;,&lt;/li&gt;
	&lt;li&gt;container.getId(),&lt;/li&gt;
	&lt;li&gt;numPendingContainerRequests);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (numPendingContainerRequests &amp;gt; 0) {&lt;/li&gt;
	&lt;li&gt;numPendingContainerRequests--;&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;final String containerIdStr = container.getId().toString();&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;workerNodeMap.put(new ResourceID(containerIdStr), new YarnWorkerNode(container));&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;try 
{
    -					// Context information used to start a TaskExecutor Java process
    -					ContainerLaunchContext taskExecutorLaunchContext = createTaskExecutorLaunchContext(
    -						container.getResource(),
    -						containerIdStr,
    -						container.getNodeId().getHost());
    -
    -					nodeManagerClient.startContainer(container, taskExecutorLaunchContext);
    -				}
&lt;p&gt; catch (Throwable t) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;log.error(&quot;Could not start TaskManager in container {}.&quot;, container.getId(), t);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;// release the failed container&lt;br/&gt;
    +		runAsync(() -&amp;gt; {&lt;br/&gt;
    +			for (Container container : containers) {&lt;br/&gt;
    +				log.info(&lt;br/&gt;
    +					&quot;Received new container: {} - Remaining pending container requests: {}&quot;,&lt;br/&gt;
    +					container.getId(),&lt;br/&gt;
    +					numPendingContainerRequests);&lt;br/&gt;
    +&lt;br/&gt;
    +				if (numPendingContainerRequests &amp;gt; 0) {&lt;br/&gt;
    +					numPendingContainerRequests--;&lt;br/&gt;
    +&lt;br/&gt;
    +					final String containerIdStr = container.getId().toString();&lt;br/&gt;
    +&lt;br/&gt;
    +					workerNodeMap.put(new ResourceID(containerIdStr), new YarnWorkerNode(container));&lt;br/&gt;
    +&lt;br/&gt;
    +					try 
{
    +						// Context information used to start a TaskExecutor Java process
    +						ContainerLaunchContext taskExecutorLaunchContext = createTaskExecutorLaunchContext(
    +							container.getResource(),
    +							containerIdStr,
    +							container.getNodeId().getHost());
    +
    +						nodeManagerClient.startContainer(container, taskExecutorLaunchContext);
    +					}
&lt;p&gt; catch (Throwable t) {&lt;br/&gt;
    +						log.error(&quot;Could not start TaskManager in container {}.&quot;, container.getId(), t);&lt;br/&gt;
    +&lt;br/&gt;
    +						// release the failed container&lt;br/&gt;
    +						resourceManagerClient.releaseAssignedContainer(container.getId());&lt;br/&gt;
    +						// and ask for a new one&lt;br/&gt;
    +						requestYarnContainer(container.getResource(), container.getPriority());&lt;br/&gt;
    +					}&lt;br/&gt;
    +				} else {&lt;br/&gt;
    +					// return the excessive containers&lt;br/&gt;
    +					log.info(&quot;Returning excess container {}.&quot;, container.getId());&lt;br/&gt;
     					resourceManagerClient.releaseAssignedContainer(container.getId());&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;// and ask for a new one&lt;/li&gt;
	&lt;li&gt;requestYarnContainer(container.getResource(), container.getPriority());&lt;br/&gt;
     				}&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;// return the excessive containers&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Returning excess container {}.&quot;, container.getId());&lt;/li&gt;
	&lt;li&gt;resourceManagerClient.releaseAssignedContainer(container.getId());&lt;br/&gt;
     			}&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// if we are waiting for no further containers, we can go to the&lt;/li&gt;
	&lt;li&gt;// regular heartbeat interval&lt;/li&gt;
	&lt;li&gt;if (numPendingContainerRequests &amp;lt;= 0) 
{
    -			resourceManagerClient.setHeartbeatInterval(yarnHeartbeatIntervalMillis);
    -		}
&lt;p&gt;    +			// if we are waiting for no further containers, we can go to the&lt;br/&gt;
    +			// regular heartbeat interval&lt;br/&gt;
    +			if (numPendingContainerRequests &amp;lt;= 0) &lt;/p&gt;
{
    +				resourceManagerClient.setHeartbeatInterval(yarnHeartbeatIntervalMillis);
    +			}
&lt;p&gt;    +		});&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	@Override&lt;br/&gt;
     	public void onShutdownRequest() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
    -			shutDown();
    -		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    -			log.warn(&quot;Fail to shutdown the YARN resource manager.&quot;, e);
    -		}
&lt;p&gt;    +		runAsync(() -&amp;gt; {&lt;br/&gt;
    +			try {&lt;br/&gt;
    +				shutDown();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    done&lt;/p&gt;</comment>
                            <comment id="16404077" author="githubbot" created="Sun, 18 Mar 2018 17:56:28 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5675&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5675&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16404085" author="till.rohrmann" created="Sun, 18 Mar 2018 18:01:28 +0000"  >&lt;p&gt;Fixed via &lt;br/&gt;
1.6.0: 9538675caca24c83201e47bd26e4e725b2695217&lt;br/&gt;
1.5.0: eb666d8128ca5f63d735d87235959719c141fe93&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 35 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3l4fj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>