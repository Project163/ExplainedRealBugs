<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:49:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-14087] throws java.lang.ArrayIndexOutOfBoundsException  when emiting the data using RebalancePartitioner. </title>
                <link>https://issues.apache.org/jira/browse/FLINK-14087</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;There is the condition the RecordWriter sharing the ChannelSelector instance.&lt;/p&gt;

&lt;p&gt;When two RecordWriter instance shared the same ChannelSelector Instance , It may throws&#160;&lt;/p&gt;

&lt;p&gt;java.lang.ArrayIndexOutOfBoundsException .&#160; For example,&#160; two recordWriter instance shared the RebalancePartitioner instance. the RebalancePartitioner instance setup 2 number of Channels when the first RecordWriter initializing, next the some RebalancePartitioner instance setup 3 number of&#160; channels When the second RecordWriter initializing. this&#160; throws ArrayIndexOutOfBoundsException when the first RecordWriter instance emits the data.&lt;/p&gt;

&lt;p&gt;The Exception likes&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;java.lang.RuntimeException: 2 at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:112) at org.apache.flink.streaming.runtime.io.RecordWriterOutput.collect(RecordWriterOutput.java:91) at org.apache.flink.streaming.runtime.io.RecordWriterOutput.collect(RecordWriterOutput.java:47) at org.apache.flink.streaming.runtime.tasks.OperatorChain$BroadcastingOutputCollector.collect(OperatorChain.java:673) at org.apache.flink.streaming.runtime.tasks.OperatorChain$BroadcastingOutputCollector.collect(OperatorChain.java:617) at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.collect(AbstractStreamOperator.java:726) at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.collect(AbstractStreamOperator.java:699) at org.apache.flink.streaming.api.operators.StreamSourceContexts$NonTimestampContext.collect(StreamSourceContexts.java:104) at com.xx.flink.demo.wordcount.case3.StateTest$Source.run(StateTest.java:107) at org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:94) at org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:57) at org.apache.flink.streaming.runtime.tasks.SourceStreamTask.run(SourceStreamTask.java:97) at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:302) at org.apache.flink.runtime.taskmanager.Task.run(Task.java:734) at java.lang.Thread.run(Thread.java:748) Caused by: java.lang.ArrayIndexOutOfBoundsException: 2 at org.apache.flink.runtime.io.network.api.writer.RecordWriter.getBufferBuilder(RecordWriter.java:255) at org.apache.flink.runtime.io.network.api.writer.RecordWriter.copyFromSerializerToTargetChannel(RecordWriter.java:177) at org.apache.flink.runtime.io.network.api.writer.RecordWriter.emit(RecordWriter.java:162) at org.apache.flink.runtime.io.network.api.writer.RecordWriter.emit(RecordWriter.java:128) at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:109) ... 14 more&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13256830">FLINK-14087</key>
            <summary>throws java.lang.ArrayIndexOutOfBoundsException  when emiting the data using RebalancePartitioner. </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gaoyunhaii">Yun Gao</assignee>
                                    <reporter username="jiangyu">jiangyu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 16 Sep 2019 09:38:36 +0000</created>
                <updated>Fri, 4 Sep 2020 06:58:46 +0000</updated>
                            <resolved>Fri, 4 Sep 2020 03:04:39 +0000</resolved>
                                    <version>1.8.0</version>
                    <version>1.8.1</version>
                    <version>1.9.0</version>
                                    <fixVersion>1.10.3</fixVersion>
                    <fixVersion>1.11.2</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>API / DataStream</component>
                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="16930376" author="jiangyu" created="Mon, 16 Sep 2019 09:43:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16930432" author="zjwang" created="Mon, 16 Sep 2019 11:04:40 +0000"  >&lt;p&gt;Thanks for reporting this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiangyu&quot; class=&quot;user-hover&quot; rel=&quot;jiangyu&quot;&gt;jiangyu&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We actually refactored the internal logic for RebalancePartitioner before. In the past it would check whether the selected channel index is beyond the number of channels before return. If exceeds, it would return the first channel index.&lt;/p&gt;

&lt;p&gt;But it is breaking my previous assumption that multiple RecordWriter instances would share the same ChannelSelector instance. I need to double check the process of StreamGraph generation whether it would happen this case. It seems not reasonable to share the same internal state for different output edges. If so, for different parallelism in one output edge, it is not strictly rebalanced.&lt;/p&gt;

&lt;p&gt;Could you share me your topology structure or the codes you submit the job, then I could easily debug the process of generating StreamGraph.&lt;/p&gt;</comment>
                            <comment id="16930439" author="jiangyu" created="Mon, 16 Sep 2019 11:16:11 +0000"  >&lt;p&gt;hi&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;&#160;,The topology structure is as follow.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12980387/12980387_image-2019-09-16-19-15-34-639.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16931171" author="zjwang" created="Tue, 17 Sep 2019 08:17:59 +0000"  >&lt;p&gt;Thanks for the further offline confirmation with me &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiangyu&quot; class=&quot;user-hover&quot; rel=&quot;jiangyu&quot;&gt;jiangyu&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;After checking the relevant process in StreamGraph, the StreamPartitioner is actually shared for different edges via the structure of &lt;tt&gt;virtualPartitionNodes&lt;/tt&gt;. IMO this sharing mechanism is not very reasonable because of two issues:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;From semantic aspect, it is the global rebalance among different stream edges, which would cause actually imbalanced case among different parallelism of one edge. It seems more make sense to rebalance partially in one edge scope.&lt;/li&gt;
	&lt;li&gt;It would limit the runtime implementation or it assumes that there is no state maintaince in runtime implementation. Otherwise it would bring unexpected behavior. In previous version of RebalancePartitioner, it would check whether the selected channel index is beyond the number of channels for every call, so it hides this potential issue before, no matter with whether this behavior is actually balanced or not. And the latest refactoring work removes this check and makes the number of channels as the property of partitioner, then it exposes this bug.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Considering the solution, I prefer to adjust the process of stream graph to build separate partitioner instance for every stream edge. Are there other suggestions or inputs &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;?&lt;/p&gt;</comment>
                            <comment id="16931212" author="pnowojski" created="Tue, 17 Sep 2019 09:04:30 +0000"  >&lt;p&gt;Sharing the same &lt;tt&gt;StreamPartitioner&lt;/tt&gt; instance indeed sounds like a bad idea, especially that we call &lt;tt&gt;#setup(...)&lt;/tt&gt; twice on them.&lt;/p&gt;

&lt;p&gt;However I didn&apos;t follow the code and I do not understand what was the rationale behind the current code structure. What could brake if we change the current semantic? I could think about the following thing:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;what if a partitioner has &quot;huge&quot; state? Could that be the case? I think all of the current partitioners are very light weight?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I also am not familiar with the virtual nodes concept. It looks like &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; wrote most of this code, could you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; reach out to him? &lt;/p&gt;</comment>
                            <comment id="16931227" author="zjwang" created="Tue, 17 Sep 2019 09:25:00 +0000"  >&lt;p&gt;Thanks for the replies &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;Unless there are some requirements of sharing information among different edges for special partitioner such as users&apos; CustomPartitioner, the existing implementations of StreamPartitioner seem be independent for different edges.&#160;&lt;/p&gt;

&lt;p&gt;Do you think it is feasible to generate separate partitioner instance for different edges? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16931243" author="aljoscha" created="Tue, 17 Sep 2019 09:43:00 +0000"  >&lt;p&gt;I think the partitioners should be separate for the different edges, yes. Can you pinpoint where in the code they use the same one?&lt;/p&gt;</comment>
                            <comment id="16931289" author="zjwang" created="Tue, 17 Sep 2019 10:48:15 +0000"  >&lt;p&gt;Thanks for the quick response &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;The topology from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiangyu&quot; class=&quot;user-hover&quot; rel=&quot;jiangyu&quot;&gt;jiangyu&lt;/a&gt;&#160;is like this :&lt;/p&gt;

&lt;p&gt;DataStream dataStream = env.addSource().rebalance();&lt;br/&gt;
 dataStream.map().setParallelism(2).filter();&lt;br/&gt;
 dataStream.map().setParallelism(3).sink();&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In StreamGraph#addVirtualPartitionNode, the &lt;tt&gt;RebalancePartitioner&lt;/tt&gt;&#160;is cached inside the structure of &lt;tt&gt;virtualPartitionNodes&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;And during StreamGraph#addEdgeInternal(), the same &lt;tt&gt;RebalancePartitioner&lt;/tt&gt;&#160;instance would be fetched from virtualPartitionNodes while adding different edges.&lt;/p&gt;</comment>
                            <comment id="17031354" author="gaoyunhaii" created="Thu, 6 Feb 2020 08:00:56 +0000"  >&lt;p&gt;Hi all, we have met with a similar problem online recently: uses write the code&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 a = env.addSource().rebalance();
 b = a.map()
 c = a.map() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;and the rebalance partition is then shared between the edges &lt;em&gt;a -&amp;gt; b&lt;/em&gt; and &lt;em&gt;a -&amp;gt; c&lt;/em&gt;, which causes half of tasks of &lt;em&gt;b&lt;/em&gt; and &lt;em&gt;c&lt;/em&gt; do not receive records. As a temporary fix, we asked users to use the following code instead&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
a = env.addSource();
b = a.rebalance().map();
c = a.rebalance().map()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In summary, currently when downstream operators are connected to the same rebalance() PartitionTransformation, the partitioner is shared between all the edges at runtime. Otherwise when the downstream operators are connected to different rebalance() PartitionTransformation, each edge will have its own partitioner at runtime. I think this should also be reasonable, but it seems to be a little divergence from the intuitive thought of users.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Therefore, do we still think always using distinct partitioner for each edge is better ? If so, we should copy the partitioner for each edge when creating graph. The down side of the change will still be that if users really want to share the same partitioner between the edges, he would not be able to achieve this after the change.&lt;/p&gt;</comment>
                            <comment id="17031373" author="pnowojski" created="Thu, 6 Feb 2020 08:52:49 +0000"  >&lt;p&gt;I think the partitioners should be separate for the different edges, as sharing is not very intuitive, especially the behaviour that you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; have mentioned is weird (half task not getting any records). &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; already confirmed that it shouldn&apos;t be like that, so if someone would like to fox this, I can assign this ticket to him.&lt;/p&gt;</comment>
                            <comment id="17031375" author="gaoyunhaii" created="Thu, 6 Feb 2020 08:56:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160; Got it. Very thanks for the explanation!&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;d like to have this issue fixed, and will open a PR as soon as possible.&#160;&lt;/p&gt;</comment>
                            <comment id="17190507" author="gaoyunhaii" created="Fri, 4 Sep 2020 03:04:16 +0000"  >&lt;p&gt;fix in master:&#160;d7fe9af0b6caa1c76e811240e53434969be771b1&lt;/p&gt;</comment>
                            <comment id="17190592" author="dawidwys" created="Fri, 4 Sep 2020 06:58:46 +0000"  >&lt;p&gt;Fixed in:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master
	&lt;ul&gt;
		&lt;li&gt;d7fe9af0b6caa1c76e811240e53434969be771b1&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;1.11.2
	&lt;ul&gt;
		&lt;li&gt;7ecffb4e31505b1f33289c278dc7f397c1f229d6&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;1.10.3
	&lt;ul&gt;
		&lt;li&gt;56bb246edc778a1360cfd16a4a9d6e3adc132d7b&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12980386" name="image-2019-09-16-19-14-39-403.png" size="27384" author="jiangyu" created="Mon, 16 Sep 2019 11:14:40 +0000"/>
                            <attachment id="12980387" name="image-2019-09-16-19-15-34-639.png" size="27384" author="jiangyu" created="Mon, 16 Sep 2019 11:15:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06o2w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>