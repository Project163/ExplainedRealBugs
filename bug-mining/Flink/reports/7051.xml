<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:17:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-31917] Loss of Idempotence in JsonSerDe Round Trip for AggregateCall and RexNode</title>
                <link>https://issues.apache.org/jira/browse/FLINK-31917</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;JsonSerDeTestUtil#testJsonRoundTrip only checks the equality between spec and deserialized object. Some corner cases are detected when serializing the deserialized object again.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;T&amp;gt; T testJsonRoundTrip(SerdeContext serdeContext, T spec, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; clazz)
            &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; actualJson = toJson(serdeContext, spec);
        T actual = toObject(serdeContext, actualJson, clazz);

        assertThat(actual).isEqualTo(spec);
        assertThat(actualJson).isEqualTo(toJson(serdeContext, actual)); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will eval some corner cases
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; actual;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The discovered corner cases are listed as follows.&lt;/p&gt;
&lt;h5&gt;&lt;a name=&quot;1.SerDeforAggregateCall&quot;&gt;&lt;/a&gt;1. SerDe for AggregateCall&lt;/h5&gt;

&lt;p&gt;When deserializing the aggregate call, we should check the JsonNodeType to avoid converting null to &quot;null&quot; string.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/blob/f9b3e0b7bc0432001b4a197539a0712b16e0b33b/flink-table/flink-table-planner/src/main/java/org/apache/flink/table/planner/plan/nodes/exec/serde/AggregateCallJsonDeserializer.java#L64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/f9b3e0b7bc0432001b4a197539a0712b16e0b33b/flink-table/flink-table-planner/src/main/java/org/apache/flink/table/planner/plan/nodes/exec/serde/AggregateCallJsonDeserializer.java#L64&lt;/a&gt;&lt;/p&gt;
&lt;h5&gt;&lt;a name=&quot;SuggestedFix&quot;&gt;&lt;/a&gt;Suggested Fix&lt;/h5&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
JsonNode nameNode = jsonNode.required(FIELD_NAME_NAME);
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = JsonNodeType.NULL ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : nameNode.asText();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h5&gt;&lt;a name=&quot;2.SerDeforRexNode&quot;&gt;&lt;/a&gt;2. SerDe for RexNode&lt;/h5&gt;

&lt;p&gt;RexNodeJsonSerdeTest#testSystemFunction should create the temporary system function instead of the temporary catalog function.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/blob/f9b3e0b7bc0432001b4a197539a0712b16e0b33b/flink-table/flink-table-planner/src/test/java/org/apache/flink/table/planner/plan/nodes/exec/serde/RexNodeJsonSerdeTest.java#L209&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/f9b3e0b7bc0432001b4a197539a0712b16e0b33b/flink-table/flink-table-planner/src/test/java/org/apache/flink/table/planner/plan/nodes/exec/serde/RexNodeJsonSerdeTest.java#L209&lt;/a&gt;&lt;/p&gt;
&lt;h5&gt;&lt;a name=&quot;SuggestedFix&quot;&gt;&lt;/a&gt;Suggested Fix&lt;/h5&gt;

&lt;p&gt;Use functionCatalog#registerTemporarySystemFunction to test.&lt;/p&gt;
&lt;h5&gt;&lt;a name=&quot;3.AboutRexLiteraltype&quot;&gt;&lt;/a&gt;3. About RexLiteral type&lt;/h5&gt;

&lt;p&gt;RexNodeJsonSerdeTest#testRexNodeSerde has a test spec as follows&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//This will create the literal with DOUBLE as the literal type, and DECIMAL as the broad type of &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; literal. You can refer to Calcite &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more details
&lt;/span&gt;rexBuilder.makeExactLiteral(BigDecimal.valueOf(&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.MAX_VALUE), FACTORY.createSqlType(SqlTypeName.DOUBLE))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The RexNodeJsonSerializer uses `typeName`(which is DECIMAL) as the literal&apos;s type, as a result, the rel data type is serialized as double, but the value is serialized as a string (in case lost the precision)&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/blob/f9b3e0b7bc0432001b4a197539a0712b16e0b33b/flink-table/flink-table-planner/src/main/java/org/apache/flink/table/planner/plan/nodes/exec/serde/RexNodeJsonSerializer.java#L197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/f9b3e0b7bc0432001b4a197539a0712b16e0b33b/flink-table/flink-table-planner/src/main/java/org/apache/flink/table/planner/plan/nodes/exec/serde/RexNodeJsonSerializer.java#L197&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And then, during the deserialization, according to the JSON, the deserialized literal will assign DOUBLE as the literal type and the broad type of the literal.&lt;br/&gt;
This will cause the comparison failure&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
expected: {&lt;span class=&quot;code-quote&quot;&gt;&quot;kind&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;LITERAL&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1.7976931348623157E+308&quot;&lt;/span&gt;}
actual: {&lt;span class=&quot;code-quote&quot;&gt;&quot;kind&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;LITERAL&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;: 1.7976931348623157E+308}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h5&gt;&lt;a name=&quot;SuggestedFix&quot;&gt;&lt;/a&gt;Suggested Fix&lt;/h5&gt;

&lt;p&gt;SARG is a special case and can be coped first, and for the rest type, we can use literal.getType().getSqlTypeName() instead of literal.getTypeName().&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// first cope with SARG type
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (literal.getTypeName() == SARG) {
    serializeSargValue(
        (Sarg&amp;lt;?&amp;gt;) value, literal.getType().getSqlTypeName(), gen, serializerProvider);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    serializeLiteralValue(
        value,
        literal.getType().getSqlTypeName(),
        gen,
        serializerProvider);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13533800">FLINK-31917</key>
            <summary>Loss of Idempotence in JsonSerDe Round Trip for AggregateCall and RexNode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="qingyue">Jane Chan</assignee>
                                    <reporter username="qingyue">Jane Chan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 24 Apr 2023 08:37:28 +0000</created>
                <updated>Tue, 16 May 2023 16:31:12 +0000</updated>
                            <resolved>Tue, 16 May 2023 16:31:12 +0000</resolved>
                                    <version>1.18.0</version>
                                    <fixVersion>1.18.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17715711" author="godfrey" created="Mon, 24 Apr 2023 10:46:03 +0000"  >&lt;p&gt;good catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qingyue&quot; class=&quot;user-hover&quot; rel=&quot;qingyue&quot;&gt;qingyue&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17719123" author="fsk119" created="Thu, 4 May 2023 02:28:43 +0000"  >&lt;p&gt;Merged into master: 333e023196d90d265c286632f8c01c41b8911ef8&lt;/p&gt;</comment>
                            <comment id="17723188" author="qingyue" created="Tue, 16 May 2023 16:31:12 +0000"  >&lt;p&gt;Merged into master: 333e023196d90d265c286632f8c01c41b8911ef8&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13415855">FLINK-25217</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                                                <inwardlinks description="Discovered while testing">
                                        <issuelink>
            <issuekey id="13532429">FLINK-31791</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1hhjc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>