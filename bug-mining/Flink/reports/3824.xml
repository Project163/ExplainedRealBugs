<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:44:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-16373] EmbeddedLeaderService: IllegalStateException: The RPC connection is already closed</title>
                <link>https://issues.apache.org/jira/browse/FLINK-16373</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In our CI system, I see a lot of these error messages:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
09:52:41,108 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-2] INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor            - Allocated slot &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; fd36e49b9105838fc7fb8fff442ade28.
09:52:41,108 [mini-cluster-io-thread-14] WARN  org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService  - Error notifying leader listener about &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; leader
java.lang.IllegalStateException: The RPC connection is already closed
	at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195)
	at org.apache.flink.runtime.registration.RegisteredRpcConnection.start(RegisteredRpcConnection.java:90)
	at org.apache.flink.runtime.taskexecutor.JobLeaderService$JobManagerLeaderListener.notifyLeaderAddress(JobLeaderService.java:334)
	at org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService$NotifyOfLeaderCall.run(EmbeddedLeaderService.java:515)
	at java.util.concurrent.CompletableFuture$AsyncRun.run(CompletableFuture.java:1640)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
09:52:41,109 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-4] INFO  org.apache.flink.runtime.taskexecutor.JobLeaderService        - Resolved JobManager address, beginning registration
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Example cases &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://transfer.sh/BAzbF/20200302.17.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://transfer.sh/BAzbF/20200302.17.tar.gz&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://transfer.sh/8344E/20200302.19.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://transfer.sh/8344E/20200302.19.tar.gz&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13288830">FLINK-16373</key>
            <summary>EmbeddedLeaderService: IllegalStateException: The RPC connection is already closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 2 Mar 2020 10:36:01 +0000</created>
                <updated>Thu, 2 Apr 2020 09:01:24 +0000</updated>
                            <resolved>Thu, 2 Apr 2020 09:01:24 +0000</resolved>
                                    <version>1.11.0</version>
                                    <fixVersion>1.9.3</fixVersion>
                    <fixVersion>1.10.1</fixVersion>
                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17049347" author="zentol" created="Mon, 2 Mar 2020 15:57:52 +0000"  >&lt;p&gt;Please list which tests have failed.&lt;/p&gt;</comment>
                            <comment id="17049426" author="rmetzger" created="Mon, 2 Mar 2020 17:00:04 +0000"  >&lt;p&gt;No tests have failed. But I wonder if this error message indicates a problem that we should address.&lt;/p&gt;

&lt;p&gt;Some logs had over 100 instances of these messages&lt;/p&gt;</comment>
                            <comment id="17050215" author="zentol" created="Tue, 3 Mar 2020 13:41:55 +0000"  >&lt;p&gt;Let&apos;s rephrase my request: Please list during which test runs this was printed.&lt;/p&gt;</comment>
                            <comment id="17050267" author="rmetzger" created="Tue, 3 Mar 2020 14:46:01 +0000"  >&lt;p&gt;Looks I&apos;ve been making a false statement: This log:&#160;&lt;a href=&quot;https://transfer.sh/8344E/20200302.19.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://transfer.sh/8344E/20200302.19.tar.gz&lt;/a&gt;&#160;is from this build:&#160;&lt;a href=&quot;https://dev.azure.com/rmetzger/Flink/_build/results?buildId=5807&amp;amp;view=logs&amp;amp;j=41cba0bb-1271-5adb-01cc-4768f26a8311&amp;amp;t=97bfbae5-9730-50fb-c7f7-7ec78a126729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/rmetzger/Flink/_build/results?buildId=5807&amp;amp;view=logs&amp;amp;j=41cba0bb-1271-5adb-01cc-4768f26a8311&amp;amp;t=97bfbae5-9730-50fb-c7f7-7ec78a126729&lt;/a&gt;... which has failed&lt;/p&gt;</comment>
                            <comment id="17050269" author="rmetzger" created="Tue, 3 Mar 2020 14:47:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://transfer.sh/BAzbF/20200302.17.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://transfer.sh/BAzbF/20200302.17.tar.gz&lt;/a&gt;&#160;+&#160;&lt;a href=&quot;https://dev.azure.com/rmetzger/Flink/_build/results?buildId=5805&amp;amp;view=logs&amp;amp;j=636f54dd-dda5-5b4b-f495-2d92ec493b6c&amp;amp;t=6c30efdf-a92a-5da3-9a6a-004c8552b2df&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/rmetzger/Flink/_build/results?buildId=5805&amp;amp;view=logs&amp;amp;j=636f54dd-dda5-5b4b-f495-2d92ec493b6c&amp;amp;t=6c30efdf-a92a-5da3-9a6a-004c8552b2df&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;... and this one is successful&lt;/p&gt;</comment>
                            <comment id="17050297" author="zentol" created="Tue, 3 Mar 2020 15:10:53 +0000"  >&lt;p&gt;Transfer.sh files are no longer available.&lt;/p&gt;

&lt;p&gt;It is exactly because of this limited availability that we usually write detailed information into the JIRA instead of linking to the artifacts. As of right no one could take targeted approach to this issue, except you in case you still have the artifacts locally.&lt;/p&gt;</comment>
                            <comment id="17050302" author="rmetzger" created="Tue, 3 Mar 2020 15:21:03 +0000"  >&lt;p&gt;I just uploaded the artifacts to the ticket.&lt;/p&gt;</comment>
                            <comment id="17050405" author="zentol" created="Tue, 3 Mar 2020 17:17:18 +0000"  >&lt;p&gt;What happens is that multiple slots are requested in quick succession, causing multiple calls to &lt;tt&gt;JobLeaderService#addJob&lt;/tt&gt; in &lt;tt&gt;TaskExecutor#requestSlot&lt;/tt&gt; for the same job ID.&lt;br/&gt;
This results in prior &lt;tt&gt;RegisteredRpcConnections&lt;/tt&gt; being closed, which lead to the exception once the JM responds to said request.&lt;/p&gt;

&lt;p&gt;One solution would be to guard the job addition with a simple check:&lt;br/&gt;
&lt;tt&gt;code:java&lt;/tt&gt;&lt;br/&gt;
// a previous slot request may have kicked off the connection establishment&lt;br/&gt;
if (!jobLeaderService.containsJob(jobId)) &lt;/p&gt;
{
	jobLeaderService.addJob(jobId, targetAddress);
}
&lt;p&gt;&lt;tt&gt;code&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; WDYT?&lt;/p&gt;</comment>
                            <comment id="17051323" author="till.rohrmann" created="Wed, 4 Mar 2020 15:29:45 +0000"  >&lt;p&gt;I don&apos;t think that this is the solution since every new slot request could update the target address of a changing &lt;tt&gt;JobMaster&lt;/tt&gt;. Instead, the problem seems to be that we are executing the &lt;tt&gt;EmbeddedLeaderService#NotifyOfLeaderCall&lt;/tt&gt; even though the respective leader retrieval service has been closed.&lt;/p&gt;</comment>
                            <comment id="17051360" author="till.rohrmann" created="Wed, 4 Mar 2020 16:02:23 +0000"  >&lt;p&gt;I think the underlying problem is that &lt;tt&gt;JobManagerLeaderListener&lt;/tt&gt; is not thread safe.&lt;/p&gt;</comment>
                            <comment id="17061843" author="till.rohrmann" created="Wed, 18 Mar 2020 15:50:27 +0000"  >&lt;p&gt;Fixed via cf7cc89ac99554dc51da5cbffc3b76fe32ef5fea&lt;/p&gt;</comment>
                            <comment id="17061846" author="rmetzger" created="Wed, 18 Mar 2020 15:52:18 +0000"  >&lt;p&gt;Thanks a lot &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="17073534" author="till.rohrmann" created="Thu, 2 Apr 2020 09:01:24 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.10.1: 15dd5fec6a8cad358ba69ab964bf6469b6868ab2&lt;br/&gt;
1.9.3: f8852e8f764ee91b0b713bb9c90f2f170096e553&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12995475" name="20200302.17.tar.gz" size="9470296" author="rmetzger" created="Tue, 3 Mar 2020 15:20:46 +0000"/>
                            <attachment id="12995474" name="20200302.19.tar.gz" size="2495078" author="rmetzger" created="Tue, 3 Mar 2020 15:20:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0c2b4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>