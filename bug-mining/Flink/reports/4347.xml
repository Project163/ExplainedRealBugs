<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:47:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18119] Fix unlimitedly growing state for time range bounded over aggregate</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18119</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;For time range bounded over aggregation in streaming query, like below,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
table
  .window(Over.partitionBy &lt;span class=&quot;code-quote&quot;&gt;&apos;a orderBy &apos;&lt;/span&gt;rowtime preceding 1.hour as &apos;w)
  .groupBy(&apos;w)
  .select(&lt;span class=&quot;code-quote&quot;&gt;&apos;a, aggregateFunction(&apos;&lt;/span&gt;b))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the operator must hold incoming records over the preceding time range in the state, but older records are no longer required and can be cleaned up.&lt;/p&gt;

&lt;p&gt;Current implementation retracts the old records only when newer records come in and so the operator knows that enough time has passed. However, the retraction never happens unless a new record with the same key comes in and this causes a state that perhaps will never be released, which leads to an unlimitedly growing state especially when the keyspace mutates over time.&lt;/p&gt;

&lt;p&gt;Since aggregate over bounded preceding time interval doesn&apos;t require old records by its nature, we can improve this by adding a timer that notifies the operator to retract old records, resulting in no changes in query result or severe performance degrade.&lt;/p&gt;

&lt;p&gt;This is a distinct feature from state retention: state retention is to forget some states that are expected to be less important to reduce state memory, so it possibly changes query results. Enabling and disabling state retention both make sense with this change.&lt;/p&gt;

&lt;p&gt;This issue applies to both row time range bound and proc time range bound. That is, we are going to have changes in both RowTimeRangeBoundedPrecedingFunction and ProcTimeRangeBoundedPrecedingFunction in flink-table-runtime-blink. I already have a running-in-production version with this change and would be glad to contribute.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13309391">FLINK-18119</key>
            <summary>Fix unlimitedly growing state for time range bounded over aggregate</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hyeonseop">Hyeonseop Lee</assignee>
                                    <reporter username="hyeonseop">Hyeonseop Lee</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 4 Jun 2020 08:31:25 +0000</created>
                <updated>Sat, 20 Jun 2020 01:55:22 +0000</updated>
                            <resolved>Sat, 20 Jun 2020 01:55:22 +0000</resolved>
                                    <version>1.10.1</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17136348" author="libenchao" created="Tue, 16 Jun 2020 06:25:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyeonseop&quot; class=&quot;user-hover&quot; rel=&quot;hyeonseop&quot;&gt;hyeonseop&lt;/a&gt;&#160;Which planner are you using? I&apos;ve checked &lt;tt&gt;RowTimeRangeUnboundedPrecedingFunction&lt;/tt&gt; in blink planner in 1.11, it&apos;s implemented using processing timers. Hence it does not have the problems you described.&lt;/p&gt;</comment>
                            <comment id="17136362" author="hyeonseop" created="Tue, 16 Jun 2020 06:48:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=libenchao&quot; class=&quot;user-hover&quot; rel=&quot;libenchao&quot;&gt;libenchao&lt;/a&gt; &lt;tt&gt;RowTimeRange*Unbounded*PrecedingFunction&lt;/tt&gt; is not the case. &lt;tt&gt;RowTimeRange*Bounded*PrecedingFunction&lt;/tt&gt; in blink runtime 1.11 still has the issue.&lt;/p&gt;

&lt;p&gt;It performs cleanup using processing timer when proper &lt;tt&gt;minRetentionTime&lt;/tt&gt; and &lt;tt&gt;maxRetentionTime&lt;/tt&gt; are configured, but what I want to improve is to retract records that is no longer required even when the state retention is not set (indefinite).&lt;/p&gt;

&lt;p&gt;In my case, I first tried to set non-zero &lt;tt&gt;minRetentionTime&lt;/tt&gt;&#160;to enable cleanup by retention, but that was applied to whole query and ended up with the retract stream instead of append stream. I understand setting state retention can be a walkaround to prevent OOM but I think functions must keep state as efficiently as possible.&lt;/p&gt;</comment>
                            <comment id="17136386" author="libenchao" created="Tue, 16 Jun 2020 07:23:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyeonseop&quot; class=&quot;user-hover&quot; rel=&quot;hyeonseop&quot;&gt;hyeonseop&lt;/a&gt;&#160;I got your point, nice catch, IMO this is a bug. Assigned to you.&lt;/p&gt;</comment>
                            <comment id="17136389" author="hyeonseop" created="Tue, 16 Jun 2020 07:28:12 +0000"  >&lt;p&gt;Thank you! Will submit PR.&lt;/p&gt;</comment>
                            <comment id="17140290" author="jark" created="Fri, 19 Jun 2020 07:23:50 +0000"  >&lt;p&gt;As discussed in the pull request, we changed the State ttl behavior for &lt;tt&gt;ProcTimeRangeBoundedPrecedingFunction&lt;/tt&gt; and &lt;tt&gt;RowTimeRowsBoundedPrecedingFunction&lt;/tt&gt;. They expire state automantically when no more data coming in in the bounded window (event/processing) time range, instead of expire depends on the &lt;tt&gt;TableConfig.setIdleStateRetentionTime&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="17140919" author="jark" created="Sat, 20 Jun 2020 01:55:22 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;master (1.12.0): 22abfe2461cf9814268f1e37e62349bc223c4a0b&lt;/li&gt;
	&lt;li&gt;1.11.0: 2cfaff87427e34e93160c56bb85b1fd8e68fb964&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 21 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fi08:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>