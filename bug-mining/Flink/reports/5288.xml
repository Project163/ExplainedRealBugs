<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:55:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-21996] Transient RPC failure without TaskManager failure can lead to split assignment loss</title>
                <link>https://issues.apache.org/jira/browse/FLINK-21996</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;NOTE: This bug has not been actually observed. It is based on reviews of the current implementation.&lt;br/&gt;
I would expect it to be a pretty rare case, bu at scale, even the rare cases happen often enough.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Problem&quot;&gt;&lt;/a&gt;Problem&lt;/h2&gt;

&lt;p&gt;Intermediate RPC messages from JM to TM can get dropped, even when the TM is not marked as failed.&lt;br/&gt;
That can happen when the connection can be recovered before the heartbeat times out.&lt;/p&gt;

&lt;p&gt;So RPCs generally retry, or handle failures: For example Deploy-Task-RPC retries, Trigger-Checkpoint RPC aborts the checkpoint on failure and triggers a new checkpoint.&lt;/p&gt;

&lt;p&gt;The &quot;Send OperatorEvent&quot; RPC call (from Coordinator to Operator) gives you a Future with the acknowledgement. But if that one fails, we are in the situation where we do not know whether the event sending was successful or not (only the ack failed).&lt;/p&gt;

&lt;p&gt;This is especially tricky for split assignments and checkpoints. Consider this sequence of actions:&lt;br/&gt;
  1. Coordinator assigns a split. Ack not yet received.&lt;br/&gt;
  2. Coordinator takes a checkpoint. Split was sent before the checkpoint, so is not included on the Coordinator.&lt;br/&gt;
  3. Split assignment RPC response is &quot;failed&quot;.&lt;br/&gt;
  4. Checkpoint completes.&lt;/p&gt;

&lt;p&gt;Now we don&apos;t know whether the split was in the checkpoint on the Operator (TaskManager) or not, and with that we don&apos;t know whether we should add it back to the coordinator. We need to do something to make sure the split is now either on the coordinator or on the Operator. Currently, the split is implicitly assumed to be on the Operator; if it isn&apos;t, then that split is lost.&lt;/p&gt;

&lt;p&gt;Not, it is worth pointing out that this is a pretty rare situation, because it means that the RPC with the split assignment fails and the one for the checkpoint succeeds, even though they are in close proximity. The way the Akka-based RPC transport works (with retries, etc.), this can happen, but isn&apos;t very likely. That why we haven&apos;t so far seen this bug in practice or haven&apos;t gotten a report for it, yet.&lt;/p&gt;


&lt;h2&gt;&lt;a name=&quot;Proposedsolution&quot;&gt;&lt;/a&gt;Proposed solution&lt;/h2&gt;

&lt;p&gt;The solution has two components:&lt;/p&gt;

&lt;p&gt;  1. Fallback to consistent point: If the system doesn&apos;t know whether two parts are still consistent with each other (here coordinator and Operator), fall back to a consistent point. Here that is the case when the Ack-Future for the &quot;Send Operator Event&quot; RPC fails or times out. Then we call the scheduler to trigger a failover of the target operator to latest checkpoint and signaling the coordinator the same. That restores consistency. We can later optimize this (see below).&lt;/p&gt;

&lt;p&gt;  2. We cannot trigger checkpoints while we are &quot;in limbo&quot; concerning our knowledge about splits. Concretely that means that the Coordinator can only acknowledge the checkpoint once the Acks for pending Operator Event RPCs (Assign-Splits) have arrived. The checkpoint future is conditional on all pending RPC futures. If the RPC futures fail (or time out) then the checkpoint cannot complete (and the target operator will anyways go through a failover). In the common case, RPC round trip time is milliseconds, which would be added to the checkpoint latency if the checkpoint happends to overlap with a split assignment (most won&apos;t).&lt;/p&gt;


&lt;h2&gt;&lt;a name=&quot;PossibleFutureImprovements&quot;&gt;&lt;/a&gt;Possible Future Improvements&lt;/h2&gt;

&lt;p&gt;Step (1) above can be optimized by going with retries first and sequence numbers to deduplicate the calls. That can help reduce the number of cases were a failover is needed. However, the number of situations where the RPC would need a retry and has a chance of succeeding (the TM is not down) should be very few to begin with, so whether this optimization is worth it remains to be seen.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13367996">FLINK-21996</key>
            <summary>Transient RPC failure without TaskManager failure can lead to split assignment loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 26 Mar 2021 20:06:05 +0000</created>
                <updated>Fri, 4 Aug 2023 09:15:33 +0000</updated>
                            <resolved>Wed, 21 Apr 2021 14:36:07 +0000</resolved>
                                    <version>1.12.2</version>
                                    <fixVersion>1.13.0</fixVersion>
                    <fixVersion>1.12.3</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>14</watches>
                                                                                                                <comments>
                            <comment id="17309697" author="stephanewen" created="Fri, 26 Mar 2021 20:07:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; What do you think of the proposed solution? &lt;br/&gt;
I have played around with the code a bit, the implementation is pretty simple. The harder part is setting up tests for this.&lt;/p&gt;</comment>
                            <comment id="17310713" author="till.rohrmann" created="Mon, 29 Mar 2021 15:01:27 +0000"  >&lt;p&gt;I think your solution proposal for the problem looks good to me. Also to exclude the optimization aspect for the time being since we don&apos;t know how much it would actually bring in the end.&lt;/p&gt;</comment>
                            <comment id="17318585" author="kezhuw" created="Sat, 10 Apr 2021 19:55:26 +0000"  >&lt;p&gt;Is there any design guarantee for no source operator coordinator in checkpointing&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;&#160;? I did not see one from docs, nor exclusion either.&lt;/p&gt;

&lt;p&gt;For no source operator coordinator, it is possible &#160;that events sending before checkpoint arrives after checkpoint in case of all good. A relative long latency between sending and arriving could make checkpoint from upstream arrives earlier than events.&#160;I constructed a &lt;a href=&quot;https://github.com/kezhuw/flink/commit/b3aeb30298ace48c8ea11be488281d6eba8930b1#diff-7007c5266035493493e3a1476d98442bf50a7f023b801b48c6b6dc15436c9499R657&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test case&lt;/a&gt; for demonstration.&lt;/p&gt;</comment>
                            <comment id="17319341" author="stephanewen" created="Mon, 12 Apr 2021 10:34:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; I think the guarantees that we need on the Task and TaskManager are that all events are delivered into the Mailbox in order. So the OperatorEvent (assignSplits) and the Checkpoint Trigger Event may not overtake each other.&lt;/p&gt;

&lt;p&gt;The TM receives them through the same RPC endpoint (TaskExecutor) so they are in order. &lt;br/&gt;
Let&apos;s double check that this order isn&apos;t messed up in the Task and StreamTask. &lt;/p&gt;</comment>
                            <comment id="17319358" author="kezhuw" created="Mon, 12 Apr 2021 10:57:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; Taking no source tasks into account, these guarantees are not enough. There is no checkpoint trigger for no source tasks. So, basically, there is no happens-before between checkpoint and operator event in no source tasks.&lt;/p&gt;</comment>
                            <comment id="17319367" author="kezhuw" created="Mon, 12 Apr 2021 11:12:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;We cannot trigger checkpoints while we are &quot;in limbo&quot; concerning our knowledge about splits. Concretely that means that the Coordinator can only acknowledge the checkpoint once the Acks for pending Operator Event RPCs (Assign-Splits) have arrived.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Extending this to no source tasks and all events should solve all cases.&lt;/p&gt;</comment>
                            <comment id="17319415" author="stephanewen" created="Mon, 12 Apr 2021 12:17:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; Yes, for operators that are not sources, there are no guarantees about the order of sent events and checkpoints. I think for now it is okay to leave it at that, because the only case where we need this for now are sources. Let&apos;s think about extending this in the future when we see cases for this.&lt;/p&gt;</comment>
                            <comment id="17324120" author="stephanewen" created="Fri, 16 Apr 2021 22:45:24 +0000"  >&lt;p&gt;Fixed in 1.13.0 via&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;de509fc2439c2cacb02c9caa40168b3765e84ceb&lt;/li&gt;
	&lt;li&gt;904536271081f393a8c29341831275080b04255a&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17325741" author="stephanewen" created="Tue, 20 Apr 2021 12:11:24 +0000"  >&lt;p&gt;Fixed in 1.12.3 via&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;da48ac8b0f2b01b6048993cd2d1f8d267fffc0ae&lt;/li&gt;
	&lt;li&gt;19b5a1b234aad91e9747c85e1cabcffc1de0817e&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17326423" author="mapohl" created="Wed, 21 Apr 2021 10:23:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;: we have a&#160;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=16923&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=03dca39c-73e8-5aaf-601d-328ae5c35f20&amp;amp;l=12543&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build failure&lt;/a&gt; in a build that includes the fixes of this issue. Shall we reopen this issue? The changes introduced in the corresponding branch&#160;aren&apos;t related as it contains a basic fix casting int to long affecting only the network memory metrics (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22385&quot; title=&quot;Type mismatch in NetworkBufferPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22385&quot;&gt;&lt;del&gt;FLINK-22385&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="17326449" author="stephanewen" created="Wed, 21 Apr 2021 11:43:00 +0000"  >&lt;p&gt;I see. The issue here is that an ask timeout on the split assignment now leads to a failover, and some test setups do not allow any failovers.&lt;/p&gt;

&lt;p&gt;We could adjust those tests to allow for failovers, unless something in the tests forbids this.&lt;/p&gt;</comment>
                            <comment id="17326549" author="mapohl" created="Wed, 21 Apr 2021 13:51:07 +0000"  >&lt;p&gt;ok, I&apos;m gonna re-open the issue to cover the test failure...&lt;/p&gt;</comment>
                            <comment id="17326565" author="till.rohrmann" created="Wed, 21 Apr 2021 14:12:18 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; fyi&lt;/p&gt;</comment>
                            <comment id="17326587" author="dawidwys" created="Wed, 21 Apr 2021 14:35:57 +0000"  >&lt;p&gt;Sorry, I should&apos;ve posted that I am aware of the issue. I actually synced offline and created &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22397&quot; title=&quot;OrcFileSystemITCase fails on Azure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22397&quot;&gt;&lt;del&gt;FLINK-22397&lt;/del&gt;&lt;/a&gt; to track the test failure. Let&apos;s keep this issue closed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="13308969">FLINK-18071</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13341721">FLINK-20254</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13369241">FLINK-22100</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13369964">FLINK-22129</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13387617">FLINK-23233</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13374435">FLINK-22417</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13374537">FLINK-22420</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13546105">FLINK-32751</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13341721">FLINK-20254</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13369964">FLINK-22129</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13373489">FLINK-22345</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13374118">FLINK-22397</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13374408">FLINK-22415</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13374537">FLINK-22420</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13369964">FLINK-22129</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 29 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0p9g8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>