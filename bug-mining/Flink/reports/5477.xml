<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:57:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-22376] SequentialChannelStateReaderImpl may recycle buffer twice</title>
                <link>https://issues.apache.org/jira/browse/FLINK-22376</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In ChannelStateChunkReader.readChunk in case of error buffer is recycled in the catch block. However, it might already have been recycled in&#160;stateHandler.recover().&lt;/p&gt;

&lt;p&gt;Using minor priority, as this only affects already failing path.&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13373865">FLINK-22376</key>
            <summary>SequentialChannelStateReaderImpl may recycle buffer twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akalashnikov">Anton Kalashnikov</assignee>
                                    <reporter username="roman">Roman Khachatryan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 20 Apr 2021 14:22:27 +0000</created>
                <updated>Thu, 23 Sep 2021 17:23:29 +0000</updated>
                            <resolved>Mon, 7 Jun 2021 09:03:34 +0000</resolved>
                                    <version>1.13.0</version>
                                    <fixVersion>1.14.0</fixVersion>
                    <fixVersion>1.13.2</fixVersion>
                                    <component>Runtime / Network</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17340762" author="akalashnikov" created="Fri, 7 May 2021 11:56:23 +0000"  >&lt;p&gt;In my opinion, the pattern of using the Buffer should be logically something like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Buffer buf = getOrCreate();
try {
 ....
 buf.retain();
 try {
 .....
 } finally {
 buf.recycle();
 }
} finally {
 buf.recycle();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;or&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Buffer buf = get();
try {
 ....
 list.add(buf.retain());
} finally {
 buf.recycle();
}

//otherThread/method
Buffer buf =list.get();
try {
 .....
 } finally {
 buf.recycle();
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In fact, in most cases, it indeed uses in such a way. But unfortunately when BufferBuilder is used this pattern is broken. For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;BufferBuilder buff = createBufferBuilder();
try{
 BufferConsumer consumer = buff.createBufferConsumer();
 try{
 } finally {
 consumer.recycle();
 }
} finally {
 buff.recycle();//error - this buffer is already recycled when consumer.recycle()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;BufferBuilder buff = createBufferBuilder();
try{
 list.add(buff.createBufferConsumer());
} finally {
 buff.recycle();
}

BufferConsumer consumer = list.get();
try{
 //error - it is impossible to use consumer because it is already recycled in buff.recycle();
 } finally {
 consumer.recycle();//error - this buffer is already recycled when buff.recycle()
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This happens because BufferBuilder writes directly to MemorySegment missing the Buffer. But the reference count is stored in the Buffer so it is impossible to recycle BufferBuilder correctly.&lt;/p&gt;

&lt;p&gt;My proposal is to change the implementation of BufferBuilder in such a way that it writes in Buffer instead of MemorySegment and during the creation of the new consumer it is just &apos;retain&apos; this buffer. So in this case the Buffer will be recycled only when all consumers and source BufferBuilder invoke the recycle.&lt;/p&gt;

&lt;p&gt;P.S. I also don&apos;t see a lot of sense having the BufferConsumer#CachedPositionMarker. So I would want to delete it.&lt;/p&gt;</comment>
                            <comment id="17340769" author="pnowojski" created="Fri, 7 May 2021 12:15:01 +0000"  >&lt;blockquote&gt;
&lt;p&gt;P.S. I also don&apos;t see a lot of sense having the BufferConsumer#CachedPositionMarker. So I would want to delete it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;AFAIK it&apos;s required for correctness. For example a race condition between two threads.&lt;br/&gt;
Thread 1:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
bufferBuilder.appendAndCommit(...);
bufferBuilder.appendAndCommit(...);
bufferBuilder.finish();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Thread2:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
bufferConsumer.build();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bufferConsumer.isFinished()) {
  bufferConsumer.close();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Without separated positions, 2nd thread can build a buffer with just the data from the first &lt;tt&gt;appendAndCommit&lt;/tt&gt; call, but &lt;tt&gt;isFinished()&lt;/tt&gt; would already return true.&lt;/p&gt;

&lt;p&gt;Secondly, it would cause more &lt;tt&gt;volatile&lt;/tt&gt; reads.&lt;/p&gt;

&lt;p&gt;About the recycling problem. I agree ideally it would be better for &lt;tt&gt;BufferBuilder&lt;/tt&gt; to do it&apos;s own reference counting. However I&apos;m not sure if that would be for free. That would have to be benchmarked carefully. So far we were maintaining an implicit invariant, that &lt;tt&gt;BufferBuilder&lt;/tt&gt; can not be accessed after closing all of the consumers. It&apos;s not very clean but it was working well. I&apos;m not sure why did we have to add &lt;tt&gt;BufferBuilder#recycle&lt;/tt&gt; method.&lt;/p&gt;</comment>
                            <comment id="17340830" author="akalashnikov" created="Fri, 7 May 2021 13:27:53 +0000"  >&lt;p&gt;Yes, I understand that it is needed for caching of isFinished. But I just tried to say that one local flag isFinished would be enough. Right now, the methods&#160;CachedPositionMarker#update and&#160;CachedPositionMarker#getCached are called always one by one so it means we never read the cached value but we need it only for isFinished.&lt;/p&gt;

&lt;p&gt;I was just confused when saw this code.&#160;In my head, I expected something like this:&lt;br/&gt;
 &#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;boolean isFinished;
int writerPosition(){
   int position = positionMarker.get();
   isFinished = PositionMarker.isFinished(position);
   return position;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Just in case, I don&apos;t have a target to remove this code, and maybe saving a couple of code lines also doesn&apos;t make sense.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;According to the original problem. of course, I don&apos;t like the idea that we just assume some guarantees(like BufferBuilder can not be accessed after closing all of the consumers). But if the direct writing to MemorySegment has better performance, I can propose pretty easy solution.&lt;br/&gt;
 BufferBuilder:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public void recycle() {
        if(!bufferConsumerCreated)
            recycler.recycle(memorySegment);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Pattern of usage:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;BufferBuilder builder = getOrCreateBuilder();
try{
} catch(Exception ex) {
 builder.recycle();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this case, if BufferBuilder has the consumers already, then these consumers responsible for recycling but if BufferBuilder doesn&apos;t have the consumers yet and something bad happens, then BufferBuilder recycles the buffer by itself.&lt;/p&gt;</comment>
                            <comment id="17358455" author="pnowojski" created="Mon, 7 Jun 2021 09:03:34 +0000"  >&lt;p&gt;Merged to master as 39746870694..2293362f0a1&lt;br/&gt;
Merged to release-1.13 as 8511ecbc33e..6a2f80605b1&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13394645">FLINK-23724</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 23 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0q8y8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>