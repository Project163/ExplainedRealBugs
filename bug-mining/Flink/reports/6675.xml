<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:14:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-28569] SinkUpsertMaterializer should be aware of the input upsertKey if it is not empty otherwise wrong result maybe produced</title>
                <link>https://issues.apache.org/jira/browse/FLINK-28569</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently SinkUpsertMaterializer only update row by comparing the complete row in anycase, but this may cause wrong result if input has upsertKey and also non-deterministic column values, see such a case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testCdcWithNonDeterministicFuncSinkWithDifferentPk() {
tEnv.createTemporaryFunction(
&lt;span class=&quot;code-quote&quot;&gt;&quot;ndFunc&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JavaUserDefinedScalarFunctions.NonDeterministicUdf());

&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; cdcDdl =
&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE users (\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; user_id STRING,\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; user_name STRING,\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; email STRING,\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; balance DECIMAL(18,2),\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; primary key (user_id) not enforced\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot;) WITH (\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; &lt;span class=&quot;code-quote&quot;&gt;&apos;connector&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;values&apos;&lt;/span&gt;,\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; &lt;span class=&quot;code-quote&quot;&gt;&apos;changelog-mode&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;I,UA,UB,D&apos;&lt;/span&gt;\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot;)&quot;&lt;/span&gt;;

&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; sinkTableDdl =
&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE sink (\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; user_id STRING,\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; user_name STRING,\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; email STRING,\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; balance DECIMAL(18,2),\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; PRIMARY KEY(email) NOT ENFORCED\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot;) WITH(\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; &lt;span class=&quot;code-quote&quot;&gt;&apos;connector&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;values&apos;&lt;/span&gt;,\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot; &lt;span class=&quot;code-quote&quot;&gt;&apos;sink-insert-only&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&apos;&lt;/span&gt;\n&quot;&lt;/span&gt;
+ &lt;span class=&quot;code-quote&quot;&gt;&quot;)&quot;&lt;/span&gt;;
tEnv.executeSql(cdcDdl);
tEnv.executeSql(sinkTableDdl);

util.verifyJsonPlan(
&lt;span class=&quot;code-quote&quot;&gt;&quot;insert into sink select user_id, ndFunc(user_name), email, balance from users&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;for original cdc source records:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+I[user1, Tom, tom@gmail.com, 10.02],
-D[user1, Tom, tom@gmail.com, 10.02],
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the above query cannot correctly delete the former insertion row because of the non-deterministic column value &apos;ndFunc(user_name)&apos;&lt;/p&gt;

&lt;p&gt;this canbe solved by letting the SinkUpsertMaterializer be aware of input upsertKey and update by it&lt;/p&gt;

</description>
                <environment></environment>
        <key id="13471746">FLINK-28569</key>
            <summary>SinkUpsertMaterializer should be aware of the input upsertKey if it is not empty otherwise wrong result maybe produced</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lincoln.86xy">lincoln lee</assignee>
                                    <reporter username="lincoln.86xy">lincoln lee</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 15 Jul 2022 09:45:26 +0000</created>
                <updated>Tue, 11 Oct 2022 13:17:18 +0000</updated>
                            <resolved>Thu, 15 Sep 2022 10:50:22 +0000</resolved>
                                    <version>1.14.5</version>
                    <version>1.15.2</version>
                                    <fixVersion>1.16.0</fixVersion>
                    <fixVersion>1.17.0</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17605260" author="godfreyhe" created="Thu, 15 Sep 2022 10:50:22 +0000"  >&lt;p&gt;Fixed in master: dbcd2d7b86fcb7fa7a26e181f1719ea4c6dad828&lt;br/&gt;
in 1.16.0: 390612320fa9be297d9eed1f4b75f8ba2ec83c40&lt;/p&gt;</comment>
                            <comment id="17612149" author="qinjunjerry" created="Sun, 2 Oct 2022 19:59:17 +0000"  >&lt;p&gt;Can we backport this fix into 1.14 and 1.15? &lt;/p&gt;</comment>
                            <comment id="17614484" author="lincoln.86xy" created="Sat, 8 Oct 2022 12:57:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=godfreyhe&quot; class=&quot;user-hover&quot; rel=&quot;godfreyhe&quot;&gt;godfreyhe&lt;/a&gt; I think it&apos;s valueable to port this fix to older versions(those users who encountered such case will get wrong result), this patch does not break the compatibility in some way (jobs can restore from previous state though new behavior changes), what do you think?&lt;/p&gt;</comment>
                            <comment id="17615681" author="terry1897" created="Tue, 11 Oct 2022 10:45:53 +0000"  >&lt;p&gt;+1 to backport this fix into 1.14 and 1.15&lt;/p&gt;</comment>
                            <comment id="17615706" author="terry1897" created="Tue, 11 Oct 2022 11:26:44 +0000"  >&lt;p&gt;But for the query which don&apos;t have upsert key and with non-deterministic values, the potential wrong result seems can not be avoid?&lt;br/&gt;
Should we disable such plan or give a warning during plan generation?&lt;/p&gt;</comment>
                            <comment id="17615780" author="lincoln.86xy" created="Tue, 11 Oct 2022 13:16:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Terry1897&quot; class=&quot;user-hover&quot; rel=&quot;Terry1897&quot;&gt;Terry1897&lt;/a&gt; in 1.16, we introduced a &lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/concepts/determinism/#33-how-to-eliminate-the-impact-of-non-deterministic-update-in-streaming&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;new mechanism&lt;/a&gt; to do such validation, the case you mentioned which has no upsertKey but with changes will get an error message if set &#8217;table.optimizer.non-deterministic-update.strategy&#8217; to `TRY_RESOLVE`.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z16w34:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>