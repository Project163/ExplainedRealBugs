<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18988] Continuous query with LATERAL and LIMIT produces wrong result</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18988</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I was trying out the example queries provided in this blog post: &lt;a href=&quot;https://materialize.io/lateral-joins-and-demand-driven-queries/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://materialize.io/lateral-joins-and-demand-driven-queries/&lt;/a&gt; to check if Flink supports the same and found that the queries were translated and executed but produced the wrong result.&lt;/p&gt;

&lt;p&gt;I used the SQL Client and Kafka (running at kafka:9092) to store the table data. I executed the following statements:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-- create cities table
CREATE TABLE cities (
  name STRING NOT NULL,
  state STRING NOT NULL,
  pop INT NOT NULL
) WITH (
  &lt;span class=&quot;code-quote&quot;&gt;&apos;connector&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;kafka&apos;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&apos;topic&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;cities&apos;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&apos;properties.bootstrap.servers&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;kafka:9092&apos;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&apos;properties.group.id&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;mygroup&apos;&lt;/span&gt;, 
  &lt;span class=&quot;code-quote&quot;&gt;&apos;scan.startup.mode&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;earliest-offset&apos;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&apos;format&apos;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;json&apos;&lt;/span&gt;
);

-- fill cities table
INSERT INTO cities VALUES
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;Los_Angeles&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;CA&apos;&lt;/span&gt;, 3979576),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;Phoenix&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;AZ&apos;&lt;/span&gt;, 1680992),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;Houston&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;TX&apos;&lt;/span&gt;, 2320268),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;San_Diego&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;CA&apos;&lt;/span&gt;, 1423851),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;San_Francisco&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;CA&apos;&lt;/span&gt;, 881549),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;New_York&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;NY&apos;&lt;/span&gt;, 8336817),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;Dallas&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;TX&apos;&lt;/span&gt;, 1343573),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;San_Antonio&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;TX&apos;&lt;/span&gt;, 1547253),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;San_Jose&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;CA&apos;&lt;/span&gt;, 1021795),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;Chicago&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;IL&apos;&lt;/span&gt;, 2695598),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;Austin&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;TX&apos;&lt;/span&gt;, 978908);

-- execute query
SELECT state, name 
FROM
  (SELECT DISTINCT state FROM cities) states,
  LATERAL (
    SELECT name, pop
    FROM cities
    WHERE state = states.state
    ORDER BY pop
    DESC LIMIT 3
  );

-- result
state                      name
   CA               Los_Angeles
   NY                  New_York
   IL                   Chicago

-- expected result
state | name
------+-------------
TX&#160;&#160;&#160; | Dallas
AZ&#160;&#160;&#160; | Phoenix
IL&#160;&#160;&#160; | Chicago
TX&#160;&#160;&#160; | Houston
CA&#160;&#160;&#160; | San_Jose
NY&#160;&#160;&#160; | New_York
CA&#160;&#160;&#160; | San_Diego
CA&#160;&#160;&#160; | Los_Angeles
TX&#160;&#160;&#160; | San_Antonio

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As you can see from the query result, Flink computes the top3 cities over all states, not for every state individually. Hence, I assume that this is a bug in the query optimizer or one of the rewriting rules.&lt;/p&gt;

&lt;p&gt;There are two valid ways to solve this issue:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Fixing the rewriting rules / optimizer (obviously preferred)&lt;/li&gt;
	&lt;li&gt;Disabling this feature and throwing an exception&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13323375">FLINK-18988</key>
            <summary>Continuous query with LATERAL and LIMIT produces wrong result</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="danny0405">Danny Chen</assignee>
                                    <reporter username="fhueske">Fabian Hueske</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 18 Aug 2020 15:00:21 +0000</created>
                <updated>Tue, 24 Nov 2020 14:16:36 +0000</updated>
                            <resolved>Tue, 24 Nov 2020 14:06:47 +0000</resolved>
                                    <version>1.11.1</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17180207" author="danny0405" created="Wed, 19 Aug 2020 01:58:55 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhueske&quot; class=&quot;user-hover&quot; rel=&quot;fhueske&quot;&gt;fhueske&lt;/a&gt;, i would like to take this issue ~ I guess you use the Blink planner right ?&lt;/p&gt;</comment>
                            <comment id="17180223" author="jark" created="Wed, 19 Aug 2020 02:38:03 +0000"  >&lt;p&gt;We can translate this pattern into StreamExecRank which is already there. I guess Materialize does in the similar way. &lt;/p&gt;</comment>
                            <comment id="17180224" author="jark" created="Wed, 19 Aug 2020 02:38:34 +0000"  >&lt;p&gt;Assigned to you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17180331" author="fhueske" created="Wed, 19 Aug 2020 07:30:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt; Yes, I used the Blink planner for this. Thanks for picking up this issue!&lt;/p&gt;</comment>
                            <comment id="17205314" author="knaufk" created="Thu, 1 Oct 2020 07:10:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt; Thank you for working on this issue. Are you also planning to fix this for Flink 1.11 or only master?&lt;/p&gt;</comment>
                            <comment id="17233552" author="danny0405" created="Tue, 17 Nov 2020 12:34:45 +0000"  >&lt;p&gt;Sorry for the delay reply, i will fix both master and 1.11.&lt;/p&gt;</comment>
                            <comment id="17238150" author="twalthr" created="Tue, 24 Nov 2020 14:06:47 +0000"  >&lt;p&gt;Fixed in 1.12.0: a3320d10d8e4bd19131f9eb8da72a3d97fd6876d&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knaufk&quot; class=&quot;user-hover&quot; rel=&quot;knaufk&quot;&gt;knaufk&lt;/a&gt; The implementation also introduce an additional planner phase. I would rather not add this to a minor release in 1.11 but only to 1.12. What do you think?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13342377">FLINK-20323</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hvw0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>