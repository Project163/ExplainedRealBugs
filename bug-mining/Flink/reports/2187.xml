<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5659] FileBaseUtils#deleteFileOrDirectory not thread-safe on Windows</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5659</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;FileBaseUtils#deleteFileOrDirectory&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; is not thread-safe on Windows.&lt;/p&gt;

&lt;p&gt;First you will run into AccessDeniedExceptions since one thread tried to delete a file while another thread was already doing that, for which the file has to be opened.&lt;/p&gt;

&lt;p&gt;Once you resolve those exceptions (by catching them double checking whether the file still exists), you run into DirectoryNotEmptyExceptions since there is some wacky timing/visibility issue when deleting files concurrently.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13038140">FLINK-5659</key>
            <summary>FileBaseUtils#deleteFileOrDirectory not thread-safe on Windows</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="chesnay">Chesnay Schepler</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Jan 2017 14:45:53 +0000</created>
                <updated>Tue, 13 Apr 2021 20:40:27 +0000</updated>
                            <resolved>Tue, 30 Jan 2018 14:56:46 +0000</resolved>
                                    <version>1.2.0</version>
                    <version>1.3.0</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15839808" author="githubbot" created="Thu, 26 Jan 2017 15:01:35 +0000"  >&lt;p&gt;GitHub user zentol opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5659&quot; title=&quot;FileBaseUtils#deleteFileOrDirectory not thread-safe on Windows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5659&quot;&gt;&lt;del&gt;FLINK-5659&lt;/del&gt;&lt;/a&gt; Harden FileBaseUtils#deleteFileOrDirectory on WIndows&lt;/p&gt;

&lt;p&gt;    This PR hardens `FileBaseUtils#deleteFileOrDirectory` when the method is called concurrently on Windows.&lt;/p&gt;

&lt;p&gt;    `AccessDeniedException`s can be thrown when attempting to delete a file while a deletion is in progress. In order to delete a file it has to be opened, and as we all know you can&apos;t (easily) delete open files on Windows.&lt;br/&gt;
    For this case we catch the exception, double-check whether the file is deleted by now, and throw the exception if it isn&apos;t, assuming a lack of permission prevented the deletion.&lt;/p&gt;

&lt;p&gt;    `DirectoryNotEmptyException`s can be thrown for directories for which a delete call for every file has succeeded, since the OS may be slow in updating the actual FileSystem.&lt;br/&gt;
    For this case we wait for a bit (50 milliseconds, yeah it&apos;s that slow) and check whether the directory is empty by now. If it isn&apos;t we throw the exception assuming a concurrent creation of a new file in the given directory.&lt;/p&gt;

&lt;p&gt;    Note that neither changes are perfect; they are not guaranteed to prevent the issue. However, it no longer categorically fails for me &#127881;, but only once every few hundred runs.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zentol/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/flink&lt;/a&gt; 5659_fileutils_win&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3219&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f372899c7cd8f5102421b986be1f1b87e32cf15f&lt;br/&gt;
Author: zentol &amp;lt;chesnay@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-26T14:47:11Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5659&quot; title=&quot;FileBaseUtils#deleteFileOrDirectory not thread-safe on Windows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5659&quot;&gt;&lt;del&gt;FLINK-5659&lt;/del&gt;&lt;/a&gt; Harden FileBaseUtils#deleteFileOrDirectory on WIndows&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15839839" author="githubbot" created="Thu, 26 Jan 2017 15:16:06 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Uff, okay, I see the problem. Windows FileSystem semantics are not as easy to handle as Unix.&lt;/p&gt;

&lt;p&gt;    How about we special case the method for Windows? Use `OperatingSystem.isWindows()` and in that case, do it different (like you suggested), but keep the Unix code path as it is? &lt;/p&gt;</comment>
                            <comment id="15839893" author="githubbot" created="Thu, 26 Jan 2017 15:48:07 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    That could work. Are you worried about the added sleep in case of an `DirectoryNotEmptyException`?&lt;/p&gt;
</comment>
                            <comment id="15839964" author="githubbot" created="Thu, 26 Jan 2017 16:31:47 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think the semantics for Unix currently work well, I&apos;d like to avoid the sleep there...&lt;/p&gt;</comment>
                            <comment id="15845112" author="githubbot" created="Mon, 30 Jan 2017 12:16:05 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen I&apos;ve update the PR. The `deleteDirectory()` method now has separate paths for windows and unix.&lt;/p&gt;</comment>
                            <comment id="15845420" author="githubbot" created="Mon, 30 Jan 2017 16:41:26 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219#discussion_r98477980&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219#discussion_r98477980&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/FileUtils.java &amp;#8212;&lt;br/&gt;
    @@ -116,6 +118,14 @@ else if (file.exists()) {&lt;br/&gt;
     			}&lt;br/&gt;
     			catch (NoSuchFileException e) &lt;/p&gt;
{
     				// if the file is already gone (concurrently), we don&apos;t mind
    +			}
&lt;p&gt; catch (AccessDeniedException e) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Can we special case this also for Windows? Should never occur on Unix (and should throw an exception if it happens)...&lt;/p&gt;</comment>
                            <comment id="15845421" author="githubbot" created="Mon, 30 Jan 2017 16:41:26 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219#discussion_r98482840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219#discussion_r98482840&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/FileUtils.java &amp;#8212;&lt;br/&gt;
    @@ -148,14 +158,49 @@ public static void deleteDirectory(File directory) throws IOException &lt;/p&gt;
{
     				return;
     			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// delete the directory. this fails if the directory is not empty, meaning&lt;/li&gt;
	&lt;li&gt;// if new files got concurrently created. we want to fail then.&lt;/li&gt;
	&lt;li&gt;try 
{
    -				Files.delete(directory.toPath());
    -			}&lt;/li&gt;
	&lt;li&gt;catch (NoSuchFileException ignored) {&lt;/li&gt;
	&lt;li&gt;// if someone else deleted this concurrently, we don&apos;t mind&lt;/li&gt;
	&lt;li&gt;// the result is the same for us, after all&lt;br/&gt;
    +			java.nio.file.Path directoryPath = directory.toPath();&lt;br/&gt;
    +			if (OperatingSystem.isWindows()) {&lt;br/&gt;
    +				// delete the directory. this fails if the directory is not empty, meaning&lt;br/&gt;
    +				// if new files got concurrently created. we want to fail then.&lt;br/&gt;
    +				try 
{
    +					Files.delete(directoryPath);
    +				}
&lt;p&gt; catch (NoSuchFileException ignored) &lt;/p&gt;
{
    +					// if someone else deleted this concurrently, we don&apos;t mind
    +					// the result is the same for us, after all
    +				}
&lt;p&gt; catch (AccessDeniedException e) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					// This may occur on Windows if another process is currently    +					// deleting the file, since the file must be opened in order    +					// to delete it. We double check here to make sure the file    +					// was actually deleted by another process. Note that this    +					// isn&amp;#39;t a perfect solution, but it&amp;#39;s better than nothing.    +					if (Files.exists(directoryPath)) {
    +						throw e;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (DirectoryNotEmptyException e) {&lt;br/&gt;
    +					// This may occur on Windows for some reason even for empty&lt;br/&gt;
    +					// directories. Apparently there&apos;s a timing/visibility&lt;br/&gt;
    +					// issue when concurrently deleting the contents of a directory &lt;br/&gt;
    +					// and afterwards deleting the directory itself.&lt;br/&gt;
    +					try {&lt;br/&gt;
    +						Thread.sleep(50);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I am wondering if it makes sense to have a something like 10-20 retries here, with 5ms delay.&lt;/p&gt;

&lt;p&gt;    The current implementation also does not remove the directory when initially seeing the `DirectoryNotEmptyException`, it simply suppresses the exception when the directory ends up empty 50ms later, but leaves the directory itself there.&lt;/p&gt;</comment>
                            <comment id="15845422" author="githubbot" created="Mon, 30 Jan 2017 16:41:27 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219#discussion_r98478136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219#discussion_r98478136&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/FileUtils.java &amp;#8212;&lt;br/&gt;
    @@ -148,14 +158,49 @@ public static void deleteDirectory(File directory) throws IOException &lt;/p&gt;
{
     				return;
     			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// delete the directory. this fails if the directory is not empty, meaning&lt;/li&gt;
	&lt;li&gt;// if new files got concurrently created. we want to fail then.&lt;/li&gt;
	&lt;li&gt;try 
{
    -				Files.delete(directory.toPath());
    -			}&lt;/li&gt;
	&lt;li&gt;catch (NoSuchFileException ignored) {&lt;/li&gt;
	&lt;li&gt;// if someone else deleted this concurrently, we don&apos;t mind&lt;/li&gt;
	&lt;li&gt;// the result is the same for us, after all&lt;br/&gt;
    +			java.nio.file.Path directoryPath = directory.toPath();&lt;br/&gt;
    +			if (OperatingSystem.isWindows()) {&lt;br/&gt;
    +				// delete the directory. this fails if the directory is not empty, meaning
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    How about moving this to a separate method for readability?&lt;/p&gt;</comment>
                            <comment id="15845424" author="githubbot" created="Mon, 30 Jan 2017 16:42:02 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I added a few more thoughts on how we could improve the behavior of the function.&lt;/p&gt;</comment>
                            <comment id="15845459" author="githubbot" created="Mon, 30 Jan 2017 16:56:16 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219#discussion_r98486443&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219#discussion_r98486443&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/FileUtils.java &amp;#8212;&lt;br/&gt;
    @@ -148,14 +158,49 @@ public static void deleteDirectory(File directory) throws IOException &lt;/p&gt;
{
     				return;
     			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// delete the directory. this fails if the directory is not empty, meaning&lt;/li&gt;
	&lt;li&gt;// if new files got concurrently created. we want to fail then.&lt;/li&gt;
	&lt;li&gt;try 
{
    -				Files.delete(directory.toPath());
    -			}&lt;/li&gt;
	&lt;li&gt;catch (NoSuchFileException ignored) {&lt;/li&gt;
	&lt;li&gt;// if someone else deleted this concurrently, we don&apos;t mind&lt;/li&gt;
	&lt;li&gt;// the result is the same for us, after all&lt;br/&gt;
    +			java.nio.file.Path directoryPath = directory.toPath();&lt;br/&gt;
    +			if (OperatingSystem.isWindows()) {&lt;br/&gt;
    +				// delete the directory. this fails if the directory is not empty, meaning&lt;br/&gt;
    +				// if new files got concurrently created. we want to fail then.&lt;br/&gt;
    +				try 
{
    +					Files.delete(directoryPath);
    +				}
&lt;p&gt; catch (NoSuchFileException ignored) &lt;/p&gt;
{
    +					// if someone else deleted this concurrently, we don&apos;t mind
    +					// the result is the same for us, after all
    +				}
&lt;p&gt; catch (AccessDeniedException e) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					// This may occur on Windows if another process is currently    +					// deleting the file, since the file must be opened in order    +					// to delete it. We double check here to make sure the file    +					// was actually deleted by another process. Note that this    +					// isn&amp;#39;t a perfect solution, but it&amp;#39;s better than nothing.    +					if (Files.exists(directoryPath)) {
    +						throw e;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (DirectoryNotEmptyException e) {&lt;br/&gt;
    +					// This may occur on Windows for some reason even for empty&lt;br/&gt;
    +					// directories. Apparently there&apos;s a timing/visibility&lt;br/&gt;
    +					// issue when concurrently deleting the contents of a directory &lt;br/&gt;
    +					// and afterwards deleting the directory itself.&lt;br/&gt;
    +					try {&lt;br/&gt;
    +						Thread.sleep(50);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    It is intended that the thread hitting this exception never deletes the directory. The assumption is that another thread has a correct view over the directory and will actually delete it if possible.&lt;/p&gt;

&lt;p&gt;    We however must still check whether the directory is empty after &lt;b&gt;some&lt;/b&gt; time so that we actually fail if a new file was created concurrently, to preserve existing behavior.&lt;/p&gt;</comment>
                            <comment id="15846941" author="githubbot" created="Tue, 31 Jan 2017 15:09:40 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219#discussion_r98687559&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219#discussion_r98687559&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/FileUtils.java &amp;#8212;&lt;br/&gt;
    @@ -148,14 +158,49 @@ public static void deleteDirectory(File directory) throws IOException &lt;/p&gt;
{
     				return;
     			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// delete the directory. this fails if the directory is not empty, meaning&lt;/li&gt;
	&lt;li&gt;// if new files got concurrently created. we want to fail then.&lt;/li&gt;
	&lt;li&gt;try 
{
    -				Files.delete(directory.toPath());
    -			}&lt;/li&gt;
	&lt;li&gt;catch (NoSuchFileException ignored) {&lt;/li&gt;
	&lt;li&gt;// if someone else deleted this concurrently, we don&apos;t mind&lt;/li&gt;
	&lt;li&gt;// the result is the same for us, after all&lt;br/&gt;
    +			java.nio.file.Path directoryPath = directory.toPath();&lt;br/&gt;
    +			if (OperatingSystem.isWindows()) {&lt;br/&gt;
    +				// delete the directory. this fails if the directory is not empty, meaning&lt;br/&gt;
    +				// if new files got concurrently created. we want to fail then.&lt;br/&gt;
    +				try 
{
    +					Files.delete(directoryPath);
    +				}
&lt;p&gt; catch (NoSuchFileException ignored) &lt;/p&gt;
{
    +					// if someone else deleted this concurrently, we don&apos;t mind
    +					// the result is the same for us, after all
    +				}
&lt;p&gt; catch (AccessDeniedException e) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					// This may occur on Windows if another process is currently    +					// deleting the file, since the file must be opened in order    +					// to delete it. We double check here to make sure the file    +					// was actually deleted by another process. Note that this    +					// isn&amp;#39;t a perfect solution, but it&amp;#39;s better than nothing.    +					if (Files.exists(directoryPath)) {
    +						throw e;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (DirectoryNotEmptyException e) {&lt;br/&gt;
    +					// This may occur on Windows for some reason even for empty&lt;br/&gt;
    +					// directories. Apparently there&apos;s a timing/visibility&lt;br/&gt;
    +					// issue when concurrently deleting the contents of a directory &lt;br/&gt;
    +					// and afterwards deleting the directory itself.&lt;br/&gt;
    +					try {&lt;br/&gt;
    +						Thread.sleep(50);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Then I do not understand the comment above. It reads like that can happen even if there is no other thread attempting to delete the directory?&lt;/p&gt;</comment>
                            <comment id="15853873" author="githubbot" created="Mon, 6 Feb 2017 11:41:14 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219#discussion_r99568502&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219#discussion_r99568502&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/FileUtils.java &amp;#8212;&lt;br/&gt;
    @@ -116,6 +118,14 @@ else if (file.exists()) {&lt;br/&gt;
     			}&lt;br/&gt;
     			catch (NoSuchFileException e) &lt;/p&gt;
{
     				// if the file is already gone (concurrently), we don&apos;t mind
    +			}
&lt;p&gt; catch (AccessDeniedException e) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Is it ok to special case this inside the catch block? (I.e for windows check again, otherwise rethrow?&lt;/p&gt;</comment>
                            <comment id="15853923" author="githubbot" created="Mon, 6 Feb 2017 12:40:27 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219#discussion_r99576850&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219#discussion_r99576850&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/FileUtils.java &amp;#8212;&lt;br/&gt;
    @@ -148,14 +158,49 @@ public static void deleteDirectory(File directory) throws IOException &lt;/p&gt;
{
     				return;
     			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// delete the directory. this fails if the directory is not empty, meaning&lt;/li&gt;
	&lt;li&gt;// if new files got concurrently created. we want to fail then.&lt;/li&gt;
	&lt;li&gt;try 
{
    -				Files.delete(directory.toPath());
    -			}&lt;/li&gt;
	&lt;li&gt;catch (NoSuchFileException ignored) {&lt;/li&gt;
	&lt;li&gt;// if someone else deleted this concurrently, we don&apos;t mind&lt;/li&gt;
	&lt;li&gt;// the result is the same for us, after all&lt;br/&gt;
    +			java.nio.file.Path directoryPath = directory.toPath();&lt;br/&gt;
    +			if (OperatingSystem.isWindows()) {&lt;br/&gt;
    +				// delete the directory. this fails if the directory is not empty, meaning&lt;br/&gt;
    +				// if new files got concurrently created. we want to fail then.&lt;br/&gt;
    +				try 
{
    +					Files.delete(directoryPath);
    +				}
&lt;p&gt; catch (NoSuchFileException ignored) &lt;/p&gt;
{
    +					// if someone else deleted this concurrently, we don&apos;t mind
    +					// the result is the same for us, after all
    +				}
&lt;p&gt; catch (AccessDeniedException e) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					// This may occur on Windows if another process is currently    +					// deleting the file, since the file must be opened in order    +					// to delete it. We double check here to make sure the file    +					// was actually deleted by another process. Note that this    +					// isn&amp;#39;t a perfect solution, but it&amp;#39;s better than nothing.    +					if (Files.exists(directoryPath)) {
    +						throw e;
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (DirectoryNotEmptyException e) {&lt;br/&gt;
    +					// This may occur on Windows for some reason even for empty&lt;br/&gt;
    +					// directories. Apparently there&apos;s a timing/visibility&lt;br/&gt;
    +					// issue when concurrently deleting the contents of a directory &lt;br/&gt;
    +					// and afterwards deleting the directory itself.&lt;br/&gt;
    +					try {&lt;br/&gt;
    +						Thread.sleep(50);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    It only happens when multiple threads are involved; running the test with 1 thread works like charm.&lt;/p&gt;

&lt;p&gt;    This whole thing is just strange. I&apos;ve made some debugging and what happened is that multiple threads delete the same file, and verify the deletion using `Files.exists(filename)`. All of them pass. A few seconds later we hit the `DirectoryNotEmptyException`, check the contents again and what do you know, the file &lt;b&gt;which we just verified to be deleted&lt;/b&gt;  still exists.&lt;/p&gt;</comment>
                            <comment id="16050158" author="githubbot" created="Thu, 15 Jun 2017 08:38:33 +0000"  >&lt;p&gt;Github user zentol closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3219&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16345163" author="zentol" created="Tue, 30 Jan 2018 14:56:46 +0000"  >&lt;p&gt;master: 2e63d5a8ec1fa874a61061b72b970879f14c86d9&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13084646">FLINK-7104</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13073046">FLINK-6622</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i398xb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>