<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10530] ProcessFailureCancelingITCase.testCancelingOnProcessFailure failed on Travis.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10530</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The logs from Travis: &lt;a href=&quot;https://api.travis-ci.org/v3/job/440109944/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/440109944/log.txt&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13190907">FLINK-10530</key>
            <summary>ProcessFailureCancelingITCase.testCancelingOnProcessFailure failed on Travis.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="kkl0u">Kostas Kloudas</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Thu, 11 Oct 2018 13:29:05 +0000</created>
                <updated>Mon, 15 Oct 2018 09:06:16 +0000</updated>
                            <resolved>Mon, 15 Oct 2018 09:06:16 +0000</resolved>
                                    <version>1.7.0</version>
                                    <fixVersion>1.7.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16646536" author="githubbot" created="Thu, 11 Oct 2018 14:53:39 +0000"  >&lt;p&gt;tillrohrmann opened a new pull request #6827: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10530&quot; title=&quot;ProcessFailureCancelingITCase.testCancelingOnProcessFailure failed on Travis.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10530&quot;&gt;&lt;del&gt;FLINK-10530&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Harden ProcessFailureCancelingITCase and AbstractTaskManagerProcessFailureRecovery&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6827&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6827&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;



&lt;p&gt;   The problem is that the Dispatcher actor is being started before it gains leadership. When using the&lt;br/&gt;
   standalone high availability services, then we don&apos;t wait until the Dispatcher has confirmed its&lt;br/&gt;
   leader session id. We only wait until the actor has become available. Due to that it can happen that&lt;br/&gt;
   we try to send a RPC message to the Dispatcher before it has actually set its leader session id.&lt;/p&gt;

&lt;p&gt;   This commit adds a helper function which waits until the Dispatcher has become available and has set&lt;br/&gt;
   its leader session id. The proper way to handle this situation would be to move the leader ship grant&lt;br/&gt;
   and revokal out of the Dispatcher into a DispatcherRunner which creates a Dispatcher actor once it&lt;br/&gt;
   gained leadership.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Covered by the hardened tests&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16649932" author="githubbot" created="Mon, 15 Oct 2018 09:06:05 +0000"  >&lt;p&gt;tillrohrmann closed pull request #6827: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10530&quot; title=&quot;ProcessFailureCancelingITCase.testCancelingOnProcessFailure failed on Travis.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10530&quot;&gt;&lt;del&gt;FLINK-10530&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Harden ProcessFailureCancelingITCase and AbstractTaskManagerProcessFailureRecovery&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6827&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6827&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-tests/src/test/java/org/apache/flink/test/recovery/AbstractTaskManagerProcessFailureRecoveryTest.java b/flink-tests/src/test/java/org/apache/flink/test/recovery/AbstractTaskManagerProcessFailureRecoveryTest.java&lt;br/&gt;
index 5d7f26bb886..83298aa78ec 100644&lt;br/&gt;
&amp;#8212; a/flink-tests/src/test/java/org/apache/flink/test/recovery/AbstractTaskManagerProcessFailureRecoveryTest.java&lt;br/&gt;
+++ b/flink-tests/src/test/java/org/apache/flink/test/recovery/AbstractTaskManagerProcessFailureRecoveryTest.java&lt;br/&gt;
@@ -18,18 +18,19 @@&lt;/p&gt;

&lt;p&gt; package org.apache.flink.test.recovery;&lt;/p&gt;

&lt;p&gt;+import org.apache.flink.api.java.utils.ParameterTool;&lt;br/&gt;
 import org.apache.flink.configuration.AkkaOptions;&lt;br/&gt;
 import org.apache.flink.configuration.Configuration;&lt;br/&gt;
 import org.apache.flink.configuration.HeartbeatManagerOptions;&lt;br/&gt;
+import org.apache.flink.configuration.HighAvailabilityOptions;&lt;br/&gt;
 import org.apache.flink.configuration.JobManagerOptions;&lt;br/&gt;
-import org.apache.flink.configuration.RestOptions;&lt;br/&gt;
 import org.apache.flink.configuration.TaskManagerOptions;&lt;br/&gt;
 import org.apache.flink.runtime.clusterframework.types.ResourceID;&lt;br/&gt;
 import org.apache.flink.runtime.entrypoint.StandaloneSessionClusterEntrypoint;&lt;br/&gt;
 import org.apache.flink.runtime.taskexecutor.TaskManagerRunner;&lt;br/&gt;
 import org.apache.flink.runtime.testutils.CommonTestUtils;&lt;br/&gt;
 import org.apache.flink.runtime.util.BlobServerResource;&lt;br/&gt;
-import org.apache.flink.util.NetUtils;&lt;br/&gt;
+import org.apache.flink.runtime.zookeeper.ZooKeeperResource;&lt;br/&gt;
 import org.apache.flink.util.TestLogger;&lt;/p&gt;

&lt;p&gt; import org.junit.Rule;&lt;br/&gt;
@@ -42,6 +43,8 @@&lt;br/&gt;
 import java.io.FileOutputStream;&lt;br/&gt;
 import java.io.IOException;&lt;br/&gt;
 import java.io.StringWriter;&lt;br/&gt;
+import java.util.ArrayList;&lt;br/&gt;
+import java.util.Map;&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicReference;&lt;/p&gt;

&lt;p&gt; import static org.apache.flink.runtime.testutils.CommonTestUtils.getCurrentClasspath;&lt;br/&gt;
@@ -76,6 +79,9 @@&lt;br/&gt;
 	@Rule&lt;br/&gt;
 	public final BlobServerResource blobServerResource = new BlobServerResource();&lt;/p&gt;

&lt;p&gt;+	@Rule&lt;br/&gt;
+	public final ZooKeeperResource zooKeeperResource = new ZooKeeperResource();&lt;br/&gt;
+&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testTaskManagerProcessFailure() throws Exception {&lt;/p&gt;

&lt;p&gt;@@ -89,18 +95,19 @@ public void testTaskManagerProcessFailure() throws Exception {&lt;/p&gt;

&lt;p&gt; 		File coordinateTempDir = null;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final int jobManagerPort = NetUtils.getAvailablePort();&lt;/li&gt;
	&lt;li&gt;final int restPort = NetUtils.getAvailablePort();&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;Configuration jmConfig = new Configuration();&lt;/li&gt;
	&lt;li&gt;jmConfig.setString(AkkaOptions.ASK_TIMEOUT, &quot;100 s&quot;);&lt;/li&gt;
	&lt;li&gt;jmConfig.setString(JobManagerOptions.ADDRESS, &quot;localhost&quot;);&lt;/li&gt;
	&lt;li&gt;jmConfig.setInteger(JobManagerOptions.PORT, jobManagerPort);&lt;/li&gt;
	&lt;li&gt;jmConfig.setLong(HeartbeatManagerOptions.HEARTBEAT_INTERVAL, 500L);&lt;/li&gt;
	&lt;li&gt;jmConfig.setLong(HeartbeatManagerOptions.HEARTBEAT_TIMEOUT, 10000L);&lt;/li&gt;
	&lt;li&gt;jmConfig.setInteger(RestOptions.PORT, restPort);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;try (final StandaloneSessionClusterEntrypoint clusterEntrypoint = new StandaloneSessionClusterEntrypoint(jmConfig)) {&lt;br/&gt;
+		Configuration config = new Configuration();&lt;br/&gt;
+		config.setString(AkkaOptions.ASK_TIMEOUT, &quot;100 s&quot;);&lt;br/&gt;
+		config.setString(JobManagerOptions.ADDRESS, &quot;localhost&quot;);&lt;br/&gt;
+		config.setLong(HeartbeatManagerOptions.HEARTBEAT_INTERVAL, 500L);&lt;br/&gt;
+		config.setLong(HeartbeatManagerOptions.HEARTBEAT_TIMEOUT, 10000L);&lt;br/&gt;
+		config.setString(HighAvailabilityOptions.HA_MODE, &quot;zookeeper&quot;);&lt;br/&gt;
+		config.setString(HighAvailabilityOptions.HA_ZOOKEEPER_QUORUM, zooKeeperResource.getConnectString());&lt;br/&gt;
+		config.setString(HighAvailabilityOptions.HA_STORAGE_PATH, temporaryFolder.newFolder().getAbsolutePath());&lt;br/&gt;
+		config.setInteger(TaskManagerOptions.NUM_TASK_SLOTS, 2);&lt;br/&gt;
+		config.setString(TaskManagerOptions.MANAGED_MEMORY_SIZE, &quot;4m&quot;);&lt;br/&gt;
+		config.setInteger(TaskManagerOptions.NETWORK_NUM_BUFFERS, 100);&lt;br/&gt;
+&lt;br/&gt;
+		try (final StandaloneSessionClusterEntrypoint clusterEntrypoint = new StandaloneSessionClusterEntrypoint(config)) {&lt;br/&gt;
 			// check that we run this test only if the java command&lt;br/&gt;
 			// is available on this machine&lt;br/&gt;
 			String javaCommand = getJavaCommandPath();&lt;br/&gt;
@@ -119,21 +126,28 @@ public void testTaskManagerProcessFailure() throws Exception {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			clusterEntrypoint.startCluster();&lt;/p&gt;

&lt;p&gt;+			final Map&amp;lt;String, String&amp;gt; keyValues = config.toMap();&lt;br/&gt;
+			final ArrayList&amp;lt;String&amp;gt; commands = new ArrayList&amp;lt;&amp;gt;((keyValues.size() &amp;lt;&amp;lt; 1) + 8);&lt;br/&gt;
+&lt;br/&gt;
 			// the TaskManager java command&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;String[] command = new String[] 
{
-					javaCommand,
-					&quot;-Dlog.level=DEBUG&quot;,
-					&quot;-Dlog4j.configuration=file:&quot; + tempLogFile.getAbsolutePath(),
-					&quot;-Xms80m&quot;, &quot;-Xmx80m&quot;,
-					&quot;-classpath&quot;, getCurrentClasspath(),
-					TaskExecutorProcessEntryPoint.class.getName(),
-					String.valueOf(jobManagerPort)
-			}
&lt;p&gt;;&lt;br/&gt;
+			commands.add(javaCommand);&lt;br/&gt;
+			commands.add(&quot;-Dlog.level=DEBUG&quot;);&lt;br/&gt;
+			commands.add(&quot;-Dlog4j.configuration=file:&quot; + tempLogFile.getAbsolutePath());&lt;br/&gt;
+			commands.add(&quot;-Xms80m&quot;);&lt;br/&gt;
+			commands.add(&quot;-Xmx80m&quot;);&lt;br/&gt;
+			commands.add(&quot;-classpath&quot;);&lt;br/&gt;
+			commands.add(getCurrentClasspath());&lt;br/&gt;
+			commands.add(AbstractTaskManagerProcessFailureRecoveryTest.TaskExecutorProcessEntryPoint.class.getName());&lt;br/&gt;
+&lt;br/&gt;
+			for (Map.Entry&amp;lt;String, String&amp;gt; keyValue: keyValues.entrySet()) &lt;/p&gt;
{
+				commands.add(&quot;--&quot; + keyValue.getKey());
+				commands.add(keyValue.getValue());
+			}&lt;br/&gt;
 &lt;br/&gt;
 			// start the first two TaskManager processes&lt;br/&gt;
-			taskManagerProcess1 = new ProcessBuilder(command).start();&lt;br/&gt;
+			taskManagerProcess1 = new ProcessBuilder(commands).start();&lt;br/&gt;
 			new CommonTestUtils.PipeForwarder(taskManagerProcess1.getErrorStream(), processOutput1);&lt;br/&gt;
-			taskManagerProcess2 = new ProcessBuilder(command).start();&lt;br/&gt;
+			taskManagerProcess2 = new ProcessBuilder(commands).start();&lt;br/&gt;
 			new CommonTestUtils.PipeForwarder(taskManagerProcess2.getErrorStream(), processOutput2);&lt;br/&gt;
 &lt;br/&gt;
 			// the program will set a marker file in each of its parallel tasks once they are ready, so that&lt;br/&gt;
@@ -148,7 +162,7 @@ public void testTaskManagerProcessFailure() throws Exception {&lt;br/&gt;
 				@Override&lt;br/&gt;
 				public void run() {&lt;br/&gt;
 					try {
-						testTaskManagerFailure(restPort, coordinateDirClosure);
+						testTaskManagerFailure(config, coordinateDirClosure);
 					}&lt;br/&gt;
 					catch (Throwable t) {&lt;br/&gt;
 						t.printStackTrace();&lt;br/&gt;
@@ -176,7 +190,7 @@ public void run() {&lt;br/&gt;
 			}&lt;br/&gt;
 &lt;br/&gt;
 			// start the third TaskManager&lt;br/&gt;
-			taskManagerProcess3 = new ProcessBuilder(command).start();&lt;br/&gt;
+			taskManagerProcess3 = new ProcessBuilder(commands).start();&lt;br/&gt;
 			new CommonTestUtils.PipeForwarder(taskManagerProcess3.getErrorStream(), processOutput3);&lt;br/&gt;
 &lt;br/&gt;
 			// kill one of the previous TaskManagers, triggering a failure and recovery&lt;br/&gt;
@@ -232,11 +246,11 @@ public void run() {&lt;br/&gt;
 	 * The test program should be implemented here in a form of a separate thread.&lt;br/&gt;
 	 * This provides a solution for checking that it has been terminated.&lt;br/&gt;
 	 *&lt;br/&gt;
-	 * @param jobManagerPort The port for submitting the topology to the local cluster&lt;br/&gt;
+	 * @param configuration the config to use&lt;br/&gt;
 	 * @param coordinateDir TaskManager failure will be triggered only after processes&lt;br/&gt;
 	 *                             have successfully created file under this directory&lt;br/&gt;
 	 */&lt;br/&gt;
-	public abstract void testTaskManagerFailure(int jobManagerPort, File coordinateDir) throws Exception;&lt;br/&gt;
+	public abstract void testTaskManagerFailure(Configuration configuration, File coordinateDir) throws Exception;&lt;br/&gt;
 &lt;br/&gt;
 	protected static void printProcessLog(String processName, String log) {&lt;br/&gt;
 		if (log == null || log.length() == 0) {&lt;br/&gt;
@@ -306,15 +320,8 @@ protected static boolean waitForMarkerFiles(File basedir, String prefix, int num&lt;br/&gt;
 &lt;br/&gt;
 		public static void main(String[] args) {&lt;br/&gt;
 			try {
-				int jobManagerPort = Integer.parseInt(args[0]);
-
-				Configuration cfg = new Configuration();
-				cfg.setString(JobManagerOptions.ADDRESS, &quot;localhost&quot;);
-				cfg.setInteger(JobManagerOptions.PORT, jobManagerPort);
-				cfg.setString(TaskManagerOptions.MANAGED_MEMORY_SIZE, &quot;4m&quot;);
-				cfg.setInteger(TaskManagerOptions.NETWORK_NUM_BUFFERS, 100);
-				cfg.setInteger(TaskManagerOptions.NUM_TASK_SLOTS, 2);
-				cfg.setString(AkkaOptions.ASK_TIMEOUT, &quot;100 s&quot;);
+				final ParameterTool parameterTool = ParameterTool.fromArgs(args);
+				Configuration cfg = parameterTool.getConfiguration();
 
 				TaskManagerRunner.runTaskManager(cfg, ResourceID.generate());
 			}&lt;br/&gt;
diff --git a/flink-tests/src/test/java/org/apache/flink/test/recovery/ProcessFailureCancelingITCase.java b/flink-tests/src/test/java/org/apache/flink/test/recovery/ProcessFailureCancelingITCase.java&lt;br/&gt;
index afca8f12100..2e39bafe67f 100644&lt;br/&gt;
&amp;#8212; a/flink-tests/src/test/java/org/apache/flink/test/recovery/ProcessFailureCancelingITCase.java&lt;br/&gt;
+++ b/flink-tests/src/test/java/org/apache/flink/test/recovery/ProcessFailureCancelingITCase.java&lt;br/&gt;
@@ -30,10 +30,12 @@&lt;br/&gt;
 import org.apache.flink.client.program.rest.RestClusterClient;&lt;br/&gt;
 import org.apache.flink.configuration.AkkaOptions;&lt;br/&gt;
 import org.apache.flink.configuration.Configuration;&lt;br/&gt;
+import org.apache.flink.configuration.HighAvailabilityOptions;&lt;br/&gt;
 import org.apache.flink.configuration.JobManagerOptions;&lt;br/&gt;
-import org.apache.flink.configuration.RestOptions;&lt;br/&gt;
+import org.apache.flink.configuration.TaskManagerOptions;&lt;br/&gt;
 import org.apache.flink.runtime.client.JobStatusMessage;&lt;br/&gt;
 import org.apache.flink.runtime.concurrent.FutureUtils;&lt;br/&gt;
+import org.apache.flink.runtime.dispatcher.Dispatcher;&lt;br/&gt;
 import org.apache.flink.runtime.dispatcher.DispatcherGateway;&lt;br/&gt;
 import org.apache.flink.runtime.dispatcher.DispatcherId;&lt;br/&gt;
 import org.apache.flink.runtime.dispatcher.MemoryArchivedExecutionGraphStore;&lt;br/&gt;
@@ -53,16 +55,20 @@&lt;br/&gt;
 import org.apache.flink.runtime.util.LeaderConnectionInfo;&lt;br/&gt;
 import org.apache.flink.runtime.util.LeaderRetrievalUtils;&lt;br/&gt;
 import org.apache.flink.runtime.util.TestingFatalErrorHandler;&lt;br/&gt;
+import org.apache.flink.runtime.zookeeper.ZooKeeperResource;&lt;br/&gt;
 import org.apache.flink.util.TestLogger;&lt;br/&gt;
 import org.apache.flink.util.function.CheckedSupplier;&lt;br/&gt;
 &lt;br/&gt;
 import org.junit.Rule;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
+import org.junit.rules.TemporaryFolder;&lt;br/&gt;
 &lt;br/&gt;
 import java.io.File;&lt;br/&gt;
 import java.io.StringWriter;&lt;br/&gt;
 import java.time.Duration;&lt;br/&gt;
+import java.util.ArrayList;&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
+import java.util.Map;&lt;br/&gt;
 import java.util.concurrent.ExecutionException;&lt;br/&gt;
 import java.util.stream.Collectors;&lt;br/&gt;
 &lt;br/&gt;
@@ -84,6 +90,12 @@&lt;br/&gt;
 	@Rule&lt;br/&gt;
 	public final BlobServerResource blobServerResource = new BlobServerResource();&lt;br/&gt;
 &lt;br/&gt;
+	@Rule&lt;br/&gt;
+	public final ZooKeeperResource zooKeeperResource = new ZooKeeperResource();&lt;br/&gt;
+&lt;br/&gt;
+	@Rule&lt;br/&gt;
+	public final TemporaryFolder temporaryFolder = new TemporaryFolder();&lt;br/&gt;
+&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testCancelingOnProcessFailure() throws Exception {&lt;br/&gt;
 		final StringWriter processOutput = new StringWriter();&lt;br/&gt;
@@ -93,23 +105,30 @@ public void testCancelingOnProcessFailure() throws Exception {&lt;br/&gt;
 		Process taskManagerProcess = null;&lt;br/&gt;
 		final TestingFatalErrorHandler fatalErrorHandler = new TestingFatalErrorHandler();&lt;br/&gt;
 &lt;br/&gt;
-		Configuration jmConfig = new Configuration();&lt;br/&gt;
-		jmConfig.setString(AkkaOptions.ASK_TIMEOUT, &quot;100 s&quot;);&lt;br/&gt;
-		jmConfig.setString(JobManagerOptions.ADDRESS, &quot;localhost&quot;);&lt;br/&gt;
-		jmConfig.setInteger(RestOptions.PORT, 0);&lt;br/&gt;
-&lt;br/&gt;
-		final RpcService rpcService = AkkaRpcServiceUtils.createRpcService(&quot;localhost&quot;, 0, jmConfig);&lt;br/&gt;
+		Configuration config = new Configuration();&lt;br/&gt;
+		config.setString(JobManagerOptions.ADDRESS, &quot;localhost&quot;);&lt;br/&gt;
+		config.setString(AkkaOptions.ASK_TIMEOUT, &quot;100 s&quot;);&lt;br/&gt;
+		config.setString(HighAvailabilityOptions.HA_MODE, &quot;zookeeper&quot;);&lt;br/&gt;
+		config.setString(HighAvailabilityOptions.HA_ZOOKEEPER_QUORUM, zooKeeperResource.getConnectString());&lt;br/&gt;
+		config.setString(HighAvailabilityOptions.HA_STORAGE_PATH, temporaryFolder.newFolder().getAbsolutePath());&lt;br/&gt;
+		config.setInteger(TaskManagerOptions.NUM_TASK_SLOTS, 2);&lt;br/&gt;
+		config.setString(TaskManagerOptions.MANAGED_MEMORY_SIZE, &quot;4m&quot;);&lt;br/&gt;
+		config.setInteger(TaskManagerOptions.NETWORK_NUM_BUFFERS, 100);&lt;br/&gt;
+&lt;br/&gt;
+		final RpcService rpcService = AkkaRpcServiceUtils.createRpcService(&quot;localhost&quot;, 0, config);&lt;br/&gt;
 		final int jobManagerPort = rpcService.getPort();&lt;br/&gt;
-		jmConfig.setInteger(JobManagerOptions.PORT, jobManagerPort);&lt;br/&gt;
+		config.setInteger(JobManagerOptions.PORT, jobManagerPort);&lt;br/&gt;
 &lt;br/&gt;
 		final SessionDispatcherResourceManagerComponentFactory resourceManagerComponentFactory = new SessionDispatcherResourceManagerComponentFactory(&lt;br/&gt;
 			StandaloneResourceManagerFactory.INSTANCE);&lt;br/&gt;
 		DispatcherResourceManagerComponent&amp;lt;?&amp;gt; dispatcherResourceManagerComponent = null;&lt;br/&gt;
 &lt;br/&gt;
-		try (final HighAvailabilityServices haServices = HighAvailabilityServicesUtils.createHighAvailabilityServices(&lt;br/&gt;
-				jmConfig,&lt;br/&gt;
-				TestingUtils.defaultExecutor(),&lt;br/&gt;
-				HighAvailabilityServicesUtils.AddressResolution.NO_ADDRESS_RESOLUTION)) {&lt;br/&gt;
+		final HighAvailabilityServices haServices = HighAvailabilityServicesUtils.createHighAvailabilityServices(&lt;br/&gt;
+			config,&lt;br/&gt;
+			TestingUtils.defaultExecutor(),&lt;br/&gt;
+			HighAvailabilityServicesUtils.AddressResolution.NO_ADDRESS_RESOLUTION);&lt;br/&gt;
+&lt;br/&gt;
+		try {&lt;br/&gt;
 &lt;br/&gt;
 			// check that we run this test only if the java command&lt;br/&gt;
 			// is available on this machine&lt;br/&gt;
@@ -125,7 +144,7 @@ public void testCancelingOnProcessFailure() throws Exception {&lt;br/&gt;
 			CommonTestUtils.printLog4jDebugConfig(tempLogFile);&lt;br/&gt;
 &lt;br/&gt;
 			dispatcherResourceManagerComponent = resourceManagerComponentFactory.create(&lt;br/&gt;
-				jmConfig,&lt;br/&gt;
+				config,&lt;br/&gt;
 				rpcService,&lt;br/&gt;
 				haServices,&lt;br/&gt;
 				blobServerResource.getBlobServer(),&lt;br/&gt;
@@ -134,26 +153,26 @@ public void testCancelingOnProcessFailure() throws Exception {&lt;br/&gt;
 				new MemoryArchivedExecutionGraphStore(),&lt;br/&gt;
 				fatalErrorHandler);&lt;br/&gt;
 &lt;br/&gt;
-			// update the rest ports&lt;br/&gt;
-			final int restPort = dispatcherResourceManagerComponent&lt;br/&gt;
-				.getWebMonitorEndpoint()&lt;br/&gt;
-				.getServerAddress()&lt;br/&gt;
-				.getPort();&lt;br/&gt;
-			jmConfig.setInteger(RestOptions.PORT, restPort);&lt;br/&gt;
+			final Map&amp;lt;String, String&amp;gt; keyValues = config.toMap();&lt;br/&gt;
+			final ArrayList&amp;lt;String&amp;gt; commands = new ArrayList&amp;lt;&amp;gt;((keyValues.size() &amp;lt;&amp;lt; 1) + 8);&lt;br/&gt;
 &lt;br/&gt;
 			// the TaskManager java command&lt;br/&gt;
-			String[] command = new String[] {
-					javaCommand,
-					&quot;-Dlog.level=DEBUG&quot;,
-					&quot;-Dlog4j.configuration=file:&quot; + tempLogFile.getAbsolutePath(),
-					&quot;-Xms80m&quot;, &quot;-Xmx80m&quot;,
-					&quot;-classpath&quot;, getCurrentClasspath(),
-					AbstractTaskManagerProcessFailureRecoveryTest.TaskExecutorProcessEntryPoint.class.getName(),
-					String.valueOf(jobManagerPort)
-			};&lt;br/&gt;
+			commands.add(javaCommand);&lt;br/&gt;
+			commands.add(&quot;-Dlog.level=DEBUG&quot;);&lt;br/&gt;
+			commands.add(&quot;-Dlog4j.configuration=file:&quot; + tempLogFile.getAbsolutePath());&lt;br/&gt;
+			commands.add(&quot;-Xms80m&quot;);&lt;br/&gt;
+			commands.add(&quot;-Xmx80m&quot;);&lt;br/&gt;
+			commands.add(&quot;-classpath&quot;);&lt;br/&gt;
+			commands.add(getCurrentClasspath());&lt;br/&gt;
+			commands.add(AbstractTaskManagerProcessFailureRecoveryTest.TaskExecutorProcessEntryPoint.class.getName());&lt;br/&gt;
+&lt;br/&gt;
+			for (Map.Entry&amp;lt;String, String&amp;gt; keyValue: keyValues.entrySet()) {+				commands.add(&quot;--&quot; + keyValue.getKey());+				commands.add(keyValue.getValue());+			}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			// start the first two TaskManager processes&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;taskManagerProcess = new ProcessBuilder(command).start();&lt;br/&gt;
+			taskManagerProcess = new ProcessBuilder(commands).start();&lt;br/&gt;
 			new CommonTestUtils.PipeForwarder(taskManagerProcess.getErrorStream(), processOutput);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			final Throwable[] errorRef = new Throwable&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;;&lt;br/&gt;
@@ -163,7 +182,7 @@ public void testCancelingOnProcessFailure() throws Exception {&lt;br/&gt;
 				@Override&lt;br/&gt;
 				public void run() {&lt;br/&gt;
 					try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ExecutionEnvironment env = ExecutionEnvironment.createRemoteEnvironment(&quot;localhost&quot;, restPort, new Configuration());&lt;br/&gt;
+						ExecutionEnvironment env = ExecutionEnvironment.createRemoteEnvironment(&quot;localhost&quot;, 1337, config);&lt;br/&gt;
 						env.setParallelism(2);&lt;br/&gt;
 						env.setRestartStrategy(RestartStrategies.noRestart());&lt;br/&gt;
 						env.getConfig().disableSysoutLogging();&lt;br/&gt;
@@ -196,16 +215,10 @@ public Long map(Long value) throws Exception {&lt;br/&gt;
 			// kill the TaskManager&lt;br/&gt;
 			programThread.start();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final LeaderConnectionInfo leaderConnectionInfo = LeaderRetrievalUtils.retrieveLeaderConnectionInfo(haServices.getDispatcherLeaderRetriever(), Time.seconds(10L));&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;final DispatcherGateway dispatcherGateway = rpcService.connect(&lt;/li&gt;
	&lt;li&gt;leaderConnectionInfo.getAddress(),&lt;/li&gt;
	&lt;li&gt;DispatcherId.fromUuid(leaderConnectionInfo.getLeaderSessionID()),&lt;/li&gt;
	&lt;li&gt;DispatcherGateway.class).get();&lt;br/&gt;
-&lt;br/&gt;
+			final DispatcherGateway dispatcherGateway = retrieveDispatcherGateway(rpcService, haServices);&lt;br/&gt;
 			waitUntilAllSlotsAreUsed(dispatcherGateway, timeout);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;clusterClient = new RestClusterClient&amp;lt;&amp;gt;(jmConfig, &quot;standalone&quot;);&lt;br/&gt;
+			clusterClient = new RestClusterClient&amp;lt;&amp;gt;(config, &quot;standalone&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			final Collection&amp;lt;JobID&amp;gt; jobIds = waitForRunningJobs(clusterClient, timeout);&lt;/p&gt;

&lt;p&gt;@@ -252,12 +265,31 @@ public Long map(Long value) throws Exception &lt;/p&gt;
{
 				dispatcherResourceManagerComponent.close();
 			}

&lt;p&gt;+			haServices.closeAndCleanupAllData();&lt;br/&gt;
+&lt;br/&gt;
 			fatalErrorHandler.rethrowError();&lt;/p&gt;

&lt;p&gt; 			RpcUtils.terminateRpcService(rpcService, Time.seconds(10L));&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Helper method to wait until the &lt;/p&gt;
{@link Dispatcher}
&lt;p&gt; has set its fencing token.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param rpcService to use to connect to the dispatcher&lt;br/&gt;
+	 * @param haServices high availability services to connect to the dispatcher&lt;br/&gt;
+	 * @return &lt;/p&gt;
{@link DispatcherGateway}
&lt;p&gt;+	 * @throws Exception if something goes wrong&lt;br/&gt;
+	 */&lt;br/&gt;
+	static DispatcherGateway retrieveDispatcherGateway(RpcService rpcService, HighAvailabilityServices haServices) throws Exception &lt;/p&gt;
{
+		final LeaderConnectionInfo leaderConnectionInfo = LeaderRetrievalUtils.retrieveLeaderConnectionInfo(haServices.getDispatcherLeaderRetriever(), Time.seconds(10L));
+
+		return rpcService.connect(
+			leaderConnectionInfo.getAddress(),
+			DispatcherId.fromUuid(leaderConnectionInfo.getLeaderSessionID()),
+			DispatcherGateway.class).get();
+	}
&lt;p&gt;+&lt;br/&gt;
 	private void waitUntilAllSlotsAreUsed(DispatcherGateway dispatcherGateway, Time timeout) throws ExecutionException, InterruptedException {&lt;br/&gt;
 		FutureUtils.retrySuccesfulWithDelay(&lt;br/&gt;
 			() -&amp;gt; dispatcherGateway.requestClusterOverview(timeout),&lt;br/&gt;
diff --git a/flink-tests/src/test/java/org/apache/flink/test/recovery/TaskManagerProcessFailureBatchRecoveryITCase.java b/flink-tests/src/test/java/org/apache/flink/test/recovery/TaskManagerProcessFailureBatchRecoveryITCase.java&lt;br/&gt;
index 4815c4938f7..473fb3959f8 100644&lt;br/&gt;
&amp;#8212; a/flink-tests/src/test/java/org/apache/flink/test/recovery/TaskManagerProcessFailureBatchRecoveryITCase.java&lt;br/&gt;
+++ b/flink-tests/src/test/java/org/apache/flink/test/recovery/TaskManagerProcessFailureBatchRecoveryITCase.java&lt;br/&gt;
@@ -64,10 +64,9 @@ public TaskManagerProcessFailureBatchRecoveryITCase(ExecutionMode executionMode)&lt;br/&gt;
 	// --------------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt; 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void testTaskManagerFailure(int jobManagerPort, final File coordinateDir) throws Exception {&lt;br/&gt;
+	public void testTaskManagerFailure(Configuration configuration, final File coordinateDir) throws Exception {&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Configuration configuration = new Configuration();&lt;/li&gt;
	&lt;li&gt;ExecutionEnvironment env = ExecutionEnvironment.createRemoteEnvironment(&quot;localhost&quot;, jobManagerPort, configuration);&lt;br/&gt;
+		ExecutionEnvironment env = ExecutionEnvironment.createRemoteEnvironment(&quot;localhost&quot;, 1337, configuration);&lt;br/&gt;
 		env.setParallelism(PARALLELISM);&lt;br/&gt;
 		env.setRestartStrategy(RestartStrategies.fixedDelayRestart(1, 0L));&lt;br/&gt;
 		env.getConfig().setExecutionMode(executionMode);&lt;br/&gt;
diff --git a/flink-tests/src/test/java/org/apache/flink/test/recovery/TaskManagerProcessFailureStreamingRecoveryITCase.java b/flink-tests/src/test/java/org/apache/flink/test/recovery/TaskManagerProcessFailureStreamingRecoveryITCase.java&lt;br/&gt;
index fbf6b5b71e3..8ccb311be1c 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-tests/src/test/java/org/apache/flink/test/recovery/TaskManagerProcessFailureStreamingRecoveryITCase.java&lt;br/&gt;
+++ b/flink-tests/src/test/java/org/apache/flink/test/recovery/TaskManagerProcessFailureStreamingRecoveryITCase.java&lt;br/&gt;
@@ -61,14 +61,13 @@&lt;br/&gt;
 	private static final int DATA_COUNT = 10000;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Override&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void testTaskManagerFailure(int jobManagerPort, final File coordinateDir) throws Exception {&lt;br/&gt;
+	public void testTaskManagerFailure(Configuration configuration, final File coordinateDir) throws Exception {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		final File tempCheckpointDir = tempFolder.newFolder();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Configuration configuration = new Configuration();&lt;br/&gt;
 		StreamExecutionEnvironment env = StreamExecutionEnvironment.createRemoteEnvironment(&lt;br/&gt;
 			&quot;localhost&quot;,&lt;/li&gt;
	&lt;li&gt;jobManagerPort,&lt;br/&gt;
+			1337, // not needed since we use ZooKeeper&lt;br/&gt;
 			configuration);&lt;br/&gt;
 		env.setParallelism(PARALLELISM);&lt;br/&gt;
 		env.getConfig().disableSysoutLogging();&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16649933" author="till.rohrmann" created="Mon, 15 Oct 2018 09:06:16 +0000"  >&lt;p&gt;Fixed via &lt;a href=&quot;https://github.com/apache/flink/commit/bbee77ab33f8ac2595ca3608d9d0d875c1715863&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/bbee77ab33f8ac2595ca3608d9d0d875c1715863&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3z2yn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>