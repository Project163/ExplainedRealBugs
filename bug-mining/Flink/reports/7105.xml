<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:17:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-32311] ZooKeeperLeaderElectionTest.testZooKeeperReelectionWithReplacement and DefaultLeaderElectionService.onGrantLeadership fell into dead lock</title>
                <link>https://issues.apache.org/jira/browse/FLINK-32311</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49750&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=24c3384f-1bcb-57b3-224f-51bf973bbee8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49750&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=24c3384f-1bcb-57b3-224f-51bf973bbee8&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;there are 2 threads one locked &lt;tt&gt;0x00000000e3a8a1e8&lt;/tt&gt; and waiting for &lt;tt&gt;0x00000000e3a89c18&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
2023-06-08T01:18:54.5609123Z Jun 08 01:18:54 &quot;ForkJoinPool-50-worker-25-EventThread&quot; #956 daemon prio=5 os_prio=0 tid=0x00007f9374253800 nid=0x6a4e waiting for monitor entry [0x00007f94b63e1000]
2023-06-08T01:18:54.5609820Z Jun 08 01:18:54    java.lang.Thread.State: BLOCKED (on object monitor)
2023-06-08T01:18:54.5610557Z Jun 08 01:18:54 	at org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService.runInLeaderEventThread(DefaultLeaderElectionService.java:425)
2023-06-08T01:18:54.5611459Z Jun 08 01:18:54 	- waiting to lock &amp;lt;0x00000000e3a89c18&amp;gt; (a java.lang.Object)
2023-06-08T01:18:54.5612198Z Jun 08 01:18:54 	at org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService.onGrantLeadership(DefaultLeaderElectionService.java:300)
2023-06-08T01:18:54.5613110Z Jun 08 01:18:54 	at org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionDriver.isLeader(ZooKeeperLeaderElectionDriver.java:153)
2023-06-08T01:18:54.5614070Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.leader.LeaderLatch$$Lambda$1649/586959400.accept(Unknown Source)
2023-06-08T01:18:54.5615014Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.listen.MappingListenerManager.lambda$forEach$0(MappingListenerManager.java:92)
2023-06-08T01:18:54.5616259Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.listen.MappingListenerManager$$Lambda$1640/1393625763.run(Unknown Source)
2023-06-08T01:18:54.5617137Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.listen.MappingListenerManager$$Lambda$1633/2012730699.execute(Unknown Source)
2023-06-08T01:18:54.5618047Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.listen.MappingListenerManager.forEach(MappingListenerManager.java:89)
2023-06-08T01:18:54.5618994Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.listen.StandardListenerManager.forEach(StandardListenerManager.java:89)
2023-06-08T01:18:54.5620071Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.leader.LeaderLatch.setLeadership(LeaderLatch.java:711)
2023-06-08T01:18:54.5621198Z Jun 08 01:18:54 	- locked &amp;lt;0x00000000e3a8a1e8&amp;gt; (a org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.leader.LeaderLatch)
2023-06-08T01:18:54.5622072Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.leader.LeaderLatch.checkLeadership(LeaderLatch.java:597)
2023-06-08T01:18:54.5622991Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.leader.LeaderLatch.access$600(LeaderLatch.java:64)
2023-06-08T01:18:54.5623988Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.leader.LeaderLatch$7.processResult(LeaderLatch.java:648)
2023-06-08T01:18:54.5624965Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.imps.CuratorFrameworkImpl.sendToBackgroundCallback(CuratorFrameworkImpl.java:926)
2023-06-08T01:18:54.5626218Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.imps.CuratorFrameworkImpl.processBackgroundOperation(CuratorFrameworkImpl.java:683)
2023-06-08T01:18:54.5627369Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.imps.WatcherRemovalFacade.processBackgroundOperation(WatcherRemovalFacade.java:152)
2023-06-08T01:18:54.5628353Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.imps.GetChildrenBuilderImpl$2.processResult(GetChildrenBuilderImpl.java:187)
2023-06-08T01:18:54.5629281Z Jun 08 01:18:54 	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:666)
2023-06-08T01:18:54.5630124Z Jun 08 01:18:54 	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:553)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and another locked &lt;tt&gt;0x00000000e3a89c18&lt;/tt&gt; and waits for &lt;tt&gt;0x00000000e3a8a1e8&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2023-06-08T01:18:54.5738286Z Jun 08 01:18:54 &quot;ForkJoinPool-50-worker-25&quot; #620 daemon prio=5 os_prio=0 tid=0x00007f953874f000 nid=0x682e waiting for monitor entry [0x00007f95461d4000]
2023-06-08T01:18:54.5738959Z Jun 08 01:18:54    java.lang.Thread.State: BLOCKED (on object monitor)
2023-06-08T01:18:54.5739645Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.leader.LeaderLatch.close(LeaderLatch.java:203)
2023-06-08T01:18:54.5740731Z Jun 08 01:18:54 	- waiting to lock &amp;lt;0x00000000e3a8a1e8&amp;gt; (a org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.leader.LeaderLatch)
2023-06-08T01:18:54.5741591Z Jun 08 01:18:54 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.leader.LeaderLatch.close(LeaderLatch.java:190)
2023-06-08T01:18:54.5742609Z Jun 08 01:18:54 	at org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionDriver.close(ZooKeeperLeaderElectionDriver.java:135)
2023-06-08T01:18:54.5743491Z Jun 08 01:18:54 	at org.apache.flink.runtime.leaderelection.DefaultLeaderElectionService.close(DefaultLeaderElectionService.java:217)
2023-06-08T01:18:54.5744427Z Jun 08 01:18:54 	- locked &amp;lt;0x00000000e3a89c18&amp;gt; (a java.lang.Object)
2023-06-08T01:18:54.5745200Z Jun 08 01:18:54 	at org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionTest.testZooKeeperReelectionWithReplacement(ZooKeeperLeaderElectionTest.java:346)
2023-06-08T01:18:54.5746206Z Jun 08 01:18:54 	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
2023-06-08T01:18:54.5746829Z Jun 08 01:18:54 	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
2023-06-08T01:18:54.5747552Z Jun 08 01:18:54 	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
2023-06-08T01:18:54.5748207Z Jun 08 01:18:54 	at java.lang.reflect.Method.invoke(Method.java:498)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13539651">FLINK-32311</key>
            <summary>ZooKeeperLeaderElectionTest.testZooKeeperReelectionWithReplacement and DefaultLeaderElectionService.onGrantLeadership fell into dead lock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mapohl">Matthias Pohl</assignee>
                                    <reporter username="Sergey Nuyanzin">Sergey Nuyanzin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Mon, 12 Jun 2023 11:17:08 +0000</created>
                <updated>Thu, 15 Jun 2023 12:00:48 +0000</updated>
                            <resolved>Thu, 15 Jun 2023 12:00:48 +0000</resolved>
                                    <version>1.18.0</version>
                                    <fixVersion>1.18.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17731623" author="mapohl" created="Mon, 12 Jun 2023 13:44:37 +0000"  >&lt;p&gt;This can, indeed, happen in the new implementation (even with the &lt;tt&gt;MultipleComponentLeaderElectionDriver&lt;/tt&gt; implementation which is not used in the test run right now) because we call close on the driver within the lock. The old &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt; implementation didn&apos;t do that (see &lt;a href=&quot;https://github.com/apache/flink/blob/release-1.17/flink-runtime/src/main/java/org/apache/flink/runtime/leaderelection/DefaultLeaderElectionService.java#L113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DefaultLeaderElectionService:113&lt;/a&gt; in &lt;tt&gt;release-1.17&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;DefaultMultipleComponentLeaderElectionService&lt;/tt&gt; implementation does close the driver in a lock, though. But it doesn&apos;t rely on the lock when processing the event (e.g. in &lt;a href=&quot;https://github.com/apache/flink/blob/e3cd3b311c1c8a6a0e0cdc849d7c951ef8beea5c/flink-runtime/src/main/java/org/apache/flink/runtime/leaderelection/DefaultMultipleComponentLeaderElectionService.java#L152&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DefaultMultipleComponentLeaderElectionService:152&lt;/a&gt;). I considered this a bug in the implementation &lt;tt&gt;MultipleComponent*&lt;/tt&gt; implementation initially: The event handling processing is done in a single thread to avoid locking. But the close method can be still called from another thread. &lt;/p&gt;</comment>
                            <comment id="17732003" author="mapohl" created="Tue, 13 Jun 2023 09:41:48 +0000"  >&lt;p&gt;Ok, I did go through the code comparing the &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt; with the &lt;tt&gt;DefaultMultipleComponentLeaderElectionService&lt;/tt&gt; in that regards: The actual deadlock in the test happens between the ZK LeaderLatch lock in the curator&apos;s event thread and the test code&apos;s thread calling the &lt;tt&gt;DefaultLeaderElectionService#close()&lt;/tt&gt; which is guarded by the &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt;&apos;s lock. With &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31733&quot; title=&quot;Model name clashes in OpenAPI spec&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31733&quot;&gt;&lt;del&gt;FLINK-31733&lt;/del&gt;&lt;/a&gt;, we split up the driver lifecycle and the contender lifecycle and moved the driver&apos;s closing into the lock&apos;s monitor region (because we wanted the driver to be shutdown along the &lt;tt&gt;leaderOperationExecutor&lt;/tt&gt; which processes the leader events to avoid {{RejectedExecutionException}}s from happening). This caused the concurrent nested lock scenario for the legacy driver to happen (as we see it being documented in the Jira issue).&lt;/p&gt;

&lt;p&gt;Now the question is whether or why it didn&apos;t appear in the production code where we use the &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24038&quot; title=&quot;DispatcherResourceManagerComponent fails to deregister application if no leading ResourceManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24038&quot;&gt;&lt;del&gt;FLINK-24038&lt;/del&gt;&lt;/a&gt; classes, i.e. &lt;tt&gt;MultipleComponentLeaderElectionDriverAdapter&lt;/tt&gt; and &lt;tt&gt;DefaultMultipleComponentLeaderElectionService&lt;/tt&gt;. The latter one does also close its driver implementation within the locks (analogously to how it&apos;s done in the current &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt; implementation). The difference is that the &lt;tt&gt;DefaultMultipleComponentLeaderElectionService&lt;/tt&gt; owns its own lock. This prevents both threads from trying to own the same two locks.&lt;/p&gt;

&lt;p&gt;Therefore, my conclusion is that it&apos;s a test code issue right now. But we have to address if we want to continue with &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-26522&quot; title=&quot;FLIP-285: Refactoring code for multiple component leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-26522&quot;&gt;&lt;del&gt;FLINK-26522&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17733025" author="mapohl" created="Thu, 15 Jun 2023 12:00:48 +0000"  >&lt;p&gt;master: fdfff096a3a513979fe7676ab2e3ab1100468494&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13532184">FLINK-31773</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ihe8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>