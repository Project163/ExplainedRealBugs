<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9936] Mesos resource manager unable to connect to master after failover</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9936</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When deployed in mesos session cluster mode, the connector monitor keeps reporting unable to connect to mesos after restart.&#160;In fact, scheduler driver already connected to mesos master, but when the connected message is lost. This is because leadership is not granted yet and fence id is not set, the rpc service ignores the connected message. So we should connect to mesos master after leadership is granted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13174064">FLINK-9936</key>
            <summary>Mesos resource manager unable to connect to master after failover</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gjy">Gary Yao</assignee>
                                    <reporter username="liurenjie1024">Renjie Liu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 24 Jul 2018 10:50:59 +0000</created>
                <updated>Wed, 7 Oct 2020 08:56:10 +0000</updated>
                            <resolved>Fri, 3 Aug 2018 14:39:44 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.5.1</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.5.3</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>Deployment / Mesos</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16561093" author="gjy" created="Sun, 29 Jul 2018 12:12:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liurenjie1024&quot; class=&quot;user-hover&quot; rel=&quot;liurenjie1024&quot;&gt;liurenjie1024&lt;/a&gt; What&apos;s the state of this ticket? Do you have solution in mind? I think we need to add a callback to the &lt;tt&gt;Runnable&lt;/tt&gt; scheduled in &lt;tt&gt;ResourceManager#grantLeadership&lt;/tt&gt;. What do you think?&lt;/p&gt;</comment>
                            <comment id="16561101" author="liurenjie1024" created="Sun, 29 Jul 2018 12:21:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt; I&apos;m working on this and I&apos;ve already made an internal version testing in our own deployment which works well. I&apos;m going to publish our patch and add some tests to it.&lt;/p&gt;</comment>
                            <comment id="16561610" author="githubbot" created="Mon, 30 Jul 2018 08:12:53 +0000"  >&lt;p&gt;liurenjie1024 opened a new pull request #6451: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt; Resource manager connect to mesos after leadership granted. .&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6451&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6451&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This PR fixes a bug in mesos resource manager which makes it unable to connect to mesos after failover.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add *&lt;b&gt;onLeadershipGranted&lt;/b&gt;* callback in resource manager.&lt;/li&gt;
	&lt;li&gt;Add *&lt;b&gt;onLeadershipRevoked&lt;/b&gt;* callback in resource manager.&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change added tests and can be verified as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Manually verified the change by running a cluster on mesos, a stateful streaming program, and killing one JobManager and two TaskManagers during the execution, verifying that recovery happens correctly.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency):  no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`:  no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper:  yes&lt;/li&gt;
	&lt;li&gt;The S3 file system connector:  no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16561796" author="githubbot" created="Mon, 30 Jul 2018 11:28:00 +0000"  >&lt;p&gt;yanghua commented on a change in pull request #6451: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt; Resource manager connect to mesos after leadership granted. .&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6451#discussion_r206097341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6451#discussion_r206097341&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -221,10 +221,14 @@ protected ActorRef createReconciliationCoordinator(SchedulerDriver schedulerDriv&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Starts the Mesos-specifics.&lt;br/&gt;
+	 * Do nothing and all work has been moved to on leadership granted callback.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   replace &quot;on leadership granted&quot; to &quot;onLeaderShipGranted&quot; looks better to me&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16561795" author="githubbot" created="Mon, 30 Jul 2018 11:28:00 +0000"  >&lt;p&gt;yanghua commented on a change in pull request #6451: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt; Resource manager connect to mesos after leadership granted. .&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6451#discussion_r206098411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6451#discussion_r206098411&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -283,7 +287,14 @@ protected void initialize() throws ResourceManagerException &lt;/p&gt;
{
 		connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);
 		schedulerDriver.start();
 
-		LOG.info(&quot;Mesos resource manager initialized.&quot;);
+		LOG.info(&quot;Mesos resource manager started.&quot;);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected void onLeaderShipRevoked() throws Exception {&lt;br/&gt;
+		workerStore.stop(false);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   We should warp try/catch block for these three calls to make sure they can be stopped even if previous statement throws an exception.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16561819" author="githubbot" created="Mon, 30 Jul 2018 11:57:12 +0000"  >&lt;p&gt;GJL commented on issue #6451: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt; Resource manager connect to mesos after leadership granted. .&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6451#issuecomment-408838604&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6451#issuecomment-408838604&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I&apos;ll take a look today.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16563658" author="githubbot" created="Tue, 31 Jul 2018 13:23:18 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6451: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt; Resource manager connect to mesos after leadership granted. .&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6451#discussion_r206522513&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6451#discussion_r206522513&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -221,10 +221,14 @@ protected ActorRef createReconciliationCoordinator(SchedulerDriver schedulerDriv&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Starts the Mesos-specifics.&lt;br/&gt;
+	 * Do nothing and all work has been moved to on leadership granted callback.&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Override&lt;br/&gt;
 	protected void initialize() throws ResourceManagerException 
{
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected void onLeaderShipGranted() throws Exception {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   We are re-creating the supporting actors without shutting them down. This should result in memory leaks everytime the instance wins the leader election. It is also not very nice that we occupy the main thread of the actor with blocking IO.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16563719" author="githubbot" created="Tue, 31 Jul 2018 14:05:04 +0000"  >&lt;p&gt;liurenjie1024 commented on issue #6451: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt; Resource manager connect to mesos after leadership granted. .&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6451#issuecomment-409232804&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6451#issuecomment-409232804&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @GJL Thanks for the review. It&apos;s ok for you to take over it.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16564307" author="githubbot" created="Tue, 31 Jul 2018 20:04:15 +0000"  >&lt;p&gt;GJL opened a new pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   WIP&lt;/p&gt;

&lt;p&gt;   cc: @tillrohrmann &lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16564903" author="githubbot" created="Wed, 1 Aug 2018 07:42:36 +0000"  >&lt;p&gt;zentol commented on issue #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#issuecomment-409481500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#issuecomment-409481500&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   If you want to share work-in-progress with another committer please just send him the branch directly.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16564913" author="githubbot" created="Wed, 1 Aug 2018 07:52:22 +0000"  >&lt;p&gt;liurenjie1024 commented on issue #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#issuecomment-409484118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#issuecomment-409484118&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Hi @GJL:&lt;br/&gt;
   If you don&apos;t have enough time for this, I still would like to work on it  under your guidance.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16565340" author="githubbot" created="Wed, 1 Aug 2018 13:43:11 +0000"  >&lt;p&gt;GJL commented on issue #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#issuecomment-409579075&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#issuecomment-409579075&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @liurenjie1024 I currently have resources to work on this full time. I think I can create a new PR today or tomorrow. I&apos;d be happy if you can review the code.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16565341" author="githubbot" created="Wed, 1 Aug 2018 13:44:22 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r206884046&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r206884046&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -279,21 +270,55 @@ protected void initialize() throws ResourceManagerException &lt;/p&gt;
{
 			throw new ResourceManagerException(&quot;Unable to configure the artifact server with TaskManager artifacts.&quot;, e);
 		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// begin scheduling&lt;/li&gt;
	&lt;li&gt;connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);&lt;/li&gt;
	&lt;li&gt;schedulerDriver.start();&lt;br/&gt;
-&lt;br/&gt;
 		LOG.info(&quot;Mesos resource manager initialized.&quot;);&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+	@Override&lt;br/&gt;
+	protected CompletableFuture&amp;lt;Void&amp;gt; prepareLeadershipAsync() {&lt;br/&gt;
+		return getRpcService().execute(() -&amp;gt; recoverWorkers())&lt;br/&gt;
+			.thenAcceptAsync((tasksFromPreviousAttempts) -&amp;gt; {&lt;br/&gt;
+				try &lt;/p&gt;
{
+					recoverWorkers(tasksFromPreviousAttempts);
+				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
+					throw new CompletionException(new ResourceManagerException(e));
+				}
&lt;p&gt;+&lt;br/&gt;
+				// begin scheduling&lt;br/&gt;
+				connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);&lt;br/&gt;
+				schedulerDriver.start();&lt;br/&gt;
+&lt;br/&gt;
+				LOG.info(&quot;Mesos resource manager started.&quot;);&lt;br/&gt;
+			}, getMainThreadExecutor());&lt;br/&gt;
+	}&lt;br/&gt;
+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected void clearState() {&lt;br/&gt;
+		schedulerDriver.stop(true);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   From my experiments it seems that it is not possible to stop and re-start the `SchedulerDriver`. I&apos;d suggest re-creating the supporting actors and the `SchedulerDriver`.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16565607" author="githubbot" created="Wed, 1 Aug 2018 16:42:05 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r206951198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r206951198&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -278,22 +268,76 @@ protected void initialize() throws ResourceManagerException {&lt;br/&gt;
 		catch (IOException e) &lt;/p&gt;
{
 			throw new ResourceManagerException(&quot;Unable to configure the artifact server with TaskManager artifacts.&quot;, e);
 		}
&lt;p&gt;+	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// begin scheduling&lt;/li&gt;
	&lt;li&gt;connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);&lt;/li&gt;
	&lt;li&gt;schedulerDriver.start();&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected CompletableFuture&amp;lt;Void&amp;gt; prepareLeadershipAsync() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+		Preconditions.checkState(initializedMesosConfig != null);++		return clearStateFuture+			.thenRunAsync(() -&amp;gt; {
+				schedulerDriver = initializedMesosConfig.createDriver(
+					new MesosResourceManagerSchedulerCallback(),
+					false);
+
+				// create supporting actors
+				connectionMonitor = createConnectionMonitor();
+				launchCoordinator = createLaunchCoordinator(schedulerDriver, selfActor);
+				reconciliationCoordinator = createReconciliationCoordinator(schedulerDriver);
+				taskMonitor = createTaskMonitor(schedulerDriver);
+			}, getMainThreadExecutor())+			.thenCombineAsync(getWorkersAsync(), (ignored, tasksFromPreviousAttempts) -&amp;gt; {
+				// recover state
+				recoverWorkers(tasksFromPreviousAttempts);
+
+				// begin scheduling
+				connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);
+				schedulerDriver.start();
+
+				LOG.info(&quot;Mesos resource manager started.&quot;);
+				return null;
+			}, getMainThreadExecutor());+	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;Mesos resource manager initialized.&quot;);&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected void clearState() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+		schedulerDriver.stop(true);++		clearStateFuture = stopSupportingActorsAsync().thenRunAsync(() -&amp;gt; {
+			workersInNew.clear();
+			workersInLaunch.clear();
+			workersBeingReturned.clear();
+		}, getUnfencedMainThreadExecutor()); 	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Recover framework/worker information persisted by a prior incarnation of the RM.&lt;br/&gt;
+	 * Fetches framework/worker information persisted by a prior incarnation of the RM.&lt;br/&gt;
 	 */&lt;/li&gt;
	&lt;li&gt;private void recoverWorkers() throws Exception {&lt;br/&gt;
+	private CompletableFuture&amp;lt;List&amp;lt;MesosWorkerStore.Worker&amp;gt;&amp;gt; getWorkersAsync() {&lt;br/&gt;
 		// if this resource manager is recovering from failure,&lt;br/&gt;
 		// then some worker tasks are most likely still alive and we can re-obtain them&lt;/li&gt;
	&lt;li&gt;final List&amp;lt;MesosWorkerStore.Worker&amp;gt; tasksFromPreviousAttempts = workerStore.recoverWorkers();&lt;br/&gt;
+		return CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
+			try {&lt;br/&gt;
+				final List&amp;lt;MesosWorkerStore.Worker&amp;gt; tasksFromPreviousAttempts = workerStore.recoverWorkers();&lt;br/&gt;
+				for (final MesosWorkerStore.Worker worker : tasksFromPreviousAttempts) {&lt;br/&gt;
+					if (worker.state() == MesosWorkerStore.WorkerState.New) {&lt;br/&gt;
+						// remove new workers because allocation requests are transient&lt;br/&gt;
+						workerStore.removeWorker(worker.taskID());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   This is copied code but I don&apos;t understand why it&apos;s needed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567081" author="githubbot" created="Thu, 2 Aug 2018 17:06:17 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207293251&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207293251&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -894,17 +900,21 @@ public void grantLeadership(final UUID newLeaderSessionID) {&lt;/p&gt;

&lt;p&gt; 				// clear the state if we&apos;ve been the leader before&lt;br/&gt;
 				if (getFencingToken() != null) &lt;/p&gt;
{
-					clearState();
+					clearStateInternal();
 				}

&lt;p&gt; 				setFencingToken(newResourceManagerId);&lt;/p&gt;

&lt;p&gt; 				slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;getRpcService().execute(&lt;/li&gt;
	&lt;li&gt;() -&amp;gt;&lt;br/&gt;
+				prepareLeadershipAsync()&lt;br/&gt;
+					.exceptionally(t -&amp;gt; 
{
+						onFatalError(t);
+						return null;
+					}
&lt;p&gt;)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Let&apos;s move the exception handling at the very end. That way we can also catch if `confirmLeaderSessionID` fails. In all cases, we should call `onFatalError`.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567082" author="githubbot" created="Thu, 2 Aug 2018 17:06:17 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207302992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207302992&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -894,17 +900,21 @@ public void grantLeadership(final UUID newLeaderSessionID) {&lt;/p&gt;

&lt;p&gt; 				// clear the state if we&apos;ve been the leader before&lt;br/&gt;
 				if (getFencingToken() != null) &lt;/p&gt;
{
-					clearState();
+					clearStateInternal();
 				}

&lt;p&gt; 				setFencingToken(newResourceManagerId);&lt;/p&gt;

&lt;p&gt; 				slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;getRpcService().execute(&lt;/li&gt;
	&lt;li&gt;() -&amp;gt;&lt;br/&gt;
+				prepareLeadershipAsync()&lt;br/&gt;
+					.exceptionally(t -&amp;gt; 
{
+						onFatalError(t);
+						return null;
+					}
&lt;p&gt;)&lt;br/&gt;
+					.thenRunAsync(() -&amp;gt;&lt;br/&gt;
 						// confirming the leader session ID might be blocking,&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;leaderElectionService.confirmLeaderSessionID(newLeaderSessionID));&lt;br/&gt;
+						leaderElectionService.confirmLeaderSessionID(newLeaderSessionID), getRpcService().getExecutor());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Maybe we could refactor the `grantLeadership` the following way:&lt;br/&gt;
   ```&lt;br/&gt;
   /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Callback method when current resourceManager is granted leadership.&lt;br/&gt;
   	 *&lt;/li&gt;
	&lt;li&gt;@param newLeaderSessionID unique leadershipID&lt;br/&gt;
   	 */&lt;br/&gt;
   	@Override&lt;br/&gt;
   	public void grantLeadership(final UUID newLeaderSessionID) {&lt;br/&gt;
   		final CompletableFuture&amp;lt;Boolean&amp;gt; acceptLeadershipFuture = CompletableFuture.supplyAsync(&lt;br/&gt;
   			() -&amp;gt; tryAcceptLeadership(newLeaderSessionID),&lt;br/&gt;
   			getUnfencedMainThreadExecutor()).thenCompose(Function.identity());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   		final CompletableFuture&amp;lt;Void&amp;gt; confirmationFuture = acceptLeadershipFuture.thenAcceptAsync(&lt;br/&gt;
   			(Boolean acceptLeadership) -&amp;gt; {&lt;br/&gt;
   				if (acceptLeadership) &lt;/p&gt;
{
   					// confirming the leader session ID might be blocking,
   					leaderElectionService.confirmLeaderSessionID(newLeaderSessionID);
   				}
&lt;p&gt;   			},&lt;br/&gt;
   			getRpcService().getExecutor());&lt;/p&gt;

&lt;p&gt;   		confirmationFuture.whenComplete(&lt;br/&gt;
   			(Void ignored, Throwable throwable) -&amp;gt; {&lt;br/&gt;
   				if (throwable != null) &lt;/p&gt;
{
   					onFatalError(ExceptionUtils.stripCompletionException(throwable));
   				}
&lt;p&gt;   			});&lt;br/&gt;
   	}&lt;/p&gt;

&lt;p&gt;   	private CompletableFuture&amp;lt;Boolean&amp;gt; tryAcceptLeadership(UUID newLeaderSessionID) {&lt;br/&gt;
   		if (leaderElectionService.hasLeadership(newLeaderSessionID)) {&lt;br/&gt;
   			final ResourceManagerId newResourceManagerId = ResourceManagerId.fromUuid(newLeaderSessionID);&lt;/p&gt;

&lt;p&gt;   			log.info(&quot;ResourceManager {} was granted leadership with fencing token {}&quot;, getAddress(), newResourceManagerId);&lt;/p&gt;

&lt;p&gt;   			// clear the state if we&apos;ve been the leader before&lt;br/&gt;
   			if (getFencingToken() != null) &lt;/p&gt;
{
   				clearStateInternal();
   			}

&lt;p&gt;   			setFencingToken(newResourceManagerId);&lt;/p&gt;

&lt;p&gt;   			slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;/p&gt;

&lt;p&gt;   			return prepareLeadershipAsync().thenApply(ignored -&amp;gt; true);&lt;br/&gt;
   		} else &lt;/p&gt;
{
   			return CompletableFuture.completedFuture(false);
   		}
&lt;p&gt;   	}&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567083" author="githubbot" created="Thu, 2 Aug 2018 17:06:17 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207295725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207295725&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -278,22 +267,76 @@ protected void initialize() throws ResourceManagerException {&lt;br/&gt;
 		catch (IOException e) &lt;/p&gt;
{
 			throw new ResourceManagerException(&quot;Unable to configure the artifact server with TaskManager artifacts.&quot;, e);
 		}
&lt;p&gt;+	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// begin scheduling&lt;/li&gt;
	&lt;li&gt;connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);&lt;/li&gt;
	&lt;li&gt;schedulerDriver.start();&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected CompletableFuture&amp;lt;Void&amp;gt; prepareLeadershipAsync() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+		Preconditions.checkState(initializedMesosConfig != null);++		return clearStateFuture+			.thenRunAsync(() -&amp;gt; {
+				schedulerDriver = initializedMesosConfig.createDriver(
+					new MesosResourceManagerSchedulerCallback(),
+					false);
+
+				// create supporting actors
+				connectionMonitor = createConnectionMonitor();
+				launchCoordinator = createLaunchCoordinator(schedulerDriver, selfActor);
+				reconciliationCoordinator = createReconciliationCoordinator(schedulerDriver);
+				taskMonitor = createTaskMonitor(schedulerDriver);
+			}, getMainThreadExecutor())+			.thenCombineAsync(getWorkersAsync(), (ignored, tasksFromPreviousAttempts) -&amp;gt; {
+				// recover state
+				recoverWorkers(tasksFromPreviousAttempts);
+
+				// begin scheduling
+				connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);
+				schedulerDriver.start();
+
+				LOG.info(&quot;Mesos resource manager started.&quot;);
+				return null;
+			}, getMainThreadExecutor());+	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;Mesos resource manager initialized.&quot;);&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected void clearState() {&lt;br/&gt;
+		schedulerDriver.stop(true);&lt;br/&gt;
+&lt;br/&gt;
+		clearStateFuture = stopSupportingActorsAsync().thenRunAsync(() -&amp;gt; {&lt;br/&gt;
+			workersInNew.clear();&lt;br/&gt;
+			workersInLaunch.clear();&lt;br/&gt;
+			workersBeingReturned.clear();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Can&apos;t we clear these fields right away when `clearState` is called?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567084" author="githubbot" created="Thu, 2 Aug 2018 17:06:17 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207294014&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207294014&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -345,15 +382,20 @@ private void recoverWorkers() throws Exception &lt;/p&gt;
{
 		CompletableFuture&amp;lt;Boolean&amp;gt; stopReconciliationCoordinatorFuture = stopActor(reconciliationCoordinator, stopTimeout);
 		reconciliationCoordinator = null;
 
-		CompletableFuture&amp;lt;Void&amp;gt; stopFuture = CompletableFuture.allOf(
+		return CompletableFuture.allOf(
 			stopTaskMonitorFuture,
 			stopConnectionMonitorFuture,
 			stopLaunchCoordinatorFuture,
 			stopReconciliationCoordinatorFuture);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public CompletableFuture&amp;lt;Void&amp;gt; postStop() {&lt;br/&gt;
+		final CompletableFuture&amp;lt;Void&amp;gt; supportActorsStopFuture = stopSupportingActorsAsync();&lt;/p&gt;

&lt;p&gt; 		final CompletableFuture&amp;lt;Void&amp;gt; terminationFuture = super.postStop();&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I think we should call `super.postStop` only after `supportActorsStopFuture` has been completed. Otherwise we might risk that the parent class shuts some resources down which are used by the support actors.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567085" author="githubbot" created="Thu, 2 Aug 2018 17:06:17 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207294205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207294205&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/test/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManagerTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -807,4 +807,21 @@ public void testDisconnected() throws Exception {&lt;br/&gt;
 			resourceManager.taskRouter.expectMsgClass(Disconnected.class);&lt;br/&gt;
 		}};&lt;br/&gt;
 	}&lt;br/&gt;
+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testClearStateRevokeLeadership() throws Exception {&lt;br/&gt;
+		new Context() {{&lt;br/&gt;
+			MesosWorkerStore.Worker worker1 = MesosWorkerStore.Worker.newWorker(task1).launchWorker(slave1, slave1host);&lt;br/&gt;
+			when(rmServices.workerStore.getFrameworkID()).thenReturn(Option.apply(framework1));&lt;br/&gt;
+			when(rmServices.workerStore.recoverWorkers()).thenReturn(Collections.singletonList(worker1)).thenReturn(Collections.emptyList());&lt;br/&gt;
+&lt;br/&gt;
+			startResourceManager();&lt;br/&gt;
+			rmServices.rmLeaderElectionService.notLeader();&lt;br/&gt;
+			rmServices.grantLeadership();&lt;br/&gt;
+&lt;br/&gt;
+			//resourceManager.stateCleared.await(5, TimeUnit.SECONDS);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Can this line be removed?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567088" author="githubbot" created="Thu, 2 Aug 2018 17:09:49 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207302752&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207302752&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/test/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManagerTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -807,4 +807,21 @@ public void testDisconnected() throws Exception {&lt;br/&gt;
 			resourceManager.taskRouter.expectMsgClass(Disconnected.class);&lt;br/&gt;
 		}};&lt;br/&gt;
 	}&lt;br/&gt;
+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testClearStateRevokeLeadership() throws Exception {&lt;br/&gt;
+		new Context() {{&lt;br/&gt;
+			MesosWorkerStore.Worker worker1 = MesosWorkerStore.Worker.newWorker(task1).launchWorker(slave1, slave1host);&lt;br/&gt;
+			when(rmServices.workerStore.getFrameworkID()).thenReturn(Option.apply(framework1));&lt;br/&gt;
+			when(rmServices.workerStore.recoverWorkers()).thenReturn(Collections.singletonList(worker1)).thenReturn(Collections.emptyList());&lt;br/&gt;
+&lt;br/&gt;
+			startResourceManager();&lt;br/&gt;
+			rmServices.rmLeaderElectionService.notLeader();&lt;br/&gt;
+			rmServices.grantLeadership();&lt;br/&gt;
+&lt;br/&gt;
+			//resourceManager.stateCleared.await(5, TimeUnit.SECONDS);&lt;br/&gt;
+			assertThat(resourceManager.workersInLaunch.size(), equalTo(0));&lt;br/&gt;
+			verify(rmServices.schedulerDriver).stop(true);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Is the test already complete?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567113" author="githubbot" created="Thu, 2 Aug 2018 17:18:53 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207306976&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207306976&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -345,15 +382,20 @@ private void recoverWorkers() throws Exception {&lt;br/&gt;
 		CompletableFuture&amp;lt;Boolean&amp;gt; stopReconciliationCoordinatorFuture = stopActor(reconciliationCoordinator, stopTimeout);&lt;br/&gt;
 		reconciliationCoordinator = null;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I think we need to check whether the supporting actors are not null because we initialize them only after the `clearStateFuture` has been completed. If this takes a bit and someone revokes our leadership in the meantime, `clearState` will be called before the support actors have been created.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567850" author="githubbot" created="Fri, 3 Aug 2018 06:57:47 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207456451&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207456451&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -894,17 +900,21 @@ public void grantLeadership(final UUID newLeaderSessionID) {&lt;/p&gt;

&lt;p&gt; 				// clear the state if we&apos;ve been the leader before&lt;br/&gt;
 				if (getFencingToken() != null) &lt;/p&gt;
{
-					clearState();
+					clearStateInternal();
 				}

&lt;p&gt; 				setFencingToken(newResourceManagerId);&lt;/p&gt;

&lt;p&gt; 				slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;getRpcService().execute(&lt;/li&gt;
	&lt;li&gt;() -&amp;gt;&lt;br/&gt;
+				prepareLeadershipAsync()&lt;br/&gt;
+					.exceptionally(t -&amp;gt; 
{
+						onFatalError(t);
+						return null;
+					}
&lt;p&gt;)&lt;br/&gt;
+					.thenRunAsync(() -&amp;gt;&lt;br/&gt;
 						// confirming the leader session ID might be blocking,&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;leaderElectionService.confirmLeaderSessionID(newLeaderSessionID));&lt;br/&gt;
+						leaderElectionService.confirmLeaderSessionID(newLeaderSessionID), getRpcService().getExecutor());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I don&apos;t understand why it&apos;s needed to check for leadership in `tryAcceptLeadership`. The zk `LeaderElectionService` already does that:&lt;br/&gt;
   ```&lt;br/&gt;
   		if (leaderLatch.hasLeadership()) {&lt;br/&gt;
   			// check if this is an old confirmation call&lt;br/&gt;
   			synchronized (lock) {&lt;br/&gt;
   				if (running) {&lt;br/&gt;
   					if (leaderSessionID.equals(this.issuedLeaderSessionID)) &lt;/p&gt;
{
   						confirmedLeaderSessionID = leaderSessionID;
   						writeLeaderInformation(confirmedLeaderSessionID);
   					}
&lt;p&gt;   				} else {&lt;br/&gt;
   					LOG.debug(&quot;Ignoring the leader session Id {} confirmation, since the &quot; +&lt;br/&gt;
   						&quot;ZooKeeperLeaderElectionService has already been stopped.&quot;, leaderSessionID);&lt;br/&gt;
   				}&lt;br/&gt;
   			}&lt;br/&gt;
   		} else {&lt;br/&gt;
   			LOG.warn(&quot;The leader session ID {} was confirmed even though the &quot; +&lt;br/&gt;
   					&quot;corresponding JobManager was not elected as the leader.&quot;, leaderSessionID);&lt;br/&gt;
   		}&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567871" author="githubbot" created="Fri, 3 Aug 2018 07:24:48 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207461474&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207461474&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -894,17 +900,21 @@ public void grantLeadership(final UUID newLeaderSessionID) {&lt;/p&gt;

&lt;p&gt; 				// clear the state if we&apos;ve been the leader before&lt;br/&gt;
 				if (getFencingToken() != null) &lt;/p&gt;
{
-					clearState();
+					clearStateInternal();
 				}

&lt;p&gt; 				setFencingToken(newResourceManagerId);&lt;/p&gt;

&lt;p&gt; 				slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;getRpcService().execute(&lt;/li&gt;
	&lt;li&gt;() -&amp;gt;&lt;br/&gt;
+				prepareLeadershipAsync()&lt;br/&gt;
+					.exceptionally(t -&amp;gt; 
{
+						onFatalError(t);
+						return null;
+					}
&lt;p&gt;)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   You are right. Fixed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567872" author="githubbot" created="Fri, 3 Aug 2018 07:24:58 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207461505&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207461505&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/test/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManagerTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -807,4 +807,21 @@ public void testDisconnected() throws Exception {&lt;br/&gt;
 			resourceManager.taskRouter.expectMsgClass(Disconnected.class);&lt;br/&gt;
 		}};&lt;br/&gt;
 	}&lt;br/&gt;
+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testClearStateRevokeLeadership() throws Exception {&lt;br/&gt;
+		new Context() {{&lt;br/&gt;
+			MesosWorkerStore.Worker worker1 = MesosWorkerStore.Worker.newWorker(task1).launchWorker(slave1, slave1host);&lt;br/&gt;
+			when(rmServices.workerStore.getFrameworkID()).thenReturn(Option.apply(framework1));&lt;br/&gt;
+			when(rmServices.workerStore.recoverWorkers()).thenReturn(Collections.singletonList(worker1)).thenReturn(Collections.emptyList());&lt;br/&gt;
+&lt;br/&gt;
+			startResourceManager();&lt;br/&gt;
+			rmServices.rmLeaderElectionService.notLeader();&lt;br/&gt;
+			rmServices.grantLeadership();&lt;br/&gt;
+&lt;br/&gt;
+			//resourceManager.stateCleared.await(5, TimeUnit.SECONDS);&lt;br/&gt;
+			assertThat(resourceManager.workersInLaunch.size(), equalTo(0));&lt;br/&gt;
+			verify(rmServices.schedulerDriver).stop(true);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Yes&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567873" author="githubbot" created="Fri, 3 Aug 2018 07:25:01 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207461514&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207461514&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/test/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManagerTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -807,4 +807,21 @@ public void testDisconnected() throws Exception {&lt;br/&gt;
 			resourceManager.taskRouter.expectMsgClass(Disconnected.class);&lt;br/&gt;
 		}};&lt;br/&gt;
 	}&lt;br/&gt;
+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testClearStateRevokeLeadership() throws Exception {&lt;br/&gt;
+		new Context() {{&lt;br/&gt;
+			MesosWorkerStore.Worker worker1 = MesosWorkerStore.Worker.newWorker(task1).launchWorker(slave1, slave1host);&lt;br/&gt;
+			when(rmServices.workerStore.getFrameworkID()).thenReturn(Option.apply(framework1));&lt;br/&gt;
+			when(rmServices.workerStore.recoverWorkers()).thenReturn(Collections.singletonList(worker1)).thenReturn(Collections.emptyList());&lt;br/&gt;
+&lt;br/&gt;
+			startResourceManager();&lt;br/&gt;
+			rmServices.rmLeaderElectionService.notLeader();&lt;br/&gt;
+			rmServices.grantLeadership();&lt;br/&gt;
+&lt;br/&gt;
+			//resourceManager.stateCleared.await(5, TimeUnit.SECONDS);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Yes&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567874" author="githubbot" created="Fri, 3 Aug 2018 07:25:09 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207461541&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207461541&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -345,15 +382,20 @@ private void recoverWorkers() throws Exception &lt;/p&gt;
{
 		CompletableFuture&amp;lt;Boolean&amp;gt; stopReconciliationCoordinatorFuture = stopActor(reconciliationCoordinator, stopTimeout);
 		reconciliationCoordinator = null;
 
-		CompletableFuture&amp;lt;Void&amp;gt; stopFuture = CompletableFuture.allOf(
+		return CompletableFuture.allOf(
 			stopTaskMonitorFuture,
 			stopConnectionMonitorFuture,
 			stopLaunchCoordinatorFuture,
 			stopReconciliationCoordinatorFuture);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public CompletableFuture&amp;lt;Void&amp;gt; postStop() {&lt;br/&gt;
+		final CompletableFuture&amp;lt;Void&amp;gt; supportActorsStopFuture = stopSupportingActorsAsync();&lt;/p&gt;

&lt;p&gt; 		final CompletableFuture&amp;lt;Void&amp;gt; terminationFuture = super.postStop();&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   You are right. Fixed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567875" author="githubbot" created="Fri, 3 Aug 2018 07:25:14 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207461551&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207461551&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -345,15 +382,20 @@ private void recoverWorkers() throws Exception {&lt;br/&gt;
 		CompletableFuture&amp;lt;Boolean&amp;gt; stopReconciliationCoordinatorFuture = stopActor(reconciliationCoordinator, stopTimeout);&lt;br/&gt;
 		reconciliationCoordinator = null;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   You are right. Fixed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567876" author="githubbot" created="Fri, 3 Aug 2018 07:25:23 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207461579&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207461579&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -278,22 +267,76 @@ protected void initialize() throws ResourceManagerException {&lt;br/&gt;
 		catch (IOException e) &lt;/p&gt;
{
 			throw new ResourceManagerException(&quot;Unable to configure the artifact server with TaskManager artifacts.&quot;, e);
 		}
&lt;p&gt;+	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// begin scheduling&lt;/li&gt;
	&lt;li&gt;connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);&lt;/li&gt;
	&lt;li&gt;schedulerDriver.start();&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected CompletableFuture&amp;lt;Void&amp;gt; prepareLeadershipAsync() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+		Preconditions.checkState(initializedMesosConfig != null);++		return clearStateFuture+			.thenRunAsync(() -&amp;gt; {
+				schedulerDriver = initializedMesosConfig.createDriver(
+					new MesosResourceManagerSchedulerCallback(),
+					false);
+
+				// create supporting actors
+				connectionMonitor = createConnectionMonitor();
+				launchCoordinator = createLaunchCoordinator(schedulerDriver, selfActor);
+				reconciliationCoordinator = createReconciliationCoordinator(schedulerDriver);
+				taskMonitor = createTaskMonitor(schedulerDriver);
+			}, getMainThreadExecutor())+			.thenCombineAsync(getWorkersAsync(), (ignored, tasksFromPreviousAttempts) -&amp;gt; {
+				// recover state
+				recoverWorkers(tasksFromPreviousAttempts);
+
+				// begin scheduling
+				connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);
+				schedulerDriver.start();
+
+				LOG.info(&quot;Mesos resource manager started.&quot;);
+				return null;
+			}, getMainThreadExecutor());+	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;Mesos resource manager initialized.&quot;);&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected void clearState() {&lt;br/&gt;
+		schedulerDriver.stop(true);&lt;br/&gt;
+&lt;br/&gt;
+		clearStateFuture = stopSupportingActorsAsync().thenRunAsync(() -&amp;gt; {&lt;br/&gt;
+			workersInNew.clear();&lt;br/&gt;
+			workersInLaunch.clear();&lt;br/&gt;
+			workersBeingReturned.clear();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   That should be safe to do.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567879" author="githubbot" created="Fri, 3 Aug 2018 07:26:15 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207461579&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207461579&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -278,22 +267,76 @@ protected void initialize() throws ResourceManagerException {&lt;br/&gt;
 		catch (IOException e) &lt;/p&gt;
{
 			throw new ResourceManagerException(&quot;Unable to configure the artifact server with TaskManager artifacts.&quot;, e);
 		}
&lt;p&gt;+	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// begin scheduling&lt;/li&gt;
	&lt;li&gt;connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);&lt;/li&gt;
	&lt;li&gt;schedulerDriver.start();&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected CompletableFuture&amp;lt;Void&amp;gt; prepareLeadershipAsync() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+		Preconditions.checkState(initializedMesosConfig != null);++		return clearStateFuture+			.thenRunAsync(() -&amp;gt; {
+				schedulerDriver = initializedMesosConfig.createDriver(
+					new MesosResourceManagerSchedulerCallback(),
+					false);
+
+				// create supporting actors
+				connectionMonitor = createConnectionMonitor();
+				launchCoordinator = createLaunchCoordinator(schedulerDriver, selfActor);
+				reconciliationCoordinator = createReconciliationCoordinator(schedulerDriver);
+				taskMonitor = createTaskMonitor(schedulerDriver);
+			}, getMainThreadExecutor())+			.thenCombineAsync(getWorkersAsync(), (ignored, tasksFromPreviousAttempts) -&amp;gt; {
+				// recover state
+				recoverWorkers(tasksFromPreviousAttempts);
+
+				// begin scheduling
+				connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);
+				schedulerDriver.start();
+
+				LOG.info(&quot;Mesos resource manager started.&quot;);
+				return null;
+			}, getMainThreadExecutor());+	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;Mesos resource manager initialized.&quot;);&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected void clearState() {&lt;br/&gt;
+		schedulerDriver.stop(true);&lt;br/&gt;
+&lt;br/&gt;
+		clearStateFuture = stopSupportingActorsAsync().thenRunAsync(() -&amp;gt; {&lt;br/&gt;
+			workersInNew.clear();&lt;br/&gt;
+			workersInLaunch.clear();&lt;br/&gt;
+			workersBeingReturned.clear();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   That should be safe to do. Fixed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567880" author="githubbot" created="Fri, 3 Aug 2018 07:27:53 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207462105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207462105&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -734,8 +734,14 @@ private void clearState() {&lt;br/&gt;
 		} catch (Exception e) &lt;/p&gt;
{
 			onFatalError(new ResourceManagerException(&quot;Could not properly clear the job leader id service.&quot;, e));
 		}
&lt;p&gt;+		clearState();&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Callback to clear state on leadership revocation.&lt;br/&gt;
+	 */&lt;br/&gt;
+	protected void clearState() {}&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   We could also make the interface asynchronous and let the `ResourceManager` handle the waiting in grant leadership.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567885" author="githubbot" created="Fri, 3 Aug 2018 07:30:51 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207462086&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207462086&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -391,13 +391,7 @@ private void recoverWorkers(final List&amp;lt;MesosWorkerStore.Worker&amp;gt; tasksFromPreviou&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public CompletableFuture&amp;lt;Void&amp;gt; postStop() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final CompletableFuture&amp;lt;Void&amp;gt; supportActorsStopFuture = stopSupportingActorsAsync();&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;final CompletableFuture&amp;lt;Void&amp;gt; terminationFuture = super.postStop();&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;return supportActorsStopFuture.thenCombine(&lt;/li&gt;
	&lt;li&gt;terminationFuture,&lt;/li&gt;
	&lt;li&gt;(Void voidA, Void voidB) -&amp;gt; null);&lt;br/&gt;
+		return super.postStop().thenCompose((ignored) -&amp;gt; stopSupportingActorsAsync());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I think it should be the other way around. First stop sub class resources and then parent class resources.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567889" author="githubbot" created="Fri, 3 Aug 2018 07:33:09 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207463112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207463112&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -734,8 +734,14 @@ private void clearState() {&lt;br/&gt;
 		} catch (Exception e) &lt;/p&gt;
{
 			onFatalError(new ResourceManagerException(&quot;Could not properly clear the job leader id service.&quot;, e));
 		}
&lt;p&gt;+		clearState();&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Callback to clear state on leadership revocation.&lt;br/&gt;
+	 */&lt;br/&gt;
+	protected void clearState() {}&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   True, I would like this a bit more, because then we don&apos;t duplicate this logic over multiple different `ResourceManager` implementations if needed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567897" author="githubbot" created="Fri, 3 Aug 2018 07:37:14 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207463934&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207463934&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -894,17 +900,21 @@ public void grantLeadership(final UUID newLeaderSessionID) {&lt;/p&gt;

&lt;p&gt; 				// clear the state if we&apos;ve been the leader before&lt;br/&gt;
 				if (getFencingToken() != null) &lt;/p&gt;
{
-					clearState();
+					clearStateInternal();
 				}

&lt;p&gt; 				setFencingToken(newResourceManagerId);&lt;/p&gt;

&lt;p&gt; 				slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;getRpcService().execute(&lt;/li&gt;
	&lt;li&gt;() -&amp;gt;&lt;br/&gt;
+				prepareLeadershipAsync()&lt;br/&gt;
+					.exceptionally(t -&amp;gt; 
{
+						onFatalError(t);
+						return null;
+					}
&lt;p&gt;)&lt;br/&gt;
+					.thenRunAsync(() -&amp;gt;&lt;br/&gt;
 						// confirming the leader session ID might be blocking,&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;leaderElectionService.confirmLeaderSessionID(newLeaderSessionID));&lt;br/&gt;
+						leaderElectionService.confirmLeaderSessionID(newLeaderSessionID), getRpcService().getExecutor());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   The check would help to guard against a concurrent revoke leadership which is triggered just before the aynchronous grant leadership call is executed. That way we would not unnecessarily initialize internal components which would be stopped by the revoke leadership async callback. At the moment this is not very likely to happen but if we make `clearState` asynchronous and wait in the `grantLeadership` method to complete the cleanup before calling the leadership callback, it gets more and more likely.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567899" author="githubbot" created="Fri, 3 Aug 2018 07:41:01 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207464729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207464729&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -391,13 +391,7 @@ private void recoverWorkers(final List&amp;lt;MesosWorkerStore.Worker&amp;gt; tasksFromPreviou&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public CompletableFuture&amp;lt;Void&amp;gt; postStop() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final CompletableFuture&amp;lt;Void&amp;gt; supportActorsStopFuture = stopSupportingActorsAsync();&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;final CompletableFuture&amp;lt;Void&amp;gt; terminationFuture = super.postStop();&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;return supportActorsStopFuture.thenCombine(&lt;/li&gt;
	&lt;li&gt;terminationFuture,&lt;/li&gt;
	&lt;li&gt;(Void voidA, Void voidB) -&amp;gt; null);&lt;br/&gt;
+		return super.postStop().thenCompose((ignored) -&amp;gt; stopSupportingActorsAsync());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   m(&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567900" author="githubbot" created="Fri, 3 Aug 2018 07:41:13 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; WIP &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207464729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207464729&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -391,13 +391,7 @@ private void recoverWorkers(final List&amp;lt;MesosWorkerStore.Worker&amp;gt; tasksFromPreviou&lt;/p&gt;

&lt;p&gt; 	@Override&lt;br/&gt;
 	public CompletableFuture&amp;lt;Void&amp;gt; postStop() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final CompletableFuture&amp;lt;Void&amp;gt; supportActorsStopFuture = stopSupportingActorsAsync();&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;final CompletableFuture&amp;lt;Void&amp;gt; terminationFuture = super.postStop();&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;return supportActorsStopFuture.thenCombine(&lt;/li&gt;
	&lt;li&gt;terminationFuture,&lt;/li&gt;
	&lt;li&gt;(Void voidA, Void voidB) -&amp;gt; null);&lt;br/&gt;
+		return super.postStop().thenCompose((ignored) -&amp;gt; stopSupportingActorsAsync());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   &#129318;&#8205;&#9794;&#65039; you are right&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16568002" author="githubbot" created="Fri, 3 Aug 2018 09:32:09 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; Mesos resource manager unable to connect to master after failover &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207491799&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207491799&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -892,30 +896,48 @@ protected void onFatalError(Throwable t) {&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Override&lt;br/&gt;
 	public void grantLeadership(final UUID newLeaderSessionID) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;runAsyncWithoutFencing(&lt;/li&gt;
	&lt;li&gt;() -&amp;gt; {&lt;/li&gt;
	&lt;li&gt;final ResourceManagerId newResourceManagerId = ResourceManagerId.fromUuid(newLeaderSessionID);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;log.info(&quot;ResourceManager {} was granted leadership with fencing token {}&quot;, getAddress(), newResourceManagerId);&lt;br/&gt;
+		final CompletableFuture&amp;lt;Boolean&amp;gt; acceptLeadershipFuture = CompletableFuture.supplyAsync(&lt;br/&gt;
+			() -&amp;gt; tryAcceptLeadership(newLeaderSessionID),&lt;br/&gt;
+			getUnfencedMainThreadExecutor()).thenCompose(Function.identity());&lt;br/&gt;
+&lt;br/&gt;
+		final CompletableFuture&amp;lt;Void&amp;gt; confirmationFuture = acceptLeadershipFuture.thenAcceptAsync(&lt;br/&gt;
+			(acceptLeadership) -&amp;gt; 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				if (acceptLeadership) {
+					// confirming the leader session ID might be blocking,
+					leaderElectionService.confirmLeaderSessionID(newLeaderSessionID);
+				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;,&lt;br/&gt;
+			getRpcService().getExecutor());&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// clear the state if we&apos;ve been the leader before&lt;/li&gt;
	&lt;li&gt;if (getFencingToken() != null) {&lt;/li&gt;
	&lt;li&gt;clearStateInternal();&lt;br/&gt;
+		confirmationFuture.whenComplete(&lt;br/&gt;
+			(Void ignored, Throwable throwable) -&amp;gt; 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				if (throwable != null) {
+					onFatalError(ExceptionUtils.stripCompletionException(throwable));
 				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
+	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;setFencingToken(newResourceManagerId);&lt;br/&gt;
+	private CompletableFuture&amp;lt;Boolean&amp;gt; tryAcceptLeadership(final UUID newLeaderSessionID) {&lt;br/&gt;
+		if (leaderElectionService.hasLeadership(newLeaderSessionID)) {&lt;br/&gt;
+			final ResourceManagerId newResourceManagerId = ResourceManagerId.fromUuid(newLeaderSessionID);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;br/&gt;
+			log.info(&quot;ResourceManager {} was granted leadership with fencing token {}&quot;, getAddress(), newResourceManagerId);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;prepareLeadershipAsync()&lt;/li&gt;
	&lt;li&gt;.thenRunAsync(() -&amp;gt;&lt;/li&gt;
	&lt;li&gt;// confirming the leader session ID might be blocking,&lt;/li&gt;
	&lt;li&gt;leaderElectionService.confirmLeaderSessionID(newLeaderSessionID), getRpcService().getExecutor())&lt;/li&gt;
	&lt;li&gt;.exceptionally(t -&amp;gt; 
{
-						onFatalError(t);
-						return null;
-					}
&lt;p&gt;);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
+			// clear the state if we&apos;ve been the leader before&lt;br/&gt;
+			if (getFencingToken() != null) 
{
+				clearStateInternal();
+			}
&lt;p&gt;+&lt;br/&gt;
+			setFencingToken(newResourceManagerId);&lt;br/&gt;
+&lt;br/&gt;
+			slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;br/&gt;
+&lt;br/&gt;
+			return clearStateFuture&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Shouldn&apos;t we wait for the completion of the `clearStateFuture` before setting the new fencing token and starting components? Otherwise, these newly started components might interact with the ones being shut down.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16568132" author="githubbot" created="Fri, 3 Aug 2018 11:59:53 +0000"  >&lt;p&gt;GJL commented on issue #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; Mesos resource manager unable to connect to master after failover &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#issuecomment-410232380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#issuecomment-410232380&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @liurenjie1024 Do you also want to have final look? The fix works in my cluster tests.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16568133" author="githubbot" created="Fri, 3 Aug 2018 12:00:32 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; Mesos resource manager unable to connect to master after failover &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464#discussion_r207522805&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464#discussion_r207522805&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -892,30 +896,48 @@ protected void onFatalError(Throwable t) {&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Override&lt;br/&gt;
 	public void grantLeadership(final UUID newLeaderSessionID) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;runAsyncWithoutFencing(&lt;/li&gt;
	&lt;li&gt;() -&amp;gt; {&lt;/li&gt;
	&lt;li&gt;final ResourceManagerId newResourceManagerId = ResourceManagerId.fromUuid(newLeaderSessionID);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;log.info(&quot;ResourceManager {} was granted leadership with fencing token {}&quot;, getAddress(), newResourceManagerId);&lt;br/&gt;
+		final CompletableFuture&amp;lt;Boolean&amp;gt; acceptLeadershipFuture = CompletableFuture.supplyAsync(&lt;br/&gt;
+			() -&amp;gt; tryAcceptLeadership(newLeaderSessionID),&lt;br/&gt;
+			getUnfencedMainThreadExecutor()).thenCompose(Function.identity());&lt;br/&gt;
+&lt;br/&gt;
+		final CompletableFuture&amp;lt;Void&amp;gt; confirmationFuture = acceptLeadershipFuture.thenAcceptAsync(&lt;br/&gt;
+			(acceptLeadership) -&amp;gt; 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				if (acceptLeadership) {
+					// confirming the leader session ID might be blocking,
+					leaderElectionService.confirmLeaderSessionID(newLeaderSessionID);
+				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;,&lt;br/&gt;
+			getRpcService().getExecutor());&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// clear the state if we&apos;ve been the leader before&lt;/li&gt;
	&lt;li&gt;if (getFencingToken() != null) {&lt;/li&gt;
	&lt;li&gt;clearStateInternal();&lt;br/&gt;
+		confirmationFuture.whenComplete(&lt;br/&gt;
+			(Void ignored, Throwable throwable) -&amp;gt; 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				if (throwable != null) {
+					onFatalError(ExceptionUtils.stripCompletionException(throwable));
 				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
+	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;setFencingToken(newResourceManagerId);&lt;br/&gt;
+	private CompletableFuture&amp;lt;Boolean&amp;gt; tryAcceptLeadership(final UUID newLeaderSessionID) {&lt;br/&gt;
+		if (leaderElectionService.hasLeadership(newLeaderSessionID)) {&lt;br/&gt;
+			final ResourceManagerId newResourceManagerId = ResourceManagerId.fromUuid(newLeaderSessionID);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;br/&gt;
+			log.info(&quot;ResourceManager {} was granted leadership with fencing token {}&quot;, getAddress(), newResourceManagerId);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;prepareLeadershipAsync()&lt;/li&gt;
	&lt;li&gt;.thenRunAsync(() -&amp;gt;&lt;/li&gt;
	&lt;li&gt;// confirming the leader session ID might be blocking,&lt;/li&gt;
	&lt;li&gt;leaderElectionService.confirmLeaderSessionID(newLeaderSessionID), getRpcService().getExecutor())&lt;/li&gt;
	&lt;li&gt;.exceptionally(t -&amp;gt; 
{
-						onFatalError(t);
-						return null;
-					}
&lt;p&gt;);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
+			// clear the state if we&apos;ve been the leader before&lt;br/&gt;
+			if (getFencingToken() != null) 
{
+				clearStateInternal();
+			}
&lt;p&gt;+&lt;br/&gt;
+			setFencingToken(newResourceManagerId);&lt;br/&gt;
+&lt;br/&gt;
+			slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;br/&gt;
+&lt;br/&gt;
+			return clearStateFuture&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   fixed&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16568272" author="githubbot" created="Fri, 3 Aug 2018 14:38:30 +0000"  >&lt;p&gt;asfgit closed pull request #6464: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;mesos&amp;#93;&lt;/span&gt; Mesos resource manager unable to connect to master after failover &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6464&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6464&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java b/flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
index e24214d28c1..bc281348fa4 100644&lt;br/&gt;
&amp;#8212; a/flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
+++ b/flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
@@ -84,6 +84,7 @@&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.concurrent.CompletableFuture;&lt;br/&gt;
+import java.util.concurrent.CompletionException;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt; import scala.Option;&lt;br/&gt;
@@ -138,6 +139,8 @@&lt;br/&gt;
 	final Map&amp;lt;ResourceID, MesosWorkerStore.Worker&amp;gt; workersInLaunch;&lt;br/&gt;
 	final Map&amp;lt;ResourceID, MesosWorkerStore.Worker&amp;gt; workersBeingReturned;&lt;/p&gt;

&lt;p&gt;+	private MesosConfiguration initializedMesosConfig;&lt;br/&gt;
+&lt;br/&gt;
 	public MesosResourceManager(&lt;br/&gt;
 			// base class&lt;br/&gt;
 			RpcService rpcService,&lt;br/&gt;
@@ -220,9 +223,6 @@ protected ActorRef createReconciliationCoordinator(SchedulerDriver schedulerDriv&lt;br/&gt;
 	//  Resource Manager overrides&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Starts the Mesos-specifics.&lt;/li&gt;
	&lt;li&gt;*/&lt;br/&gt;
 	@Override&lt;br/&gt;
 	protected void initialize() throws ResourceManagerException {&lt;br/&gt;
 		// create and start the worker store&lt;br/&gt;
@@ -233,9 +233,7 @@ protected void initialize() throws ResourceManagerException 
{
 			throw new ResourceManagerException(&quot;Unable to initialize the worker store.&quot;, e);
 		}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// register with Mesos&lt;/li&gt;
	&lt;li&gt;// TODO : defer connection until RM acquires leadership&lt;br/&gt;
-&lt;br/&gt;
+		// Prepare to register with Mesos&lt;br/&gt;
 		Protos.FrameworkInfo.Builder frameworkInfo = mesosConfig.frameworkInfo()&lt;br/&gt;
 			.clone()&lt;br/&gt;
 			.setCheckpoint(true);&lt;br/&gt;
@@ -251,49 +249,86 @@ protected void initialize() throws ResourceManagerException 
{
 			throw new ResourceManagerException(&quot;Unable to recover the framework ID.&quot;, e);
 		}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;MesosConfiguration initializedMesosConfig = mesosConfig.withFrameworkInfo(frameworkInfo);&lt;br/&gt;
+		initializedMesosConfig = mesosConfig.withFrameworkInfo(frameworkInfo);&lt;br/&gt;
 		MesosConfiguration.logMesosConfig(LOG, initializedMesosConfig);&lt;br/&gt;
+&lt;br/&gt;
+		this.selfActor = createSelfActor();&lt;br/&gt;
+&lt;br/&gt;
+		// configure the artifact server to serve the TM container artifacts&lt;br/&gt;
+		try 
{
+			LaunchableMesosWorker.configureArtifactServer(artifactServer, taskManagerContainerSpec);
+		}
&lt;p&gt;+		catch (IOException e) &lt;/p&gt;
{
+			throw new ResourceManagerException(&quot;Unable to configure the artifact server with TaskManager artifacts.&quot;, e);
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected CompletableFuture&amp;lt;Void&amp;gt; prepareLeadershipAsync() {&lt;br/&gt;
+		Preconditions.checkState(initializedMesosConfig != null);&lt;br/&gt;
+&lt;br/&gt;
 		schedulerDriver = initializedMesosConfig.createDriver(&lt;br/&gt;
 			new MesosResourceManagerSchedulerCallback(),&lt;br/&gt;
 			false);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		// create supporting actors&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;selfActor = createSelfActor();&lt;br/&gt;
 		connectionMonitor = createConnectionMonitor();&lt;br/&gt;
 		launchCoordinator = createLaunchCoordinator(schedulerDriver, selfActor);&lt;br/&gt;
 		reconciliationCoordinator = createReconciliationCoordinator(schedulerDriver);&lt;br/&gt;
 		taskMonitor = createTaskMonitor(schedulerDriver);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// recover state&lt;/li&gt;
	&lt;li&gt;try 
{
-			recoverWorkers();
-		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
-			throw new ResourceManagerException(&quot;Unable to recover Mesos worker state.&quot;, e);
-		}
&lt;p&gt;+		return getWorkersAsync().thenApplyAsync((tasksFromPreviousAttempts) -&amp;gt; {&lt;br/&gt;
+			// recover state&lt;br/&gt;
+			recoverWorkers(tasksFromPreviousAttempts);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// configure the artifact server to serve the TM container artifacts&lt;/li&gt;
	&lt;li&gt;try 
{
-			LaunchableMesosWorker.configureArtifactServer(artifactServer, taskManagerContainerSpec);
-		}&lt;/li&gt;
	&lt;li&gt;catch (IOException e) 
{
-			throw new ResourceManagerException(&quot;Unable to configure the artifact server with TaskManager artifacts.&quot;, e);
-		}
&lt;p&gt;+			// begin scheduling&lt;br/&gt;
+			connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);&lt;br/&gt;
+			schedulerDriver.start();&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// begin scheduling&lt;/li&gt;
	&lt;li&gt;connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);&lt;/li&gt;
	&lt;li&gt;schedulerDriver.start();&lt;br/&gt;
+			LOG.info(&quot;Mesos resource manager started.&quot;);&lt;br/&gt;
+			return null;&lt;br/&gt;
+		}, getMainThreadExecutor());&lt;br/&gt;
+	}&lt;br/&gt;
+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected CompletableFuture&amp;lt;Void&amp;gt; clearStateAsync() 
{
+		schedulerDriver.stop(true);
+
+		workersInNew.clear();
+		workersInLaunch.clear();
+		workersBeingReturned.clear();
 
-		LOG.info(&quot;Mesos resource manager initialized.&quot;);
+		return stopSupportingActorsAsync();
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Recover framework/worker information persisted by a prior incarnation of the RM.&lt;br/&gt;
+	 * Fetches framework/worker information persisted by a prior incarnation of the RM.&lt;br/&gt;
 	 */&lt;/li&gt;
	&lt;li&gt;private void recoverWorkers() throws Exception {&lt;br/&gt;
+	private CompletableFuture&amp;lt;List&amp;lt;MesosWorkerStore.Worker&amp;gt;&amp;gt; getWorkersAsync() {&lt;br/&gt;
 		// if this resource manager is recovering from failure,&lt;br/&gt;
 		// then some worker tasks are most likely still alive and we can re-obtain them&lt;/li&gt;
	&lt;li&gt;final List&amp;lt;MesosWorkerStore.Worker&amp;gt; tasksFromPreviousAttempts = workerStore.recoverWorkers();&lt;br/&gt;
+		return CompletableFuture.supplyAsync(() -&amp;gt; {&lt;br/&gt;
+			try {&lt;br/&gt;
+				final List&amp;lt;MesosWorkerStore.Worker&amp;gt; tasksFromPreviousAttempts = workerStore.recoverWorkers();&lt;br/&gt;
+				for (final MesosWorkerStore.Worker worker : tasksFromPreviousAttempts) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+					if (worker.state() == MesosWorkerStore.WorkerState.New) {
+						// remove new workers because allocation requests are transient
+						workerStore.removeWorker(worker.taskID());
+					}+				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+				return tasksFromPreviousAttempts;&lt;br/&gt;
+			} catch (final Exception e) &lt;/p&gt;
{
+				throw new CompletionException(new ResourceManagerException(e));
+			}
&lt;p&gt;+		}, getRpcService().getExecutor());&lt;br/&gt;
+	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+	/**&lt;br/&gt;
+	 * Recovers given framework/worker information.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @see #getWorkersAsync()&lt;br/&gt;
+	 */&lt;br/&gt;
+	private void recoverWorkers(final List&amp;lt;MesosWorkerStore.Worker&amp;gt; tasksFromPreviousAttempts) {&lt;br/&gt;
 		assert(workersInNew.isEmpty());&lt;br/&gt;
 		assert(workersInLaunch.isEmpty());&lt;br/&gt;
 		assert(workersBeingReturned.isEmpty());&lt;br/&gt;
@@ -304,15 +339,10 @@ private void recoverWorkers() throws Exception {&lt;br/&gt;
 			List&amp;lt;Tuple2&amp;lt;TaskRequest, String&amp;gt;&amp;gt; toAssign = new ArrayList&amp;lt;&amp;gt;(tasksFromPreviousAttempts.size());&lt;/p&gt;

&lt;p&gt; 			for (final MesosWorkerStore.Worker worker : tasksFromPreviousAttempts) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LaunchableMesosWorker launchable = createLaunchableMesosWorker(worker.taskID(), worker.profile());&lt;br/&gt;
-&lt;br/&gt;
 				switch(worker.state()) {&lt;/li&gt;
	&lt;li&gt;case New:&lt;/li&gt;
	&lt;li&gt;// remove new workers because allocation requests are transient&lt;/li&gt;
	&lt;li&gt;workerStore.removeWorker(worker.taskID());&lt;/li&gt;
	&lt;li&gt;break;&lt;br/&gt;
 					case Launched:&lt;br/&gt;
 						workersInLaunch.put(extractResourceID(worker.taskID()), worker);&lt;br/&gt;
+						final LaunchableMesosWorker launchable = createLaunchableMesosWorker(worker.taskID(), worker.profile());&lt;br/&gt;
 						toAssign.add(new Tuple2&amp;lt;&amp;gt;(launchable.taskRequest(), worker.hostname().get()));&lt;br/&gt;
 						break;&lt;br/&gt;
 					case Released:&lt;br/&gt;
@@ -329,8 +359,7 @@ private void recoverWorkers() throws Exception {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public CompletableFuture&amp;lt;Void&amp;gt; postStop() {&lt;br/&gt;
+	private CompletableFuture&amp;lt;Void&amp;gt; stopSupportingActorsAsync() {&lt;br/&gt;
 		FiniteDuration stopTimeout = new FiniteDuration(5L, TimeUnit.SECONDS);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		CompletableFuture&amp;lt;Boolean&amp;gt; stopTaskMonitorFuture = stopActor(taskMonitor, stopTimeout);&lt;br/&gt;
@@ -345,23 +374,23 @@ private void recoverWorkers() throws Exception &lt;/p&gt;
{
 		CompletableFuture&amp;lt;Boolean&amp;gt; stopReconciliationCoordinatorFuture = stopActor(reconciliationCoordinator, stopTimeout);
 		reconciliationCoordinator = null;
 
-		CompletableFuture&amp;lt;Void&amp;gt; stopFuture = CompletableFuture.allOf(
+		return CompletableFuture.allOf(
 			stopTaskMonitorFuture,
 			stopConnectionMonitorFuture,
 			stopLaunchCoordinatorFuture,
 			stopReconciliationCoordinatorFuture);
+	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final CompletableFuture&amp;lt;Void&amp;gt; terminationFuture = super.postStop();&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;return stopFuture.thenCombine(&lt;/li&gt;
	&lt;li&gt;terminationFuture,&lt;/li&gt;
	&lt;li&gt;(Void voidA, Void voidB) -&amp;gt; null);&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public CompletableFuture&amp;lt;Void&amp;gt; postStop() 
{
+		return stopSupportingActorsAsync().thenCompose((ignored) -&amp;gt; super.postStop());
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Override&lt;br/&gt;
 	protected void internalDeregisterApplication(&lt;br/&gt;
 			ApplicationStatus finalStatus,&lt;br/&gt;
 			@Nullable String diagnostics) throws ResourceManagerException {&lt;br/&gt;
+&lt;br/&gt;
 		LOG.info(&quot;Shutting down and unregistering as a Mesos framework.&quot;);&lt;/p&gt;

&lt;p&gt; 		Exception exception = null;&lt;br/&gt;
@@ -627,10 +656,15 @@ public void taskTerminated(TaskMonitor.TaskTerminated message) {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tries to shut down the given actor gracefully.&lt;br/&gt;
 	 *&lt;/li&gt;
	&lt;li&gt;@param actorRef specifying the actor to shut down&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @param timeout for the graceful shut down&lt;/li&gt;
	&lt;li&gt;* @return Future containing the result of the graceful shut down&lt;br/&gt;
+	 * @param timeout  for the graceful shut down&lt;br/&gt;
+	 * @return A future that finishes with 
{@code true}
&lt;p&gt; iff. the actor could be stopped gracefully&lt;br/&gt;
+	 * or &lt;/p&gt;
{@code actorRef}
&lt;p&gt; was &lt;/p&gt;
{@code null}
&lt;p&gt;.&lt;br/&gt;
 	 */&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;private CompletableFuture&amp;lt;Boolean&amp;gt; stopActor(final ActorRef actorRef, FiniteDuration timeout) {&lt;br/&gt;
+	private CompletableFuture&amp;lt;Boolean&amp;gt; stopActor(@Nullable final ActorRef actorRef, FiniteDuration timeout) {&lt;br/&gt;
+		if (actorRef == null) 
{
+			return CompletableFuture.completedFuture(true);
+		}
&lt;p&gt;+&lt;br/&gt;
 		return FutureUtils.toJava(Patterns.gracefulStop(actorRef, timeout))&lt;br/&gt;
 			.exceptionally(&lt;br/&gt;
 				(Throwable throwable) -&amp;gt; {&lt;br/&gt;
@@ -639,7 +673,7 @@ public void taskTerminated(TaskMonitor.TaskTerminated message) {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 					log.warn(&quot;Could not stop actor {} gracefully.&quot;, actorRef.path(), throwable);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return true;&lt;br/&gt;
+					return false;&lt;br/&gt;
 				}&lt;br/&gt;
 			);&lt;br/&gt;
 	}&lt;br/&gt;
@@ -794,7 +828,7 @@ public void run() {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		@Override&lt;br/&gt;
 		public void disconnected(SchedulerDriver driver) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;runAsync(new Runnable() {&lt;br/&gt;
+			runAsyncWithoutFencing(new Runnable() {&lt;br/&gt;
 				@Override&lt;br/&gt;
 				public void run() {&lt;br/&gt;
 					MesosResourceManager.this.disconnected(new Disconnected());&lt;br/&gt;
diff --git a/flink-mesos/src/test/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManagerTest.java b/flink-mesos/src/test/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManagerTest.java&lt;br/&gt;
index 5af3fa0a7d1..171e4087ddc 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-mesos/src/test/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManagerTest.java&lt;br/&gt;
+++ b/flink-mesos/src/test/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManagerTest.java&lt;br/&gt;
@@ -505,6 +505,7 @@ public void registerJobMaster(MockJobMaster jobMaster) throws Exception  
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: { 		@Override 		public void close() throws Exception {
 			rpcService.stopService().get();
+			fatalErrorHandler.rethrowError();
 		} 	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -807,4 +808,24 @@ public void testDisconnected() throws Exception {&lt;br/&gt;
 			resourceManager.taskRouter.expectMsgClass(Disconnected.class);&lt;br/&gt;
 		}};&lt;br/&gt;
 	}&lt;br/&gt;
+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testClearStateAfterRevokeLeadership() throws Exception {&lt;br/&gt;
+		new Context() {{&lt;br/&gt;
+			final MesosWorkerStore.Worker worker1 = MesosWorkerStore.Worker.newWorker(task1);&lt;br/&gt;
+			final MesosWorkerStore.Worker worker2 = MesosWorkerStore.Worker.newWorker(task2).launchWorker(slave1, slave1host);&lt;br/&gt;
+			final MesosWorkerStore.Worker worker3 = MesosWorkerStore.Worker.newWorker(task3).launchWorker(slave1, slave1host).releaseWorker();&lt;br/&gt;
+			when(rmServices.workerStore.getFrameworkID()).thenReturn(Option.apply(framework1));&lt;br/&gt;
+			when(rmServices.workerStore.recoverWorkers()).thenReturn(Arrays.asList(worker1, worker2, worker3)).thenReturn(Collections.emptyList());&lt;br/&gt;
+&lt;br/&gt;
+			startResourceManager();&lt;br/&gt;
+			rmServices.rmLeaderElectionService.notLeader();&lt;br/&gt;
+			rmServices.grantLeadership();&lt;br/&gt;
+&lt;br/&gt;
+			assertThat(resourceManager.workersInNew.size(), equalTo(0));&lt;br/&gt;
+			assertThat(resourceManager.workersInLaunch.size(), equalTo(0));&lt;br/&gt;
+			assertThat(resourceManager.workersBeingReturned.size(), equalTo(0));&lt;br/&gt;
+			verify(rmServices.schedulerDriver).stop(true);&lt;br/&gt;
+		}};&lt;br/&gt;
+	}&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java b/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
index a992632b666..7a54224e59b 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
@@ -139,6 +139,14 @@&lt;br/&gt;
 	/** All registered listeners for status updates of the ResourceManager. */&lt;br/&gt;
 	private ConcurrentMap&amp;lt;String, InfoMessageListenerRpcGateway&amp;gt; infoMessageListeners;&lt;/p&gt;

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Represents asynchronous state clearing work.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @see #clearStateAsync()&lt;br/&gt;
+	 * @see #clearStateInternal()&lt;br/&gt;
+	 */&lt;br/&gt;
+	private CompletableFuture&amp;lt;Void&amp;gt; clearStateFuture = CompletableFuture.completedFuture(null);&lt;br/&gt;
+&lt;br/&gt;
 	public ResourceManager(&lt;br/&gt;
 			RpcService rpcService,&lt;br/&gt;
 			String resourceManagerEndpointId,&lt;br/&gt;
@@ -192,6 +200,8 @@ public void start() throws Exception {&lt;/p&gt;

&lt;p&gt; 		leaderElectionService = highAvailabilityServices.getResourceManagerLeaderElectionService();&lt;/p&gt;

&lt;p&gt;+		initialize();&lt;br/&gt;
+&lt;br/&gt;
 		try &lt;/p&gt;
{
 			leaderElectionService.start(this);
 		}
&lt;p&gt; catch (Exception e) {&lt;br/&gt;
@@ -203,8 +213,6 @@ public void start() throws Exception {&lt;br/&gt;
 		} catch (Exception e) &lt;/p&gt;
{
 			throw new ResourceManagerException(&quot;Could not start the job leader id service.&quot;, e);
 		}
&lt;p&gt;-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;initialize();&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	@Override&lt;br/&gt;
@@ -233,7 +241,7 @@ public void start() throws Exception &lt;/p&gt;
{
 			exception = ExceptionUtils.firstOrSuppressed(e, exception);
 		}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;clearState();&lt;br/&gt;
+		clearStateInternal();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		if (exception != null) {&lt;br/&gt;
 			return FutureUtils.completedExceptionally(&lt;br/&gt;
@@ -724,7 +732,7 @@ public void requestHeartbeat(ResourceID resourceID, Void payload) {&lt;br/&gt;
 		}&lt;br/&gt;
 	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void clearState() {&lt;br/&gt;
+	private void clearStateInternal() {&lt;br/&gt;
 		jobManagerRegistrations.clear();&lt;br/&gt;
 		jmResourceIdRegistrations.clear();&lt;br/&gt;
 		taskExecutors.clear();&lt;br/&gt;
@@ -734,6 +742,7 @@ private void clearState() {&lt;br/&gt;
 		} catch (Exception e) 
{
 			onFatalError(new ResourceManagerException(&quot;Could not properly clear the job leader id service.&quot;, e));
 		}
&lt;p&gt;+		clearStateFuture = clearStateAsync();&lt;br/&gt;
 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;br/&gt;
@@ -886,26 +895,45 @@ protected void onFatalError(Throwable t) {&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Override&lt;br/&gt;
 	public void grantLeadership(final UUID newLeaderSessionID) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;runAsyncWithoutFencing(&lt;/li&gt;
	&lt;li&gt;() -&amp;gt; {&lt;/li&gt;
	&lt;li&gt;final ResourceManagerId newResourceManagerId = ResourceManagerId.fromUuid(newLeaderSessionID);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;log.info(&quot;ResourceManager {} was granted leadership with fencing token {}&quot;, getAddress(), newResourceManagerId);&lt;br/&gt;
+		final CompletableFuture&amp;lt;Boolean&amp;gt; acceptLeadershipFuture = clearStateFuture&lt;br/&gt;
+			.thenComposeAsync((ignored) -&amp;gt; tryAcceptLeadership(newLeaderSessionID), getUnfencedMainThreadExecutor());&lt;br/&gt;
+&lt;br/&gt;
+		final CompletableFuture&amp;lt;Void&amp;gt; confirmationFuture = acceptLeadershipFuture.thenAcceptAsync(&lt;br/&gt;
+			(acceptLeadership) -&amp;gt; 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				if (acceptLeadership) {
+					// confirming the leader session ID might be blocking,
+					leaderElectionService.confirmLeaderSessionID(newLeaderSessionID);
+				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;,&lt;br/&gt;
+			getRpcService().getExecutor());&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// clear the state if we&apos;ve been the leader before&lt;/li&gt;
	&lt;li&gt;if (getFencingToken() != null) {&lt;/li&gt;
	&lt;li&gt;clearState();&lt;br/&gt;
+		confirmationFuture.whenComplete(&lt;br/&gt;
+			(Void ignored, Throwable throwable) -&amp;gt; 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				if (throwable != null) {
+					onFatalError(ExceptionUtils.stripCompletionException(throwable));
 				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
+	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;setFencingToken(newResourceManagerId);&lt;br/&gt;
+	private CompletableFuture&amp;lt;Boolean&amp;gt; tryAcceptLeadership(final UUID newLeaderSessionID) {&lt;br/&gt;
+		if (leaderElectionService.hasLeadership(newLeaderSessionID)) {&lt;br/&gt;
+			final ResourceManagerId newResourceManagerId = ResourceManagerId.fromUuid(newLeaderSessionID);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;br/&gt;
+			log.info(&quot;ResourceManager {} was granted leadership with fencing token {}&quot;, getAddress(), newResourceManagerId);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;getRpcService().execute(&lt;/li&gt;
	&lt;li&gt;() -&amp;gt;&lt;/li&gt;
	&lt;li&gt;// confirming the leader session ID might be blocking,&lt;/li&gt;
	&lt;li&gt;leaderElectionService.confirmLeaderSessionID(newLeaderSessionID));&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
+			// clear the state if we&apos;ve been the leader before&lt;br/&gt;
+			if (getFencingToken() != null) 
{
+				clearStateInternal();
+			}
&lt;p&gt;+&lt;br/&gt;
+			setFencingToken(newResourceManagerId);&lt;br/&gt;
+&lt;br/&gt;
+			slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;br/&gt;
+&lt;br/&gt;
+			return prepareLeadershipAsync().thenApply(ignored -&amp;gt; true);&lt;br/&gt;
+		} else &lt;/p&gt;
{
+			return CompletableFuture.completedFuture(false);
+		}
&lt;p&gt; 	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;br/&gt;
@@ -917,7 +945,7 @@ public void revokeLeadership() {&lt;br/&gt;
 			() -&amp;gt; {&lt;br/&gt;
 				log.info(&quot;ResourceManager {} was revoked leadership. Clearing fencing token.&quot;, getAddress());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;clearState();&lt;br/&gt;
+				clearStateInternal();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 				setFencingToken(null);&lt;/p&gt;

&lt;p&gt;@@ -946,6 +974,28 @@ public void handleError(final Exception exception) {&lt;br/&gt;
 	 */&lt;br/&gt;
 	protected abstract void initialize() throws ResourceManagerException;&lt;/p&gt;

&lt;p&gt;+	/**&lt;br/&gt;
+	 * This method can be overridden to add a (non-blocking) initialization routine to the&lt;br/&gt;
+	 * ResourceManager that will be called when leadership is granted but before leadership is&lt;br/&gt;
+	 * confirmed.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @return Returns a &lt;/p&gt;
{@code CompletableFuture} that completes when the computation is finished.&lt;br/&gt;
+	 */&lt;br/&gt;
+	protected CompletableFuture&amp;lt;Void&amp;gt; prepareLeadershipAsync() {
+		return CompletableFuture.completedFuture(null);
+	}&lt;br/&gt;
+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * This method can be overridden to add a (non-blocking) state clearing routine to the&lt;br/&gt;
+	 * ResourceManager that will be called when leadership is revoked.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @return Returns a {@code CompletableFuture}
&lt;p&gt; that completes when the state clearing routine&lt;br/&gt;
+	 * is finished.&lt;br/&gt;
+	 */&lt;br/&gt;
+	protected CompletableFuture&amp;lt;Void&amp;gt; clearStateAsync() &lt;/p&gt;
{
+		return CompletableFuture.completedFuture(null);
+	}
&lt;p&gt;+&lt;br/&gt;
 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The framework specific code to deregister the application. This should report the&lt;/li&gt;
	&lt;li&gt;application&apos;s final status and shut down the resource manager cleanly.&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/resourcemanager/ResourceManagerTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/resourcemanager/ResourceManagerTest.java&lt;br/&gt;
index a8837846311..a1f6227be02 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/resourcemanager/ResourceManagerTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/resourcemanager/ResourceManagerTest.java&lt;br/&gt;
@@ -18,7 +18,6 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; package org.apache.flink.runtime.resourcemanager;&lt;/p&gt;

&lt;p&gt;-import org.apache.flink.configuration.Configuration;&lt;br/&gt;
 import org.apache.flink.runtime.clusterframework.types.ResourceID;&lt;br/&gt;
 import org.apache.flink.runtime.heartbeat.HeartbeatServices;&lt;br/&gt;
 import org.apache.flink.runtime.highavailability.TestingHighAvailabilityServices;&lt;br/&gt;
@@ -67,7 +66,6 @@ public void tearDown() throws ExecutionException, InterruptedException {&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testRequestTaskManagerInfo() throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Configuration configuration = new Configuration();&lt;br/&gt;
 		final TestingHighAvailabilityServices highAvailabilityServices = new TestingHighAvailabilityServices();&lt;br/&gt;
 		final SlotManager slotManager = new SlotManager(&lt;br/&gt;
 			rpcService.getScheduledExecutor(),&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16568276" author="till.rohrmann" created="Fri, 3 Aug 2018 14:39:44 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
master: 5b1500d4fe39a44bfaa03b27216627e3caf55240&lt;br/&gt;
1.6.0: 231c9559ef67cf159e0413b56634a382bc78d93c&lt;br/&gt;
1.5.3: fb157c93d3cbd8063dc86e1eac8985f10dec34e2&lt;/p&gt;</comment>
                            <comment id="16581062" author="githubbot" created="Wed, 15 Aug 2018 13:22:46 +0000"  >&lt;p&gt;tillrohrmann commented on issue #6451: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt; Resource manager connect to mesos after leadership granted. .&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6451#issuecomment-413195708&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6451#issuecomment-413195708&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Subsumed by #6464&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16581063" author="githubbot" created="Wed, 15 Aug 2018 13:22:47 +0000"  >&lt;p&gt;tillrohrmann closed pull request #6451: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9936&quot; title=&quot;Mesos resource manager unable to connect to master after failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9936&quot;&gt;&lt;del&gt;FLINK-9936&lt;/del&gt;&lt;/a&gt; Resource manager connect to mesos after leadership granted. .&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6451&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6451&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java b/flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
index e24214d28c1..b2606e46fbc 100644&lt;br/&gt;
&amp;#8212; a/flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
+++ b/flink-mesos/src/main/java/org/apache/flink/mesos/runtime/clusterframework/MesosResourceManager.java&lt;br/&gt;
@@ -221,10 +221,14 @@ protected ActorRef createReconciliationCoordinator(SchedulerDriver schedulerDriv&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt; 	/**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Starts the Mesos-specifics.&lt;br/&gt;
+	 * Do nothing and all work has been moved to on leadership granted callback.&lt;br/&gt;
 	 */&lt;br/&gt;
 	@Override&lt;br/&gt;
 	protected void initialize() throws ResourceManagerException 
{
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected void onLeaderShipGranted() throws Exception {&lt;br/&gt;
 		// create and start the worker store&lt;br/&gt;
 		try {&lt;br/&gt;
 			this.workerStore = mesosServices.createMesosWorkerStore(flinkConfig, getRpcService().getExecutor());&lt;br/&gt;
@@ -283,7 +287,14 @@ protected void initialize() throws ResourceManagerException &lt;/p&gt;
{
 		connectionMonitor.tell(new ConnectionMonitor.Start(), selfActor);
 		schedulerDriver.start();
 
-		LOG.info(&quot;Mesos resource manager initialized.&quot;);
+		LOG.info(&quot;Mesos resource manager started.&quot;);
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	protected void onLeaderShipRevoked() throws Exception &lt;/p&gt;
{
+		workerStore.stop(false);
+		schedulerDriver.stop(true);
+		disconnected(new Disconnected());
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/**&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java b/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
index a992632b666..081da27424d 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java&lt;br/&gt;
@@ -899,6 +899,12 @@ public void grantLeadership(final UUID newLeaderSessionID) {&lt;/p&gt;

&lt;p&gt; 				setFencingToken(newResourceManagerId);&lt;/p&gt;

&lt;p&gt;+				try &lt;/p&gt;
{
+					onLeaderShipGranted();
+				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
+					onFatalError(e);
+				}&lt;br/&gt;
+&lt;br/&gt;
 				slotManager.start(getFencingToken(), getMainThreadExecutor(), new ResourceActionsImpl());&lt;br/&gt;
 &lt;br/&gt;
 				getRpcService().execute(&lt;br/&gt;
@@ -919,6 +925,12 @@ public void revokeLeadership() {&lt;br/&gt;
 &lt;br/&gt;
 				clearState();&lt;br/&gt;
 &lt;br/&gt;
+				try {
+					onLeaderShipRevoked();
+				} catch (Exception e) {+					onFatalError(e);+				}
&lt;p&gt;+&lt;br/&gt;
 				setFencingToken(null);&lt;/p&gt;

&lt;p&gt; 				slotManager.suspend();&lt;br/&gt;
@@ -946,6 +958,18 @@ public void handleError(final Exception exception) {&lt;br/&gt;
 	 */&lt;br/&gt;
 	protected abstract void initialize() throws ResourceManagerException;&lt;/p&gt;

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Called when leadership is granted.&lt;br/&gt;
+	 * @throws Exception which occurs during granting leadership and causes the resource manager to fail.&lt;br/&gt;
+	 */&lt;br/&gt;
+	protected void onLeaderShipGranted() throws Exception {}&lt;br/&gt;
+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Called when leadership is revoked.&lt;br/&gt;
+	 * @throws Exception which occurs during revoking leadership and causes the resource manager to fail.&lt;br/&gt;
+	 */&lt;br/&gt;
+	protected void onLeaderShipRevoked() throws Exception {}&lt;br/&gt;
+&lt;br/&gt;
 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The framework specific code to deregister the application. This should report the&lt;/li&gt;
	&lt;li&gt;application&apos;s final status and shut down the resource manager cleanly.&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13095444">FLINK-7470</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 13 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w7v3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>