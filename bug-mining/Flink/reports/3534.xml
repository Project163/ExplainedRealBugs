<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:42:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-13197] Fix Hive view row type mismatch when expanding in planner</title>
                <link>https://issues.apache.org/jira/browse/FLINK-13197</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;One goal of HiveCatalog and hive integration is to enable Flink-Hive interoperability, that is Flink should understand existing Hive meta-objects, and Hive meta-objects created thru Flink should be understood by Hive.&lt;/p&gt;

&lt;p&gt;Taking an example of a Hive view v1 in HiveCatalog and database hc.db. Unlike an equivalent Flink view whose full path in expanded query should be hc.db.v1, the Hive view&apos;s full path in the expanded query should be db.v1 such that Hive can understand it, no matter it&apos;s created by Hive or Flink.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt; can you help to ensure that Flink can also query Hive&apos;s view in both Flink planner and Blink planner?&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13244184">FLINK-13197</key>
            <summary>Fix Hive view row type mismatch when expanding in planner</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lirui">Rui Li</assignee>
                                    <reporter username="phoenixjiangnan">Bowen Li</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Jul 2019 22:19:04 +0000</created>
                <updated>Wed, 18 Dec 2019 13:30:16 +0000</updated>
                            <resolved>Wed, 18 Dec 2019 13:30:16 +0000</resolved>
                                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Connectors / Hive</component>
                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16910930" author="lirui" created="Tue, 20 Aug 2019 02:20:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phoenixjiangnan&quot; class=&quot;user-hover&quot; rel=&quot;phoenixjiangnan&quot;&gt;phoenixjiangnan&lt;/a&gt; I suppose this has to wait for &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-12905&quot; title=&quot;Convert CatalogView to org.apache.calcite.schema.Table so that planner can use unified catalog APIs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-12905&quot;&gt;&lt;del&gt;FLINK-12905&lt;/del&gt;&lt;/a&gt; to get in first, is that correct?&lt;/p&gt;</comment>
                            <comment id="16910975" author="phoenixjiangnan" created="Tue, 20 Aug 2019 03:54:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt;&#160;I think so.&lt;/p&gt;</comment>
                            <comment id="16988604" author="lirui" created="Thu, 5 Dec 2019 09:04:04 +0000"  >&lt;p&gt;I hit some issue when trying to query views created in Hive. The view is created as:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create table src (key &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, val string);
create view v as select key, count(*) from src group by key having count(*) &amp;gt; 1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When querying this view from Flink, I hit the following exception:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.flink.table.api.TableException: Could not expand view. Types mismatch.
 Expected row type: RecordType(INTEGER key, BIGINT _c1)
 Expanded view type: RecordType(INTEGER key, BIGINT EXPR$1)


	at org.apache.flink.table.planner.calcite.FlinkPlannerImpl.expandView(FlinkPlannerImpl.scala:191)
	at org.apache.flink.table.planner.catalog.SqlCatalogViewTable.convertToRel(SqlCatalogViewTable.java:56)
	at org.apache.flink.table.planner.plan.schema.ExpandingPreparingTable.expand(ExpandingPreparingTable.java:59)
	at org.apache.flink.table.planner.plan.schema.ExpandingPreparingTable.toRel(ExpandingPreparingTable.java:55)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The expected row type is what we get from &lt;tt&gt;HiveCatalog&lt;/tt&gt;, and the expanded view type is what we get after compiling the expanded query of the view.&lt;br/&gt;
I wonder whether it&apos;s necessary to check the equality of these two, given that we can&apos;t anticipate what we&apos;ll get from the catalog. I think we can at least be more lenient here, e.g. it doesn&apos;t make sense to compare the column names, perhaps nullability either.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; could you please share your thoughts? BTW I&apos;m using the blink planner.&lt;/p&gt;</comment>
                            <comment id="16988606" author="dawidwys" created="Thu, 5 Dec 2019 09:13:57 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt; I think this is could be an argument for actually adding the cast we discussed here: &lt;a href=&quot;https://github.com/apache/flink/pull/8859#discussion_r350518897&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/8859#discussion_r350518897&lt;/a&gt; What do you think?&lt;/p&gt;

&lt;p&gt;The problem here is that the automatic names differ between what calcite and what hive produces/&lt;/p&gt;</comment>
                            <comment id="16989288" author="danny0405" created="Fri, 6 Dec 2019 01:07:40 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt; for reporting this ~&lt;/p&gt;

&lt;p&gt;I thought a lot, and think we still should not add redundant casts/AS operators above the view relational expression.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;For column alias, i&apos;m thinking about to support view alias from the create view statement, which should be finished in FLIP-71&lt;/li&gt;
	&lt;li&gt;For nullability, we should fix it from the type inference&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m always agains with the redundant nodes because it add a useless projection above the view thus would change the logical plan (make it more complicated and we may lose some plan promotion like project merge or transpose or reduction).&lt;/p&gt;</comment>
                            <comment id="16989334" author="lirui" created="Fri, 6 Dec 2019 02:36:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt; Thanks for your inputs. I&apos;m not very familiar with the Calcite logics here, but just curious why we even care about the row type returned by the catalog? A view is essentially just a query, and the row type from the the catalog is what the external system &quot;thinks&quot; this query will produce. I don&apos;t think we consult external system for result types of ordinary queries. So why do we do that for views?&lt;/p&gt;</comment>
                            <comment id="16989518" author="dawidwys" created="Fri, 6 Dec 2019 08:25:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt; View is not just a &quot;query&quot;. It is closer to a Table than to a query. There can be a whole query built on top of a view that assumed correct information retrieved from the catalog. Moreover view can be even writable if certain requirements are met.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt; I fully agree with you we should not introduce redundant cast. I am not sure though if the cast we are talking about is redundant. &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;It cannot be solved through DDL. The views are not always created from Flink. We also need to support views created in Hive externally.&lt;/li&gt;
	&lt;li&gt;How does type inference relate in this case? If I am not mistaken Hive (at least in earlier versions) will always give you nullable types for literals when calcite will derive not null types which will never match.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;BTW If I am not mistaken the utility method I suggest to use will not add additional cast nodes if the types and names match.&lt;/p&gt;</comment>
                            <comment id="16989667" author="lirui" created="Fri, 6 Dec 2019 11:59:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt; I see. Thanks for the explanation. I agree we should make sure types match if we would support writing to views.&lt;/p&gt;</comment>
                            <comment id="16989738" author="danny0405" created="Fri, 6 Dec 2019 13:03:58 +0000"  >&lt;p&gt;Let me have some study this weekend to see if we can have the solution without introducing the casts(from the Calcite community), i have no accurate answer at this moment.&lt;/p&gt;</comment>
                            <comment id="16990296" author="danny0405" created="Sat, 7 Dec 2019 03:10:02 +0000"  >&lt;p&gt;Checking out the code of `RelOptUtil#createCastRel`, i&apos;m wondering if we can rename the LogicalProject directly without add any above new projections with casts. After all, the code already rename the project with the constructor:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rename) {
      &lt;span class=&quot;code-comment&quot;&gt;// Use names and types from castRowType.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; projectFactory.createProject(rel, castExps,
          castRowType.getFieldNames());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So i thought if we can&quot;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;If the view rel root node is a LogicalProject, get its input then construct the new project with the renamed one.&lt;/li&gt;
	&lt;li&gt;If the view rel is not a LogicalProject, add a project above it with renamed input refs.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16991220" author="dawidwys" created="Mon, 9 Dec 2019 08:05:03 +0000"  >&lt;p&gt;And what about null handling? E.g. in hive 1.x all columns will be nullable, even if they are backed by literal.&lt;/p&gt;</comment>
                            <comment id="16993182" author="lirui" created="Wed, 11 Dec 2019 04:18:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt; I have just logged &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15186&quot; title=&quot;Column names and nullability mismatch when querying CatalogViews&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15186&quot;&gt;&lt;del&gt;FLINK-15186&lt;/del&gt;&lt;/a&gt; to track the issue.&lt;/p&gt;</comment>
                            <comment id="16993269" author="dawidwys" created="Wed, 11 Dec 2019 07:48:02 +0000"  >&lt;p&gt;Good idea &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt; Thank you&lt;/p&gt;</comment>
                            <comment id="16994640" author="jark" created="Thu, 12 Dec 2019 13:15:41 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Hi Dawid Wysakowicz Danny Chen, About add a cast:

&amp;gt; we may lose some plan promotion like project merge or transpose or reduction

 I don&apos;t think so, is our optimizer too weak? I think redundant cast will be removed easily by optimizer and should not affect optimizer.

And I think cast will enhance correctness, image:

- view sql will produce nullable fields
- view schema define fields not null.
- our code generator for cast consider null check, cast null to a not null field will fail.
- So add a cast is good to verify the data.

And maybe not only field name, nullable, but also precision, this kind of scene really needs a cast to transform.

So I am +1 for add a cast, What do you think? 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I repost &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;&apos;s comment under &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15186&quot; title=&quot;Column names and nullability mismatch when querying CatalogViews&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15186&quot;&gt;&lt;del&gt;FLINK-15186&lt;/del&gt;&lt;/a&gt; here, to make the discussion in a thread. &lt;br/&gt;
From my point of view, if we only need to rename fields, it would be great to avoid a cast project. &lt;br/&gt;
But if we want to handling nullable and precision, I think a project is required and it&apos;s fine to have a project on the view. &lt;/p&gt;

&lt;p&gt;If the cast project can&apos;be avoided, why not simply introduce a cast project.&lt;br/&gt;
So I&apos;m also +1 for cast project. &lt;/p&gt;
</comment>
                            <comment id="16997003" author="danny0405" created="Mon, 16 Dec 2019 06:28:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&amp;gt; And what about null handling? E.g. in hive 1.x all columns will be nullable, even if they are backed by&lt;br/&gt;
&amp;gt; literal.&lt;/p&gt;

&lt;p&gt;For hive (or other external storage) views, we may need to add the projection because it is hard to keep the nullability inference synced with Calcite.&lt;/p&gt;

&lt;p&gt;If the view are create from Flink, the data type and nullability should always expect to be correct.&lt;br/&gt;
We can add casts to fix only the nullability but not the field name.&lt;/p&gt;

&lt;p&gt;BTW, if all the assumption is correct, we should not expect to have any plan change with current code with the fix patch.&lt;/p&gt;</comment>
                            <comment id="16997084" author="lzljs3620320" created="Mon, 16 Dec 2019 08:37:59 +0000"  >&lt;p&gt;We don&apos;t need distinguish hive from Flink.&lt;/p&gt;

&lt;p&gt;I think we can just add a project and fix these field patterns:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Type and name totally same, do nothing.&lt;/li&gt;
	&lt;li&gt;Name not same, do rename.&lt;/li&gt;
	&lt;li&gt;Type not same, do cast.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If all fields are #1. Don&apos;t need add project. I think calcite can do this optimization to remove this project.&lt;/p&gt;</comment>
                            <comment id="16997924" author="danny0405" created="Tue, 17 Dec 2019 06:27:08 +0000"  >&lt;p&gt;PR updated &lt;a href=&quot;https://github.com/apache/flink/pull/10595/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/10595/files&lt;/a&gt; , can someone helps to review ? Thanks in advance ~&lt;/p&gt;</comment>
                            <comment id="16999160" author="dawidwys" created="Wed, 18 Dec 2019 13:30:16 +0000"  >&lt;p&gt;Fixed in:&lt;br/&gt;
master: 4e4dcf521748538aa164124fd613c9fe096ea604&lt;br/&gt;
1.10: 3d70c75477705b71acc83c010e7b89fce6c78c19&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13273755">FLINK-15186</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13240421">FLINK-12905</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 47 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04jmw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>