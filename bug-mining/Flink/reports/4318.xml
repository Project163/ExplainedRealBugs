<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:47:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18238] RemoteChannelThroughputBenchmark deadlocks</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18238</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In the last couple of days &lt;tt&gt;RemoteChannelThroughputBenchmark.remoteRebalance&lt;/tt&gt; deadlocked for the second time:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://codespeed.dak8s.net:8080/job/flink-master-benchmarks/6019/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://codespeed.dak8s.net:8080/job/flink-master-benchmarks/6019/&lt;/a&gt;&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13310595">FLINK-18238</key>
            <summary>RemoteChannelThroughputBenchmark deadlocks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kevin.cyj">Yingjie Cao</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 10 Jun 2020 08:30:14 +0000</created>
                <updated>Wed, 17 Jun 2020 13:12:57 +0000</updated>
                            <resolved>Wed, 17 Jun 2020 13:12:57 +0000</resolved>
                                    <version>1.11.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17135372" author="zjwang" created="Mon, 15 Jun 2020 03:23:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;&#160;already finalized the root cause which was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8871&quot; title=&quot;Checkpoint cancellation is not propagated to stop checkpointing threads on the task manager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8871&quot;&gt;&lt;del&gt;FLINK-8871&lt;/del&gt;&lt;/a&gt;.&#160;&lt;/p&gt;

&lt;p&gt;When the checkpoint coordinator received the aborted checkpoint RPC from one task, it will send the abort RPC call to all the remaining tasks to avoid useless checkpoint happen.&lt;/p&gt;

&lt;p&gt;If the respective checkpoint has not performed on&#160;SubtaskCheckpointCoordinatorImpl side, it will store this aborted id to exit the later checkpoint directly. But the downstream side still waits for barrier alignment and can not receive any checkpoint barrier or CancelCheckpointMarker any more from this aborted upstream. Then it will cause gradually backpressure until completely deadlock.&#160; &#160;&lt;/p&gt;

&lt;p&gt;One possible option is to broadcast&#160;CancelCheckpointMarker to downstream side when the upstream already aborted the checkpoint from RPC call, then the downstream can end the alignment immediately. But one side effect is that the&#160;CancelCheckpointMarker might be broadcasted twice, one is via RPC trigger and anther is via data stream in CheckpointBarrierHandler.&lt;/p&gt;</comment>
                            <comment id="17135499" author="pnowojski" created="Mon, 15 Jun 2020 06:54:32 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; for investigating this.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;But the downstream side still waits for barrier alignment and can not receive any checkpoint barrier or CancelCheckpointMarker any more from this aborted upstream.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Why is the downstream task not receiving the checkpoint aborted RPC call? Is it because it was sent before this task started or something like that?&lt;/p&gt;</comment>
                            <comment id="17135502" author="zjwang" created="Mon, 15 Jun 2020 06:56:07 +0000"  >&lt;p&gt;The downstream task can receive the abort rpc call from coordinator, but it can not touch the `CheckpointBarrierHandler` to end the alignment and it only works on `StreamTask` with sub task coordinator.&lt;/p&gt;</comment>
                            <comment id="17135506" author="yunta" created="Mon, 15 Jun 2020 07:02:04 +0000"  >&lt;p&gt;Thanks for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; for investigating this.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;, I think this is because current implementation would not emit checkpoint barrier or CancelCheckpointMarker downstream if it found the checkpoint has been aborted (see &lt;a href=&quot;https://github.com/apache/flink/blob/35f95f5ac02c6014cdc8ef714ca66ad7e2cfdd5b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java#L240-L252&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SubtaskCheckpointCoordinatorImpl code&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I compare the implementation of current Flink with our internal Blink and noticed that we would broadcast barrier and then return to ignore follow-up sync and async phase in Blink. I think that&apos;s why we did not meet this problem internally.&lt;/p&gt;</comment>
                            <comment id="17135534" author="pnowojski" created="Mon, 15 Jun 2020 07:33:48 +0000"  >&lt;blockquote&gt;
&lt;p&gt;The downstream task can receive the abort rpc call from coordinator, but it can not touch the `CheckpointBarrierHandler` to end the alignment and it only works on `StreamTask` with sub task coordinator.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ok I get it. It would be I think OK to cancel the alignment directly from the &lt;tt&gt;SubtaskCheckpointCoordinator&lt;/tt&gt;, but as I wrote above, it might open up possibilities for some race conditions with task not started.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;One possible option is to broadcast CancelCheckpointMarker to downstream side when the upstream already aborted the checkpoint from RPC call, then the downstream can end the alignment immediately. But one side effect is that the CancelCheckpointMarker might be broadcasted twice, one is via RPC trigger and anther is via data stream in CheckpointBarrierHandler.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This could be handled by checking if the checkpoint has already been aborted or not.&lt;/p&gt;

&lt;p&gt;But now that I think about it, what if there are multiple ongoing checkpoints in the job graph: N, N+1, ..., N +5. What if checkpoint N+5 fails somewhere at the head of the job graph, while other are still flowing through the job graph? Without the abort RPC call, if a task completed checkpoints N, .., N+4, it broadcasted checkpoint barriers for those checkpoints and then failed for checkpoint N+5, those cancellation markers from this Task wouldn&apos;t be processed by downstream Tasks (because of alignment and blocked channels) that are still waiting for alignment on checkpoints N, ..., N+4. So checkpoints N, ..., N+4 could complete normally.&lt;/p&gt;

&lt;p&gt;With the abort RPC call, cancellations can overtake the pending checkpoint barriers, so in the before mentioned scenario, we would cancel all checkpoints, from N to N+5. I&apos;m not sure if this can happen on master as it is without broadcasting &lt;tt&gt;CancelCheckpointMarker&lt;/tt&gt;, but I think it could happen with broadcasting.&lt;/p&gt;</comment>
                            <comment id="17135667" author="zjwang" created="Mon, 15 Jun 2020 09:27:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;Ok I get it. It would be I think OK to cancel the alignment directly from the&#160;SubtaskCheckpointCoordinator, but as I wrote above, it might open up possibilities for some race conditions with task not started.&lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;This could be handled by checking if the checkpoint has already been aborted or not.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I guess we can not cancel the alignment easily now when receiving the abort rpc call, since the&#160;SubtaskCheckpointCoordinator can not access the component of CheckpointBarrierHandler directly. Also we could not avoid duplicated broadcast since these two components work separately.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;With the abort RPC call, cancellations can overtake the pending checkpoint barriers, so in the before mentioned scenario, we would cancel all checkpoints, from N to N+5. I&apos;m not sure if this can happen on master as it is without broadcasting&#160;CancelCheckpointMarker, but I think it could happen with broadcasting.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we need to finalize the semantic of aborting checkpoint from global coordinator firstly. If the checkpoint N+5 is aborted from coordinator, does that mean all the pending checkpoints smaller than N+5 should also be aborted as well?&lt;br/&gt;
 The previous semantic is for precise abort for the indicated checkpoint id from rpc call. If we changed this behavior to abort all the preceding pending checkpoint, we might need to think more and redefine the semantic/behavior.&lt;/p&gt;

&lt;p&gt;Anyway I think it might be a separate topic to discuss. Now we can firstly confirm how to cancel the dedicated checkpoint to keep the previous behavior.&lt;/p&gt;</comment>
                            <comment id="17135680" author="roman_khachatryan" created="Mon, 15 Jun 2020 09:39:02 +0000"  >&lt;p&gt;RPC abort notifications were introduced in 1.11 but we&apos;ve encountered this issue in 1.10, right?&#160;&lt;/p&gt;</comment>
                            <comment id="17135695" author="zjwang" created="Mon, 15 Jun 2020 09:50:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;RPC abort notifications were introduced in 1.11 but we&apos;ve encountered this issue in 1.10, right? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The motivation for introducing abort notification is for saving the efforts of clearing the invalid checkpoint, and it did in 1.11. After this improvement we prevented the barrier broadcasting to downstream side, so it encountered the deadlock issue now. This issue is not in 1.10.&lt;/p&gt;</comment>
                            <comment id="17135764" author="yunta" created="Mon, 15 Jun 2020 11:20:04 +0000"  >&lt;p&gt;I think the clear solution is to broadcast &lt;tt&gt;CancelCheckpointMarker&lt;/tt&gt; downside. However, I&apos;m not very sure whether it&apos;s okay to process &lt;tt&gt;CancelCheckpointMarker&lt;/tt&gt; twice on task side.&lt;/p&gt;

&lt;p&gt;Maybe I could prepare a PR without UTs first to see how much work need to broadcast &lt;tt&gt;CancelCheckpointMarker&lt;/tt&gt; downside.&lt;/p&gt;</comment>
                            <comment id="17135790" author="pnowojski" created="Mon, 15 Jun 2020 11:53:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt; as I wrote above, broadcasting &lt;tt&gt;CancelCheckpointMarker&lt;/tt&gt; downstream can probably cause checkpoint failures of previous checkpoints, that would complete successfully otherwise.&lt;/p&gt;

&lt;p&gt;Current semantic of &lt;tt&gt;CancelCheckpointMarker(N)&lt;/tt&gt; is that it aborts all checkpoints &amp;lt;= N. To preserve the previous behaviour, we would need more complicate logic, either in processing &lt;tt&gt;CancelCheckpointMarker&lt;/tt&gt; or in broadcasting it (we could postpone broadcasting).&lt;/p&gt;

&lt;p&gt;Maybe it&apos;s fine to change the previous behaviour, but that wasn&apos;t the intention of the &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8871&quot; title=&quot;Checkpoint cancellation is not propagated to stop checkpointing threads on the task manager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8871&quot;&gt;&lt;del&gt;FLINK-8871&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Either way, I think it would be safer to revert this change and re-do it on master branch for 1.12, as who knows what other problems can pop up even in the simplest solution:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;the clear solution is to broadcast CancelCheckpointMarker downside. &lt;/p&gt;&lt;/blockquote&gt; 
&lt;p&gt;and we are now blocking 1.11 release.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;since the SubtaskCheckpointCoordinator can not access the component of CheckpointBarrierHandler directly&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; this would be easy to solve, assuming that we would want to go this direction.&lt;/p&gt;</comment>
                            <comment id="17135862" author="yunta" created="Mon, 15 Jun 2020 13:29:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Thanks for your clarification.&lt;/p&gt;

&lt;p&gt;From my point of view, broadcasting checkpoint barrier downside, which is our internal Flink did, could solve this problem. In other words, we need to change the order of current step-0 after step-2:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Step (2): Send the checkpoint barrier downstream
&lt;/span&gt;operatorChain.broadcastEvent(
	&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CheckpointBarrier(metadata.getCheckpointId(), metadata.getTimestamp(), options),
	options.isUnalignedCheckpoint());

......

&lt;span class=&quot;code-comment&quot;&gt;// Step (0): Record the last triggered checkpointId.
&lt;/span&gt;lastCheckpointId = metadata.getCheckpointId();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (checkAndClearAbortedStatus(metadata.getCheckpointId())) {
	LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Checkpoint {} has been notified as aborted, would not trigger any checkpoint.&quot;&lt;/span&gt;, metadata.getCheckpointId());
	&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="17135863" author="yunta" created="Mon, 15 Jun 2020 13:29:50 +0000"  >&lt;p&gt;If we have to choose to revert code, I think &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18074&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-18074&lt;/a&gt; cannot be directly reverted.&lt;/p&gt;</comment>
                            <comment id="17136511" author="pnowojski" created="Tue, 16 Jun 2020 10:22:21 +0000"  >&lt;p&gt;Copying the result of an online discussion: we decided to go with broadcasting checkpoint cancellation markers from &lt;tt&gt;SubtaskCheckpointCoordinatorImpl#checkpointState&lt;/tt&gt; in the case when &lt;tt&gt;notifyCheckpointAborted&lt;/tt&gt; RPC call was received before it the checkpoint was triggered. This guarantees that downstream tasks will always eventually stop the alignment. &lt;/p&gt;

&lt;p&gt;We could further optimise the process by cancelling the ongoing alignment of the task, once it receives &lt;tt&gt;notifyCheckpointAborted&lt;/tt&gt; RPC, but that would require some more extensive changes that we do not need to do right now.&lt;/p&gt;</comment>
                            <comment id="17138421" author="zjwang" created="Wed, 17 Jun 2020 13:12:57 +0000"  >&lt;p&gt;Master:&#160;07772bdb9abc0bcd3b3c8869f6abdc8088bd7cea&lt;/p&gt;

&lt;p&gt;Release-1.11:&#160;e7c634f223c0a2c180ca5abe14a4661115f0afe6&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13142593">FLINK-8871</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13005417" name="consoleText_remote_benchmark_deadlock.txt" size="1985858" author="pnowojski" created="Wed, 10 Jun 2020 14:49:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fpfk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>