<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:07:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-24401] TM cannot exit after Metaspace OOM</title>
                <link>https://issues.apache.org/jira/browse/FLINK-24401</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Hi masters, from the code and log, we can see that OOM will terminateJVM directly, but Metaspace OutOfMemoryError will graceful shutdown. The code comment mentions: &lt;tt&gt;&lt;em&gt;it does not usually require more class loading to fail again with the Metaspace OutOfMemoryError&lt;/em&gt;.&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;But we encountered: after Metaspace OutOfMemoryError, &lt;tt&gt;&lt;em&gt;java.lang.NoClassDefFoundError: Could not initialize class org.apache.flink.runtime.taskexecutor.TaskManagerRunner$Result&lt;/em&gt;.&lt;/tt&gt;, makes Tm unable to exit, keeps trying again, keeps NoClassDefFoundError, keeps class loading failure, until kill tm by manually.&lt;/p&gt;

&lt;p&gt;I want to add a catch Throwable in the onFatalError method, and directly terminateJVM() in the catch. Is there any problem with this strategy?&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/4fe9f525a92319acc1e3434bebed601306f7a16f/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskManagerRunner.java#L312&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code link &lt;/a&gt;&lt;/p&gt;

&lt;p&gt;picture:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13034351/13034351_image-2021-09-29-12-00-44-812.png&quot; height=&quot;692&quot; width=&quot;1337&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13034350/13034350_image-2021-09-29-12-00-28-510.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13403992">FLINK-24401</key>
            <summary>TM cannot exit after Metaspace OOM</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fanrui">Rui Fan</assignee>
                                    <reporter username="fanrui">Rui Fan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 29 Sep 2021 03:54:34 +0000</created>
                <updated>Wed, 15 Dec 2021 01:44:01 +0000</updated>
                            <resolved>Mon, 8 Nov 2021 07:51:46 +0000</resolved>
                                    <version>1.12.0</version>
                    <version>1.13.0</version>
                                    <fixVersion>1.13.6</fixVersion>
                    <fixVersion>1.14.3</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17430011" author="pnowojski" created="Mon, 18 Oct 2021 13:23:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt;, can you post the actual second&apos;s OOM stack trace?&lt;/p&gt;

&lt;p&gt;As the error was caused by &lt;tt&gt;org.apache.flink.runtime.taskexecutor.TaskManagerRunner.Result&lt;/tt&gt;, I wonder if we should actually just treat all OOMs the sam way, regardless if it&apos;s meta space or not. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;, what do you think? I&apos;m asking as you were doing the review of that change, and I don&apos;t know the motivation behind it. Was it just best effort thing that we added, just because we thought we could? Or was it addressing some problem that users were complaining about?&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In case of Metaspace OOM error, we try a graceful TM shutdown to notify JM because it is not expected to require class loading for that and cause further failures.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;After all this assumption is clearly in the wrong.&lt;/p&gt;</comment>
                            <comment id="17430283" author="fanrui" created="Tue, 19 Oct 2021 02:41:00 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;, thanks for you reply. I&apos;m sorry, I didn&apos;t save the stack trace of TM, I just save the log.&#160;&lt;/p&gt;</comment>
                            <comment id="17437392" author="till.rohrmann" created="Tue, 2 Nov 2021 14:34:22 +0000"  >&lt;p&gt;I think the assumption was that a meta space OOM mainly occurs when loading user code (additional classes). That&apos;s why we thought that most of Flink related things can still work because they were loaded before. Clearly, this does not seem to hold true. I&apos;d be fine with failing hard in case of a meta space OOM. If we want to still provide the old behaviour, then we could make the exit behaviour configurable with default to fail hard.&lt;/p&gt;</comment>
                            <comment id="17437798" author="pnowojski" created="Wed, 3 Nov 2021 08:02:28 +0000"  >&lt;p&gt;Thanks for the explanation. At this moment I do not see a good justification for keeping &quot;failing soft&quot; code path, so I would vote for the sake of simplicity to just remove it.&lt;/p&gt;</comment>
                            <comment id="17437801" author="pnowojski" created="Wed, 3 Nov 2021 08:03:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt;, is this something that you would like to work on and contribute?&lt;/p&gt;</comment>
                            <comment id="17438031" author="fanrui" created="Wed, 3 Nov 2021 12:40:37 +0000"  >&lt;p&gt;Of course. I&apos;d like to contribute. Please assign this issue to me. Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="17440253" author="pnowojski" created="Mon, 8 Nov 2021 07:51:46 +0000"  >&lt;p&gt;Merged to master/release-1.14/release-1.13 as 365d12d499a/8f73e6c38cc/3b5b5428271 respectively&lt;/p&gt;

&lt;p&gt;Thanks again &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt; for reporting and fixing the issue!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13034350" name="image-2021-09-29-12-00-28-510.png" size="634171" author="fanrui" created="Wed, 29 Sep 2021 04:00:30 +0000"/>
                            <attachment id="13034351" name="image-2021-09-29-12-00-44-812.png" size="170059" author="fanrui" created="Wed, 29 Sep 2021 04:00:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vem8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>