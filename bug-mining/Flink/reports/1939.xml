<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:29:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7524] Task &quot;xxx&quot; did not react to cancelling signal, but is stuck in method</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7524</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I observed the following errors in taskmanager.log &lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2017-08-25 17:03:40,141 WARN  org.apache.flink.runtime.taskmanager.Task                     - Task &lt;span class=&quot;code-quote&quot;&gt;&apos;TriggerWindow(SlidingEventTimeWindows(259200000, 3600000), AggregatingStateDescriptor{serializer=org.apache.flink.api.java.typeutils.runtime.TupleSerializer@f65b6aa2, aggFunction=com.streamingApp$MyAggregateFunction@1f193686}, EventTimeTrigger(), WindowedStream.aggregate(WindowedStream.java:858)) -&amp;gt; Sink: prod_item (2/6)&apos;&lt;/span&gt; did not react to cancelling signal, but is stuck in method:
 org.apache.flink.util.AbstractCloseableRegistry.unregisterClosable(AbstractCloseableRegistry.java:84)
org.apache.flink.runtime.state.StateSnapshotContextSynchronousImpl.closeAndUnregisterStream(StateSnapshotContextSynchronousImpl.java:137)
org.apache.flink.runtime.state.StateSnapshotContextSynchronousImpl.close(StateSnapshotContextSynchronousImpl.java:147)
org.apache.flink.streaming.api.operators.AbstractStreamOperator.snapshotState(AbstractStreamOperator.java:399)
org.apache.flink.streaming.runtime.tasks.StreamTask$CheckpointingOperation.checkpointStreamOperator(StreamTask.java:1157)
org.apache.flink.streaming.runtime.tasks.StreamTask$CheckpointingOperation.executeCheckpointing(StreamTask.java:1089)
org.apache.flink.streaming.runtime.tasks.StreamTask.checkpointState(StreamTask.java:653)
org.apache.flink.streaming.runtime.tasks.StreamTask.performCheckpoint(StreamTask.java:589)
org.apache.flink.streaming.runtime.tasks.StreamTask.triggerCheckpointOnBarrier(StreamTask.java:542)
org.apache.flink.streaming.runtime.io.BarrierBuffer.notifyCheckpoint(BarrierBuffer.java:378)
org.apache.flink.streaming.runtime.io.BarrierBuffer.processBarrier(BarrierBuffer.java:281)
org.apache.flink.streaming.runtime.io.BarrierBuffer.getNextNonBlocked(BarrierBuffer.java:183)
org.apache.flink.streaming.runtime.io.StreamInputProcessor.processInput(StreamInputProcessor.java:213)
org.apache.flink.streaming.runtime.tasks.OneInputStreamTask.run(OneInputStreamTask.java:69)
org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:262)
org.apache.flink.runtime.taskmanager.Task.run(Task.java:702)
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)

...

2017-08-25 17:05:10,139 INFO  org.apache.flink.runtime.taskmanager.Task                     - Notifying TaskManager about fatal error. Task &lt;span class=&quot;code-quote&quot;&gt;&apos;TriggerWindow(SlidingEventTimeWindows(259200000, 3600000), AggregatingStateDescriptor{serializer=org.apache.flink.api.java.typeutils.runtime.TupleSerializer@f65b6aa2, aggFunction=com.streamingApp$MyAggregateFunction@1f193686}, EventTimeTrigger(), WindowedStream.aggregate(WindowedStream.java:858)) -&amp;gt; Sink: prod_item (2/6)&apos;&lt;/span&gt; did not react to cancelling signal in the last 30 seconds, but is stuck in method:
 org.apache.flink.util.AbstractCloseableRegistry.unregisterClosable(AbstractCloseableRegistry.java:84)
org.apache.flink.runtime.state.StateSnapshotContextSynchronousImpl.closeAndUnregisterStream(StateSnapshotContextSynchronousImpl.java:137)
org.apache.flink.runtime.state.StateSnapshotContextSynchronousImpl.close(StateSnapshotContextSynchronousImpl.java:147)
org.apache.flink.streaming.api.operators.AbstractStreamOperator.snapshotState(AbstractStreamOperator.java:399)
org.apache.flink.streaming.runtime.tasks.StreamTask$CheckpointingOperation.checkpointStreamOperator(StreamTask.java:1157)
org.apache.flink.streaming.runtime.tasks.StreamTask$CheckpointingOperation.executeCheckpointing(StreamTask.java:1089)
org.apache.flink.streaming.runtime.tasks.StreamTask.checkpointState(StreamTask.java:653)
org.apache.flink.streaming.runtime.tasks.StreamTask.performCheckpoint(StreamTask.java:589)
org.apache.flink.streaming.runtime.tasks.StreamTask.triggerCheckpointOnBarrier(StreamTask.java:542)
org.apache.flink.streaming.runtime.io.BarrierBuffer.notifyCheckpoint(BarrierBuffer.java:378)
org.apache.flink.streaming.runtime.io.BarrierBuffer.processBarrier(BarrierBuffer.java:281)
org.apache.flink.streaming.runtime.io.BarrierBuffer.getNextNonBlocked(BarrierBuffer.java:183)
org.apache.flink.streaming.runtime.io.StreamInputProcessor.processInput(StreamInputProcessor.java:213)
org.apache.flink.streaming.runtime.tasks.OneInputStreamTask.run(OneInputStreamTask.java:69)
org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:262)
org.apache.flink.runtime.taskmanager.Task.run(Task.java:702)
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
.
2017-08-25 17:05:10,140 ERROR org.apache.flink.yarn.YarnTaskManager                         - 
==============================================================
======================      FATAL      =======================
==============================================================

A fatal error occurred, forcing the TaskManager to shut down: Task &lt;span class=&quot;code-quote&quot;&gt;&apos;TriggerWindow(SlidingEventTimeWindows(259200000, 3600000), AggregatingStateDescriptor{serializer=org.apache.flink.api.java.typeutils.runtime.TupleSerializer@f65b6aa2, aggFunction=com.streamingApp$MyAggregateFunction@1f193686}, EventTimeTrigger(), WindowedStream.aggregate(WindowedStream.java:858)) -&amp;gt; Sink: prod_item (2/6)&apos;&lt;/span&gt; did not react to cancelling signal in the last 30 seconds, but is stuck in method:
 org.apache.flink.util.AbstractCloseableRegistry.unregisterClosable(AbstractCloseableRegistry.java:84)
org.apache.flink.runtime.state.StateSnapshotContextSynchronousImpl.closeAndUnregisterStream(StateSnapshotContextSynchronousImpl.java:137)
org.apache.flink.runtime.state.StateSnapshotContextSynchronousImpl.close(StateSnapshotContextSynchronousImpl.java:147)
org.apache.flink.streaming.api.operators.AbstractStreamOperator.snapshotState(AbstractStreamOperator.java:399)
org.apache.flink.streaming.runtime.tasks.StreamTask$CheckpointingOperation.checkpointStreamOperator(StreamTask.java:1157)
org.apache.flink.streaming.runtime.tasks.StreamTask$CheckpointingOperation.executeCheckpointing(StreamTask.java:1089)
org.apache.flink.streaming.runtime.tasks.StreamTask.checkpointState(StreamTask.java:653)
org.apache.flink.streaming.runtime.tasks.StreamTask.performCheckpoint(StreamTask.java:589)
org.apache.flink.streaming.runtime.tasks.StreamTask.triggerCheckpointOnBarrier(StreamTask.java:542)
org.apache.flink.streaming.runtime.io.BarrierBuffer.notifyCheckpoint(BarrierBuffer.java:378)
org.apache.flink.streaming.runtime.io.BarrierBuffer.processBarrier(BarrierBuffer.java:281)
org.apache.flink.streaming.runtime.io.BarrierBuffer.getNextNonBlocked(BarrierBuffer.java:183)
org.apache.flink.streaming.runtime.io.StreamInputProcessor.processInput(StreamInputProcessor.java:213)
org.apache.flink.streaming.runtime.tasks.OneInputStreamTask.run(OneInputStreamTask.java:69)
org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:262)
org.apache.flink.runtime.taskmanager.Task.run(Task.java:702)
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why is the task stucked?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13097666">FLINK-7524</key>
            <summary>Task &quot;xxx&quot; did not react to cancelling signal, but is stuck in method</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10004">Not A Bug</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="phoenixjiangnan">Bowen Li</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Aug 2017 18:10:35 +0000</created>
                <updated>Mon, 25 Sep 2017 15:50:43 +0000</updated>
                            <resolved>Wed, 30 Aug 2017 16:49:48 +0000</resolved>
                                    <version>1.3.0</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16146098" author="phoenixjiangnan" created="Tue, 29 Aug 2017 20:51:56 +0000"  >&lt;p&gt;This seems to be due to Flink TM ran out of memory. After switching from filesystemstatebackend to rocksdbstatebackend, the memory usage has gone down a lot, and this issue never happens again.&lt;/p&gt;</comment>
                            <comment id="16152697" author="githubbot" created="Mon, 4 Sep 2017 15:06:34 +0000"  >&lt;p&gt;GitHub user StefanRRichter opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7524&quot; title=&quot;Task &amp;quot;xxx&amp;quot; did not react to cancelling signal, but is stuck in method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7524&quot;&gt;&lt;del&gt;FLINK-7524&lt;/del&gt;&lt;/a&gt; Remove potentially blocking behaviour from AbstractClose&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;ableRegistry&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR removes potential for blocking behaviour in all CloseableRegistries.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Change is tested in `AbstractCloseableRegistryTest::testNonBlockingClose`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature?  (no)&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StefanRRichter/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StefanRRichter/flink&lt;/a&gt; improve-closeable-registry&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4639&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit a11bc242031134504d80c66e3349772e315fa2cf&lt;br/&gt;
Author: Stefan Richter &amp;lt;s.richter@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-09-04T10:30:41Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7524&quot; title=&quot;Task &amp;quot;xxx&amp;quot; did not react to cancelling signal, but is stuck in method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7524&quot;&gt;&lt;del&gt;FLINK-7524&lt;/del&gt;&lt;/a&gt; Remove potentially blocking behaviour from AbstractCloseableRegistry&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16152698" author="githubbot" created="Mon, 4 Sep 2017 15:06:50 +0000"  >&lt;p&gt;Github user StefanRRichter commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    CC @aljoscha &lt;/p&gt;</comment>
                            <comment id="16152989" author="githubbot" created="Tue, 5 Sep 2017 00:01:16 +0000"  >&lt;p&gt;Github user bowenli86 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r136877433&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r136877433&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/AbstractCloseableRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -61,13 +75,14 @@ public final void registerClosable(C closeable) throws IOException {&lt;br/&gt;
     		}&lt;/p&gt;

&lt;p&gt;     		synchronized (getSynchronizationLock()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (closed) {&lt;/li&gt;
	&lt;li&gt;IOUtils.closeQuietly(closeable);&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Cannot register Closeable, registry is already closed. Closing argument.&quot;);&lt;br/&gt;
    +			if (!closed) 
{
    +				doRegister(closeable, closeableToRef);
    +				return;
     			}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;doRegister(closeable, closeableToRef);&lt;br/&gt;
     		}&lt;br/&gt;
    +&lt;br/&gt;
    +		IOUtils.closeQuietly(closeable);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Should this also be in synchronized block?&lt;/p&gt;</comment>
                            <comment id="16152991" author="githubbot" created="Tue, 5 Sep 2017 00:06:31 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r136877616&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r136877616&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/AbstractCloseableRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -61,13 +75,14 @@ public final void registerClosable(C closeable) throws IOException {&lt;br/&gt;
     		}&lt;/p&gt;

&lt;p&gt;     		synchronized (getSynchronizationLock()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (closed) {&lt;/li&gt;
	&lt;li&gt;IOUtils.closeQuietly(closeable);&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Cannot register Closeable, registry is already closed. Closing argument.&quot;);&lt;br/&gt;
    +			if (!closed) 
{
    +				doRegister(closeable, closeableToRef);
    +				return;
     			}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;doRegister(closeable, closeableToRef);&lt;br/&gt;
     		}&lt;br/&gt;
    +&lt;br/&gt;
    +		IOUtils.closeQuietly(closeable);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think it should not. For some distributed filesystems a call to `close()` could block and would keep the registry blocked. We only need to synchronize the access to the internal map and the closed flag.&lt;/p&gt;</comment>
                            <comment id="16152992" author="githubbot" created="Tue, 5 Sep 2017 00:10:14 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r136877817&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r136877817&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/AbstractCloseableRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -61,13 +75,14 @@ public final void registerClosable(C closeable) throws IOException {&lt;br/&gt;
     		}&lt;/p&gt;

&lt;p&gt;     		synchronized (getSynchronizationLock()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (closed) {&lt;/li&gt;
	&lt;li&gt;IOUtils.closeQuietly(closeable);&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Cannot register Closeable, registry is already closed. Closing argument.&quot;);&lt;br/&gt;
    +			if (!closed) 
{
    +				doRegister(closeable, closeableToRef);
    +				return;
     			}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;doRegister(closeable, closeableToRef);&lt;br/&gt;
     		}&lt;br/&gt;
    +&lt;br/&gt;
    +		IOUtils.closeQuietly(closeable);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    In general, the idea of the change is to move every call that could block or aquire other locks, with a potential to deadlock outside of the synchronized blocks, so that this class will never block for other threads.&lt;/p&gt;</comment>
                            <comment id="16153002" author="githubbot" created="Tue, 5 Sep 2017 00:52:35 +0000"  >&lt;p&gt;Github user bowenli86 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r136879648&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r136879648&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/AbstractCloseableRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -61,13 +75,14 @@ public final void registerClosable(C closeable) throws IOException {&lt;br/&gt;
     		}&lt;/p&gt;

&lt;p&gt;     		synchronized (getSynchronizationLock()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (closed) {&lt;/li&gt;
	&lt;li&gt;IOUtils.closeQuietly(closeable);&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Cannot register Closeable, registry is already closed. Closing argument.&quot;);&lt;br/&gt;
    +			if (!closed) 
{
    +				doRegister(closeable, closeableToRef);
    +				return;
     			}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;doRegister(closeable, closeableToRef);&lt;br/&gt;
     		}&lt;br/&gt;
    +&lt;br/&gt;
    +		IOUtils.closeQuietly(closeable);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I see&lt;/p&gt;</comment>
                            <comment id="16176202" author="githubbot" created="Fri, 22 Sep 2017 09:48:58 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r140452104&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r140452104&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/core/fs/AbstractCloseableRegistryTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,230 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + * &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.core.fs;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.core.testutils.OneShotLatch;&lt;br/&gt;
    +import org.apache.flink.util.AbstractCloseableRegistry;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.Closeable;&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicInteger;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.mockito.Mockito.doAnswer;&lt;br/&gt;
    +import static org.mockito.Mockito.verify;&lt;br/&gt;
    +import static org.powermock.api.mockito.PowerMockito.spy;&lt;br/&gt;
    +&lt;br/&gt;
    +public abstract class AbstractCloseableRegistryTest&amp;lt;C extends Closeable, T&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +	protected ProducerThread[] streamOpenThreads;&lt;br/&gt;
    +	protected AbstractCloseableRegistry&amp;lt;C, T&amp;gt; closeableRegistry;&lt;br/&gt;
    +	protected AtomicInteger unclosedCounter;&lt;br/&gt;
    +&lt;br/&gt;
    +	protected abstract C createCloseable();&lt;br/&gt;
    +&lt;br/&gt;
    +	protected abstract AbstractCloseableRegistry&amp;lt;C, T&amp;gt; createRegistry();&lt;br/&gt;
    +&lt;br/&gt;
    +	protected abstract ProducerThread&amp;lt;C, T&amp;gt; createProducerThread(&lt;br/&gt;
    +		AbstractCloseableRegistry&amp;lt;C, T&amp;gt; registry,&lt;br/&gt;
    +		AtomicInteger unclosedCounter,&lt;br/&gt;
    +		int maxStreams);&lt;br/&gt;
    +&lt;br/&gt;
    +	public void setup() {&lt;br/&gt;
    +		Assert.assertFalse(SafetyNetCloseableRegistry.isReaperThreadRunning());&lt;br/&gt;
    +		this.closeableRegistry = createRegistry();&lt;br/&gt;
    +		this.unclosedCounter = new AtomicInteger(0);&lt;br/&gt;
    +		this.streamOpenThreads = new ProducerThread&lt;span class=&quot;error&quot;&gt;&amp;#91;10&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +		for (int i = 0; i &amp;lt; streamOpenThreads.length; ++i) &lt;/p&gt;
{
    +			streamOpenThreads[i] = createProducerThread(closeableRegistry, unclosedCounter, Integer.MAX_VALUE);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	protected void startThreads(int maxStreams) {&lt;br/&gt;
    +		for (ProducerThread t : streamOpenThreads) &lt;/p&gt;
{
    +			t.setMaxStreams(maxStreams);
    +			t.start();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	protected void joinThreads() throws InterruptedException {&lt;br/&gt;
    +		for (Thread t : streamOpenThreads) &lt;/p&gt;
{
    +			t.join();
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testClose() throws Exception {&lt;br/&gt;
    +&lt;br/&gt;
    +		setup();&lt;br/&gt;
    +		startThreads(Integer.MAX_VALUE);&lt;br/&gt;
    +&lt;br/&gt;
    +		for (int i = 0; i &amp;lt; 5; ++i) &lt;/p&gt;
{
    +			System.gc();
    +			Thread.sleep(40);
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		closeableRegistry.close();&lt;br/&gt;
    +&lt;br/&gt;
    +		joinThreads();&lt;br/&gt;
    +&lt;br/&gt;
    +		Assert.assertEquals(0, unclosedCounter.get());&lt;br/&gt;
    +		Assert.assertEquals(0, closeableRegistry.getNumberOfRegisteredCloseables());&lt;br/&gt;
    +&lt;br/&gt;
    +		final C testCloseable = spy(createCloseable());&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +
    +			closeableRegistry.registerClosable(testCloseable);
    +
    +			Assert.fail(&quot;Closed registry should not accept closeables!&quot;);
    +
    +		}
&lt;p&gt; catch (IOException expected) &lt;/p&gt;
{
    +			//expected
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		Assert.assertEquals(0, unclosedCounter.get());&lt;br/&gt;
    +		Assert.assertEquals(0, closeableRegistry.getNumberOfRegisteredCloseables());&lt;br/&gt;
    +		verify(testCloseable).close();&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNonBlockingClose() throws Exception {&lt;br/&gt;
    +		setup();&lt;br/&gt;
    +&lt;br/&gt;
    +		final OneShotLatch waitRegistryClosedLatch = new OneShotLatch();&lt;br/&gt;
    +		final OneShotLatch blockCloseLatch = new OneShotLatch();&lt;br/&gt;
    +&lt;br/&gt;
    +		final C spyCloseable = spy(createCloseable());&lt;br/&gt;
    +&lt;br/&gt;
    +		doAnswer(invocationOnMock -&amp;gt; &lt;/p&gt;
{
    +			invocationOnMock.callRealMethod();
    +			waitRegistryClosedLatch.trigger();
    +			blockCloseLatch.await();
    +			return null;
    +		}
&lt;p&gt;).when(spyCloseable).close();&lt;br/&gt;
    +&lt;br/&gt;
    +		closeableRegistry.registerClosable(spyCloseable);&lt;br/&gt;
    +&lt;br/&gt;
    +		Assert.assertEquals(1, closeableRegistry.getNumberOfRegisteredCloseables());&lt;br/&gt;
    +&lt;br/&gt;
    +		Thread closer = new Thread(() -&amp;gt; {&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				closeableRegistry.close();
    +			}
&lt;p&gt; catch (IOException ignore) &lt;/p&gt;
{
    +
    +			}
&lt;p&gt;    +		});&lt;br/&gt;
    +&lt;br/&gt;
    +		closer.start();&lt;br/&gt;
    +		waitRegistryClosedLatch.await();&lt;br/&gt;
    +&lt;br/&gt;
    +		final C testCloseable = spy(createCloseable());&lt;br/&gt;
    +&lt;br/&gt;
    +		try &lt;/p&gt;
{
    +			closeableRegistry.registerClosable(testCloseable);
    +			Assert.fail(&quot;Closed registry should not accept closeables!&quot;);
    +		}
&lt;p&gt;catch (IOException ignore) &lt;/p&gt;
{
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		blockCloseLatch.trigger();&lt;br/&gt;
    +		closer.join();&lt;br/&gt;
    +&lt;br/&gt;
    +		verify(spyCloseable).close();&lt;br/&gt;
    +		verify(testCloseable).close();&lt;br/&gt;
    +		Assert.assertEquals(0, closeableRegistry.getNumberOfRegisteredCloseables());&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	protected static abstract class ProducerThread&amp;lt;C extends Closeable, T&amp;gt; extends Thread {&lt;br/&gt;
    +&lt;br/&gt;
    +		protected final AbstractCloseableRegistry&amp;lt;C, T&amp;gt; registry;&lt;br/&gt;
    +		protected final AtomicInteger refCount;&lt;br/&gt;
    +		protected int maxStreams;&lt;br/&gt;
    +&lt;br/&gt;
    +		public ProducerThread(AbstractCloseableRegistry&amp;lt;C, T&amp;gt; registry, AtomicInteger refCount, int maxStreams) &lt;/p&gt;
{
    +			this.registry = registry;
    +			this.refCount = refCount;
    +			this.maxStreams = maxStreams;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public int getMaxStreams() &lt;/p&gt;
{
    +			return maxStreams;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		public void setMaxStreams(int maxStreams) &lt;/p&gt;
{
    +			this.maxStreams = maxStreams;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		protected abstract void createAndRegisterStream() throws IOException;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void run() {&lt;br/&gt;
    +			try {&lt;br/&gt;
    +				while (maxStreams &amp;gt; 0) {&lt;br/&gt;
    +&lt;br/&gt;
    +					createAndRegisterStream();&lt;br/&gt;
    +&lt;br/&gt;
    +					try &lt;/p&gt;
{
    +						Thread.sleep(2);
    +					}
&lt;p&gt; catch (InterruptedException ignored) {}&lt;br/&gt;
    +&lt;br/&gt;
    +					if (maxStreams != Integer.MAX_VALUE) {&lt;br/&gt;
    +						--maxStreams;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: I always find it strange when a field that should be a final is also used as a &quot;counter&quot;. In those cases there should probably be a field `numStream` and you loop until `maxStreams == openStreams`.&lt;/p&gt;</comment>
                            <comment id="16176203" author="githubbot" created="Fri, 22 Sep 2017 09:48:58 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r140448606&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r140448606&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/AbstractCloseableRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -61,13 +75,14 @@ public final void registerClosable(C closeable) throws IOException {&lt;br/&gt;
     		}&lt;/p&gt;

&lt;p&gt;     		synchronized (getSynchronizationLock()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (closed) {&lt;/li&gt;
	&lt;li&gt;IOUtils.closeQuietly(closeable);&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Cannot register Closeable, registry is already closed. Closing argument.&quot;);&lt;br/&gt;
    +			if (!closed) 
{
    +				doRegister(closeable, closeableToRef);
    +				return;
     			}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;doRegister(closeable, closeableToRef);&lt;br/&gt;
     		}&lt;br/&gt;
    +&lt;br/&gt;
    +		IOUtils.closeQuietly(closeable);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I&apos;m wondering, should it actually be the responsibility of the registry to close the `closeable` if it&apos;s already closed or should it be the responsibility of however wants to register that closable?&lt;/p&gt;</comment>
                            <comment id="16176204" author="githubbot" created="Fri, 22 Sep 2017 09:48:58 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r140449401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r140449401&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/WrappingProxyUtil.java &amp;#8212;&lt;br/&gt;
    @@ -27,10 +27,16 @@ private WrappingProxyUtil() &lt;/p&gt;
{
     		throw new AssertionError();
     	}

&lt;p&gt;    +	@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     	public static &amp;lt;T&amp;gt; T stripProxy(T object) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;while (object instanceof WrappingProxy) {&lt;br/&gt;
    +&lt;br/&gt;
    +		T previous = null;&lt;br/&gt;
    +&lt;br/&gt;
    +		while (object instanceof WrappingProxy &amp;amp;&amp;amp; previous != object) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Guarding against infinite looping in case the bottom-most object is also a `WrappingProxy`?&lt;/p&gt;</comment>
                            <comment id="16176207" author="githubbot" created="Fri, 22 Sep 2017 09:52:31 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r140454362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r140454362&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/WrappingProxyUtil.java &amp;#8212;&lt;br/&gt;
    @@ -27,10 +27,16 @@ private WrappingProxyUtil() &lt;/p&gt;
{
     		throw new AssertionError();
     	}

&lt;p&gt;    +	@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     	public static &amp;lt;T&amp;gt; T stripProxy(T object) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;while (object instanceof WrappingProxy) {&lt;br/&gt;
    +&lt;br/&gt;
    +		T previous = null;&lt;br/&gt;
    +&lt;br/&gt;
    +		while (object instanceof WrappingProxy &amp;amp;&amp;amp; previous != object) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Exactly, somebody could come up with the stupid idea to return ``this`` as inner object. Just to be on the safe side.&lt;/p&gt;</comment>
                            <comment id="16176210" author="githubbot" created="Fri, 22 Sep 2017 09:55:58 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r140455067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r140455067&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/AbstractCloseableRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -61,13 +75,14 @@ public final void registerClosable(C closeable) throws IOException {&lt;br/&gt;
     		}&lt;/p&gt;

&lt;p&gt;     		synchronized (getSynchronizationLock()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (closed) {&lt;/li&gt;
	&lt;li&gt;IOUtils.closeQuietly(closeable);&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Cannot register Closeable, registry is already closed. Closing argument.&quot;);&lt;br/&gt;
    +			if (!closed) 
{
    +				doRegister(closeable, closeableToRef);
    +				return;
     			}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;doRegister(closeable, closeableToRef);&lt;br/&gt;
     		}&lt;br/&gt;
    +&lt;br/&gt;
    +		IOUtils.closeQuietly(closeable);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I have this done on purpose. For the time a ``Closeable`` is registered, it is managed by the registry but I do not want to stop somebody from removing a ``Closeable`` again and reclaim responsibility over the resource. I was, however, considering a convenience method that does the remove-and-close in one call. &lt;/p&gt;</comment>
                            <comment id="16176212" author="githubbot" created="Fri, 22 Sep 2017 09:57:46 +0000"  >&lt;p&gt;Github user StefanRRichter commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r140455425&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r140455425&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/AbstractCloseableRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -61,13 +75,14 @@ public final void registerClosable(C closeable) throws IOException {&lt;br/&gt;
     		}&lt;/p&gt;

&lt;p&gt;     		synchronized (getSynchronizationLock()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (closed) {&lt;/li&gt;
	&lt;li&gt;IOUtils.closeQuietly(closeable);&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Cannot register Closeable, registry is already closed. Closing argument.&quot;);&lt;br/&gt;
    +			if (!closed) 
{
    +				doRegister(closeable, closeableToRef);
    +				return;
     			}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;doRegister(closeable, closeableToRef);&lt;br/&gt;
     		}&lt;br/&gt;
    +&lt;br/&gt;
    +		IOUtils.closeQuietly(closeable);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    And for the second part, I think it should be closed automatically, because you the caller decides to give the responsibility to the registry and tie it to the registry&apos;s status. So the registry should take care that the close status is propagated to new incoming objects.&lt;/p&gt;</comment>
                            <comment id="16176539" author="githubbot" created="Fri, 22 Sep 2017 15:00:07 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639#discussion_r140516796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639#discussion_r140516796&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/util/AbstractCloseableRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -61,13 +75,14 @@ public final void registerClosable(C closeable) throws IOException {&lt;br/&gt;
     		}&lt;/p&gt;

&lt;p&gt;     		synchronized (getSynchronizationLock()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (closed) {&lt;/li&gt;
	&lt;li&gt;IOUtils.closeQuietly(closeable);&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Cannot register Closeable, registry is already closed. Closing argument.&quot;);&lt;br/&gt;
    +			if (!closed) 
{
    +				doRegister(closeable, closeableToRef);
    +				return;
     			}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;doRegister(closeable, closeableToRef);&lt;br/&gt;
     		}&lt;br/&gt;
    +&lt;br/&gt;
    +		IOUtils.closeQuietly(closeable);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Makes sense! &#128076; &lt;/p&gt;
</comment>
                            <comment id="16179194" author="githubbot" created="Mon, 25 Sep 2017 15:49:34 +0000"  >&lt;p&gt;Github user StefanRRichter closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4639&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4639&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16179196" author="srichter" created="Mon, 25 Sep 2017 15:50:43 +0000"  >&lt;p&gt;I still found some small potential for improvement that is merged in 0073204b25.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 8 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3jatj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>