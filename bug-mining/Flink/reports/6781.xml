<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:15:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-28695] Fail to send partition request to restarted taskmanager</title>
                <link>https://issues.apache.org/jira/browse/FLINK-28695</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;After upgrade to &lt;b&gt;1.15.1&lt;/b&gt; we started getting error while running JOB&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.flink.runtime.io.network.netty.exception.LocalTransportException: Sending the partition request to &lt;span class=&quot;code-quote&quot;&gt;&apos;/XXX.XXX.XX.32:6121 (#0)&apos;&lt;/span&gt; failed.    at org.apache.flink.runtime.io.network.netty.NettyPartitionRequestClient$1.operationComplete(NettyPartitionRequestClient.java:145)    .... &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: org.apache.flink.shaded.netty4.io.netty.channel.StacklessClosedChannelException atrg.apache.flink.shaded.netty4.io.netty.channel.AbstractChannel$AbstractUnsafe.write(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, ChannelPromise)(Unknown Source)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After investigation we managed narrow it down to the exact behavior then this issue happens:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Deploying JOB on fresh kubernetes session cluster with multiple TaskManagers: TM1 and TM2 is successful. Job has multiple partitions running on both TM1 and TM2.&lt;/li&gt;
	&lt;li&gt;One TaskManager TM2 (XXX.XXX.XX.32) fails for unrelated issue. For example OOM exception.&lt;/li&gt;
	&lt;li&gt;Kubernetes POD with mentioned TaskManager TM2 is restarted. POD retains same IP address as before.&lt;/li&gt;
	&lt;li&gt;JobManager is able to pickup the restarted TM2 (XXX.XXX.XX.32)&lt;/li&gt;
	&lt;li&gt;JOB is restarted because it was running on the failed TaskManager TM2&lt;/li&gt;
	&lt;li&gt;TM1 data channel to TM2 is closed and we get LocalTransportException: Sending the partition request to &apos;/XXX.XXX.XX.32:6121 (#0)&apos; failed during JOB running stage.&#160;&#160;&lt;/li&gt;
	&lt;li&gt;When we explicitly delete pod with TM2 it creates new POD with different IP address and JOB is able to start again.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Important to note that we didn&apos;t encountered this issue with previous &lt;b&gt;1.14.4&lt;/b&gt; version and TaskManager restarts didn&apos;t cause such error.&lt;/p&gt;

&lt;p&gt;Please note attached kubernetes deployments and reduced logs from JobManager. TaskManager logs did show errors before error, but doesn&apos;t show anything significant after restart.&lt;/p&gt;

&lt;p&gt;EDIT:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Setting &lt;tt&gt;taskmanager.network.max-num-tcp-connections&lt;/tt&gt; to a very high number workarounds the problem&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="13473576">FLINK-28695</key>
            <summary>Fail to send partition request to restarted taskmanager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fanrui">Rui Fan</assignee>
                                    <reporter username="simonas.gelazevicius@vinted.com">Simonas</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 26 Jul 2022 14:00:23 +0000</created>
                <updated>Wed, 25 Oct 2023 20:47:21 +0000</updated>
                            <resolved>Mon, 21 Nov 2022 18:51:18 +0000</resolved>
                                    <version>1.15.0</version>
                    <version>1.15.1</version>
                                    <fixVersion>1.17.0</fixVersion>
                    <fixVersion>1.16.1</fixVersion>
                    <fixVersion>1.15.4</fixVersion>
                                    <component>Deployment / Kubernetes</component>
                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17628826" author="brian zhou" created="Fri, 4 Nov 2022 09:38:11 +0000"  >&lt;p&gt;We have experienced this issue on Flink 1.15, is there anyone that can help on this issue?&lt;/p&gt;</comment>
                            <comment id="17629570" author="brian zhou" created="Mon, 7 Nov 2022 02:47:32 +0000"  >&lt;p&gt;From investigating the code, looks like it is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22643&quot; title=&quot;Too many TCP connections among TaskManagers for large scale jobs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22643&quot;&gt;&lt;del&gt;FLINK-22643&lt;/del&gt;&lt;/a&gt;. While reusing the TCP connections in taskmanagers, it also brings the risk that the reusing the dead connection if the IP address does not change under a Kubernetes session cluster.&lt;/p&gt;

&lt;p&gt;Ping the author &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt; for further discussion and help on this issue.&lt;/p&gt;</comment>
                            <comment id="17629572" author="fanrui" created="Mon, 7 Nov 2022 02:52:39 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Brian+Zhou&quot; class=&quot;user-hover&quot; rel=&quot;Brian Zhou&quot;&gt;Brian Zhou&lt;/a&gt; , thanks for your feedback, I will take a look this week. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17629583" author="weijie guo" created="Mon, 7 Nov 2022 04:04:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Brian+Zhou&quot; class=&quot;user-hover&quot; rel=&quot;Brian Zhou&quot;&gt;Brian Zhou&lt;/a&gt; Just to confirm, if you do not manually delete the POD of TM2, what is the status of job, can this job recover from the exception thrown in 6 or never recover? If so, is the job constantly reporting this errors or is it stuck?&lt;/p&gt;</comment>
                            <comment id="17629596" author="brian zhou" created="Mon, 7 Nov 2022 05:33:12 +0000"  >&lt;p&gt;Not sure if the original reporter has the same, but from our testing, the job is constantly reporting with this error and keeps restarting.&lt;/p&gt;</comment>
                            <comment id="17629601" author="weijie guo" created="Mon, 7 Nov 2022 06:17:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Brian+Zhou&quot; class=&quot;user-hover&quot; rel=&quot;Brian Zhou&quot;&gt;Brian Zhou&lt;/a&gt; If you suspect that the problem is caused by connection reuse, you can try to set `taskmanager.network.max-num-tcp-connections` to a large value.What I&apos;m puzzled about is that even if the TCP connection between two TMs is reused, the K8S should theoretically be able to correctly deliver the message to the new pod. And It sounds like you can reproduce this problem, could you provide me with a minimum reproducible approach to do further investigation.&lt;/p&gt;</comment>
                            <comment id="17629618" author="brian zhou" created="Mon, 7 Nov 2022 07:16:51 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt; for your suggestion, we can try that.&lt;/p&gt;

&lt;p&gt;For reproduction, in our case, we are experiencing this issue on a Kubernetes node reboot case. In other words, the other steps are the same as the description, except Step 2, we have a node reboot.&#160;&lt;/p&gt;

&lt;p&gt;However, unfortunately, we have tested several times during the weekend with the same steps, but cannot reproduce the problem.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17635285" author="nobleyd" created="Thu, 17 Nov 2022 10:51:41 +0000"  >&lt;p&gt;We also encounter this problem in production, and task failures will continue to restart because of this problem.&lt;/p&gt;</comment>
                            <comment id="17635947" author="pnowojski" created="Fri, 18 Nov 2022 16:22:17 +0000"  >&lt;p&gt;I&apos;ve assigned the ticket to you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt;. Please ping me/request a review from me once you have some fix ready.&lt;/p&gt;

&lt;p&gt;In the meantime can someone, who can reproduce this issue, try out if setting &lt;tt&gt;`taskmanager.network.max-num-tcp-connections`&lt;/tt&gt; to a very high number work arounds the problem?&lt;/p&gt;</comment>
                            <comment id="17636273" author="fanrui" created="Sun, 20 Nov 2022 08:21:30 +0000"  >&lt;p&gt;Thank you all for your feedback.&lt;/p&gt;

&lt;p&gt;After analysis, I think the root cause is as follows:&lt;/p&gt;

&lt;p&gt;`CreditBasedPartitionRequestClientHandler#channelInactive` doesn&apos;t call the `notifyAllChannelsOfErrorAndClose` when &#160;the `inputChannels.isEmpty()`.&lt;/p&gt;

&lt;p&gt;code link: &lt;a href=&quot;https://github.com/apache/flink/blob/d745f5b3f7a64445854c735668afa9b72edb3fee/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java#L126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/d745f5b3f7a64445854c735668afa9b72edb3fee/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java#L126&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13052899/13052899_image-2022-11-20-16-16-45-705.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15455&quot; title=&quot;Enable TCP connection reuse across multiple jobs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15455&quot;&gt;&lt;del&gt;FLINK-15455&lt;/del&gt;&lt;/a&gt; enables TCP connection reuse across multiple jobs. That means `CreditBasedPartitionRequestClientHandler#channelInactive` doesn&apos;t call the `notifyAllChannelsOfErrorAndClose` when &#160;after old job stop and before new job start. If the tcp connection is disconnected during this period, the new job should create a new tcp connection. However, the `PartitionRequestClientFactory` doesn&apos;t know that the tcp connection is broken, so the new job reuses the failed connection.&lt;/p&gt;

&lt;p&gt;Please correct me if there is any mistake. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Weijie+Guo&quot; class=&quot;user-hover&quot; rel=&quot;Weijie Guo&quot;&gt;Weijie Guo&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guoyangze&quot; class=&quot;user-hover&quot; rel=&quot;guoyangze&quot;&gt;guoyangze&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17636390" author="nobleyd" created="Mon, 21 Nov 2022 02:15:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Hi, we have the same problem, and adjusting `taskmanager.network.max-num-tcp-connections` words fine.&lt;/p&gt;</comment>
                            <comment id="17636563" author="pnowojski" created="Mon, 21 Nov 2022 08:54:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt; What&apos;s your proposed solution? If the &lt;tt&gt;inputChannels&lt;/tt&gt; is empty how would calling &lt;tt&gt;notifyAllChannelsOfErrorAndClose&lt;/tt&gt; help with anything? Would it help, because it would set &lt;tt&gt;channelError&lt;/tt&gt; for any future use? &lt;/p&gt;</comment>
                            <comment id="17636577" author="fanrui" created="Mon, 21 Nov 2022 09:20:28 +0000"  >&lt;p&gt;&amp;gt; Would it help, because it would set &lt;tt&gt;channelError&lt;/tt&gt;&#160;for any future use?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt; Yes, you&apos;re right. From the notifyAllChannelsOfErrorAndClose code, we can see if inputChannels is empty, nothing to to do. It just set channelError and close ctx.&lt;/p&gt;

&lt;p&gt;The channelError will be used within &lt;em&gt;PartitionRequestClientFactory#createPartitionRequestClient&lt;/em&gt;. When create the new client, factory will think the old client has error, so create a new client.&lt;/p&gt;

&lt;p&gt;If channelError is null, factory will think old client is well, so don&apos;t create the new client, and reuse the old client.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13052921/13052921_image-2022-11-21-17-15-58-749.png&quot; height=&quot;696&quot; width=&quot;1273&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17636590" author="pnowojski" created="Mon, 21 Nov 2022 09:37:26 +0000"  >&lt;p&gt;Thanks for the explanation!&lt;/p&gt;</comment>
                            <comment id="17636833" author="pnowojski" created="Mon, 21 Nov 2022 18:51:18 +0000"  >&lt;p&gt;merged commit 6b56505 into apache:release-1.15 &lt;br/&gt;
merged commit ecede7a into apache:release-1.16 &lt;br/&gt;
merged e7854193816^^^..e7854193816 into apache:master&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt; for fixing, and others for reporting/analyzing and confirming the bug and workaround.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13277163">FLINK-15455</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13047246" name="deployment.txt" size="7161" author="simonas.gelazevicius@vinted.com" created="Tue, 26 Jul 2022 13:43:18 +0000"/>
                            <attachment id="13063871" name="image-1.png" size="97140" author="kibebr" created="Wed, 25 Oct 2023 20:47:21 +0000"/>
                            <attachment id="13052899" name="image-2022-11-20-16-16-45-705.png" size="97140" author="fanrui" created="Sun, 20 Nov 2022 08:16:47 +0000"/>
                            <attachment id="13052921" name="image-2022-11-21-17-15-58-749.png" size="161273" author="fanrui" created="Mon, 21 Nov 2022 09:16:00 +0000"/>
                            <attachment id="13063870" name="image.png" size="161273" author="kibebr" created="Wed, 25 Oct 2023 20:47:13 +0000"/>
                            <attachment id="13047241" name="job_log.txt" size="2742" author="simonas.gelazevicius@vinted.com" created="Tue, 26 Jul 2022 13:55:53 +0000"/>
                            <attachment id="13047244" name="jobmanager_config.txt" size="1736" author="simonas.gelazevicius@vinted.com" created="Tue, 26 Jul 2022 13:49:17 +0000"/>
                            <attachment id="13047242" name="jobmanager_logs.txt" size="479" author="simonas.gelazevicius@vinted.com" created="Tue, 26 Jul 2022 13:54:25 +0000"/>
                            <attachment id="13047243" name="pod_restart.txt" size="570" author="simonas.gelazevicius@vinted.com" created="Tue, 26 Jul 2022 13:53:05 +0000"/>
                            <attachment id="13047245" name="taskmanager_config.txt" size="1453" author="simonas.gelazevicius@vinted.com" created="Tue, 26 Jul 2022 13:49:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z177d4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>