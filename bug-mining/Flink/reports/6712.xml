<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:14:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-29395] [Kinesis][EFO] Issue using EFO consumer at timestamp with empty shard</title>
                <link>https://issues.apache.org/jira/browse/FLINK-29395</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Background&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The consumer fails when an EFO record publisher uses a timestamp sentinel starting position, the first record batch is not empty, but the first deaggregated record batch is empty. This can happen if the user explicitly specifies the hashkey in the KPL, and does not ensure that the explicitHashKey of every record in the aggregated batch is the same.&lt;/p&gt;

&lt;p&gt;When resharding occurs, the aggregated record batch can have records that are out of the shard&apos;s hash key range. This causes the records to be dropped when deaggregating, and can result in this situation, where record batch is not empty, but the deaggregated record batch is empty.&lt;/p&gt;

&lt;p&gt;The symptom seen is similar to the issue seen in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20088&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-20088&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://github.com/awslabs/kinesis-aggregation/blob/master/potential_data_loss.md&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;https://github.com/awslabs/kinesis-aggregation/issues/11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; for a more detailed explanation&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Replicate&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Get shard information&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
aws kinesis describe-stream --stream-name &amp;lt;stream_name&amp;gt;
{
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;StreamDescription&quot;&lt;/span&gt;: {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;Shards&quot;&lt;/span&gt;: [
&#160; &#160; &#160; &#160; &#160; &#160; ...
&#160; &#160; &#160; &#160; &#160; &#160; {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;ShardId&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;shardId-000000000037&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;ParentShardId&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;shardId-000000000027&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;HashKeyRange&quot;&lt;/span&gt;: {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;StartingHashKey&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;272225893536750770770699685945414569164&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;EndingHashKey&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;340282366920938463463374607431768211455&quot;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
            ...
&#160; &#160; &#160; &#160; &#160; &#160; },
&#160; &#160; &#160; &#160; &#160; &#160; {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;ShardId&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;shardId-000000000038&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;ParentShardId&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;shardId-000000000034&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;AdjacentParentShardId&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;shardId-000000000036&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;HashKeyRange&quot;&lt;/span&gt;: {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;StartingHashKey&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;204169420152563078078024764459060926873&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;EndingHashKey&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;272225893536750770770699685945414569163&quot;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
            ...
&#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; ]
...
&#160; &#160; }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Create an aggregate record with two records, each with explicit hash keys belonging to different shards&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
RecordAggregator aggregator = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RecordAggregator();
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; record1 = &lt;span class=&quot;code-quote&quot;&gt;&quot;RECORD_1&quot;&lt;/span&gt;;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; record2 = &lt;span class=&quot;code-quote&quot;&gt;&quot;RECORD_2&quot;&lt;/span&gt;;
aggregator.addUserRecord(&lt;span class=&quot;code-quote&quot;&gt;&quot;pk&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;272225893536750770770699685945414569162&quot;&lt;/span&gt;, record1.getBytes());
aggregator.addUserRecord(&lt;span class=&quot;code-quote&quot;&gt;&quot;pk&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;272225893536750770770699685945414569165&quot;&lt;/span&gt;, record2.getBytes());

AmazonKinesis kinesisClient = AmazonKinesisClient.builder()
   .build();
kinesisClient.putRecord(aggregator.clearAndGet().toPutRecordRequest(&lt;span class=&quot;code-quote&quot;&gt;&quot;EFOStreamTest&quot;&lt;/span&gt;)); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Consume from given stream whilst specifying a Timestamp where the only record retrieved is the record above.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Error&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalArgumentException: Unexpected sentinel type: AT_TIMESTAMP_SEQUENCE_NUM
	at org.apache.flink.streaming.connectors.kinesis.model.StartingPosition.fromSentinelSequenceNumber(StartingPosition.java:115)
	at org.apache.flink.streaming.connectors.kinesis.model.StartingPosition.fromSequenceNumber(StartingPosition.java:91)
	at org.apache.flink.streaming.connectors.kinesis.model.StartingPosition.continueFromSequenceNumber(StartingPosition.java:72)

	at 
org.apache.flink.streaming.connectors.kinesis.internals.publisher.fanout.FanOutRecordPublisher.lambda$run$0(FanOutRecordPublisher.java:120)

	at 
org.apache.flink.streaming.connectors.kinesis.internals.publisher.fanout.FanOutShardSubscriber.consumeAllRecordsFromKinesisShard(FanOutShardSubscriber.java:356)

	at 
org.apache.flink.streaming.connectors.kinesis.internals.publisher.fanout.FanOutShardSubscriber.subscribeToShardAndConsumeRecords(FanOutShardSubscriber.java:188)

	at 
org.apache.flink.streaming.connectors.kinesis.internals.publisher.fanout.FanOutRecordPublisher.runWithBackoff(FanOutRecordPublisher.java:154)

	at 
org.apache.flink.streaming.connectors.kinesis.internals.publisher.fanout.FanOutRecordPublisher.run(FanOutRecordPublisher.java:123)
	at org.apache.flink.streaming.connectors.kinesis.internals.ShardConsumer.run(ShardConsumer.java:114)
	at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
	at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Solution&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This is fixed by reusing the existing timestamp starting position in this condition.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13482777">FLINK-29395</key>
            <summary>[Kinesis][EFO] Issue using EFO consumer at timestamp with empty shard</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="liangtl">Hong Liang Teoh</assignee>
                                    <reporter username="liangtl">Hong Liang Teoh</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 22 Sep 2022 13:21:46 +0000</created>
                <updated>Thu, 20 Oct 2022 02:33:34 +0000</updated>
                            <resolved>Mon, 10 Oct 2022 13:42:42 +0000</resolved>
                                    <version>1.12.7</version>
                    <version>1.13.6</version>
                    <version>1.14.5</version>
                    <version>1.15.2</version>
                                    <fixVersion>1.16.0</fixVersion>
                    <fixVersion>1.17.0</fixVersion>
                    <fixVersion>1.15.3</fixVersion>
                                    <component>Connectors / Kinesis</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17615105" author="dannycranmer" created="Mon, 10 Oct 2022 13:01:32 +0000"  >&lt;p&gt;Merged commit&#160;&lt;a href=&quot;https://github.com/apache/flink/commit/ef93ae4525ea42a87baf77747dd3ffbc007112fd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;ef93ae4&lt;/tt&gt;&lt;/a&gt; into master&lt;br/&gt;
Merged commit &lt;a href=&quot;https://github.com/apache/flink/commit/7a1dccd3020ffefe83f1fa80ab70bc3150144640&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;7a1dccd&lt;/tt&gt;&lt;/a&gt; into release-1.16&#160;&lt;br/&gt;
Merged commit &lt;a href=&quot;https://github.com/apache/flink/commit/ae20e524671c26d87f4ffedd171c1ed3418be6d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;ae20e52&lt;/tt&gt;&lt;/a&gt; into release-1.15&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                            <outwardlinks description="is a clone of">
                                        <issuelink>
            <issuekey id="13339986">FLINK-20088</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 5 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18rr4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>