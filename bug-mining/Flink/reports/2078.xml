<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7266] Don&apos;t attempt to delete parent directory on S3</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7266</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently, every attempted release of an S3 state object also checks if the &quot;parent directory&quot; is empty and then tries to delete it.&lt;/p&gt;

&lt;p&gt;Not only is that unnecessary on S3, but it is prohibitively expensive and for example causes S3 to throttle calls by the JobManager on checkpoint cleanup.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;FileState&lt;/tt&gt; must only attempt parent directory cleanup when operating against real file systems, not when operating against object stores.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13089917">FLINK-7266</key>
            <summary>Don&apos;t attempt to delete parent directory on S3</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aljoscha">Aljoscha Krettek</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Jul 2017 15:32:27 +0000</created>
                <updated>Thu, 28 Feb 2019 13:20:38 +0000</updated>
                            <resolved>Fri, 17 Nov 2017 16:23:11 +0000</resolved>
                                    <version>1.3.1</version>
                                    <fixVersion>1.3.2</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16110453" author="srichter" created="Wed, 2 Aug 2017 07:22:20 +0000"  >&lt;p&gt;One comment about the &quot;not necessary on S3&quot; part: during the release 1.3.2 testing, I observed that I can see some empty directory entries remaining in S3. I added a screenshot in the testing document &lt;a href=&quot;https://docs.google.com/document/d/1dN9AM9FUPizIu4hTKAXJSbbAORRdrce-BqQ8AUHlOqE/edit?ts=59807985#&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. If this is not a problem, can the issue be closed or is the merge into 1.4 still pending?&lt;/p&gt;


</comment>
                            <comment id="16110535" author="stephanewen" created="Wed, 2 Aug 2017 08:34:21 +0000"  >&lt;p&gt;We could try and improve that by not dong the &lt;tt&gt;mkdirs()&lt;/tt&gt; call in the stream factory for each state element. That might help with that, but I would consider this to not be a release blocker.&lt;/p&gt;

&lt;p&gt;I would try and solve that in a more holistic way in 1.4.0, by extending the FileSystem abstraction and post-state release hooks in the Checkpoint Coordinator (so that there is one call to drop the directory marker file, if we cannot find a way for it to not be created in the first place.&lt;/p&gt;</comment>
                            <comment id="16110547" author="srichter" created="Wed, 2 Aug 2017 08:40:42 +0000"  >&lt;p&gt;I agree that we should not block the release on this. Just wanted to have this recorded with this issue, so that we can improve it for the future.&lt;/p&gt;</comment>
                            <comment id="16112606" author="aljoscha" created="Thu, 3 Aug 2017 11:46:56 +0000"  >&lt;p&gt;This is actually resolved on &lt;tt&gt;release-1.3&lt;/tt&gt; for the s3 filesystem.&lt;/p&gt;</comment>
                            <comment id="16153910" author="stevel@apache.org" created="Tue, 5 Sep 2017 16:20:19 +0000"  >&lt;p&gt;FWIW, in s3a we create a single delete request to rm all parent paths &lt;b&gt;and don&apos;t bother doing the existence check&lt;/b&gt;. &lt;/p&gt;

&lt;p&gt;That is, for a file a/b/c.txt, after the file is written in close(), POST a delete list of&lt;/p&gt;

&lt;p&gt;/a/&lt;br/&gt;
/a/b&lt;/p&gt;

&lt;p&gt;It&apos;s ~O(1)  for depth and as you don&apos;t need to wait for the response, even something you could being async on.&lt;/p&gt;</comment>
                            <comment id="16155151" author="aljoscha" created="Wed, 6 Sep 2017 10:23:07 +0000"  >&lt;p&gt;I think that&apos;s only part of the problem because Flink must check on its own whether the directory is empty before we can delete it.&lt;/p&gt;

&lt;p&gt;The basic problem is that each state handle is being cleaned up individually. If we had global knowledge that all state handles actually reside in on base directory then we could shoot of an asynchronous command that deletes that whole sub-directory. (Which might still be horribly slow on S3 and not solve the problem at all.)&lt;/p&gt;</comment>
                            <comment id="16155245" author="stevel@apache.org" created="Wed, 6 Sep 2017 11:47:12 +0000"  >&lt;p&gt;if you are using s3a then delete(path, recursive=false) will stop you from trying to delete a non-empty dir&lt;/p&gt;</comment>
                            <comment id="16168733" author="elevy" created="Sat, 16 Sep 2017 00:34:05 +0000"  >&lt;p&gt;I am curious what the state of this is.  It is still a problem on 1.3.2, making use of S3 with the file system state backend very imprudent in production.  You end up with thousands of empty &quot;directories&quot; in S3 for the checkpoints&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ $ sudo aws s3 ls --recursive s3:&lt;span class=&quot;code-comment&quot;&gt;//bucket/flink/checkpoints/58c7604fbc543b6df75b62601a9b4c9d/ 
&lt;/span&gt;2017-09-15 23:03:15          0 flink/checkpoints/58c7604fbc543b6df75b62601a9b4c9d/chk-1/
2017-09-15 23:04:15          0 flink/checkpoints/58c7604fbc543b6df75b62601a9b4c9d/chk-10/
2017-09-15 23:14:07          0 flink/checkpoints/58c7604fbc543b6df75b62601a9b4c9d/chk-100/
2017-09-15 23:14:14          0 flink/checkpoints/58c7604fbc543b6df75b62601a9b4c9d/chk-101/
2017-09-15 23:14:20          0 flink/checkpoints/58c7604fbc543b6df75b62601a9b4c9d/chk-102/
2017-09-15 23:15:12          0 flink/checkpoints/58c7604fbc543b6df75b62601a9b4c9d/chk-103/
2017-09-15 23:15:18          0 flink/checkpoints/58c7604fbc543b6df75b62601a9b4c9d/chk-104/
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16194915" author="stephanewen" created="Fri, 6 Oct 2017 17:34:40 +0000"  >&lt;p&gt;True, this is a problem in 1.3.2 - the tradeoff was to either have a very large amount of redundant requests for directory emptiness check (which cause the checkpointing to stall or be throttled) or to leave the &quot;directories&quot;.&lt;/p&gt;

&lt;p&gt;In Flink 1.4 we want to fix this by letting the checkpoints understand the file structure and make it a single call to drop the directory, as Steve suggested.&lt;br/&gt;
The current abstraction is overly generic (just things in arbitrary byte chunks) and does not understand that checkpoint files cluster together in directories.&lt;/p&gt;</comment>
                            <comment id="16201823" author="aljoscha" created="Thu, 12 Oct 2017 11:40:38 +0000"  >&lt;p&gt;For 1.4, this will be resolved by only deleting the parent directory on the master (in the checkpoint coordinator).&lt;/p&gt;</comment>
                            <comment id="16256920" author="aljoscha" created="Fri, 17 Nov 2017 12:40:44 +0000"  >&lt;p&gt;We actually have to fix this for 1.4 because we regress from 1.3, otherwise. The operation that deletes parent directories is too expensive and will basically DDOS s3, making Flink unusable for bigger installations with s3.&lt;/p&gt;</comment>
                            <comment id="16257146" author="aljoscha" created="Fri, 17 Nov 2017 15:50:18 +0000"  >&lt;p&gt;Fixed on master (to be 1.5) in&lt;br/&gt;
b00f1b326c1ab4221a555200a4d5798e1565b821&lt;/p&gt;</comment>
                            <comment id="16257178" author="aljoscha" created="Fri, 17 Nov 2017 16:23:11 +0000"  >&lt;p&gt;Fixed on release-1.4 in&lt;br/&gt;
666b1b2e62463ae4985d237535d56c9e0ab9dba9&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="13089915">FLINK-7265</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13099903">FLINK-7587</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13099903">FLINK-7587</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3152u:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>