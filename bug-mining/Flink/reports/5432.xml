<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:57:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-22494] Avoid discarding checkpoints in case of failure</title>
                <link>https://issues.apache.org/jira/browse/FLINK-22494</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Both &lt;tt&gt;StateHandleStore&lt;/tt&gt; implementations (i.e. &lt;a href=&quot;https://github.com/apache/flink/blob/c6997c97c575d334679915c328792b8a3067cfb5/flink-kubernetes/src/main/java/org/apache/flink/kubernetes/highavailability/KubernetesStateHandleStore.java#L157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;KubernetesStateHandleStore:157&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/flink/blob/c6997c97c575d334679915c328792b8a3067cfb5/flink-runtime/src/main/java/org/apache/flink/runtime/zookeeper/ZooKeeperStateHandleStore.java#L170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperStateHandleStore:170&lt;/a&gt;) discard checkpoints if the checkpoint metadata wasn&apos;t written to the backend. &lt;/p&gt;

&lt;p&gt;This does not cover the cases where the data was actually written to the backend but the call failed anyway (e.g. due to network issues). In such a case, we might end up having a pointer in the backend pointing to a checkpoint that was discarded.&lt;/p&gt;

&lt;p&gt;Instead of discarding the checkpoint data in this case, we might want to keep it for this specific use case. Otherwise, we might run into Exceptions when recovering from the Checkpoint later on. We might want to add a warning to the user pointing to the possibly orphaned checkpoint data.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13375384">FLINK-22494</key>
            <summary>Avoid discarding checkpoints in case of failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mapohl">Matthias Pohl</assignee>
                                    <reporter username="mapohl">Matthias Pohl</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 27 Apr 2021 16:24:12 +0000</created>
                <updated>Tue, 5 Jul 2022 07:03:48 +0000</updated>
                            <resolved>Tue, 18 May 2021 10:43:19 +0000</resolved>
                                    <version>1.13.0</version>
                    <version>1.14.0</version>
                    <version>1.12.3</version>
                                    <fixVersion>1.14.0</fixVersion>
                    <fixVersion>1.13.1</fixVersion>
                    <fixVersion>1.12.5</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17333365" author="mapohl" created="Tue, 27 Apr 2021 16:27:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt;: I had the discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpaul&quot; class=&quot;user-hover&quot; rel=&quot;fpaul&quot;&gt;fpaul&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; about this issue and we came to the conclusion that having an orphaned Checkpoint pointer in the ConfigMap isn&apos;t the best solution. Hence, I created this ticket to handle the this case.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;We might only remove the discard in case of failure since we cannot be sure whether the data was actually written to the backend or not in case of failure.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;In case of failure, we might only trigger the discard of the checkpoint if we can make sure that the ConfigMap wasn&apos;t updated.&lt;/p&gt;</comment>
                            <comment id="17333372" author="till.rohrmann" created="Tue, 27 Apr 2021 16:43:42 +0000"  >&lt;p&gt;If the exception allows to say that we did not write anything to ZK or K8s, then the checkpoint blobs can be removed.&lt;/p&gt;</comment>
                            <comment id="17334528" author="fly_in_gis" created="Wed, 28 Apr 2021 07:42:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;&#160;I agree with you that it is not a good behavior to have such&#160;orphaned checkpoint pointer in the ZNode or ConfigMap.&lt;/p&gt;

&lt;p&gt;Given that it could happen the ZK/K8s client failed with exception but the data was actually written to the ZNode/ConfigMap. I am not sure about how to guarantee that the data on the DFS is only discarded when writing ConfigMap/ZK has true failure. Do you mean we need to check the existence of ZNode / ConfigMap key before discarding the state on DFS?&lt;/p&gt;</comment>
                            <comment id="17334546" author="mapohl" created="Wed, 28 Apr 2021 07:58:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fly_in_gis&quot; class=&quot;user-hover&quot; rel=&quot;fly_in_gis&quot;&gt;fly_in_gis&lt;/a&gt; I updated my statement above because I realized that it was not really clear what I meant. Anyway, you understood me correctly: Either we do a loop checking whether the entry made it into the ConfigMap/ZNode or we skip the discard entirely.&lt;/p&gt;</comment>
                            <comment id="17334553" author="mapohl" created="Wed, 28 Apr 2021 08:16:29 +0000"  >&lt;p&gt;I analyzed the code a bit further and realized that the discard is not only triggered in the &lt;tt&gt;StateHandleStore&lt;/tt&gt; but also initiated in the &lt;a href=&quot;https://github.com/apache/flink/blob/577113f0c339df844f2cc32b1d4a09d3da28085a/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L1208&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CheckpointCoordinator:1208&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; also triggers a cleanup in case of a &lt;tt&gt;CompletedCheckpointStore.addCheckpoint&lt;/tt&gt; failure. We would end up in this cleanup since we&apos;re still trying to decline the processed checkpoint by forwarding the Exception from &lt;tt&gt;StateHandleStore.addAndLock&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Hence, it&apos;s not enough to not discard in case of failure in the &lt;tt&gt;StateHandleStore&lt;/tt&gt; implementations but also on the &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; level.&lt;/p&gt;</comment>
                            <comment id="17335271" author="till.rohrmann" created="Thu, 29 Apr 2021 09:09:27 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17346777" author="till.rohrmann" created="Tue, 18 May 2021 10:43:19 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.14.0:&lt;br/&gt;
9d2e2d980e&lt;br/&gt;
cc59ad5e62&lt;br/&gt;
417cf78fd0&lt;br/&gt;
e632591623&lt;br/&gt;
fa0d1dc3d5&lt;/p&gt;

&lt;p&gt;1.13.1:&lt;br/&gt;
a24b0d86d7&lt;br/&gt;
6ce9cc900c&lt;br/&gt;
b5c49ef484&lt;br/&gt;
a6c13e79b6&lt;br/&gt;
13bc663802&lt;/p&gt;

&lt;p&gt;1.12.5:&lt;br/&gt;
a53a1f3e99&lt;br/&gt;
95bd043f0a&lt;br/&gt;
b81887e647&lt;br/&gt;
5aec1bb949&lt;br/&gt;
6b53f8b0e0&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13375535">FLINK-22502</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13406512">FLINK-24543</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13379178">FLINK-22704</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13414397">FLINK-25098</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13416888">FLINK-25265</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qib4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>