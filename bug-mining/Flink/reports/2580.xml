<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9969] Unreasonable memory requirements to complete examples/batch/WordCount</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9969</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;setup on AWS EMR:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;5 worker nodes (m4.4xlarge nodes)&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;1 master node (m4.large)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;following command fails with out of memory errors:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;export HADOOP_CLASSPATH=`hadoop classpath`
./bin/flink run -m yarn-cluster -p 20 -yn 5 -ys 4 -ytm 16000 examples/batch/WordCount.jar&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Only increasing memory over 17.2GB example completes. At the same time after disabling flip6 following command succeeds:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;export HADOOP_CLASSPATH=`hadoop classpath`
./bin/flink run -m yarn-cluster -p 20 -yn 5 -ys 4 -ytm 1000 examples/batch/WordCount.jar&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13174819">FLINK-9969</key>
            <summary>Unreasonable memory requirements to complete examples/batch/WordCount</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 26 Jul 2018 12:24:51 +0000</created>
                <updated>Thu, 28 Feb 2019 14:00:01 +0000</updated>
                            <resolved>Fri, 3 Aug 2018 14:39:50 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.5.1</version>
                    <version>1.5.2</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.5.3</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16559576" author="pnowojski" created="Fri, 27 Jul 2018 11:08:55 +0000"  >&lt;p&gt;Strangely, problem disappears when &lt;tt&gt;taskmanager.memory.preallocate&lt;/tt&gt; is set to true&lt;/p&gt;</comment>
                            <comment id="16559773" author="pnowojski" created="Fri, 27 Jul 2018 13:42:05 +0000"  >&lt;p&gt;Another remark. This might also have something to do with how Flip6 lazily requests new&#160;task managers. In &lt;tt&gt;mode: old&lt;/tt&gt; tasks are uniformly distributed among all nodes, while in Flip6, tasks are squeezed mostly into one node.&#160;Time line of events is as follow:&lt;/p&gt;

&lt;p&gt;12:49:13 - requested new TaskManager&lt;/p&gt;

&lt;p&gt;12:49:20 - first TaskManager&#160;registered&lt;br/&gt;
12:49:20 all tasks moved from `CREATED` to `SCHEDULED`, they start being executed in batches of 4 (because of 4 slots) on this TM&lt;/p&gt;

&lt;p&gt;12:49:20 - requested more TaskManagers&lt;/p&gt;

&lt;p&gt;12:49:21 first TM after processing ~18 tasks fails with OOM&lt;/p&gt;

&lt;p&gt;12:49:27 - more TM registered&lt;/p&gt;

&lt;p&gt;Please check attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12933363/12933363_yarn_logs&quot; title=&quot;yarn_logs attached to FLINK-9969&quot;&gt;yarn_logs&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160; for details.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16567019" author="githubbot" created="Thu, 2 Aug 2018 16:15:55 +0000"  >&lt;p&gt;tillrohrmann opened a new pull request #6479: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9969&quot; title=&quot;Unreasonable memory requirements to complete examples/batch/WordCount&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9969&quot;&gt;&lt;del&gt;FLINK-9969&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;batch&amp;#93;&lt;/span&gt; Dispose InMemorySorters created by the UnilateralSortMerger&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6479&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6479&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This commit changes the behaviour of the UnilateralSortMerger to keep references of the created&lt;br/&gt;
   InMemorySorters in order to explicitly dispse them when the sort merger is closed. This prevents&lt;br/&gt;
   that InMemorySorters leak and block the garbage collection of MemorySegments to which they keep&lt;br/&gt;
   references.&lt;/p&gt;

&lt;p&gt;   cc @StephanEwen &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Introduce `InMemorySorterFactory` to make `UnilateralSortMerger` testable&lt;/li&gt;
	&lt;li&gt;Keep reference to created `InMemorySorters` in `UnilateralSortMerger`&lt;/li&gt;
	&lt;li&gt;Dispose all `InMemorySorters` before releasing memory to `MemoryManager`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added `UnilateralSortMergerTest#testInMemorySorterDisposal`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567291" author="githubbot" created="Thu, 2 Aug 2018 17:59:15 +0000"  >&lt;p&gt;zentol commented on a change in pull request #6479: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9969&quot; title=&quot;Unreasonable memory requirements to complete examples/batch/WordCount&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9969&quot;&gt;&lt;del&gt;FLINK-9969&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;batch&amp;#93;&lt;/span&gt; Dispose InMemorySorters created by the UnilateralSortMerger&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6479#discussion_r207319425&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6479#discussion_r207319425&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/DefaultInMemorySorterFactory.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -0,0 +1,80 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.runtime.operators.sort;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeComparator;&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeSerializer;&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeSerializerFactory;&lt;br/&gt;
+import org.apache.flink.core.memory.MemorySegment;&lt;br/&gt;
+&lt;br/&gt;
+import javax.annotation.Nonnull;&lt;br/&gt;
+import javax.annotation.Nullable;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.List;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Default factory for &lt;/p&gt;
{@link InMemorySorter}
&lt;p&gt;.&lt;br/&gt;
+ */&lt;br/&gt;
+public class DefaultInMemorySorterFactory&amp;lt;T&amp;gt; implements InMemorySorterFactory&amp;lt;T&amp;gt; {&lt;br/&gt;
+&lt;br/&gt;
+	@Nonnull&lt;br/&gt;
+	private final TypeSerializerFactory&amp;lt;T&amp;gt; typeSerializerFactory;&lt;br/&gt;
+&lt;br/&gt;
+	@Nonnull&lt;br/&gt;
+	private final TypeComparator&amp;lt;T&amp;gt; typeComparator;&lt;br/&gt;
+&lt;br/&gt;
+	private final boolean useFixedLengthRecordSorter;&lt;br/&gt;
+&lt;br/&gt;
+	@Nullable&lt;br/&gt;
+	private TypeSerializer&amp;lt;T&amp;gt; initialSerializer;&lt;br/&gt;
+&lt;br/&gt;
+	DefaultInMemorySorterFactory(&lt;br/&gt;
+			@Nonnull TypeSerializerFactory&amp;lt;T&amp;gt; typeSerializerFactory,&lt;br/&gt;
+			@Nonnull TypeComparator&amp;lt;T&amp;gt; typeComparator,&lt;br/&gt;
+			int thresholdForInPlaceSorting) &lt;/p&gt;
{
+		this.typeSerializerFactory = typeSerializerFactory;
+		this.typeComparator = typeComparator;
+
+		this.initialSerializer = typeSerializerFactory.getSerializer();
+
+		this.useFixedLengthRecordSorter = typeComparator.supportsSerializationWithKeyNormalization() &amp;amp;&amp;amp;
+			initialSerializer.getLength() &amp;gt; 0 &amp;amp;&amp;amp; initialSerializer.getLength() &amp;lt;= thresholdForInPlaceSorting;
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public InMemorySorter&amp;lt;T&amp;gt; create(List&amp;lt;MemorySegment&amp;gt; sortSegments) {&lt;br/&gt;
+&lt;br/&gt;
+		final TypeSerializer&amp;lt;T&amp;gt; typeSerializer;&lt;br/&gt;
+&lt;br/&gt;
+		if (initialSerializer == null) &lt;/p&gt;
{
+			typeSerializer = typeSerializerFactory.getSerializer();
+		}
&lt;p&gt; else {&lt;br/&gt;
+			typeSerializer = initialSerializer;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   couldn&apos;t we simplify this by always discarding the serializer created in the constructor? We could then remove the `initialSerializer` field and always create a new serializer here.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567292" author="githubbot" created="Thu, 2 Aug 2018 17:59:53 +0000"  >&lt;p&gt;zentol commented on a change in pull request #6479: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9969&quot; title=&quot;Unreasonable memory requirements to complete examples/batch/WordCount&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9969&quot;&gt;&lt;del&gt;FLINK-9969&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;batch&amp;#93;&lt;/span&gt; Dispose InMemorySorters created by the UnilateralSortMerger&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6479#discussion_r207319672&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6479#discussion_r207319672&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/UnilateralSortMerger.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -212,9 +215,39 @@ protected UnilateralSortMerger(MemoryManager memoryManager, List&amp;lt;MemorySegment&amp;gt;&lt;br/&gt;
 			TypeSerializerFactory&amp;lt;E&amp;gt; serializerFactory, TypeComparator&amp;lt;E&amp;gt; comparator,&lt;br/&gt;
 			int numSortBuffers, int maxNumFileHandles,&lt;br/&gt;
 			float startSpillingFraction, boolean noSpillingMemory, boolean handleLargeRecords,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;boolean objectReuseEnabled)&lt;/li&gt;
	&lt;li&gt;throws IOException&lt;/li&gt;
	&lt;li&gt;{&lt;br/&gt;
+			boolean objectReuseEnabled) throws IOException 
{
+		this (
+			memoryManager,
+			memory,
+			ioManager,
+			input,
+			parentTask,
+			serializerFactory,
+			comparator,
+			numSortBuffers,
+			maxNumFileHandles,
+			startSpillingFraction,
+			noSpillingMemory,
+			handleLargeRecords,
+			objectReuseEnabled,
+			new DefaultInMemorySorterFactory&amp;lt;&amp;gt;(serializerFactory, comparator, THRESHOLD_FOR_IN_PLACE_SORTING));
+	}
&lt;p&gt;+&lt;br/&gt;
+	protected UnilateralSortMerger(&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   `@VisibleForTesting`?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567691" author="githubbot" created="Fri, 3 Aug 2018 02:27:43 +0000"  >&lt;p&gt;TisonKun commented on a change in pull request #6479: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9969&quot; title=&quot;Unreasonable memory requirements to complete examples/batch/WordCount&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9969&quot;&gt;&lt;del&gt;FLINK-9969&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;batch&amp;#93;&lt;/span&gt; Dispose InMemorySorters created by the UnilateralSortMerger&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6479#discussion_r207425876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6479#discussion_r207425876&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/operators/sort/CombiningUnilateralSortMergerITCase.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -47,9 +37,20 @@&lt;br/&gt;
 import org.apache.flink.runtime.util.ReusingKeyGroupedIterator;&lt;br/&gt;
 import org.apache.flink.util.Collector;&lt;br/&gt;
 import org.apache.flink.util.MutableObjectIterator;&lt;br/&gt;
+import org.apache.flink.util.TestLogger;&lt;br/&gt;
+&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
+import org.junit.Assert;&lt;br/&gt;
 import org.junit.Before;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
+import org.slf4j.Logger;&lt;br/&gt;
+import org.slf4j.LoggerFactory;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.IOException;&lt;br/&gt;
+import java.util.ArrayList;&lt;br/&gt;
+import java.util.Hashtable;&lt;br/&gt;
+import java.util.Iterator;&lt;br/&gt;
+import java.util.NoSuchElementException;&lt;/p&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   The change can be suppressed if merged.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567692" author="githubbot" created="Fri, 3 Aug 2018 02:27:52 +0000"  >&lt;p&gt;TisonKun commented on a change in pull request #6479: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9969&quot; title=&quot;Unreasonable memory requirements to complete examples/batch/WordCount&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9969&quot;&gt;&lt;del&gt;FLINK-9969&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;batch&amp;#93;&lt;/span&gt; Dispose InMemorySorters created by the UnilateralSortMerger&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6479#discussion_r207425876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6479#discussion_r207425876&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/operators/sort/CombiningUnilateralSortMergerITCase.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -47,9 +37,20 @@&lt;br/&gt;
 import org.apache.flink.runtime.util.ReusingKeyGroupedIterator;&lt;br/&gt;
 import org.apache.flink.util.Collector;&lt;br/&gt;
 import org.apache.flink.util.MutableObjectIterator;&lt;br/&gt;
+import org.apache.flink.util.TestLogger;&lt;br/&gt;
+&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
+import org.junit.Assert;&lt;br/&gt;
 import org.junit.Before;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
+import org.slf4j.Logger;&lt;br/&gt;
+import org.slf4j.LoggerFactory;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.IOException;&lt;br/&gt;
+import java.util.ArrayList;&lt;br/&gt;
+import java.util.Hashtable;&lt;br/&gt;
+import java.util.Iterator;&lt;br/&gt;
+import java.util.NoSuchElementException;&lt;/p&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   This change can be suppressed if merged.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567700" author="githubbot" created="Fri, 3 Aug 2018 02:53:59 +0000"  >&lt;p&gt;TisonKun commented on a change in pull request #6479: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9969&quot; title=&quot;Unreasonable memory requirements to complete examples/batch/WordCount&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9969&quot;&gt;&lt;del&gt;FLINK-9969&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;batch&amp;#93;&lt;/span&gt; Dispose InMemorySorters created by the UnilateralSortMerger&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6479#discussion_r207428623&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6479#discussion_r207428623&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/UnilateralSortMerger.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -212,9 +215,39 @@ protected UnilateralSortMerger(MemoryManager memoryManager, List&amp;lt;MemorySegment&amp;gt;&lt;br/&gt;
 			TypeSerializerFactory&amp;lt;E&amp;gt; serializerFactory, TypeComparator&amp;lt;E&amp;gt; comparator,&lt;br/&gt;
 			int numSortBuffers, int maxNumFileHandles,&lt;br/&gt;
 			float startSpillingFraction, boolean noSpillingMemory, boolean handleLargeRecords,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;boolean objectReuseEnabled)&lt;/li&gt;
	&lt;li&gt;throws IOException&lt;/li&gt;
	&lt;li&gt;{&lt;br/&gt;
+			boolean objectReuseEnabled) throws IOException 
{
+		this (
+			memoryManager,
+			memory,
+			ioManager,
+			input,
+			parentTask,
+			serializerFactory,
+			comparator,
+			numSortBuffers,
+			maxNumFileHandles,
+			startSpillingFraction,
+			noSpillingMemory,
+			handleLargeRecords,
+			objectReuseEnabled,
+			new DefaultInMemorySorterFactory&amp;lt;&amp;gt;(serializerFactory, comparator, THRESHOLD_FOR_IN_PLACE_SORTING));
+	}
&lt;p&gt;+&lt;br/&gt;
+	protected UnilateralSortMerger(&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   why? we might config which `InMemorySorterFactory` to use if needed. semantically it&apos;s no need to be `@VisibleForTesting`&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567861" author="githubbot" created="Fri, 3 Aug 2018 07:14:03 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6479: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9969&quot; title=&quot;Unreasonable memory requirements to complete examples/batch/WordCount&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9969&quot;&gt;&lt;del&gt;FLINK-9969&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;batch&amp;#93;&lt;/span&gt; Dispose InMemorySorters created by the UnilateralSortMerger&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6479#discussion_r207459350&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6479#discussion_r207459350&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/UnilateralSortMerger.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -212,9 +215,39 @@ protected UnilateralSortMerger(MemoryManager memoryManager, List&amp;lt;MemorySegment&amp;gt;&lt;br/&gt;
 			TypeSerializerFactory&amp;lt;E&amp;gt; serializerFactory, TypeComparator&amp;lt;E&amp;gt; comparator,&lt;br/&gt;
 			int numSortBuffers, int maxNumFileHandles,&lt;br/&gt;
 			float startSpillingFraction, boolean noSpillingMemory, boolean handleLargeRecords,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;boolean objectReuseEnabled)&lt;/li&gt;
	&lt;li&gt;throws IOException&lt;/li&gt;
	&lt;li&gt;{&lt;br/&gt;
+			boolean objectReuseEnabled) throws IOException 
{
+		this (
+			memoryManager,
+			memory,
+			ioManager,
+			input,
+			parentTask,
+			serializerFactory,
+			comparator,
+			numSortBuffers,
+			maxNumFileHandles,
+			startSpillingFraction,
+			noSpillingMemory,
+			handleLargeRecords,
+			objectReuseEnabled,
+			new DefaultInMemorySorterFactory&amp;lt;&amp;gt;(serializerFactory, comparator, THRESHOLD_FOR_IN_PLACE_SORTING));
+	}
&lt;p&gt;+&lt;br/&gt;
+	protected UnilateralSortMerger(&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I agree with @TisonKun &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567862" author="githubbot" created="Fri, 3 Aug 2018 07:14:56 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6479: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9969&quot; title=&quot;Unreasonable memory requirements to complete examples/batch/WordCount&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9969&quot;&gt;&lt;del&gt;FLINK-9969&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;batch&amp;#93;&lt;/span&gt; Dispose InMemorySorters created by the UnilateralSortMerger&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6479#discussion_r207459523&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6479#discussion_r207459523&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/operators/sort/CombiningUnilateralSortMergerITCase.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -47,9 +37,20 @@&lt;br/&gt;
 import org.apache.flink.runtime.util.ReusingKeyGroupedIterator;&lt;br/&gt;
 import org.apache.flink.util.Collector;&lt;br/&gt;
 import org.apache.flink.util.MutableObjectIterator;&lt;br/&gt;
+import org.apache.flink.util.TestLogger;&lt;br/&gt;
+&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
+import org.junit.Assert;&lt;br/&gt;
 import org.junit.Before;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
+import org.slf4j.Logger;&lt;br/&gt;
+import org.slf4j.LoggerFactory;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.IOException;&lt;br/&gt;
+import java.util.ArrayList;&lt;br/&gt;
+import java.util.Hashtable;&lt;br/&gt;
+import java.util.Iterator;&lt;br/&gt;
+import java.util.NoSuchElementException;&lt;/p&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   You&apos;re right it&apos;s unrelated. I will remove it from the commit.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567865" author="githubbot" created="Fri, 3 Aug 2018 07:16:29 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6479: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9969&quot; title=&quot;Unreasonable memory requirements to complete examples/batch/WordCount&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9969&quot;&gt;&lt;del&gt;FLINK-9969&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;batch&amp;#93;&lt;/span&gt; Dispose InMemorySorters created by the UnilateralSortMerger&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6479#discussion_r207459818&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6479#discussion_r207459818&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/DefaultInMemorySorterFactory.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -0,0 +1,80 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.runtime.operators.sort;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeComparator;&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeSerializer;&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeSerializerFactory;&lt;br/&gt;
+import org.apache.flink.core.memory.MemorySegment;&lt;br/&gt;
+&lt;br/&gt;
+import javax.annotation.Nonnull;&lt;br/&gt;
+import javax.annotation.Nullable;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.List;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Default factory for &lt;/p&gt;
{@link InMemorySorter}
&lt;p&gt;.&lt;br/&gt;
+ */&lt;br/&gt;
+public class DefaultInMemorySorterFactory&amp;lt;T&amp;gt; implements InMemorySorterFactory&amp;lt;T&amp;gt; {&lt;br/&gt;
+&lt;br/&gt;
+	@Nonnull&lt;br/&gt;
+	private final TypeSerializerFactory&amp;lt;T&amp;gt; typeSerializerFactory;&lt;br/&gt;
+&lt;br/&gt;
+	@Nonnull&lt;br/&gt;
+	private final TypeComparator&amp;lt;T&amp;gt; typeComparator;&lt;br/&gt;
+&lt;br/&gt;
+	private final boolean useFixedLengthRecordSorter;&lt;br/&gt;
+&lt;br/&gt;
+	@Nullable&lt;br/&gt;
+	private TypeSerializer&amp;lt;T&amp;gt; initialSerializer;&lt;br/&gt;
+&lt;br/&gt;
+	DefaultInMemorySorterFactory(&lt;br/&gt;
+			@Nonnull TypeSerializerFactory&amp;lt;T&amp;gt; typeSerializerFactory,&lt;br/&gt;
+			@Nonnull TypeComparator&amp;lt;T&amp;gt; typeComparator,&lt;br/&gt;
+			int thresholdForInPlaceSorting) &lt;/p&gt;
{
+		this.typeSerializerFactory = typeSerializerFactory;
+		this.typeComparator = typeComparator;
+
+		this.initialSerializer = typeSerializerFactory.getSerializer();
+
+		this.useFixedLengthRecordSorter = typeComparator.supportsSerializationWithKeyNormalization() &amp;amp;&amp;amp;
+			initialSerializer.getLength() &amp;gt; 0 &amp;amp;&amp;amp; initialSerializer.getLength() &amp;lt;= thresholdForInPlaceSorting;
+	}
&lt;p&gt;+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public InMemorySorter&amp;lt;T&amp;gt; create(List&amp;lt;MemorySegment&amp;gt; sortSegments) {&lt;br/&gt;
+&lt;br/&gt;
+		final TypeSerializer&amp;lt;T&amp;gt; typeSerializer;&lt;br/&gt;
+&lt;br/&gt;
+		if (initialSerializer == null) &lt;/p&gt;
{
+			typeSerializer = typeSerializerFactory.getSerializer();
+		}
&lt;p&gt; else {&lt;br/&gt;
+			typeSerializer = initialSerializer;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Yes, the `initialSerializer` is an optimization to decrease the number of created `TypeSerializer` instances at the cost of a slightly more complicated `create` method. I guess both ways should work given that the `UnilateralSortMerger` does not create thousands of `InMemorySorters`.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16568270" author="githubbot" created="Fri, 3 Aug 2018 14:38:29 +0000"  >&lt;p&gt;asfgit closed pull request #6479: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9969&quot; title=&quot;Unreasonable memory requirements to complete examples/batch/WordCount&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9969&quot;&gt;&lt;del&gt;FLINK-9969&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;batch&amp;#93;&lt;/span&gt; Dispose InMemorySorters created by the UnilateralSortMerger&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6479&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6479&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/memory/MemoryManager.java b/flink-runtime/src/main/java/org/apache/flink/runtime/memory/MemoryManager.java&lt;br/&gt;
index f3bea87a039..c450880f98b 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/memory/MemoryManager.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/memory/MemoryManager.java&lt;br/&gt;
@@ -176,6 +176,15 @@ public MemoryManager(long memorySize, int numberOfSlots, int pageSize,&lt;br/&gt;
 			default:&lt;br/&gt;
 				throw new IllegalArgumentException(&quot;unrecognized memory type: &quot; + memoryType);&lt;br/&gt;
 		}&lt;br/&gt;
+&lt;br/&gt;
+		LOG.debug(&quot;Initialized MemoryManager with total memory size {}, number of slots {}, page size {}, &quot; +&lt;br/&gt;
+				&quot;memory type {}, pre allocate memory {} and number of non allocated pages {}.&quot;,&lt;br/&gt;
+			memorySize,&lt;br/&gt;
+			numberOfSlots,&lt;br/&gt;
+			pageSize,&lt;br/&gt;
+			memoryType,&lt;br/&gt;
+			preAllocateMemory,&lt;br/&gt;
+			numNonAllocatedPages);&lt;br/&gt;
 	}&lt;/p&gt;

&lt;p&gt; 	// ------------------------------------------------------------------------&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/DefaultInMemorySorterFactory.java b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/DefaultInMemorySorterFactory.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..673ac41e00b&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/DefaultInMemorySorterFactory.java&lt;br/&gt;
@@ -0,0 +1,67 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.runtime.operators.sort;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeComparator;&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeSerializer;&lt;br/&gt;
+import org.apache.flink.api.common.typeutils.TypeSerializerFactory;&lt;br/&gt;
+import org.apache.flink.core.memory.MemorySegment;&lt;br/&gt;
+&lt;br/&gt;
+import javax.annotation.Nonnull;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.List;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Default factory for &lt;/p&gt;
{@link InMemorySorter}.&lt;br/&gt;
+ */&lt;br/&gt;
+public class DefaultInMemorySorterFactory&amp;lt;T&amp;gt; implements InMemorySorterFactory&amp;lt;T&amp;gt; {&lt;br/&gt;
+&lt;br/&gt;
+	@Nonnull&lt;br/&gt;
+	private final TypeSerializerFactory&amp;lt;T&amp;gt; typeSerializerFactory;&lt;br/&gt;
+&lt;br/&gt;
+	@Nonnull&lt;br/&gt;
+	private final TypeComparator&amp;lt;T&amp;gt; typeComparator;&lt;br/&gt;
+&lt;br/&gt;
+	private final boolean useFixedLengthRecordSorter;&lt;br/&gt;
+&lt;br/&gt;
+	DefaultInMemorySorterFactory(&lt;br/&gt;
+			@Nonnull TypeSerializerFactory&amp;lt;T&amp;gt; typeSerializerFactory,&lt;br/&gt;
+			@Nonnull TypeComparator&amp;lt;T&amp;gt; typeComparator,&lt;br/&gt;
+			int thresholdForInPlaceSorting) {
+		this.typeSerializerFactory = typeSerializerFactory;
+		this.typeComparator = typeComparator;
+
+		TypeSerializer&amp;lt;T&amp;gt; typeSerializer = typeSerializerFactory.getSerializer();
+
+		this.useFixedLengthRecordSorter = typeComparator.supportsSerializationWithKeyNormalization() &amp;amp;&amp;amp;
+			typeSerializer.getLength() &amp;gt; 0 &amp;amp;&amp;amp; typeSerializer.getLength() &amp;lt;= thresholdForInPlaceSorting;
+	}&lt;br/&gt;
+&lt;br/&gt;
+	@Override&lt;br/&gt;
+	public InMemorySorter&amp;lt;T&amp;gt; create(List&amp;lt;MemorySegment&amp;gt; sortSegments) {&lt;br/&gt;
+		final TypeSerializer&amp;lt;T&amp;gt; typeSerializer = typeSerializerFactory.getSerializer();&lt;br/&gt;
+		final TypeComparator&amp;lt;T&amp;gt; duplicateTypeComparator = typeComparator.duplicate();&lt;br/&gt;
+&lt;br/&gt;
+		if (useFixedLengthRecordSorter) {
+			return new FixedLengthRecordSorter&amp;lt;&amp;gt;(typeSerializer, duplicateTypeComparator, sortSegments);
+		} else {
+			return new NormalizedKeySorter&amp;lt;&amp;gt;(typeSerializer, duplicateTypeComparator, sortSegments);
+		}&lt;br/&gt;
+	}&lt;br/&gt;
+}&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/InMemorySorterFactory.java b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/InMemorySorterFactory.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..e15f5d8aea5&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/InMemorySorterFactory.java&lt;br/&gt;
@@ -0,0 +1,37 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.runtime.operators.sort;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.flink.core.memory.MemorySegment;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.List;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Factory for {@link InMemorySorter}
&lt;p&gt;.&lt;br/&gt;
+ */&lt;br/&gt;
+public interface InMemorySorterFactory&amp;lt;T&amp;gt; {&lt;br/&gt;
+&lt;br/&gt;
+	/**&lt;br/&gt;
+	 * Create an &lt;/p&gt;
{@link InMemorySorter}
&lt;p&gt; instance with the given memory segments.&lt;br/&gt;
+	 *&lt;br/&gt;
+	 * @param sortSegments to initialize the InMemorySorter with&lt;br/&gt;
+	 * @return new InMemorySorter instance&lt;br/&gt;
+	 */&lt;br/&gt;
+	InMemorySorter&amp;lt;T&amp;gt; create(List&amp;lt;MemorySegment&amp;gt; sortSegments);&lt;br/&gt;
+}&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/UnilateralSortMerger.java b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/UnilateralSortMerger.java&lt;br/&gt;
index 934eeb7c2b4..1c9a8d77a30 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/UnilateralSortMerger.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/operators/sort/UnilateralSortMerger.java&lt;br/&gt;
@@ -22,6 +22,7 @@&lt;br/&gt;
 import java.io.IOException;&lt;br/&gt;
 import java.util.ArrayDeque;&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
+import java.util.Collection;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.Iterator;&lt;br/&gt;
@@ -151,6 +152,8 @@&lt;br/&gt;
 	 */&lt;br/&gt;
 	protected final boolean objectReuseEnabled;&lt;/p&gt;

&lt;p&gt;+	private final Collection&amp;lt;InMemorySorter&amp;lt;?&amp;gt;&amp;gt; inMemorySorters;&lt;br/&gt;
+&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;br/&gt;
 	//                         Constructor &amp;amp; Shutdown&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;br/&gt;
@@ -212,9 +215,39 @@ protected UnilateralSortMerger(MemoryManager memoryManager, List&amp;lt;MemorySegment&amp;gt;&lt;br/&gt;
 			TypeSerializerFactory&amp;lt;E&amp;gt; serializerFactory, TypeComparator&amp;lt;E&amp;gt; comparator,&lt;br/&gt;
 			int numSortBuffers, int maxNumFileHandles,&lt;br/&gt;
 			float startSpillingFraction, boolean noSpillingMemory, boolean handleLargeRecords,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;boolean objectReuseEnabled)&lt;/li&gt;
	&lt;li&gt;throws IOException&lt;/li&gt;
	&lt;li&gt;{&lt;br/&gt;
+			boolean objectReuseEnabled) throws IOException 
{
+		this (
+			memoryManager,
+			memory,
+			ioManager,
+			input,
+			parentTask,
+			serializerFactory,
+			comparator,
+			numSortBuffers,
+			maxNumFileHandles,
+			startSpillingFraction,
+			noSpillingMemory,
+			handleLargeRecords,
+			objectReuseEnabled,
+			new DefaultInMemorySorterFactory&amp;lt;&amp;gt;(serializerFactory, comparator, THRESHOLD_FOR_IN_PLACE_SORTING));
+	}
&lt;p&gt;+&lt;br/&gt;
+	protected UnilateralSortMerger(&lt;br/&gt;
+			MemoryManager memoryManager,&lt;br/&gt;
+			List&amp;lt;MemorySegment&amp;gt; memory,&lt;br/&gt;
+			IOManager ioManager,&lt;br/&gt;
+			MutableObjectIterator&amp;lt;E&amp;gt; input,&lt;br/&gt;
+			AbstractInvokable parentTask,&lt;br/&gt;
+			TypeSerializerFactory&amp;lt;E&amp;gt; serializerFactory,&lt;br/&gt;
+			TypeComparator&amp;lt;E&amp;gt; comparator,&lt;br/&gt;
+			int numSortBuffers,&lt;br/&gt;
+			int maxNumFileHandles,&lt;br/&gt;
+			float startSpillingFraction,&lt;br/&gt;
+			boolean noSpillingMemory,&lt;br/&gt;
+			boolean handleLargeRecords,&lt;br/&gt;
+			boolean objectReuseEnabled,&lt;br/&gt;
+			InMemorySorterFactory&amp;lt;E&amp;gt; inMemorySorterFactory) throws IOException {&lt;br/&gt;
 		// sanity checks&lt;br/&gt;
 		if (memoryManager == null || (ioManager == null &amp;amp;&amp;amp; !noSpillingMemory) || serializerFactory == null || comparator == null) &lt;/p&gt;
{
 			throw new NullPointerException();
@@ -330,6 +363,8 @@ protected UnilateralSortMerger(MemoryManager memoryManager, List&amp;lt;MemorySegment&amp;gt;
 		
 		// circular queues pass buffers between the threads
 		final CircularQueues&amp;lt;E&amp;gt; circularQueues = new CircularQueues&amp;lt;E&amp;gt;();
+
+		inMemorySorters = new ArrayList&amp;lt;&amp;gt;(numSortBuffers);
 		
 		// allocate the sort buffers and fill empty queue with them
 		final Iterator&amp;lt;MemorySegment&amp;gt; segments = this.sortReadMemory.iterator();
@@ -341,20 +376,11 @@ protected UnilateralSortMerger(MemoryManager memoryManager, List&amp;lt;MemorySegment&amp;gt;
 				sortSegments.add(segments.next());
 			}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final TypeComparator&amp;lt;E&amp;gt; comp = comparator.duplicate();&lt;/li&gt;
	&lt;li&gt;final InMemorySorter&amp;lt;E&amp;gt; buffer;&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;// instantiate a fix-length in-place sorter, if possible, otherwise the out-of-place sorter&lt;/li&gt;
	&lt;li&gt;if (comp.supportsSerializationWithKeyNormalization() &amp;amp;&amp;amp;&lt;/li&gt;
	&lt;li&gt;serializer.getLength() &amp;gt; 0 &amp;amp;&amp;amp; serializer.getLength() &amp;lt;= THRESHOLD_FOR_IN_PLACE_SORTING)&lt;/li&gt;
	&lt;li&gt;{
-				buffer = new FixedLengthRecordSorter&amp;lt;E&amp;gt;(serializerFactory.getSerializer(), comp, sortSegments);
-			}
&lt;p&gt; else &lt;/p&gt;
{
-				buffer = new NormalizedKeySorter&amp;lt;E&amp;gt;(serializerFactory.getSerializer(), comp, sortSegments);
-			}
&lt;p&gt;+			final InMemorySorter&amp;lt;E&amp;gt; inMemorySorter = inMemorySorterFactory.create(sortSegments);&lt;br/&gt;
+			inMemorySorters.add(inMemorySorter);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			// add to empty queue&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CircularElement&amp;lt;E&amp;gt; element = new CircularElement&amp;lt;E&amp;gt;(i, buffer, sortSegments);&lt;br/&gt;
+			CircularElement&amp;lt;E&amp;gt; element = new CircularElement&amp;lt;E&amp;gt;(i, inMemorySorter, sortSegments);&lt;br/&gt;
 			circularQueues.empty.add(element);&lt;br/&gt;
 		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -494,7 +520,12 @@ public void close() {&lt;br/&gt;
 			}&lt;br/&gt;
 		}&lt;br/&gt;
 		finally {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
+			// Dispose all in memory sorter in order to clear memory references&lt;br/&gt;
+			for (InMemorySorter&amp;lt;?&amp;gt; inMemorySorter : inMemorySorters) &lt;/p&gt;
{
+				inMemorySorter.dispose();
+			}
&lt;p&gt;+&lt;br/&gt;
 			// RELEASE ALL MEMORY. If the threads and channels are still running, this should cause&lt;br/&gt;
 			// exceptions, because their memory segments are freed&lt;br/&gt;
 			try {&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/taskmanager/Task.java b/flink-runtime/src/main/java/org/apache/flink/runtime/taskmanager/Task.java&lt;br/&gt;
index 60b2ed8fee7..92ae1676ed6 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/taskmanager/Task.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/taskmanager/Task.java&lt;br/&gt;
@@ -78,6 +78,7 @@&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import javax.annotation.Nonnull;&lt;br/&gt;
+import javax.annotation.Nullable;&lt;/p&gt;

&lt;p&gt; import java.io.IOException;&lt;br/&gt;
 import java.lang.reflect.Constructor;&lt;br/&gt;
@@ -243,7 +244,9 @@&lt;br/&gt;
 	/** atomic flag that makes sure the invokable is canceled exactly once upon error. */&lt;br/&gt;
 	private final AtomicBoolean invokableHasBeenCanceled;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** The invokable of this task, if initialized. */&lt;br/&gt;
+	/** The invokable of this task, if initialized. All accesses must copy the reference and&lt;br/&gt;
+	 * check for null, as this field is cleared as part of the disposal logic. */&lt;br/&gt;
+	@Nullable&lt;br/&gt;
 	private volatile AbstractInvokable invokable;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	/** The current execution state of the task. */&lt;br/&gt;
@@ -473,6 +476,12 @@ long getTaskCancellationTimeout() &lt;/p&gt;
{
 		return taskCancellationTimeout;
 	}

&lt;p&gt;+	@Nullable&lt;br/&gt;
+	@VisibleForTesting&lt;br/&gt;
+	AbstractInvokable getInvokable() &lt;/p&gt;
{
+		return invokable;
+	}
&lt;p&gt;+&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;br/&gt;
 	//  Task Execution&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;br/&gt;
@@ -762,7 +771,7 @@ else if (current == ExecutionState.CANCELING) {&lt;br/&gt;
 					if (current == ExecutionState.RUNNING || current == ExecutionState.DEPLOYING) {&lt;br/&gt;
 						if (t instanceof CancelTaskException) {&lt;br/&gt;
 							if (transitionState(current, ExecutionState.CANCELED)) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cancelInvokable();&lt;br/&gt;
+								cancelInvokable(invokable);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 								notifyObservers(ExecutionState.CANCELED, null);&lt;br/&gt;
 								break;&lt;br/&gt;
@@ -773,7 +782,7 @@ else if (current == ExecutionState.CANCELING) {&lt;br/&gt;
 								// proper failure of the task. record the exception as the root cause&lt;br/&gt;
 								String errorMessage = String.format(&quot;Execution of %s (%s) failed.&quot;, taskNameWithSubtask, executionId);&lt;br/&gt;
 								failureCause = t;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cancelInvokable();&lt;br/&gt;
+								cancelInvokable(invokable);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 								notifyObservers(ExecutionState.FAILED, new Exception(errorMessage, t));&lt;br/&gt;
 								break;&lt;br/&gt;
@@ -808,6 +817,10 @@ else if (transitionState(current, ExecutionState.FAILED, t)) {&lt;br/&gt;
 			try {&lt;br/&gt;
 				LOG.info(&quot;Freeing task resources for {} ({}).&quot;, taskNameWithSubtask, executionId);&lt;/p&gt;

&lt;p&gt;+				// clear the reference to the invokable. this helps guard against holding references&lt;br/&gt;
+				// to the invokable and its structures in cases where this Task object is still referenced&lt;br/&gt;
+				this.invokable = null;&lt;br/&gt;
+&lt;br/&gt;
 				// stop the async dispatcher.&lt;br/&gt;
 				// copy dispatcher reference to stack, against concurrent release&lt;br/&gt;
 				ExecutorService dispatcher = this.asyncCallDispatcher;&lt;br/&gt;
@@ -924,18 +937,20 @@ private boolean transitionState(ExecutionState currentState, ExecutionState newS&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@throws IllegalStateException if the 
{@link Task}
&lt;p&gt; is not yet running&lt;br/&gt;
 	 */&lt;br/&gt;
 	public void stopExecution() {&lt;br/&gt;
+		// copy reference to stack, to guard against concurrent setting to null&lt;br/&gt;
+		final AbstractInvokable invokable = this.invokable;&lt;br/&gt;
+&lt;br/&gt;
 		if (invokable != null) {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.info(&quot;Attempting to stop task {} ({}).&quot;, taskNameWithSubtask, executionId);&lt;br/&gt;
 			if (invokable instanceof StoppableTask) {&lt;/li&gt;
	&lt;li&gt;Runnable runnable = new Runnable() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void run() {&lt;/li&gt;
	&lt;li&gt;try 
{
-							((StoppableTask) invokable).stop();
-						}
&lt;p&gt; catch (RuntimeException e) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;LOG.error(&quot;Stopping task {} ({}) failed.&quot;, taskNameWithSubtask, executionId, e);&lt;/li&gt;
	&lt;li&gt;taskManagerActions.failTask(executionId, e);&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
+				LOG.info(&quot;Attempting to stop task {} ({}).&quot;, taskNameWithSubtask, executionId);&lt;br/&gt;
+				final StoppableTask stoppable = (StoppableTask) invokable;&lt;br/&gt;
+&lt;br/&gt;
+				Runnable runnable = () -&amp;gt; {&lt;br/&gt;
+					try 
{
+						stoppable.stop();
+					}
&lt;p&gt; catch (Throwable t) {&lt;br/&gt;
+						LOG.error(&quot;Stopping task {} ({}) failed.&quot;, taskNameWithSubtask, executionId, t);&lt;br/&gt;
+						taskManagerActions.failTask(executionId, t);&lt;br/&gt;
 					}&lt;br/&gt;
 				};&lt;br/&gt;
 				executeAsyncCallRunnable(runnable, String.format(&quot;Stopping source task %s (%s).&quot;, taskNameWithSubtask, executionId));&lt;br/&gt;
@@ -945,7 +960,7 @@ public void run() {&lt;br/&gt;
 		} else &lt;/p&gt;
{
 			throw new IllegalStateException(
 				String.format(
-					&quot;Cannot stop task %s (%s) because it is not yet running.&quot;,
+					&quot;Cannot stop task %s (%s) because it is not running.&quot;,
 					taskNameWithSubtask,
 					executionId));
 		}
&lt;p&gt;@@ -1010,6 +1025,10 @@ else if (current == ExecutionState.RUNNING) {&lt;br/&gt;
 				if (transitionState(ExecutionState.RUNNING, targetState, cause)) {&lt;br/&gt;
 					// we are canceling / failing out of the running state&lt;br/&gt;
 					// we need to cancel the invokable&lt;br/&gt;
+&lt;br/&gt;
+					// copy reference to guard against concurrent null-ing out the reference&lt;br/&gt;
+					final AbstractInvokable invokable = this.invokable;&lt;br/&gt;
+&lt;br/&gt;
 					if (invokable != null &amp;amp;&amp;amp; invokableHasBeenCanceled.compareAndSet(false, true)) {&lt;br/&gt;
 						this.failureCause = cause;&lt;br/&gt;
 						notifyObservers(&lt;br/&gt;
@@ -1363,9 +1382,9 @@ private void executeAsyncCallRunnable(Runnable runnable, String callName) {&lt;br/&gt;
 	//  Utilities&lt;br/&gt;
 	// ------------------------------------------------------------------------&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void cancelInvokable() {&lt;br/&gt;
+	private void cancelInvokable(AbstractInvokable invokable) {&lt;br/&gt;
 		// in case of an exception during execution, we still call &quot;cancel()&quot; on the task&lt;/li&gt;
	&lt;li&gt;if (invokable != null &amp;amp;&amp;amp; this.invokable != null &amp;amp;&amp;amp; invokableHasBeenCanceled.compareAndSet(false, true)) {&lt;br/&gt;
+		if (invokable != null &amp;amp;&amp;amp; invokableHasBeenCanceled.compareAndSet(false, true)) {&lt;br/&gt;
 			try 
{
 				invokable.cancel();
 			}
&lt;p&gt;diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/sort/CombiningUnilateralSortMergerITCase.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/sort/CombiningUnilateralSortMergerITCase.java&lt;br/&gt;
index fa675f69e24..d32cad05cdd 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/sort/CombiningUnilateralSortMergerITCase.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/sort/CombiningUnilateralSortMergerITCase.java&lt;br/&gt;
@@ -18,21 +18,11 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; package org.apache.flink.runtime.operators.sort;&lt;/p&gt;

&lt;p&gt;-import java.io.IOException;&lt;br/&gt;
-import java.util.ArrayList;&lt;br/&gt;
-import java.util.Hashtable;&lt;br/&gt;
-import java.util.Iterator;&lt;br/&gt;
-import java.util.NoSuchElementException;&lt;br/&gt;
-&lt;br/&gt;
 import org.apache.flink.api.common.functions.GroupCombineFunction;&lt;br/&gt;
-import org.apache.flink.util.TestLogger;&lt;br/&gt;
-import org.junit.Assert;&lt;br/&gt;
-import org.slf4j.Logger;&lt;br/&gt;
-import org.slf4j.LoggerFactory;&lt;br/&gt;
+import org.apache.flink.api.common.functions.RichGroupReduceFunction;&lt;br/&gt;
 import org.apache.flink.api.common.typeutils.TypeComparator;&lt;br/&gt;
 import org.apache.flink.api.common.typeutils.TypeSerializer;&lt;br/&gt;
 import org.apache.flink.api.common.typeutils.TypeSerializerFactory;&lt;br/&gt;
-import org.apache.flink.api.common.functions.RichGroupReduceFunction;&lt;br/&gt;
 import org.apache.flink.api.common.typeutils.base.IntComparator;&lt;br/&gt;
 import org.apache.flink.api.java.tuple.Tuple2;&lt;br/&gt;
 import org.apache.flink.configuration.Configuration;&lt;br/&gt;
@@ -47,9 +37,20 @@&lt;br/&gt;
 import org.apache.flink.runtime.util.ReusingKeyGroupedIterator;&lt;br/&gt;
 import org.apache.flink.util.Collector;&lt;br/&gt;
 import org.apache.flink.util.MutableObjectIterator;&lt;br/&gt;
+import org.apache.flink.util.TestLogger;&lt;br/&gt;
+&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
+import org.junit.Assert;&lt;br/&gt;
 import org.junit.Before;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
+import org.slf4j.Logger;&lt;br/&gt;
+import org.slf4j.LoggerFactory;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.IOException;&lt;br/&gt;
+import java.util.ArrayList;&lt;br/&gt;
+import java.util.Hashtable;&lt;br/&gt;
+import java.util.Iterator;&lt;br/&gt;
+import java.util.NoSuchElementException;&lt;/p&gt;

&lt;p&gt; public class CombiningUnilateralSortMergerITCase extends TestLogger {&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/sort/UnilateralSortMergerTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/sort/UnilateralSortMergerTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..f5a56bce4e1&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/sort/UnilateralSortMergerTest.java&lt;br/&gt;
@@ -0,0 +1,205 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.flink.runtime.operators.sort;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.flink.api.java.tuple.Tuple2;&lt;br/&gt;
+import org.apache.flink.core.memory.MemorySegment;&lt;br/&gt;
+import org.apache.flink.runtime.io.disk.iomanager.ChannelWriterOutputView;&lt;br/&gt;
+import org.apache.flink.runtime.io.disk.iomanager.IOManagerAsync;&lt;br/&gt;
+import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.DummyInvokable;&lt;br/&gt;
+import org.apache.flink.runtime.operators.testutils.TestData;&lt;br/&gt;
+import org.apache.flink.runtime.util.EmptyMutableObjectIterator;&lt;br/&gt;
+import org.apache.flink.util.MutableObjectIterator;&lt;br/&gt;
+import org.apache.flink.util.TestLogger;&lt;br/&gt;
+&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.IOException;&lt;br/&gt;
+import java.util.ArrayList;&lt;br/&gt;
+import java.util.Collection;&lt;br/&gt;
+import java.util.List;&lt;br/&gt;
+&lt;br/&gt;
+import static org.hamcrest.Matchers.empty;&lt;br/&gt;
+import static org.hamcrest.Matchers.is;&lt;br/&gt;
+import static org.hamcrest.Matchers.not;&lt;br/&gt;
+import static org.junit.Assert.assertThat;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Tests for the &lt;/p&gt;
{@link UnilateralSortMerger}
&lt;p&gt;.&lt;br/&gt;
+ */&lt;br/&gt;
+public class UnilateralSortMergerTest extends TestLogger {&lt;br/&gt;
+&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testInMemorySorterDisposal() throws Exception {&lt;br/&gt;
+		final TestingInMemorySorterFactory&amp;lt;Tuple2&amp;lt;Integer, Integer&amp;gt;&amp;gt; inMemorySorterFactory = new TestingInMemorySorterFactory&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+		final int numPages = 32;&lt;br/&gt;
+		final MemoryManager memoryManager = new MemoryManager(MemoryManager.DEFAULT_PAGE_SIZE * numPages, 1);&lt;br/&gt;
+		final DummyInvokable parentTask = new DummyInvokable();&lt;br/&gt;
+		final UnilateralSortMerger&amp;lt;Tuple2&amp;lt;Integer, Integer&amp;gt;&amp;gt; unilateralSortMerger = new UnilateralSortMerger&amp;lt;&amp;gt;(&lt;br/&gt;
+			memoryManager,&lt;br/&gt;
+			memoryManager.allocatePages(parentTask, numPages),&lt;br/&gt;
+			new IOManagerAsync(),&lt;br/&gt;
+			EmptyMutableObjectIterator.get(),&lt;br/&gt;
+			parentTask,&lt;br/&gt;
+			TestData.getIntIntTupleSerializerFactory(),&lt;br/&gt;
+			TestData.getIntIntTupleComparator(),&lt;br/&gt;
+			10,&lt;br/&gt;
+			2,&lt;br/&gt;
+			1.0f,&lt;br/&gt;
+			true,&lt;br/&gt;
+			false,&lt;br/&gt;
+			false,&lt;br/&gt;
+			inMemorySorterFactory);&lt;br/&gt;
+&lt;br/&gt;
+		final Collection&amp;lt;TestingInMemorySorter&amp;lt;?&amp;gt;&amp;gt; inMemorySorters = inMemorySorterFactory.getInMemorySorters();&lt;br/&gt;
+&lt;br/&gt;
+		assertThat(inMemorySorters, is(not(empty())));&lt;br/&gt;
+&lt;br/&gt;
+		unilateralSortMerger.close();&lt;br/&gt;
+&lt;br/&gt;
+		assertThat(unilateralSortMerger.closed, is(true));&lt;br/&gt;
+&lt;br/&gt;
+		for (TestingInMemorySorter&amp;lt;?&amp;gt; inMemorySorter : inMemorySorters) &lt;/p&gt;
{
+			assertThat(inMemorySorter.isDisposed(), is(true));
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
+	private static final class TestingInMemorySorterFactory&amp;lt;T&amp;gt; implements InMemorySorterFactory&amp;lt;T&amp;gt; {&lt;br/&gt;
+&lt;br/&gt;
+		private final Collection&amp;lt;TestingInMemorySorter&amp;lt;?&amp;gt;&amp;gt; inMemorySorters = new ArrayList&amp;lt;&amp;gt;(10);&lt;br/&gt;
+&lt;br/&gt;
+		Collection&amp;lt;TestingInMemorySorter&amp;lt;?&amp;gt;&amp;gt; getInMemorySorters() &lt;/p&gt;
{
+			return inMemorySorters;
+		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public InMemorySorter&amp;lt;T&amp;gt; create(List&amp;lt;MemorySegment&amp;gt; sortSegments) &lt;/p&gt;
{
+			final TestingInMemorySorter&amp;lt;T&amp;gt; testingInMemorySorter = new TestingInMemorySorter&amp;lt;&amp;gt;();
+			inMemorySorters.add(testingInMemorySorter);
+			return testingInMemorySorter;
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
+	private static final class TestingInMemorySorter&amp;lt;T&amp;gt; implements InMemorySorter&amp;lt;T&amp;gt; {&lt;br/&gt;
+&lt;br/&gt;
+		private volatile boolean isDisposed;&lt;br/&gt;
+&lt;br/&gt;
+		public boolean isDisposed() &lt;/p&gt;
{
+			return isDisposed;
+		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public void reset() &lt;/p&gt;
{
+
+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public boolean isEmpty() {
+			return false;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public void dispose() {
+			isDisposed = true;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public long getCapacity() {
+			return 0;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public long getOccupancy() {+			return 0;+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public T getRecord(int logicalPosition) throws IOException {
+			return null;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public T getRecord(T reuse, int logicalPosition) throws IOException {+			return null;+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public boolean write(T record) throws IOException {+			return false;+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public MutableObjectIterator&amp;lt;T&amp;gt; getIterator() {
+			return null;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public void writeToOutput(ChannelWriterOutputView output) throws IOException {++		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public void writeToOutput(ChannelWriterOutputView output, LargeRecordHandler&amp;lt;T&amp;gt; largeRecordsOutput) throws IOException &lt;/p&gt;
{
+
+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public void writeToOutput(ChannelWriterOutputView output, int start, int num) throws IOException {++		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public int compare(int i, int j) &lt;/p&gt;
{
+			return 0;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public int compare(int segmentNumberI, int segmentOffsetI, int segmentNumberJ, int segmentOffsetJ) {+			return 0;+		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public void swap(int i, int j) &lt;/p&gt;
{
+
+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public void swap(int segmentNumberI, int segmentOffsetI, int segmentNumberJ, int segmentOffsetJ) {++		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public int size() &lt;/p&gt;
{
+			return 0;
+		}&lt;br/&gt;
+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public int recordSize() {+			return 0;+		}
&lt;p&gt;+&lt;br/&gt;
+		@Override&lt;br/&gt;
+		public int recordsPerSegment() &lt;/p&gt;
{
+			return 0;
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
+}&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/taskmanager/TaskTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/taskmanager/TaskTest.java&lt;br/&gt;
index 1829e977489..3dfcfb3b059 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/taskmanager/TaskTest.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/taskmanager/TaskTest.java&lt;br/&gt;
@@ -174,6 +174,7 @@ public void testRegularExecution() {&lt;br/&gt;
 			assertEquals(ExecutionState.FINISHED, task.getExecutionState());&lt;br/&gt;
 			assertFalse(task.isCanceledOrFailed());&lt;br/&gt;
 			assertNull(task.getFailureCause());&lt;br/&gt;
+			assertNull(task.getInvokable());&lt;/p&gt;

&lt;p&gt; 			// verify listener messages&lt;br/&gt;
 			validateListenerMessage(ExecutionState.RUNNING, task, false);&lt;br/&gt;
@@ -202,6 +203,8 @@ public void testCancelRightAway() &lt;/p&gt;
{
 			// verify final state
 			assertEquals(ExecutionState.CANCELED, task.getExecutionState());
 			validateUnregisterTask(task.getExecutionId());
+
+			assertNull(task.getInvokable());
 		}
&lt;p&gt; 		catch (Exception e) {&lt;br/&gt;
 			e.printStackTrace();&lt;br/&gt;
@@ -258,6 +261,8 @@ public void testLibraryCacheRegistrationFailed() &lt;/p&gt;
{
 
 			// make sure that the TaskManager received an message to unregister the task
 			validateUnregisterTask(task.getExecutionId());
+
+			assertNull(task.getInvokable());
 		}
&lt;p&gt; 		catch (Exception e) {&lt;br/&gt;
 			e.printStackTrace();&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16568277" author="till.rohrmann" created="Fri, 3 Aug 2018 14:39:50 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
master: bf94d287d71454d9de7e52c22c1ae17c3062aa9f&lt;br/&gt;
1.6.0: ad281a2753cee7aa5a5c549225ceeae58e2ebd00&lt;br/&gt;
1.5.3: 2c6b9422154eda600d05e04c300920d353740042&lt;/p&gt;</comment>
                            <comment id="16572878" author="pnowojski" created="Wed, 8 Aug 2018 08:30:52 +0000"  >&lt;p&gt;Confirmed on EMR cluster that problem is gone&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12933363" name="yarn_logs" size="1016400" author="pnowojski" created="Fri, 27 Jul 2018 13:42:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 14 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wciv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>