<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:57:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-23003] Resource leak in RocksIncrementalSnapshotStrategy</title>
                <link>https://issues.apache.org/jira/browse/FLINK-23003</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We found that `RocksDBStateUploader` in `RocksIncrementalSnapshotStrategy` is not closed correctly after being used. It would lead to a resource leak.&lt;/p&gt;

&lt;p&gt;`RocksDBStateUploader` inherits `RocksDBStateDataTransfer`, and `RocksDBStateDataTransfer` holds an `ExecutorService`. `RocksDBStateUploader` uses the `ExecutorService` to upload files to DFS asynchronously.&lt;/p&gt;

&lt;p&gt;When `RocksDBKeyedStateBackend` is cleaned up, all resources held by the backend should be closed, but now `RocksIncrementalSnapshotStrategy` lacks a close() function.&lt;/p&gt;

&lt;p&gt;And we encountered an example caused by this problem. When we benchmarked the performance of incremental rescaling, we observed that the forked VM of JMH can&apos;t exit normally.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[INFO]
[INFO] --- exec-maven-plugin:1.6.0:exec (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cli) @ benchmark ---
# JMH version: 1.19
# VM version: JDK 1.8.0_281, VM 25.281-b09
# VM invoker: /home/leiyanfei.lyf/jdk1.8.0_281/jre/bin/java
# VM options: -Djava.rmi.server.hostname=127.0.0.1 -Dcom.sun.management.jmxremote.authenticate=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; -Dcom.sun.management.jmxremote.ssl=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; -Dcom.sun.management.jmxremote.ssl
# Warmup: 10 iterations, 1 s each
# Measurement: 10 iterations, 1 s each
# Timeout: 10 min per iteration
# Threads: 1 thread, will synchronize iterations
# Benchmark mode: Average time, time/op
# Benchmark: org.apache.flink.state.RocksIncrementalCheckpointScaleUpBenchmark.ScalingUp
# Parameters: (numberElements = 100, parallelism1 = 2, parallelism2 = 3)# Run progress: 0.00% complete, ETA 00:02:00
# Fork: 1 of 3
# Warmup Iteration   1: 244.717 ms/op
# Warmup Iteration   2: 104.749 ms/op
# Warmup Iteration   3: 104.182 ms/op
...
Iteration   1: 96.600 ms/op
Iteration   2: 108.463 ms/op
Iteration   3: 93.657 ms/op
...&amp;lt;JMH had finished, but forked VM did not exit, are there stray running threads? Waiting 24 seconds more...&amp;gt;Non-finished threads:
...
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[pool-15-thread-4,5,main]
  at sun.misc.Unsafe.park(Native Method)
  at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
  at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
  at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)
  at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)
  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)
  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&amp;lt;shutdown timeout of 30 seconds expired, forcing forked VM to exit&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
The root cause of this example is that the `&lt;tt&gt;RocksDBStateUploader&lt;/tt&gt;` in `&lt;tt&gt;RocksIncrementalSnapshotStrategy`&lt;/tt&gt; is not closed normally when `&lt;tt&gt;RocksDBKeyedStateBackend`&lt;/tt&gt; is disposed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The solution to this problem is quite straightforward, `&lt;tt&gt;RocksDBStateUploader`&lt;/tt&gt; in `&lt;tt&gt;RocksIncrementalSnapshotStrategy&lt;/tt&gt;` can be closed when cleaning up `&lt;tt&gt;RocksDBKeyedStateBackend&lt;/tt&gt;`.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Flink:&#160;1.14-SNAPSHOT&lt;/p&gt;</environment>
        <key id="13384029">FLINK-23003</key>
            <summary>Resource leak in RocksIncrementalSnapshotStrategy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Yanfei Lei">Yanfei Lei</assignee>
                                    <reporter username="Yanfei Lei">Yanfei Lei</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 16 Jun 2021 02:16:00 +0000</created>
                <updated>Sat, 28 Aug 2021 12:18:07 +0000</updated>
                            <resolved>Thu, 17 Jun 2021 15:33:19 +0000</resolved>
                                    <version>1.14.0</version>
                    <version>1.13.1</version>
                    <version>1.12.4</version>
                                    <fixVersion>1.14.0</fixVersion>
                    <fixVersion>1.13.2</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17364018" author="wind_ljy" created="Wed, 16 Jun 2021 02:40:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Yanfei+Lei&quot; class=&quot;user-hover&quot; rel=&quot;Yanfei Lei&quot;&gt;Yanfei Lei&lt;/a&gt; This looks like a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22886&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-22886&lt;/a&gt;. The issue is already in-progress and I&apos;m sure there would be a PR in two days.&lt;/p&gt;</comment>
                            <comment id="17364027" author="ym" created="Wed, 16 Jun 2021 02:51:18 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;would you please take a review?&lt;/p&gt;</comment>
                            <comment id="17364142" author="roman_khachatryan" created="Wed, 16 Jun 2021 08:42:27 +0000"  >&lt;p&gt;Sure, reviewed, thanks for pulling me in.&lt;/p&gt;</comment>
                            <comment id="17364740" author="roman_khachatryan" created="Thu, 17 Jun 2021 07:23:29 +0000"  >&lt;p&gt;Merged into master as 8be1058a60565587b465a2237136dbbbb4c168f3.&lt;/p&gt;

&lt;p&gt;It should also be ported to 1.13 according to the&#160;&lt;a href=&quot;https://flink.apache.org/downloads.html#update-policy-for-old-releases&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Update Policy&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Yanfei+Lei&quot; class=&quot;user-hover&quot; rel=&quot;Yanfei Lei&quot;&gt;Yanfei Lei&lt;/a&gt; would you like to open a PR to backport it to 1.13?&lt;/p&gt;</comment>
                            <comment id="17364760" author="yanfei lei" created="Thu, 17 Jun 2021 07:51:10 +0000"  >&lt;p&gt;Sure,&#160;opened.&#160; &lt;a href=&quot;https://github.com/apache/flink/pull/16176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/16176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; would you please take a review again?&lt;/p&gt;</comment>
                            <comment id="17364985" author="roman_khachatryan" created="Thu, 17 Jun 2021 15:32:53 +0000"  >&lt;p&gt;Sure, reviewd and merged into 1.13 as&#160;84578222cc84537c2f014573706bf070d3da49da.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13382322">FLINK-22886</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rzjk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>