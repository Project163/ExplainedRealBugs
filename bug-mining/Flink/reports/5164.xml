<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:54:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20547] Batch job fails due to the exception in network stack</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20547</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I run a simple batch job with only two job vertices: a source and a sink.&lt;/p&gt;

&lt;p&gt;The parallelisms of them are both 8000. They are connected via all-to-all blocking edges.&lt;/p&gt;

&lt;p&gt;During the running of sink tasks, an exception raises:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-12-09 18:43:48,981 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Sink: Sink 1 (1595/8000) (08bd4214d6e0dc144e9654f1faaa3b28) switched from RUNNING to FAILED on [masked container name] @ [masked address] (dataPort=47872).
java.io.IOException: java.lang.IllegalStateException: Inconsistent availability: expected &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
	at org.apache.flink.runtime.io.network.partition.consumer.InputChannel.checkError(InputChannel.java:232) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.RecoveredInputChannel.getNextBuffer(RecoveredInputChannel.java:165) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.waitAndGetNextData(SingleInputGate.java:626) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.getNextBufferOrEvent(SingleInputGate.java:603) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.pollNext(SingleInputGate.java:591) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.taskmanager.InputGateWithMetrics.pollNext(InputGateWithMetrics.java:109) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.io.CheckpointedInputGate.pollNext(CheckpointedInputGate.java:142) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.io.StreamTaskNetworkInput.emitNext(StreamTaskNetworkInput.java:157) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:67) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:372) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:186) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:575) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:539) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:722) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:547) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834) ~[?:1.8.0_102]
Caused by: java.lang.IllegalStateException: Inconsistent availability: expected &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
	at org.apache.flink.util.Preconditions.checkState(Preconditions.java:198) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.checkConsistentAvailability(LocalBufferPool.java:434) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.setNumBuffers(LocalBufferPool.java:564) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.buffer.NetworkBufferPool.redistributeBuffers(NetworkBufferPool.java:509) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.buffer.NetworkBufferPool.tryRedistributeBuffers(NetworkBufferPool.java:438) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.buffer.NetworkBufferPool.requestMemorySegments(NetworkBufferPool.java:166) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.buffer.NetworkBufferPool.requestMemorySegments(NetworkBufferPool.java:60) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.BufferManager.requestExclusiveBuffers(BufferManager.java:131) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.RemoteInputChannel.setup(RemoteInputChannel.java:148) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.RemoteRecoveredInputChannel.toInputChannelInternal(RemoteRecoveredInputChannel.java:76) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.RecoveredInputChannel.toInputChannel(RecoveredInputChannel.java:91) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.convertRecoveredInputChannels(SingleInputGate.java:299) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.io.network.partition.consumer.SingleInputGate.requestPartitions(SingleInputGate.java:285) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.runtime.taskmanager.InputGateWithMetrics.requestPartitions(InputGateWithMetrics.java:94) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.runThrowing(StreamTaskActionExecutor.java:47) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.mailbox.Mail.run(Mail.java:78) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.processMail(MailboxProcessor.java:283) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:184) ~[flink-dist_2.11-1.13-SNAPSHOT.jar:1.13-SNAPSHOT]
	... 5 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;It seems to be an exception in network stack.&lt;/p&gt;

&lt;p&gt;The full log of the job is attached below.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13345051">FLINK-20547</key>
            <summary>Batch job fails due to the exception in network stack</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kevin.cyj">Yingjie Cao</assignee>
                                    <reporter username="Thesharing">Zhilong Hong</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Wed, 9 Dec 2020 11:17:49 +0000</created>
                <updated>Wed, 24 Mar 2021 07:26:24 +0000</updated>
                            <resolved>Wed, 24 Mar 2021 07:26:23 +0000</resolved>
                                    <version>1.12.0</version>
                    <version>1.12.1</version>
                    <version>1.12.2</version>
                    <version>1.13.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                    <fixVersion>1.12.3</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17247029" author="kevin.cyj" created="Thu, 10 Dec 2020 05:41:14 +0000"  >&lt;p&gt;I also encountered this issue these days when testing the new optimization for sort-merge shuffle but I was suspecting that this exception is caused by my new added code. From this case, I suspect that it is a bug from master branch.&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AHeise&quot; class=&quot;user-hover&quot; rel=&quot;AHeise&quot;&gt;AHeise&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17247130" author="roman_khachatryan" created="Thu, 10 Dec 2020 09:40:54 +0000"  >&lt;p&gt;Can you share your configuration please &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;(in particular, TM memory configuration)&lt;/p&gt;</comment>
                            <comment id="17247144" author="kevin.cyj" created="Thu, 10 Dec 2020 10:08:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&#160;I encountered this exception when running TPCDS tests, but the exception is hard to reproduce. Here is the relevant configuration:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
taskmanager.memory.process.size: 30000m
taskmanager.memory.jvm-metaspace.size: 512m
# leave &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; to page cache
containerized.heap-cutoff-ratio: 0.3
taskmanager.memory.managed.size: 12000m

taskmanager.network.memory.fraction: 0.99
taskmanager.network.memory.min: 64mb
taskmanager.network.memory.max: 4096mb

taskmanager.numberOfTaskSlots: 10&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Thesharing&quot; class=&quot;user-hover&quot; rel=&quot;Thesharing&quot;&gt;Thesharing&lt;/a&gt; Could you also share more&#160; information about the issue? For example, can the issue be reproduced?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17247153" author="roman_khachatryan" created="Thu, 10 Dec 2020 10:25:43 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Can you please also confirm that the issue appears only since 1.13?&lt;/p&gt;</comment>
                            <comment id="17247174" author="thesharing" created="Thu, 10 Dec 2020 11:10:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; This issue can be reproduced.&#160;&lt;/p&gt;

&lt;p&gt;The configurations related to the memory are:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
jobmanager.memory.heap.size: 40960 m
env.java.opts: -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:ParallelGCThreads=4 -XX:+PrintPromotionFailure -XX:+PrintGCCause
env.java.opts.jobmanager: -Xmx25600m -Xms25600m -Xmn15360m -XX:ParallelGCThreads=32 -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70
env.java.opts.taskmanager: -Xloggc:&amp;lt;LOG_DIR&amp;gt;/taskmanager-gc.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=2 -XX:GCLogFileSize=512M

taskmanager.numberOfTaskSlots: 20
taskmanager.memory.segment-size: 4 k
taskmanager.memory.process.size: 8192 m
taskmanager.memory.task.off-heap.size: 134217728b
taskmanager.memory.framework.off-heap.size: 1073741824b
taskmanager.memory.managed.size: 134217728b
taskmanager.memory.network.min: 1073741824b
taskmanager.memory.network.max: 1073741824b
taskmanager.network.netty.transport: nio
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17247222" author="kevin.cyj" created="Thu, 10 Dec 2020 12:47:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&#160;To be honest, I am not sure whether 1.12 has the same issue or not. But we didn&apos;t encountered the exception when running TPCDS test with 1.12. I offline discussed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Thesharing&quot; class=&quot;user-hover&quot; rel=&quot;Thesharing&quot;&gt;Thesharing&lt;/a&gt;, he confirmed that his configuration can&#160;consistently reproduce the issue. He will confirm whether the issue can be reproduced with 1.12 and update the result latter.&lt;/p&gt;</comment>
                            <comment id="17247227" author="roman_khachatryan" created="Thu, 10 Dec 2020 12:58:59 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I&apos;m asking because the first suspicion was that RecoveredInputChannels aren&apos;t needed in Batch mode.&#160; But after checking the code, I see they are created uniformly since 1.11.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Do I understand correctly, that you need the DOP of at least 8000 to reproduce the issue?&lt;/p&gt;</comment>
                            <comment id="17247236" author="kevin.cyj" created="Thu, 10 Dec 2020 13:21:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&#160;We are using 8000 because we are testing the scheduling performance of Flink (preparing for migrating large scale batch job from Blink to Flink). I think 8000 parallelism is not a must for reproducing the issue, but I guess parallelism may influence the probability of reproduction.&lt;/p&gt;</comment>
                            <comment id="17249610" author="roman_khachatryan" created="Tue, 15 Dec 2020 10:11:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Thesharing&quot; class=&quot;user-hover&quot; rel=&quot;Thesharing&quot;&gt;Thesharing&lt;/a&gt; did you manage to reproduce it in previous Flink releases?&lt;/p&gt;</comment>
                            <comment id="17250894" author="thesharing" created="Thu, 17 Dec 2020 08:22:23 +0000"  >&lt;p&gt;Sorry for the late reply, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;. I need to clarify that we discovered this issue in the latest master branch. At present, we have managed to reproduce this issue in release-1.12. And we are still working on reproducing it in release-1.11.&lt;/p&gt;</comment>
                            <comment id="17255707" author="roman_khachatryan" created="Mon, 28 Dec 2020 19:56:20 +0000"  >&lt;p&gt;Debugging an unrelated issue &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20654&quot; title=&quot;Unaligned checkpoint recovery may lead to corrupted data stream&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20654&quot;&gt;&lt;del&gt;FLINK-20654&lt;/del&gt;&lt;/a&gt;, I see there is probably a memory leak when running UnalignedCheckpointITCase multiple times:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
122805 [ForkJoinPool.commonPool-worker-5] WARN  org.apache.flink.runtime.minicluster.MiniClusterJobClient [] - Shutdown of MiniCluster failed.
org.apache.flink.util.FlinkException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; shutting the TaskExecutor down.
	at org.apache.flink.runtime.taskexecutor.TaskExecutor.handleOnStopException(TaskExecutor.java:461) ~[classes/:?]
	at org.apache.flink.runtime.taskexecutor.TaskExecutor.lambda$onStop$2(TaskExecutor.java:443) ~[classes/:?]
	at java.util.concurrent.CompletableFuture.uniHandle(CompletableFuture.java:836) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture$UniHandle.tryFire(CompletableFuture.java:811) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:488) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:1990) ~[?:1.8.0_271]
	at org.apache.flink.runtime.concurrent.FutureUtils.lambda$runAfterwardsAsync$17(FutureUtils.java:678) ~[classes/:?]
	at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:774) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:750) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture$Completion.run(CompletableFuture.java:456) ~[?:1.8.0_271]
	at org.apache.flink.runtime.concurrent.DirectExecutorService.execute(DirectExecutorService.java:217) ~[classes/:?]
	at java.util.concurrent.CompletableFuture$UniCompletion.claim(CompletableFuture.java:543) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:765) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:750) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:488) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:1975) ~[?:1.8.0_271]
	at org.apache.flink.runtime.concurrent.FutureUtils.lambda$forwardTo$22(FutureUtils.java:1323) ~[classes/:?]
	at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:774) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:750) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:488) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:575) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture$UniRun.tryFire(CompletableFuture.java:704) ~[?:1.8.0_271]
	at java.util.concurrent.CompletableFuture$Completion.run(CompletableFuture.java:456) ~[?:1.8.0_271]
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRunAsync(AkkaRpcActor.java:442) ~[classes/:?]
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:209) ~[classes/:?]
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleMessage(AkkaRpcActor.java:159) ~[classes/:?]
	at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:26) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:21) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at scala.PartialFunction$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;applyOrElse(PartialFunction.scala:123) ~[scala-library-2.11.12.jar:?]
	at akka.japi.pf.UnitCaseStatement.applyOrElse(CaseStatements.scala:21) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:170) ~[scala-library-2.11.12.jar:?]
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171) ~[scala-library-2.11.12.jar:?]
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171) ~[scala-library-2.11.12.jar:?]
	at akka.actor.Actor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;aroundReceive(Actor.scala:517) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.actor.AbstractActor.aroundReceive(AbstractActor.scala:225) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:592) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.actor.ActorCell.invoke(ActorCell.scala:561) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:258) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.Mailbox.run(Mailbox.scala:225) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.Mailbox.exec(Mailbox.scala:235) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
	at akka.dispatch.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107) ~[akka-actor_2.11-2.5.21.jar:2.5.21]
Caused by: org.apache.flink.util.FlinkException: Could not properly shut down the TaskManager services.
	at org.apache.flink.runtime.taskexecutor.TaskManagerServices.shutDown(TaskManagerServices.java:235) ~[classes/:?]
	at org.apache.flink.runtime.taskexecutor.TaskExecutor.stopTaskExecutorServices(TaskExecutor.java:484) ~[classes/:?]
	at org.apache.flink.runtime.concurrent.FutureUtils.lambda$runAfterwardsAsync$17(FutureUtils.java:672) ~[classes/:?]
	... 37 more
Caused by: java.lang.IllegalStateException: NetworkBufferPool is not empty after destroying all LocalBufferPools
	at org.apache.flink.runtime.io.network.buffer.NetworkBufferPool.destroyAllBufferPools(NetworkBufferPool.java:431) ~[classes/:?]
	at org.apache.flink.runtime.io.network.NettyShuffleEnvironment.close(NettyShuffleEnvironment.java:346) ~[classes/:?]
	at org.apache.flink.runtime.taskexecutor.TaskManagerServices.shutDown(TaskManagerServices.java:191) ~[classes/:?]
	at org.apache.flink.runtime.taskexecutor.TaskExecutor.stopTaskExecutorServices(TaskExecutor.java:484) ~[classes/:?]
	at org.apache.flink.runtime.concurrent.FutureUtils.lambda$runAfterwardsAsync$17(FutureUtils.java:672) ~[classes/:?]
	... 37 mor
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17304693" author="pnowojski" created="Fri, 19 Mar 2021 07:44:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; have you managed to make any progress? I&apos;m not sure if trying to reproduce the problem is worth it. It seems like an internal bug of &lt;tt&gt;LocalBufferPool&lt;/tt&gt; and how &lt;tt&gt;availabilityHelper&lt;/tt&gt; gets out of sync from &lt;tt&gt;availableMemorySegments&lt;/tt&gt; and &lt;tt&gt;unavailableSubpartitionsCount&lt;/tt&gt;, so it should be easy to just analyse the code what code paths can lead to that inconsistency.&lt;/p&gt;</comment>
                            <comment id="17304845" author="kevin.cyj" created="Fri, 19 Mar 2021 11:25:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;&#160;No much progress so far. Previously, I was trying to reproduce it with a unit test because it is hard to debug the large parallelism real job, unfortunately, the error did not reproduce. These days, I am busy with the blocking shuffle things and is not working it. I agree with your suggestion, I will spend some time dig into the code and see if I can find something.&lt;/p&gt;</comment>
                            <comment id="17305878" author="kevin.cyj" created="Mon, 22 Mar 2021 04:24:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;After reading the code, I think I have find the bug. The checkAvailability method will allocate buffer from the global, I may return false even when it already allocate some buffers and the available future will be set as unavailable which leads to the consistency check fail.&lt;/p&gt;

&lt;p&gt;Things happen in the following order can lead to the error:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The setNumBuffers method is called.&lt;/li&gt;
	&lt;li&gt;The checkAvailability method is called.&lt;/li&gt;
	&lt;li&gt;The requestMemorySegmentFromGlobal is called and no buffer is returned which means the global pool does not have any available buffers.&lt;/li&gt;
	&lt;li&gt;The requestMemorySegmentFromGlobalWhenAvailable method is called and the global pool now has available buffers and the registered call back is called directly, after which new buffers are allocated and the buffer pool becomes available.&lt;/li&gt;
	&lt;li&gt;However, the checkAvailability call in 2 returns false and the else branch in&#160;setNumBuffers is ran, the buffer pool is set unavailable and the inconsistency happens.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Could you please verify if I am right? If I am right, I can prepare a fix PR soon, but the test is hard to simulate the scenario. I wonder if we can fix it without test coverage (I can verify the fix with the 8000 * 8000 real world job).&lt;/p&gt;</comment>
                            <comment id="17305973" author="pnowojski" created="Mon, 22 Mar 2021 08:13:17 +0000"  >&lt;p&gt;Good catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;. I think you are right. &lt;/p&gt;

&lt;p&gt;Isn&apos;t it quite easy to test on a unit test level with passing a mock implementation of `NetworkBufferPool`, that is first unavailable and doesn&apos;t have any buffers when requesting it for the first time. But when `getAvailableFuture` is called, one buffer becomes available and always returns a completed future?&lt;/p&gt;</comment>
                            <comment id="17305984" author="kevin.cyj" created="Mon, 22 Mar 2021 08:29:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;Thanks for the confirmation. You are right, a mock&#160;NetworkBufferPool can do the work. I will submit a fix PR&#160; soon.&lt;/p&gt;</comment>
                            <comment id="17306733" author="kevin.cyj" created="Tue, 23 Mar 2021 04:00:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;I have opened a PR for this issue, could you please take a look?&lt;/p&gt;</comment>
                            <comment id="17307609" author="pnowojski" created="Wed, 24 Mar 2021 07:26:24 +0000"  >&lt;p&gt;Thanks for fixing the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;merged commit bc78f6b into apache:master&lt;br/&gt;
merged f90bce94cbc into release-1.12&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13348542">FLINK-20824</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13348542">FLINK-20824</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13016764" name="inconsistent.tar.gz" size="4874231" author="Thesharing" created="Wed, 9 Dec 2020 11:14:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0lcj4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>