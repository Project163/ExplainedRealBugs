<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:31:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8215] Support implicit type widening for array/map constructors in SQL</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8215</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;TableAPI goes through `LogicalNode.validate()`, which brings up the collection validation and rejects inconsistent type, this will throw `ValidationExcpetion` for something like `array(1.0, 2.0f)`.&lt;/p&gt;

&lt;p&gt;SqlAPI uses `FlinkPlannerImpl.validator(SqlNode)`, which uses calcite SqlNode validation, which supports resolving leastRestrictive type. `ARRAY&lt;span class=&quot;error&quot;&gt;&amp;#91;CAST(1 AS DOUBLE), CAST(2 AS FLOAT)&amp;#93;&lt;/span&gt;` throws codegen exception.&lt;/p&gt;

&lt;p&gt;Root cause is the CodeGeneration for these collection value constructors does not cast or resolve leastRestrictive type correctly. I see 2 options:&lt;br/&gt;
1. Strengthen validation to not allow resolving leastRestrictive type on SQL.&lt;br/&gt;
2. Making codegen support leastRestrictive type cast, such as using `generateCast` instead of direct casting like `(ClassType) element`.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13123335">FLINK-8215</key>
            <summary>Support implicit type widening for array/map constructors in SQL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rongr">Rong Rong</assignee>
                                    <reporter username="rongr">Rong Rong</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Dec 2017 00:37:08 +0000</created>
                <updated>Thu, 19 Sep 2019 19:18:02 +0000</updated>
                            <resolved>Tue, 19 Dec 2017 10:27:48 +0000</resolved>
                                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16281537" author="twalthr" created="Thu, 7 Dec 2017 09:18:39 +0000"  >&lt;p&gt;I think the Table API should not support automatic type widening. It is also not supported at other locations. But if the SQL standard supports that we need to adapt the code generation accordingly.&lt;/p&gt;</comment>
                            <comment id="16282799" author="rongr" created="Fri, 8 Dec 2017 00:26:23 +0000"  >&lt;p&gt;Agree. as long as the ValidationException is thrown for TableAPI, we could go ahead and make the codegen to support type widening by adding in better type cast. Will go with option #2 then.&lt;/p&gt;</comment>
                            <comment id="16286763" author="githubbot" created="Mon, 11 Dec 2017 23:40:25 +0000"  >&lt;p&gt;GitHub user walterddr opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5148&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8215&quot; title=&quot;Support implicit type widening for array/map constructors in SQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8215&quot;&gt;&lt;del&gt;FLINK-8215&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Table&amp;#93;&lt;/span&gt; fix codegen issue on array/map value constructor dealing with implicit type cast&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This pull request fix the codegen issue when value constructor on SQL API.&lt;br/&gt;
    On Table API we enforce strict type compatibility and no implicit type cast is allowed. However on SQL API, Calcite `SqlMultisetValueConstructor` is trying to process some combination of types where `leastRestrictive` type is resolved correctly. &lt;/p&gt;

&lt;p&gt;    A type-cast-safe method is introduce to avoid such codegen excpetion.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added in `generateCast` before boxing the nullable item&lt;/li&gt;
	&lt;li&gt;Added in unit-test for Map / Array value constructor&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Unit tests are added.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    No&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    No new feature required.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/walterddr/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/walterddr/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8215&quot; title=&quot;Support implicit type widening for array/map constructors in SQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8215&quot;&gt;&lt;del&gt;FLINK-8215&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5148.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5148.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5148&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f8eb55d80fc5232f7989e3e48666257bd4383042&lt;br/&gt;
Author: Rong Rong &amp;lt;rongr@uber.com&amp;gt;&lt;br/&gt;
Date:   2017-12-11T22:55:49Z&lt;/p&gt;

&lt;p&gt;    before generating output type boxing, try a generateCast on the expression beforehand. This is to avoid doing an invalid type cast directly such as: (Java.util.Double) 1.0f.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16296576" author="githubbot" created="Tue, 19 Dec 2017 10:00:32 +0000"  >&lt;p&gt;Github user twalthr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5148&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank for this fix @walterddr. The code looks good. I will merge this...&lt;/p&gt;</comment>
                            <comment id="16296601" author="githubbot" created="Tue, 19 Dec 2017 10:24:31 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5148&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16296607" author="twalthr" created="Tue, 19 Dec 2017 10:27:48 +0000"  >&lt;p&gt;Fixed in 1.5: 2142eeda9df262e989951c4b31273cbd9346567f&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 48 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nmmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>