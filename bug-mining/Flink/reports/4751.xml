<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19717] SourceReaderBase.pollNext may return END_OF_INPUT if SplitReader.fetch throws</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19717</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Here are my imaginative execution flows:&lt;br/&gt;
1. In mailbox thread, we enters &lt;tt&gt;SourceReaderBase.getNextFetch&lt;/tt&gt;. After executes &lt;tt&gt;splitFetcherManager.checkErrors()&lt;/tt&gt; but before &lt;tt&gt;elementsQueue.poll()&lt;/tt&gt;, &lt;tt&gt;SplitFetcher&lt;/tt&gt; gets its chance to run.&lt;br/&gt;
2. &lt;tt&gt;SplitFetcher&lt;/tt&gt; terminates due to exception from &lt;tt&gt;SplitReader.fetch&lt;/tt&gt;. &lt;tt&gt;SplitFetcher.shutdownHook&lt;/tt&gt; will removes this exceptional fetcher from &lt;tt&gt;SplitFetcherManager&lt;/tt&gt;.&lt;br/&gt;
3. In mailbox thread,  &lt;tt&gt;elementsQueue.poll()&lt;/tt&gt; executes. If there is no elements in queue, &lt;tt&gt;elementsQueue&lt;/tt&gt; will be reset to unavailable.&lt;br/&gt;
4. After getting no elements from &lt;tt&gt;SourceReaderBase.getNextFetch&lt;/tt&gt;, we will enter &lt;tt&gt;SourceReaderBase.finishedOrAvailableLater&lt;/tt&gt;. If the exceptional fetcher is last alive fetcher, then &lt;tt&gt;SourceReaderBase.finishedOrAvailableLater&lt;/tt&gt; may evaluate to &lt;tt&gt;InputStatus.END_OF_INPUT&lt;/tt&gt;&lt;br/&gt;
5. &lt;tt&gt;StreamTask&lt;/tt&gt; will terminate itself due to &lt;tt&gt;InputStatus.END_OF_INPUT&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Here is revised &lt;tt&gt;SourceReaderBaseTest.testExceptionInSplitReader&lt;/tt&gt; which will fails in rate about 1/2.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	@Test
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testExceptionInSplitReader() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		expectedException.expect(RuntimeException.class);
		expectedException.expectMessage(&lt;span class=&quot;code-quote&quot;&gt;&quot;One or more fetchers have encountered exception&quot;&lt;/span&gt;);
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; errMsg = &lt;span class=&quot;code-quote&quot;&gt;&quot;Testing Exception&quot;&lt;/span&gt;;

		FutureCompletingBlockingQueue&amp;lt;RecordsWithSplitIds&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[]&amp;gt;&amp;gt; elementsQueue =
			&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FutureCompletingBlockingQueue&amp;lt;&amp;gt;();
		&lt;span class=&quot;code-comment&quot;&gt;// We have to handle split changes first, otherwise fetch will not be called.
&lt;/span&gt;		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (MockSourceReader reader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MockSourceReader(
			elementsQueue,
			() -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SplitReader&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[], MockSourceSplit&amp;gt;() {
				@Override
				&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; RecordsWithSplitIds&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[]&amp;gt; fetch() {
					&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(errMsg);
				}

				@Override
				&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void handleSplitsChanges(SplitsChange&amp;lt;MockSourceSplit&amp;gt; splitsChanges) {}

				@Override
				&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void wakeUp() {
				}
			},
			getConfig(),
			&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)) {
			ValidatingSourceOutput output = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ValidatingSourceOutput();
			reader.addSplits(Collections.singletonList(getSplit(0,
				NUM_RECORDS_PER_SPLIT,
				Boundedness.CONTINUOUS_UNBOUNDED)));
			reader.handleSourceEvents(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoMoreSplitsEvent());
			&lt;span class=&quot;code-comment&quot;&gt;// This is not a real infinite loop, it is supposed to &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; exception after some polls.
&lt;/span&gt;			&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
				InputStatus inputStatus = reader.pollNext(output);
				assertNotEquals(InputStatus.END_OF_INPUT, inputStatus);
				&lt;span class=&quot;code-comment&quot;&gt;// Add a sleep to avoid tight loop.
&lt;/span&gt;				&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(0);
			}
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This revised &lt;tt&gt;SourceReaderBaseTest.testExceptionInSplitReader&lt;/tt&gt; differs from existing one in three places:&lt;br/&gt;
 1. &lt;tt&gt;reader.handleSourceEvents(new NoMoreSplitsEvent())&lt;/tt&gt; sets &lt;tt&gt;SourceReaderBase.noMoreSplitsAssignment&lt;/tt&gt; to true.&lt;br/&gt;
 2. Add assertion to assert that &lt;tt&gt;reader.pollNext&lt;/tt&gt; will not return &lt;tt&gt;InputStatus.END_OF_INPUT&lt;/tt&gt;.&lt;br/&gt;
 3. Modify &lt;tt&gt;Thread.sleep(1)&lt;/tt&gt; to &lt;tt&gt;Thread.sleep(0)&lt;/tt&gt; to increase failure rate from 1/200 to 1/2.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19448&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;FLINK-19448&lt;/a&gt; for initial discussion.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13336089">FLINK-19717</key>
            <summary>SourceReaderBase.pollNext may return END_OF_INPUT if SplitReader.fetch throws</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kezhuw">Kezhu Wang</assignee>
                                    <reporter username="kezhuw">Kezhu Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 19 Oct 2020 14:48:34 +0000</created>
                <updated>Tue, 8 Dec 2020 09:46:25 +0000</updated>
                            <resolved>Tue, 8 Dec 2020 09:41:54 +0000</resolved>
                                    <version>1.11.2</version>
                                    <fixVersion>1.11.3</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Connectors / Common</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17216840" author="kezhuw" created="Mon, 19 Oct 2020 15:51:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe the fix would be to always check for errors before returning NOTHING_AVAILABLE.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; I guess you means checking for errors before returning &lt;b&gt;&lt;tt&gt;END_OF_INPUT&lt;/tt&gt;&lt;/b&gt; ? I think it is no enough since what this error-checking expect is that error-setting happens before fetcher-removing. Before error-checking, all error-setting operations should completed, otherwise we are facing&#160;undetermined result. We can&apos;t get this guarantee from current implementation. Currently, we do fetcher-removing in &lt;tt&gt;SplitFetcher.shutdownHook&lt;/tt&gt; and error-setting in &lt;tt&gt;ThrowableCatchingRunnable.exceptionHandler&lt;/tt&gt;. Both operations are concurrent safe, but fetcher-removing happens before error-setting. This means that there is no &apos;happen before&apos; relationship between error-checking and error-setting. If we reverses &apos;happen before&apos; relationship between error-setting and fetcher-removing, then, after detecting &lt;tt&gt;allFetchersHaveShutdown&lt;/tt&gt; and before error-checking, we known that error-setting has completed. So, if we are going to check for errors before returning &lt;tt&gt;END_OF_INPUT&lt;/tt&gt;, we should also reverse &apos;happen before&apos; relationship between error-setting and fetcher-removing.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dianfu&quot; class=&quot;user-hover&quot; rel=&quot;dianfu&quot;&gt;dianfu&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; Should this be a blocker for 1.12 ?&lt;/p&gt;</comment>
                            <comment id="17218181" author="rmetzger" created="Wed, 21 Oct 2020 08:09:19 +0000"  >&lt;p&gt;Thanks a lot for your investigation and for opening this ticket.&lt;br/&gt;
I can not comment on the priority of the ticket. Let&apos;s wait for Stephan or Jiangjie.&lt;/p&gt;</comment>
                            <comment id="17218676" author="kezhuw" created="Thu, 22 Oct 2020 00:59:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt; Thanks for response. Let&apos;s wait their decision.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; I think we can solve this by moving &lt;tt&gt;exceptionHandler&lt;/tt&gt; from &lt;tt&gt;ThrowableCatchingRunnable&lt;/tt&gt; to &lt;tt&gt;SplitFetcher&lt;/tt&gt;, this way we can rearrange &apos;happen before&apos; relationship between error-setting and fetcher-removing inside &lt;tt&gt;SplitFetcher&lt;/tt&gt; with no interference from extra structure. I have created &lt;a href=&quot;https://github.com/kezhuw/flink/tree/test-case-source-reader-end-of-input-caused-by-split-reader-exception&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a branch in my clone&lt;/a&gt; to demonstrate test case and possible fix. Commit &lt;a href=&quot;https://github.com/kezhuw/flink/commit/3c65b2d8dddd3c18c787fd590ece17304110e3fc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3c65b2d&lt;/a&gt; modifies and fails &lt;tt&gt;SourceReaderBaseTest.testExceptionInSplitReader&lt;/tt&gt;, &lt;a href=&quot;https://github.com/kezhuw/flink/commit/e2e3832c7a4c726405111fb9198e6737417877d5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;e2e383&lt;/a&gt; fixes it. Does this and above analysis make sense to you ? If it is, could you mind assign this issue to me ?&lt;/p&gt;</comment>
                            <comment id="17219692" author="stephanewen" created="Fri, 23 Oct 2020 13:59:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; I agree with your analysis and with the suggested fix. Good work!&lt;/p&gt;

&lt;p&gt;Do you want to prepare a PR for this? Otherwise I could work on this in a few days.&lt;/p&gt;</comment>
                            <comment id="17219695" author="kezhuw" created="Fri, 23 Oct 2020 14:05:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; I am willing to take over this.&lt;/p&gt;</comment>
                            <comment id="17220783" author="rmetzger" created="Mon, 26 Oct 2020 15:57:56 +0000"  >&lt;p&gt;Thank you. I assigned you to the ticket.&lt;/p&gt;</comment>
                            <comment id="17221252" author="dian.fu" created="Tue, 27 Oct 2020 08:46:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt;&#160;Any update on this ticket? It would be great if we can fix this issue by this week as we&apos;re planning to building the first RC of 1.12 on next Monday.&lt;/p&gt;</comment>
                            <comment id="17221272" author="rmetzger" created="Tue, 27 Oct 2020 09:52:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dian.fu&quot; class=&quot;user-hover&quot; rel=&quot;dian.fu&quot;&gt;dian.fu&lt;/a&gt; I believe the issue here is that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kezhuw&quot; class=&quot;user-hover&quot; rel=&quot;kezhuw&quot;&gt;kezhuw&lt;/a&gt; is waiting for a reviewer of the PR. It has been open for 4 days.&lt;/p&gt;</comment>
                            <comment id="17221318" author="dian.fu" created="Tue, 27 Oct 2020 11:01:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt;&#160;You are right. I missed the PR.&lt;/p&gt;</comment>
                            <comment id="17226786" author="rmetzger" created="Thu, 5 Nov 2020 15:57:13 +0000"  >&lt;p&gt;Is this blocker expected to be merged before the feature freeze on Sunday?&lt;br/&gt;
I guess we could also fix this bug after the feature freeze in the stabilization phase.&lt;/p&gt;</comment>
                            <comment id="17228016" author="stephanewen" created="Sun, 8 Nov 2020 15:47:48 +0000"  >&lt;p&gt;We are about to merge this. There is consensus on problem and solution, so it&apos;ll be in very soon.&lt;/p&gt;

&lt;p&gt;Given that this is not a feature, but a critical bug fix, I think the feature freeze deadline does not apply here.&lt;/p&gt;</comment>
                            <comment id="17228328" author="becket_qin" created="Mon, 9 Nov 2020 02:52:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;&#160;I have merged the patch to master. But cherry-picking the patch to release-1.11 has some conflicts. Do you want to sequentialize the backporting of this patch with other Source patches? Otherwise I can also rebase the patch on release-1.11.&lt;/p&gt;</comment>
                            <comment id="17228550" author="stephanewen" created="Mon, 9 Nov 2020 12:38:26 +0000"  >&lt;p&gt;Yes, we need to pick back all changes from master to release-1.11 in order. Otherwise it will be impossible.&lt;br/&gt;
Let&apos;s coordinate between the two of us how we do this...&lt;/p&gt;</comment>
                            <comment id="17230689" author="stephanewen" created="Thu, 12 Nov 2020 15:00:32 +0000"  >&lt;p&gt;Fixed in 1.12.0 via 2cce1aced0d6a311ff0803b773f1565e7f9d76fc&lt;/p&gt;</comment>
                            <comment id="17245774" author="becket_qin" created="Tue, 8 Dec 2020 09:41:54 +0000"  >&lt;p&gt;Merged to release-1.11.&lt;br/&gt;
ceda80842723f3f621279d44ddcbb5210e2a3525&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jtb4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>