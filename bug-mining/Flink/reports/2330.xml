<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:32:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8887] ClusterClient.getJobStatus can throw FencingTokenException</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8887</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;&lt;br/&gt;
Calling &lt;tt&gt;RestClusterClient.getJobStatus&lt;/tt&gt; or &lt;tt&gt;MiniClusterClient.getJobStatus&lt;/tt&gt; can result in a &lt;tt&gt;FencingTokenException&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;&lt;b&gt;Analysis&lt;/b&gt;&lt;br/&gt;
&lt;tt&gt;Dispatcher.requestJobStatus&lt;/tt&gt; first looks the &lt;tt&gt;JobManagerRunner&lt;/tt&gt; up by job id. If a reference is found, &lt;tt&gt;requestJobStatus&lt;/tt&gt; is called on the respective instance. If not, the &lt;tt&gt;ArchivedExecutionGraphStore&lt;/tt&gt; is queried. However, between the lookup and the method call, the &lt;tt&gt;JobMaster&lt;/tt&gt; of the respective job may have lost leadership already (job finished), and has set the fencing token to &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Stacktrace&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: org.apache.flink.runtime.rpc.exceptions.FencingTokenException: Fencing token mismatch: Ignoring message LocalFencedMessage(null, LocalRpcInvocation(requestJobStatus(Time))) because the fencing token null did not match the expected fencing token b8423c75bc6838244b8c93c8bd4a4f51.
	at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleMessage(FencedAkkaRpcActor.java:73)
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.lambda$onReceive$1(AkkaRpcActor.java:132)
	at akka.actor.ActorCell$$anonfun$become$1.applyOrElse(ActorCell.scala:544)
	at akka.actor.Actor$class.aroundReceive(Actor.scala:502)
	at akka.actor.UntypedActor.aroundReceive(UntypedActor.scala:95)
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:526)
	at akka.actor.ActorCell.invoke(ActorCell.scala:495)
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:257)
	at akka.dispatch.Mailbox.run(Mailbox.scala:224)
	at akka.dispatch.Mailbox.exec(Mailbox.scala:234)
	at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
	at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
	at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: org.apache.flink.runtime.rpc.exceptions.FencingTokenException: Fencing token not set: Ignoring message LocalFencedMessage(null, LocalRpcInvocation(requestJobStatus(Time))) because the fencing token is null.
	at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleMessage(FencedAkkaRpcActor.java:56)
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.lambda$onReceive$1(AkkaRpcActor.java:132)
	at akka.actor.ActorCell$$anonfun$become$1.applyOrElse(ActorCell.scala:544)
	at akka.actor.Actor$class.aroundReceive(Actor.scala:502)
	at akka.actor.UntypedActor.aroundReceive(UntypedActor.scala:95)
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:526)
	at akka.actor.ActorCell.invoke(ActorCell.scala:495)
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:257)
	at akka.dispatch.Mailbox.run(Mailbox.scala:224)
	at akka.dispatch.Mailbox.exec(Mailbox.scala:234)
	at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
	at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
	at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13142963">FLINK-8887</key>
            <summary>ClusterClient.getJobStatus can throw FencingTokenException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="gjy">Gary Yao</reporter>
                        <labels>
                            <label>flip-6</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 6 Mar 2018 20:16:16 +0000</created>
                <updated>Tue, 16 Oct 2018 19:57:11 +0000</updated>
                            <resolved>Wed, 28 Mar 2018 15:26:47 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16388967" author="githubbot" created="Wed, 7 Mar 2018 03:49:34 +0000"  >&lt;p&gt;GitHub user yanghua opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5648&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5648&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip-6&amp;#93;&lt;/span&gt; ClusterClient.getJobStatus can throw FencingTokenException&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    &lt;b&gt;This pull request fixed ClusterClient.getJobStatus throw FencingTokenException issue&lt;/b&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;try-catch request job status from job master gateway if catch a exception then goto : request job status  from archived execution graph store&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change is already covered by existing tests, such as &lt;b&gt;DispatcherTest.testCacheJobExecutionResult&lt;/b&gt;.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable / docs / JavaDocs / *&lt;b&gt;not documented&lt;/b&gt;*)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/yanghua/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yanghua/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5648.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5648.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5648&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 03c5bf0aa1536842359740b53f43e7b46f48b006&lt;br/&gt;
Author: vinoyang &amp;lt;vinoyang@...&amp;gt;&lt;br/&gt;
Date:   2018-03-07T03:43:10Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip-6&amp;#93;&lt;/span&gt; ClusterClient.getJobStatus can throw FencingTokenException&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16389273" author="githubbot" created="Wed, 7 Mar 2018 09:01:17 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5648#discussion_r172775779&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5648#discussion_r172775779&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -404,16 +404,25 @@ public void start() throws Exception {&lt;br/&gt;
     		final JobManagerRunner jobManagerRunner = jobManagerRunners.get(jobId);&lt;/p&gt;

&lt;p&gt;     		if (jobManagerRunner != null) &lt;/p&gt;
{
    -			return jobManagerRunner.getJobManagerGateway().requestJobStatus(timeout);
    -		}
&lt;p&gt; else {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobDetails jobDetails = archivedExecutionGraphStore.getAvailableJobDetails(jobId);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (jobDetails != null) 
{
    -				return CompletableFuture.completedFuture(jobDetails.getStatus());
    -			}
&lt;p&gt; else {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return FutureUtils.completedExceptionally(new FlinkJobNotFoundException(jobId));&lt;br/&gt;
    +			try {&lt;br/&gt;
    +				return jobManagerRunner.getJobManagerGateway().requestJobStatus(timeout);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This is an asynchronous call that isn&apos;t throwing the exception. You have to add a handler to the returned `CompletableFuture`. It also only properly resolves one of the exceptions, and IMO shouldn&apos;t catch `Exception` but the specific exceptions we want the workaround to work for as to not hide other issues.&lt;/p&gt;

&lt;p&gt;    In any case, I&apos;m not sure if adding workarounds to the Dispatcher is the right way to go. These issues revealed that some scenarios are not properly handled, and I would prefer waiting for @tillrohrmann to really fix this in the Dispatcher and related components.&lt;/p&gt;

&lt;p&gt;    We can temporarily handle both exceptions in the `MiniClusterClient` by adding a &lt;b&gt;single&lt;/b&gt; retry (with a short sleep) if a *&lt;b&gt;specific&lt;/b&gt;* exception occurs.&lt;/p&gt;</comment>
                            <comment id="16389302" author="githubbot" created="Wed, 7 Mar 2018 09:28:42 +0000"  >&lt;p&gt;Github user yanghua commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5648#discussion_r172782747&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5648#discussion_r172782747&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -404,16 +404,25 @@ public void start() throws Exception {&lt;br/&gt;
     		final JobManagerRunner jobManagerRunner = jobManagerRunners.get(jobId);&lt;/p&gt;

&lt;p&gt;     		if (jobManagerRunner != null) &lt;/p&gt;
{
    -			return jobManagerRunner.getJobManagerGateway().requestJobStatus(timeout);
    -		}
&lt;p&gt; else {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobDetails jobDetails = archivedExecutionGraphStore.getAvailableJobDetails(jobId);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (jobDetails != null) 
{
    -				return CompletableFuture.completedFuture(jobDetails.getStatus());
    -			}
&lt;p&gt; else {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return FutureUtils.completedExceptionally(new FlinkJobNotFoundException(jobId));&lt;br/&gt;
    +			try {&lt;br/&gt;
    +				return jobManagerRunner.getJobManagerGateway().requestJobStatus(timeout);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    OK, I will try this way, thanks!&lt;/p&gt;</comment>
                            <comment id="16389471" author="githubbot" created="Wed, 7 Mar 2018 12:14:06 +0000"  >&lt;p&gt;Github user yanghua commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5648&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5648&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    hi @zentol  how about this solution? I think try another way(fetch from archived execution graph store) from CompletableFuture.handler is a good choice.&lt;/p&gt;</comment>
                            <comment id="16389526" author="githubbot" created="Wed, 7 Mar 2018 13:11:00 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5648#discussion_r172835665&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5648#discussion_r172835665&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -404,7 +406,29 @@ public void start() throws Exception {&lt;br/&gt;
     		final JobManagerRunner jobManagerRunner = jobManagerRunners.get(jobId);&lt;/p&gt;

&lt;p&gt;     		if (jobManagerRunner != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return jobManagerRunner.getJobManagerGateway().requestJobStatus(timeout);&lt;br/&gt;
    +				CompletableFuture&amp;lt;JobStatus&amp;gt; statusFuture = jobManagerRunner.getJobManagerGateway().requestJobStatus(timeout);&lt;br/&gt;
    +				statusFuture.handle((JobStatus status, Throwable throwable) -&amp;gt; {&lt;br/&gt;
    +					if (throwable != null) {&lt;br/&gt;
    +						Throwable error = ExceptionUtils.stripCompletionException(throwable);&lt;br/&gt;
    +&lt;br/&gt;
    +						if (error instanceof FencingTokenException) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    missing else block causes other exceptions to be swallowed...&lt;/p&gt;</comment>
                            <comment id="16389531" author="githubbot" created="Wed, 7 Mar 2018 13:16:19 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5648#discussion_r172837682&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5648#discussion_r172837682&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -404,16 +404,25 @@ public void start() throws Exception {&lt;br/&gt;
     		final JobManagerRunner jobManagerRunner = jobManagerRunners.get(jobId);&lt;/p&gt;

&lt;p&gt;     		if (jobManagerRunner != null) &lt;/p&gt;
{
    -			return jobManagerRunner.getJobManagerGateway().requestJobStatus(timeout);
    -		}
&lt;p&gt; else {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final JobDetails jobDetails = archivedExecutionGraphStore.getAvailableJobDetails(jobId);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (jobDetails != null) 
{
    -				return CompletableFuture.completedFuture(jobDetails.getStatus());
    -			}
&lt;p&gt; else {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return FutureUtils.completedExceptionally(new FlinkJobNotFoundException(jobId));&lt;br/&gt;
    +			try {&lt;br/&gt;
    +				return jobManagerRunner.getJobManagerGateway().requestJobStatus(timeout);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think methods such as `requestJob` and `requestOperatorBackPressureStats` are equally affected by this bug. I would also like to hear @tillrohrmann&apos;s opinion first before proceeding.&lt;/p&gt;</comment>
                            <comment id="16389601" author="githubbot" created="Wed, 7 Mar 2018 14:13:42 +0000"  >&lt;p&gt;GitHub user zentol opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5657&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5657&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Add single retry in MiniClusterClient&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This PR presents a test workaround for race-conditions in FLIP-6 (most notably &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt;). Basically, every `MiniClusterClient` call is retried &lt;b&gt;once&lt;/b&gt; after 500ms in case of certain exceptions.&lt;/p&gt;

&lt;p&gt;    *&lt;b&gt;This is only a band-aid until a proper fix is in place&lt;/b&gt;* so we can finally continue merging more test ports.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul&gt;
	&lt;li&gt;add `guardWithSingleRetry` convenience method&lt;/li&gt;
	&lt;li&gt;add `ScheduledExecutor` to `MiniClusterClient`&lt;/li&gt;
	&lt;li&gt;guard all calls to the `MiniCluster`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    The change can be verified by cherry-picking &lt;span class=&quot;error&quot;&gt;&amp;#91;this branch&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/zentol/flink/tree/8797&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/flink/tree/8797&lt;/a&gt;) and running the `AbstractOperatorRestoreTestBase`. Before this change there was always 1-2 tests failing, whereas now none should fail.&lt;/p&gt;

&lt;p&gt;    /cc @aljoscha @GJL &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zentol/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zentol/flink&lt;/a&gt; 8887_bandaid&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5657.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5657.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5657&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f685fad6731b7c1774b247985a446260ea285663&lt;br/&gt;
Author: zentol &amp;lt;chesnay@...&amp;gt;&lt;br/&gt;
Date:   2018-03-07T14:02:05Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;tests&amp;#93;&lt;/span&gt; Add single retry in MiniClusterClient&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16389762" author="githubbot" created="Wed, 7 Mar 2018 16:31:47 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5657&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5657&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 I think this makes sense if it unblocks merging test ports to master. I&apos;m guessing we&apos;ll leave &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt; open until we have the proper fix?&lt;/p&gt;</comment>
                            <comment id="16391820" author="githubbot" created="Thu, 8 Mar 2018 19:40:30 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5657&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5657&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    merging.&lt;/p&gt;</comment>
                            <comment id="16392589" author="githubbot" created="Fri, 9 Mar 2018 08:42:21 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5657&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5657&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16392597" author="zentol" created="Fri, 9 Mar 2018 08:44:11 +0000"  >&lt;p&gt;Temporary workaround for the &lt;tt&gt;MiiniClusterClient&lt;/tt&gt; merged in:&lt;br/&gt;
master: 94e959f4fc747f86b84055b333c0b60f45fb5c40&lt;br/&gt;
1.5: 9125687635e403c11408dcc00a0bd4cb25432453&lt;/p&gt;</comment>
                            <comment id="16409738" author="till.rohrmann" created="Thu, 22 Mar 2018 15:40:32 +0000"  >&lt;p&gt;When did you observe the problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjy&quot; class=&quot;user-hover&quot; rel=&quot;gjy&quot;&gt;gjy&lt;/a&gt;? I think this problem can always occur if you send a rpc while a leader change happens. However, such an event should not happen if the leader component is not killed, if I&apos;m not mistaken.&lt;/p&gt;</comment>
                            <comment id="16414043" author="till.rohrmann" created="Mon, 26 Mar 2018 15:59:33 +0000"  >&lt;p&gt;The problem is that we do not wait for &lt;tt&gt;JobMaster&lt;/tt&gt; to be elected as the leader before we send messages from the &lt;tt&gt;Dispatcher&lt;/tt&gt; to the &lt;tt&gt;JobMaster&lt;/tt&gt;. This should happen for all &lt;tt&gt;JobMaster&lt;/tt&gt; requests originating from the &lt;tt&gt;Dispatcher&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16414099" author="githubbot" created="Mon, 26 Mar 2018 16:34:14 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt; Wait for JobMaster leader election in Dispatcher&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Before sending requests from the Dispatcher to the JobMasters, the Dispatcher must&lt;br/&gt;
    wait until the respective JobMaster has gained leadership. Otherwise we might risk&lt;br/&gt;
    that the messages are ignored because no fencing token was set.&lt;/p&gt;

&lt;p&gt;    This is solved by letting the JobManagerRunner expose a CompletableFuture&amp;lt;JobMasterGateway&amp;gt;&lt;br/&gt;
    which is only completed after the JobMaster has gained leadership. The future is cleared&lt;br/&gt;
    once the leadership is revoked.&lt;/p&gt;

&lt;p&gt;    cc @GJL &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;confirm leader session after `JobMaster` is started by `JobManagerRunner`&lt;/li&gt;
	&lt;li&gt;expose `JobMasterGateway` as a future in `JobManagerRunner`&lt;/li&gt;
	&lt;li&gt;Wait for the `JobMasterGateway#getLeaderGatewayFuture` completion before sending messages from the `Dispatcher` to the `JobMaster`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added `DispatcherTest#testWaitingForJobMasterLeadership`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; fixFencingToken&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5767&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2790952a1ec76962b3d5b905abc673a35945c63f&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-03-26T15:55:10Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt; Wait for JobMaster leader election in Dispatcher&lt;/p&gt;

&lt;p&gt;    Before sending requests from the Dispatcher to the JobMasters, the Dispatcher must&lt;br/&gt;
    wait until the respective JobMaster has gained leadership. Otherwise we might risk&lt;br/&gt;
    that the messages are ignored because no fencing token was set.&lt;/p&gt;

&lt;p&gt;    This is solved by letting the JobManagerRunner expose a CompletableFuture&amp;lt;JobMasterGateway&amp;gt;&lt;br/&gt;
    which is only completed after the JobMaster has gained leadership. The future is cleared&lt;br/&gt;
    once the leadership is revoked.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16414127" author="githubbot" created="Mon, 26 Mar 2018 16:57:59 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767#discussion_r177163114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767#discussion_r177163114&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-clients/src/main/java/org/apache/flink/client/program/MiniClusterClient.java &amp;#8212;&lt;br/&gt;
    @@ -67,7 +61,7 @@&lt;br/&gt;
     	private final ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(4, new ExecutorThreadFactory(&quot;Flink-MiniClusterClient&quot;));&lt;br/&gt;
     	private final ScheduledExecutor scheduledExecutor = new ScheduledExecutorServiceAdapter(scheduledExecutorService);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    can this be removed now?&lt;/p&gt;</comment>
                            <comment id="16415090" author="githubbot" created="Tue, 27 Mar 2018 06:25:22 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767#discussion_r177318939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767#discussion_r177318939&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-clients/src/main/java/org/apache/flink/client/program/MiniClusterClient.java &amp;#8212;&lt;br/&gt;
    @@ -67,7 +61,7 @@&lt;br/&gt;
     	private final ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(4, new ExecutorThreadFactory(&quot;Flink-MiniClusterClient&quot;));&lt;br/&gt;
     	private final ScheduledExecutor scheduledExecutor = new ScheduledExecutorServiceAdapter(scheduledExecutorService);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes, will remove it.&lt;/p&gt;</comment>
                            <comment id="16415392" author="githubbot" created="Tue, 27 Mar 2018 10:27:33 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Rebased onto the latest master.&lt;/p&gt;</comment>
                            <comment id="16417115" author="githubbot" created="Wed, 28 Mar 2018 09:58:38 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767#discussion_r177684059&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767#discussion_r177684059&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -645,6 +637,56 @@ private void registerOrphanedJobManagerTerminationFuture(CompletableFuture&amp;lt;Void&amp;gt;&lt;br/&gt;
     			jobManagerRunnerTerminationFuture));&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	private CompletableFuture&amp;lt;JobMasterGateway&amp;gt; getJobMasterGatewayFuture(JobID jobId) {&lt;br/&gt;
    +		final JobManagerRunner jobManagerRunner = jobManagerRunners.get(jobId);&lt;br/&gt;
    +&lt;br/&gt;
    +		if (jobManagerRunner == null) &lt;/p&gt;
{
    +			return FutureUtils.completedExceptionally(new FlinkJobNotFoundException(jobId));
    +		}
&lt;p&gt; else {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;JobMasterGateway&amp;gt; leaderGatewayFuture = jobManagerRunner.getLeaderGatewayFuture();&lt;br/&gt;
    +			return leaderGatewayFuture.thenApplyAsync(&lt;br/&gt;
    +				(JobMasterGateway jobMasterGateway) -&amp;gt; {&lt;br/&gt;
    +					// check whether the retrieved JobMasterGateway belongs still to a running JobMaster&lt;br/&gt;
    +					if (jobManagerRunners.containsKey(jobId)) &lt;/p&gt;
{
    +						return jobMasterGateway;
    +					}
&lt;p&gt; else &lt;/p&gt;
{
    +						throw new CompletionException(new FlinkJobNotFoundException(jobId));
    +					}
&lt;p&gt;    +				},&lt;br/&gt;
    +				getMainThreadExecutor());&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	private &amp;lt;T&amp;gt; List&amp;lt;T&amp;gt; flattenOptionalCollection(Collection&amp;lt;Optional&amp;lt;T&amp;gt;&amp;gt; optionalCollection) &lt;/p&gt;
{
    +		return optionalCollection.stream().filter(Optional::isPresent).map(Optional::get).collect(Collectors.toList());
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Nonnull&lt;br/&gt;
    +	private &amp;lt;T&amp;gt; List&amp;lt;CompletableFuture&amp;lt;Optional&amp;lt;T&amp;gt;&amp;gt;&amp;gt; queryJobMastersForInformation(Function&amp;lt;JobMasterGateway, CompletableFuture&amp;lt;T&amp;gt;&amp;gt; queryFunction) {&lt;br/&gt;
    +		final int numberJobsRunning = jobManagerRunners.size();&lt;br/&gt;
    +&lt;br/&gt;
    +		ArrayList&amp;lt;CompletableFuture&amp;lt;Optional&amp;lt;T&amp;gt;&amp;gt;&amp;gt; optionalJobInformation = new ArrayList&amp;lt;&amp;gt;(&lt;br/&gt;
    +			numberJobsRunning);&lt;br/&gt;
    +&lt;br/&gt;
    +		for (JobID jobId : jobManagerRunners.keySet()) {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;JobMasterGateway&amp;gt; jobMasterGatewayFuture = getJobMasterGatewayFuture(jobId);&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Optional&amp;lt;T&amp;gt;&amp;gt; optionalRequest = jobMasterGatewayFuture&lt;br/&gt;
    +				.thenCompose(queryFunction::apply)&lt;br/&gt;
    +				.handle(&lt;br/&gt;
    +					(T value, Throwable throwable) -&amp;gt; {&lt;br/&gt;
    +						if (throwable != null) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This is equivalent to `.handle((T value, Throwable throwable) -&amp;gt; Optional.ofNullable(value));`&lt;/p&gt;</comment>
                            <comment id="16417116" author="githubbot" created="Wed, 28 Mar 2018 09:58:38 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767#discussion_r177696032&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767#discussion_r177696032&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/highavailability/nonha/embedded/EmbeddedLeaderService.java &amp;#8212;&lt;br/&gt;
    @@ -440,28 +439,33 @@ public void run() {&lt;/p&gt;

&lt;p&gt;     	private static class GrantLeadershipCall implements Runnable {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final LeaderContender contender;&lt;br/&gt;
    +		private final EmbeddedLeaderElectionService leaderCandidate;&lt;br/&gt;
     		private final UUID leaderSessionId;&lt;br/&gt;
     		private final Logger logger;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		GrantLeadershipCall(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LeaderContender contender,&lt;br/&gt;
    +				EmbeddedLeaderElectionService leaderCandidate,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why is this called `leaderCandidate` and not `leaderElectionService?&lt;/p&gt;</comment>
                            <comment id="16417257" author="githubbot" created="Wed, 28 Mar 2018 12:19:00 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767#discussion_r177728701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767#discussion_r177728701&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java &amp;#8212;&lt;br/&gt;
    @@ -645,6 +637,56 @@ private void registerOrphanedJobManagerTerminationFuture(CompletableFuture&amp;lt;Void&amp;gt;&lt;br/&gt;
     			jobManagerRunnerTerminationFuture));&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	private CompletableFuture&amp;lt;JobMasterGateway&amp;gt; getJobMasterGatewayFuture(JobID jobId) {&lt;br/&gt;
    +		final JobManagerRunner jobManagerRunner = jobManagerRunners.get(jobId);&lt;br/&gt;
    +&lt;br/&gt;
    +		if (jobManagerRunner == null) &lt;/p&gt;
{
    +			return FutureUtils.completedExceptionally(new FlinkJobNotFoundException(jobId));
    +		}
&lt;p&gt; else {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;JobMasterGateway&amp;gt; leaderGatewayFuture = jobManagerRunner.getLeaderGatewayFuture();&lt;br/&gt;
    +			return leaderGatewayFuture.thenApplyAsync(&lt;br/&gt;
    +				(JobMasterGateway jobMasterGateway) -&amp;gt; {&lt;br/&gt;
    +					// check whether the retrieved JobMasterGateway belongs still to a running JobMaster&lt;br/&gt;
    +					if (jobManagerRunners.containsKey(jobId)) &lt;/p&gt;
{
    +						return jobMasterGateway;
    +					}
&lt;p&gt; else &lt;/p&gt;
{
    +						throw new CompletionException(new FlinkJobNotFoundException(jobId));
    +					}
&lt;p&gt;    +				},&lt;br/&gt;
    +				getMainThreadExecutor());&lt;br/&gt;
    +		}&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	private &amp;lt;T&amp;gt; List&amp;lt;T&amp;gt; flattenOptionalCollection(Collection&amp;lt;Optional&amp;lt;T&amp;gt;&amp;gt; optionalCollection) &lt;/p&gt;
{
    +		return optionalCollection.stream().filter(Optional::isPresent).map(Optional::get).collect(Collectors.toList());
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Nonnull&lt;br/&gt;
    +	private &amp;lt;T&amp;gt; List&amp;lt;CompletableFuture&amp;lt;Optional&amp;lt;T&amp;gt;&amp;gt;&amp;gt; queryJobMastersForInformation(Function&amp;lt;JobMasterGateway, CompletableFuture&amp;lt;T&amp;gt;&amp;gt; queryFunction) {&lt;br/&gt;
    +		final int numberJobsRunning = jobManagerRunners.size();&lt;br/&gt;
    +&lt;br/&gt;
    +		ArrayList&amp;lt;CompletableFuture&amp;lt;Optional&amp;lt;T&amp;gt;&amp;gt;&amp;gt; optionalJobInformation = new ArrayList&amp;lt;&amp;gt;(&lt;br/&gt;
    +			numberJobsRunning);&lt;br/&gt;
    +&lt;br/&gt;
    +		for (JobID jobId : jobManagerRunners.keySet()) {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;JobMasterGateway&amp;gt; jobMasterGatewayFuture = getJobMasterGatewayFuture(jobId);&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Optional&amp;lt;T&amp;gt;&amp;gt; optionalRequest = jobMasterGatewayFuture&lt;br/&gt;
    +				.thenCompose(queryFunction::apply)&lt;br/&gt;
    +				.handle(&lt;br/&gt;
    +					(T value, Throwable throwable) -&amp;gt; {&lt;br/&gt;
    +						if (throwable != null) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Good catch. Will change it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16417258" author="githubbot" created="Wed, 28 Mar 2018 12:19:14 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767#discussion_r177728773&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767#discussion_r177728773&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/highavailability/nonha/embedded/EmbeddedLeaderService.java &amp;#8212;&lt;br/&gt;
    @@ -440,28 +439,33 @@ public void run() {&lt;/p&gt;

&lt;p&gt;     	private static class GrantLeadershipCall implements Runnable {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final LeaderContender contender;&lt;br/&gt;
    +		private final EmbeddedLeaderElectionService leaderCandidate;&lt;br/&gt;
     		private final UUID leaderSessionId;&lt;br/&gt;
     		private final Logger logger;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		GrantLeadershipCall(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LeaderContender contender,&lt;br/&gt;
    +				EmbeddedLeaderElectionService leaderCandidate,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    True, will correct it.&lt;/p&gt;</comment>
                            <comment id="16417261" author="githubbot" created="Wed, 28 Mar 2018 12:22:50 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @GJL. I&apos;ve addressed your comments and rebased on the soon to be master and force pushed.&lt;/p&gt;</comment>
                            <comment id="16417544" author="githubbot" created="Wed, 28 Mar 2018 15:26:21 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5767&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16417547" author="till.rohrmann" created="Wed, 28 Mar 2018 15:26:47 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
master: c0dddc1a6e3eef8ded1963e61ee4a8f8ecf66475&lt;br/&gt;
1.5.0: 11548456d52c22e1e31fea122de106b1b76a0618&lt;/p&gt;</comment>
                            <comment id="16652362" author="githubbot" created="Tue, 16 Oct 2018 19:57:11 +0000"  >&lt;p&gt;zentol commented on issue #5648: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip-6&amp;#93;&lt;/span&gt; ClusterClient.getJobStatus can throw FencingTokenException&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5648#issuecomment-430378301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5648#issuecomment-430378301&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Already fixed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16652363" author="githubbot" created="Tue, 16 Oct 2018 19:57:11 +0000"  >&lt;p&gt;zentol closed pull request #5648: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8887&quot; title=&quot;ClusterClient.getJobStatus can throw FencingTokenException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8887&quot;&gt;&lt;del&gt;FLINK-8887&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;flip-6&amp;#93;&lt;/span&gt; ClusterClient.getJobStatus can throw FencingTokenException&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/5648&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5648&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java b/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java&lt;br/&gt;
index 9b2411c66b7..1789758a6f1 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java&lt;br/&gt;
@@ -57,6 +57,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.rpc.FencedRpcEndpoint;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcService;&lt;br/&gt;
 import org.apache.flink.runtime.rpc.RpcUtils;&lt;br/&gt;
+import org.apache.flink.runtime.rpc.exceptions.FencingTokenException;&lt;br/&gt;
 import org.apache.flink.util.ExceptionUtils;&lt;br/&gt;
 import org.apache.flink.util.FlinkException;&lt;br/&gt;
 import org.apache.flink.util.Preconditions;&lt;br/&gt;
@@ -74,6 +75,7 @@&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.UUID;&lt;br/&gt;
 import java.util.concurrent.CompletableFuture;&lt;br/&gt;
+import java.util.concurrent.CompletionException;&lt;br/&gt;
 import java.util.stream.Collectors;&lt;/p&gt;

&lt;p&gt; /**&lt;br/&gt;
@@ -404,7 +406,29 @@ public void start() throws Exception {&lt;br/&gt;
 		final JobManagerRunner jobManagerRunner = jobManagerRunners.get(jobId);&lt;/p&gt;

&lt;p&gt; 		if (jobManagerRunner != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return jobManagerRunner.getJobManagerGateway().requestJobStatus(timeout);&lt;br/&gt;
+				CompletableFuture&amp;lt;JobStatus&amp;gt; statusFuture = jobManagerRunner.getJobManagerGateway().requestJobStatus(timeout);&lt;br/&gt;
+				statusFuture.handle((JobStatus status, Throwable throwable) -&amp;gt; {&lt;br/&gt;
+					if (throwable != null) {&lt;br/&gt;
+						Throwable error = ExceptionUtils.stripCompletionException(throwable);&lt;br/&gt;
+&lt;br/&gt;
+						if (error instanceof FencingTokenException) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+							log.warn(&amp;quot;It occurs FencingTokenException may be the job manager runner has no leadership or&amp;quot; ++								&amp;quot; the job has finished, so we would try to get it from archived execution graph store.&amp;quot;);+							final JobDetails jobDetails = archivedExecutionGraphStore.getAvailableJobDetails(jobId);++							if (jobDetails != null) {
+								return jobDetails.getStatus();
+							} else {
+								throw new CompletionException(new FlinkJobNotFoundException(jobId));
+							}+						}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+					}&lt;br/&gt;
+&lt;br/&gt;
+					return status;&lt;br/&gt;
+				});&lt;br/&gt;
+&lt;br/&gt;
+				return statusFuture;&lt;br/&gt;
 		} else {&lt;br/&gt;
 			final JobDetails jobDetails = archivedExecutionGraphStore.getAvailableJobDetails(jobId);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qxzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>