<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10267] [State] Fix arbitrary iterator access on RocksDBMapIterator</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10267</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently, RocksDBMapIterator would load 128 entries into local cacheEntries every time if needed. Both RocksDBMapIterator#next() and RocksDBMapIterator#hasNext() action might trigger to load RocksDBEntry into cacheEntries.&lt;/p&gt;

&lt;p&gt;However, if the iterator&apos;s size larger than 128 and we continue to access the iterator with following order: hasNext() -&amp;gt; next() -&amp;gt; hasNext() -&amp;gt; remove(), we would meet weird exception when we try to remove the 128th element:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException: The remove operation must be called after a valid next operation.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since we could not control user&apos;s access on iterator, we should fix this bug to avoid unexpected exception.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13182187">FLINK-10267</key>
            <summary>[State] Fix arbitrary iterator access on RocksDBMapIterator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yunta">Yun Tang</assignee>
                                    <reporter username="yunta">Yun Tang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 30 Aug 2018 17:29:24 +0000</created>
                <updated>Tue, 11 Sep 2018 13:47:23 +0000</updated>
                            <resolved>Tue, 11 Sep 2018 13:47:23 +0000</resolved>
                                    <version>1.5.3</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.5.4</fixVersion>
                    <fixVersion>1.6.1</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16597719" author="githubbot" created="Thu, 30 Aug 2018 17:41:08 +0000"  >&lt;p&gt;Myasuka opened a new pull request #6638: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10267&quot; title=&quot;[State] Fix arbitrary iterator access on RocksDBMapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10267&quot;&gt;&lt;del&gt;FLINK-10267&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;State&amp;#93;&lt;/span&gt; Fix arbitrary iterator access on RocksDBMapIterator&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6638&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6638&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This pull request fix the arbitrary iterator access on RocksDBMapIterator to avoid unexpected exception.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Fix the `RocksDBMapIterator#loadCache()` logical to add not-removed `lastEntry` as the first entry in `cacheEntries`. &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change added tests and can be verified as follows:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added unit test for `StateBackendTestBase#testMapState()`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency):  no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): don&apos;t know&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: no&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature?  no&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16598705" author="githubbot" created="Fri, 31 Aug 2018 13:03:14 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #6638: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10267&quot; title=&quot;[State] Fix arbitrary iterator access on RocksDBMapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10267&quot;&gt;&lt;del&gt;FLINK-10267&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;State&amp;#93;&lt;/span&gt; Fix arbitrary iterator access on RocksDBMapIterator&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6638#discussion_r214345264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6638#discussion_r214345264&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -2913,7 +2913,21 @@ public void testMapState() throws Exception {&lt;br/&gt;
 		assertEquals(new HashMap&amp;lt;Integer, String&amp;gt;() {{ put(103, &quot;103&quot;); put(1031, &quot;1031&quot;); put(1032, &quot;1032&quot;); }},&lt;br/&gt;
 				getSerializedMap(restoredKvState2, &quot;3&quot;, keySerializer, VoidNamespace.INSTANCE, namespaceSerializer, userKeySerializer, userValueSerializer));&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;backend.dispose();&lt;br/&gt;
+		// &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10267&quot; title=&quot;[State] Fix arbitrary iterator access on RocksDBMapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10267&quot;&gt;&lt;del&gt;FLINK-10267&lt;/del&gt;&lt;/a&gt; validate arbitrary iterator access not throwing IllegalStateException&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   The test cases are already quite huge, can we create a separate one for this behaviour?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16598706" author="githubbot" created="Fri, 31 Aug 2018 13:03:15 +0000"  >&lt;p&gt;azagrebin commented on a change in pull request #6638: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10267&quot; title=&quot;[State] Fix arbitrary iterator access on RocksDBMapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10267&quot;&gt;&lt;del&gt;FLINK-10267&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;State&amp;#93;&lt;/span&gt; Fix arbitrary iterator access on RocksDBMapIterator&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6638#discussion_r214344987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6638#discussion_r214344987&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBMapState.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -595,6 +595,8 @@ private void loadCache() {&lt;br/&gt;
 				 */&lt;br/&gt;
 				if (lastEntry != null &amp;amp;&amp;amp; !lastEntry.deleted) {&lt;br/&gt;
 					iterator.next();&lt;br/&gt;
+					cacheEntries.add(lastEntry);&lt;br/&gt;
+					cacheIndex = 1;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Could be also just:&lt;br/&gt;
   ```&lt;br/&gt;
   if (lastEntry != null &amp;amp;&amp;amp; !lastEntry.deleted) &lt;/p&gt;
{
       cacheIndex = 1;
   }
&lt;p&gt;   ```&lt;/p&gt;

&lt;p&gt;   This should work in general. I wonder if we could make it cleaner.&lt;br/&gt;
   Although, the remove operation is not supposed to be called twice for the same next,&lt;br/&gt;
   if it happens and `lastEntry.deleted` is true, the problem will stay.&lt;br/&gt;
   What if we cache always the previously returned value in `nextEntry()` as a class field:&lt;br/&gt;
   ```&lt;br/&gt;
   previousEntry = cacheEntries.get(cacheIndex);&lt;br/&gt;
   ```&lt;br/&gt;
   then remove could be:&lt;br/&gt;
   ```&lt;br/&gt;
           @Override&lt;br/&gt;
   		public void remove() {&lt;br/&gt;
   			if (previousEntry == null) &lt;/p&gt;
{
   				throw new IllegalStateException(&quot;The remove operation must be called after a valid next operation.&quot;);
   			}

&lt;p&gt;   			if (!previousEntry.deleted) &lt;/p&gt;
{
   			    previousEntry.remove();
               }
&lt;p&gt;   		}&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;   What do you think?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16604586" author="githubbot" created="Wed, 5 Sep 2018 15:47:27 +0000"  >&lt;p&gt;Myasuka commented on issue #6638: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10267&quot; title=&quot;[State] Fix arbitrary iterator access on RocksDBMapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10267&quot;&gt;&lt;del&gt;FLINK-10267&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;State&amp;#93;&lt;/span&gt; Fix arbitrary iterator access on RocksDBMapIterator&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6638#issuecomment-418780838&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6638#issuecomment-418780838&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @azagrebin Really thanks for your review, and sorry for the late reply since I just have a couple busy days after a weekend.&lt;br/&gt;
   I&apos;ll check your review comments and add new commit soon.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16604673" author="githubbot" created="Wed, 5 Sep 2018 16:58:01 +0000"  >&lt;p&gt;Myasuka commented on a change in pull request #6638: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10267&quot; title=&quot;[State] Fix arbitrary iterator access on RocksDBMapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10267&quot;&gt;&lt;del&gt;FLINK-10267&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;State&amp;#93;&lt;/span&gt; Fix arbitrary iterator access on RocksDBMapIterator&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6638#discussion_r215349665&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6638#discussion_r215349665&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBMapState.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -595,6 +595,8 @@ private void loadCache() {&lt;br/&gt;
 				 */&lt;br/&gt;
 				if (lastEntry != null &amp;amp;&amp;amp; !lastEntry.deleted) {&lt;br/&gt;
 					iterator.next();&lt;br/&gt;
+					cacheEntries.add(lastEntry);&lt;br/&gt;
+					cacheIndex = 1;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Thanks for your comments, I quite agree with your comments except that I prefer to call the `#nextEntry()` returned entry as `currentEntry`, since this entry points to the current position before any other `#nextEntry()` is invoked.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16610569" author="githubbot" created="Tue, 11 Sep 2018 13:23:33 +0000"  >&lt;p&gt;StefanRRichter commented on issue #6638: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10267&quot; title=&quot;[State] Fix arbitrary iterator access on RocksDBMapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10267&quot;&gt;&lt;del&gt;FLINK-10267&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;State&amp;#93;&lt;/span&gt; Fix arbitrary iterator access on RocksDBMapIterator&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6638#issuecomment-420272898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6638#issuecomment-420272898&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for the contribution! Looks good for me as well &#128077; Merging.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16610573" author="githubbot" created="Tue, 11 Sep 2018 13:25:43 +0000"  >&lt;p&gt;asfgit closed pull request #6638: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10267&quot; title=&quot;[State] Fix arbitrary iterator access on RocksDBMapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10267&quot;&gt;&lt;del&gt;FLINK-10267&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;State&amp;#93;&lt;/span&gt; Fix arbitrary iterator access on RocksDBMapIterator&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6638&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6638&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java b/flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java&lt;br/&gt;
index 649c6d03a6a..2634268c947 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java&lt;br/&gt;
@@ -117,6 +117,7 @@&lt;br/&gt;
 import java.util.concurrent.Executors;&lt;br/&gt;
 import java.util.concurrent.Future;&lt;br/&gt;
 import java.util.concurrent.RunnableFuture;&lt;br/&gt;
+import java.util.concurrent.ThreadLocalRandom;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;br/&gt;
 import java.util.stream.Stream;&lt;/p&gt;

&lt;p&gt;@@ -2916,6 +2917,52 @@ public void testMapState() throws Exception &lt;/p&gt;
{
 		backend.dispose();
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Verify iterator of &lt;/p&gt;
{@link MapState}
&lt;p&gt; supporting arbitrary access, see &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10267&quot; title=&quot;[State] Fix arbitrary iterator access on RocksDBMapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10267&quot;&gt;&lt;del&gt;FLINK-10267&lt;/del&gt;&lt;/a&gt; to know more details.&lt;br/&gt;
+	 */&lt;br/&gt;
+	@Test&lt;br/&gt;
+	public void testMapStateIteratorArbitraryAccess() throws Exception {&lt;br/&gt;
+		MapStateDescriptor&amp;lt;Integer, Long&amp;gt; kvId = new MapStateDescriptor&amp;lt;&amp;gt;(&quot;id&quot;, Integer.class, Long.class);&lt;br/&gt;
+&lt;br/&gt;
+		AbstractKeyedStateBackend&amp;lt;Integer&amp;gt; backend = createKeyedBackend(IntSerializer.INSTANCE);&lt;br/&gt;
+&lt;br/&gt;
+		try {&lt;br/&gt;
+			MapState&amp;lt;Integer, Long&amp;gt; state = backend.getPartitionedState(VoidNamespace.INSTANCE, VoidNamespaceSerializer.INSTANCE, kvId);&lt;br/&gt;
+			backend.setCurrentKey(1);&lt;br/&gt;
+			int stateSize = 4096;&lt;br/&gt;
+			for (int i = 0; i &amp;lt; stateSize; i++) &lt;/p&gt;
{
+				state.put(i, i * 2L);
+			}
&lt;p&gt;+			Iterator&amp;lt;Map.Entry&amp;lt;Integer, Long&amp;gt;&amp;gt; iterator = state.iterator();&lt;br/&gt;
+			int iteratorCount = 0;&lt;br/&gt;
+			while (iterator.hasNext()) {&lt;br/&gt;
+				Map.Entry&amp;lt;Integer, Long&amp;gt; entry = iterator.next();&lt;br/&gt;
+				assertEquals(iteratorCount, (int) entry.getKey());&lt;br/&gt;
+				switch (ThreadLocalRandom.current().nextInt() % 3) {&lt;br/&gt;
+					case 0: // remove twice&lt;br/&gt;
+						iterator.remove();&lt;br/&gt;
+						try &lt;/p&gt;
{
+							iterator.remove();
+							fail();
+						}
&lt;p&gt; catch (IllegalStateException e) &lt;/p&gt;
{
+							// ignore expected exception
+						}
&lt;p&gt;+						break;&lt;br/&gt;
+					case 1: // hasNext -&amp;gt; remove&lt;br/&gt;
+						iterator.hasNext();&lt;br/&gt;
+						iterator.remove();&lt;br/&gt;
+						break;&lt;br/&gt;
+					case 2: // nothing to do&lt;br/&gt;
+						break;&lt;br/&gt;
+				}&lt;br/&gt;
+				iteratorCount++;&lt;br/&gt;
+			}&lt;br/&gt;
+			assertEquals(stateSize, iteratorCount);&lt;br/&gt;
+		} finally &lt;/p&gt;
{
+			backend.dispose();
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Verify that 
{@link ValueStateDescriptor}
&lt;p&gt; allows &lt;/p&gt;
{@code null}
&lt;p&gt; as default.&lt;br/&gt;
 	 */&lt;br/&gt;
diff --git a/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBMapState.java b/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBMapState.java&lt;br/&gt;
index 5c9f7f9f30c..cb656b53b1b 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBMapState.java&lt;br/&gt;
+++ b/flink-state-backends/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/RocksDBMapState.java&lt;br/&gt;
@@ -498,6 +498,7 @@ public UV setValue(UV value) {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;have the same prefix, hence we can stop iterating once coming across an&lt;/li&gt;
	&lt;li&gt;entry with a different prefix.&lt;br/&gt;
 		 */&lt;br/&gt;
+		@Nonnull&lt;br/&gt;
 		private final byte[] keyPrefixBytes;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		/**&lt;br/&gt;
@@ -508,6 +509,9 @@ public UV setValue(UV value) {&lt;/p&gt;

&lt;p&gt; 		/** A in-memory cache for the entries in the rocksdb. */&lt;br/&gt;
 		private ArrayList&amp;lt;RocksDBMapEntry&amp;gt; cacheEntries = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+		/** The entry pointing to the current position which is last returned by calling &lt;/p&gt;
{@link #nextEntry()}
&lt;p&gt;. */&lt;br/&gt;
+		private RocksDBMapEntry currentEntry;&lt;br/&gt;
 		private int cacheIndex = 0;&lt;/p&gt;

&lt;p&gt; 		private final TypeSerializer&amp;lt;UK&amp;gt; keySerializer;&lt;br/&gt;
@@ -537,12 +541,11 @@ public boolean hasNext() {&lt;/p&gt;

&lt;p&gt; 		@Override&lt;br/&gt;
 		public void remove() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (cacheIndex == 0 || cacheIndex &amp;gt; cacheEntries.size()) {&lt;br/&gt;
+			if (currentEntry == null || currentEntry.deleted) 
{
 				throw new IllegalStateException(&quot;The remove operation must be called after a valid next operation.&quot;);
 			}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RocksDBMapEntry lastEntry = cacheEntries.get(cacheIndex - 1);&lt;/li&gt;
	&lt;li&gt;lastEntry.remove();&lt;br/&gt;
+			currentEntry.remove();&lt;br/&gt;
 		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		final RocksDBMapEntry nextEntry() {&lt;br/&gt;
@@ -556,10 +559,10 @@ final RocksDBMapEntry nextEntry() &lt;/p&gt;
{
 				return null;
 			}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RocksDBMapEntry entry = cacheEntries.get(cacheIndex);&lt;br/&gt;
+			this.currentEntry = cacheEntries.get(cacheIndex);&lt;br/&gt;
 			cacheIndex++;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return entry;&lt;br/&gt;
+			return currentEntry;&lt;br/&gt;
 		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		private void loadCache() {&lt;br/&gt;
@@ -577,12 +580,11 @@ private void loadCache() {&lt;br/&gt;
 			try (RocksIteratorWrapper iterator = RocksDBKeyedStateBackend.getRocksIterator(db, columnFamily)) {&lt;/p&gt;

&lt;p&gt; 				/*&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* The iteration starts from the prefix bytes at the first loading. The cache then is&lt;/li&gt;
	&lt;li&gt;* reloaded when the next entry to return is the last one in the cache. At that time,&lt;/li&gt;
	&lt;li&gt;* we will start the iterating from the last returned entry.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;RocksDBMapEntry lastEntry = cacheEntries.size() == 0 ? null : cacheEntries.get(cacheEntries.size() - 1);&lt;/li&gt;
	&lt;li&gt;byte[] startBytes = (lastEntry == null ? keyPrefixBytes : lastEntry.rawKeyBytes);&lt;br/&gt;
+				 * The iteration starts from the prefix bytes at the first loading. After #nextEntry() is called,&lt;br/&gt;
+				 * the currentEntry points to the last returned entry, and at that time, we will start&lt;br/&gt;
+				 * the iterating from currentEntry if reloading cache is needed.&lt;br/&gt;
+				 */&lt;br/&gt;
+				byte[] startBytes = (currentEntry == null ? keyPrefixBytes : currentEntry.rawKeyBytes);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 				cacheEntries.clear();&lt;br/&gt;
 				cacheIndex = 0;&lt;br/&gt;
@@ -590,10 +592,10 @@ private void loadCache() {&lt;br/&gt;
 				iterator.seek(startBytes);&lt;/p&gt;

&lt;p&gt; 				/*&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* If the last returned entry is not deleted, it will be the first entry in the&lt;/li&gt;
	&lt;li&gt;* iterating. Skip it to avoid redundant access in such cases.&lt;br/&gt;
+				 * If the entry pointing to the current position is not removed, it will be the first entry in the&lt;br/&gt;
+				 * new iterating. Skip it to avoid redundant access in such cases.&lt;br/&gt;
 				 */&lt;/li&gt;
	&lt;li&gt;if (lastEntry != null &amp;amp;&amp;amp; !lastEntry.deleted) {&lt;br/&gt;
+				if (currentEntry != null &amp;amp;&amp;amp; !currentEntry.deleted) 
{
 					iterator.next();
 				}&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16610612" author="srichter" created="Tue, 11 Sep 2018 13:47:23 +0000"  >&lt;p&gt;Merged in:&lt;br/&gt;
master: 16dc5978c7&lt;br/&gt;
release-1.6: a19e1ee3ba&lt;br/&gt;
release-1.5: d8e7741bf4&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xlmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>